Directory structure:
└── prism-php-prism/
    ├── README.md
    ├── composer.json
    ├── LICENSE
    ├── phpstan.neon.dist
    ├── phpunit.xml.dist
    ├── rector.php
    ├── Taskfile.yml
    ├── testbench.yaml
    ├── whisky.json
    ├── assets/
    │   └── prism-logo.webp
    ├── config/
    │   └── prism.php
    ├── docs/
    │   ├── README.md
    │   ├── documentation-style-guide.md
    │   ├── index.md
    │   ├── package.json
    │   ├── advanced/
    │   │   ├── custom-providers.md
    │   │   ├── error-handling.md
    │   │   ├── provider-interoperability.md
    │   │   └── rate-limits.md
    │   ├── components/
    │   │   ├── ExceptionSupport.vue
    │   │   └── ProviderSupport.vue
    │   ├── core-concepts/
    │   │   ├── audio.md
    │   │   ├── embeddings.md
    │   │   ├── image-generation.md
    │   │   ├── prism-server.md
    │   │   ├── schemas.md
    │   │   ├── streaming-output.md
    │   │   ├── structured-output.md
    │   │   ├── testing.md
    │   │   ├── text-generation.md
    │   │   └── tools-function-calling.md
    │   ├── getting-started/
    │   │   ├── configuration.md
    │   │   ├── installation.md
    │   │   └── introduction.md
    │   ├── input-modalities/
    │   │   ├── audio.md
    │   │   ├── documents.md
    │   │   ├── images.md
    │   │   └── video.md
    │   ├── providers/
    │   │   ├── anthropic.md
    │   │   ├── deepseek.md
    │   │   ├── elevenlabs.md
    │   │   ├── gemini.md
    │   │   ├── groq.md
    │   │   ├── mistral.md
    │   │   ├── ollama.md
    │   │   ├── openai.md
    │   │   ├── openrouter.md
    │   │   ├── providers.md.template
    │   │   ├── voyageai.md
    │   │   └── xai.md
    │   ├── public/
    │   │   └── assets/
    │   │       └── prism-logo.webp
    │   └── .vitepress/
    │       ├── config.mts
    │       └── theme/
    │           ├── custom.css
    │           ├── HostedFooter.vue
    │           └── index.js
    ├── resources/
    │   └── boost/
    │       └── guidelines/
    │           └── core.blade.php
    ├── src/
    │   ├── helpers.php
    │   ├── Prism.php
    │   ├── PrismManager.php
    │   ├── PrismServer.php
    │   ├── PrismServiceProvider.php
    │   ├── Tool.php
    │   ├── .gitkeep
    │   ├── Audio/
    │   │   ├── AudioResponse.php
    │   │   ├── PendingRequest.php
    │   │   ├── SpeechToTextRequest.php
    │   │   ├── TextResponse.php
    │   │   └── TextToSpeechRequest.php
    │   ├── Concerns/
    │   │   ├── CallsTools.php
    │   │   ├── ChecksSelf.php
    │   │   ├── ConfiguresClient.php
    │   │   ├── ConfiguresGeneration.php
    │   │   ├── ConfiguresModels.php
    │   │   ├── ConfiguresProviders.php
    │   │   ├── ConfiguresStructuredOutput.php
    │   │   ├── ConfiguresTools.php
    │   │   ├── HasFluentAttributes.php
    │   │   ├── HasMessages.php
    │   │   ├── HasPrompts.php
    │   │   ├── HasProviderOptions.php
    │   │   ├── HasProviderTools.php
    │   │   ├── HasSchema.php
    │   │   ├── HasTools.php
    │   │   ├── InitializesClient.php
    │   │   └── NullableSchema.php
    │   ├── Contracts/
    │   │   ├── Message.php
    │   │   ├── PrismRequest.php
    │   │   ├── ProviderMediaMapper.php
    │   │   ├── ProviderRequestMapper.php
    │   │   └── Schema.php
    │   ├── Embeddings/
    │   │   ├── PendingRequest.php
    │   │   ├── Request.php
    │   │   └── Response.php
    │   ├── Enums/
    │   │   ├── FinishReason.php
    │   │   ├── Provider.php
    │   │   ├── StreamEventType.php
    │   │   ├── StructuredMode.php
    │   │   ├── ToolChoice.php
    │   │   └── Citations/
    │   │       ├── CitationSourcePositionType.php
    │   │       └── CitationSourceType.php
    │   ├── Events/
    │   │   └── Broadcasting/
    │   │       ├── ErrorBroadcast.php
    │   │       ├── StreamEndBroadcast.php
    │   │       ├── StreamEventBroadcast.php
    │   │       ├── StreamStartBroadcast.php
    │   │       ├── TextCompleteBroadcast.php
    │   │       ├── TextDeltaBroadcast.php
    │   │       ├── TextStartBroadcast.php
    │   │       ├── ThinkingBroadcast.php
    │   │       ├── ThinkingCompleteBroadcast.php
    │   │       ├── ThinkingStartBroadcast.php
    │   │       ├── ToolCallBroadcast.php
    │   │       └── ToolResultBroadcast.php
    │   ├── Exceptions/
    │   │   ├── PrismException.php
    │   │   ├── PrismProviderOverloadedException.php
    │   │   ├── PrismRateLimitedException.php
    │   │   ├── PrismRequestTooLargeException.php
    │   │   ├── PrismServerException.php
    │   │   ├── PrismStreamDecodeException.php
    │   │   └── PrismStructuredDecodingException.php
    │   ├── Facades/
    │   │   ├── Prism.php
    │   │   ├── PrismServer.php
    │   │   └── Tool.php
    │   ├── Http/
    │   │   └── Controllers/
    │   │       ├── PrismChatController.php
    │   │       └── PrismModelController.php
    │   ├── Images/
    │   │   ├── PendingRequest.php
    │   │   ├── Request.php
    │   │   ├── Response.php
    │   │   └── ResponseBuilder.php
    │   ├── Providers/
    │   │   ├── Provider.php
    │   │   ├── Anthropic/
    │   │   │   ├── Anthropic.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── ExtractsCitations.php
    │   │   │   │   ├── ExtractsText.php
    │   │   │   │   ├── ExtractsThinking.php
    │   │   │   │   ├── HandlesHttpRequests.php
    │   │   │   │   └── ProcessesRateLimits.php
    │   │   │   ├── Enums/
    │   │   │   │   └── AnthropicCacheType.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   ├── Text.php
    │   │   │   │   └── StructuredStrategies/
    │   │   │   │       ├── AnthropicStructuredStrategy.php
    │   │   │   │       ├── JsonModeStructuredStrategy.php
    │   │   │   │       └── ToolStructuredStrategy.php
    │   │   │   ├── Maps/
    │   │   │   │   ├── CitationsMapper.php
    │   │   │   │   ├── DocumentMapper.php
    │   │   │   │   ├── FinishReasonMap.php
    │   │   │   │   ├── ImageMapper.php
    │   │   │   │   ├── MessageMap.php
    │   │   │   │   ├── ToolChoiceMap.php
    │   │   │   │   └── ToolMap.php
    │   │   │   ├── Parsers/
    │   │   │   │   └── StreamEventParser.php
    │   │   │   └── ValueObjects/
    │   │   │       ├── AnthropicStreamState.php
    │   │   │       ├── LegacyAnthropicCitation.php
    │   │   │       └── LegacyAnthropicMessagePartWithCitations.php
    │   │   ├── DeepSeek/
    │   │   │   ├── DeepSeek.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── MapsFinishReason.php
    │   │   │   │   └── ValidatesResponses.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   └── Maps/
    │   │   │       ├── FinishReasonMap.php
    │   │   │       ├── ImageMapper.php
    │   │   │       ├── MessageMap.php
    │   │   │       ├── ToolCallMap.php
    │   │   │       ├── ToolChoiceMap.php
    │   │   │       └── ToolMap.php
    │   │   ├── ElevenLabs/
    │   │   │   ├── ElevenLabs.php
    │   │   │   ├── Handlers/
    │   │   │   │   └── Audio.php
    │   │   │   └── Maps/
    │   │   │       └── TextToSpeechRequestMapper.php
    │   │   ├── Gemini/
    │   │   │   ├── Gemini.php
    │   │   │   ├── Concerns/
    │   │   │   │   └── ValidatesResponse.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Cache.php
    │   │   │   │   ├── Embeddings.php
    │   │   │   │   ├── Images.php
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   ├── Maps/
    │   │   │   │   ├── AudioVideoMapper.php
    │   │   │   │   ├── CitationMapper.php
    │   │   │   │   ├── DocumentMapper.php
    │   │   │   │   ├── FinishReasonMap.php
    │   │   │   │   ├── ImageMapper.php
    │   │   │   │   ├── ImageRequestMap.php
    │   │   │   │   ├── MessageMap.php
    │   │   │   │   ├── SchemaMap.php
    │   │   │   │   ├── SearchGroundingMap.php
    │   │   │   │   ├── ToolCallMap.php
    │   │   │   │   ├── ToolChoiceMap.php
    │   │   │   │   └── ToolMap.php
    │   │   │   ├── Support/
    │   │   │   │   └── MediaUrlDetector.php
    │   │   │   └── ValueObjects/
    │   │   │       ├── GeminiCachedObject.php
    │   │   │       ├── MessagePartWithSearchGroundings.php
    │   │   │       └── SearchGrounding.php
    │   │   ├── Groq/
    │   │   │   ├── Groq.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── ProcessRateLimits.php
    │   │   │   │   └── ValidateResponse.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Audio.php
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   └── Maps/
    │   │   │       ├── FinishReasonMap.php
    │   │   │       ├── ImageMapper.php
    │   │   │       ├── MessageMap.php
    │   │   │       ├── TextToSpeechRequestMapper.php
    │   │   │       ├── ToolChoiceMap.php
    │   │   │       └── ToolMap.php
    │   │   ├── Mistral/
    │   │   │   ├── Mistral.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── ExtractsText.php
    │   │   │   │   ├── ExtractsThinking.php
    │   │   │   │   ├── MapsFinishReason.php
    │   │   │   │   ├── ProcessRateLimits.php
    │   │   │   │   └── ValidatesResponse.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Audio.php
    │   │   │   │   ├── Embeddings.php
    │   │   │   │   ├── OCR.php
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   ├── Maps/
    │   │   │   │   ├── DocumentMapper.php
    │   │   │   │   ├── FinishReasonMap.php
    │   │   │   │   ├── ImageMapper.php
    │   │   │   │   ├── MessageMap.php
    │   │   │   │   ├── ToolChoiceMap.php
    │   │   │   │   └── ToolMap.php
    │   │   │   └── ValueObjects/
    │   │   │       ├── OCRPageResponse.php
    │   │   │       └── OCRResponse.php
    │   │   ├── Ollama/
    │   │   │   ├── Ollama.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── MapsFinishReason.php
    │   │   │   │   └── ValidatesResponse.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Embeddings.php
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   ├── Maps/
    │   │   │   │   ├── FinishReasonMap.php
    │   │   │   │   ├── ImageMapper.php
    │   │   │   │   ├── MessageMap.php
    │   │   │   │   └── ToolMap.php
    │   │   │   └── ValueObjects/
    │   │   │       └── OllamaStreamState.php
    │   │   ├── OpenAI/
    │   │   │   ├── OpenAI.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── BuildsTools.php
    │   │   │   │   ├── ExtractsCitations.php
    │   │   │   │   ├── MapsFinishReason.php
    │   │   │   │   ├── ProcessRateLimits.php
    │   │   │   │   └── ValidatesResponse.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Audio.php
    │   │   │   │   ├── Embeddings.php
    │   │   │   │   ├── Images.php
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   ├── Maps/
    │   │   │   │   ├── CitationsMapper.php
    │   │   │   │   ├── DocumentMapper.php
    │   │   │   │   ├── FinishReasonMap.php
    │   │   │   │   ├── ImageMapper.php
    │   │   │   │   ├── ImageRequestMap.php
    │   │   │   │   ├── MessageMap.php
    │   │   │   │   ├── TextToSpeechRequestMapper.php
    │   │   │   │   ├── ToolCallMap.php
    │   │   │   │   ├── ToolChoiceMap.php
    │   │   │   │   └── ToolMap.php
    │   │   │   └── Support/
    │   │   │       └── StructuredModeResolver.php
    │   │   ├── OpenRouter/
    │   │   │   ├── OpenRouter.php
    │   │   │   ├── Concerns/
    │   │   │   │   ├── BuildsRequestOptions.php
    │   │   │   │   ├── MapsFinishReason.php
    │   │   │   │   └── ValidatesResponses.php
    │   │   │   ├── Handlers/
    │   │   │   │   ├── Stream.php
    │   │   │   │   ├── Structured.php
    │   │   │   │   └── Text.php
    │   │   │   └── Maps/
    │   │   │       ├── AudioMapper.php
    │   │   │       ├── FinishReasonMap.php
    │   │   │       ├── ImageMapper.php
    │   │   │       ├── MessageMap.php
    │   │   │       ├── ToolCallMap.php
    │   │   │       ├── ToolChoiceMap.php
    │   │   │       ├── ToolMap.php
    │   │   │       └── VideoMapper.php
    │   │   ├── VoyageAI/
    │   │   │   ├── Embeddings.php
    │   │   │   └── VoyageAI.php
    │   │   └── XAI/
    │   │       ├── XAI.php
    │   │       ├── Concerns/
    │   │       │   ├── ExtractsThinking.php
    │   │       │   ├── MapsFinishReason.php
    │   │       │   └── ValidatesResponses.php
    │   │       ├── Handlers/
    │   │       │   ├── Stream.php
    │   │       │   ├── Structured.php
    │   │       │   └── Text.php
    │   │       └── Maps/
    │   │           ├── FinishReasonMap.php
    │   │           ├── ImageMapper.php
    │   │           ├── MessageMap.php
    │   │           ├── ToolChoiceMap.php
    │   │           └── ToolMap.php
    │   ├── Rectors/
    │   │   └── ReorderMethodsRector.php
    │   ├── Routes/
    │   │   └── PrismServer.php
    │   ├── Schema/
    │   │   ├── AnyOfSchema.php
    │   │   ├── ArraySchema.php
    │   │   ├── BooleanSchema.php
    │   │   ├── EnumSchema.php
    │   │   ├── NumberSchema.php
    │   │   ├── ObjectSchema.php
    │   │   └── StringSchema.php
    │   ├── Streaming/
    │   │   ├── EventID.php
    │   │   ├── StreamCollector.php
    │   │   ├── StreamState.php
    │   │   ├── Adapters/
    │   │   │   ├── BroadcastAdapter.php
    │   │   │   ├── DataProtocolAdapter.php
    │   │   │   └── SSEAdapter.php
    │   │   └── Events/
    │   │       ├── CitationEvent.php
    │   │       ├── ErrorEvent.php
    │   │       ├── StreamEndEvent.php
    │   │       ├── StreamEvent.php
    │   │       ├── StreamStartEvent.php
    │   │       ├── TextCompleteEvent.php
    │   │       ├── TextDeltaEvent.php
    │   │       ├── TextStartEvent.php
    │   │       ├── ThinkingCompleteEvent.php
    │   │       ├── ThinkingEvent.php
    │   │       ├── ThinkingStartEvent.php
    │   │       ├── ToolCallEvent.php
    │   │       └── ToolResultEvent.php
    │   ├── Structured/
    │   │   ├── PendingRequest.php
    │   │   ├── Request.php
    │   │   ├── Response.php
    │   │   ├── ResponseBuilder.php
    │   │   └── Step.php
    │   ├── Testing/
    │   │   ├── EmbeddingsResponseFake.php
    │   │   ├── ImageResponseFake.php
    │   │   ├── PrismFake.php
    │   │   ├── StructuredResponseFake.php
    │   │   ├── StructuredStepFake.php
    │   │   ├── TextResponseFake.php
    │   │   ├── TextStepFake.php
    │   │   └── Concerns/
    │   │       └── CanGenerateFakeChunksFromTextResponses.php
    │   ├── Text/
    │   │   ├── PendingRequest.php
    │   │   ├── Request.php
    │   │   ├── Response.php
    │   │   ├── ResponseBuilder.php
    │   │   └── Step.php
    │   └── ValueObjects/
    │       ├── Citation.php
    │       ├── Embedding.php
    │       ├── EmbeddingsUsage.php
    │       ├── GeneratedAudio.php
    │       ├── GeneratedImage.php
    │       ├── MessagePartWithCitations.php
    │       ├── Meta.php
    │       ├── ProviderRateLimit.php
    │       ├── ProviderTool.php
    │       ├── ToolCall.php
    │       ├── ToolResult.php
    │       ├── Usage.php
    │       ├── Media/
    │       │   ├── Audio.php
    │       │   ├── Document.php
    │       │   ├── Image.php
    │       │   ├── Media.php
    │       │   ├── Text.php
    │       │   └── Video.php
    │       └── Messages/
    │           ├── AssistantMessage.php
    │           ├── SystemMessage.php
    │           ├── ToolResultMessage.php
    │           └── UserMessage.php
    ├── tests/
    │   ├── ArchTest.php
    │   ├── HelpersTest.php
    │   ├── Pest.php
    │   ├── PrismManagerTest.php
    │   ├── SchemaTest.php
    │   ├── TestCase.php
    │   ├── ToolErrorHandlingTest.php
    │   ├── ToolTest.php
    │   ├── Concerns/
    │   │   ├── HasFluentAttributesTest.php
    │   │   ├── HasProviderOptionsTest.php
    │   │   └── WhenProviderTest.php
    │   ├── Fixtures/
    │   │   ├── FixtureResponse.php
    │   │   ├── profile.md
    │   │   ├── test-embedding-file.md
    │   │   ├── test-text.md
    │   │   ├── test-text.txt
    │   │   ├── anthropic/
    │   │   │   ├── calculate-cache-usage-1.json
    │   │   │   ├── generate-structured-with-text-document-citations-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-base64-image-1.json
    │   │   │   ├── generate-text-with-custom-content-document-citations-1.json
    │   │   │   ├── generate-text-with-image-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-multiple-tools-3.json
    │   │   │   ├── generate-text-with-pdf-citations-1.json
    │   │   │   ├── generate-text-with-provider-tool-1.json
    │   │   │   ├── generate-text-with-provider-tool-and-user-tool-1.json
    │   │   │   ├── generate-text-with-provider-tool-and-user-tool-2.json
    │   │   │   ├── generate-text-with-required-tool-call-1.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── generate-text-with-text-document-citations-1.json
    │   │   │   ├── generate-text-with-text-document-citations-on-followup-1.json
    │   │   │   ├── generate-text-with-text-document-citations-on-followup-2.json
    │   │   │   ├── generate-text-with-web-search-citations-1.json
    │   │   │   ├── generate-text-with-web-search-citations-on-followup-1.json
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-multi-tool-conversation-1.sse
    │   │   │   ├── stream-multi-tool-conversation-2.sse
    │   │   │   ├── stream-multi-tool-conversation-3.sse
    │   │   │   ├── stream-with-citations-1.sse
    │   │   │   ├── stream-with-extended-thinking-1.sse
    │   │   │   ├── stream-with-tools-1.sse
    │   │   │   ├── stream-with-tools-2.sse
    │   │   │   ├── stream-with-tools-3.sse
    │   │   │   ├── stream-with-web-search-citations-1.sse
    │   │   │   ├── structured-1.json
    │   │   │   ├── structured-chinese-tool-calling-1.json
    │   │   │   ├── structured-with-default-json-1.json
    │   │   │   ├── structured-with-extending-thinking-1.json
    │   │   │   ├── structured-with-use-tool-calling-1.json
    │   │   │   ├── text-with-extending-thinking-1.json
    │   │   │   ├── text-with-extending-thinking-and-tool-calls-1.json
    │   │   │   ├── text-with-extending-thinking-and-tool-calls-2.json
    │   │   │   └── text-with-extending-thinking-and-tool-calls-3.json
    │   │   ├── deepseek/
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-max-tokens-1.sse
    │   │   │   ├── stream-system-prompt-1.sse
    │   │   │   ├── stream-with-tools-1.sse
    │   │   │   ├── stream-with-tools-2.sse
    │   │   │   └── structured-1.json
    │   │   ├── gemini/
    │   │   │   ├── create-cache-1.json
    │   │   │   ├── embeddings-file-1.json
    │   │   │   ├── embeddings-input-1.json
    │   │   │   ├── embeddings-with-dimensionality-1.json
    │   │   │   ├── embeddings-with-meta-1.json
    │   │   │   ├── embeddings-with-task-type-1.json
    │   │   │   ├── embeddings-with-title-1.json
    │   │   │   ├── generate-structured-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-a-prompt-with-no-thinking-budget-1.json
    │   │   │   ├── generate-text-with-a-prompt-with-thinking-budget-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-required-tool-call-1.json
    │   │   │   ├── generate-text-with-search-grounding-1.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── image-detection-1.json
    │   │   │   ├── media-detection-1.json
    │   │   │   ├── media-detection-2.json
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-with-tools-1.json
    │   │   │   ├── stream-with-tools-2.json
    │   │   │   ├── stream-with-tools-search-grounding-1.json
    │   │   │   ├── text-with-pdf-documents-1.json
    │   │   │   ├── text-with-text-documents-1.json
    │   │   │   ├── use-cache-with-structured-1.json
    │   │   │   ├── use-cache-with-structured-2.json
    │   │   │   ├── use-cache-with-text-1.json
    │   │   │   └── use-cache-with-text-2.json
    │   │   ├── groq/
    │   │   │   ├── audio-from-base64-1.json
    │   │   │   ├── audio-from-path-1.json
    │   │   │   ├── audio-from-path-text-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-multiple-tools-3.json
    │   │   │   ├── generate-text-with-required-tool-call-1.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── image-detection-1.json
    │   │   │   ├── speech-to-text-basic-1.json
    │   │   │   ├── speech-to-text-complex-1.json
    │   │   │   ├── speech-to-text-simple-1.json
    │   │   │   ├── speech-to-text-usage-1.json
    │   │   │   ├── speech-to-text-verbose-1.json
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-with-tools-1.sse
    │   │   │   ├── stream-with-tools-2.sse
    │   │   │   ├── stream-with-tools-3.sse
    │   │   │   ├── structured-1.json
    │   │   │   ├── text-image-from-base64-1.json
    │   │   │   ├── text-image-from-url-1.json
    │   │   │   ├── text-to-speech-basic-1.json
    │   │   │   ├── text-to-speech-speed-1.json
    │   │   │   ├── text-to-speech-voice-1.json
    │   │   │   └── text-to-speech-wav-1.json
    │   │   ├── mistral/
    │   │   │   ├── audio-from-base64-1.json
    │   │   │   ├── audio-from-path-1.json
    │   │   │   ├── audio-from-path-vtt-1.json
    │   │   │   ├── embeddings-file-1.json
    │   │   │   ├── embeddings-input-1.json
    │   │   │   ├── embeddings-multiple-inputs-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-reasoning-model-1.json
    │   │   │   ├── generate-text-with-required-tool-call-1.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── image-detection-1.json
    │   │   │   ├── ocr-response-1.json
    │   │   │   ├── speech-to-text-basic-1.json
    │   │   │   ├── speech-to-text-complex-1.json
    │   │   │   ├── speech-to-text-simple-1.json
    │   │   │   ├── speech-to-text-usage-1.json
    │   │   │   ├── speech-to-text-verbose-1.json
    │   │   │   ├── stream-basic-text-1-1.sse
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-with-tools-1-1.sse
    │   │   │   ├── stream-with-tools-1-2.sse
    │   │   │   ├── structured-1.json
    │   │   │   ├── text-document-from-url-1.json
    │   │   │   ├── text-image-from-base64-1.json
    │   │   │   └── text-image-from-url-1.json
    │   │   ├── ollama/
    │   │   │   ├── embeddings-file-1.json
    │   │   │   ├── embeddings-input-1.json
    │   │   │   ├── embeddings-multiple-inputs-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-messages-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── image-detection-1.json
    │   │   │   ├── stream-basic-text-1.sse
    │   │   │   ├── stream-multi-tool-conversation-1.sse
    │   │   │   ├── stream-with-thinking-1.sse
    │   │   │   ├── stream-with-thinking-enabled-1.sse
    │   │   │   ├── stream-with-tools-1.sse
    │   │   │   ├── stream-with-tools-2.sse
    │   │   │   ├── stream-with-tools-3.sse
    │   │   │   ├── stream-without-thinking-1.sse
    │   │   │   ├── structured-1.json
    │   │   │   ├── structured-with-multiple-tools-structured-mode-1.json
    │   │   │   ├── structured-with-multiple-tools-structured-mode-2.json
    │   │   │   ├── text-image-from-base64-1.json
    │   │   │   ├── text-with-thinking-enabled-1.json
    │   │   │   └── text-without-thinking-1.json
    │   │   ├── openai/
    │   │   │   ├── anyof-structured-1.json
    │   │   │   ├── audio-from-base64-1.json
    │   │   │   ├── audio-from-path-1.json
    │   │   │   ├── audio-from-path-vtt-1.json
    │   │   │   ├── cache-usage-automatic-caching-1.json
    │   │   │   ├── cache-usage-automatic-caching-2.json
    │   │   │   ├── embeddings-file-1.json
    │   │   │   ├── embeddings-input-1.json
    │   │   │   ├── embeddings-with-dimensions-1.json
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-code-interpreter-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-null-tool-call-1.json
    │   │   │   ├── generate-text-with-required-tool-call-1.json
    │   │   │   ├── generate-text-with-required-tool-call-and-provider-tool-1.json
    │   │   │   ├── generate-text-with-required-tool-call-and-provider-tool-2.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── generate-text-with-web-search-citations-1.json
    │   │   │   ├── generate-text-with-web-search-citations-included-in-turn-1.json
    │   │   │   ├── generate-text-with-web-search-citations-included-in-turn-2.json
    │   │   │   ├── nullable-anyof-structured-1.json
    │   │   │   ├── stream-basic-text-responses-1.json
    │   │   │   ├── stream-falsy-argument-conversation-responses-1.json
    │   │   │   ├── stream-falsy-argument-conversation-responses-2.json
    │   │   │   ├── stream-multi-tool-conversation-responses-1.json
    │   │   │   ├── stream-multi-tool-conversation-responses-2.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-1.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-2.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-3.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-past-reasoning-1.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-past-reasoning-2.json
    │   │   │   ├── stream-multi-tool-conversation-responses-reasoning-past-reasoning-3.json
    │   │   │   ├── stream-rate-limited-1.json
    │   │   │   ├── stream-reasoning-effort-1.json
    │   │   │   ├── stream-unknown-error-responses-1.json
    │   │   │   ├── stream-with-provider-tool-1.json
    │   │   │   ├── stream-with-tools-responses-1.json
    │   │   │   ├── stream-with-tools-responses-2.json
    │   │   │   ├── strict-schema-defaults-1.json
    │   │   │   ├── strict-schema-setting-set-1.json
    │   │   │   ├── structured-cache-usage-automatic-caching-1.json
    │   │   │   ├── structured-cache-usage-automatic-caching-2.json
    │   │   │   ├── structured-json-mode-1.json
    │   │   │   ├── structured-reasoning-effort-1.json
    │   │   │   ├── structured-structured-mode-1.json
    │   │   │   ├── text-reasoning-effort-1.json
    │   │   │   ├── text-response-with-document-1.json
    │   │   │   ├── tts-all-options-1.json
    │   │   │   ├── tts-tts-1-1.json
    │   │   │   └── tts-voice-option-1.json
    │   │   ├── openrouter/
    │   │   │   ├── generate-text-with-a-prompt-1.json
    │   │   │   ├── generate-text-with-multiple-tools-1.json
    │   │   │   ├── generate-text-with-multiple-tools-2.json
    │   │   │   ├── generate-text-with-system-prompt-1.json
    │   │   │   ├── stream-text-with-a-prompt-1.sse
    │   │   │   ├── stream-text-with-empty-parameters-tools-when-using-gpt-5-1.sse
    │   │   │   ├── stream-text-with-empty-parameters-tools-when-using-gpt-5-2.sse
    │   │   │   ├── stream-text-with-reasoning-1.sse
    │   │   │   ├── stream-text-with-tools-1.sse
    │   │   │   ├── stream-text-with-tools-2.sse
    │   │   │   └── structured-1.json
    │   │   ├── Responses/
    │   │   │   └── xai/
    │   │   │       ├── stream-basic-text-responses.php
    │   │   │       ├── stream-falsy-argument-conversation-responses.php
    │   │   │       ├── stream-multi-tool-conversation-responses.php
    │   │   │       ├── stream-unknown-error-responses.php
    │   │   │       ├── stream-with-tools-responses.php
    │   │   │       ├── structured-basic-response.php
    │   │   │       ├── structured-with-meta.php
    │   │   │       └── structured-with-usage.php
    │   │   ├── voyageai/
    │   │   │   ├── embeddings-from-input-1.json
    │   │   │   ├── embeddings-from-multiple-inputs-1.json
    │   │   │   ├── embeddings-with-input-type-1.json
    │   │   │   ├── embeddings-with-input-type-and-truncation-1.json
    │   │   │   └── embeddings-with-truncation-1.json
    │   │   └── xai/
    │   │       ├── generate-text-with-a-prompt-1.json
    │   │       ├── generate-text-with-multiple-tools-1.json
    │   │       ├── generate-text-with-multiple-tools-2.json
    │   │       ├── generate-text-with-multiple-tools-3.json
    │   │       ├── generate-text-with-required-tool-call-1.json
    │   │       ├── generate-text-with-specific-tool-call-1.json
    │   │       ├── generate-text-with-system-prompt-1.json
    │   │       ├── image-detection-1.json
    │   │       ├── stream-basic-text-responses-1.json
    │   │       ├── stream-basic-text-responses-with-zeros-1.json
    │   │       ├── stream-with-reasoning-responses-1.json
    │   │       ├── stream-with-tools-responses-1.json
    │   │       ├── stream-with-tools-responses-2.json
    │   │       ├── stream-with-tools-responses-3.json
    │   │       ├── structured-basic-response-1.json
    │   │       ├── structured-with-meta-1.json
    │   │       ├── text-image-from-base64-1.json
    │   │       └── text-image-from-url-1.json
    │   ├── Http/
    │   │   ├── PrismChatControllerTest.php
    │   │   └── PrismModelControllerTest.php
    │   ├── Providers/
    │   │   ├── Anthropic/
    │   │   │   ├── AnthropicClientTest.php
    │   │   │   ├── AnthropicStructuredRequestTest.php
    │   │   │   ├── AnthropicTextRequestTest.php
    │   │   │   ├── AnthropicTextTest.php
    │   │   │   ├── CitationsMapperTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   └── ToolMapTest.php
    │   │   ├── DeepSeek/
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   ├── TextTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── ElevenLabs/
    │   │   │   └── AudioTest.php
    │   │   ├── Gemini/
    │   │   │   ├── CacheTest.php
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── GeminiExceptionsTest.php
    │   │   │   ├── GeminiMediaTest.php
    │   │   │   ├── GeminiStreamTest.php
    │   │   │   ├── GeminiStructuredTest.php
    │   │   │   ├── GeminiTextTest.php
    │   │   │   ├── ImagesTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── SchemaMapTest.php
    │   │   │   ├── ToolChoiceMapTest.php
    │   │   │   ├── ToolTest.php
    │   │   │   └── ValueObjects/
    │   │   │       ├── MessagePartWithSearchGroundingsTest.php
    │   │   │       └── SearchGroundingTest.php
    │   │   ├── Groq/
    │   │   │   ├── AudioTest.php
    │   │   │   ├── GroqTextTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── Mistral/
    │   │   │   ├── AudioTest.php
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── MistralExceptionsTest.php
    │   │   │   ├── MistralOCRTest.php
    │   │   │   ├── MistralTextTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── Ollama/
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   ├── TextTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── OpenAI/
    │   │   │   ├── AnyOfSchemaTest.php
    │   │   │   ├── AudioTest.php
    │   │   │   ├── CitationsMapperTest.php
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── ImagesTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── OpenAIExceptionsTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   ├── TextTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── OpenRouter/
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   ├── ExceptionHandlingTest.php
    │   │   │   ├── MessageMapTest.php
    │   │   │   ├── StreamTest.php
    │   │   │   ├── StructuredTest.php
    │   │   │   ├── TextTest.php
    │   │   │   └── ToolTest.php
    │   │   ├── VoyageAI/
    │   │   │   ├── EmbeddingsTest.php
    │   │   │   └── VoyageAITest.php
    │   │   └── XAI/
    │   │       ├── MessageMapTest.php
    │   │       ├── StreamTest.php
    │   │       ├── StructuredTest.php
    │   │       ├── ToolTest.php
    │   │       └── XAITextTest.php
    │   ├── Streaming/
    │   │   ├── OnStreamEndIntegrationTest.php
    │   │   ├── PrismStreamIntegrationTest.php
    │   │   ├── StreamCollectorTest.php
    │   │   └── Adapters/
    │   │       ├── BroadcastAdapterTest.php
    │   │       ├── DataProtocolAdapterTest.php
    │   │       └── SSEAdapterTest.php
    │   ├── Structured/
    │   │   ├── PendingRequestTest.php
    │   │   └── ResponseBuilderTest.php
    │   ├── TestDoubles/
    │   │   └── TestProvider.php
    │   ├── Testing/
    │   │   ├── AssertRequestTest.php
    │   │   ├── FakeResponsesTest.php
    │   │   ├── FakeStepsTest.php
    │   │   └── PrismFakeTest.php
    │   ├── Text/
    │   │   ├── PendingRequestTest.php
    │   │   └── ResponseBuilderTest.php
    │   ├── Unit/
    │   │   ├── Providers/
    │   │   │   ├── Anthropic/
    │   │   │   │   └── AnthropicStreamStateTest.php
    │   │   │   └── Ollama/
    │   │   │       └── OllamaStreamStateTest.php
    │   │   └── Streaming/
    │   │       ├── StreamStateTest.php
    │   │       └── Events/
    │   │           ├── ErrorEventTest.php
    │   │           ├── StreamEndEventTest.php
    │   │           ├── StreamStartEventTest.php
    │   │           ├── TextCompleteEventTest.php
    │   │           ├── TextDeltaEventTest.php
    │   │           ├── TextStartEventTest.php
    │   │           ├── ThinkingCompleteEventTest.php
    │   │           ├── ThinkingEventTest.php
    │   │           ├── ThinkingStartEventTest.php
    │   │           ├── ToolCallEventTest.php
    │   │           └── ToolResultEventTest.php
    │   └── ValueObjects/
    │       ├── ToolCallTest.php
    │       └── Media/
    │           ├── DocumentTest.php
    │           └── MediaTest.php
    ├── workbench/
    │   ├── app/
    │   │   ├── Models/
    │   │   │   ├── User.php
    │   │   │   └── .gitkeep
    │   │   └── Providers/
    │   │       └── WorkbenchServiceProvider.php
    │   ├── bootstrap/
    │   │   └── app.php
    │   ├── database/
    │   │   ├── factories/
    │   │   │   ├── UserFactory.php
    │   │   │   └── .gitkeep
    │   │   ├── migrations/
    │   │   │   └── .gitkeep
    │   │   └── seeders/
    │   │       └── DatabaseSeeder.php
    │   ├── resources/
    │   │   └── views/
    │   │       └── .gitkeep
    │   └── routes/
    │       ├── console.php
    │       └── web.php
    └── .github/
        ├── CONTRIBUTING.md
        ├── FUNDING.yml
        ├── pull_request_template.md
        ├── SECURITY.md
        └── workflows/
            ├── formatting.yml
            ├── phpstan.yml
            └── tests.yml

================================================
FILE: README.md
================================================
<p align="center">
  <img src="assets/prism-logo.webp" />
</p>

<p align="center">
    <a href="https://packagist.org/packages/prism-php/prism">
        <img src="https://poser.pugx.org/prism-php/prism/d/total.svg" alt="Total Downloads">
    </a>
    <a href="https://packagist.org/packages/prism-php/prism">
        <img src="https://poser.pugx.org/prism-php/prism/v/stable.svg" alt="Latest Stable Version">
    </a>
    <a href="https://packagist.org/packages/prism-php/prism">
        <img src="https://poser.pugx.org/prism-php/prism/license.svg" alt="License">
    </a>
</p>

# Prism

Prism is a powerful Laravel package for integrating Large Language Models (LLMs) into your applications. It provides a fluent interface for generating text, handling multi-step conversations, and utilizing tools with various AI providers. This way, you can focus on developing outstanding AI applications for your users without getting lost in the technical intricacies.

## Official Documentation

Official documentation can be found on the [Prism website](https://prismphp.com).

## Code of Conduct

While we aren't affiliated with Laravel, we follow the Laravel [Code of Conduct](https://laravel.com/docs/contributions#code-of-conduct). We expect you to abide by these guidelines as well.

## Authors

This library is created by [TJ Miller](https://tjmiller.me) with contributions from the [Open Source Community](https://github.com/prism-php/prism/graphs/contributors).

## License

The MIT License (MIT). Please see [License File](LICENSE) for more information.



================================================
FILE: composer.json
================================================
{
  "name": "prism-php/prism",
  "description": "A powerful Laravel package for integrating Large Language Models (LLMs) into your applications.",
  "type": "library",
  "license": "MIT",
  "autoload": {
    "psr-4": {
      "Prism\\Prism\\": "src/"
    },
    "files": [
      "src/helpers.php"
    ]
  },
  "authors": [
    {
      "name": "TJ Miller",
      "email": "hello@echolabs.dev"
    }
  ],
  "require": {
    "php": "^8.2",
    "ext-fileinfo": "*",
    "laravel/framework": "^11.0|^12.0"
  },
  "config": {
    "allow-plugins": {
      "php-http/discovery": true,
      "pestphp/pest-plugin": true,
      "phpstan/extension-installer": true
    }
  },
  "require-dev": {
    "pestphp/pest": "^3.0",
    "laravel/pint": "^1.14",
    "phpstan/phpstan": "^2.1",
    "pestphp/pest-plugin-arch": "^3.0",
    "pestphp/pest-plugin-laravel": "^3.0",
    "phpstan/extension-installer": "^1.3",
    "phpstan/phpstan-deprecation-rules": "^2.0",
    "rector/rector": "^2.1",
    "projektgopher/whisky": "^0.7.0",
    "orchestra/testbench": "^10",
    "mockery/mockery": "^1.6",
    "symplify/rule-doc-generator-contracts": "^11.2",
    "phpstan/phpdoc-parser": "^2.0",
    "spatie/laravel-ray": "^1.39"
  },
  "autoload-dev": {
    "psr-4": {
      "Tests\\": "tests/",
      "Workbench\\App\\": "workbench/app/",
      "Workbench\\Database\\Factories\\": "workbench/database/factories/",
      "Workbench\\Database\\Seeders\\": "workbench/database/seeders/"
    }
  },
  "scripts": {
    "post-install-cmd": [
      "whisky update"
    ],
    "post-update-cmd": [
      "whisky update"
    ],
    "post-autoload-dump": [
      "@clear",
      "@prepare"
    ],
    "format": [
      "@php vendor/bin/pint --ansi",
      "@php vendor/bin/rector process --no-diffs"
    ],
    "test": [
      "@php vendor/bin/pest --parallel"
    ],
    "clear": "@php vendor/bin/testbench package:purge-skeleton --ansi",
    "prepare": "@php vendor/bin/testbench package:discover --ansi",
    "build": "@php vendor/bin/testbench workbench:build --ansi",
    "serve": [
      "Composer\\Config::disableProcessTimeout",
      "@build",
      "@php vendor/bin/testbench serve --ansi"
    ],
    "types": [
      "@php vendor/bin/phpstan analyse --verbose --no-ansi"
    ]
  },
  "extra": {
    "laravel": {
      "providers": [
        "Prism\\Prism\\PrismServiceProvider"
      ],
      "aliases": {
        "PrismServer": "Prism\\Prism\\Facades\\PrismServer"
      }
    }
  }
}



================================================
FILE: LICENSE
================================================
MIT License

Copyright (c) 2024 TJ MIller

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.



================================================
FILE: phpstan.neon.dist
================================================
parameters:
    level: 8
    paths:
        - src
    tmpDir: build/phpstan
    reportUnmatchedIgnoredErrors: true
    ignoreErrors:
        - identifier: function.alreadyNarrowedType



================================================
FILE: phpunit.xml.dist
================================================
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/10.3/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Test Suite">
            <directory suffix="Test.php">./tests</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory suffix=".php">./src</directory>
        </include>
    </source>
</phpunit>



================================================
FILE: rector.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Rectors\ReorderMethodsRector;
use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\LevelSetList;
use Rector\Set\ValueObject\SetList;

return RectorConfig::configure()
    ->withParallel()
    ->withPaths([
        __DIR__.'/src',
        __DIR__.'/tests',
    ])
    ->withRules([
        ReorderMethodsRector::class,
    ])
    ->withSets([
        LevelSetList::UP_TO_PHP_82,
        SetList::CODE_QUALITY,
        SetList::DEAD_CODE,
        SetList::EARLY_RETURN,
        SetList::TYPE_DECLARATION,
        SetList::PRIVATIZATION,
    ]);



================================================
FILE: Taskfile.yml
================================================
# https://taskfile.dev

version: "3"

tasks:
  setup:
    cmds:
      - composer install
    sources:
      - composer.json
      - composer.lock
    generates:
      - vendor/autoload.php

  push:
    cmds:
      - git remote | xargs -I{} git push {{.CLI_ARGS}} {}

  format:
    cmds:
      - vendor/bin/rector
      - vendor/bin/pint

  validate:
    cmds:
      - vendor/bin/pest --compact
      - vendor/bin/phpstan



================================================
FILE: testbench.yaml
================================================
providers:
  - Prism\Prism\PrismServiceProvider
  - Workbench\App\Providers\WorkbenchServiceProvider

migrations:
  - workbench/database/migrations

seeders:
  - Workbench\Database\Seeders\DatabaseSeeder

workbench:
  start: "/"
  install: true
  health: false
  discovers:
    web: true
    api: false
    commands: false
    components: false
    views: false
  build: []
  assets: []
  sync: []



================================================
FILE: whisky.json
================================================
{
  "disabled": [],
  "hooks": {
    "pre-commit": [
      "bin/git-hooks/formatting"
    ]
  }
}



================================================
FILE: assets/prism-logo.webp
================================================
[Binary file]


================================================
FILE: config/prism.php
================================================
<?php

return [
    'prism_server' => [
        // The middleware that will be applied to the Prism Server routes.
        'middleware' => [],
        'enabled' => env('PRISM_SERVER_ENABLED', false),
    ],
    'providers' => [
        'openai' => [
            'url' => env('OPENAI_URL', 'https://api.openai.com/v1'),
            'api_key' => env('OPENAI_API_KEY', ''),
            'organization' => env('OPENAI_ORGANIZATION', null),
            'project' => env('OPENAI_PROJECT', null),
        ],
        'anthropic' => [
            'api_key' => env('ANTHROPIC_API_KEY', ''),
            'version' => env('ANTHROPIC_API_VERSION', '2023-06-01'),
            'default_thinking_budget' => env('ANTHROPIC_DEFAULT_THINKING_BUDGET', 1024),
            // Include beta strings as a comma separated list.
            'anthropic_beta' => env('ANTHROPIC_BETA', null),
        ],
        'ollama' => [
            'url' => env('OLLAMA_URL', 'http://localhost:11434'),
        ],
        'mistral' => [
            'api_key' => env('MISTRAL_API_KEY', ''),
            'url' => env('MISTRAL_URL', 'https://api.mistral.ai/v1'),
        ],
        'groq' => [
            'api_key' => env('GROQ_API_KEY', ''),
            'url' => env('GROQ_URL', 'https://api.groq.com/openai/v1'),
        ],
        'xai' => [
            'api_key' => env('XAI_API_KEY', ''),
            'url' => env('XAI_URL', 'https://api.x.ai/v1'),
        ],
        'gemini' => [
            'api_key' => env('GEMINI_API_KEY', ''),
            'url' => env('GEMINI_URL', 'https://generativelanguage.googleapis.com/v1beta/models'),
        ],
        'deepseek' => [
            'api_key' => env('DEEPSEEK_API_KEY', ''),
            'url' => env('DEEPSEEK_URL', 'https://api.deepseek.com/v1'),
        ],
        'elevenlabs' => [
            'api_key' => env('ELEVENLABS_API_KEY', ''),
            'url' => env('ELEVENLABS_URL', 'https://api.elevenlabs.io/v1/'),
        ],
        'voyageai' => [
            'api_key' => env('VOYAGEAI_API_KEY', ''),
            'url' => env('VOYAGEAI_URL', 'https://api.voyageai.com/v1'),
        ],
        'openrouter' => [
            'api_key' => env('OPENROUTER_API_KEY', ''),
            'url' => env('OPENROUTER_URL', 'https://openrouter.ai/api/v1'),
            'site' => [
                'http_referer' => env('OPENROUTER_SITE_HTTP_REFERER', null),
                'x_title' => env('OPENROUTER_SITE_X_TITLE', null),
            ],
        ],
    ],
];



================================================
FILE: docs/README.md
================================================
# Prism Docs

The Prism docs are built using [Vitepress](https://vitepress.dev) and deployed via [Netlify](https://www.netlify.com).

> [!IMPORTANT]
> Make sure you review the [documentation style guide](./documentation-style-guide.md)!

## Development

```shell
npm run docs:dev
```

### Adding a new Provider

- Update `getting-started/introduction.md` and add the new provider to the supported provider list
  - Ensure the provider list remains in alphanumeric order
- Create a provider page in `providers/{provider.md}` using the template (`providers/provider.md.template`)
  - Remove any sections that are not needed
- Update `./vitepress/config.mts` and add the provider to the provider sidebar
  - Ensure the provider sidebar section remains in alphanumeric order

## Production

```shell
npm run docs:build
```



================================================
FILE: docs/documentation-style-guide.md
================================================
# Technical Documentation Style Guide
## Core Principles
### 1. Conversational Professionalism

- Write as if you're having a focused conversation with a peer
- Use "you" to directly address the reader
- Keep it professional but not rigid or overly formal
- Include occasional lighthearted remarks without being silly
Example:

```
❌ "The configuration file must be published prior to utilization."
✅ "First, let's publish your config file so you can customize these options."
```

### 2. Clear and Direct

- Get to the point quickly
- Use active voice
- Break complex concepts into digestible chunks
- Front-load important information

Example:

```
❌ "It is recommended that validation be implemented using the provided methods."
✅ "Validate your inputs using the validate() method."
```

### 3. Authentic Enthusiasm

- Show genuine excitement for powerful features
- Highlight elegant solutions
- Express appreciation for good practices
- Share useful tips naturally

Example:

```
❌ "The feature enables asynchronous processing capabilities."
✅ "This powerful feature lets you process jobs in the background, keeping your app snappy and responsive."
```

## Writing Guidelines
### Structure and Flow

- Start with a brief, engaging introduction
- Use progressive disclosure - basic concepts first, then advanced
- Include relevant cross-references

### Code Examples

- Show real-world, practical examples
- Include comments for complex parts
- Demonstrate both basic and advanced usage
- Follow code style conventions
- Use meaningful variable names

Example:

```php
// Basic Example
$users = User::where('active', true)
    ->orderBy('name')
    ->get();
// With Additional Constraints
$users = User::where('active', true)
    ->whereHas('subscriptions', function ($query) {
        $query->where('status', 'active');
    })
    ->orderBy('name')
    ->get();
```

### Language Patterns
#### Do:

- Use contractions naturally (you'll, we're, let's)
- Write in a confident, positive tone
- Include subtle humor when appropriate
- Acknowledge common pitfalls
- Offer best practices and tips

#### Don't:

- Use jargon without explanation
- Write overly long paragraphs
- Sound condescending or patronizing
- Use excessive exclamation points
- Include unnecessary abstractions
- Use Emojis

### Formatting Best Practices

1. **Headers and Sections**
   - Use clear, descriptive headers
   - Keep hierarchy logical
   - Include jump links for long pages
2. **Lists and Tables**
   - Use bullet points for related items
   - Create tables for comparing options
   - Include examples after lists
3. **Callouts and Notes**
   - Highlight important warnings
   - Share pro tips in callouts
   - Use consistent styling for notes

Example:

```
> [!NOTE]
> Highlights information that users should take into account, even when skimming.
> [!TIP]
> Optional information to help a user be more successful.
> [!IMPORTANT]
> Crucial information necessary for users to succeed.
> [!WARNING]
> Critical content demanding immediate user attention due to potential risks.
> [!CAUTION]
> Negative potential consequences of an action.
```

## Tone Examples
### Introduction

```
❌ "This documentation delineates the methodologies for implementing the authentication system."
✅ "In this guide, you'll learn how to add authentication to your app. We'll cover everything from basic login forms to OAuth providers."
```

### Explanations

```
❌ "The utilization of queues facilitates the handling of resource-intensive operations."
✅ "Queues let you handle time-consuming tasks in the background, keeping your app fast and your users happy."
```

### Error Handling

```
❌ "Exception handling must be implemented to prevent application failure."
✅ "Let's make your app more robust by catching and handling potential errors gracefully."
```

## Key Takeaways

1. **Be Human**
   - Write like you're explaining to a colleague
   - Show personality while maintaining professionalism
   - Be encouraging and supportive
2. **Be Clear**
   - Use simple, direct language
   - Explain complex concepts step by step
   - Provide real-world examples
3. **Be Helpful**
   - Anticipate common questions
   - Offer best practices
   - Include troubleshooting tips
   - Link to related resources

Remember: Great documentation feels like a conversation with a knowledgeable friend who genuinely wants to help you succeed.



================================================
FILE: docs/index.md
================================================
---
# https://vitepress.dev/reference/default-theme-home-page
layout: home

hero:
  name: "Prism"
  text: Laravel x LLMs
  tagline: "Prism is a powerful Laravel package for integrating Large Language Models (LLMs) into your applications."
  actions:
    - theme: brand
      text: Get Started
      link: /getting-started/introduction
    - theme: alt
      text: Sponsor
      link: https://github.com/sponsors/sixlive
    - theme: alt
      text: Github
      link: https://github.com/prism-php/prism
  image:
    src: /assets/prism-logo.webp
    alt: Prism Logo

features:
  - title: Elegant Provider Integrations
    details: Seamlessly switch between AI providers like OpenAI, Anthropic, and Ollama with a clean, expressive syntax you'll love.
  - title: Fluent Text Generation API
    details: Craft AI-powered text with an intuitive, chainable API that feels right at home in your Laravel projects.
  - title: Seamless Tool Integration
    details: Empower your AI with custom tools and external APIs, extending its capabilities with Laravel-like simplicity.
  - title: Structured Output Handling
    details: Transform AI responses into strongly-typed data with schema validation and rich object mapping - perfect for building robust APIs and applications.
  - title: First-Class Testing Support
    details: Write confident code with our comprehensive testing utilities, including response faking and detailed assertion helpers that make unit testing a breeze.
  - title: Multi-Modal Capabilities
    details: Work with text, images, and audio seamlessly using the same elegant API, enabling rich understanding and context-aware responses across all media types.
---



================================================
FILE: docs/package.json
================================================
{
  "scripts": {
    "docs:dev": "vitepress dev",
    "docs:build": "vitepress build",
    "docs:preview": "vitepress preview"
  },
  "devDependencies": {
    "vitepress": "^1.3.4",
    "vitepress-plugin-llms": "^1.2.0"
  }
}



================================================
FILE: docs/advanced/custom-providers.md
================================================
# Custom Providers

Want to add support for a new AI provider in Prism? This guide will walk you through creating and registering your own custom provider implementation.

## Building Your Provider

All providers must extend the `Prism\Prism\Providers\Provider` abstract class. This base class provides default implementations for all required methods, throwing exceptions for unsupported actions.

When creating your provider, you'll only need to override the methods for the features you want to support:
- `text()` - For text generation
- `structured()` - For structured output generation
- `embeddings()` - For creating embeddings
- `images()` - For image generation
- `stream()` - For streaming text responses

Here's what that looks like in practice:

```php
namespace App\Prism\Providers;

use Prism\Prism\Providers\Provider;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class MyCustomProvider extends Provider
{
    public function __construct(
        protected string $apiKey,
    ) {}

    public function text(TextRequest $request): TextResponse
    {
        // Your text generation logic here
        // Make API calls, process the response, and return a TextResponse
    }

    // Only override the methods you need!
}
```

## Registration Process

Once you've created your provider, you'll need to register it with Prism. Let's add it to a service provider:

```php
namespace App\Providers;

use App\Prism\Providers\MyCustomProvider;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        $this->app['prism-manager']->extend('my-custom-provider', function ($app, $config) {
            return new MyCustomProvider(
                apiKey: $config['api_key'] ?? '',
            );
        });
    }
}
```

Next, add your provider configuration to `config/prism.php`:

```php
return [
    'providers' => [
        // ... other providers ...
        'my-custom-provider' => [
            'api_key' => env('MY_CUSTOM_PROVIDER_API_KEY'),
        ],
    ],
];
```

That's it! You're ready to use your custom provider:

```php
use Prism\Prism\Facades\Prism;

$response = Prism::text()
    ->using('my-custom-provider', 'model-name')
    ->withPrompt('Hello, custom AI!')
    ->asText();
```

## Custom Error Handling

Your provider inherits a default `handleRequestException` method that handles common HTTP status codes. You can override this method to handle provider-specific errors or add custom logic:

```php
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Exceptions\PrismException;

class MyCustomProvider extends Provider
{
    // ... other methods ...

    public function handleRequestException(string $model, RequestException $e): never
    {
        // Handle provider-specific error codes
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make(
                rateLimits: $this->processRateLimits($e->response),
                retryAfter: $e->response->header('retry-after') === ''
                    ? null
                    : (int) $e->response->header('retry-after'),
            ),
            default => parent::handleRequestException($model, $e),
        };
    }
}
```

The method must throw an exception (return type `never`). If you don't handle a specific status code, make sure to call the parent method to maintain the default error handling.

## Best Practices

- **Start small**: Begin by implementing just the methods you need. You don't have to support every feature right away.
- **Handle errors gracefully**: Leverage the inherited error handling or override `handleRequestException()` for provider-specific errors (see Custom Error Handling section above).
- **Test thoroughly**: Make sure to test your provider with various inputs and edge cases.
- **Document your models**: Let users know which models your provider supports and any special parameters they can use.

> [!TIP]
> Looking at existing provider implementations in Prism's source code can give you great insights into best practices and patterns to follow.



================================================
FILE: docs/advanced/error-handling.md
================================================
<script setup>
import ExceptionSupport from '../components/ExceptionSupport.vue'
</script>

# Error handling

By default, Prism throws a `PrismException` for Prism errors, or a `PrismServerException` for Prism Server errors.

For production use cases, you may find yourself needing to catch Exceptions more granularly, for instance to provide more useful error messages to users or to implement failover or retry logic.

Prism has begun rolling out more specific exceptions as use cases arise.

## Provider agnostic exceptions

- `PrismStructuredDecodingException` where a provider has returned invalid JSON for a structured request.

## Exceptions based on provider feedback

Prism currently supports three exceptions based on provider feedback:

- `PrismRateLimitedException` where you have hit a rate limit or quota (see [Handling rate limits](/advanced/rate-limits.html) for more info).
- `PrismProviderOverloadedException` where the provider is unable to fulfil your request due to capacity issues.
- `PrismRequestTooLargeException` where your request is too large.

However, as providers all handle errors differently, support is being rolled out incrementally. If you'd like to make your first contribution, adding one or more of these exceptions for a provider would make a great first contribution. If you'd like to discuss, start an issue on Github, or just jump straight into a pull request.

<ExceptionSupport />


================================================
FILE: docs/advanced/provider-interoperability.md
================================================
# Provider Interoperability

When working with Prism, you might need to customize requests based on which provider you're using. Different providers have unique capabilities, configuration options, and requirements that can affect how you structure your requests for optimal results.

## Using the `whenProvider` Method

The `whenProvider` method lets you easily customize your requests for specific providers while maintaining clean, readable code.

```php
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->withPrompt('Who are you?')
    ->whenProvider(
        Provider::Anthropic,
        fn ($request) => $request
            ->withProviderOptions([
                'cacheType' => 'ephemeral',
            ])
    )
    ->asText();
```

In this example, the `withProviderOptions` settings will only be applied when using Anthropic's provider. If you're using OpenAI (as specified in the `using` method), these customizations are simply skipped.

## Key Benefits

- **Cleaner Code**: Keep your provider-specific customizations encapsulated and only apply them when needed
- **Easy Provider Switching**: Swap between providers without rewriting your configuration code
- **Maintainable Applications**: Define provider-specific behaviors in one place

## Advanced Usage

You can chain multiple `whenProvider` calls to handle different provider scenarios:

```php
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->withPrompt('Generate a creative story about robots.')
    ->whenProvider(
        Provider::Anthropic,
        fn ($request) => $request
            ->withMaxTokens(4000)
            ->withProviderOptions(['cacheType' => 'ephemeral'])
    )
    ->whenProvider(
        Provider::OpenAI,
        fn ($request) => $request
            ->withMaxTokens(2000)
            ->withProviderOptions(['response_format' => ['type' => 'text']])
    )
    ->asText();
```

## Using Invokable Classes

For more complex provider-specific configurations, you can use invokable classes instead of closures:

```php
class AnthropicConfigurator
{
    public function __invoke($request)
    {
        return $request
            ->withMaxTokens(4000)
            ->withProviderOptions([
                'cacheType' => 'ephemeral',
                'citations' => true,
            ]);
    }
}

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withPrompt('Explain the theory of relativity.')
    ->whenProvider(Provider::Anthropic, new AnthropicConfigurator())
    ->asText();
```

This approach can be especially helpful when you have complex or reusable provider configurations.

> [!TIP]
> The `whenProvider` method works with all request types in Prism including text, structured output, and embeddings requests.

## Best Practices

### Avoiding SystemMessages with Multiple Providers

When working with multiple providers, it's best to avoid using `SystemMessages` directly in your `withMessages` array. Instead, use the `withSystemPrompt` method as it offers better provider interoperability.

```php
// Avoid this when switching between providers
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->withMessages([
        new SystemMessage('You are a helpful assistant.'),
        new UserMessage('Tell me about AI'),
    ])
    ->asText();

// Prefer this instead
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->withSystemPrompt('You are a helpful assistant.')
    ->withPrompt('Tell me about AI')
    ->asText();
```

This approach allows Prism to handle the provider-specific formatting of system messages, making your code more portable across different LLM providers.



================================================
FILE: docs/advanced/rate-limits.md
================================================
# Handling Rate Limits

Hitting issues with rate limits? We've got you covered!

In this guide we will look at handling:
- situations where you actually hit a rate limit (i.e. HTTP 429); and
- dynamic rate limiting (figuring out when you can make your next request, from a successful request).

## Provider support

Prism throws a `PrismRateLimitedException` for all providers other than DeepSeek (which does not have rate limits).

Prism provides an array of `ProviderRateLimit` value objects on the exception and on meta for all providers other than OpenAI, Gemini, xAI and VoyageAI - as they do not provide the necessary headers to do so.

## The ProviderRateLimit value object

Throughout this guide, we'll talk about the `ProviderRateLimit` value object.

Each `ProviderRateLimit` has four properties:
- name - the name given to that rate limit by the provider - e.g. "input-tokens"
- limit - the current limit set on your API key by the provider - e.g. for input-tokens, perhaps 80000
- remaining - how many you have left - e.g. for input-tokens if you have used 30000 out of your 80000 limit - this will be 50000
- resetsAt - a Carbon instance with the date and time at which remaining will reset to limit

## Handling a rate limit hit

Prism throws a `PrismRateLimitedException` when you hit a rate limit.

You can catch that exception, gracefully fail and inspect the `rateLimits` property which contains an array of `ProviderRateLimit`s. 

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Prism\Prism\Exceptions\PrismRateLimitedException;

try {
    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
        ->withPrompt('Hello world!')
        ->asText();
}
catch (PrismRateLimitedException $e) {
    /** @var ProviderRateLimit $rate_limit */ 
    foreach ($e->rateLimits as $rate_limit) {
        // Loop through rate limits...
    }
    
    // Log, fail gracefully, etc.
}
```

### Figuring out which rate limit you have hit

In a simple world, they'd only be one rate limit. 

However most providers implement various rate limits (e.g. request, input tokens, output tokens, etc.) and provide you with information on all of them on all requests, regardless of which you have hit.

For simple rate limits like "requests", the `remaining` property on `ProviderRateLimit` will be 0 if you have hit it. These are easy to find:

```php 
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Illuminate\Support\Arr;

try {
    // Your request
}
catch (PrismRateLimitedException $e) {
    $hit_limit = Arr::first($e->rateLimits, fn(ProviderRateLimit $rate_limit) => $rate_limit->remaining === 0);
}
```

For less simple rate limits like input tokens, the `remaining` property may not be zero. For instance, if you have 5,000 input tokens remaining and submit a request requiring 6,000 tokens, you'll be rate limited but remaining will still show 5,000.

Here, you may need to implement some logic to approximate how many tokens your request will use before sending it, and then test against that:

```php 
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Illuminate\Support\Arr;

try {
    // Your request
}
catch (PrismRateLimitedException $e) {
    $input_token_limit = Arr::first($e->rateLimits, fn(ProviderRateLimit $rate_limit) => $rate_limit->name === 'input-tokens');

    if ($input_token_limit < $your_token_estimate) {
        // Handle
    }
}
```

To help with approximating input token usage, we plan to implement Anthopic's token counting endpoint in a future release. 

For providers that don't have a token counting endpoint, you could either roll your own token counter or use something like [tiktoken](https://github.com/openai/tiktoken) if you are comfortable calling out to Python.

Once you know which rate limit you have hit, you'll want to ensure your app does not continue making requests until after the `ProviderRateLimit` `resetsAt` property. 

If you aren't sure where to start with that, check out the [What should you do with rate limit information](#what-should-you-do-with-rate-limit-information) section below.

## Dynamic rate limiting

Prism adds the same rate limit information to every successful request:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\ProviderRateLimit;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt('Hello world!')
    ->asText();
    
/** @var ProviderRateLimit $rate_limit */ 
foreach ($response->meta->rateLimits as $rate_limit) {
    // Handle
}

```

Armed with that information, you'll probably want to [update your app's rate limiter(s)](#what-should-you-do-with-rate-limit-information).

## What should you do with rate limit information?

You'll likely want to implement a rate limiter within your app. Thankfully Laravel, as always, makes this very easy!

You should take a look at the [rate limiting](https://laravel.com/docs/11.x/rate-limiting) docs, and if you are firing requests from your queue, check out the [job middleware](https://laravel.com/docs/11.x/queues#job-middleware) docs.

You should implement a rate limiter / job middleware for each of the provider rate limits your application typically hits. 



================================================
FILE: docs/components/ExceptionSupport.vue
================================================
<template>
  <div>
    <table>
      <thead>
        <tr>
          <th scope="col">Provider</th>
          <th v-for="exception in exceptions" :key="exception" scope="col">
            {{ exception }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="provider in providers" :key="provider.name">
          <th scope="row">{{ provider.name }}</th>
          <td v-for="exception in exceptions" :key="exception">
            <div class="flex justify-center">
              <svg
                v-if="provider[camelCase(exception)] === 'supported'"
                class="w-6 h-6"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M20 6L9 17L4 12"
                  stroke="green"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <svg
                v-else
                class="w-6 h-6"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6l12 12"
                  stroke="red"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="flex gap-4 mt-4">
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M20 6L9 17L4 12"
            stroke="green"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Supported</span>
      </div>
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M18 6L6 18M6 6l12 12"
            stroke="red"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Unsupported</span>
      </div>
    </div>
  </div>
</template>

<script>
const Supported = "supported";
const Unsupported = "unsupported";

export default {
  name: "ExceptionMatrix",
  data() {
    return {
      exceptions: ["Rate Limited", "Overloaded", "Too Large"],
      providers: [
        {
          name: "Amazon Bedrock",
          rateLimited: Unsupported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Anthropic",
          rateLimited: Supported,
          overloaded: Supported,
          tooLarge: Supported,
        },
        {
          name: "Azure OpenAI",
          rateLimited: Unsupported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "DeepSeek",
          rateLimited: Unsupported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Gemini",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Groq",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Mistral",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Ollama",
          rateLimited: Unsupported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "OpenAI",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "Voyage AI",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },
        {
          name: "xAI",
          rateLimited: Supported,
          overloaded: Unsupported,
          tooLarge: Unsupported,
        },        
      ],
    };
  },
  methods: {
    camelCase: (str) => {
      return str.replace(/(?:^\w|[A-Z]|\b\w)/g, function (word, index) {
        return index == 0 ? word.toLowerCase() : word.toUpperCase();
      }).replace(/\s+/g, '')
    }
  }
};
</script>



================================================
FILE: docs/components/ProviderSupport.vue
================================================
<template>
  <div>
    <div style="overflow-x: auto !important; display: block !important; width: 100% !important;">
      <table style="width: 100% !important; min-width: 850px !important;">
        <thead>
          <tr>
            <th scope="col">Provider</th>
            <th v-for="feature in features" :key="feature" scope="col">
              {{ feature }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="provider in providers" :key="provider.name">
            <th scope="row">{{ provider.name }}</th>
            <td v-for="feature in features" :key="feature">
              <div class="flex justify-center">
                <svg
                  v-if="provider[feature.toLowerCase()] === 'supported'"
                  class="w-6 h-6"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M20 6L9 17L4 12"
                    stroke="green"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <svg
                  v-else-if="provider[feature.toLowerCase()] === 'planned'"
                  class="w-6 h-6"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <circle
                    cx="12"
                    cy="12"
                    r="8"
                    stroke="orange"
                    stroke-width="2"
                  />
                </svg>
                <svg
                  v-else-if="provider[feature.toLowerCase()] === 'adapted'"
                  class="w-6 h-6"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 3v3m0 12v3M3 12h3m12 0h3"
                    stroke="green"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                  <circle cx="12" cy="12" r="4" stroke="green" stroke-width="2" />
                </svg>
                <svg
                  v-else
                  class="w-6 h-6"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M18 6L6 18M6 6l12 12"
                    stroke="red"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex gap-4 mt-4">
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M20 6L9 17L4 12"
            stroke="green"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Supported</span>
      </div>
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="12" cy="12" r="8" stroke="orange" stroke-width="2" />
        </svg>
        <span>Planned Support</span>
      </div>
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 3v3m0 12v3M3 12h3m12 0h3"
            stroke="green"
            stroke-width="2"
            stroke-linecap="round"
          />
          <circle cx="12" cy="12" r="4" stroke="green" stroke-width="2" />
        </svg>
        <span>Adapted Support</span>
      </div>
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M18 6L6 18M6 6l12 12"
            stroke="red"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Unsupported</span>
      </div>
    </div>
  </div>
</template>

<script>
const Supported = "supported";
const Planned = "planned";
const Adapted = "adapted";
const Unsupported = "unsupported";

export default {
  name: "CompatibilityMatrix",
  data() {
    return {
      features: [
        "Text",
        "Streaming",
        "Structured",
        "Embeddings",
        "Image",
        "Speech-to-Text",
        "Text-to-Speech",
        "Tools",
        "Documents",
      ],
      providers: [
        {
          name: "Anthropic",
          text: Supported,
          streaming: Supported,
          structured: Adapted,
          embeddings: Unsupported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Supported,
        },
        {
          name: "Azure OpenAI",
          text: Planned,
          streaming: Planned,
          structured: Planned,
          embeddings: Planned,
          image: Planned,
          "speech-to-text": Planned,
          "text-to-speech": Planned,
          tools: Planned,
          documents: Unsupported,
        },
        {
          name: "Bedrock - Anthropic",
          text: Supported,
          streaming: Unsupported,
          structured: Supported,
          embeddings: Unsupported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Unsupported,
        },
        {
          name: "Bedrock - Cohere",
          text: Unsupported,
          streaming: Unsupported,
          structured: Unsupported,
          embeddings: Supported,
          image: Unsupported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Unsupported,
          documents: Unsupported,
        },
        {
          name: "Bedrock - Converse",
          text: Supported,
          streaming: Unsupported,
          structured: Supported,
          embeddings: Unsupported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Supported,
        },
        {
          name: "DeepSeek",
          text: Supported,
          streaming: Unsupported,
          structured: Supported,
          embeddings: Unsupported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Unsupported,
        },
        {
          name: "ElevenLabs",
          text: Unsupported,
          streaming: Unsupported,
          structured: Unsupported,
          embeddings: Unsupported,
          image: Unsupported,
          "speech-to-text": Supported,
          "text-to-speech": Planned,
          tools: Unsupported,
          documents: Unsupported,
        },
        {
          name: "Gemini",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Supported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Supported,
        },
        {
          name: "Groq",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Planned,
          image: Supported,
          "speech-to-text": Supported,
          "text-to-speech": Supported,
          tools: Supported,
          documents: Unsupported,
        },
        {
          name: "Mistral",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Supported,
          image: Supported,
          "speech-to-text": Supported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Supported,
        },
        {
          name: "Ollama",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Supported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Unsupported,
        },
        {
          name: "OpenRouter",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Unsupported,
          image: Unsupported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Unsupported,
        },
        {
          name: "OpenAI",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Supported,
          image: Supported,
          "speech-to-text": Supported,
          "text-to-speech": Supported,
          tools: Supported,
          documents: Supported,
        },
        {
          name: "VoyageAI",
          text: Unsupported,
          streaming: Unsupported,
          structured: Unsupported,
          embeddings: Supported,
          image: Unsupported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Unsupported,
          documents: Unsupported,
        },
        {
          name: "xAI",
          text: Supported,
          streaming: Supported,
          structured: Supported,
          embeddings: Unsupported,
          image: Supported,
          "speech-to-text": Unsupported,
          "text-to-speech": Unsupported,
          tools: Supported,
          documents: Unsupported,
        },
      ],
    };
  },
};
</script>

<style>
.provider-table-wrapper {
  overflow-x: auto;
  width: 100%;
}
.provider-table {
  min-width: 640px;
  width: 100%;
}
</style>



================================================
FILE: docs/core-concepts/audio.md
================================================
# Audio Processing

Transform text into speech and speech into text using AI-powered audio models. Prism provides a unified API for audio processing across different providers, enabling both text-to-speech (TTS) and speech-to-text (STT) functionality.

## Getting Started

### Text-to-Speech

Convert text into natural-sounding speech:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::audio()
    ->using(Provider::OpenAI, 'tts-1')
    ->withInput('Hello, this is a test of text-to-speech functionality.')
    ->withVoice('alloy')
    ->asAudio();

$audio = $response->audio;
if ($audio->hasBase64()) {
    file_put_contents('output.mp3', base64_decode($audio->base64));
    echo "Audio saved as: output.mp3";
}
```

### Speech-to-Text

Convert audio files into text transcriptions:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Audio;

$audioFile = Audio::fromPath('/path/to/audio.mp3');

$response = Prism::audio()
    ->using(Provider::OpenAI, 'whisper-1')
    ->withInput($audioFile)
    ->asText();

echo "Transcription: " . $response->text;
```

## Provider Support

Currently, Prism supports audio processing through:

- **OpenAI**: TTS-1, TTS-1-HD (text-to-speech) and Whisper-1 (speech-to-text)
- **Groq**: PlayAI TTS models (text-to-speech) and Whisper Large V3 models (speech-to-text)

Additional providers will be added in future releases as the ecosystem evolves.

## Basic Usage

### Simple Text-to-Speech

Generate speech from text input:

```php
$response = Prism::audio()
    ->using('openai', 'tts-1')
    ->withInput('Welcome to our application!')
    ->withVoice('alloy')
    ->asAudio();

$audio = $response->audio;
echo "Audio type: " . $audio->getMimeType(); // audio/mpeg
echo "Has audio data: " . ($audio->hasBase64() ? 'Yes' : 'No');
```

### Simple Speech-to-Text

Transcribe audio files to text:

```php
use Prism\Prism\ValueObjects\Media\Audio;

// From file path
$audioFile = Audio::fromPath('/path/to/recording.wav');

// From URL
$audioFile = Audio::fromUrl('https://example.com/audio.mp3');

// From base64 data
$audioFile = Audio::fromBase64($base64AudioData, 'audio/wav');

$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->asText();

// Access the transcription
echo $response->text;
```

## Working with Audio Files

### Creating Audio Objects

The `Audio` class provides several ways to work with audio files:

```php
use Prism\Prism\ValueObjects\Media\Audio;

// From local file
$audio = Audio::fromPath('/path/to/audio.mp3');

// From remote URL
$audio = Audio::fromUrl('https://example.com/speech.wav');

// From base64 encoded data
$audio = Audio::fromBase64($base64Data, 'audio/mpeg');

// From raw binary content
$audio = Audio::fromContent($binaryData, 'audio/wav');
```

### Audio Properties

Access audio file information:

```php
$audio = Audio::fromPath('/path/to/audio.mp3');

echo "MIME type: " . $audio->mimeType();
echo "Has local path: " . ($audio->hasLocalPath() ? 'Yes' : 'No');
echo "File size: " . $audio->size() . " bytes";
```

## Working with Responses

### Text-to-Speech Responses

```php
$response = Prism::audio()
    ->using('openai', 'tts-1-hd')
    ->withInput('This is high-quality text-to-speech.')
    ->withVoice('nova')
    ->asAudio();

// Access the generated audio
$audio = $response->audio;

if ($audio->hasBase64()) {
    // Save to file
    $audioData = base64_decode($audio->base64);
    file_put_contents('speech.mp3', $audioData);
    
    // Get MIME type
    echo "Content type: " . $audio->getMimeType();
}

// Access additional response data
foreach ($response->additionalContent as $key => $value) {
    echo "{$key}: {$value}\n";
}
```

### Speech-to-Text Responses

```php
$audioFile = Audio::fromPath('/path/to/speech.mp3');

$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->asText();

// Access the transcription
$text = $response->text;
echo "Transcription: " . $text;

// Check token usage
if ($response->usage) {
    echo "Prompt tokens: " . $response->usage->promptTokens;
    echo "Completion tokens: " . $response->usage->completionTokens;
}

// Access raw response data
print_r($response->additionalContent);
```

## Voice Selection

Prism provides a dedicated `withVoice()` method for selecting voices in text-to-speech, making voice selection a first-class citizen in the API:

```php
$response = Prism::audio()
    ->using('openai', 'tts-1')
    ->withInput('Hello, how are you today?')
    ->withVoice('alloy')  // Voice options vary by provider
    ->asAudio();
```

## Provider-Specific Options

While Prism provides a consistent API, you can access provider-specific features using the `withProviderOptions()` method.

### OpenAI Text-to-Speech Options

Customize format, speed, and other options:

```php
$response = Prism::audio()
    ->using('openai', 'tts-1')
    ->withInput('Hello, how are you today?')
    ->withVoice('nova')
    ->withProviderOptions([
        'response_format' => 'mp3',           // mp3, opus, aac, flac, wav, pcm
        'speed' => 1.0,                       // 0.25 to 4.0
    ])
    ->asAudio();
```

### OpenAI Speech-to-Text Options

Configure transcription settings:

```php
$audioFile = Audio::fromPath('/path/to/multilingual.mp3');

$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'language' => 'en',
        'prompt' => 'Previous context...'
    ])
    ->asText();
```

### Response Formats

Different response formats provide varying levels of detail:

```php
// Verbose JSON format includes timestamps and confidence scores
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'verbose_json',
    ])
    ->asText();

// Access additional metadata
$metadata = $response->additionalContent;
if (isset($metadata['segments'])) {
    foreach ($metadata['segments'] as $segment) {
        echo "Segment: " . $segment['text'] . "\n";
        echo "Start: " . $segment['start'] . "s\n";
        echo "End: " . $segment['end'] . "s\n";
    }
}
```

## Advanced Usage

Audio can be integrated into multi-modal conversations:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Text;

$audioFile = Audio::fromPath('/path/to/question.mp3');

// First transcribe the audio
$transcription = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->asText();

// Then use in a text conversation
$response = Prism::text()
    ->using('openai', 'gpt-4')
    ->withMessages([
        new UserMessage('', [
            new Text('User asked: '),
            new Text($transcription->text),
            new Text(' - Please provide a detailed response.')
        ])
    ])
    ->asText();

// Convert response back to speech
$speechResponse = Prism::audio()
    ->using('openai', 'tts-1')
    ->withInput($response->text)
    ->withVoice('alloy')
    ->asAudio();
```

## Configuration Options

### Client Configuration

Configure HTTP client options for audio processing:

```php
$response = Prism::audio()
    ->using('openai', 'tts-1')
    ->withInput('This might take a while to process.')
    ->withClientOptions([
        'timeout' => 60,           // Increase timeout for large files
        'connect_timeout' => 10,   // Connection timeout
    ])
    ->withClientRetry(3, 1000)     // Retry 3 times with 1s delay
    ->asAudio();
```

### Provider Configuration

Override provider configuration for multi-tenant applications:

```php
$customConfig = [
    'api_key' => 'user-specific-api-key',
    'organization' => 'user-org-id',
];

$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->usingProviderConfig($customConfig)
    ->withInput($audioFile)
    ->asText();
```

## Error Handling

Handle potential errors in audio processing:

```php
use Prism\Prism\Exceptions\PrismException;
use Throwable;

try {
    $response = Prism::audio()
        ->using('openai', 'tts-1')
        ->withInput('Text to convert to speech')
        ->withVoice('alloy')
        ->asAudio();
        
    // Process successful response
    file_put_contents('output.mp3', base64_decode($response->audio->base64));
    
} catch (PrismException $e) {
    Log::error('Audio processing failed:', ['error' => $e->getMessage()]);
    // Handle Prism-specific errors
} catch (Throwable $e) {
    Log::error('General error:', ['error' => $e->getMessage()]);
    // Handle any other errors
}
```

## Testing

Prism provides convenient fakes for testing audio functionality:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\PrismFake;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\TextResponse;
use Prism\Prism\ValueObjects\GeneratedAudio;

test('can generate text-to-speech', function () {
    $fakeAudio = new AudioResponse(
        audio: new GeneratedAudio(
            base64: base64_encode('fake-audio-data'),
            type: 'audio/mpeg'
        )
    );
    
    Prism::fake([$fakeAudio]);

    $response = Prism::audio()
        ->using('openai', 'tts-1')
        ->withInput('Test audio generation')
        ->withVoice('alloy')
        ->asAudio();

    expect($response->audio->hasBase64())->toBeTrue();
    expect($response->audio->getMimeType())->toBe('audio/mpeg');
});

test('can transcribe speech-to-text', function () {
    $fakeTranscription = new TextResponse(
        text: 'This is a fake transcription'
    );
    
    Prism::fake([$fakeTranscription]);

    $audioFile = Audio::fromPath('/fake/path/test.mp3');
    
    $response = Prism::audio()
        ->using('openai', 'whisper-1')
        ->withInput($audioFile)
        ->asText();

    expect($response->text)->toBe('This is a fake transcription');
});
```




================================================
FILE: docs/core-concepts/embeddings.md
================================================
# Embeddings

Transform your text into powerful vector representations! Embeddings let you add semantic search, recommendation systems, and other advanced natural language features to your applications.

## Quick Start

Here's how to generate an embedding with just a few lines of code:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::embeddings()
    ->using(Provider::OpenAI, 'text-embedding-3-large')
    ->fromInput('Your text goes here')
    ->asEmbeddings();

// Get your embeddings vector
$embeddings = $response->embeddings[0]->embedding;

// Check token usage
echo $response->usage->tokens;
```

## Generating multiple embeddings

You can generate multiple embeddings at once with all providers that support embeddings, other than Gemini:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::embeddings()
    ->using(Provider::OpenAI, 'text-embedding-3-large')
    // First embedding
    ->fromInput('Your text goes here')
    // Second embedding
    ->fromInput('Your second text goes here')
    // Third and fourth embeddings
    ->fromArray([
        'Third',
        'Fourth'
    ])
    ->asEmbeddings();

/** @var Embedding $embedding */
foreach ($embeddings as $embedding) {
    // Do something with your embeddings
    $embedding->embedding;
}

// Check token usage
echo $response->usage->tokens;
```

## Input Methods

You've got two convenient ways to feed text into the embeddings generator:

### Direct Text Input

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::embeddings()
    ->using(Provider::OpenAI, 'text-embedding-3-large')
    ->fromInput('Analyze this text')
    ->asEmbeddings();
```

### From File

Need to analyze a larger document? No problem:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::embeddings()
    ->using(Provider::OpenAI, 'text-embedding-3-large')
    ->fromFile('/path/to/your/document.txt')
    ->asEmbeddings();
```

> [!NOTE]
> Make sure your file exists and is readable. The generator will throw a helpful `PrismException` if there's any issue accessing the file.

## Common Settings

Just like with text generation, you can fine-tune your embeddings requests:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::embeddings()
    ->using(Provider::OpenAI, 'text-embedding-3-large')
    ->fromInput('Your text here')
    ->withClientOptions(['timeout' => 30]) // Adjust request timeout
    ->withClientRetry(3, 100) // Add automatic retries
    ->asEmbeddings();
```

## Response Handling

The embeddings response gives you everything you need:

```php
namespace Prism\Prism\ValueObjects\Embedding;

// Get an array of Embedding value objects
$embeddings = $response->embeddings;

// Just get first embedding
$firstVectorSet = $embeddings[0]->embedding;

// Loop over all embeddings
/** @var Embedding $embedding */
foreach ($embeddings as $embedding) {
    $vectorSet = $embedding->embedding;
}

// Check token usage
$tokenCount = $response->usage->tokens;
```

## Error Handling

Always handle potential errors gracefully:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;

try {
    $response = Prism::embeddings()
        ->using(Provider::OpenAI, 'text-embedding-3-large')
        ->fromInput('Your text here')
        ->asEmbeddings();
} catch (PrismException $e) {
    Log::error('Embeddings generation failed:', [
        'error' => $e->getMessage()
    ]);
}
```

## Pro Tips 🌟

**Vector Storage**: Consider using a vector database like Milvus, Qdrant, or pgvector to store and query your embeddings efficiently.

**Text Preprocessing**: For best results, clean and normalize your text before generating embeddings. This might include:
   - Removing unnecessary whitespace
   - Converting to lowercase
   - Removing special characters
   - Handling Unicode normalization

> [!IMPORTANT]
> Different providers and models produce vectors of different dimensions. Always check your provider's documentation for specific details about the embedding model you're using.



================================================
FILE: docs/core-concepts/image-generation.md
================================================
# Image Generation

Generate stunning images from text prompts using AI-powered models. Prism provides a clean, consistent API for image generation across different providers, starting with comprehensive OpenAI support.

## Getting Started

Creating images with Prism is as simple as describing what you want:

```php
use Prism\Prism\Facades\Prism;

$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('A cute baby sea otter floating on its back in calm blue water')
    ->generate();

$image = $response->firstImage();
echo $image->url; // https://oaidalleapiprodscus.blob.core.windows.net/...
```

## Provider Support

Currently, Prism supports image generation through:

- **OpenAI**: DALL-E 2, DALL-E 3, and GPT-Image-1 models
- **Gemini**: Gemini 2.0 Flash Preview Image Generation, Imagen 4, Imagen 3

Additional providers will be added in future releases as the ecosystem evolves.

## Basic Usage

### Simple Generation

The most straightforward way to generate an image:

```php
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('A serene mountain landscape at sunset')
    ->generate();

// Access the generated image
$image = $response->firstImage();
if ($image->hasUrl()) {
    echo "Image URL: " . $image->url;
}
if ($image->hasBase64()) {
    echo "Base64 Image Data: " . $image->base64;
}
```

### Working with Responses

The response object provides helpful methods for accessing generated content:

```php
$response = Prism::image()
    ->using('openai', 'dall-e-2')
    ->withPrompt('Abstract geometric patterns in vibrant colors')
    ->generate();

// Check if images were generated
if ($response->hasImages()) {
    echo "Generated {$response->imageCount()} image(s)";

    // Access all images
    foreach ($response->images as $image) {
        if ($image->hasUrl()) {
            echo "Image: {$image->url}\n";
        }

        if ($image->hasBase64()) {
            echo "Base64 Image: " . substr($image->base64, 0, 50) . "...\n";
        }

        if ($image->hasRevisedPrompt()) {
            echo "Revised prompt: {$image->revisedPrompt}\n";
        }
    }

    // Or just get the first one
    $firstImage = $response->firstImage();
}

// Check usage information
echo "Prompt tokens: {$response->usage->promptTokens}";
echo "Model used: {$response->meta->model}";
```

## Provider-Specific Options

While Prism provides a consistent API, you can access provider-specific features using the `withProviderOptions()` method.

### OpenAI Options

OpenAI offers various customization options depending on the model:

#### DALL-E 3 Options

```php
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('A beautiful sunset over mountains')
    ->withProviderOptions([
        'size' => '1792x1024',          // 1024x1024, 1024x1792, 1792x1024
        'quality' => 'hd',              // standard, hd
        'style' => 'vivid',             // vivid, natural
        'response_format' => 'url',     // url, b64_json
    ])
    ->generate();
```

#### GPT-Image-1 (Base64 Only)

The GPT-Image-1 model always returns base64-encoded images, regardless of the `response_format` setting:

```php
$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('A cute baby sea otter floating on its back')
    ->withProviderOptions([
        'size' => '1024x1024',              // 1024x1024, 1536x1024, 1024x1536, auto
        'quality' => 'high',                // auto, high, medium, low
        'background' => 'transparent',      // transparent, opaque, auto
        'output_format' => 'png',           // png, jpeg, webp
        'output_compression' => 90,         // 0-100 (for jpeg/webp)
    ])
    ->generate();

$image = $response->firstImage();
if ($image->hasBase64()) {
    // Save the base64 image to a file
    file_put_contents('generated-image.png', base64_decode($image->base64));
    echo "Base64 image saved to generated-image.png";
}
```

#### Base64 vs URL Responses

Different models return images in different formats:

- **GPT-Image-1**: Always returns base64-encoded images in the `base64` property
- **DALL-E 2 & 3**: Return URLs by default, but can return base64 when `response_format` is set to `'b64_json'`

```php
// Request base64 format from DALL-E 3
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('Abstract art')
    ->withProviderOptions([
        'response_format' => 'b64_json',
    ])
    ->generate();

$image = $response->firstImage();
if ($image->hasBase64()) {
    echo "Received base64 image data";
}
```

### Gemini Options

Gemini offers customizations, depending on what model is selected. All Gemini image generation models return base64-encoded images only. They also return `mimeType`.

### Gemini Flash Preview Image Generation

Gemini conversational image generation provides the option to edit images:

```php
$originalImage = fopen('image/boots.png', 'r');

$response = Prism::image()
    ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
    ->withPrompt('Actually, could we make those boots red?')
    ->withProviderOptions([
        'image' => $originalImage,
        'image_mime_type' => 'image/png',
    ])
    ->generate();
```

### Imagen Options

```php
$response = Prism::image()
    ->using(Provider::Gemini, 'imagen-4.0-generate-001')
    ->withPrompt('Generate an image of a magnificent building falling into the ocean')
    ->withProviderOptions([
        'n' => 3,                               // number of images to generate
        'size' => '2K',                         // 1K (default), 2K
        'aspect_ratio' => '16:9',               // 1:1 (default), 3:4, 4:3, 9:16, 16:9
        'person_generation' => 'dont_allow',    // dont_allow, allow_adult, allow_all
    ])
    ->generate();
```

## Testing

Prism provides convenient fakes for testing image generation:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\PrismFake;

test('can generate images', function () {
    $fake = PrismFake::create()->image();
    Prism::fake($fake);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('Test image')
        ->generate();

    expect($response->hasImages())->toBeTrue();
    expect($response->firstImage()->url)->toContain('fake-image-url');
});
```

Need help with a specific provider or use case? Check the [openai documentation](/providers/openai) or [gemini documentation](/providers/gemini) for detailed configuration options and examples.



================================================
FILE: docs/core-concepts/prism-server.md
================================================
# Prism Server

Prism Server is a powerful feature that allows you to expose your Prism-powered AI models through a standardized API. This makes it easy to integrate your custom AI solutions into various applications, including chat interfaces and other tools that support OpenAI-compatible APIs.

## How It Works

Prism Server acts as a middleware, translating requests from OpenAI-compatible clients into Prism-specific operations. This means you can use tools like ChatGPT web UIs or any OpenAI SDK to interact with your custom Prism models.

## Setting Up Prism Server

### 1. Enable Prism Server

First, make sure Prism Server is enabled in your `config/prism.php` file:

```php
'prism_server' => [
    // The middleware that will be applied to the Prism Server routes.
    'middleware' => [],
    'enabled' => env('PRISM_SERVER_ENABLED', false),
]
```

### 2. Register Your Prisms

To make your Prism models available through the server, you need to register them. This is typically done in a service provider, such as `AppServiceProvider`:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\PrismServer;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        PrismServer::register(
            'my-custom-model',
            fn () => Prism::text()
                ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
                ->withSystemPrompt('You are a helpful assistant.')
        );
    }
}
```

In this example, we're registering a model named `my-custom-model` that uses the Anthropic Claude 3 Sonnet model with a custom system message.

## Using Prism Server

Once set up, Prism Server exposes two main endpoints:

### Chat Completions

To generate text using your registered Prism models:

```bash
curl -X POST "http://your-app.com/prism/openai/v1/chat/completions" \
     -H "Content-Type: application/json" \
     -d '{
  "model": "my-custom-model",
  "messages": [
    {"role": "user", "content": "Hello, who are you?"}
  ]
}'
```

### List Available Models

To get a list of all registered Prism models:

```bash
curl "http://your-app.com/prism/openai/v1/models"
```

## Integration with Open WebUI

Prism Server works seamlessly with OpenAI-compatible chat interfaces like [Open WebUI](https://openwebui.com). Here's an example Docker Compose configuration:

```yaml
services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    ports:
      - "3000:8080"
    environment:
      OPENAI_API_BASE_URLS: "http://laravel:8080/prism/openai/v1"
      WEBUI_SECRET_KEY: "your-secret-key"

  laravel:
    image: serversideup/php:8.3-fpm-nginx
    volumes:
      - ".:/var/www/html"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    depends_on:
      - open-webui
```

With this setup, you can access your Prism models through a user-friendly chat interface at `http://localhost:3000`.

By leveraging Prism Server, you can create powerful, custom AI experiences while maintaining compatibility with a wide ecosystem of tools and libraries. Whether you're building a chatbot, a content generation tool, or something entirely new, Prism Server provides the flexibility and standardization you need to succeed.

## Adding Middleware

You can add middleware to the Prism Server routes by setting the `middleware` option in your `config/prism.php` file:

```php
'prism_server' => [
    'middleware' => ['api'],
],
```



================================================
FILE: docs/core-concepts/schemas.md
================================================
# Schemas

Schemas are the blueprints that help you define the shape of your data in Prism. Whether you're building tool parameters or crafting structured outputs, schemas help you clearly communicate what your data should look like.

## Quick Start

Let's dive right in with a practical example:

> [!IMPORTANT]
> **Structured Output Requirement**: When using schemas for structured output with providers like OpenAI (especially in strict mode), the root schema should be an `ObjectSchema`. Other schema types can only be used as properties within an ObjectSchema, not as the top-level schema. Different providers may have varying requirements.

```php
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

$userSchema = new ObjectSchema(
    name: 'user',
    description: 'A user profile with their hobbies',
    properties: [
        new StringSchema('name', 'The user\'s full name'),
        new ArraySchema(
            name: 'hobbies',
            description: 'The user\'s list of hobbies',
            items: new ObjectSchema(
                name: 'hobby',
                description: 'A detailed hobby entry',
                properties: [
                    new StringSchema('name', 'The name of the hobby'),
                    new StringSchema('description', 'A brief description of the hobby'),
                ],
                requiredFields: ['name', 'description']
            )
        ),
    ],
    requiredFields: ['name', 'hobbies']
);
```

## Available Schema Types

### StringSchema

For text values of any length. Perfect for names, descriptions, or any textual data.

```php
use Prism\Prism\Schema\StringSchema;

$nameSchema = new StringSchema(
    name: 'full_name',
    description: 'The user\'s full name including first and last name'
);
```

### NumberSchema

Handles both integers and floating-point numbers. Great for ages, quantities, or measurements.

```php
use Prism\Prism\Schema\NumberSchema;

$ageSchema = new NumberSchema(
    name: 'age',
    description: 'The user\'s age in years'
);
```

### BooleanSchema

For simple true/false values. Perfect for flags and toggles.

```php
use Prism\Prism\Schema\BooleanSchema;

$activeSchema = new BooleanSchema(
    name: 'is_active',
    description: 'Whether the user account is active'
);
```

### ArraySchema

For lists of items, where each item follows a specific schema.

```php
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\StringSchema;

$tagsSchema = new ArraySchema(
    name: 'tags',
    description: 'List of tags associated with the post',
    items: new StringSchema('tag', 'A single tag')
);
```

### EnumSchema

When you need to restrict values to a specific set of options.

```php
use Prism\Prism\Schema\EnumSchema;

$statusSchema = new EnumSchema(
    name: 'status',
    description: 'The current status of the post',
    options: ['draft', 'published', 'archived']
);
```

### ObjectSchema

For complex, nested data structures. The Swiss Army knife of schemas!

> [!NOTE]
> ObjectSchema is typically required as the root schema for structured output operations with providers like OpenAI. It's the recommended schema type to use directly with `withSchema()` in structured output requests, though different providers may have varying requirements.

```php
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Schema\NumberSchema;

$profileSchema = new ObjectSchema(
    name: 'profile',
    description: 'A user\'s public profile information',
    properties: [
        new StringSchema('username', 'The unique username'),
        new StringSchema('bio', 'A short biography'),
        new NumberSchema('joined_year', 'Year the user joined'),
    ],
    requiredFields: ['username']
);
```

### AnyOfSchema

For flexible data that can match one of several schemas. This is particularly useful when you need to handle different data types or structures in the same field.

> [!IMPORTANT]
> **OpenAI Compatibility**: The AnyOfSchema is designed to work with OpenAI's structured outputs `anyOf` specification. Each nested schema must be a valid JSON schema according to OpenAI's subset requirements. For best results, ensure each nested schema has a proper `type` field.

```php
use Prism\Prism\Schema\AnyOfSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;

// Simple example: A value that can be either a string or number
$flexibleValueSchema = new AnyOfSchema(
    schemas: [
        new StringSchema('text', 'A text value'),
        new NumberSchema('number', 'A numeric value'),
    ],
    name: 'flexible_value',
    description: 'A value that can be either text or numeric'
);

// Complex example: Different content types
$contentSchema = new AnyOfSchema(
    schemas: [
        new ObjectSchema(
            name: 'article',
            description: 'A blog article',
            properties: [
                new StringSchema('title', 'Article title'),
                new StringSchema('content', 'Article content'),
                new StringSchema('author', 'Article author'),
            ],
            requiredFields: ['title', 'content']
        ),
        new ObjectSchema(
            name: 'image',
            description: 'An image post',
            properties: [
                new StringSchema('url', 'Image URL'),
                new StringSchema('caption', 'Image caption'),
                new NumberSchema('width', 'Image width in pixels'),
                new NumberSchema('height', 'Image height in pixels'),
            ],
            requiredFields: ['url']
        ),
    ],
    name: 'content',
    description: 'Content that can be either an article or an image'
);
```

**Key Features:**
- Accepts an array of schema objects that define the possible types
- Automatically validates nested schemas for OpenAI compatibility
- Supports nullable values through the `nullable` parameter
- Optional name and description parameters
- Removes unsupported JSON schema properties automatically

## Nullable Fields

Sometimes, not every field is required. You can make any schema nullable by setting the `nullable` parameter to `true`:

```php
use Prism\Prism\Schema\StringSchema;

$bioSchema = new StringSchema(
    name: 'bio',
    description: 'Optional user biography',
    nullable: true
);
```

> [!NOTE]
> When using OpenAI in strict mode, all fields must be marked as required, so optional fields must be marked as nullable.

## Required vs Nullable Fields

Understanding the difference between required fields and nullable fields is crucial when working with schemas in Prism:

### Required Fields

Required fields are specified at the object level using the `requiredFields` parameter. They indicate which properties must be present in the data structure:

```php
$userSchema = new ObjectSchema(
    name: 'user',
    description: 'User profile',
    properties: [
        new StringSchema('email', 'Primary email address'),
        new StringSchema('name', 'User\'s full name'),
        new StringSchema('bio', 'User biography', nullable: true), // bio can be null
    ],
    requiredFields: ['email', 'name', 'bio'] // all fields must be present
);
```

### Nullable Fields

Nullable fields, on the other hand, are specified at the individual field level using the `nullable` parameter. They indicate that a field can contain a `null` value:

```php
$userSchema = new ObjectSchema(
    name: 'user',
    description: 'User profile',
    properties: [
        new StringSchema('email', 'Primary email address'),
        new StringSchema('name', 'User\'s full name'),
        new StringSchema('bio', 'User biography', nullable: true), // bio can be null
    ],
    requiredFields: ['email', 'name', 'bio'] // bio must be present, but can be null
);
```

### Key Differences

1. **Required vs Present**: 
   - A required field must be present in the data structure
   - A non-nullable field must contain a non-null value when present
   - A field can be required but nullable (must be present, can be null)
   - A field can be non-required and non-nullable (when present, cannot be null)

2. **Common Patterns**:
```php
// Required and Non-nullable (most strict)
new StringSchema('email', 'Primary email', nullable: false);
// requireFields: ['email']

// Required but Nullable (must be present, can be null)
new StringSchema('bio', 'User bio', nullable: true);
// requireFields: ['bio']

// Optional and Non-nullable (can be omitted, but if present cannot be null)
new StringSchema('phone', 'Phone number', nullable: false);
// requireFields: []

// Optional and Nullable (most permissive)
new StringSchema('website', 'Personal website', nullable: true);
// requireFields: []
```

### Provider Considerations

When working with providers that support strict mode (like OpenAI), you'll want to be especially careful with these settings:

```php
// For OpenAI strict mode: 
// - All fields should be required
// - Use nullable: true for optional fields
$userSchema = new ObjectSchema(
    name: 'user',
    description: 'User profile',
    properties: [
        new StringSchema('email', 'Required email address'),
        new StringSchema('bio', 'Optional biography', nullable: true),
    ],
    requiredFields: ['email', 'bio'] // Note: bio is required but nullable
);
```

> [!TIP]
> When in doubt, be explicit about both requirements. Specify both the `nullable` status of each field AND which fields are required in your object schemas. This makes your intentions clear to both other developers and AI providers.

## Best Practices

1. **Clear Descriptions**: Write clear, concise descriptions for each field. Future you (and other developers) will thank you!
   ```php
   // ❌ Not helpful
   new StringSchema('name', 'the name');

   // ✅ Much better
   new StringSchema('name', 'The user\'s display name (2-50 characters)');
   ```

2. **Thoughtful Required Fields**: Only mark fields as required if they're truly necessary:
   ```php
   new ObjectSchema(
       name: 'user',
       description: 'User profile',
       properties: [
           new StringSchema('email', 'Primary email address'),
           new StringSchema('phone', 'Optional phone number', nullable: true),
       ],
       requiredFields: ['email']
   );
   ```

3. **Nested Organization**: Keep your schemas organized when dealing with complex structures:
   ```php
   // Define child schemas first
   $addressSchema = new ObjectSchema(/*...*/);
   $contactSchema = new ObjectSchema(/*...*/);

   // Then use them in your parent schema
   $userSchema = new ObjectSchema(
       name: 'user',
       description: 'Complete user profile',
       properties: [$addressSchema, $contactSchema]
   );
   ```

> [!NOTE]
> Remember that while schemas help define the structure of your data, Prism doesn't currently validate the data against these schemas. Schema validation is planned for a future release!



================================================
FILE: docs/core-concepts/streaming-output.md
================================================
# Streaming Output

Want to show AI responses to your users in real-time? Prism provides multiple ways to handle streaming AI responses, from simple Server-Sent Events to WebSocket broadcasting for real-time applications.

> [!WARNING]
> When using Laravel Telescope or other packages that intercept Laravel's HTTP client events, they may consume the stream before Prism can emit the stream events. This can cause streaming to appear broken or incomplete. Consider disabling such interceptors when using streaming functionality, or configure them to ignore Prism's HTTP requests.

## Quick Start

### Server-Sent Events (SSE)

The simplest way to stream AI responses to a web interface:

```php
Route::get('/chat', function () {
    return Prism::text()
        ->using('anthropic', 'claude-3-7-sonnet')
        ->withPrompt(request('message'))
        ->asEventStreamResponse();
});
```

```javascript
const eventSource = new EventSource('/chat');

eventSource.addEventListener('text_delta', (event) => {
    const data = JSON.parse(event.data);
    document.getElementById('output').textContent += data.delta;
});

eventSource.addEventListener('stream_end', (event) => {
    const data = JSON.parse(event.data);
    console.log('Stream ended:', data.finish_reason);
    eventSource.close();
});
```

### Vercel AI SDK Integration

For apps using Vercel's AI SDK, use the Data Protocol adapter which provides compatibility with the [Vercel AI SDK UI](https://ai-sdk.dev/docs/reference/ai-sdk-ui):

```php
Route::post('/api/chat', function () {
    return Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt(request('message'))
        ->asDataStreamResponse();
});
```

Client-side with the `useChat` hook:

```javascript
import { useChat } from '@ai-sdk/react';
import { useState } from 'react';

export default function Chat() {
    // AI SDK 5.0 no longer manages input state, so we handle it ourselves
    const [input, setInput] = useState('');

    const { messages, sendMessage, status } = useChat({
        transport: {
            api: '/api/chat',
        },
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        if (input.trim() && status === 'ready') {
            sendMessage(input);
            setInput('');
        }
    };

    return (
        <div>
            <div>
                {messages.map(m => (
                    <div key={m.id}>
                        <strong>{m.role}:</strong>{' '}
                        {m.parts
                            .filter(part => part.type === 'text')
                            .map(part => part.text)
                            .join('')}
                    </div>
                ))}
            </div>

            <form onSubmit={handleSubmit}>
                <input
                    value={input}
                    placeholder="Say something..."
                    onChange={(e) => setInput(e.target.value)}
                    disabled={status !== 'ready'}
                />
                <button type="submit" disabled={status !== 'ready'}>
                    {status === 'streaming' ? 'Sending...' : 'Send'}
                </button>
            </form>
        </div>
    );
}
```

> [!NOTE]
> This example uses AI SDK 5.0, which introduced significant changes to the `useChat` hook. The hook no longer manages input state internally, and you'll need to use the `sendMessage` function directly instead of `handleSubmit`.

For more advanced usage, including tool support and custom options, see the [Vercel AI SDK UI documentation](https://ai-sdk.dev/docs/reference/ai-sdk-ui).

### WebSocket Broadcasting with Background Jobs

For real-time multi-user applications that need to process AI requests in the background:

```php
// Job Class
<?php

namespace App\Jobs;

use Illuminate\Broadcasting\Channel;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Prism\Prism\Facades\Prism;

class ProcessAiStreamJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public function __construct(
        public string $message,
        public string $channel,
        public string $model = 'claude-3-7-sonnet'
    ) {}

    public function handle(): void
    {
        Prism::text()
            ->using('anthropic', $this->model)
            ->withPrompt($this->message)
            ->asBroadcast(new Channel($this->channel));
    }
}

// Controller
Route::post('/chat-broadcast', function () {
    $sessionId = request('session_id') ?? 'session_' . uniqid();
    
    ProcessAiStreamJob::dispatch(
        request('message'),
        "chat.{$sessionId}",
        request('model', 'claude-3-7-sonnet')
    );
    
    return response()->json(['status' => 'processing', 'session_id' => $sessionId]);
});
```

Client-side with React and useEcho:

```javascript
import { useEcho } from '@/hooks/useEcho';
import { useState } from 'react';

function ChatComponent() {
    const [currentMessage, setCurrentMessage] = useState('');
    const [currentMessageId, setCurrentMessageId] = useState('');
    const [isComplete, setIsComplete] = useState(false);

    const sessionId = 'session_' + Date.now();

    // Listen for streaming events
    useEcho(`chat.${sessionId}`, {
        '.stream_start': (data) => {
            console.log('Stream started:', data);
            setCurrentMessage('');
            setIsComplete(false);
        },
        
        '.text_start': (data) => {
            console.log('Text start event received:', data);
            setCurrentMessage('');
            setCurrentMessageId(data.message_id || Date.now().toString());
        },
        
        '.text_delta': (data) => {
            console.log('Text delta received:', data);
            setCurrentMessage(prev => prev + data.delta);
        },
        
        '.text_complete': (data) => {
            console.log('Text complete:', data);
        },
        
        '.tool_call': (data) => {
            console.log('Tool called:', data.tool_name, data.arguments);
        },
        
        '.tool_result': (data) => {
            console.log('Tool result:', data.result);
        },
        
        '.stream_end': (data) => {
            console.log('Stream ended:', data.finish_reason);
            setIsComplete(true);
        },
        
        '.error': (data) => {
            console.error('Stream error:', data.message);
        }
    });

    const sendMessage = async (message) => {
        await fetch('/chat-broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message, 
                session_id: sessionId,
                model: 'claude-3-7-sonnet' 
            })
        });
    };

    return (
        <div>
            <div className="message-display">
                {currentMessage}
                {!isComplete && <span className="cursor">|</span>}
            </div>
            
            <button onClick={() => sendMessage("What's the weather in Detroit?")}>
                Send Message
            </button>
        </div>
    );
}
```

## Event Types

All streaming approaches emit the same core events with consistent data structures:

### Available Events

- **`stream_start`** - Stream initialization with model and provider info
- **`text_start`** - Beginning of a text message  
- **`text_delta`** - Incremental text chunks as they're generated
- **`text_complete`** - End of a complete text message
- **`thinking_start`** - Beginning of AI reasoning/thinking session
- **`thinking_delta`** - Reasoning content as it's generated  
- **`thinking_complete`** - End of reasoning session
- **`tool_call`** - Tool invocation with arguments
- **`tool_result`** - Tool execution results
- **`error`** - Error handling with recovery information
- **`stream_end`** - Stream completion with usage statistics

### Event Data Examples

Based on actual streaming output:

```javascript
// stream_start event
{
    "id": "anthropic_evt_SSrB7trNIXsLkbUB",
    "timestamp": 1756412888,
    "model": "claude-3-7-sonnet-20250219",
    "provider": "anthropic",
    "metadata": {
        "request_id": "msg_01BS7MKgXvUESY8yAEugphV2",
        "rate_limits": []
    }
}

// text_start event
{
    "id": "anthropic_evt_8YI9ULcftpFtHzh3",
    "timestamp": 1756412888,
    "message_id": "msg_01BS7MKgXvUESY8yAEugphV2"
}

// text_delta event
{
    "id": "anthropic_evt_NbS3LIP0QDl5whYu",
    "timestamp": 1756412888,
    "delta": "💠🌐 Well hello there! You want to know",
    "message_id": "msg_01BS7MKgXvUESY8yAEugphV2"
}

// tool_call event
{
    "id": "anthropic_evt_qXvozT6OqtmFPgkG",
    "timestamp": 1756412889,
    "tool_id": "toolu_01NAbzpjGxv2mJ8gJRX5Bb8m",
    "tool_name": "search",
    "arguments": {"query": "current date and time in Detroit Michigan"},
    "message_id": "msg_01BS7MKgXvUESY8yAEugphV2",
    "reasoning_id": null
}

// stream_end event
{
    "id": "anthropic_evt_BZ3rqDYyprnywNyL",
    "timestamp": 1756412898,
    "finish_reason": "Stop",
    "usage": {
        "prompt_tokens": 3448,
        "completion_tokens": 192,
        "cache_write_input_tokens": 0,
        "cache_read_input_tokens": 0,
        "thought_tokens": 0
    }
}
```

## Advanced Usage

### Handling Stream Completion with Callbacks

Need to save a conversation to your database after the AI finishes responding? The `onComplete` callback lets you handle completed messages without interrupting the stream. This is perfect for persisting conversations, tracking analytics, or logging AI interactions.


```php
use Illuminate\Support\Collection;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;

return Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet')
    ->withTools([$weatherTool])
    ->withPrompt(request('message'))
    ->onComplete(function (PendingRequest $request, Collection $messages) use ($conversationId) {
        foreach ($messages as $message) {
            if ($message instanceof AssistantMessage) {
                // Save the assistant's text response
                ConversationMessage::create([
                    'conversation_id' => $conversationId,
                    'role' => 'assistant',
                    'content' => $message->content,
                    'tool_calls' => $message->toolCalls,
                ]);
            }

            if ($message instanceof ToolResultMessage) {
                // Save tool execution results
                foreach ($message->toolResults as $toolResult) {
                    ConversationMessage::create([
                        'conversation_id' => $conversationId,
                        'role' => 'tool',
                        'content' => json_encode($toolResult->result),
                        'tool_name' => $toolResult->toolName,
                        'tool_call_id' => $toolResult->toolCallId,
                    ]);
                }
            }
        }
    })
    ->asEventStreamResponse();
```

#### Using Invokable Classes

For better organization, you can use invokable classes as callbacks:

```php
use Illuminate\Support\Collection;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;

class SaveConversation
{
    public function __construct(
        protected string $conversationId
    ) {}

    public function __invoke(PendingRequest $request, Collection $messages): void
    {
        foreach ($messages as $message) {
            if ($message instanceof AssistantMessage) {
                ConversationMessage::create([
                    'conversation_id' => $this->conversationId,
                    'role' => 'assistant',
                    'content' => $message->content,
                    'tool_calls' => $message->toolCalls,
                ]);
            }
        }
    }
}
```

### Custom Event Processing

Access raw events for complete control over handling:

```php
$events = Prism::text()
    ->using('openai', 'gpt-4')
    ->withPrompt('Explain quantum physics')
    ->asStream();

foreach ($events as $event) {
    match ($event->type()) {
        StreamEventType::TextDelta => handleTextChunk($event),
        StreamEventType::ToolCall => handleToolCall($event),
        StreamEventType::StreamEnd => handleCompletion($event),
        default => null,
    };
}
```

### Streaming with Tools

Stream responses that include tool interactions:

```php
use Prism\Prism\Facades\Tool;

$searchTool = Tool::as('search')
    ->for('Search for information')
    ->withStringParameter('query', 'Search query')
    ->using(function (string $query) {
        return "Search results for: {$query}";
    });

return Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet')
    ->withTools([$searchTool])
    ->withPrompt("What's the weather in Detroit?")
    ->asEventStreamResponse();
```

### Data Protocol Output

The Vercel AI SDK format provides structured streaming data:

```
data: {"type":"start","messageId":"anthropic_evt_NPbGJs7D0oQhvz2K"}

data: {"type":"text-start","id":"msg_013P3F8KkVG3Qasjeay3NUmY"}

data: {"type":"text-delta","id":"msg_013P3F8KkVG3Qasjeay3NUmY","delta":"Hello"}

data: {"type":"text-end","id":"msg_013P3F8KkVG3Qasjeay3NUmY"}

data: {"type":"finish","messageMetadata":{"finishReason":"stop","usage":{"promptTokens":1998,"completionTokens":288}}}

data: [DONE]
```

## Configuration Options

Streaming supports all the same configuration options as regular [text generation](/core-concepts/text-generation#generation-parameters), including temperature, max tokens, and provider-specific settings.



================================================
FILE: docs/core-concepts/structured-output.md
================================================
# Structured Output

Want your AI responses as neat and tidy as a Marie Kondo-approved closet? Structured output lets you define exactly how you want your data formatted, making it perfect for building APIs, processing forms, or any time you need data in a specific shape.

## Quick Start

Here's how to get structured data from your AI:

> [!IMPORTANT]
> **Schema Requirement for OpenAI**: When using OpenAI's structured output (especially strict mode), the root schema must be an `ObjectSchema`. Other schema types (StringSchema, NumberSchema, etc.) can only be used as properties within an ObjectSchema, not as the top-level schema. Other providers may have different requirements.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

$schema = new ObjectSchema(
    name: 'movie_review',
    description: 'A structured movie review',
    properties: [
        new StringSchema('title', 'The movie title'),
        new StringSchema('rating', 'Rating out of 5 stars'),
        new StringSchema('summary', 'Brief review summary')
    ],
    requiredFields: ['title', 'rating', 'summary']
);

$response = Prism::structured()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->withSchema($schema)
    ->withPrompt('Review the movie Inception')
    ->asStructured();

// Access your structured data
$review = $response->structured;
echo $review['title'];    // "Inception"
echo $review['rating'];   // "5 stars"
echo $review['summary'];  // "A mind-bending..."
```

> [!TIP]
> This is just a basic example of schema usage. Check out our [dedicated schemas guide](/core-concepts/schemas) to learn about all available schema types, nullable fields, and best practices for structuring your data.

## Understanding Output Modes

Different AI providers handle structured output in two main ways:

1. **Structured Mode**: Some providers support strict schema validation, ensuring responses perfectly match your defined structure.
2. **JSON Mode**: Other providers simply guarantee valid JSON output that approximately matches your schema.

> [!NOTE]
> Check your provider's documentation to understand which mode they support. Provider support can vary by model, so always verify capabilities for your specific use case.

## Provider-Specific Options

Providers may offer additional options for structured output:

### OpenAI: Strict Mode
OpenAI supports a "strict mode" for even tighter schema validation:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::structured()
    ->withProviderOptions([
        'schema' => [
            'strict' => true
        ]
    ])
    // ... rest of your configuration
```

### Anthropic: Tool Calling Mode
Anthropic doesn't have native structured output, but Prism provides two approaches. For more reliable JSON parsing, especially with complex content or non-English text, use tool calling mode:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::structured()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    ->withSchema($schema)
    ->withPrompt('天氣怎麼樣？應該穿什麼？') // Chinese text with potential quotes
    ->withProviderOptions(['use_tool_calling' => true])
    ->asStructured();
```

**When to use tool calling mode with Anthropic:**
- Working with non-English content that may contain quotes
- Complex JSON structures that might confuse prompt-based parsing
- When you need the most reliable structured output possible

> [!NOTE]
> Tool calling mode cannot be used with Anthropic's citations feature.

> [!TIP]
> Check the provider-specific documentation pages for additional options and features that might be available for structured output.

## Response Handling

When working with structured responses, you have access to both the structured data and metadata about the generation:

```php
use Prism\Prism\Facades\Prism;

$response = Prism::structured()
    ->withSchema($schema)
    ->asStructured();

// Access the structured data as a PHP array
$data = $response->structured;

// Get the raw response text if needed
echo $response->text;

// Check why the generation stopped
echo $response->finishReason->name;

// Get token usage statistics
echo "Prompt tokens: {$response->usage->promptTokens}";
echo "Completion tokens: {$response->usage->completionTokens}";

// Access provider-specific response data
$rawResponse = $response->response;
```

> [!TIP]
> Always validate the structured data before using it in your application:
```php
if ($response->structured === null) {
    // Handle parsing failure
}

if (!isset($response->structured['required_field'])) {
    // Handle missing required data
}
```

## Common Settings

Structured output supports several configuration options to fine-tune your generations:

### Model Configuration
- `maxTokens` - Set the maximum number of tokens to generate
- `temperature` - Control output randomness (provider-dependent)
- `topP` - Alternative to temperature for controlling randomness (provider-dependent)

### Input Methods
- `withPrompt` - Single prompt for generation
- `withMessages` - Message history for more context
- `withSystemPrompt` - System-level instructions

### Request Configuration 
- `withClientOptions` - Set HTTP client options (e.g., timeouts)
- `withClientRetry` - Configure automatic retries on failures
- `usingProviderConfig` - Override provider configuration
- `withProviderOptions` - Set provider-specific options

> [!NOTE]
> Unlike text generation, structured output does not support tools/function calling. For those features, use the text generation API instead.

See the [Text Generation](./text-generation.md) documentation for comparison with standard text generation capabilities.

## Error Handling

When working with structured output, it's especially important to handle potential errors:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;

try {
    $response = Prism::structured()
        ->using('anthropic', 'claude-3-sonnet')
        ->withSchema($schema)
        ->withPrompt('Generate product data')
        ->asStructured();
} catch (PrismException $e) {
    // Handle validation or generation errors
    Log::error('Structured generation failed:', [
        'error' => $e->getMessage()
    ]);
}
```

> [!IMPORTANT]
> Always validate the structured response before using it in your application, as different providers may have varying levels of schema adherence.



================================================
FILE: docs/core-concepts/testing.md
================================================
# Testing

Want to make sure your Prism integrations work flawlessly? Let's dive into testing! Prism provides a powerful fake implementation that makes it a breeze to test your AI‑powered features.

## Basic Test Setup

First, let's look at how to set up basic response faking:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Usage;
use Prism\Prism\Testing\TextResponseFake;

it('can generate text', function () {
    $fakeResponse = TextResponseFake::make()
        ->withText('Hello, I am Claude!')
        ->withUsage(new Usage(10, 20));

    // Set up the fake
    $fake = Prism::fake([$fakeResponse]);

    // Run your code
    $response = Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withPrompt('Who are you?')
        ->asText();

    // Make assertions
    expect($response->text)->toBe('Hello, I am Claude!');
});
```

The response fakes create a new response with default values and let you fluently set the values you need for your test.

## Testing Multiple Responses

When testing conversations or tool usage, you might need to simulate multiple responses:

```php
use Prism\Prism\ValueObjects\Usage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\ValueObjects\Meta;

it('can handle tool calls', function () {
    $responses = [
        TextResponseFake::make()
            ->withToolCalls([
                new ToolCall(
                    id: 'call_1',
                    name: 'search',
                    arguments: ['query' => 'Latest news']
                )
            ])
            ->withUsage(new Usage(15, 25))
            ->withMeta(new Meta('fake-1', 'fake-model')),

        TextResponseFake::make()
            ->withText('Here are the latest news...')
            ->withUsage(new Usage(20, 30))
            ->withMeta(new Meta('fake-2', 'fake-model')),
    ];

    $fake = Prism::fake($responses);
});
```

## Using the ResponseBuilder

If you need to test a richer response object, e.g. with Steps, you may find it easier to use the `ResponseBuilder` together with the fake Step helpers.
This is especially useful when you want to test complex streamed responses.

```php
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\ValueObjects\Usage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Messages\{UserMessage,AssistantMessage,SystemMessage};
use Prism\Prism\ValueObjects\Media\Document;

Prism::fake([
    (new ResponseBuilder)
        ->addStep(
            TextStepFake::make()
                ->withText('Step 1 response text')
                ->withFinishReason(FinishReason::Stop)
                ->withToolCalls([/* tool calls */])
                ->withToolResults([/* tool results */])
                ->withUsage(new Usage(1000, 750))
                ->withMeta(new Meta('step1', 'test-model'))
                ->withMessages([
                    new UserMessage('Test message 1', [
                        new Document(
                            document: '',
                            mimeType: 'text/plain',
                            dataFormat: 'text',
                            documentTitle: 'Test document',
                            documentContext: 'Test context'
                        ),
                    ]),
                    new AssistantMessage('Test message 2')
                ])
                ->withSystemPrompts([
                    new SystemMessage('Test system')
                ])
                ->withAdditionalContent(['test' => 'additional'])
        )
       ->addStep(
           TextStepFake::make()
                ->withText('Step 2 response text')
                ->withFinishReason(FinishReason::Stop)
                ->withToolCalls([/* tool calls */])
                ->withToolResults([/* tool results */])
                ->withUsage(new Usage(1000, 750))
                ->withMeta(new Meta(id: 123, model: 'test-model'))
                ->withMessages([/* Second step messages */])
                ->withSystemPrompts([/* Second step system prompts */])
                ->withAdditionalContent([/* Second step additional data */])
       )
        ->toResponse()
]);
```

## Testing Tools

```php
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

it('can use weather tool', function () {
    // Define the expected tool call and response sequence
    $responses = [
        (new ResponseBuilder)
            ->addStep(
                // First response: AI decides to use the weather tool
                TextStepFake::make()
                    ->withToolCalls([
                        new ToolCall(
                            id: 'call_123',
                            name: 'weather',
                            arguments: ['city' => 'Paris']
                        ),
                    ])
                    ->withFinishReason(FinishReason::ToolCalls)
                    ->withUsage(new Usage(15, 25))
                    ->withMeta(new Meta('fake-1', 'fake-model'))
            )
            ->addStep(
                // Second response: AI uses the tool result to form a response
                TextStepFake::make()
                    ->withText('Based on current conditions, the weather in Paris is sunny with a temperature of 72°F.')
                    ->withToolResults([
                        new ToolResult(
                            toolCallId: 'call_123',
                            toolName: 'weather',
                            args: ['city' => 'Paris'],
                            result: 'Sunny, 72°F'
                        ),
                    ])
                    ->withFinishReason(FinishReason::Stop)
                    ->withUsage(new Usage(20, 30))
                    ->withMeta(new Meta('fake-2', 'fake-model')),
            )
            ->toResponse(),
    ];

    // Set up the fake
    Prism::fake($responses);

    // Create the weather tool
    $weatherTool = Tool::as('weather')
        ->for('Get weather information')
        ->withStringParameter('city', 'City name')
        ->using(fn (string $city) => "The weather in {$city} is sunny with a temperature of 72°F");

    // Run the actual test
    $response = Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withPrompt('What\'s the weather in Paris?')
        ->withTools([$weatherTool])
        ->withMaxSteps(2)
        ->asText();

    // Assert the response has the correct number of steps
    expect($response->steps)->toHaveCount(2);

    // Assert tool calls were made correctly
    expect($response->steps[0]->toolCalls)->toHaveCount(1);
    expect($response->steps[0]->toolCalls[0]->name)->toBe('weather');
    expect($response->steps[0]->toolCalls[0]->arguments())->toBe(['city' => 'Paris']);

    // Assert tool results were processed
    expect($response->toolResults)->toHaveCount(1);
    expect($response->toolResults[0]->result)
        ->toBe('Sunny, 72°F');

    // Assert final response
    expect($response->text)
        ->toBe('Based on current conditions, the weather in Paris is sunny with a temperature of 72°F.');
});
```

## Testing Streamed Responses

To test streamed responses, you can use any text response for a fake. The fake Provider will turn the text response into a fake stream of text chunks.
It will always finish with an empty chunk including your given finish reason.

```php
Prism::fake([
    TextResponseFake::make()
        ->withText('fake response text') // text to be streamed
        ->withFinishReason(FinishReason::Stop), // finish reason for final chunk
]);

$text = Prism::text()
    ->using('anthropic', 'claude-3-sonnet')
    ->withPrompt('What is the meaning of life?')
    ->asStream();

$outputText = '';
foreach ($text as $chunk) {
    $outputText .= $chunk->text; // will be ['fake ', 'respo', 'nse t', 'ext', '']; 
}

expect($outputText)->toBe('fake response text');
```

You can adjust the chunk size by using `withFakeChunkSize` on the fake.

```php
Prism::fake([
    TextResponseFake::make()->withText('fake response text'),
])->withFakeChunkSize(1);
```

Now, the text will be streamed in chunks of one character (`['f', 'a', 'k', ...]`).

### Testing Tool Calling while Streaming

When testing streamed responses with tool calls, you can use the `ResponseBuilder` to create a more complex response.
Given a text response with steps, the fake provider will not only generate text chunks, but also include chunks for tool calls and results.

```php
Prism::fake([
    (new ResponseBuilder)
        ->addStep(
            TextStepFake::make()
                ->withToolCalls(
                    [
                        new ToolCall('id-123', 'tool', ['input' => 'value']),
                    ]
                )
        )
        ->addStep(
            TextStepFake::make()
                ->withToolResults(
                    [
                        new ToolResult('id-123', 'tool', ['input' => 'value'], 'result'),
                    ]
                )
        )
        ->addStep(
            TextStepFake::make()
                ->withText('fake response text')
        )
        ->toResponse(),
]);

$text = Prism::text()
    ->using('anthropic', 'claude-3-sonnet')
    ->withPrompt('What is the meaning of life?')
    ->asStream();

$outputText = '';
$toolCalls = [];
$toolResults = [];

foreach ($text as $chunk) {
    $outputText .= $chunk->text;

    // Accumulate tool calls
    if ($chunk->toolCalls) {
        foreach ($chunk->toolCalls as $call) {
            $toolCalls[] = $call;
        }
    }

    // Accumulate tool results
    if ($chunk->toolResults) {
        foreach ($chunk->toolResults as $result) {
            $toolResults[] = $result;
        }
    }
}

expect($outputText)->toBe('fake response text')
    ->and($toolCalls)->toHaveCount(1)
    ->and($toolCalls[0])->toBeInstanceOf(ToolCall::class)
    ->and($toolCalls[0]->id)->toBe('id-123')
    ->and($toolCalls[0]->name)->toBe('tool')
    ->and($toolCalls[0]->arguments())->toBe(['input' => 'value'])
    ->and($toolResults)->toHaveCount(1)
    ->and($toolResults[0])->toBeInstanceOf(ToolResult::class)
    ->and($toolResults[0]->toolCallId)->toBe('id-123')
    ->and($toolResults[0]->toolName)->toBe('tool')
    ->and($toolResults[0]->args)->toBe(['input' => 'value'])
    ->and($toolResults[0]->result)->toBe('result');
```

## Testing Structured Output

> [!NOTE]
> When testing OpenAI-style structured output (strict mode), the root schema should be an `ObjectSchema`.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\StructuredResponseFake;
use Prism\Prism\ValueObjects\Usage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

it('can generate structured response', function () {
    $schema = new ObjectSchema(
        name: 'user',
        description: 'A user object, because we love organizing things!',
        properties: [
            new StringSchema('name', 'The user\'s name (hopefully not "test test")'),
            new StringSchema('bio', 'A brief bio (no novels, please)'),
        ],
        requiredFields: ['name', 'bio']
    );

    $fakeResponse = StructuredResponseFake::make()
        ->withText(json_encode([
            'name' => 'Alice Tester',
            'bio' => 'Professional bug hunter and code wrangler'
        ], JSON_THROW_ON_ERROR))
        ->withStructured([
            'name' => 'Alice Tester',
            'bio' => 'Professional bug hunter and code wrangler'
        ])
        ->withFinishReason(FinishReason::Stop)
        ->withUsage(new Usage(10, 20))
        ->withMeta(new Meta('fake-1', 'fake-model'));

    $fake = Prism::fake([$fakeResponse]);

    $response = Prism::structured()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Generate a user profile')
        ->withSchema($schema)
        ->asStructured();

    // Assertions
    expect($response->structured)->toBeArray();
    expect($response->structured['name'])->toBe('Alice Tester');
    expect($response->structured['bio'])->toBe('Professional bug hunter and code wrangler');
});
```

## Testing Embeddings

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\Testing\EmbeddingsResponseFake;
use Prism\Prism\ValueObjects\Meta;

it('can generate embeddings', function () {
    $fakeResponse = EmbeddingsResponseFake::make()
        ->withEmbeddings([Embedding::fromArray(array_fill(0, 1536, 0.1))])
        ->withUsage(new EmbeddingsUsage(10))
        ->withMeta(new Meta('fake-emb-1', 'fake-model'));

    Prism::fake([$fakeResponse]);

    $response = Prism::embeddings()
        ->using(Provider::OpenAI, 'text-embedding-3-small')
        ->fromInput('Test content for embedding generation.')
        ->asEmbeddings();

    expect($response->embeddings)->toHaveCount(1)
        ->and($response->embeddings[0]->embedding)
        ->toBeArray()
        ->toHaveCount(1536);
});
```

## Assertions

`PrismFake` provides several helpful assertion methods:

```php
// Assert specific prompt was sent
$fake->assertPrompt('Who are you?');

// Assert number of calls made
$fake->assertCallCount(2);

// Assert detailed request properties
$fake->assertRequest(function ($requests) {
    expect($requests[0]->provider())->toBe('anthropic');
    expect($requests[0]->model())->toBe('claude-3-sonnet');
});

// Assert provider configuration
$fake->assertProviderConfig(['api_key' => 'sk-1234']);
```

## Using the real response classes

While the fake helpers make tests concise, you can still build responses with the real
classes if you know you will need to test against all the properties of the response:

```php
use Prism\Prism\Text\Response;
use Illuminate\Support\Collection;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\Usage;
use Prism\Prism\ValueObjects\Meta;

$response = new Response(
    steps: collect([]),
    responseMessages: collect([]),
    text: 'The meaning of life is 42',
    finishReason: FinishReason::Stop,
    toolCalls: [],
    toolResults: [],
    usage: new Usage(42, 42),
    meta: new Meta('resp_1', 'real-model'),
    messages: collect([]),
    additionalContent: [],
);
```

This approach is perfectly valid—but for most tests the fake builders are shorter and
easier to read.



================================================
FILE: docs/core-concepts/text-generation.md
================================================
# Text Generation

Prism provides a powerful interface for generating text using Large Language Models (LLMs). This guide covers everything from basic usage to advanced features like multi-modal interactions and response handling.

## Basic Text Generation

At its simplest, you can generate text with just a few lines of code:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt('Tell me a short story about a brave knight.')
    ->asText();

echo $response->text;
```

## System Prompts and Context

System prompts help set the behavior and context for the AI. They're particularly useful for maintaining consistent responses or giving the LLM a persona:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withSystemPrompt('You are an expert mathematician who explains concepts simply.')
    ->withPrompt('Explain the Pythagorean theorem.')
    ->asText();
```

You can also use Laravel views for complex system prompts:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withSystemPrompt(view('prompts.math-tutor'))
    ->withPrompt('What is calculus?')
    ->asText();
```

You an also pass a View to the `withPrompt` method.

## Multi-Modal Input

Prism supports including images, documents, audio, and video files in your prompts for rich multi-modal analysis:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Video;

// Analyze an image
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'What objects do you see in this image?',
        [Image::fromLocalPath('/path/to/image.jpg')]
    )
    ->asText();

// Process a document
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'Summarize the key points from this document',
        [Document::fromLocalPath('/path/to/document.pdf')]
    )
    ->asText();

// Analyze audio content
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'What is being discussed in this audio?',
        [Audio::fromLocalPath('/path/to/audio.mp3')]
    )
    ->asText();

// Process video content
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Describe what happens in this video',
        [Video::fromUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ')]
    )
    ->asText();

// Multiple media types in one prompt
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Compare this image with the information in this document',
        [
            Image::fromLocalPath('/path/to/chart.png'),
            Document::fromLocalPath('/path/to/report.pdf')
        ]
    )
    ->asText();
```

## Message Chains and Conversations

For interactive conversations, use message chains to maintain context:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withMessages([
        new UserMessage('What is JSON?'),
        new AssistantMessage('JSON is a lightweight data format...'),
        new UserMessage('Can you show me an example?')
    ])
    ->asText();
```

### Message Types

- `SystemMessage`
- `UserMessage`
- `AssistantMessage`
- `ToolResultMessage`

> [!NOTE]
> Some providers, like Anthropic, do not support the `SystemMessage` type. In those cases we convert `SystemMessage` to `UserMessage`.

## Generation Parameters

Fine-tune your generations with various parameters:

`withMaxTokens`

Maximum number of tokens to generate.

`usingTemperature`

Temperature setting.

The value is passed through to the provider. The range depends on the provider and model. For most providers, 0 means almost deterministic results, and higher values mean more randomness.

> [!TIP]
> It is recommended to set either temperature or topP, but not both.

`usingTopP`

Nucleus sampling.

The value is passed through to the provider. The range depends on the provider and model. For most providers, nucleus sampling is a number between 0 and 1. E.g. 0.1 would mean that only tokens with the top 10% probability mass are considered.

> [!TIP]
> It is recommended to set either temperature or topP, but not both.

`withClientOptions`

Under the hood we use Laravel's [HTTP client](https://laravel.com/docs/11.x/http-client#main-content). You can use this method to pass any of Guzzles [request options](https://docs.guzzlephp.org/en/stable/request-options.html) e.g. `->withClientOptions(['timeout' => 30])`.

`withClientRetry`

Under the hood we use Laravel's [HTTP client](https://laravel.com/docs/11.x/http-client#main-content). You can use this method to set [retries](https://laravel.com/docs/11.x/http-client#retries) e.g. `->withClientRetry(3, 100)`.

`usingProviderConfig`

This allows for complete or partial override of the providers configuration. This is great for multi-tenant applications where users supply their own API keys. These values are merged with the original configuration allowing for partial or complete config override.

## Response Handling

The response object provides rich access to the generation results:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt('Explain quantum computing.')
    ->asText();

// Access the generated text
echo $response->text;

// Check why the generation stopped
echo $response->finishReason->name;

// Get token usage statistics
echo "Prompt tokens: {$response->usage->promptTokens}";
echo "Completion tokens: {$response->usage->completionTokens}";

// For multi-step generations, examine each step
foreach ($response->steps as $step) {
    echo "Step text: {$step->text}";
    echo "Step tokens: {$step->usage->completionTokens}";
}

// Access message history
foreach ($response->responseMessages as $message) {
    if ($message instanceof AssistantMessage) {
        echo $message->content;
    }
}
```

## Handling Completions with Callbacks

Need to perform actions after text generation completes? The `onComplete()` callback lets you handle the generated messages without interrupting the response flow. This is perfect for persisting conversations, tracking analytics, or logging AI interactions.

### Basic Example

```php
use Illuminate\Support\Collection;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Text\PendingRequest;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt('Explain Laravel middleware')
    ->onComplete(function (PendingRequest $request, Collection $messages) {
        // Save the conversation after generation completes
        foreach ($messages as $message) {
            ConversationLog::create([
                'model' => $request->model,
                'prompt' => $request->prompt,
                'content' => $message->content,
                'role' => 'assistant',
            ]);
        }
    })
    ->asText();

// Response is still returned normally
echo $response->text;
```

## Error Handling

Remember to handle potential errors in your generations:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Throwable;

try {
    $response = Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
        ->withPrompt('Generate text...')
        ->asText();
} catch (PrismException $e) {
    Log::error('Text generation failed:', ['error' => $e->getMessage()]);
} catch (Throwable $e) {
    Log::error('Generic error:', ['error' => $e->getMessage()]);
}
```



================================================
FILE: docs/core-concepts/tools-function-calling.md
================================================
# Tools & Function Calling

Need your AI assistant to check the weather, search a database, or call your API? Tools are here to help! They let you extend your AI's capabilities by giving it access to specific functions it can call.

## Tool Concept Overview

Think of tools as special functions that your AI assistant can use when it needs to perform specific tasks. Just like how Laravel's facades provide a clean interface to complex functionality, Prism tools give your AI a clean way to interact with external services and data sources.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Tool;

$weatherTool = Tool::as('weather')
    ->for('Get current weather conditions')
    ->withStringParameter('city', 'The city to get weather for')
    ->using(function (string $city): string {
        // Your weather API logic here
        return "The weather in {$city} is sunny and 72°F.";
    });

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    ->withMaxSteps(2)
    ->withPrompt('What is the weather like in Paris?')
    ->withTools([$weatherTool])
    ->asText();
```

## Max Steps

Prism defaults to allowing a single step. To use Tools, you'll need to increase this using `withMaxSteps`:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    // Increase max steps to at least 2
    ->withMaxSteps(2)
    ->withPrompt('What is the weather like in Paris?')
    ->withTools([$weatherTool])
    ->asText();
```

You should use a higher number of max steps if you expect your initial prompt to make multiple tool calls.

## Creating Basic Tools

Creating tools in Prism is straightforward and fluent. Here's how you can create a simple tool:

```php
use Prism\Prism\Facades\Tool;

$searchTool = Tool::as('search')
    ->for('Search for current information')
    ->withStringParameter('query', 'The search query')
    ->using(function (string $query): string {
        // Your search implementation
        return "Search results for: {$query}";
    });
```

Tools can take a variety of parameters, but must always return a string.

## Error Handling

By default, tools handle invalid parameters gracefully by returning error messages instead of throwing exceptions. This helps AI assistants understand and potentially correct their mistakes.

```php
$tool = Tool::as('calculate')
    ->for('Add two numbers')
    ->withNumberParameter('a', 'First number')
    ->withNumberParameter('b', 'Second number')
    ->using(fn (int $a, int $b): string => (string) ($a + $b));

// If AI provides invalid parameters, it receives:
// "Parameter validation error: Type mismatch. Expected: [a (NumberSchema, required), b (NumberSchema, required)]. Received: {"a":"five","b":10}"
```

### Opting Out

If you prefer exceptions for invalid parameters:

```php
// Per-tool
$tool->withoutErrorHandling();

// Per-request
Prism::text()->withoutToolErrorHandling();
```

**Best Practice**: Use default error handling for conversational AI. Disable it only when you need strict validation that stops execution.

## Parameter Definition

Prism offers multiple ways to define tool parameters, from simple primitives to complex objects.

### String Parameters

Perfect for text inputs:

```php
use Prism\Prism\Facades\Tool;

$tool = Tool::as('search')
    ->for('Search for information')
    ->withStringParameter('query', 'The search query')
    ->using(function (string $query): string {
        return "Search results for: {$query}";
    });
```

### Number Parameters

For integer or floating-point values:

```php
use Prism\Prism\Facades\Tool;

$tool = Tool::as('calculate')
    ->for('Perform calculations')
    ->withNumberParameter('value', 'The number to process')
    ->using(function (float $value): string {
        return "Calculated result: {$value * 2}";
    });
```

### Boolean Parameters

For true/false flags:

```php
use Prism\Prism\Facades\Tool;

$tool = Tool::as('feature_toggle')
    ->for('Toggle a feature')
    ->withBooleanParameter('enabled', 'Whether to enable the feature')
    ->using(function (bool $enabled): string {
        return "Feature is now " . ($enabled ? 'enabled' : 'disabled');
    });
```

### Array Parameters

For handling lists of items:

```php
use Prism\Prism\Facades\Tool;

$tool = Tool::as('process_tags')
    ->for('Process a list of tags')
    ->withArrayParameter(
        'tags',
        'List of tags to process',
        new StringSchema('tag', 'A single tag')
    )
    ->using(function (array $tags): string {
        return "Processing tags: " . implode(', ', $tags);
    });
```

### Enum Parameters

When you need to restrict values to a specific set:

```php
use Prism\Prism\Facades\Tool;

$tool = Tool::as('set_status')
    ->for('Set the status')
    ->withEnumParameter(
        'status',
        'The new status',
        ['draft', 'published', 'archived']
    )
    ->using(function (string $status): string {
        return "Status set to: {$status}";
    });
```

### Object Parameters

For complex objects without needing to create separate schema instances:

```php
use Prism\Prism\Facades\Tool;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Schema\NumberSchema;

$tool = Tool::as('update_user')
    ->for('Update a user profile')
    ->withObjectParameter(
        'user',
        'The user profile data',
        [
            new StringSchema('name', 'User\'s full name'),
            new NumberSchema('age', 'User\'s age'),
            new StringSchema('email', 'User\'s email address')
        ],
        requiredFields: ['name', 'email']
    )
    ->using(function (array $user): string {
        return "Updated user profile for: {$user['name']}";
    });
```

### Schema-based Parameters

For complex, nested data structures, you can use Prism's schema system:

```php
use Prism\Prism\Facades\Tool;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Schema\NumberSchema;

$tool = Tool::as('create_user')
    ->for('Create a new user profile')
    ->withParameter(new ObjectSchema(
        name: 'user',
        description: 'The user profile data',
        properties: [
            new StringSchema('name', 'User\'s full name'),
            new NumberSchema('age', 'User\'s age'),
            new StringSchema('email', 'User\'s email address')
        ],
        requiredFields: ['name', 'email']
    ))
    ->using(function (array $user): string {
        return "Created user profile for: {$user['name']}";
    });
```

> [!TIP]
> For more complex parameter definitions, Prism provides a powerful schema system. See our [complete schemas guide](/core-concepts/schemas) to learn how to define complex nested objects, arrays, enums, and more.

## Complex Tool Implementation

For more sophisticated tools, you can create dedicated classes:

```php
namespace App\Tools;

use Prism\Prism\Tool;
use Illuminate\Support\Facades\Http;

class SearchTool extends Tool
{
    public function __construct()
    {
        $this
            ->as('search')
            ->for('useful when you need to search for current events')
            ->withStringParameter('query', 'Detailed search query. Best to search one topic at a time.')
            ->using($this);
    }

    public function __invoke(string $query): string
    {
        $response = Http::get('https://serpapi.com/search', [
            'engine' => 'google',
            'q' => $query,
            'google_domain' => 'google.com',
            'gl' => 'us',
            'hl' => 'en',
            'api_key' => config('services.serpapi.api_key'),
        ]);

        $results = collect($response->json('organic_results'));

        $results->map(function ($result) {
            return [
                'title' => $result['title'],
                'link' => $result['link'],
                'snippet' => $result['snippet'],
            ];
        })->take(4);

        return view('prompts.search-tool-results', [
            'results' => $results,
        ])->render();
    }
}
```

## Tool Choice Options

You can control how the AI uses tools with the `withToolChoice` method:
```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;

$prism = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    ->withMaxSteps(2)
    ->withPrompt('How is the weather in Paris?')
    ->withTools([$weatherTool])
    // Let the AI decide whether to use tools
    ->withToolChoice(ToolChoice::Auto)
    // Force the AI to use a tool
    ->withToolChoice(ToolChoice::Any)
    // Force the AI to use a specific tool
    ->withToolChoice('weather');
```

> [!WARNING]
> Tool choice support varies by provider. Check your provider's documentation for specific capabilities.

## Response Handling with Tools

When your AI uses tools, you can inspect the results and see how it arrived at its answer:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    ->withMaxSteps(2)
    ->withPrompt('What is the weather like in Paris?')
    ->withTools([$weatherTool])
    ->asText();

// Get the final answer
echo $response->text;

// ->text is empty for tool calls

// Inspect tool usage

if ($response->toolResults) {
    foreach ($response->toolResults as $toolResult) {
        echo "Tool: " . $toolResult->toolName . "\n";
        echo "Result: " . $toolResult->result . "\n";
    }
}


foreach ($response->steps as $step) {
    if ($step->toolCalls) {
        foreach ($step->toolCalls as $toolCall) {
            echo "Tool: " . $toolCall->name . "\n";
            echo "Arguments: " . json_encode($toolCall->arguments()) . "\n";
        }
    }
}
```

## Provider Tools

In addition to custom tools that you define, Prism supports **provider tools** - built-in capabilities offered directly by AI providers. These are specialized tools that leverage the provider's own infrastructure and services.

### Understanding Provider Tools vs Custom Tools

**Custom Tools** (covered above) are functions you define and implement yourself:
- You control the logic and implementation
- Called by the AI, executed by your code
- Can access your databases, APIs, and services

**Provider Tools** are built-in capabilities offered by the AI provider:
- Implemented and executed by the provider
- Access the provider's own services and infrastructure
- Enable capabilities like code execution, web search, and more

### Using Provider Tools

Provider tools are added to your requests using the `withProviderTools()` method with `ProviderTool` objects:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\ProviderTool;

$response = Prism::text()
    ->using('anthropic', 'claude-3-5-sonnet-latest')
    ->withPrompt('Calculate the fibonacci sequence up to 100')
    ->withProviderTools([
        new ProviderTool(type: 'code_execution_20250522', name: 'code_execution')
    ])
    ->asText();
```

### Available Provider Tools

Each provider offers different built-in capabilities. Check the provider-specific documentation for detailed information about available tools, configuration options, and usage examples.

### ProviderTool Object

The `ProviderTool` class accepts three parameters:

```php
new ProviderTool(
    type: 'code_execution_20250522',  // Required: The provider tool identifier
    name: 'code_execution',           // Optional: Custom name for the tool
    options: []                       // Optional: Provider-specific options
)
```

- **type**: The provider-specific tool identifier (required)
- **name**: Optional custom name for the tool
- **options**: Additional provider-specific configuration options

### Combining Provider Tools and Custom Tools

You can use both provider tools and custom tools in the same request:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\ProviderTool;
use Prism\Prism\Facades\Tool;

$customTool = Tool::as('database_lookup')
    ->for('Look up user information')
    ->withStringParameter('user_id', 'The user ID to look up')
    ->using(function (string $userId): string {
        // Your database lookup logic
        return "User data for ID: {$userId}";
    });

$response = Prism::text()
    ->using('anthropic', 'claude-3-5-sonnet-latest')
    ->withMaxSteps(5)
    ->withPrompt('Look up user 123 and calculate their usage statistics')
    ->withTools([$customTool])
    ->withProviderTools([
        new ProviderTool(type: 'code_execution_20250522', name: 'code_execution')
    ])
    ->asText();
``` 



================================================
FILE: docs/getting-started/configuration.md
================================================
# Configuration

Prism's flexible configuration allows you to easily set up and switch between different AI providers. Let's dive into how you can configure Prism to work with your preferred providers.

## Configuration File

After installation, you'll find the Prism configuration file at `config/prism.php`. If you haven't published it yet, you can do so with:

```bash
php artisan vendor:publish --tag=prism-config
```

Let's break down the key sections of this configuration file:

```php
return [
    'prism_server' => [
        'enabled' => env('PRISM_SERVER_ENABLED', false),
    ],
    'providers' => [
        // Provider configurations here
    ],
];
```

## Provider Configuration

Prism uses a straightforward provider configuration system that lets you set up multiple AI providers in one place. Each provider has its own section in the configuration file where you can specify:

- API credentials
- Base URLs (useful for self-hosted instances or custom endpoints)
- Other Provider-specific settings

Here's a general template for how providers are configured:

```php
'providers' => [
    'provider-name' => [
        'api_key' => env('PROVIDER_API_KEY', ''),
        'url' => env('PROVIDER_URL', 'https://api.provider.com'),
        // Other provider-specific settings
    ],
],
```

## Environment Variables

Prism follows Laravel's environment configuration best practices. All sensitive or environment-specific values should be stored in your `.env` file. Here's how it works:

1. Each provider's configuration pulls values from environment variables
2. Default values are provided as fallbacks
3. Environment variables follow a predictable naming pattern:
   - API keys: `PROVIDER_API_KEY`
   - URLs: `PROVIDER_URL`
   - Other settings: `PROVIDER_SETTING_NAME`

For example:

```shell
# Prism Server Configuration
PRISM_SERVER_ENABLED=true

# Provider Configuration
PROVIDER_API_KEY=your-api-key-here
PROVIDER_URL=https://custom-endpoint.com

```

> [!NOTE]
> Remember to always refer to your chosen provider's documentation pages for the most up-to-date configuration options and requirements specific to that provider.

## Overriding config in your code

You can override config in your code in two ways:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

// Via the third parameter of `using()`
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o', [
        'url' => 'new-base-url'
    ])
    ->withPrompt('Explain quantum computing.')
    ->asText();

// Or via `usingProviderConfig()` (note that this will re-resolve the provider).
$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4o')
    ->usingProviderConfig([
        'url' => 'new-base-url'
    ])
    ->withPrompt('Explain quantum computing.')
    ->asText();
```



================================================
FILE: docs/getting-started/installation.md
================================================
# Installation

Getting started with Prism is a breeze.

## Requirements

Before we dive in, make sure your project meets these requirements:

- PHP 8.2 or higher
- Laravel 11.0 or higher

## Step 1: Composer Installation

::: tip
Prism is actively evolving. To prevent unexpected issues from breaking changes, we strongly recommend pinning your installation to a specific version. Example: "prism-php/prism": "^0.3.0".
:::

First, let's add Prism to your project using Composer. Open your terminal, navigate to your project directory, and run:

```bash
composer require prism-php/prism
```

This command will download Prism and its dependencies into your project.

## Step 2: Publish the Configuration

Prism comes with a configuration file that you'll want to customize. Publish it to your config directory by running:

```bash
php artisan vendor:publish --tag=prism-config
```

This will create a new file at `config/prism.php`. We'll explore how to configure Prism in the next section.



================================================
FILE: docs/getting-started/introduction.md
================================================
<script setup>
import ProviderSupport from '../components/ProviderSupport.vue'
</script>

# Introduction

Large Language Models (LLMs) have revolutionized how we interact with artificial intelligence, enabling applications to understand, generate, and manipulate human language with unprecedented sophistication. These powerful models open up exciting possibilities for developers, from creating chatbots and content generators to building complex AI-driven applications.

Prism **simplifies the process of integrating LLMs into your Laravel projects**, providing a unified interface to work with various AI providers. This allows you to focus on crafting innovative AI features for your users, rather than getting bogged down in the intricacies of different APIs and implementation details.

Here's a quick example of how you can generate text using Prism:

::: code-group
```php [Anthropic]
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-7-sonnet-latest')
    ->withSystemPrompt(view('prompts.system'))
    ->withPrompt('Explain quantum computing to a 5-year-old.')
    ->asText();

echo $response->text;
```

```php [Mistral]
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Mistral, 'mistral-medium')
    ->withSystemPrompt(view('prompts.system'))
    ->withPrompt('Explain quantum computing to a 5-year-old.')
    ->asText();

echo $response->text;
```

```php [Ollama]
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Ollama, 'llama2')
    ->withSystemPrompt(view('prompts.system'))
    ->withPrompt('Explain quantum computing to a 5-year-old.')
    ->asText();

echo $response->text;
```

```php [OpenAI]
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::OpenAI, 'gpt-4')
    ->withSystemPrompt(view('prompts.system'))
    ->withPrompt('Explain quantum computing to a 5-year-old.')
    ->asText();

echo $response->text;
```
:::

Prism draws significant inspiration from the [Vercel AI SDK](https://sdk.vercel.ai/docs/ai-sdk-core), adapting its powerful concepts and developer-friendly approach to the Laravel ecosystem.

## Key Features

- **Unified Provider Interface**: Switch seamlessly between AI providers like OpenAI, Anthropic, and Ollama without changing your application code.
- **Tool System**: Extend AI capabilities by defining custom tools that can interact with your application's business logic.
- **Image Support**: Work with multi-modal models that can process both text and images.

Prism also provides a fluent `prism()` helper function to resolve the `Prism` instance from the application container.

```php
prism()
    ->text()
    ->using(Provider::OpenAI, 'gpt-4')
    ->withPrompt('Explain quantum computing to a 5-year-old.')
    ->asText();
``` 

## Providers

We currently offer first-party support for these leading AI providers:

- [Anthropic](/providers/anthropic.md)
- [DeepSeek](/providers/deepseek.md)
- [Groq](/providers/groq.md)
- [Mistral](/providers/mistral.md)
- [Ollama](/providers/ollama.md)
- [OpenAI](/providers/openai.md)
- [xAI](/providers/xai.md)

Each provider brings its own strengths to the table, and Prism makes it easy to use them all through a consistent, elegant interface.

## Provider Support

Make sure you check the dedicated provider pages for considerations, limitations, and options. Support may be model dependant, check with your provider for model specific features and support.

<ProviderSupport />



================================================
FILE: docs/input-modalities/audio.md
================================================
# Audio

Prism supports including audio files in your messages for advanced analysis with supported providers like Gemini.

See the [provider support table](/getting-started/introduction.html#provider-support) to check whether Prism supports your chosen provider.

Note however that provider support may differ by model. If you receive error messages with a provider that Prism indicates is supported, check the provider's documentation as to whether the model you are using supports audio files.

::: tip
For other input modalities like videos and images, see their respective documentation pages:
- [Video documentation](/input-modalities/video.html)
- [Images documentation](/input-modalities/images.html)
:::

## Getting started

To add an audio file to your prompt, use the `withPrompt` method with an `Audio` value object:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Audio;

// From a local path
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        "What's in this audio?",
        [Audio::fromLocalPath(path: '/path/to/audio.mp3')]
    )
    ->asText();

// From a path on a storage disk
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        "What's in this audio?",
        [Audio::fromStoragePath(
            path: '/path/to/audio.mp3',
            diskName: 'my-disk' // optional - omit/null for default disk
        )]
    )
    ->asText();

// From a URL
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this audio:',
        [Audio::fromUrl(url: 'https://example.com/audio.mp3')]
    )
    ->asText();

// From base64
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this audio:',
        [Audio::fromBase64(
            base64: base64_encode(file_get_contents('/path/to/audio.mp3')),
            mimeType: 'audio/mpeg'
        )]
    )
    ->asText();

// From raw content
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this audio:',
        [Audio::fromRawContent(
            rawContent: file_get_contents('/path/to/audio.mp3'),
            mimeType: 'audio/mpeg'
        )]
    )
    ->asText();
```

## Alternative: Using withMessages

You can also include audio files using the message-based approach:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Audio;

$message = new UserMessage(
    "What's in this audio?",
    [Audio::fromLocalPath(path: '/path/to/audio.mp3')]
);

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withMessages([$message])
    ->asText();
```

## Supported Audio Types

Prism supports a variety of audio formats, including:

- MP3 (audio/mpeg)
- WAV (audio/x-wav, audio/wav)
- AAC (audio/aac)
- FLAC (audio/flac)

The specific supported formats depend on the provider. Gemini is currently the main provider with comprehensive audio analysis capabilities. Check the provider's documentation for a complete list of supported formats.

## Transfer mediums

Providers are not consistent in their support of sending raw contents, base64 and/or URLs.

Prism tries to smooth over these rough edges, but its not always possible.

### Supported conversions
- Where a provider does not support URLs: Prism will fetch the URL and use base64 or rawContent.
- Where you provide a file, base64 or rawContent: Prism will switch between base64 and rawContent depending on what the provider accepts.

### Limitations
- Where a provider only supports URLs: if you provide a file path, raw contents or base64, for security reasons Prism does not create a URL for you and your request will fail.



================================================
FILE: docs/input-modalities/documents.md
================================================
# Documents

Prism supports including documents in your messages with some providers.

See the [provider support table](/getting-started/introduction.html#provider-support) to check whether Prism supports your chosen provider.

Note however that provider support may differ by model. If you receive error messages with a provider that Prism indicates is supported, check the provider's documentation as to whether the model you are using supports documents.

## Supported file types

> [!TIP]
> If provider interoperability is important to your app, we recommend converting documents to markdown.

Please check provider documentation for supported file/mime types, as support differs widely.

The most supported file types are pdf and text/plain (which may include markdown).

## Transfer mediums

> [!TIP]
> If provider interoperability is important to your app, we recommend using rawContent or base64.

Providers are not consistent in their support of sending file raw contents, base64 and/or URLs.

Prism tries to smooth over these rough edges, but its not always possible.

### Supported conversions

- Where a provider does not support URLs: Prism will fetch the URL and use base64 or rawContent.
- Where you provide a file, base64 or rawContent: Prism will switch between base64 and rawContent depending on what the provider accepts.

### Limitations

- Where a provider only supports URLs: if you provide a file path, raw contents, base64 or chunks, for security reasons Prism does not create a URL for you and your request will fail.
- Chunks cannot be passed between providers, as they could be in different formats (however, currently only Anthropic supports them).

## Getting started

To add a document to your prompt, use the `withPrompt` method with a `Document` value object:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Document;

// From a local path
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Analyze this document',
        [Document::fromLocalPath(
            path: 'tests/Fixtures/test-pdf.pdf',
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From a storage path
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Summarize this document',
        [Document::fromStoragePath(
            path: 'mystoragepath/file.pdf',
            diskName: 'my-disk', // optional - omit/null for default disk
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From base64
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Extract key points from this document',
        [Document::fromBase64(
            base64: $baseFromDB,
            mimeType: 'optional/mimetype', // optional
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From raw content
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Review this document',
        [Document::fromRawContent(
            rawContent: $rawContent,
            mimeType: 'optional/mimetype', // optional
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From a text string
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Process this text document',
        [Document::fromText(
            text: 'Hello world!',
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From an URL
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Analyze this document from URL',
        [Document::fromUrl(
            url: 'https://example.com/test-pdf.pdf',
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From chunks
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Process this chunked document',
        [Document::fromChunks(
            chunks: [
                'chunk one',
                'chunk two'
            ],
            title: 'My document title' // optional
        )]
    )
    ->asText();

// From a provider file ID
$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withPrompt(
        'Analyze this document from provider file',
        [Document::fromFileId(
            fileId: 'my-provider-file-id'
        )]
    )
    ->asText();
```

## Alternative: Using withMessages

You can also include documents using the message-based approach:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Document;

$message = new UserMessage(
    'Analyze this document',
    [Document::fromLocalPath(
        path: 'tests/Fixtures/test-pdf.pdf',
        title: 'My document title' // optional
    )]
);

$response = Prism::text()
    ->using('my-provider', 'my-model')
    ->withMessages([$message])
    ->asText();
```

Or, if using a provider file_id - use fromFileId:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Document;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'Analyze this OpenAI file',
        [Document::fromFileId(
            fileId: 'file-lsfgSXyV2xEb8gw8fYjXU6'
        )]
    )
    ->asText();
```



================================================
FILE: docs/input-modalities/images.md
================================================
# Images

Prism supports including images in your messages for vision analysis for most providers.

See the [provider support table](/getting-started/introduction.html#provider-support) to check whether Prism supports your chosen provider.

Note however that provider support may differ by model. If you receive error messages with a provider that Prism indicates is supported, check the provider's documentation as to whether the model you are using supports images.

## Getting started

To add an image to your prompt, use the `withPrompt` method with an `Image` value object:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

// From a local path
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        "What's in this image?",
        [Image::fromLocalPath(path: '/path/to/image.jpg')]
    )
    ->asText();

// From a path on a storage disk
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        "What's in this image?",
        [Image::fromStoragePath(
            path: '/path/to/image.jpg',
            diskName: 'my-disk' // optional - omit/null for default disk
        )]
    )
    ->asText();

// From a URL
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'Analyze this diagram:',
        [Image::fromUrl(url: 'https://example.com/diagram.png')]
    )
    ->asText();

// From base64
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'Analyze this diagram:',
        [Image::fromBase64(base64: base64_encode(file_get_contents('/path/to/image.jpg')))]
    )
    ->asText();

// From raw content
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withPrompt(
        'Analyze this diagram:',
        [Image::fromRawContent(rawContent: file_get_contents('/path/to/image.jpg'))]
    )
    ->asText();
```

## Alternative: Using withMessages

You can also include images using the message-based approach:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Image;

$message = new UserMessage(
    "What's in this image?",
    [Image::fromLocalPath(path: '/path/to/image.jpg')]
);

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withMessages([$message])
    ->asText();
```

## Customizing Image Filenames

When uploading images, you can provide a custom filename using the fluent `as()` method. This is particularly useful when working with multiple images, as it makes your API requests more readable and helps with debugging:

```php
use Prism\Prism\ValueObjects\Media\Image;

$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('Edit these images', [
        Image::fromLocalPath('path/to/photo1.png')->as('original-photo.png'),
        Image::fromLocalPath('path/to/photo2.png')->as('reference-image.png'),
    ])
    ->generate();
```

Without custom filenames, images are automatically named using a default pattern. The `as()` method lets you provide meaningful names that make your code more self-documenting.

## Transfer mediums

Providers are not consistent in their support of sending raw contents, base64 and/or URLs (as noted above).

Prism tries to smooth over these rough edges, but its not always possible.

### Supported conversions
- Where a provider does not support URLs: Prism will fetch the URL and use base64 or rawContent.
- Where you provide a file, base64 or rawContent: Prism will switch between base64 and rawContent depending on what the provider accepts.

### Limitations
- Where a provider only supports URLs: if you provide a file path, raw contents or base64, for security reasons Prism does not create a URL for you and your request will fail.



================================================
FILE: docs/input-modalities/video.md
================================================
# Video

Prism supports including video files and YouTube videos in your messages for advanced analysis with supported providers like Gemini.

See the [provider support table](/getting-started/introduction.html#provider-support) to check whether Prism supports your chosen provider.

Note however that provider support may differ by model. If you receive error messages with a provider that Prism indicates is supported, check the provider's documentation as to whether the model you are using supports video files.

::: tip
For other input modalities like audio and images, see their respective documentation pages:
- [Audio documentation](/input-modalities/audio.html)
- [Images documentation](/input-modalities/images.html)
:::

## Getting started

To add a video to your prompt, use the `withPrompt` method with a `Video` value object:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Video;

// From a local path
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        "What's in this video?",
        [Video::fromLocalPath(path: '/path/to/video.mp4')]
    )
    ->asText();

// From a path on a storage disk
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        "What's in this video?",
        [Video::fromStoragePath(
            path: '/path/to/video.mp4',
            diskName: 'my-disk' // optional - omit/null for default disk
        )]
    )
    ->asText();

// From a URL
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this video:',
        [Video::fromUrl(url: 'https://example.com/video.mp4')]
    )
    ->asText();

// From a YouTube URL (automatically extracts the video ID)
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'What is this YouTube video about?',
        [Video::fromUrl(url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ')]
    )
    ->asText();

// From shortened YouTube URL
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'What is this YouTube video about?',
        [Video::fromUrl(url: 'https://youtu.be/dQw4w9WgXcQ')]
    )
    ->asText();

// From base64
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this video:',
        [Video::fromBase64(
            base64: base64_encode(file_get_contents('/path/to/video.mp4')),
            mimeType: 'video/mp4'
        )]
    )
    ->asText();

// From raw content
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'Analyze this video:',
        [Video::fromRawContent(
            rawContent: file_get_contents('/path/to/video.mp4'),
            mimeType: 'video/mp4'
        )]
    )
    ->asText();
```

## Alternative: Using withMessages

You can also include videos using the message-based approach:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Video;

$message = new UserMessage(
    "What's in this video?",
    [Video::fromLocalPath(path: '/path/to/video.mp4')]
);

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withMessages([$message])
    ->asText();
```

## Supported Video Types

Prism supports a variety of video formats, including:

- MP4 (video/mp4)
- MOV (video/quicktime)
- WEBM (video/webm)
- AVI (video/x-msvideo)
- YouTube videos (via URL)

The specific supported formats depend on the provider. Gemini is currently the main provider with comprehensive video analysis capabilities. Check the provider's documentation for a complete list of supported formats.

## YouTube Video Support

Prism provides seamless support for YouTube videos. When you pass a YouTube URL to `Video::fromUrl()`, Prism automatically extracts the video ID and sends it to the provider in the appropriate format.

Supported YouTube URL formats:

- Standard: `https://www.youtube.com/watch?v=VIDEO_ID`
- Shortened: `https://youtu.be/VIDEO_ID`

Example:

```php
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withPrompt(
        'What is this YouTube video about?',
        [Video::fromUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ')]
    )
    ->asText();
```

## Transfer mediums

Providers are not consistent in their support of sending raw contents, base64 and/or URLs.

Prism tries to smooth over these rough edges, but its not always possible.

### Supported conversions
- Where a provider does not support URLs: Prism will fetch the URL and use base64 or rawContent.
- Where you provide a file, base64 or rawContent: Prism will switch between base64 and rawContent depending on what the provider accepts.

### Limitations
- Where a provider only supports URLs: if you provide a file path, raw contents or base64, for security reasons Prism does not create a URL for you and your request will fail.



================================================
FILE: docs/providers/anthropic.md
================================================
# Anthropic
## Configuration

```php
'anthropic' => [
    'api_key' => env('ANTHROPIC_API_KEY', ''),
    'version' => env('ANTHROPIC_API_VERSION', '2023-06-01'),
    'default_thinking_budget' => env('ANTHROPIC_DEFAULT_THINKING_BUDGET', 1024),
    // Include beta strings as a comma separated list.
    'anthropic_beta' => env('ANTHROPIC_BETA', null),
]
```
## Prompt caching

Anthropic's prompt caching feature allows you to drastically reduce latency and your API bill when repeatedly re-using blocks of content within five minutes of each other.

We support Anthropic prompt caching on:

- System Messages (text only)
- User Messages (Text, Image and PDF (pdf only))
- Assistant Messages (text only)
- Tools

The API for enabling prompt caching is the same for all, enabled via the `withProviderOptions()` method. Where a UserMessage contains both text and an image or document, both will be cached.

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withSystemPrompt(
        (new SystemMessage('I am a long re-usable system message.'))
            ->withProviderOptions(['cacheType' => 'ephemeral'])
    )
    ->withMessages([
        (new UserMessage('I am a long re-usable user message.'))
            ->withProviderOptions(['cacheType' => 'ephemeral'])
    ])
    ->withTools([
        Tool::as('cache me')
            ->withProviderOptions(['cacheType' => 'ephemeral'])
    ])
    ->asText();
```

If you prefer, you can use the `AnthropicCacheType` Enum like so:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Providers\Anthropic\Enums\AnthropicCacheType;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Document;

(new UserMessage('I am a long re-usable user message.'))->withProviderOptions(['cacheType' => AnthropicCacheType::ephemeral])
```
**Important:** To enable prompt caching:
- System messages must use `withSystemPrompt()` or `withSystemPrompts()` (Anthropic does not allow SystemMessages in the messages array)
- User and Assistant messages must use `withMessages()`
- Tools use `withTools()`
- All message types support caching via `withProviderOptions(['cacheType' => 'ephemeral'])`
- You cannot use `withPrompt()` for caching as it doesn't allow adding provider options to individual messages

### Tool result caching

In addition to caching prompts and tool definitions, Prism supports caching tool results. This is particularly useful when making multiple tool calls where results might be referenced repeatedly.

To enable tool result caching, use the `tool_result_cache_type` provider option on your request:

```php
use Prism\Prism\Facades\Prism;

$response = Prism::text()
    ->using('anthropic', 'claude-3-5-sonnet-20241022')
    ->withMaxSteps(30)
    ->withTools([new WeatherTool()])
    ->withProviderOptions([
        'tool_result_cache_type' => 'ephemeral'
    ])
    ->withPrompt('Check the weather in New York, London, Tokyo, Paris, and Sydney')
    ->asText();
```

When multiple tool results are returned, Prism automatically applies caching to only the last result, which caches all preceding results as well. This avoids Anthropic's 4-cache-breakpoint limitation.

Please ensure you read Anthropic's [prompt caching documentation](https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching), which covers some important information on e.g. minimum cacheable tokens and message order consistency.

## Extended thinking

Claude Sonnet 3.7 supports an optional extended thinking mode, where it will reason before returning its answer. Please ensure your consider [Anthropic's own extended thinking documentation](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking) before using extended thinking with caching and/or tools, as there are some important limitations and behaviours to be aware of.

### Enabling extended thinking and setting budget
Prism supports thinking mode for text and structured with the same API:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
    // enable thinking
    ->withProviderOptions(['thinking' => ['enabled' => true]]) 
    ->asText();
```
By default Prism will set the thinking budget to the value set in config, or where that isn't set, the minimum allowed (1024).

You can overide the config (or its default) using `withProviderOptions`:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
    // Enable thinking and set a budget
    ->withProviderOptions([
        'thinking' => [
            'enabled' => true, 
            'budgetTokens' => 2048
        ]
    ]);
```
Note that thinking tokens count towards output tokens, so you will be billed for them and your token budget must be less than the max tokens you have set for the request. 

If you expect a long response, you should ensure there's enough tokens left for the response - i.e. does (maxTokens - thinkingBudget) leave a sufficient remainder.

### Inspecting the thinking block

Anthropic returns the thinking block with its response. 

You can access it via the additionalContent property on either the Response or the relevant step.

On the Response (easiest if not using tools):

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
    ->withProviderOptions(['thinking' => ['enabled' => true']]) 
    ->asText();

$response->additionalContent['thinking'];
```

On the Step (necessary if using tools, as Anthropic returns the thinking block on the ToolCall step):

```php
$tools = [...];

$response = Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withTools($tools)
    ->withMaxSteps(3)
    ->withPrompt('What time is the tigers game today and should I wear a coat?')
    ->withProviderOptions(['thinking' => ['enabled' => true]])
    ->asText();

$response->steps->first()->additionalContent->thinking;
```

### Extended output mode

Claude Sonnet 3.7 also brings extended output mode which increase the output limit to 128k tokens. 

This feature is currently in beta, so you will need to enable to by adding `output-128k-2025-02-19` to your Anthropic anthropic_beta config (see [Configuration](#configuration) above).

## Streaming

Claude supports streaming responses in real-time. All the standard streaming methods work with Anthropic models:

```php
// Stream events
$stream = Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withPrompt('Write a story')
    ->asStream();

// Server-Sent Events
return Prism::text()
    ->using('anthropic', 'claude-3-7-sonnet-latest')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

### Streaming with Extended Thinking

When using extended thinking, the reasoning process streams separately from the final answer:

```php
use Prism\Prism\Enums\StreamEventType;

foreach ($stream as $event) {
    match ($event->type()) {
        StreamEventType::ThinkingDelta => echo "[Thinking] " . $event->delta,
        StreamEventType::TextDelta => echo $event->delta,
        default => null,
    };
}
```

For complete streaming documentation including Vercel Data Protocol and WebSocket broadcasting, see [Streaming Output](/core-concepts/streaming-output).

## Documents

Anthropic supports PDF, text and markdown documents. Note that Anthropic uses vision to process PDFs under the hood, and consequently there are some limitations detailed in their [feature documentation](https://docs.anthropic.com/en/docs/build-with-claude/pdf-support).

See the [Documents](/input-modalities/documents.html) on how to get started using them.

Anthropic also supports "custom content documents", separately documented below, which are primarily for use with citations.

### Custom content documents

Custom content documents are primarily for use with citations (see below), if you need citations to reference your own chunking strategy.

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Document;

Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withMessages([
        new UserMessage(
            content: "Is the grass green and the sky blue?",
            additionalContent: [
                Document::fromChunks(["The grass is green.", "Flamingos are pink.", "The sky is blue."])
            ]
        )
    ])
    ->asText();
```

## Citations

Prism supports [Anthropic's citations feature](https://docs.anthropic.com/en/docs/build-with-claude/citations) for both text and structured. 

Please note however that due to Anthropic not supporting "native" structured output, and Prism's workaround for this, the output can be unreliable. You should therefore ensure you implement proper error handling for the scenario where Anthropic does not return a valid decodable schema.

## Code execution

Anthropic offers built-in code execution capabilities that allow your AI to run code in a secure environment. This is a provider tool that executes code using Anthropic's infrastructure. For more information about the difference between custom tools and provider tools, see [Tools & Function Calling](/core-concepts/tools-function-calling#provider-tools).

To enable code execution, you will first need to enable the beta feature.

Either in prism/config.php:

```php
        'anthropic' => [
            ...
            'anthropic_beta' => 'code-execution-2025-05-22',
        ],

```

Or in your env file (assuming config/prism.php reflects the default prism setup):

```
ANTHROPIC_BETA="code-execution-2025-05-22"
```

You may then use code execution as follows:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\ProviderTool;

Prism::text()
    ->using('anthropic', 'claude-3-5-haiku-latest')
    ->withPrompt('Solve the equation 3x + 10 = 14.')
    ->withProviderTools([new ProviderTool(type: 'code_execution_20250522', name: 'code_execution')])
    ->asText();

```

### Enabling citations

Anthropic require citations to be enabled on all documents in a request. To enable them, using the `withProviderOptions()` method when building your request:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Document;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')
    ->withMessages([
        new UserMessage(
            content: "Is the grass green and the sky blue?",
            additionalContent: [
                Document::fromChunks(
                    chunks: ["The grass is green.", "Flamingos are pink.", "The sky is blue."],
                    title: 'The colours of nature',
                    context: 'The go-to textbook on the colours found in nature!'
                )
            ]
        )
    ])
    ->withProviderOptions(['citations' => true])
    ->asText();
```

### Accessing citations

You can access the chunked output with its citations via the additionalContent property on a response, which returns an array of `MessagePartWithCitations`s.

As a rough worked example, let's assume you want to implement footnotes. You'll need to loop through those chunks and (1) re-construct the message with links to the footnotes; and (2) build an array of footnotes to loop through in your frontend.

```php
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Citation;

$messageChunks = $response->additionalContent['citations'];

$text = '';
$footnotes = [];

$footnoteId = 1;

/** @var MessagePartWithCitations $messageChunk  */
foreach ($messageChunks as $messageChunk) {
    $text .= $messageChunk->outputText;
    
    /** @var Citation $citation */
    foreach ($messageChunk->citations as $citation) {
        $footnotes[] = [
            'id' => $footnoteId,
            'document_title' => $citation->sourceTitle,
            'reference_start' => $citation->sourceStartIndex,
            'reference_end' => $citation->sourceEndIndex
        ];
    
        $text .= '<sup><a href="#footnote-'.$footnoteId.'">'.$footnoteId.'</a></sup>';
    
        $footnoteId++;
    }
}
```

Note that when using streaming, Anthropic does not stream citations in the same way. Instead, of building the context as above, yield text to the browser in the usual way and pair text up with the relevant footnote using the `citationIndex` on the text chunk's additionalContent parameter.

## Considerations
### Message Order

- Message order matters. Anthropic is strict about the message order being:

1. `UserMessage`
2. `AssistantMessage`
3. `UserMessage`

### Structured Output

While Anthropic models don't have native JSON mode or structured output like some providers, Prism implements two approaches for structured output:

#### Default JSON Mode (Prompt-based)
- We automatically append instructions to your prompt that guide the model to output valid JSON matching your schema
- If the response isn't valid JSON, Prism will raise a PrismException
- This method can sometimes struggle with complex JSON containing quotes, especially in non-English languages

#### Tool Calling Mode (Recommended)
For more reliable structured output, especially when dealing with complex content or non-English text that may contain quotes, you can enable tool calling mode:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

$response = Prism::structured()
    ->withSchema(new ObjectSchema(
        'weather_report',
        'Weather forecast with recommendations',
        [
            new StringSchema('forecast', 'The weather forecast'),
            new StringSchema('recommendation', 'Clothing recommendation')
        ],
        ['forecast', 'recommendation']
    ))
    ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
    ->withPrompt('What\'s the weather like and what should I wear?')
    ->withProviderOptions(['use_tool_calling' => true])
    ->asStructured();
```

**Benefits of tool calling mode:**
- More reliable JSON parsing, especially with quotes and special characters
- Better handling of non-English content (Chinese, Japanese, etc.)
- Reduced risk of malformed JSON responses
- Compatible with thinking mode

**Limitations:**
- Cannot be used with citations (citations are not supported in tool calling mode)
- Slightly more complex under the hood but identical API usage

## Limitations
### Messages

Most providers' API include system messages in the messages array with a "system" role. Anthropic does not support the system role, and instead has a "system" property, separate from messages.

Therefore, for Anthropic we:
* Filter all `SystemMessage`s out, omitting them from messages.
* Always submit the prompt defined with `->withSystemPrompt()` at the top of the system prompts array.
* Move all `SystemMessage`s to the system prompts array in the order they were declared.

### Images

Does not support `Image::fromURL`



================================================
FILE: docs/providers/deepseek.md
================================================
# DeepSeek
## Configuration

```php
'deepseek' => [
    'api_key' => env('DEEPSEEK_API_KEY', ''),
    'url' => env('DEEPSEEK_URL', 'https://api.deepseek.com/v1')
]
```

## Provider-specific options

## Streaming

DeepSeek supports streaming responses in real-time. All standard streaming methods are supported:

```php
return Prism::text()
    ->using('deepseek', 'deepseek-chat')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

For complete streaming documentation, see [Streaming Output](/core-concepts/streaming-output).

## Limitations
### Embeddings

Does not support embeddings.

### Tool Choice

Does not support tool choice.

### Images

Does not support images.



================================================
FILE: docs/providers/elevenlabs.md
================================================
# ElevenLabs

## Configuration

```php
'elevenlabs' => [
    'api_key' => env('ELEVENLABS_API_KEY', ''),
    'url' => env('ELEVENLABS_URL', 'https://api.elevenlabs.io/v1/'),
]
```

## Speech-to-Text

ElevenLabs provides speech-to-text through their Scribe model with support for diarization and audio event tagging.

### Basic Usage

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;

$audioFile = Audio::fromPath('/path/to/recording.mp3');

$response = Prism::audio()
    ->using('elevenlabs', 'scribe_v1')
    ->withInput($audioFile)
    ->asText();
```

## Provider-specific Options

### Language Detection

```php
$response = Prism::audio()
    ->using('elevenlabs', 'scribe_v1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'language_code' => 'en',
    ])
    ->asText();
```

### Speaker Diarization

```php
$response = Prism::audio()
    ->using('elevenlabs', 'scribe_v1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'diarize' => true,
        'num_speakers' => 2,
    ])
    ->asText();
```

### Audio Event Tagging

```php
$response = Prism::audio()
    ->using('elevenlabs', 'scribe_v1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'tag_audio_events' => true,
    ])
    ->asText();
```

## Limitations

- Text-to-speech is not yet implemented


================================================
FILE: docs/providers/gemini.md
================================================
# Gemini

## Configuration

```php
'gemini' => [
    'api_key' => env('GEMINI_API_KEY', ''),
    'url' => env('GEMINI_URL', 'https://generativelanguage.googleapis.com/v1beta/models'),
],
```

## Search grounding

Google Gemini offers built-in search grounding capabilities that allow your AI to search the web for real-time information. This is a provider tool that uses Google's search infrastructure. For more information about the difference between custom tools and provider tools, see [Tools & Function Calling](/core-concepts/tools-function-calling#provider-tools).

You may enable Google search grounding on text requests using withProviderTools:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\ProviderTool;

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-2.0-flash')
    ->withPrompt('What is the stock price of Google right now?')
    // Enable search grounding
    ->withProviderTools([
            new ProviderTool('google_search')
        ])
    ->asText();
```

If you use search groundings, Google require you meet certain [display requirements](https://ai.google.dev/gemini-api/docs/grounding/search-suggestions).

The data you need to meet these display requirements, and to build e.g. footnote functionality will be saved to the response's `additionalContent` property.

```php
// The Google supplied and styled widget to click through to results.
$response->additionalContent['searchEntryPoint'];

// The search queries made by the model
$response->additionalContent['searchQueries'];

// The citations data is available as an array of MessagePartWithCitations
$response->additionalContent['citations'];
```

`citations` is an array of `MessagePartWithCitations`, which you can use to build up footnotes as follows:

```php
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Citation;

$text = '';
$footnotes = [];

$footnoteId = 1;

/** @var MessagePartWithCitations $part */
foreach ($response->additionalContent['citations'] as $part) {
    $text .= $part->outputText;
    
    /** @var Citation $citation */
    foreach ($part->citations as $citation) {
        $footnotes[] = [
            'id' => $footnoteId,
            'title' => $citation->sourceTitle,
            'uri' => $citation->source,
        ];

        $text .= '<sup><a href="#footnote-'.$footnoteId.'">'.$footnoteId.'</a></sup>';

        $footnoteId++;
    }
}

// Pass $text and $footnotes to your frontend.
```

## Caching

Prism supports Gemini prompt caching, though due to Gemini requiring you first upload the cached content, it works a little differently to other providers.

To store content in the cache, use the Gemini provider cache method as follows:

```php

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Gemini\Gemini;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;

/** @var Gemini */
$provider = Prism::provider(Provider::Gemini);

$object = $provider->cache(
    model: 'gemini-1.5-flash-002',
    messages: [
        new UserMessage('', [
            Document::fromLocalPath('tests/Fixtures/long-document.pdf'),
        ]),
    ],
    systemPrompts: [
        new SystemMessage('You are a legal analyst.'),
    ],
    ttl: 60
);
```

Then reference that object's name in your request using withProviderOptions:

```php
$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash-002')
    ->withProviderOptions(['cachedContentName' => $object->name])
    ->withPrompt('In no more than 100 words, what is the document about?')
    ->asText();
```

## Embeddings

You can customize your Gemini embeddings request with additional parameters using `->withProviderOptions()`.

### Title

You can add a title to your embedding request. Only applicable when TaskType is `RETRIEVAL_DOCUMENT`

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::Gemini, 'text-embedding-004')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['title' => 'Restaurant Review'])
    ->asEmbeddings();
```

### Task Type

Gemini allows you to specify the task type for your embeddings to optimize them for specific use cases:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::Gemini, 'text-embedding-004')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['taskType' => 'RETRIEVAL_QUERY'])
    ->asEmbeddings();
```

[Available task types](https://ai.google.dev/api/embeddings#tasktype)

### Output Dimensionality

You can control the dimensionality of your embeddings:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::Gemini, 'text-embedding-004')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['outputDimensionality' => 768])
    ->asEmbeddings();
```

### Thinking Mode

Gemini 2.5 series models use an internal "thinking process" during response generation. Thinking is on by default as these models have the ability to automatically decide when and how much to think based on the prompt. If you would like to customize how many tokens the model may use for thinking, or disable thinking altogether, utilize the `withProviderOptions()` method, and pass through an array with a key value pair with `thinkingBudget` and an integer representing the budget of tokens. Set this value to `0` to disable thinking.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-2.5-flash-preview')
    ->withPrompt('Explain the concept of Occam\'s Razor and provide a simple, everyday example.')
    // Set thinking budget
    ->withProviderOptions(['thinkingBudget' => 300])
    ->asText();
```

> [!NOTE]
> Do not specify a `thinkingBudget` on 2.0 or prior series Gemini models as your request will fail.

## Streaming

Gemini supports streaming responses in real-time. All the standard streaming methods work with Gemini models:

```php
return Prism::text()
    ->using('gemini', 'gemini-2.5-flash-preview')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

### Streaming with Thinking

Models with thinking capabilities stream their reasoning process separately:

```php
use Prism\Prism\Enums\StreamEventType;

foreach ($stream as $event) {
    match ($event->type()) {
        StreamEventType::ThinkingDelta => echo "[Thinking] " . $event->delta,
        StreamEventType::TextDelta => echo $event->delta,
        default => null,
    };
}
```

For complete streaming documentation, see [Streaming Output](/core-concepts/streaming-output).

## Media Support

Gemini has robust support for processing multimedia content:

### Video Analysis

Gemini can process and analyze video content including standard video files and YouTube videos. Prism implements this through the `Video` value object which maps to Gemini's video processing capabilities.

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withMessages([
        new UserMessage(
            'What is happening in this video?',
            additionalContent: [
                Video::fromUrl('https://example.com/sample-video.mp4'),
            ],
        ),
    ])
    ->asText();
```

### YouTube Integration

Gemini has special support for YouTube videos. You can easily `analyze/summarize` YouTube content by providing the URL:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withMessages([
        new UserMessage(
            'Summarize this YouTube video:',
            additionalContent: [
                Video::fromUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ'),
            ],
        ),
    ])
    ->asText();
```

### Audio Processing

Gemini can analyze audio files for various tasks like transcription, content analysis, and audio scene understanding. The implementation in Prism uses the `Audio` value object which is specifically designed for Gemini's audio processing capabilities.

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Gemini, 'gemini-1.5-flash')
    ->withMessages([
        new UserMessage(
            'Transcribe this audio file:',
            additionalContent: [
                Audio::fromLocalPath('/path/to/audio.mp3'),
            ],
        ),
    ])
    ->asText();
```

## Image Generation

Prism supports Gemini image generation through Imagen and Gemini models. See Gemini [image generation docs](https://ai.google.dev/gemini-api/docs/image-generation) for full usage.

### Supported Models

| Model                                       | Description                                        |
| ------------------------------------------- | -------------------------------------------------- |
| `gemini-2.0-flash-preview-image-generation` | Experimental gemini image generation model.        |
| `imagen-4.0-generate-001`                   | Latest Imagen model. Good for HD image generation. |
| `imagen-4.0-ultra-generate-001`             | Highest quality images, only one image per request |
| `imagen-4.0-fast-generate-001`              | Fastest Imagen 4 model                             |
| `imagen-3.0-generate-002`                   | Imagen 3                                           |

### Basic Usage

```php
$response = Prism::image()
    ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
    ->withPrompt('Generate an image of ducklings wearing rubber boots')
    ->generate();

file_put_contents('image.png', base64_decode($response->firstImage()->base64));

// gemini models return usage and metadata
echo $response->usage->promptTokens;
echo $response->meta->id;
```

### Image Editing with Gemini

```php
$originalImage = fopen('image/boots.png', 'r');

$response = Prism::image()
    ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
    ->withPrompt('Actually, could we make those boots red?')
    ->withProviderOptions([
        'image' => $originalImage,
        'image_mime_type' => 'image/png',
    ])
    ->generate();

file_put_contents('new-boots.png', base64_decode($response->firstImage()->base64));
```

### Image options for Imagen models

```php
$response = Prism::image()
    ->using(Provider::Gemini, 'imagen-4.0-generate-001')
    ->withPrompt('Generate an image of a magnificent building falling into the ocean')
    ->withProviderOptions([
        'n' => 3,                               // number of images to generate
        'size' => '2K',                         // 1K (default), 2K
        'aspect_ratio' => '16:9',               // 1:1 (default), 3:4, 4:3, 9:16, 16:9
        'person_generation' => 'dont_allow',    // dont_allow, allow_adult, allow_all
    ])
    ->generate();
```

Note:

- Imagen 4 Ultra can only generate 1 image at a time.
- An empty response is sent if the prompt is in violation of the person_generation policy, causing Prism to throw an Exception.

### Response Format

All generated images are returned as base64 encoded strings.



================================================
FILE: docs/providers/groq.md
================================================
# Groq
## Configuration

```php
'groq' => [
    'api_key' => env('GROQ_API_KEY', ''),
    'url' => env('GROQ_URL', 'https://api.groq.com/openai/v1'),
],
```

## Streaming

Groq's ultra-fast LPU architecture provides exceptional streaming performance. All standard streaming methods are supported:

```php
return Prism::text()
    ->using('groq', 'llama-3.3-70b-versatile')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

For complete streaming documentation, see [Streaming Output](/core-concepts/streaming-output).

## Audio Processing

Groq provides high-performance audio processing capabilities through their ultra-fast Language Processing Unit (LPU) architecture, enabling both text-to-speech (TTS) and speech-to-text (STT) functionality with exceptional speed and quality.

### Text-to-Speech

Groq offers PlayAI TTS models that can convert text into natural-sounding speech with support for multiple languages and voices.

#### Basic TTS Usage

```php
use Prism\Prism\Facades\Prism;

$response = Prism::audio()
    ->using('groq', 'playai-tts')
    ->withInput('Hello, welcome to our application!')
    ->withVoice('Fritz-PlayAI')
    ->asAudio();

// Save the audio file
$audioData = base64_decode($response->audio->base64);
file_put_contents('welcome.wav', $audioData);
```

#### TTS Configuration Options

Control audio format and quality:

```php
$response = Prism::audio()
    ->using('groq', 'playai-tts')
    ->withInput('Testing different audio settings.')
    ->withVoice('Celeste-PlayAI')
    ->withProviderOptions([
        'response_format' => 'wav',        // wav (default)
        'speed' => 1.2,                    // Speed: 0.5 to 5.0
        'sample_rate' => 48000,            // Sample rate options: 8000, 16000, 22050, 24000, 32000, 44100, 48000
    ])
    ->asAudio();

echo "Audio type: " . $response->audio->getMimeType();
```

#### Arabic Text-to-Speech

```php
$response = Prism::audio()
    ->using('groq', 'playai-tts-arabic')
    ->withInput('مرحبا بكم في تطبيقنا')
    ->withVoice('Amira-PlayAI')
    ->asAudio();

file_put_contents('arabic_speech.wav', base64_decode($response->audio->base64));
```

### Speech-to-Text

Groq provides ultra-fast speech recognition using Whisper models, offering exceptional speed with real-time factors of up to 299x.

#### Basic STT Usage

```php
use Prism\Prism\ValueObjects\Media\Audio;

$audioFile = Audio::fromPath('/path/to/recording.mp3');

$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->asText();

echo "Transcription: " . $response->text;
```

#### Model Selection Guide

Choose the right model for your use case:

```php
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->asText();

// For fastest English-only transcription
$response = Prism::audio()
    ->using('groq', 'distil-whisper-large-v3-en')
    ->withInput($audioFile)
    ->asText();

// For balanced speed and multilingual capability
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3-turbo')
    ->withInput($audioFile)
    ->asText();
```

#### Language Detection and Specification

Whisper can automatically detect languages or you can specify them:

```php
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->withProviderOptions([
        'language' => 'es',           // ISO-639-1 code (optional)
        'temperature' => 0.2,         // Lower for more focused results
    ])
    ->asText();
```

#### Response Formats

Get transcriptions in different formats:

```php
// Standard JSON response
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'json',  // json, text, verbose_json
    ])
    ->asText();

// Verbose JSON includes timestamps and segments
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'verbose_json',
        'timestamp_granularities' => ['segment'], // word, segment
    ])
    ->asText();

// Access detailed segment information
$segments = $response->additionalContent['segments'] ?? [];
foreach ($segments as $segment) {
    echo "Text: " . $segment['text'] . "\n";
    echo "Start: " . $segment['start'] . "s\n";
    echo "End: " . $segment['end'] . "s\n";
}
```

#### Context and Prompts

Improve transcription accuracy with context:

```php
$response = Prism::audio()
    ->using('groq', 'whisper-large-v3')
    ->withInput($audioFile)
    ->withProviderOptions([
        'prompt' => 'This is a technical discussion about machine learning and artificial intelligence.',
        'language' => 'en',
        'temperature' => 0.1,         // Lower temperature for technical content
    ])
    ->asText();
```

#### Creating Audio Objects

```php
use Prism\Prism\ValueObjects\Media\Audio;

// From local file path
$audio = Audio::fromPath('/path/to/audio.mp3');

// From remote URL (recommended for large files)
$audio = Audio::fromUrl('https://example.com/recording.wav');

// From base64 encoded data
$audio = Audio::fromBase64($base64AudioData, 'audio/mpeg');

// From binary content
$audioContent = file_get_contents('/path/to/audio.wav');
$audio = Audio::fromContent($audioContent, 'audio/wav');
```



================================================
FILE: docs/providers/mistral.md
================================================
# Mistral
## Configuration

```php
'mistral' => [
    'api_key' => env('MISTRAL_API_KEY', ''),
    'url' => env('MISTRAL_URL', 'https://api.mistral.ai/v1'),
],
```
## Provider-specific options

## Reasoning Models
### Using Reasoning Models

Simply specify a reasoning model when making your request. The thinking process is automatically included in the response:

```php
use Prism\Prism\Facades\Prism;

$response = Prism::text()
    ->using('mistral', 'magistral-medium-latest')
    ->withPrompt('What is the capital of France?')
    ->asText();

// Access the final answer
echo $response->text;
// "The capital of France is Paris."

// Access the reasoning process
echo $response->additionalContent['thinking'];
// "Okay, the user asked about the capital of France. I know that the capital of France is Paris..."
```

### Accessing Thinking Content

You can access the thinking content via the `additionalContent` property on either the Response or the relevant Step.

On the Response (easiest when not using tools):

```php
$response = Prism::text()
    ->using('mistral', 'magistral-medium-latest')
    ->withPrompt('What is the meaning of life in popular fiction?')
    ->asText();

// Get the reasoning process
$thinking = $response->additionalContent['thinking'];

// Get the final answer
$answer = $response->text;
```

On the Step (necessary when using tools, as reasoning happens before tool calls):

```php
$tools = [
    Tool::as('search')
        ->for('Search for current information')
        ->withStringParameter('query', 'The search query')
        ->using(fn (string $query): string => 'The Tigers game is at 3pm'),
];

$response = Prism::text()
    ->using('mistral', 'magistral-medium-latest')
    ->withTools($tools)
    ->withMaxSteps(3)
    ->withPrompt('What time is the Tigers game today?')
    ->asText();

// Access thinking from the first step
$thinking = $response->steps->first()->additionalContent['thinking'];
```

### Understanding the Response Structure

Reasoning models return content in a structured format with two types of blocks:

1. **Thinking blocks** - The model's internal reasoning process (stored in `additionalContent['thinking']`)
2. **Text blocks** - The final self-contained answer (stored in `text`)

Prism automatically separates these for you, making both easily accessible.

## Streaming

Mistral supports streaming responses in real-time. All standard streaming methods are supported:

```php
return Prism::text()
    ->using('mistral', 'mistral-large-latest')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

For complete streaming documentation, see [Streaming Output](/core-concepts/streaming-output).

## Audio Processing

Mistral provides advanced speech-to-text capabilities through their Voxtral models, offering state-of-the-art transcription accuracy with native multilingual support and audio understanding features.

### Speech-to-Text

Mistral's Voxtral models deliver exceptional speech recognition performance, outperforming industry standards like Whisper large-v3 across multiple languages and acoustic environments.

#### Basic STT Usage

```php
use Prism\Prism\ValueObjects\Media\Audio;

$audioFile = Audio::fromPath('/path/to/recording.mp3');

$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($audioFile)
    ->asText();

echo "Transcription: " . $response->text;
```

#### Model Selection Guide

Choose the right Voxtral model for your use case:

```php
// For production transcription with highest accuracy
$response = Prism::audio()
    ->using('mistral', 'voxtral-small-latest')
    ->withInput($audioFile)
    ->asText();

// For efficient transcription and edge deployment
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-latest')
    ->withInput($audioFile)
    ->asText();

// For optimized transcription-only service
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($audioFile)
    ->asText();
```

#### Language Detection and Specification

Voxtral automatically detects languages or you can specify them for better accuracy:

```php
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($audioFile)
    ->withProviderOptions([
        'language' => 'en',           // ISO-639-1 code (optional)
        'temperature' => 0.0,         // Lower for more deterministic results
    ])
    ->asText();

// Multilingual support - single model handles multiple languages
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($multilingualAudioFile)
    ->withProviderOptions([
        // Auto-detection works well for mixed-language content
        'temperature' => 0.1,
    ])
    ->asText();
```

#### Timestamps and Segmentation

Get detailed timing information with your transcriptions:

```php
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($audioFile)
    ->withProviderOptions([
        'timestamp_granularities' => ['segment'], // Available: word, segment
        'response_format' => 'json',
    ])
    ->asText();

// Access segment information with timestamps
$segments = $response->additionalContent['segments'] ?? [];
foreach ($segments as $segment) {
    echo "Text: " . $segment['text'] . "\n";
    echo "Start: " . $segment['start'] . "s\n";
    echo "End: " . $segment['end'] . "s\n";
}
```

#### Context and Prompts

Improve transcription accuracy with contextual information:

```php
$response = Prism::audio()
    ->using('mistral', 'voxtral-mini-2507')
    ->withInput($audioFile)
    ->withProviderOptions([
        'prompt' => 'This is a medical consultation discussing patient symptoms and treatment options.',
        'language' => 'en',
        'temperature' => 0.0,         // Deterministic for medical content
    ])
    ->asText();
```

#### Long-form Audio Processing

Voxtral handles extended audio without chunking:

```php
// Process up to 30 minutes of audio in a single request
$longAudioFile = Audio::fromPath('/path/to/long_meeting.wav');

$response = Prism::audio()
    ->using('mistral', 'voxtral-small-latest')
    ->withInput($longAudioFile)
    ->withProviderOptions([
        'timestamp_granularities' => ['segment'],
        'language' => 'en',
    ])
    ->asText();

echo "Full transcription: " . $response->text;

// Access usage information
if ($response->usage) {
    echo "Audio duration: " . $response->usage->promptTokens . " tokens\n";
    echo "Total tokens: " . $response->usage->totalTokens . "\n";
}
```

#### Creating Audio Objects

```php
use Prism\Prism\ValueObjects\Media\Audio;

// From local file path
$audio = Audio::fromPath('/path/to/audio.mp3');

// From remote URL
$audio = Audio::fromUrl('https://example.com/recording.wav');

// From base64 encoded data
$audio = Audio::fromBase64($base64AudioData, 'audio/mpeg');

// From binary content
$audioContent = file_get_contents('/path/to/audio.wav');
$audio = Audio::fromContent($audioContent, 'audio/wav');
```

## Documents
The text generation part of the exposed Facade only allows documents to be passed in through via URL.
See the [documents](./../input-modalities/documents.md) on how to do that.

## OCR
Mistral provides an OCR endpoint which can be used to extract text from documents.
This OCR endpoint can be used like this:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\Providers\Mistral\Mistral;
use Prism\Prism\Providers\Mistral\ValueObjects\OCRResponse;

/** @var Mistral $provider */
$provider = Prism::provider(\Prism\Prism\Enums\Provider::Mistral);

/** @var OCRResponse $ocrResponse */
$ocrResponse = $provider->ocr(
    'mistral-ocr-latest',
    Document::fromUrl('https://prismphp.com/storage/prism-text-generation.pdf')
);

/**
* Just need the full text of all the pages combined? Use the toText() method.
 */
$text = $ocrResponse->toText();
```
::: tip
The OCR endpoint response time can vary depending on the size of the document. We recommend doing this in the background like a queue with a longer timeout.
:::




================================================
FILE: docs/providers/ollama.md
================================================
# Ollama
## Configuration

```php
'ollama' => [
    'url' => env('OLLAMA_URL', 'http://localhost:11434/v1'),
],
```

## Ollama Options

Ollama allows you to customize how the model is run via [options](https://github.com/ollama/ollama/blob/main/docs/modelfile.md#parameter). These options can be passed via the `->withProviderOptions()` method.

```php
Prism::text() // [!code focus]
  ->using(Provider::Ollama, 'gemma3:1b')
  ->withPrompt('Who are you?')
  ->withClientOptions(['timeout' => 60])
  ->withProviderOptions([ // [!code focus]
      'top_p' => 0.9, // [!code focus]
      'num_ctx' => 4096, // [!code focus]
  ]) // [!code focus]
```

> [!NOTE]
> Using `withProviderOptions` will override settings like `topP` and `temperature`

## Streaming

Ollama supports streaming responses from your local models. All standard streaming methods are supported:

```php
return Prism::text()
    ->using('ollama', 'llama3.2')
    ->withPrompt(request('message'))
    ->withClientOptions(['timeout' => 120])
    ->asEventStreamResponse();
```

> [!TIP]
> Remember to increase the timeout for local models to prevent premature disconnection.

For complete streaming documentation, see [Streaming Output](/core-concepts/streaming-output).

## Considerations
### Timeouts

Depending on your configuration, responses tend to time out. You may need to extend the client's timeout using `->withClientOptions(['timeout' => $seconds])`.

```php
Prism::text() // [!code focus]
  ->using(Provider::Ollama, 'gemma3:1b')
  ->withPrompt('Who are you?')
  ->withClientOptions(['timeout' => 60]) // [!code focus]
```

### Structured Output

Ollama doesn't have native JSON mode or structured output like some providers, Prism implements a robust workaround for structured output:

- We automatically append instructions to your prompt that guide the model to output valid JSON matching your schema
- If the response isn't valid JSON, Prism will raise a PrismException

## Limitations
### Image URL

Ollama does not support images using `Image::fromUrl()`.

### Tool Choice

Ollama does not currently support tool choice / required tools.



================================================
FILE: docs/providers/openai.md
================================================
# OpenAI
## Configuration

```php
'openai' => [
    'url' => env('OPENAI_URL', 'https://api.openai.com/v1'),
    'api_key' => env('OPENAI_API_KEY', ''),
    'organization' => env('OPENAI_ORGANIZATION', null),
]
```

## Provider-specific options
### Strict Tool Schemas

Prism supports OpenAI's [function calling with Structured Outputs](https://platform.openai.com/docs/guides/function-calling#function-calling-with-structured-outputs) via provider-specific meta.

```php
Tool::as('search') // [!code focus]
    ->for('Searching the web')
    ->withStringParameter('query', 'the detailed search query')
    ->using(fn (): string => '[Search results]')
    ->withProviderOptions([ // [!code focus]
      'strict' => true, // [!code focus]
    ]); // [!code focus]
```

### Strict Structured Output Schemas

```php
$response = Prism::structured()
    ->withProviderOptions([ // [!code focus]
        'schema' => [ // [!code focus]
            'strict' => true // [!code focus]
        ] // [!code focus]
    ]) // [!code focus]
```

> [!WARNING]
> **All Fields Must Be Required**: When using structured outputs with OpenAI (especially in strict mode), you must include ALL fields in the `requiredFields` array. Fields that should be optional must be marked with `nullable: true` instead. This is an OpenAI API requirement and applies to all structured output requests.
>
> ```php
> new ObjectSchema(
>     name: 'user',
>     properties: [
>         new StringSchema('email', 'Email address'),
>         new StringSchema('bio', 'Optional bio', nullable: true),
>     ],
>     requiredFields: ['email', 'bio'] // ✅ All fields listed
> );
> ```
>
> For more details on required vs nullable fields, see [Schemas - Required vs Nullable Fields](/core-concepts/schemas#required-vs-nullable-fields).

### Metadata

```php
$response = Prism::structured()
    ->withProviderOptions([ // [!code focus]
        'metadata' => [ // [!code focus]
            'project_id' => 23 // [!code focus]
        ] // [!code focus]
    ]) // [!code focus]
```

### Previous Responses

Prism supports OpenAI's [conversation state](https://platform.openai.com/docs/guides/conversation-state#openai-apis-for-conversation-state) with the `previous_response_id` parameter.

```php
$response = Prism::structured()
    ->withProviderOptions([ // [!code focus]
        'previous_response_id' => 'response_id' // [!code focus]
    ]) // [!code focus]
```

### Truncation

```php
$response = Prism::structured()
    ->withProviderOptions([ // [!code focus]
        'truncation' => 'auto' // [!code focus]
    ]) // [!code focus]
```

### Service Tiers

Prism supports OpenAI's [Service Tier Configuration](https://platform.openai.com/docs/api-reference/chat/create#chat-create-service_tier) via provider-specific meta.

```php
$response = Prism::text()
    ->withProviderOptions([ // [!code focus]
        'service_tier' => 'priority' // [!code focus]
    ]) // [!code focus]
```

> [!WARNING]
> **Priority Service Tiers increase Cost**: Using priority service tier may reduce response time but increases token costs.
>
> 
### Reasoning Models

OpenAI's reasoning models like `gpt-5`, `gpt-5-mini`, and `gpt-5-nano` use advanced reasoning capabilities to think through complex problems before responding. These models excel at multi-step problem solving, coding, scientific reasoning, and complex analysis tasks.

#### Reasoning Effort

Control how much reasoning the model performs before generating a response using the `reasoning` parameter:

```php
$response = Prism::text()
    ->using('openai', 'gpt-5')
    ->withPrompt('Write a PHP function to implement a binary search algorithm with proper error handling')
    ->withProviderOptions([ // [!code focus]
        'reasoning' => ['effort' => 'high'] // [!code focus]
    ]) // [!code focus]
    ->asText();
```

Available reasoning effort levels:

- **`low`**: Faster responses with economical token usage, suitable for simpler tasks
- **`medium`**: Balanced approach between speed and reasoning depth (default)
- **`high`**: More thorough reasoning for complex problems requiring deep analysis

> [!NOTE]
> Reasoning models generate internal "reasoning tokens" that help them think through problems. These tokens are included in your usage costs but aren't visible in the response.

#### Reasoning Token Usage

You can track reasoning token usage through the response's usage information:

```php
$response = Prism::text()
    ->using('openai', 'gpt-5-mini')
    ->withPrompt('Refactor this PHP code to use dependency injection')
    ->withProviderOptions([
        'reasoning' => ['effort' => 'medium']
    ])
    ->asText();

// Access reasoning token usage
$usage = $response->firstStep()->usage;
echo "Reasoning tokens: " . $usage->thoughtTokens;
echo "Total completion tokens: " . $usage->completionTokens;
```

## Streaming

OpenAI supports streaming responses in real-time. All the standard streaming methods work with OpenAI models:

```php
// Stream events
$stream = Prism::text()
    ->using('openai', 'gpt-4o')
    ->withPrompt('Write a story')
    ->asStream();

// Server-Sent Events
return Prism::text()
    ->using('openai', 'gpt-4o')
    ->withPrompt(request('message'))
    ->asEventStreamResponse();
```

### Streaming Reasoning Models

Reasoning models like `gpt-5` stream their thinking process separately from the final answer:

```php
use Prism\Prism\Enums\StreamEventType;

foreach ($stream as $event) {
    match ($event->type()) {
        StreamEventType::ThinkingDelta => echo "[Thinking] " . $event->delta,
        StreamEventType::TextDelta => echo $event->delta,
        default => null,
    };
}
```

For complete streaming documentation including Vercel Data Protocol and WebSocket broadcasting, see [Streaming Output](/core-concepts/streaming-output).

### Caching

Automatic caching does not currently work with JsonMode. Please ensure you use StructuredMode if you wish to utilise automatic caching.

## Provider Tools

OpenAI offers built-in provider tools that can be used alongside your custom tools. These tools are executed by OpenAI's infrastructure and provide specialized capabilities. For more information about the difference between custom tools and provider tools, see [Tools & Function Calling](/core-concepts/tools-function-calling#provider-tools).

### Code Interpreter

The OpenAI code interpreter allows your AI to execute Python code in a secure, sandboxed environment. This is particularly useful for mathematical calculations, data analysis, and code execution tasks.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\ProviderTool;

Prism::text()
    ->using('openai', 'gpt-4.1')
    ->withPrompt('Solve the equation 3x + 10 = 14.')
    ->withProviderTools([
        new ProviderTool(type: 'code_interpreter', options: ['container' => ['type' => 'auto']])
    ])
    ->asText();
```

#### Configuration Options

- **container**: Configure the execution environment
  - `type`: Set to `'auto'` for automatic environment selection

## Additional Message Attributes

Adding optional parameters to a `UserMessage` like the `name` field can be done through the `additionalAttributes` parameter.

```php
Prism::text()
    ->using('openai', 'gpt-4.1')
    ->withMessages([
        new UserMessage('Who are you?', additionalAttributes: ['name' => 'TJ']),
    ])
    ->asText()
```

## Image Generation

OpenAI provides powerful image generation capabilities through multiple models. Prism supports all of OpenAI's image generation models with their full feature sets.

### Supported Models

| Model | Description |
|-------|-------------|
| `dall-e-3` | Latest DALL-E model |
| `dall-e-2` | Previous generation |
| `gpt-image-1` | GPT-based image model |

### Basic Usage

```php
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('A serene mountain landscape at sunset')
    ->generate();

$image = $response->firstImage();
echo $image->url; // Generated image URL
```

### DALL-E 3 Options

DALL-E 3 is the most advanced model with the highest quality output:

```php
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('A futuristic cityscape with flying cars')
    ->withProviderOptions([
        'size' => '1792x1024',          // 1024x1024, 1024x1792, 1792x1024
        'quality' => 'hd',              // standard, hd
        'style' => 'vivid',             // vivid, natural
    ])
    ->generate();

// DALL-E 3 automatically revises prompts for better results
if ($response->firstImage()->hasRevisedPrompt()) {
    echo "Revised prompt: " . $response->firstImage()->revisedPrompt;
}
```

### DALL-E 2 Options

DALL-E 2 supports generating multiple images and is more cost-effective:

```php
$response = Prism::image()
    ->using('openai', 'dall-e-2')
    ->withPrompt('Abstract geometric patterns')
    ->withProviderOptions([
        'n' => 4,                       // Number of images (1-10)
        'size' => '1024x1024',          // 256x256, 512x512, 1024x1024
        'response_format' => 'url',     // url only
        'user' => 'user-123',           // Optional user identifier
    ])
    ->generate();

// Process multiple images
foreach ($response->images as $image) {
    echo "Image: {$image->url}\n";
}
```

### GPT-Image-1 Options

GPT-Image-1 offers advanced features including image editing and format control:

```php
$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('A detailed architectural rendering of a modern house')
    ->withProviderOptions([
        'size' => '1536x1024',              // Various sizes supported
        'quality' => 'high',                // standard, high
        'output_format' => 'webp',          // png, webp, jpeg
        'output_compression' => 85,         // Compression level (0-100)
        'background' => 'transparent',      // transparent, white, black
        'moderation' => true,               // Enable content moderation
    ])
    ->generate();
```

### Image Editing with GPT-Image-1

GPT-Image-1 supports sophisticated image editing operations using the `withPrompt` method with Image value objects:

```php
use Prism\Prism\ValueObjects\Media\Image;

$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('Add a vaporwave sunset to the background', [
        Image::fromLocalPath('tests/Fixtures/diamond.png'),
    ])
    ->withProviderOptions([
        'size' => '1024x1024',
        'output_format' => 'png',
        'quality' => 'high',
    ])
    ->withClientOptions(['timeout' => 9999])
    ->generate();

file_put_contents('edited-image.png', base64_decode($response->firstImage()->base64));
```

#### Using Masks for Targeted Editing

For precise control over which parts of the image to edit, use a mask image:

```php
$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('Add a vaporwave sunset to the background', [
        Image::fromLocalPath('tests/Fixtures/diamond.png'),
    ])
    ->withProviderOptions([
        'mask' => Image::fromLocalPath('tests/Fixtures/diamond-mask.png'),
        'size' => '1024x1024',
        'output_format' => 'png',
        'quality' => 'high',
    ])
    ->generate();
```

#### Editing with Multiple Images

You can also edit with multiple images for more complex operations. Use the `as()` method to provide custom filenames for better readability:

```php
$response = Prism::image()
    ->using('openai', 'gpt-image-1')
    ->withPrompt('Combine these images with a futuristic theme', [
        Image::fromLocalPath('tests/Fixtures/diamond.png')->as('diamond.png'),
        Image::fromLocalPath('tests/Fixtures/sunset.png')->as('sunset-background.png'),
    ])
    ->withProviderOptions([
        'size' => '1024x1024',
        'output_format' => 'png',
        'quality' => 'high',
    ])
    ->generate();
```

### Response Format

Generated images are returned as URLs:

```php
$response = Prism::image()
    ->using('openai', 'dall-e-3')
    ->withPrompt('Digital artwork')
    ->generate();

$image = $response->firstImage();
if ($image->hasUrl()) {
    echo "<img src='{$image->url}' alt='Generated image'>";
}
```

## Audio Processing

OpenAI provides comprehensive audio processing capabilities through their TTS (Text-to-Speech) and Whisper (Speech-to-Text) models. Prism supports all of OpenAI's audio models with their full feature sets.


### Text-to-Speech

Convert text into natural-sounding speech with various voice options:

#### Basic TTS Usage

```php
use Prism\Prism\Facades\Prism;

$response = Prism::audio()
    ->using('openai', 'gpt-4o-mini-tts')
    ->withInput('Hello, welcome to our application!')
    ->withVoice('alloy')
    ->asAudio();

// Save the audio file
$audioData = base64_decode($response->audio->base64);
file_put_contents('welcome.mp3', $audioData);
```

#### High-Definition Audio

For higher quality audio output, use the model:

```php
$response = Prism::audio()
    ->using('openai', 'gpt-4o-mini-tts')
    ->withInput('This is high-quality audio generation.')
    ->withProviderOptions([
        'voice' => 'nova',
        'response_format' => 'wav',    // Higher quality format
    ])
    ->asAudio();
```

#### Audio Format Options

Control the output format and quality:

```php
$response = Prism::audio()
    ->using('openai', 'gpt-4o-mini-tts')
    ->withInput('Testing different audio formats.')
    ->withProviderOptions([
        'voice' => 'echo',
        'response_format' => 'opus',   // mp3, opus, aac, flac, wav, pcm
        'speed' => 1.25,              // Speed: 0.25 to 4.0
    ])
    ->asAudio();

echo "Audio type: " . $response->audio->getMimeType();
```

For more information on the available options, please refer to the [OpenAI API documentation](https://platform.openai.com/docs/guides/text-to-speech).

### Speech-to-Text

Convert audio files into accurate text transcriptions using Whisper:

#### Basic STT Usage

```php
use Prism\Prism\ValueObjects\Media\Audio;

$audioFile = Audio::fromPath('/path/to/recording.mp3');

$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->asText();

echo "Transcription: " . $response->text;
```
#### Language Detection

Whisper can automatically detect the language or you can specify it:

```php
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'language' => 'es',           // ISO-639-1 code (optional)
        'temperature' => 0.2,         // Lower temperature for more focused results
    ])
    ->asText();
```

#### Response Formats

Get transcriptions in different formats with varying detail levels:

```php
// Standard JSON response
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'json',  // json, text, srt, verbose_json, vtt
    ])
    ->asText();

// Verbose JSON includes timestamps and confidence scores
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'verbose_json',
    ])
    ->asText();

// Access detailed segment information
$segments = $response->additionalContent['segments'] ?? [];
foreach ($segments as $segment) {
    echo "Text: " . $segment['text'] . "\n";
    echo "Start: " . $segment['start'] . "s\n";
    echo "End: " . $segment['end'] . "s\n";
    echo "Confidence: " . ($segment['no_speech_prob'] ?? 'N/A') . "\n\n";
}
```

#### Subtitle Generation

Generate subtitle files directly:

```php
// SRT format subtitles
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'srt',
    ])
    ->asText();

file_put_contents('subtitles.srt', $response->text);

// VTT format subtitles
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'response_format' => 'vtt',
    ])
    ->asText();

file_put_contents('subtitles.vtt', $response->text);
```

#### Context and Prompts

Improve transcription accuracy with context:

```php
$response = Prism::audio()
    ->using('openai', 'whisper-1')
    ->withInput($audioFile)
    ->withProviderOptions([
        'prompt' => 'This is a technical discussion about machine learning and artificial intelligence.',
        'language' => 'en',
        'temperature' => 0.1,         // Lower temperature for technical content
    ])
    ->asText();
```

### Audio File Handling

#### Creating Audio Objects

Load audio from various sources:

```php
use Prism\Prism\ValueObjects\Media\Audio;

// From local file path
$audio = Audio::fromPath('/path/to/audio.mp3');

// From remote URL
$audio = Audio::fromUrl('https://example.com/recording.wav');

// From base64 encoded data
$audio = Audio::fromBase64($base64AudioData, 'audio/mpeg');

// From binary content
$audioContent = file_get_contents('/path/to/audio.wav');
$audio = Audio::fromContent($audioContent, 'audio/wav');
```

#### File Size Considerations

Whisper has a file size limit of 25 MB. For larger files, consider:

```php
// Check file size before processing
$audio = Audio::fromPath('/path/to/large-audio.mp3');

if ($audio->size() > 25 * 1024 * 1024) { // 25 MB
    echo "File too large for processing";
} else {
    $response = Prism::audio()
        ->using('openai', 'whisper-1')
        ->withInput($audio)
        ->asText();
}
```

For more information on the available options, please refer to the [OpenAI API documentation](https://platform.openai.com/docs/guides/speech-to-text).



================================================
FILE: docs/providers/openrouter.md
================================================
# OpenRouter

OpenRouter provides access to multiple AI models through a single API. This provider allows you to use various models from different providers through OpenRouter's routing system.

## Configuration

Add your OpenRouter configuration to `config/prism.php`:

```php
'providers' => [
    'openrouter' => [
        'api_key' => env('OPENROUTER_API_KEY'),
        'url' => env('OPENROUTER_URL', 'https://openrouter.ai/api/v1'),
        'site' => [
            'http_referer' => env('OPENROUTER_SITE_HTTP_REFERER'),
            'x_title' => env('OPENROUTER_SITE_X_TITLE'),
        ],
    ],
],
```

## Environment Variables

Set your OpenRouter API key and URL in your `.env` file:

```env
OPENROUTER_API_KEY=your_api_key_here
OPENROUTER_URL=https://openrouter.ai/api/v1
OPENROUTER_SITE_HTTP_REFERER=https://your-site.example
OPENROUTER_SITE_X_TITLE="Your Site Name"
```

## Usage

### Text Generation

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
    ->withPrompt('Tell me a story about AI.')
    ->generate();

echo $response->text;
```

### Structured Output

> [!NOTE]
> OpenRouter uses OpenAI-compatible structured outputs. For strict schema validation, the root schema should be an `ObjectSchema`.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

$schema = new ObjectSchema('person', 'Person information', [
    new StringSchema('name', 'The person\'s name'),
    new StringSchema('occupation', 'The person\'s occupation'),
]);

$response = Prism::structured()
    ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
    ->withPrompt('Generate a person profile for John Doe.')
    ->withSchema($schema)
    ->generate();

echo $response->text;
```

### Tool Calling

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Tool;

$weatherTool = Tool::as('get_weather')
    ->for('Get the current weather for a location')
    ->withStringParameter('location', 'The location to get weather for')
    ->using(function (string $location) {
        return "The weather in {$location} is sunny and 72°F";
    });

$response = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
    ->withPrompt('What is the weather like in New York?')
    ->withTools([$weatherTool])
    ->generate();

echo $response->text;
```

### Multimodal Prompts

OpenRouter keeps the OpenAI content-part schema, so you can mix text and images inside a single user turn.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

$response = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4o-mini')
    ->withPrompt('Describe the key trends in this diagram.', [
        Image::fromLocalPath('storage/charts/retention.png'),
    ])
    ->generate();

echo $response->text;
```

> [!TIP]
> `Image` value objects are serialized into the `image_url` entries that OpenRouter expects, so you can attach multiple images or pair them with plain text in the same message.

### Streaming

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\StreamEventType;

$stream = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
    ->withPrompt('Tell me a long story about AI.')
    ->asStream();

foreach ($stream as $event) {
    if ($event->type() === StreamEventType::TextDelta) {
        echo $event->delta;
    }
}
```

> [!NOTE]
> OpenRouter keeps SSE connections alive by emitting comment events such as `: OPENROUTER PROCESSING`. These lines are safe to ignore while parsing the stream.
>
> [!WARNING]
> Mid-stream failures propagate as normal SSE payloads with `error` details and `finish_reason: "error"` while the HTTP status remains 200. Make sure to inspect each chunk for an `error` field so you can surface failures to the caller and stop reading the stream.

### Streaming with Tools

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Tool;

$weatherTool = Tool::as('get_weather')
    ->for('Get the current weather for a location')
    ->withStringParameter('location', 'The location to get weather for')
    ->using(function (string $location) {
        return "The weather in {$location} is sunny and 72°F";
    });

$stream = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
    ->withPrompt('What is the weather like in multiple cities?')
    ->withTools([$weatherTool])
    ->asStream();

foreach ($stream as $event) {
    match ($event->type()) {
        StreamEventType::TextDelta => echo $event->delta,
        StreamEventType::ToolCall => echo "Tool called: {$event->toolName}\n",
        StreamEventType::ToolResult => echo "Tool result: " . json_encode($event->result) . "\n",
        default => null,
    };
}
```

### Reasoning/Thinking Tokens

Some models (like OpenAI's o1 series) support reasoning tokens that show the model's thought process:

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\StreamEventType;

$stream = Prism::text()
    ->using(Provider::OpenRouter, 'openai/o1-preview')
    ->withPrompt('Solve this complex math problem: What is the derivative of x^3 + 2x^2 - 5x + 1?')
    ->asStream();

foreach ($stream as $event) {
    if ($event->type() === StreamEventType::ThinkingDelta) {
        // This is the model's reasoning/thinking process
        echo "Thinking: " . $event->delta . "\n";
    } elseif ($event->type() === StreamEventType::TextDelta) {
        // This is the final answer
        echo $event->delta;
    }
}
```

#### Reasoning Effort

Control how much reasoning the model performs before generating a response using the `reasoning` parameter. The way this is structured depends on the underlying model you are calling:

```php
$response = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-5-mini')
    ->withPrompt('Write a PHP function to implement a binary search algorithm with proper error handling')
    ->withProviderOptions([
        'reasoning' => [
            'effort' => 'high',  // Can be "high", "medium", or "low" (OpenAI-style)
            'max_tokens' =>  2000, // Specific token limit (Gemini / Anthropic-style)
            
            // Optional: Default is false. All models support this.
            'exclude' => false, // Set to true to exclude reasoning tokens from response
            // Or enable reasoning with the default parameters:
            'enabled' => true // Default: inferred from `effort` or `max_tokens`
        ]
    ])
    ->asText();
```

### Provider Routing & Advanced Options

Use `withProviderOptions()` to forward OpenRouter-specific controls such as model preferences or sampling parameters. Prism automatically forwards the native request values for `temperature`, `top_p`, and `max_tokens`, so you can continue tuning them through the usual Prism API without duplicating them in `withProviderOptions()`. For transform pipelines, OpenRouter currently documents `"middle-out"` as the primary example—consult the parameter reference for additional context.

```php
use Prism\Prism\Facades\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::OpenRouter, 'openai/gpt-4o')
    ->withPrompt('Draft a concise product changelog entry.')
    ->withProviderOptions([
        // https://openrouter.ai/docs/model-routing
        'models' => [
            'anthropic/claude-sonnet-4.5',
            'openai/gpt-4o-mini',
        ],
        'top_k' => 40,
        // Reference: https://openrouter.ai/docs/api-reference/parameters for the full parameter list.
    ])
    ->generate();

echo $response->text;
```

> [!IMPORTANT]
> The values you supply here are passed directly to OpenRouter. Consult the [Parameters reference](https://openrouter.ai/docs/api-reference/parameters) and [Provider Routing guide](https://openrouter.ai/docs/provider-routing) for the full list of supported keys.

The single `model` parameter and the fallback `models` array work together. When both are present, OpenRouter first tries the `model` value, then walks the `models` list in order—exactly as outlined in the [Model Routing guide](https://openrouter.ai/docs/features/model-routing). Fallbacks trigger for moderation flags, context-length errors, rate limits, or provider downtime, and the final `model` field in the response reveals which entry actually served the request (and therefore which pricing tier applies). If you prefer OpenRouter to choose the initial model, set `model` to `openrouter/auto` and still supply a `models` array for explicit overrides when needed. Because metadata is centralized, you can double-check `supported_parameters`, context length, and per-request limits via the [Models API](https://openrouter.ai/docs/overview/models) before rolling out changes.

## Available Models

OpenRouter supports many models from different providers. The [Models API](https://openrouter.ai/docs/overview/models) returns structured metadata—`supported_parameters`, context length, pricing, and more—so you can verify capabilities programmatically before issuing requests. Some popular options include:

- `x-ai/grok-code-fast-1`
- `anthropic/claude-sonnet-4.5`
- `google/gemini-2.5-flash`
- `deepseek/deepseek-chat-v3-0324`
- `z-ai/glm-4.6`
- `tngtech/deepseek-r1t2-chimera:free`
- `qwen/qwen3-coder-30b-a3b-instruct`
- `mistralai/mistral-nemo`

Visit [OpenRouter's models page](https://openrouter.ai/models) for a complete list of available models.

## Features

- ✅ Text Generation
- ✅ Structured Output
- ✅ Tool Calling
- ✅ Multiple Model Support
- ✅ Provider Routing
- ✅ Streaming
- ✅ Reasoning/Thinking Tokens (for compatible models)
- ❌ Embeddings (not yet implemented)
- ❌ Image Generation (not yet implemented)

## API Reference

For detailed API documentation, visit [OpenRouter's API documentation](https://openrouter.ai/docs/api-reference/chat-completion).

## Error Handling

The OpenRouter provider includes standard error handling for common issues:

- Rate limiting
- Request too large
- Provider overload
- Invalid API key

Errors are automatically mapped to appropriate Prism exceptions for consistent error handling across all providers. 



================================================
FILE: docs/providers/providers.md.template
================================================
# Provider
## Configuration

```php
```

## Provider-specific Settings
## Considerations
## Provider-specific options
## Limitations



================================================
FILE: docs/providers/voyageai.md
================================================
# Voyage AI
## Configuration

```php
'voyageai' => [
    'api_key' => env('VOYAGEAI_API_KEY', ''),
    'url' => env('VOYAGEAI_URL', 'https://api.voyageai.com/v1'),
],
```

## Provider specific options

You can change some options on your request specific to Voyage AI by using `->withProviderOptions()`.

### Input type

By default, Voyage AI generates general purpose vectors.

However, they taylor your vectors for the task they are intended for - for search ("query") or for retrieval ("document"):

For search / querying:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::VoyageAI, 'voyage-3-lite')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['inputType' => 'query'])
    ->asEmbeddings();
```

For document retrieval:

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::VoyageAI, 'voyage-3-lite')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['inputType' => 'document'])
    ->asEmbeddings();
```

### Truncation

By default, Voyage AI truncates inputs that are over the context length.

You can force it to throw an error instead by setting truncation to false.

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

Prism::embeddings()
    ->using(Provider::VoyageAI, 'voyage-3-lite')
    ->fromInput('The food was delicious and the waiter...')
    ->withProviderOptions(['truncation' => false])
    ->asEmbeddings();
```



================================================
FILE: docs/providers/xai.md
================================================
# xAI
## Configuration

```php
'xai' => [
    'api_key' => env('XAI_API_KEY', ''),
    'url' => env('XAI_URL', 'https://api.x.ai/v1'),
],
```

## Provider-specific options

### Extended Thinking/Reasoning

xAI's Grok models support an optional extended thinking mode, where the model will reason through problems before returning its answer. This is particularly useful for complex mathematical problems, logical reasoning, and detailed analysis tasks.

#### Enabling thinking mode

```php
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withPrompt('Solve this complex equation: 3x² + 5x - 2 = 0')
    ->withProviderOptions([
        'thinking' => ['enabled' => true]
    ])
    ->asText();
```

Thinking content is automatically extracted when present in the response and can be accessed through streaming events.
If you prefer not to process thinking content, you can disable it. Set the `thinking` option to `false`.

#### Streaming thinking content

When using streaming, thinking content is yielded as separate events:

```php
use Prism\Prism\Enums\StreamEventType;

$stream = Prism::text()
	->using(Provider::XAI, 'grok-4')
	->withPrompt('Explain quantum entanglement in detail')
	->asStream();

foreach ($stream as $event) {
	if ($event->type() === StreamEventType::ThinkingDelta) {
		echo $event->delta . PHP_EOL; // Outputs: Thinking...
	} elseif ($event->type() === StreamEventType::TextDelta) {
		echo $event->delta;
	}
}
```

### Structured Output

xAI supports structured output through JSON schema validation. The following models support structured output:

> [!NOTE]
> xAI uses an OpenAI-compatible API. For strict schema validation, the root schema should be an `ObjectSchema`.

- `grok-3`
- `grok-4`

```php
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Schema\BooleanSchema;

$schema = new ObjectSchema(
    'weather_report',
    'Weather forecast with recommendations',
    [
        new StringSchema('forecast', 'The weather forecast'),
        new StringSchema('clothing', 'Clothing recommendation'),
        new BooleanSchema('coat_required', 'Whether a coat is needed'),
    ],
    ['forecast', 'clothing', 'coat_required']
);

$response = Prism::structured()
    ->withSchema($schema)
    ->using(Provider::XAI, 'grok-4')
    ->withPrompt('What\'s the weather like in Detroit and should I wear a coat?')
    ->asStructured();

// Access structured data
echo $response->structured['forecast']; // "75° and sunny"
echo $response->structured['coat_required']; // false
```

#### Strict schema mode

Enable strict schema validation for more reliable structured output:

```php
$response = Prism::structured()
    ->withSchema($schema)
    ->using(Provider::XAI, 'grok-4')
    ->withProviderOptions([
        'schema' => ['strict' => true]
    ])
    ->withPrompt('Analyze this data')
    ->asStructured();
```

### Tool Calling

xAI supports function calling with tools. Tools can be used alongside thinking mode for complex problem-solving scenarios.

```php
use Prism\Prism\Facades\Tool;

$tools = [
    Tool::as('calculator')
        ->for('Perform mathematical calculations')
        ->withStringParameter('expression', 'Mathematical expression to calculate')
        ->using(fn (string $expression): string => "Result: " . eval("return $expression;")),
        
    Tool::as('weather')
        ->for('Get current weather information')
        ->withStringParameter('city', 'City name')
        ->using(fn (string $city): string => "Weather in {$city}: 72°F and sunny"),
];

$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withTools($tools)
    ->withMaxSteps(3)
    ->withPrompt('Calculate 15 * 23 and tell me the weather in Detroit')
    ->asText();
```

### Model Parameters

#### Temperature Control

Control the randomness of responses:

```php
$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withTemperature(0.7) // 0.0 = deterministic, 1.0 = very creative
    ->withPrompt('Write a creative story')
    ->asText();
```

#### Top-P Sampling

Control nucleus sampling:

```php
$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withTopP(0.9) // Consider top 90% probability mass
    ->withPrompt('Generate diverse responses')
    ->asText();
```

#### Token Limits

Set maximum output tokens:

```php
$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withMaxTokens(1000)
    ->withPrompt('Write a detailed explanation')
    ->asText();
```

## Advanced Examples

### Complex Analysis with Thinking

```php
$response = Prism::text()
    ->using(Provider::XAI, 'grok-4')
    ->withPrompt('
        Analyze the economic implications of implementing a universal basic income program.
        Consider both potential benefits and drawbacks, and provide specific examples.
    ')
    ->asStream();

$analysis = '';
$reasoning = '';

foreach ($response as $chunk) {
    if ($chunk->chunkType === ChunkType::Thinking) {
        $reasoning .= $chunk->text;
    } else {
        $analysis .= $chunk->text;
        echo $chunk->text; // Stream to user
    }
}

// Save the reasoning process for later review
file_put_contents('analysis_reasoning.txt', $reasoning);
```

### Structured Data Extraction

```php
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\IntegerSchema;
use Prism\Prism\Schema\NumberSchema;

$schema = new ObjectSchema(
    'financial_analysis',
    'Complete financial analysis result',
    [
        new StringSchema('summary', 'Executive summary'),
        new NumberSchema('total_revenue', 'Total revenue amount'),
        new NumberSchema('profit_margin', 'Profit margin percentage'),
        new ArraySchema('recommendations', 'List of recommendations', 
            new StringSchema('recommendation', 'Individual recommendation')
        ),
        new ObjectSchema('risk_assessment', 'Risk analysis', [
            new StringSchema('level', 'Risk level (low/medium/high)'),
            new IntegerSchema('score', 'Risk score from 1-10'),
        ], ['level', 'score']),
    ],
    ['summary', 'total_revenue', 'profit_margin', 'recommendations', 'risk_assessment']
);

$response = Prism::structured()
    ->withSchema($schema)
    ->using(Provider::XAI, 'grok-4')
    ->withPrompt('
        Analyze this financial data: 
        Q1 Revenue: $1.2M, Q1 Costs: $800K
        Q2 Revenue: $1.5M, Q2 Costs: $900K
        Provide a complete analysis with recommendations.
    ')
    ->asStructured();

$analysis = $response->structured;
echo "Revenue: $" . number_format($analysis['total_revenue']);
echo "Risk Level: " . $analysis['risk_assessment']['level'];
```

### Model Validation

Structured output is only supported on specific models. Prism will throw an exception for unsupported models:

```php
use Prism\Prism\Exceptions\PrismException;

try {
    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::XAI, 'unsupported-model')
        ->asStructured();
} catch (PrismException $e) {
    // Handle unsupported model error
    echo "Error: " . $e->getMessage();
}
```

## Considerations

### Thinking Content Processing

- Thinking content is automatically filtered to remove repetitive "Thinking..." patterns
- Only meaningful reasoning content is yielded in thinking chunks
- Thinking content appears before regular response content in streams
- Thinking can be disabled if not needed to reduce processing overhead

### API Compatibility

xAI uses an OpenAI-compatible API structure, which means:
- Request/response formats are similar to OpenAI
- Tool calling follows OpenAI's function calling specification
- Structured output uses JSON schema format
- Streaming follows server-sent events (SSE) format

### Token Management

- Thinking tokens count toward your total token usage
- Set appropriate `maxTokens` limits when expecting long thinking sequences
- Monitor usage through the response objects for cost tracking



================================================
FILE: docs/public/assets/prism-logo.webp
================================================
[Binary file]


================================================
FILE: docs/.vitepress/config.mts
================================================
import { defineConfig } from "vitepress";
import llmstxt from "vitepress-plugin-llms";

// https://vitepress.dev/reference/site-config
export default defineConfig({
  title: "Prism",
  head: [
    [
      "link",
      {
        rel: "icon",
        href: "/favicon.ico",
      },
    ],
    [
      "script",
      {
        src: "https://cdn.tailwindcss.com",
      },
    ],
    [
      "script",
      {
        defer: "",
        src: "https://analytics.echolabs.dev/script.js",
        "data-website-id": "38989bda-90b5-47af-81ab-57a823480b9e",
      },
    ],
    // OpenGraph / Facebook
    ["meta", { property: "og:type", content: "website" }],
    ["meta", { property: "og:url", content: "https://prismphp.com" }],
    ["meta", { property: "og:title", content: "Prism" }],
    [
      "meta",
      {
        property: "og:description",
        content:
          "Prism is a powerful Laravel package for integrating Large Language Models (LLMs) into your applications.",
      },
    ],
    [
      "meta",
      {
        property: "og:image",
        content: "https://prismphp.com/assets/og-image.png?v=3",
      },
    ],

    // Twitter
    ["meta", { name: "twitter:card", content: "summary_large_image" }],
    ["meta", { property: "twitter:domain", content: "prism.echolabs.dev" }],
    ["meta", { property: "twitter:url", content: "https://prismphp.com" }],
    ["meta", { name: "twitter:title", content: "Prism" }],
    [
      "meta",
      {
        name: "twitter:description",
        content:
          "Prism is a powerful Laravel package for integrating Large Language Models (LLMs) into your applications.",
      },
    ],
    [
      "meta",
      {
        name: "twitter:image",
        content: "https://prismphp.com/assets/og-image.png?v=3",
      },
    ],
  ],
  srcExclude: ["**/README.md", "documentation-style-guide.md"],
  description:
    "Prism is a powerful Laravel package for integrating Large Language Models (LLMs) into your applications.",
  themeConfig: {
    // https://vitepress.dev/reference/default-theme-config
    nav: [
      { text: "Home", link: "/" },
      { text: "Docs", link: "/getting-started/introduction" },
      { text: "Sponsor", link: "https://github.com/sponsors/sixlive" },
    ],

    sidebar: [
      {
        items: [
          {
            text: "Getting Started",
            items: [
              {
                text: "Introduction",
                link: "/getting-started/introduction",
              },
              {
                text: "Installation",
                link: "/getting-started/installation",
              },
              {
                text: "Configuration",
                link: "/getting-started/configuration",
              },
            ],
          },
          {
            text: "Core Concepts",
            items: [
              {
                text: "Text Generation",
                link: "/core-concepts/text-generation",
              },
              {
                text: "Streaming Output",
                link: "/core-concepts/streaming-output",
              },
              {
                text: "Tool & Function Calling",
                link: "/core-concepts/tools-function-calling",
              },
              {
                text: "Structured Output",
                link: "/core-concepts/structured-output",
              },
              {
                text: "Embeddings",
                link: "/core-concepts/embeddings",
              },
              {
                text: "Image Generation",
                link: "/core-concepts/image-generation",
              },
              {
                text: "Audio",
                link: "/core-concepts/audio",
              },
              {
                text: "Schemas",
                link: "/core-concepts/schemas",
              },
              {
                text: "Prism Server",
                link: "/core-concepts/prism-server",
              },
              {
                text: "Testing",
                link: "/core-concepts/testing",
              },
            ],
          },
          {
            text: "Input modalities",
            items: [
              {
                text: "Images",
                link: "/input-modalities/images",
              },
              {
                text: "Documents",
                link: "/input-modalities/documents",
              },
              {
                text: "Audio",
                link: "/input-modalities/audio",
              },
              {
                text: "Video",
                link: "/input-modalities/video",
              },
            ],
          },
          {
            text: "Providers",
            items: [
              {
                text: "Anthropic",
                link: "/providers/anthropic",
              },
              {
                text: "Bedrock",
                link: "https://github.com/prism-php/bedrock",
              },
              {
                text: "DeepSeek",
                link: "/providers/deepseek",
              },
              {
                text: "ElevenLabs",
                link: "/providers/elevenlabs",
              },
              {
                text: "Groq",
                link: "/providers/groq",
              },
              {
                text: "Gemini",
                link: "/providers/gemini",
              },
              {
                text: "Mistral",
                link: "/providers/mistral",
              },
              {
                text: "Ollama",
                link: "/providers/ollama",
              },
              {
                text: "OpenAI",
                link: "/providers/openai",
              },
              {
                text: "Voyage AI",
                link: "/providers/voyageai",
              },
              {
                text: "XAI",
                link: "/providers/xai",
              },
            ],
          },
          {
            text: "Advanced",
            items: [
              {
                text: "Error Handling",
                link: "/advanced/error-handling",
              },
              {
                text: "Custom Providers",
                link: "/advanced/custom-providers",
              },
              {
                text: "Handling Rate Limits",
                link: "/advanced/rate-limits",
              },
              {
                text: "Provider Interoperability",
                link: "/advanced/provider-interoperability",
              },
            ],
          },
          {
            text: "Packages",
            items: [
              {
                text: "Relay",
                link: "https://github.com/prism-php/relay",
              },
              {
                text: "Bedrock",
                link: "https://github.com/prism-php/bedrock",
              },
            ],
          },
        ],
      },
    ],

    search: {
      provider: "local",
    },

    socialLinks: [
      { icon: "github", link: "https://github.com/echolabsdev/prism" },
    ],
    footer: {
      message: "Released under the MIT License.",
      copyright: "Copyright © 2024-present TJ Miller",
    },
  },
  vite: {
    plugins: [llmstxt()],
  },
});



================================================
FILE: docs/.vitepress/theme/custom.css
================================================
/* Vaporwave Theme for Prism PHP Documentation */

:root {
  /* Light mode colors */
  --vp-c-brand-1: #ff71ce;
  --vp-c-brand-2: #b967ff;
  --vp-c-brand-3: #01cdfe;

  /* Base */
  --vp-c-bg: #f8f9fc;
  --vp-c-bg-soft: #f0f3f9;
  --vp-c-bg-mute: #e7ecf5;

  /* Borders */
  --vp-c-border: #e5e9f0;
  --vp-c-divider: #e5e9f0;

  /* Text */
  --vp-c-text-1: #2e3440;
  --vp-c-text-2: #434c5e;
  --vp-c-text-3: #4c566a;

  /* Code blocks */
  --vp-code-block-bg: #f0f3f9;

  /* Button */
  --vp-button-brand-bg: var(--vp-c-brand-1);
  --vp-button-brand-hover-bg: var(--vp-c-brand-2);
  --vp-button-brand-active-bg: var(--vp-c-brand-3);

  /* Custom vaporwave gradients */
  --vaporwave-gradient-1: linear-gradient(90deg, #ff71ce, #b967ff);
  --vaporwave-gradient-2: linear-gradient(90deg, #01cdfe, #05ffa1);

  /* Banner/Image */
  --vp-home-hero-image-background-image: linear-gradient(325deg, var(--vp-c-brand-1) 50%, #01cdfe 50%);
  --vp-home-hero-image-filter: blur(71px);
}

.dark {
  /* Dark mode colors */
  --vp-c-brand-1: #ff71ce;
  --vp-c-brand-2: #b967ff;
  --vp-c-brand-3: #01cdfe;

  /* Base */
  --vp-c-bg: #191b28;
  --vp-c-bg-soft: #222436;
  --vp-c-bg-mute: #2a2d45;

  /* Borders */
  --vp-c-border: #373a54;
  --vp-c-divider: #373a54;

  /* Text */
  --vp-c-text-1: #e4e9f7;
  --vp-c-text-2: #c7d0e2;
  --vp-c-text-3: #a3b0cc;

  /* Code blocks */
  --vp-code-block-bg: #222436;

  /* Button */
  --vp-button-brand-bg: var(--vp-c-brand-1);
  --vp-button-brand-hover-bg: var(--vp-c-brand-2);
  --vp-button-brand-active-bg: var(--vp-c-brand-3);

  /* Custom dark mode styling */
  --vp-c-glow: rgba(255, 113, 206, 0.15);
}

/* Custom Vaporwave Styling */

/* Header styling */
.VPNav {
  background-color: var(--vp-c-bg);
  box-shadow: 0 2px 12px 0 rgba(185, 103, 255, 0.1);
}

/* Brand name with gradient */
.VPNavBarTitle .title {
  background: var(--vaporwave-gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: bold;
  text-shadow: 0 0 8px rgba(255, 113, 206, 0.3);
  letter-spacing: 1px;
}

/* Logo animation */
.VPNavBarTitle .logo {
  transition: all 0.3s ease;
}

.VPNavBarTitle:hover .logo {
  filter: drop-shadow(0 0 8px rgba(255, 113, 206, 0.5));
  transform: rotate(-5deg) scale(1.1);
}

/* Links with hover effects */
.VPLink:hover {
  color: var(--vp-c-brand-1);
  text-shadow: 0 0 8px rgba(255, 113, 206, 0.5);
  transition: all 0.3s ease;
}

/* Disable hover effects for feature links on home page */
.VPLink.no-icon.VPFeature:hover {
  color: inherit;
  text-shadow: none;
}

/* Feature titles with gradient */
.VPFeature .title {
  background: var(--vaporwave-gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: inline-block;
}

/* Special styling for sidebar */
.VPSidebar {
  background-color: var(--vp-c-bg) !important;
}

/* Sidebar elements */
.VPSidebarNav {
  background-color: var(--vp-c-bg) !important;
}

.VPSidebarItem .text,
.VPSidebarItem .link {
  color: var(--vp-c-text-2);
}

/* Active sidebar item with gradient and glow */
.VPSidebarItem.is-active .link {
  color: var(--vp-c-brand-1) !important;
  font-weight: 600;
}

/* Buttons with hover glow effect */
.VPButton.brand {
  transition: all 0.3s ease;
}

.VPButton.brand:hover {
  box-shadow: 0 0 12px rgba(255, 113, 206, 0.7);
  transform: translateY(-1px);
}

/* Code blocks with custom styling */
div[class*="language-"] {
  border: 1px solid var(--vp-c-divider);
  border-radius: 8px;
  overflow: hidden;
}

/* Home hero section with retro feel */
.VPHero .name,
.VPHero .text {
  background: var(--vaporwave-gradient-2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.VPHero.has-image.VPHomeHero .image-bg {
  width: 372px;
	height: 182px;
}

.VPHero.has-image.VPHomeHero .VPImage {
  filter: drop-shadow(-4px 8px 7px #0003);
  transition: all 0.3s ease;
}

.VPHero.has-image.VPHomeHero .image-container:hover .VPImage {
  filter: drop-shadow(-4px 8px 7px rgba(255, 113, 206, 0.5));
}

/* Main content area styling */
.VPContent {
  background-color: var(--vp-c-bg);
}

.VPDoc {
  background-color: var(--vp-c-bg);
}

/* Footer styling */
.VPFooter {
  background-color: var(--vp-c-bg-soft);
  border-top: none !important;
}

/* Header anchors with vaporwave color */
.header-anchor:hover {
  color: var(--vp-c-brand-1);
}

/* Tables with soft grid styling */
.vp-doc table {
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(185, 103, 255, 0.1);
}

.vp-doc th {
  background-color: var(--vp-c-bg-soft);
  border-bottom: 2px solid var(--vp-c-border);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: var(--vp-c-bg-soft);
}

::-webkit-scrollbar-thumb {
  background-image: var(--vaporwave-gradient-1);
  border-radius: 5px;
}

/* Removed page decorations */

/* Code block enhancements */
div[class*="language-"] {
  box-shadow: 0 3px 15px rgba(185, 103, 255, 0.1);
  border-radius: 8px;
  margin: 1.5rem 0;
}

.dark div[class*="language-"] {
  box-shadow: 0 3px 15px rgba(255, 113, 206, 0.1);
}

/* Headings with subtle gradient */
.vp-doc h1,
.vp-doc h2 {
  background: var(--vaporwave-gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.vp-doc h3,
.vp-doc h4 {
  color: var(--vp-c-brand-1);
}

/* Custom blockquote */
.vp-doc blockquote {
  border-left: 3px solid var(--vp-c-brand-2);
  background-color: rgba(185, 103, 255, 0.05);
  border-radius: 0 8px 8px 0;
  padding: 16px 24px;
}

/* Mobile responsiveness fixes - removing custom mobile sizing */
@media (max-width: 768px) {
  .VPContent::before,
  .VPContent::after {
    display: none;
  }
}

.VPNavBarTitle.has-sidebar .title {
  border-bottom: none;
}

.VPNav .divider {
  display: none !important;
}

.VPLocalNav {
  border-bottom: none !important;
}



================================================
FILE: docs/.vitepress/theme/HostedFooter.vue
================================================
<template>
  <div>
    <a href="https://sevalla.com/">
      <img class="m-auto max-w-32 pb-4" src="/assets/hosted-on-sevalla.png" />
    </a>
  </div>
</template>

<script>
export default {
  name: "Footer",
  data() {
    return {};
  },
  props: {},
  computed: {},
  methods: {},
  mounted() {},
};
</script>

<style scoped></style>



================================================
FILE: docs/.vitepress/theme/index.js
================================================
import { h } from "vue";
import DefaultTheme from "vitepress/theme";
import HostedFooter from "./HostedFooter.vue";
import "./custom.css";

export default {
  extends: DefaultTheme,
  Layout() {
    return h(DefaultTheme.Layout, null, {
      "layout-bottom": () => h(HostedFooter),
    });
  },
};



================================================
FILE: resources/boost/guidelines/core.blade.php
================================================
## Prism

- Prism is a Laravel package for integrating Large Language Models (LLMs) into applications with a fluent, expressive and eloquent API.
- Prism supports multiple AI providers: OpenAI, Anthropic, Ollama, Mistral, Groq, XAI, Gemini, VoyageAI, ElevenLabs, DeepSeek, and OpenRouter, Amazon Bedrock.
- Always use the `Prism` facade, class, or `prism()` helper function for all LLM interactions.
- Prism documentation follows the `llms.txt` format for its docs website and its hosted at `https://prismphp.com/**`
- **Before implementing any features using Prism, use the `web-search` tool to get the latest docs for that specific feature. The docs listing is available in <available-docs>**

### Basic Usage Patterns
- Use `Prism::text()` for text generation, `Prism::structured()` for structured output, `Prism::embeddings()` for embeddings, `Prism::image()` for image generation, and `Prism::audio()` for audio processing.
- Always chain the `using()` method to specify provider and model before generating responses.
- Use `asText()`, `asStructured()`, `asStream()`, `asEmbeddings()`, etc. to finalize the request based on the desired response type.
- You can also use the fluent `prism()` helper function as an alternative to the Prism facade.

<available-docs>
## Getting Started
- [**/getting-started/introduction.md] Use these docs for comprehensive introduction to Prism package, overview of architecture, list of all supported LLM providers (OpenAI, Anthropic, Gemini, etc.), and understanding the core philosophy behind Prism's unified API design
- [**/getting-started/installation.md] Use these docs for step-by-step installation instructions via Composer, package registration, publishing config files, and initial setup requirements including PHP version compatibility
- [**/getting-started/configuration.md] Use these docs for detailed configuration guide including environment variables, API keys setup for each provider, config file structure, default provider selection, and Laravel integration options

## Core Concepts
- [**/core-concepts/text-generation.md] Use these docs for complete guide to text generation including basic usage patterns, the fluent API, provider/model selection, prompt engineering, max tokens configuration, temperature settings, and response handling
- [**/core-concepts/streaming-output.md] Use these docs for streaming responses in real-time, handling chunked output, streaming event types, and streaming response types
- [**/core-concepts/tools-function-calling.md] Use these docs for comprehensive tool/function calling functionality, defining tools with JSON schemas, registering handler functions, multi-step tool execution, error handling in tools, and provider-specific tool calling capabilities
- [**/core-concepts/structured-output.md] Use these docs for generating structured JSON output, defining schemas and handling structured responses across different providers
- [**/core-concepts/embeddings.md] Use these docs for creating vector embeddings from text and documents, choosing embedding models, and use cases like semantic search and similarity matching
- [**/core-concepts/image-generation.md] Use these docs for generating images from text prompts, configuring image size and quality, working with different image models and handling image responses
- [**/core-concepts/audio.md] Use these docs for audio processing including text-to-speech (TTS) synthesis, speech-to-text (STT) transcription, voice selection, audio format options, and handling audio files
- [**/core-concepts/schemas.md] Use these docs for defining and working with schemas for structured output, JSON schema specifications
- [**/core-concepts/prism-server.md] Use these docs for setting up and using Prism Server, Prism Server is a powerful feature that allows you to expose your Prism-powered AI models through a standardized API.
- [**/core-concepts/testing.md] Use these docs for testing Prism integrations avoiding real API calls in tests, and assertion helpers

## Input Modalities
- [**/input-modalities/images.md] Use these docs for passing images as input to LLMs, supporting multiple image formats
- [**/input-modalities/documents.md] Use these docs for processing documents (PDFs, Word docs, etc.) as input, document parsing and text extraction
- [**/input-modalities/audio.md] Use these docs for using audio files as input, audio transcription to text, supported audio formats
- [**/input-modalities/video.md] Use these docs for working with video input for supporting providers.

## Providers
- [**/providers/anthropic.md] Use these docs for Anthropic (Claude) provider and provider-specific parameters
- [**/providers/deepseek.md] Use these docs for DeepSeek provider and provider-specific parameters
- [**/providers/elevenlabs.md] Use these docs for ElevenLabs text-to-speech provider and provider-specific parameters
- [**/providers/gemini.md] Use these docs for Google Gemini provider and provider-specific parameters
- [**/providers/groq.md] Use these docs for Groq provider setup and provider-specific parameters
- [**/providers/mistral.md] Use these docs for Mistral AI provider and provider-specific parameters
- [**/providers/ollama.md] Use these docs for Ollama local LLM provider and provider-specific parameters
- [**/providers/openai.md] Use these docs for OpenAI provider and provider-specific parameters
- [**/providers/openrouter.md] Use these docs for OpenRouter provider and provider-specific parameters
- [**/providers/voyageai.md] Use these docs for VoyageAI embeddings provider and provider-specific parameters
- [**/providers/xai.md] Use these docs for XAI (Grok) provider and provider-specific parameters

## Advanced
- [**/advanced/error-handling.md] Use these docs for error handling strategies,
- [**/advanced/custom-providers.md] Use these docs for creating custom provider implementations, extending the Provider base class, implementing required methods (text, stream, structured, embeddings)
- [**/advanced/rate-limits.md] Use these docs for managing API rate limits across providers.
- [**/advanced/provider-interoperability.md] Use these docs for switching between providers seamlessly, writing provider-agnostic code
</available-docs>

#### Prism Replay (Model Context Protocol Integration) (https://github.com/prism-php/replay)

#### Prism Bedrock (AWS Bedrock Provider) (https://github.com/prism-php/bedrock)



================================================
FILE: src/helpers.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Support\Facades\App;
use Prism\Prism\Prism;

if (! function_exists('prism')) {

    /**
     * A fluent helper function to resolve prism from
     * the application container.
     */
    function prism(): Prism
    {
        return App::make(Prism::class);
    }
}



================================================
FILE: src/Prism.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism;

use Prism\Prism\Audio\PendingRequest as PendingAudioRequest;
use Prism\Prism\Embeddings\PendingRequest as PendingEmbeddingRequest;
use Prism\Prism\Images\PendingRequest as PendingImageRequest;
use Prism\Prism\Structured\PendingRequest as PendingStructuredRequest;
use Prism\Prism\Text\PendingRequest as PendingTextRequest;

class Prism
{
    public function text(): PendingTextRequest
    {
        return new PendingTextRequest;
    }

    public function structured(): PendingStructuredRequest
    {
        return new PendingStructuredRequest;
    }

    public function embeddings(): PendingEmbeddingRequest
    {
        return new PendingEmbeddingRequest;
    }

    public function image(): PendingImageRequest
    {
        return new PendingImageRequest;
    }

    public function audio(): PendingAudioRequest
    {
        return new PendingAudioRequest;
    }
}



================================================
FILE: src/PrismManager.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism;

use Closure;
use Illuminate\Contracts\Foundation\Application;
use InvalidArgumentException;
use Prism\Prism\Enums\Provider as ProviderEnum;
use Prism\Prism\Providers\Anthropic\Anthropic;
use Prism\Prism\Providers\DeepSeek\DeepSeek;
use Prism\Prism\Providers\ElevenLabs\ElevenLabs;
use Prism\Prism\Providers\Gemini\Gemini;
use Prism\Prism\Providers\Groq\Groq;
use Prism\Prism\Providers\Mistral\Mistral;
use Prism\Prism\Providers\Ollama\Ollama;
use Prism\Prism\Providers\OpenAI\OpenAI;
use Prism\Prism\Providers\OpenRouter\OpenRouter;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Providers\VoyageAI\VoyageAI;
use Prism\Prism\Providers\XAI\XAI;
use RuntimeException;

class PrismManager
{
    /** @var array<string, Closure> */
    protected array $customCreators = [];

    public function __construct(
        protected Application $app
    ) {}

    /**
     * @param  array<string, mixed>  $providerConfig
     *
     * @throws InvalidArgumentException
     */
    public function resolve(ProviderEnum|string $name, array $providerConfig = []): Provider
    {
        $name = $this->resolveName($name);

        $config = array_merge($this->getConfig($name), $providerConfig);

        if (isset($this->customCreators[$name])) {
            return $this->callCustomCreator($name, $config);
        }

        $factory = sprintf('create%sProvider', ucfirst($name));

        if (method_exists($this, $factory)) {
            return $this->{$factory}($config);
        }

        throw new InvalidArgumentException("Provider [{$name}] is not supported.");
    }

    /**
     * @throws RuntimeException
     */
    public function extend(string $provider, Closure $callback): self
    {
        if (($callback = $callback->bindTo($this, $this)) instanceof Closure) {
            $this->customCreators[$provider] = $callback;

            return $this;
        }

        throw new RuntimeException(
            sprintf('Couldn\'t bind %s', $provider)
        );
    }

    protected function resolveName(ProviderEnum|string $name): string
    {
        if ($name instanceof ProviderEnum) {
            $name = $name->value;
        }

        return strtolower($name);
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createOpenaiProvider(array $config): OpenAI
    {
        return new OpenAI(
            apiKey: $config['api_key'] ?? '',
            url: $config['url'],
            organization: $config['organization'] ?? null,
            project: $config['project'] ?? null,
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createOllamaProvider(array $config): Ollama
    {
        return new Ollama(
            apiKey: $config['api_key'] ?? '',
            url: $config['url'],
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createMistralProvider(array $config): Mistral
    {
        return new Mistral(
            apiKey: $config['api_key'],
            url: $config['url'],
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createAnthropicProvider(array $config): Anthropic
    {
        return new Anthropic(
            $config['api_key'],
            $config['version'],
            $config['anthropic_beta'] ?? null
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createDeepseekProvider(array $config): DeepSeek
    {
        return new DeepSeek(
            apiKey: $config['api_key'] ?? '',
            url: $config['url'] ?? '',
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createVoyageaiProvider(array $config): VoyageAI
    {
        return new VoyageAI(
            apiKey: $config['api_key'] ?? '',
            baseUrl: $config['url'] ?? ''
        );
    }

    /**
     * @param  array<string, mixed>  $config
     */
    protected function callCustomCreator(string $provider, array $config): Provider
    {
        return $this->customCreators[$provider]($this->app, $config);
    }

    /**
     * @return array<string, mixed>
     */
    protected function getConfig(string $name): array
    {
        return config("prism.providers.{$name}", []);
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createGroqProvider(array $config): Groq
    {
        return new Groq(
            apiKey: $config['api_key'],
            url: $config['url'],
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createXaiProvider(array $config): XAI
    {
        return new XAI(
            apiKey: $config['api_key'],
            url: $config['url'],
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createGeminiProvider(array $config): Gemini
    {
        return new Gemini(
            apiKey: $config['api_key'],
            url: $config['url'],
        );
    }

    /**
     * @param  array<string, mixed>  $config
     */
    protected function createOpenrouterProvider(array $config): OpenRouter
    {
        $siteConfig = $config['site'] ?? null;
        $site = is_array($siteConfig) ? $siteConfig : [];

        return new OpenRouter(
            apiKey: $config['api_key'] ?? '',
            url: $config['url'] ?? 'https://openrouter.ai/api/v1',
            httpReferer: $site['http_referer'] ?? null,
            xTitle: $site['x_title'] ?? null,
        );
    }

    /**
     * @param  array<string, string>  $config
     */
    protected function createElevenlabsProvider(array $config): ElevenLabs
    {
        return new ElevenLabs(
            apiKey: $config['api_key'] ?? '',
            url: $config['url'] ?? 'https://api.elevenlabs.io/v1/',
        );
    }
}



================================================
FILE: src/PrismServer.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism;

use Closure;
use Illuminate\Support\Collection;
use Prism\Prism\Text\PendingRequest;

readonly class PrismServer
{
    /**
     * @param  Collection<int, array{name: string, prism: Closure():PendingRequest|callable():PendingRequest}>  $prisms
     * */
    public function __construct(
        protected Collection $prisms = new Collection,
    ) {}

    /** @param \Closure():PendingRequest|callable():PendingRequest $prism */
    public function register(string $name, Closure|callable $prism): self
    {
        $this->prisms->push(['name' => $name, 'prism' => $prism]);

        return $this;
    }

    /** @return Collection<int, array{name: string, prism: Closure():PendingRequest|callable():PendingRequest}> */
    public function prisms(): Collection
    {
        return $this->prisms;
    }
}



================================================
FILE: src/PrismServiceProvider.php
================================================
<?php

namespace Prism\Prism;

use Illuminate\Support\Facades\Route;
use Illuminate\Support\ServiceProvider;

class PrismServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        $this->publishes([
            __DIR__.'/../config/prism.php' => config_path('prism.php'),
        ], 'prism-config');

        if (config('prism.prism_server.enabled')) {
            Route::group([
                'middleware' => config('prism.prism_server.middleware', []),
            ], function (): void {
                $this->loadRoutesFrom(__DIR__.'/Routes/PrismServer.php');
            });
        }
    }

    #[\Override]
    public function register(): void
    {
        $this->mergeConfigFrom(
            __DIR__.'/../config/prism.php',
            'prism'
        );

        $this->app->singleton(
            PrismManager::class,
            fn (): PrismManager => new PrismManager($this->app)
        );

        $this->app->alias(PrismManager::class, 'prism-manager');

        $this->app->singleton(
            Prism::class,
            fn (): Prism => new Prism
        );

        $this->app->alias(Prism::class, 'prism');

        $this->app->singleton(
            'prism-server',
            fn (): PrismServer => new PrismServer
        );
    }
}



================================================
FILE: src/Tool.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism;

use ArgumentCountError;
use Closure;
use Error;
use Illuminate\Support\Arr;
use InvalidArgumentException;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Schema;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\EnumSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Throwable;
use TypeError;

class Tool
{
    use HasProviderOptions;

    protected string $name = '';

    protected string $description;

    /** @var array<string,Schema> */
    protected array $parameters = [];

    /** @var array <int, string> */
    protected array $requiredParameters = [];

    /** @var Closure():string|callable():string */
    protected $fn;

    /** @var null|false|Closure(Throwable,array<int|string,mixed>):string */
    protected null|false|Closure $failedHandler = null;

    public function __construct()
    {
        //
    }

    public function as(string $name): self
    {
        $this->name = $name;

        return $this;
    }

    public function for(string $description): self
    {
        $this->description = $description;

        return $this;
    }

    public function using(Closure|callable $fn): self
    {
        $this->fn = $fn;

        return $this;
    }

    /**
     * @param  Closure(Throwable,array<int|string,mixed>):string  $handler
     */
    public function failed(Closure $handler): self
    {
        $this->failedHandler = $handler;

        return $this;
    }

    public function withoutErrorHandling(): self
    {
        $this->failedHandler = false;

        return $this;
    }

    public function withErrorHandling(?Closure $handler = null): self
    {
        $this->failedHandler = $handler;

        return $this;
    }

    public function withParameter(Schema $parameter, bool $required = true): self
    {
        $this->parameters[$parameter->name()] = $parameter;

        if ($required) {
            $this->requiredParameters[] = $parameter->name();
        }

        return $this;
    }

    public function withStringParameter(string $name, string $description, bool $required = true): self
    {
        $this->withParameter(new StringSchema($name, $description), $required);

        return $this;
    }

    public function withNumberParameter(string $name, string $description, bool $required = true): self
    {
        $this->withParameter(new NumberSchema($name, $description), $required);

        return $this;
    }

    public function withBooleanParameter(string $name, string $description, bool $required = true): self
    {
        $this->withParameter(new BooleanSchema($name, $description), $required);

        return $this;
    }

    public function withArrayParameter(
        string $name,
        string $description,
        Schema $items,
        bool $required = true,
    ): self {
        $this->withParameter(new ArraySchema($name, $description, $items), $required);

        return $this;
    }

    /**
     * @param  array<int, Schema>  $properties
     * @param  array<int, string>  $requiredFields
     */
    public function withObjectParameter(
        string $name,
        string $description,
        array $properties,
        array $requiredFields = [],
        bool $allowAdditionalProperties = false,
        bool $required = true,
    ): self {

        $this->withParameter(new ObjectSchema(
            $name,
            $description,
            $properties,
            $requiredFields,
            $allowAdditionalProperties,
        ), $required);

        return $this;
    }

    /**
     * @param  array<int, string|int|float>  $options
     */
    public function withEnumParameter(
        string $name,
        string $description,
        array $options,
        bool $required = true,
    ): self {
        $this->withParameter(new EnumSchema($name, $description, $options), $required);

        return $this;
    }

    /** @return array<int, string> */
    public function requiredParameters(): array
    {
        return $this->requiredParameters;
    }

    /**
     * @return array<string,Schema>
     */
    public function parameters(): array
    {
        return $this->parameters;
    }

    /**
     * @return array<string, array<string,mixed>>
     */
    public function parametersAsArray(): array
    {
        return Arr::mapWithKeys($this->parameters, fn (Schema $schema, string $name): array => [
            $name => $schema->toArray(),
        ]);
    }

    public function name(): string
    {
        return $this->name;
    }

    public function description(): string
    {
        return $this->description;
    }

    public function hasParameters(): bool
    {
        return (bool) count($this->parameters);
    }

    /**
     * @return null|false|Closure(Throwable,array<int|string,mixed>):string
     */
    public function failedHandler(): null|false|Closure
    {
        return $this->failedHandler;
    }

    /**
     * @param  string|int|float  $args
     *
     * @throws PrismException|Throwable
     */
    public function handle(...$args): string
    {
        try {
            $value = call_user_func($this->fn, ...$args);

            if (! is_string($value)) {
                throw PrismException::invalidReturnTypeInTool($this->name, new TypeError('Return value must be of type string'));
            }

            return $value;
        } catch (Throwable $e) {
            return $this->handleToolException($e, $args);
        }
    }

    protected function shouldHandleErrors(): bool
    {
        return $this->failedHandler !== false;
    }

    protected function hasCustomErrorHandler(): bool
    {
        return $this->failedHandler instanceof Closure;
    }

    protected function shouldUseDefaultErrorHandling(): bool
    {
        return $this->shouldHandleErrors() && ! $this->hasCustomErrorHandler();
    }

    /**
     * @param  array<int|string,mixed>  $providedParams
     */
    protected function getDefaultFailedMessage(Throwable $e, array $providedParams): string
    {
        $errorType = $this->classifyToolError($e);

        return match ($errorType) {
            'validation' => $this->formatValidationError($e, $providedParams),
            'runtime' => $this->formatRuntimeError($e),
            default => $this->formatRuntimeError($e),
        };
    }

    protected function classifyToolError(Throwable $e): string
    {
        $isValidationError = $e instanceof TypeError
            || ($e instanceof Error && str_contains($e->getMessage(), 'Unknown named parameter'));

        return $isValidationError ? 'validation' : 'runtime';
    }

    /**
     * @param  array<int|string,mixed>  $providedParams
     */
    protected function formatValidationError(Throwable $e, array $providedParams): string
    {
        $errorType = $this->determineValidationErrorType($e);
        $expectedParams = $this->formatExpectedParameters();
        $receivedParams = $this->formatReceivedParameters($providedParams);

        return sprintf(
            'Parameter validation error: %s. Expected: [%s]. Received: %s. Please provide correct parameter types and names.',
            $errorType,
            $expectedParams,
            $receivedParams
        );
    }

    protected function formatRuntimeError(Throwable $e): string
    {
        return sprintf(
            'Tool execution error: %s. This error occurred during tool execution, not due to invalid parameters.',
            $e->getMessage()
        );
    }

    protected function determineValidationErrorType(Throwable $e): string
    {
        return match (true) {
            $e instanceof ArgumentCountError => 'Missing required parameters',
            $e instanceof TypeError && str_contains($e->getMessage(), 'must be of type') => 'Type mismatch',
            str_contains($e->getMessage(), 'Unknown named parameter') => 'Unknown parameters',
            default => 'Invalid parameters',
        };
    }

    protected function formatExpectedParameters(): string
    {
        return collect($this->parameters)
            ->map(fn (Schema $param): string => sprintf(
                '%s (%s%s)',
                $param->name(),
                class_basename($param),
                in_array($param->name(), $this->requiredParameters) ? ', required' : ''
            ))
            ->join(', ');
    }

    /**
     * @param  array<int|string,mixed>  $providedParams
     */
    protected function formatReceivedParameters(array $providedParams): string
    {
        return json_encode($providedParams) ?: '{}';
    }

    /**
     * @param  array<int|string,mixed>  $args
     * @return array<int|string,mixed>
     */
    protected function extractProvidedParams(array $args): array
    {
        // If args is already an associative array (from tool calls), return as is
        if (! array_is_list($args)) {
            return $args;
        }

        // Otherwise map positional args to parameter names
        $paramNames = array_keys($this->parameters);
        $result = [];

        foreach ($args as $index => $value) {
            if (isset($paramNames[$index])) {
                $result[$paramNames[$index]] = $value;
            }
        }

        return $result;
    }

    /**
     * @param  array<int|string,mixed>  $args
     *
     * @throws PrismException|Throwable
     */
    protected function handleToolException(Throwable $e, array $args): string
    {
        if ($this->hasCustomErrorHandler()) {
            $providedParams = $this->extractProvidedParams($args);

            /** @var Closure(Throwable,array<int|string,mixed>):string $handler */
            $handler = $this->failedHandler;

            return $handler($e, $providedParams);
        }

        if (! $this->shouldHandleErrors()) {
            $this->throwMappedException($e);
        }

        if ($this->shouldUseDefaultErrorHandling()) {
            $providedParams = $this->extractProvidedParams($args);

            return $this->getDefaultFailedMessage($e, $providedParams);
        }

        throw $e;
    }

    /**
     * @throws PrismException|Throwable
     */
    protected function throwMappedException(Throwable $e): never
    {
        if ($e instanceof TypeError || $e instanceof InvalidArgumentException) {
            throw PrismException::invalidParameterInTool($this->name, $e);
        }

        if ($e::class === Error::class && ! str_starts_with($e->getMessage(), 'Unknown named parameter')) {
            throw $e;
        }

        if (str_starts_with($e->getMessage(), 'Unknown named parameter')) {
            throw PrismException::invalidParameterInTool($this->name, $e);
        }

        throw $e;
    }
}



================================================
FILE: src/.gitkeep
================================================
[Empty file]


================================================
FILE: src/Audio/AudioResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Audio;

use Prism\Prism\ValueObjects\GeneratedAudio;

readonly class AudioResponse
{
    public function __construct(
        public GeneratedAudio $audio,
        /** @var array<string,mixed> */
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/Audio/PendingRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Audio;

use Illuminate\Http\Client\RequestException;
use InvalidArgumentException;
use Prism\Prism\Concerns\ConfiguresClient;
use Prism\Prism\Concerns\ConfiguresModels;
use Prism\Prism\Concerns\ConfiguresProviders;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\ValueObjects\Media\Audio;

class PendingRequest
{
    use ConfiguresClient;
    use ConfiguresModels;
    use ConfiguresProviders;
    use HasProviderOptions;

    protected string|Audio $input;

    protected string $voice;

    public function withInput(string|Audio $input): self
    {
        $this->input = $input;

        return $this;
    }

    public function withVoice(string $voice): self
    {
        $this->voice = $voice;

        return $this;
    }

    public function asAudio(): AudioResponse
    {
        $request = $this->toTextToSpeechRequest();

        try {
            return $this->provider->textToSpeech($request);
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    public function asText(): TextResponse
    {
        $request = $this->toSpeechToTextRequest();

        try {
            return $this->provider->speechToText($request);
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    protected function toTextToSpeechRequest(): TextToSpeechRequest
    {
        if (! is_string($this->input)) {
            throw new InvalidArgumentException('Text-to-speech requires string input');
        }

        return new TextToSpeechRequest(
            model: $this->model,
            providerKey: $this->providerKey(),
            input: $this->input,
            voice: $this->voice,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            providerOptions: $this->providerOptions,
        );
    }

    protected function toSpeechToTextRequest(): SpeechToTextRequest
    {
        if (! ($this->input instanceof Audio)) {
            throw new InvalidArgumentException('Speech-to-text requires Audio input');
        }

        return new SpeechToTextRequest(
            model: $this->model,
            providerKey: $this->providerKey(),
            input: $this->input,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            providerOptions: $this->providerOptions,
        );
    }
}



================================================
FILE: src/Audio/SpeechToTextRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Audio;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\ValueObjects\Media\Audio;

class SpeechToTextRequest implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     */
    public function __construct(
        protected string $model,
        protected string $providerKey,
        protected Audio $input,
        protected array $clientOptions,
        protected array $clientRetry,
        array $providerOptions = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    /**
     * @return array<string, mixed>
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    public function input(): Audio
    {
        return $this->input;
    }

    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }
}



================================================
FILE: src/Audio/TextResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Audio;

use Prism\Prism\ValueObjects\Usage;

readonly class TextResponse
{
    public function __construct(
        public string $text,
        public ?Usage $usage = null,
        /** @var array<string,mixed> */
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/Audio/TextToSpeechRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Audio;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\PrismRequest;

class TextToSpeechRequest implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     */
    public function __construct(
        protected string $model,
        protected string $providerKey,
        protected string $input,
        protected string $voice,
        protected array $clientOptions,
        protected array $clientRetry,
        array $providerOptions = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    /**
     * @return array<string, mixed>
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    public function input(): string
    {
        return $this->input;
    }

    public function voice(): string
    {
        return $this->voice;
    }

    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }
}



================================================
FILE: src/Concerns/CallsTools.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Illuminate\Support\ItemNotFoundException;
use Illuminate\Support\MultipleItemsFoundException;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Throwable;

trait CallsTools
{
    /**
     * @param  Tool[]  $tools
     * @param  ToolCall[]  $toolCalls
     * @return ToolResult[]
     */
    protected function callTools(array $tools, array $toolCalls): array
    {
        return array_map(
            function (ToolCall $toolCall) use ($tools): ToolResult {
                $tool = $this->resolveTool($toolCall->name, $tools);

                try {
                    $result = call_user_func_array(
                        $tool->handle(...),
                        $toolCall->arguments()
                    );

                    return new ToolResult(
                        toolCallId: $toolCall->id,
                        toolName: $toolCall->name,
                        args: $toolCall->arguments(),
                        result: $result,
                        toolCallResultId: $toolCall->resultId,
                    );
                } catch (Throwable $e) {
                    if ($e instanceof PrismException) {
                        throw $e;
                    }

                    throw PrismException::toolCallFailed($toolCall, $e);
                }

            },
            $toolCalls
        );
    }

    /**
     * @param  Tool[]  $tools
     */
    protected function resolveTool(string $name, array $tools): Tool
    {
        try {
            return collect($tools)
                ->sole(fn (Tool $tool): bool => $tool->name() === $name);
        } catch (ItemNotFoundException $e) {
            throw PrismException::toolNotFound($name, $e);
        } catch (MultipleItemsFoundException $e) {
            throw PrismException::multipleToolsFound($name, $e);
        }
    }
}



================================================
FILE: src/Concerns/ChecksSelf.php
================================================
<?php

namespace Prism\Prism\Concerns;

trait ChecksSelf
{
    /**
     * @param  class-string  $classString
     */
    public function is(string $classString): bool
    {
        return $this instanceof $classString;
    }
}



================================================
FILE: src/Concerns/ConfiguresClient.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Closure;

trait ConfiguresClient
{
    /** @var array<string, mixed> */
    protected array $clientOptions = [];

    /** @var array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool} */
    protected array $clientRetry = [0];

    /**
     * @param  array<string, mixed>  $options
     */
    public function withClientOptions(array $options): self
    {
        $this->clientOptions = $options;

        return $this;
    }

    /**
     * @param  array<int>|int  $times
     */
    public function withClientRetry(
        array|int $times,
        Closure|int $sleepMilliseconds = 0,
        ?callable $when = null,
        bool $throw = true
    ): self {
        $this->clientRetry = [$times, $sleepMilliseconds, $when, $throw];

        return $this;
    }
}



================================================
FILE: src/Concerns/ConfiguresGeneration.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

trait ConfiguresGeneration
{
    protected int $maxSteps = 1;

    public function withMaxSteps(int $steps): self
    {
        $this->maxSteps = $steps;

        return $this;
    }
}



================================================
FILE: src/Concerns/ConfiguresModels.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

trait ConfiguresModels
{
    protected ?int $maxTokens = 2048;

    protected int|float|null $temperature = null;

    protected int|float|null $topP = null;

    public function withMaxTokens(?int $maxTokens): self
    {
        $this->maxTokens = $maxTokens;

        return $this;
    }

    public function usingTemperature(int|float|null $temperature): self
    {
        $this->temperature = $temperature;

        return $this;
    }

    public function usingTopP(int|float $topP): self
    {
        $this->topP = $topP;

        return $this;
    }
}



================================================
FILE: src/Concerns/ConfiguresProviders.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Enums\Provider as ProviderEnum;
use Prism\Prism\PrismManager;
use Prism\Prism\Providers\Provider;

trait ConfiguresProviders
{
    protected Provider $provider;

    protected string $providerKey;

    protected string $model;

    /**
     * @param  array<string, mixed>  $providerConfig
     */
    public function using(string|ProviderEnum $provider, string $model = '', array $providerConfig = []): self
    {
        $this->providerKey = is_string($provider) ? $provider : $provider->value;

        $this->model = $model;

        return $this->usingProviderConfig($providerConfig);
    }

    public function provider(): Provider
    {
        return $this->provider;
    }

    /**
     * @param  array<string, mixed>  $config
     */
    public function usingProviderConfig(array $config): self
    {
        $this->provider = resolve(PrismManager::class)->resolve($this->providerKey, $config);

        return $this;
    }

    public function model(): string
    {
        return $this->model;
    }

    public function providerKey(): string
    {
        return $this->providerKey;
    }

    public function whenProvider(string|ProviderEnum $provider, callable $callback): self
    {
        $providerKey = is_string($provider) ? $provider : $provider->value;

        if ($this->providerKey() === $providerKey) {
            return $callback($this);
        }

        return $this;
    }
}



================================================
FILE: src/Concerns/ConfiguresStructuredOutput.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Enums\StructuredMode;

trait ConfiguresStructuredOutput
{
    protected StructuredMode $structuredMode = StructuredMode::Auto;

    public function usingStructuredMode(StructuredMode $mode): self
    {
        $this->structuredMode = $mode;

        return $this;
    }
}



================================================
FILE: src/Concerns/ConfiguresTools.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Tool;

trait ConfiguresTools
{
    protected string|ToolChoice|null $toolChoice = null;

    public function withToolChoice(string|ToolChoice|Tool $toolChoice): self
    {
        $this->toolChoice = $toolChoice instanceof Tool
            ? $toolChoice->name()
            : $toolChoice;

        return $this;
    }
}



================================================
FILE: src/Concerns/HasFluentAttributes.php
================================================
<?php

namespace Prism\Prism\Concerns;

use BadMethodCallException;
use Illuminate\Support\Str;
use InvalidArgumentException;

trait HasFluentAttributes
{
    /**
     * @param  array<mixed>  $arguments
     */
    public function __call(string $name, array $arguments): self
    {
        $propertyName = Str::of($name)->after('with')->camel()->value();

        if (! property_exists($this, $propertyName)) {
            throw new BadMethodCallException("Method {$name} does not exist.");
        }

        if (count($arguments) !== 1) {
            throw new InvalidArgumentException("Method {$name} expects exactly one argument.");
        }

        return new self(
            ...array_merge(
                get_object_vars($this),
                [$propertyName => array_values($arguments)[0]]
            )
        );
    }
}



================================================
FILE: src/Concerns/HasMessages.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Contracts\Message;

trait HasMessages
{
    /** @var array<int, Message> */
    protected array $messages = [];

    /**
     * @param  array<int, Message>  $messages
     */
    public function withMessages(array $messages): self
    {
        $this->messages = $messages;

        return $this;
    }
}



================================================
FILE: src/Concerns/HasPrompts.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Illuminate\Contracts\View\View;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Media;
use Prism\Prism\ValueObjects\Media\Text;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

trait HasPrompts
{
    protected ?string $prompt = null;

    /**
     * @var array<int, Audio|Text|Image|Media|Document|Video>
     */
    protected array $additionalContent = [];

    /**
     * @var SystemMessage[]
     */
    protected array $systemPrompts = [];

    /**
     * @param  array<int, Audio|Text|Image|Media|Document|Video>  $additionalContent
     */
    public function withPrompt(string|View $prompt, array $additionalContent = []): self
    {
        $this->prompt = is_string($prompt) ? $prompt : $prompt->render();
        $this->additionalContent = $additionalContent;

        return $this;
    }

    public function withSystemPrompt(string|View|SystemMessage $message): self
    {
        if ($message instanceof SystemMessage) {
            $this->systemPrompts[] = $message;

            return $this;
        }

        $this->systemPrompts[] = new SystemMessage(is_string($message) ? $message : $message->render());

        return $this;
    }

    /**
     * @param  SystemMessage[]  $messages
     */
    public function withSystemPrompts(array $messages): self
    {
        $this->systemPrompts = $messages;

        return $this;
    }
}



================================================
FILE: src/Concerns/HasProviderOptions.php
================================================
<?php

namespace Prism\Prism\Concerns;

trait HasProviderOptions
{
    /** @var array<string, mixed> */
    protected array $providerOptions = [];

    /**
     * @param  array<string, mixed>  $options
     */
    public function withProviderOptions(array $options = []): self
    {
        $this->providerOptions = $options;

        return $this;
    }

    public function providerOptions(?string $valuePath = null): mixed
    {
        if ($valuePath === null) {
            return $this->providerOptions;
        }

        return data_get($this->providerOptions, $valuePath, null);
    }
}



================================================
FILE: src/Concerns/HasProviderTools.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\ValueObjects\ProviderTool;

trait HasProviderTools
{
    /** @var array<int,ProviderTool> */
    protected array $providerTools = [];

    /**
     * @param  array<int,ProviderTool>  $providerTools
     */
    public function withProviderTools(array $providerTools): self
    {
        $this->providerTools = $providerTools;

        return $this;
    }
}



================================================
FILE: src/Concerns/HasSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Contracts\Schema;

trait HasSchema
{
    protected ?Schema $schema = null;

    public function withSchema(Schema $schema): self
    {
        $this->schema = $schema;

        return $this;
    }
}



================================================
FILE: src/Concerns/HasTools.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Prism\Prism\Tool;

trait HasTools
{
    /** @var array<int, Tool> */
    protected array $tools = [];

    protected bool $toolErrorHandlingEnabled = true;

    /**
     * @param  array<int, Tool>  $tools
     */
    public function withTools(array $tools): self
    {
        $this->tools = $tools;

        return $this;
    }

    public function withoutToolErrorHandling(): self
    {
        $this->toolErrorHandlingEnabled = false;

        return $this;
    }
}



================================================
FILE: src/Concerns/InitializesClient.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Concerns;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Facades\Http;
use Psr\Http\Message\RequestInterface;
use Psr\Http\Message\ResponseInterface;

trait InitializesClient
{
    protected function baseClient(): PendingRequest
    {
        return Http::withRequestMiddleware(fn (RequestInterface $request): RequestInterface => $request)
            ->withResponseMiddleware(fn (ResponseInterface $response): ResponseInterface => $response)
            ->throw();
    }
}



================================================
FILE: src/Concerns/NullableSchema.php
================================================
<?php

namespace Prism\Prism\Concerns;

trait NullableSchema
{
    /**
     * @return array<int, string>
     */
    protected function castToNullable(string $type): array
    {
        return [$type, 'null'];
    }
}



================================================
FILE: src/Contracts/Message.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Contracts;

interface Message {}



================================================
FILE: src/Contracts/PrismRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Contracts;

interface PrismRequest
{
    /**
     * @param  class-string  $classString
     */
    public function is(string $classString): bool;

    public function model(): string;

    /**
     * @param  array<string, mixed>  $options
     */
    public function withProviderOptions(array $options = []): self;

    public function providerOptions(?string $valuePath = null): mixed;
}



================================================
FILE: src/Contracts/ProviderMediaMapper.php
================================================
<?php

namespace Prism\Prism\Contracts;

use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Media\Media;

abstract class ProviderMediaMapper
{
    public function __construct(public readonly Media $media)
    {
        $this->runValidation();
    }

    abstract public function toPayload(): mixed;

    abstract protected function provider(): string|Provider;

    abstract protected function validateMedia(): bool;

    protected function runValidation(): void
    {
        if ($this->validateMedia() === false) {
            $providerName = $this->provider() instanceof Provider ? $this->provider()->value : $this->provider();

            $calledClass = static::class;

            throw new PrismException("The $providerName provider does not support the mediums available in the provided `$calledClass`. Pleae consult the Prism documentation for more information on which mediums the $providerName provider supports.");
        }
    }
}



================================================
FILE: src/Contracts/ProviderRequestMapper.php
================================================
<?php

namespace Prism\Prism\Contracts;

use Prism\Prism\Enums\Provider;

abstract class ProviderRequestMapper
{
    /**
     * @return array<string, mixed>
     */
    abstract public function toPayload(): array;

    abstract protected function provider(): string|Provider;
}



================================================
FILE: src/Contracts/Schema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Contracts;

interface Schema
{
    public function name(): string;

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array;
}



================================================
FILE: src/Embeddings/PendingRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Embeddings;

use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\ConfiguresClient;
use Prism\Prism\Concerns\ConfiguresProviders;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Exceptions\PrismException;

class PendingRequest
{
    use ConfiguresClient;
    use ConfiguresProviders;
    use HasProviderOptions;

    /** @var array<string> */
    protected array $inputs = [];

    public function fromInput(string $input): self
    {
        $this->inputs[] = $input;

        return $this;
    }

    /**
     * @param  array<string>  $inputs
     */
    public function fromArray(array $inputs): self
    {
        $this->inputs = array_merge($this->inputs, $inputs);

        return $this;
    }

    public function fromFile(string $path): self
    {
        if (! is_file($path)) {
            throw new PrismException(sprintf('%s is not a valid file', $path));
        }

        $contents = file_get_contents($path);

        if ($contents === false) {
            throw new PrismException(sprintf('%s contents could not be read', $path));
        }

        $this->inputs[] = $contents;

        return $this;
    }

    /**
     * @deprecated Use `asEmbeddings` instead.
     */
    public function generate(): Response
    {
        return $this->asEmbeddings();
    }

    public function asEmbeddings(): Response
    {
        if ($this->inputs === []) {
            throw new PrismException('Embeddings input is required');
        }

        $request = $this->toRequest();

        try {
            return $this->provider->embeddings($request);
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    protected function toRequest(): Request
    {
        return new Request(
            model: $this->model,
            providerKey: $this->providerKey(),
            inputs: $this->inputs,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            providerOptions: $this->providerOptions
        );
    }
}



================================================
FILE: src/Embeddings/Request.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Embeddings;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\PrismRequest;

class Request implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  array<string>  $inputs
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     */
    public function __construct(
        protected string $model,
        protected string $providerKey,
        protected array $inputs,
        protected array $clientOptions,
        protected array $clientRetry,
        array $providerOptions = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool} $clientRetry
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    /**
     * @return array<string, mixed> $clientOptions
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    /**
     * @return array<string> $inputs
     */
    public function inputs(): array
    {
        return $this->inputs;
    }

    #[\Override]
    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }
}



================================================
FILE: src/Embeddings/Response.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Embeddings;

use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

readonly class Response
{
    /**
     * @param  Embedding[]  $embeddings
     */
    public function __construct(
        public array $embeddings,
        public EmbeddingsUsage $usage,
        public Meta $meta
    ) {}
}



================================================
FILE: src/Enums/FinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums;

enum FinishReason: string
{
    case Stop = 'stop';
    case Length = 'length';
    case ContentFilter = 'content-filter';
    case ToolCalls = 'tool-calls';
    case Error = 'error';
    case Other = 'other';
    case Unknown = 'unknown';
}



================================================
FILE: src/Enums/Provider.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums;

enum Provider: string
{
    case Anthropic = 'anthropic';
    case DeepSeek = 'deepseek';
    case Ollama = 'ollama';
    case OpenAI = 'openai';
    case OpenRouter = 'openrouter';
    case Mistral = 'mistral';
    case Groq = 'groq';
    case XAI = 'xai';
    case Gemini = 'gemini';
    case VoyageAI = 'voyageai';
    case ElevenLabs = 'elevenlabs';
}



================================================
FILE: src/Enums/StreamEventType.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums;

enum StreamEventType: string
{
    case StreamStart = 'stream_start';
    case TextStart = 'text_start';
    case TextDelta = 'text_delta';
    case TextComplete = 'text_complete';
    case ThinkingStart = 'thinking_start';
    case ThinkingDelta = 'thinking_delta';
    case ThinkingComplete = 'thinking_complete';
    case ToolCall = 'tool_call';
    case ToolResult = 'tool_result';
    case Citation = 'citation';
    case Error = 'error';
    case StreamEnd = 'stream_end';
}



================================================
FILE: src/Enums/StructuredMode.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums;

enum StructuredMode
{
    case Auto;
    case Json;
    case Structured;
}



================================================
FILE: src/Enums/ToolChoice.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums;

enum ToolChoice
{
    case Auto;
    case Any;
    case None;
}



================================================
FILE: src/Enums/Citations/CitationSourcePositionType.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums\Citations;

enum CitationSourcePositionType: string
{
    case Character = 'character';
    case Page = 'page';
    case Chunk = 'chunk';
}



================================================
FILE: src/Enums/Citations/CitationSourceType.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Enums\Citations;

enum CitationSourceType: string
{
    case Document = 'document';
    case Url = 'url';
}



================================================
FILE: src/Events/Broadcasting/ErrorBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ErrorBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/StreamEndBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class StreamEndBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/StreamEventBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

use Illuminate\Broadcasting\Channel;
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Contracts\Broadcasting\ShouldBroadcastNow;
use Prism\Prism\Streaming\Events\StreamEvent;

abstract class StreamEventBroadcast implements ShouldBroadcastNow
{
    use InteractsWithSockets;

    /**
     * @param  Channel|Channel[]  $channels
     */
    public function __construct(
        public StreamEvent $event,
        public Channel|array $channels
    ) {}

    /**
     * @return array<int, Channel>
     */
    public function broadcastOn(): array
    {
        return is_array($this->channels) ? $this->channels : [$this->channels];
    }

    public function broadcastAs(): string
    {
        return $this->event->type()->value;
    }

    /**
     * @return array<string, mixed>
     */
    public function broadcastWith(): array
    {
        return $this->event->toArray();
    }
}



================================================
FILE: src/Events/Broadcasting/StreamStartBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class StreamStartBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/TextCompleteBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class TextCompleteBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/TextDeltaBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class TextDeltaBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/TextStartBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class TextStartBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/ThinkingBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ThinkingBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/ThinkingCompleteBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ThinkingCompleteBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/ThinkingStartBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ThinkingStartBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/ToolCallBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ToolCallBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Events/Broadcasting/ToolResultBroadcast.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Events\Broadcasting;

class ToolResultBroadcast extends StreamEventBroadcast {}



================================================
FILE: src/Exceptions/PrismException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Exception;
use Prism\Prism\ValueObjects\ToolCall;
use Throwable;

class PrismException extends Exception
{
    public static function promptOrMessages(): self
    {
        return new self('You can only use `prompt` or `messages`');
    }

    public static function toolNotFound(string $name, Throwable $previous): self
    {
        return new self(
            sprintf('Tool (%s) not found', $name),
            previous: $previous
        );
    }

    public static function multipleToolsFound(string $name, Throwable $previous): self
    {
        return new self(
            sprintf('Multiple tools with the name %s found', $name),
            previous: $previous
        );
    }

    public static function toolCallFailed(ToolCall $toolCall, Throwable $previous): self
    {
        return new self(
            sprintf('Calling %s tool failed', $toolCall->name),
            previous: $previous
        );
    }

    public static function invalidParameterInTool(string $toolName, Throwable $previous): self
    {
        return new self(
            sprintf('Invalid parameters for tool : %s', $toolName),
            previous: $previous
        );
    }

    public static function invalidReturnTypeInTool(string $toolName, Throwable $previous): self
    {
        return new self(
            sprintf('Invalid return type for tool : %s. Tools must return string.', $toolName),
            previous: $previous
        );
    }

    public static function providerResponseError(string $message): self
    {
        return new self($message);
    }

    public static function providerRequestError(string $model, Throwable $previous): self
    {
        return new self(vsprintf('Sending to model (%s) failed: %s', [
            $model,
            $previous->getMessage(),
        ]), previous: $previous);
    }

    public static function unsupportedProviderAction(string $method, string $provider): self
    {
        return new self(sprintf(
            '%s is not supported by %s',
            ucfirst($method),
            $provider,
        ));
    }
}



================================================
FILE: src/Exceptions/PrismProviderOverloadedException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Prism\Prism\Enums\Provider;

class PrismProviderOverloadedException extends PrismException
{
    public function __construct(string|Provider $provider)
    {
        $provider = is_string($provider) ? $provider : $provider->value;

        parent::__construct("Prism provider $provider is overloaded.");
    }

    public static function make(string|Provider $provider): self
    {
        return new self($provider);
    }
}



================================================
FILE: src/Exceptions/PrismRateLimitedException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Prism\Prism\ValueObjects\ProviderRateLimit;

class PrismRateLimitedException extends PrismException
{
    /**
     * @param  ProviderRateLimit[]  $rateLimits
     */
    public function __construct(
        public readonly array $rateLimits,
        public readonly ?int $retryAfter = null
    ) {
        $message = 'You hit a provider rate limit';

        if ($retryAfter) {
            $message .= ' - retry after '.$retryAfter.' seconds';
        }

        $message .= '. Details: '.json_encode($rateLimits);

        parent::__construct($message);
    }

    /**
     * @param  ProviderRateLimit[]  $rateLimits
     */
    public static function make(array $rateLimits = [], ?int $retryAfter = null): self
    {
        return new self(rateLimits: $rateLimits, retryAfter: $retryAfter);
    }
}



================================================
FILE: src/Exceptions/PrismRequestTooLargeException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Prism\Prism\Enums\Provider;

class PrismRequestTooLargeException extends PrismException
{
    public function __construct(string|Provider $provider)
    {
        $provider = is_string($provider) ? $provider : $provider->value;

        parent::__construct("Your Prism request to $provider was too large. Consult the provider's documentation.");
    }

    public static function make(string|Provider $provider): self
    {
        return new self($provider);
    }
}



================================================
FILE: src/Exceptions/PrismServerException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Exception;
use Throwable;

class PrismServerException extends Exception
{
    public static function unresolvableModel(string $model, ?Throwable $previous = null): self
    {
        return new self(
            sprintf('Prism "%s" is not registered with PrismServer', $model),
            previous: $previous
        );
    }
}



================================================
FILE: src/Exceptions/PrismStreamDecodeException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

use Throwable;

class PrismStreamDecodeException extends PrismException
{
    public function __construct(string $provider, Throwable $previous)
    {
        parent::__construct(
            sprintf('Could not decode stream from %s', $provider),
            previous: $previous
        );
    }
}



================================================
FILE: src/Exceptions/PrismStructuredDecodingException.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Exceptions;

class PrismStructuredDecodingException extends PrismException
{
    public function __construct(string $responseText)
    {
        parent::__construct(sprintf(
            'Structured object could not be decoded. Received: %s',
            $responseText
        ));
    }

    public static function make(string $responseText): self
    {
        return new self($responseText);
    }
}



================================================
FILE: src/Facades/Prism.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Facades;

use Illuminate\Support\Facades\Facade;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\PendingRequest as PendingAudioRequest;
use Prism\Prism\Audio\TextResponse as AudioTextResponse;
use Prism\Prism\Embeddings\PendingRequest as PendingEmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Enums\Provider as ProviderEnum;
use Prism\Prism\Images\PendingRequest as PendingImageRequest;
use Prism\Prism\Images\Response as ImageResponse;
use Prism\Prism\PrismManager;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\PendingRequest as PendingStructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Testing\PrismFake;
use Prism\Prism\Text\PendingRequest as PendingTextRequest;
use Prism\Prism\Text\Response as TextResponse;

/**
 * @method static PendingTextRequest text()
 * @method static PendingStructuredRequest structured()
 * @method static PendingEmbeddingRequest embeddings()
 * @method static PendingImageRequest image()
 * @method static PendingAudioRequest audio()
 *
 * @see \Prism\Prism\Prism
 */
class Prism extends Facade
{
    /**
     * @param  array<int, TextResponse|StructuredResponse|EmbeddingResponse|ImageResponse|AudioResponse|AudioTextResponse>  $responses
     */
    public static function fake(array $responses = []): PrismFake
    {
        $fake = new PrismFake($responses);

        app()->instance(PrismManager::class, new class($fake) extends PrismManager
        {
            public function __construct(
                private readonly PrismFake $fake
            ) {}

            public function resolve(ProviderEnum|string $name, array $providerConfig = []): Provider
            {
                $this->fake->setProviderConfig($providerConfig);

                return $this->fake;
            }
        });

        return $fake;
    }

    /**
     * @param  array<string,mixed>  $providerConfig
     */
    public static function provider(ProviderEnum|string $name, array $providerConfig = []): Provider
    {
        return app(PrismManager::class)->resolve($name, $providerConfig);
    }

    protected static function getFacadeAccessor(): string
    {
        return 'prism';
    }
}



================================================
FILE: src/Facades/PrismServer.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Facades;

use Closure;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Facade;
use Prism\Prism\Text\PendingRequest;

/**
 * @method static self register(string $name, Closure():PendingRequest|callable():PendingRequest $prism)
 * @method static Collection<int, array{name: string, prism: Closure():PendingRequest|callable():PendingRequest}> prisms()
 */
class PrismServer extends Facade
{
    #[\Override]
    protected static function getFacadeAccessor(): string
    {
        return 'prism-server';
    }
}



================================================
FILE: src/Facades/Tool.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Facades;

use BadMethodCallException;
use Closure;
use Prism\Prism\Contracts\Schema;
use Prism\Prism\Tool as BaseTool;

/**
 * @method static BaseTool as(string $name)
 * @method static BaseTool for(string $description)
 * @method static BaseTool using(Closure|callable $fn)
 * @method static BaseTool withParameter(Schema $parameter, bool $required = true)
 * @method static BaseTool withStringParameter(string $name, string $description, bool $required = true)
 * @method static BaseTool withNumberParameter(string $name, string $description, bool $required = true)
 * @method static BaseTool withBooleanParameter(string $name, string $description, bool $required = true)
 * @method static BaseTool withEnumParameter(string $name, string $description, array<string> $options, bool $required = true)
 * @method static BaseTool withArrayParameter(string $name, string $description, Schema $items, bool $required = true)
 * @method static BaseTool withObjectParameter(string $name, string $description, array<string, Schema> $properties, array<string> $requiredFields = [], bool $allowAdditionalProperties = false, bool $required = true)
 */
class Tool
{
    /** @param array<int, mixed> $arguments */
    public static function __callStatic(string $method, array $arguments): BaseTool
    {
        $instance = new BaseTool;

        if (method_exists($instance, $method)) {
            return $instance->$method(...$arguments);
        }

        throw new BadMethodCallException("Method {$method} does not exist.");
    }
}



================================================
FILE: src/Http/Controllers/PrismChatController.php
================================================
<?php

namespace Prism\Prism\Http\Controllers;

use Illuminate\Support\ItemNotFoundException;
use Prism\Prism\Exceptions\PrismServerException;
use Prism\Prism\Facades\PrismServer;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Symfony\Component\HttpFoundation\Response;
use Throwable;

class PrismChatController
{
    public function __invoke(): Response
    {
        request()->validate([
            'stream' => 'sometimes|boolean',
            'model' => 'string|required',
            'messages' => 'sometimes|array',
        ]);

        try {
            /** @var array<array{role: string, content: string}> $messages */
            $messages = request('messages');

            $prism = $this->resolvePrism(request('model'));

            $prism->withMessages($this->mapMessages($messages));

            if (request('stream')) {
                return $this->stream($prism);
            }

            return $this->chat($prism);
        } catch (Throwable $e) {
            return $this->error($e);
        }
    }

    protected function stream(PendingRequest $generator): Response
    {
        return response()->stream(function () use ($generator): void {
            $response = $generator->asStream();

            foreach ($response as $chunk) {
                if (! $chunk instanceof TextDeltaEvent) {
                    continue;
                }

                $data = [
                    'id' => $chunk->id,
                    'object' => 'chat.completion.chunk',
                    'created' => now()->timestamp,
                    'model' => 'unknown',
                    'choices' => [[
                        'delta' => [
                            'role' => 'assistant',
                            'content' => $chunk->delta,
                        ],
                    ]],
                ];

                echo 'data: '.json_encode($data)."\n\n";
                ob_flush();
                flush();
            }

            echo "data: [DONE]\n";
            ob_flush();
            flush();
        }, 200, [
            'Content-Type' => 'text/event-stream',
            'X-Accel-Buffering' => 'no',
            'Cache-Control' => 'no-cache',
            'Connection' => 'keep-alive',
        ]);
    }

    protected function error(Throwable $e): Response
    {
        return response()->json([
            'error' => [
                'message' => $e->getMessage(),
            ],
        ], Response::HTTP_INTERNAL_SERVER_ERROR);
    }

    protected function chat(PendingRequest $generator): Response
    {
        $response = $generator->asText();

        $data = [
            'id' => $response->meta->id,
            'object' => 'chat.completion',
            'created' => now()->timestamp,
            'model' => $response->meta->model,
            'usage' => [
                'prompt_tokens' => $response->usage->promptTokens,
                'completion_tokens' => $response->usage->completionTokens,
                'total_tokens' => $response->usage->promptTokens
                        + $response->usage->completionTokens,
            ],
            'choices' => [
                [
                    'index' => 0,
                    'message' => [
                        'content' => $this->textFromResponse($response),
                        'role' => 'assistant',
                    ],
                    'finish_reason' => 'stop',
                ],
            ],
        ];

        return response()->json($data);
    }

    protected function textFromResponse(TextResponse $response): string
    {
        return $response->text;
    }

    /**
     * @param  array<int, array{role: string, content: mixed}>  $messages
     * @return array<int, UserMessage|AssistantMessage|SystemMessage>
     */
    protected function mapMessages(array $messages): array
    {
        return collect($messages)
            ->map(fn (array $message): UserMessage|AssistantMessage|SystemMessage => match ($message['role']) {
                'user' => $this->mapUserMessage($message),
                'assistant' => new AssistantMessage($this->extractTextContent($message['content'])),
                'system' => new SystemMessage($this->extractTextContent($message['content'])),
                default => throw new PrismServerException("Couldn't map messages to Prism messages")
            })
            ->toArray();
    }

    /**
     * @param  array{role: string, content: mixed}  $message
     */
    protected function mapUserMessage(array $message): UserMessage
    {
        $content = $message['content'];

        // Si le contenu est une string simple, retourner un UserMessage classique
        if (is_string($content)) {
            return new UserMessage($content);
        }

        // Si le contenu est un array (format multimodal OpenAI)
        if (is_array($content)) {
            $textContent = '';
            $additionalContent = [];

            foreach ($content as $part) {
                if (! is_array($part)) {
                    continue;
                }
                if (! isset($part['type'])) {
                    continue;
                }
                if (! is_string($part['type'])) {
                    continue;
                }
                match ($part['type']) {
                    'text' => $textContent .= $part['text'] ?? '',
                    'image_url' => $additionalContent[] = $this->mapImageUrl($part),
                    default => null // Ignore unknown types
                };
            }

            return new UserMessage($textContent, $additionalContent);
        }

        // This line should never be reached due to the type guards above
        throw new PrismServerException('Invalid message content type');
    }

    /**
     * @param  array<string, mixed>  $imagePart
     */
    protected function mapImageUrl(array $imagePart): Image
    {
        $imageUrl = $imagePart['image_url'] ?? [];
        $url = $imageUrl['url'] ?? '';

        // Détecter si c'est une image base64 ou une URL
        if (str_starts_with((string) $url, 'data:')) {
            // Format: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...
            $parts = explode(',', (string) $url, 2);
            if (count($parts) === 2) {
                $metadata = $parts[0]; // data:image/png;base64
                $base64Data = $parts[1];

                // Extraire le mime type
                preg_match('/data:([^;]+)/', $metadata, $matches);
                $mimeType = $matches[1] ?? 'image/jpeg';

                return Image::fromBase64($base64Data, $mimeType);
            }
        }

        // C'est une URL
        return Image::fromUrl($url);
    }

    /**
     * @param  string|array<int, mixed>  $content
     */
    protected function extractTextContent(string|array $content): string
    {
        if (is_string($content)) {
            return $content;
        }
        $text = '';
        foreach ($content as $part) {
            if (is_array($part) && isset($part['type']) && $part['type'] === 'text') {
                $text .= $part['text'] ?? '';
            }
        }

        return $text;
    }

    protected function resolvePrism(string $model): PendingRequest
    {
        try {
            $prism = PrismServer::prisms()
                ->sole('name', $model);
        } catch (ItemNotFoundException $e) {
            throw PrismServerException::unresolvableModel($model, $e);
        }

        return $prism['prism']();
    }
}



================================================
FILE: src/Http/Controllers/PrismModelController.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Http\Controllers;

use Illuminate\Http\JsonResponse;
use Prism\Prism\Facades\PrismServer;

class PrismModelController
{
    public function __invoke(): JsonResponse
    {
        $prisms = PrismServer::prisms()
            ->map(fn (array $model): array => [
                'id' => $model['name'],
                'object' => 'model',
            ]);

        return response()->json(
            [
                'object' => 'list',
                'data' => $prisms->toArray(),
            ]
        );
    }
}



================================================
FILE: src/Images/PendingRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Images;

use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\ConfiguresClient;
use Prism\Prism\Concerns\ConfiguresModels;
use Prism\Prism\Concerns\ConfiguresProviders;
use Prism\Prism\Concerns\HasPrompts;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Media;
use Prism\Prism\ValueObjects\Media\Text;

class PendingRequest
{
    use ConfiguresClient;
    use ConfiguresModels;
    use ConfiguresProviders;
    use HasPrompts;
    use HasProviderOptions;

    public function generate(): Response
    {
        $request = $this->toRequest();

        try {
            return $this->provider->images($this->toRequest());
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    public function toRequest(): Request
    {
        return new Request(
            model: $this->model,
            providerKey: $this->providerKey(),
            systemPrompts: $this->systemPrompts,
            prompt: $this->prompt,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            additionalContent: array_values(array_filter(
                $this->additionalContent,
                fn (Media|Text $content): bool => $content instanceof Image
            )),
            providerOptions: $this->providerOptions,
        );
    }
}



================================================
FILE: src/Images/Request.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Images;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

class Request implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  SystemMessage[]  $systemPrompts
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     * @param  array<int, Image>  $additionalContent
     */
    public function __construct(
        protected string $model,
        protected string $providerKey,
        protected array $systemPrompts,
        protected ?string $prompt,
        protected array $clientOptions,
        protected array $clientRetry,
        protected array $additionalContent,
        array $providerOptions = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool} $clientRetry
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    /**
     * @return array<string, mixed> $clientOptions
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    public function prompt(): ?string
    {
        return $this->prompt;
    }

    /**
     * @return SystemMessage[]
     */
    public function systemPrompts(): array
    {
        return $this->systemPrompts;
    }

    #[\Override]
    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }

    /**
     * @return array<int, Image>
     */
    public function additionalContent(): array
    {
        return $this->additionalContent;
    }
}



================================================
FILE: src/Images/Response.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Images;

use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

readonly class Response
{
    /**
     * @param  GeneratedImage[]  $images
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        public array $images,
        public Usage $usage,
        public Meta $meta,
        public array $additionalContent = []
    ) {}

    public function firstImage(): ?GeneratedImage
    {
        return $this->images[0] ?? null;
    }

    public function hasImages(): bool
    {
        return $this->images !== [];
    }

    public function imageCount(): int
    {
        return count($this->images);
    }
}



================================================
FILE: src/Images/ResponseBuilder.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Images;

use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

readonly class ResponseBuilder
{
    public function __construct(
        public Usage $usage,
        public Meta $meta,
        /** @var GeneratedImage[] */
        public array $images = [],
        /** @var array<string,mixed> */
        public array $additionalContent = []
    ) {}

    public function toResponse(): Response
    {
        return new Response(
            images: $this->images,
            usage: $this->usage,
            meta: $this->meta,
            additionalContent: $this->additionalContent,
        );
    }
}



================================================
FILE: src/Providers/Provider.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers;

use Generator;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Audio\AudioResponse as TextToSpeechResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as SpeechToTextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Embeddings\Request as EmbeddingsRequest;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Images\Request as ImagesRequest;
use Prism\Prism\Images\Response as ImagesResponse;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

abstract class Provider
{
    public function text(TextRequest $request): TextResponse
    {
        throw PrismException::unsupportedProviderAction('text', class_basename($this));
    }

    public function structured(StructuredRequest $request): StructuredResponse
    {
        throw PrismException::unsupportedProviderAction('structured', class_basename($this));
    }

    public function embeddings(EmbeddingsRequest $request): EmbeddingsResponse
    {
        throw PrismException::unsupportedProviderAction('embeddings', class_basename($this));
    }

    public function images(ImagesRequest $request): ImagesResponse
    {
        throw PrismException::unsupportedProviderAction('images', class_basename($this));
    }

    public function textToSpeech(TextToSpeechRequest $request): TextToSpeechResponse
    {
        throw PrismException::unsupportedProviderAction('textToSpeech', class_basename($this));
    }

    public function speechToText(SpeechToTextRequest $request): SpeechToTextResponse
    {
        throw PrismException::unsupportedProviderAction('speechToText', class_basename($this));
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function stream(TextRequest $request): Generator
    {
        throw PrismException::unsupportedProviderAction(__METHOD__, class_basename($this));
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            413 => throw PrismRequestTooLargeException::make(class_basename($this)),
            429 => throw PrismRateLimitedException::make([]),
            529 => throw PrismProviderOverloadedException::make(class_basename($this)),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }
}



================================================
FILE: src/Providers/Anthropic/Anthropic.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Enums\Provider as ProviderName;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Providers\Anthropic\Concerns\ProcessesRateLimits;
use Prism\Prism\Providers\Anthropic\Handlers\Stream;
use Prism\Prism\Providers\Anthropic\Handlers\Structured;
use Prism\Prism\Providers\Anthropic\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class Anthropic extends Provider
{
    use InitializesClient, ProcessesRateLimits;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $apiVersion,
        public readonly ?string $betaFeatures = null
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            ),
            $request
        );

        return $handler->handle();
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            ),
            $request
        );

        return $handler->handle();
    }

    /**
     * @return Generator<\Prism\Prism\Streaming\Events\StreamEvent>
     */
    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make(
                rateLimits: $this->processRateLimits($e->response),
                retryAfter: $e->response->hasHeader('retry-after')
                    ? (int) $e->response->getHeader('retry-after')[0]
                    : null
            ),
            529 => throw PrismProviderOverloadedException::make(ProviderName::Anthropic),
            413 => throw PrismRequestTooLargeException::make(ProviderName::Anthropic),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->withHeaders(array_filter([
                'x-api-key' => $this->apiKey,
                'anthropic-version' => $this->apiVersion,
                'anthropic-beta' => $this->betaFeatures,
            ]))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? 'https://api.anthropic.com/v1');
    }
}



================================================
FILE: src/Providers/Anthropic/Concerns/ExtractsCitations.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Concerns;

use Illuminate\Support\Arr;
use Prism\Prism\Providers\Anthropic\Maps\CitationsMapper;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

trait ExtractsCitations
{
    /**
     * @param  array<string, mixed>  $data
     * @return array<int, MessagePartWithCitations>|null
     */
    protected function extractCitations(array $data): ?array
    {
        if (data_get($data, 'content.*.citations', []) === []) {
            return null;
        }

        return array_values(Arr::whereNotNull(
            Arr::map(data_get($data, 'content', []), CitationsMapper::mapFromAnthropic(...))
        ));
    }
}



================================================
FILE: src/Providers/Anthropic/Concerns/ExtractsText.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Concerns;

trait ExtractsText
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractText(array $data): string
    {
        return array_reduce(data_get($data, 'content', []), function (string $text, array $content): string {
            if (data_get($content, 'type') === 'text') {
                $text .= data_get($content, 'text');
            }

            return $text;
        }, '');
    }
}



================================================
FILE: src/Providers/Anthropic/Concerns/ExtractsThinking.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Concerns;

use Illuminate\Support\Arr;

trait ExtractsThinking
{
    /**
     * @param  array<string, mixed>  $data
     * @return array<string, mixed>
     */
    protected function extractThinking(array $data): array
    {
        if ($this->request->providerOptions('thinking.enabled') !== true) {
            return [];
        }

        $thinking = Arr::first(
            data_get($data, 'content', []),
            fn ($content): bool => data_get($content, 'type') === 'thinking'
        );

        return [
            'thinking' => data_get($thinking, 'thinking'),
            'thinking_signature' => data_get($thinking, 'signature'),
        ];
    }
}



================================================
FILE: src/Providers/Anthropic/Concerns/HandlesHttpRequests.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\Exceptions\PrismException;

trait HandlesHttpRequests
{
    protected Response $httpResponse;

    /**
     * @return array<string, mixed>
     */
    abstract public static function buildHttpRequestPayload(PrismRequest $request): array;

    protected function sendRequest(): void
    {
        $this->httpResponse = $this->client->post(
            'messages',
            static::buildHttpRequestPayload($this->request)
        );

        $this->handleResponseErrors();
    }

    protected function handleResponseErrors(): void
    {
        $data = $this->httpResponse->json();

        if (data_get($data, 'type') === 'error') {
            throw PrismException::providerResponseError(vsprintf(
                'Anthropic Error: [%s] %s',
                [
                    data_get($data, 'error.type', 'unknown'),
                    data_get($data, 'error.message'),
                ]
            ));
        }
    }
}



================================================
FILE: src/Providers/Anthropic/Concerns/ProcessesRateLimits.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Concerns;

use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Carbon;
use Illuminate\Support\Str;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ProcessesRateLimits
{
    /**
     * @return array<int, ProviderRateLimit>
     */
    protected function processRateLimits(Response $response): array
    {
        $rate_limits = [];

        foreach ($response->getHeaders() as $headerName => $headerValues) {
            if (Str::startsWith($headerName, 'anthropic-ratelimit-') === false) {
                continue;
            }

            $limit_name = Str::of($headerName)->after('anthropic-ratelimit-')->beforeLast('-')->toString();
            $field_name = Str::of($headerName)->afterLast('-')->toString();
            $rate_limits[$limit_name][$field_name] = $headerValues[0];
        }

        return array_values(Arr::map($rate_limits, function ($fields, $limit_name): ProviderRateLimit {
            $resets_at = data_get($fields, 'reset');

            return new ProviderRateLimit(
                name: $limit_name,
                limit: data_get($fields, 'limit') !== null
                    ? (int) data_get($fields, 'limit')
                    : null,
                remaining: data_get($fields, 'remaining') !== null
                    ? (int) data_get($fields, 'remaining')
                    : null,
                resetsAt: data_get($fields, 'reset') !== null ? new Carbon($resets_at) : null
            );
        }));
    }
}



================================================
FILE: src/Providers/Anthropic/Enums/AnthropicCacheType.php
================================================
<?php

namespace Prism\Prism\Providers\Anthropic\Enums;

enum AnthropicCacheType: string
{
    case Ephemeral = 'ephemeral';
}



================================================
FILE: src/Providers/Anthropic/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\Anthropic\Maps\CitationsMapper;
use Prism\Prism\Providers\Anthropic\ValueObjects\AnthropicStreamState;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\CitationEvent;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools;

    protected AnthropicStreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new AnthropicStreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $this->state->reset();
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        while (! $response->getBody()->eof()) {
            $event = $this->parseNextSSEEvent($response->getBody());

            if ($event === null) {
                continue;
            }

            $streamEvent = $this->processEvent($event);

            if ($streamEvent instanceof Generator) {
                yield from $streamEvent;
            } elseif ($streamEvent instanceof StreamEvent) {
                yield $streamEvent;
            }
        }

        // Handle tool calls if present
        if ($this->state->hasToolCalls()) {
            yield from $this->handleToolCalls($request, $depth);
        }
    }

    /**
     * @param  array<string, mixed>  $event
     * @return StreamEvent|Generator<StreamEvent>|null
     */
    protected function processEvent(array $event): StreamEvent|Generator|null
    {
        return match ($event['type'] ?? null) {
            'message_start' => $this->handleMessageStart($event),
            'content_block_start' => $this->handleContentBlockStart($event),
            'content_block_delta' => $this->handleContentBlockDelta($event),
            'content_block_stop' => $this->handleContentBlockStop($event),
            'message_delta' => $this->handleMessageDelta($event),
            'message_stop' => $this->handleMessageStop($event),
            'error' => $this->handleError($event),
            'ping' => null, // Ignore ping events
            default => null,
        };
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleMessageStart(array $event): StreamStartEvent
    {
        $message = $event['message'] ?? [];
        $this->state->withMessageId($message['id'] ?? EventID::generate());

        // Capture initial usage data
        $usageData = $message['usage'] ?? [];
        if (! empty($usageData)) {
            $this->state->withUsage(new Usage(
                promptTokens: $usageData['input_tokens'] ?? 0,
                completionTokens: $usageData['output_tokens'] ?? 0,
                cacheWriteInputTokens: $usageData['cache_creation_input_tokens'] ?? null,
                cacheReadInputTokens: $usageData['cache_read_input_tokens'] ?? null
            ));
        }

        return new StreamStartEvent(
            id: EventID::generate(),
            timestamp: time(),
            model: $message['model'] ?? 'unknown',
            provider: 'anthropic'
        );
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleContentBlockStart(array $event): ?StreamEvent
    {
        $contentBlock = $event['content_block'] ?? [];
        $this->state->withBlockContext(
            $event['index'] ?? 0,
            $contentBlock['type'] ?? ''
        );

        return match ($this->state->currentBlockType()) {
            'text' => new TextStartEvent(
                id: EventID::generate(),
                timestamp: time(),
                messageId: $this->state->messageId()
            ),
            'thinking' => $this->handleThinkingStart(),
            'tool_use' => $this->handleToolUseStart($contentBlock),
            default => null,
        };
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleContentBlockDelta(array $event): ?StreamEvent
    {
        $delta = $event['delta'] ?? [];
        $deltaType = $delta['type'] ?? null;

        return match ([$this->state->currentBlockType(), $deltaType]) {
            ['text', 'text_delta'] => $this->handleTextDelta($delta),
            ['text', 'citations_delta'] => $this->handleCitationsDelta($delta),
            ['thinking', 'thinking_delta'] => $this->handleThinkingDelta($delta),
            ['thinking', 'signature_delta'] => $this->handleSignatureDelta($delta),
            ['tool_use', 'input_json_delta'] => $this->handleToolInputDelta($delta),
            default => null,
        };
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleContentBlockStop(array $event): ?StreamEvent
    {
        $result = match ($this->state->currentBlockType()) {
            'text' => new TextCompleteEvent(
                id: EventID::generate(),
                timestamp: time(),
                messageId: $this->state->messageId()
            ),
            'thinking' => new ThinkingCompleteEvent(
                id: EventID::generate(),
                timestamp: time(),
                reasoningId: $this->state->reasoningId()
            ),
            'tool_use' => $this->handleToolUseComplete(),
            default => null,
        };

        $this->state->resetBlockContext();

        return $result;
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleMessageDelta(array $event): null
    {
        // Update usage with final data from message_delta
        $usageData = $event['usage'] ?? [];
        // Update completion tokens if provided
        if (! empty($usageData) && $this->state->usage() instanceof Usage && isset($usageData['output_tokens'])) {
            $currentUsage = $this->state->usage();
            $this->state->withUsage(new Usage(
                promptTokens: $currentUsage->promptTokens,
                completionTokens: $usageData['output_tokens'],
                cacheWriteInputTokens: $currentUsage->cacheWriteInputTokens,
                cacheReadInputTokens: $currentUsage->cacheReadInputTokens
            ));
        }

        return null;
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleMessageStop(array $event): StreamEndEvent
    {
        return new StreamEndEvent(
            id: EventID::generate(),
            timestamp: time(),
            finishReason: FinishReason::Stop, // Default, will be updated by message_delta
            usage: $this->state->usage(),
            citations: $this->state->citations() !== [] ? $this->state->citations() : null
        );
    }

    /**
     * @param  array<string, mixed>  $event
     */
    protected function handleError(array $event): ErrorEvent
    {
        return new ErrorEvent(
            id: EventID::generate(),
            timestamp: time(),
            errorType: $event['error']['type'] ?? 'unknown_error',
            message: $event['error']['message'] ?? 'Unknown error occurred',
            recoverable: true
        );
    }

    protected function handleThinkingStart(): ThinkingStartEvent
    {
        $this->state->withReasoningId(EventID::generate());

        return new ThinkingStartEvent(
            id: EventID::generate(),
            timestamp: time(),
            reasoningId: $this->state->reasoningId()
        );
    }

    /**
     * @param  array<string, mixed>  $delta
     */
    protected function handleTextDelta(array $delta): ?TextDeltaEvent
    {
        $text = $delta['text'] ?? '';

        if ($text === '') {
            return null;
        }

        $this->state->appendText($text);

        return new TextDeltaEvent(
            id: EventID::generate(),
            timestamp: time(),
            delta: $text,
            messageId: $this->state->messageId()
        );
    }

    /**
     * @param  array<string, mixed>  $delta
     */
    protected function handleCitationsDelta(array $delta): ?CitationEvent
    {
        $citationData = $delta['citation'] ?? null;

        if ($citationData === null) {
            return null;
        }

        // Map citation data using CitationsMapper
        $citation = CitationsMapper::mapCitationFromAnthropic($citationData);

        // Create MessagePartWithCitations for aggregation
        $messagePartWithCitations = new MessagePartWithCitations(
            outputText: $this->state->currentText(),
            citations: [$citation]
        );

        // Store for later aggregation
        $this->state->addCitation($messagePartWithCitations);

        return new CitationEvent(
            id: EventID::generate(),
            timestamp: time(),
            citation: $citation,
            messageId: $this->state->messageId(),
            blockIndex: $this->state->currentBlockIndex()
        );
    }

    /**
     * @param  array<string, mixed>  $delta
     */
    protected function handleThinkingDelta(array $delta): ?ThinkingEvent
    {
        $thinking = $delta['thinking'] ?? '';

        if ($thinking === '') {
            return null;
        }

        $this->state->appendThinking($thinking);

        return new ThinkingEvent(
            id: EventID::generate(),
            timestamp: time(),
            delta: $thinking,
            reasoningId: $this->state->reasoningId()
        );
    }

    /**
     * @param  array<string, mixed>  $delta
     */
    protected function handleSignatureDelta(array $delta): null
    {
        $this->state->appendThinkingSignature($delta['signature'] ?? '');

        return null;
    }

    /**
     * @param  array<string, mixed>  $contentBlock
     */
    protected function handleToolUseStart(array $contentBlock): null
    {
        if ($this->state->currentBlockIndex() !== null) {
            $this->state->addToolCall($this->state->currentBlockIndex(), [
                'id' => $contentBlock['id'] ?? EventID::generate(),
                'name' => $contentBlock['name'] ?? 'unknown',
                'input' => '',
            ]);
        }

        return null;
    }

    /**
     * @param  array<string, mixed>  $delta
     */
    protected function handleToolInputDelta(array $delta): null
    {
        $partialJson = $delta['partial_json'] ?? '';

        if ($this->state->currentBlockIndex() !== null && isset($this->state->toolCalls()[$this->state->currentBlockIndex()])) {
            $this->state->appendToolCallInput($this->state->currentBlockIndex(), $partialJson);
        }

        return null;
    }

    protected function handleToolUseComplete(): ?ToolCallEvent
    {
        if ($this->state->currentBlockIndex() === null || ! isset($this->state->toolCalls()[$this->state->currentBlockIndex()])) {
            return null;
        }

        $toolCall = $this->state->toolCalls()[$this->state->currentBlockIndex()];
        $input = $toolCall['input'];

        // Parse the JSON input
        if (is_string($input) && json_validate($input)) {
            $input = json_decode($input, true);
        } elseif (is_string($input) && $input !== '') {
            // If it's not valid JSON but not empty, wrap in array
            $input = ['input' => $input];
        } else {
            $input = [];
        }

        $toolCallObj = new ToolCall(
            id: $toolCall['id'],
            name: $toolCall['name'],
            arguments: $input,
            reasoningId: $this->state->reasoningId() !== '' ? $this->state->reasoningId() : null
        );

        return new ToolCallEvent(
            id: EventID::generate(),
            timestamp: time(),
            toolCall: $toolCallObj,
            messageId: $this->state->messageId()
        );
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(Request $request, int $depth): Generator
    {
        $toolCalls = [];

        // Convert tool calls to ToolCall objects
        foreach ($this->state->toolCalls() as $toolCallData) {
            $input = $toolCallData['input'];
            if (is_string($input) && json_validate($input)) {
                $input = json_decode($input, true);
            } elseif (is_string($input) && $input !== '') {
                $input = ['input' => $input];
            } else {
                $input = [];
            }

            $toolCalls[] = new ToolCall(
                id: $toolCallData['id'],
                name: $toolCallData['name'],
                arguments: $input
            );
        }

        // Execute tools and emit results
        $toolResults = [];
        foreach ($toolCalls as $toolCall) {
            try {
                $tool = $this->resolveTool($toolCall->name, $request->tools());
                $result = call_user_func_array($tool->handle(...), $toolCall->arguments());

                $toolResult = new ToolResult(
                    toolCallId: $toolCall->id,
                    toolName: $toolCall->name,
                    args: $toolCall->arguments(),
                    result: $result
                );

                $toolResults[] = $toolResult;

                yield new ToolResultEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    toolResult: $toolResult,
                    messageId: $this->state->messageId(),
                    success: true
                );
            } catch (Throwable $e) {
                $errorResultObj = new ToolResult(
                    toolCallId: $toolCall->id,
                    toolName: $toolCall->name,
                    args: $toolCall->arguments(),
                    result: []
                );

                yield new ToolResultEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    toolResult: $errorResultObj,
                    messageId: $this->state->messageId(),
                    success: false,
                    error: $e->getMessage()
                );
            }
        }

        // Add messages to request for next turn
        if ($toolResults !== []) {
            $request->addMessage(new AssistantMessage(
                content: $this->state->currentText(),
                toolCalls: $toolCalls
            ));

            $request->addMessage(new ToolResultMessage($toolResults));

            // Continue streaming if within step limit
            $depth++;
            if ($depth < $request->maxSteps()) {
                $this->state->reset();
                $nextResponse = $this->sendRequest($request);
                yield from $this->processStream($nextResponse, $request, $depth);
            }
        }
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseNextSSEEvent(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);
        $line = trim($line);

        if ($line === '' || $line === '0') {
            return null;
        }

        if (str_starts_with($line, 'event:')) {
            return $this->parseEventChunk($line, $stream);
        }

        if (str_starts_with($line, 'data:')) {
            return $this->parseDataChunk($line);
        }

        return null;
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseEventChunk(string $line, StreamInterface $stream): ?array
    {
        $eventType = trim(substr($line, strlen('event:')));

        if ($eventType === 'ping') {
            return ['type' => 'ping'];
        }

        $dataLine = $this->readLine($stream);
        $dataLine = trim($dataLine);

        if ($dataLine === '' || $dataLine === '0' || ! str_starts_with($dataLine, 'data:')) {
            return ['type' => $eventType];
        }

        return $this->parseJsonData($dataLine, $eventType);
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseDataChunk(string $line): ?array
    {
        $jsonData = trim(substr($line, strlen('data:')));

        if ($jsonData === '' || $jsonData === '0' || str_contains($jsonData, 'DONE')) {
            return null;
        }

        return $this->parseJsonData($jsonData);
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseJsonData(string $jsonDataLine, ?string $eventType = null): ?array
    {
        $jsonData = trim(str_starts_with($jsonDataLine, 'data:')
            ? substr($jsonDataLine, strlen('data:'))
            : $jsonDataLine);

        if ($jsonData === '' || $jsonData === '0') {
            return $eventType ? ['type' => $eventType] : null;
        }

        try {
            $data = json_decode($jsonData, true, flags: JSON_THROW_ON_ERROR);

            if ($eventType) {
                $data['type'] = $eventType;
            }

            return $data;
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Anthropic', $e);
        }
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    protected function sendRequest(Request $request): Response
    {
        return $this->client
            ->withOptions(['stream' => true])
            ->post('messages', Arr::whereNotNull([
                'stream' => true,
                ...Text::buildHttpRequestPayload($request),
            ]));
    }
}



================================================
FILE: src/Providers/Anthropic/Handlers/Structured.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Illuminate\Support\Collection;
use InvalidArgumentException;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsCitations;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsText;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsThinking;
use Prism\Prism\Providers\Anthropic\Concerns\HandlesHttpRequests;
use Prism\Prism\Providers\Anthropic\Concerns\ProcessesRateLimits;
use Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies\AnthropicStructuredStrategy;
use Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies\JsonModeStructuredStrategy;
use Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies\ToolStructuredStrategy;
use Prism\Prism\Providers\Anthropic\Maps\FinishReasonMap;
use Prism\Prism\Providers\Anthropic\Maps\MessageMap;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use ExtractsCitations, ExtractsText, ExtractsThinking, HandlesHttpRequests, ProcessesRateLimits;

    protected Response $tempResponse;

    protected ResponseBuilder $responseBuilder;

    protected AnthropicStructuredStrategy $strategy;

    public function __construct(protected PendingRequest $client, protected StructuredRequest $request)
    {
        $this->responseBuilder = new ResponseBuilder;

        $this->strategy = $this->request->providerOptions('use_tool_calling') === true
            ? new ToolStructuredStrategy(request: $request)
            : new JsonModeStructuredStrategy(request: $request);
    }

    public function handle(): Response
    {
        $this->strategy->appendMessages();

        $this->sendRequest();

        $this->prepareTempResponse();

        $responseMessage = new AssistantMessage(
            content: $this->tempResponse->text,
            additionalContent: $this->tempResponse->additionalContent
        );

        $this->request->addMessage($responseMessage);

        $this->responseBuilder->addStep(new Step(
            text: $this->tempResponse->text,
            finishReason: $this->tempResponse->finishReason,
            usage: $this->tempResponse->usage,
            meta: $this->tempResponse->meta,
            messages: $this->request->messages(),
            systemPrompts: $this->request->systemPrompts(),
            additionalContent: $this->tempResponse->additionalContent,
            structured: $this->tempResponse->structured ?? [],
        ));

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  StructuredRequest  $request
     * @return array<string, mixed>
     */
    #[\Override]
    public static function buildHttpRequestPayload(PrismRequest $request): array
    {
        if (! $request->is(StructuredRequest::class)) {
            throw new InvalidArgumentException('Request must be an instance of '.StructuredRequest::class);
        }

        $structuredStrategy = $request->providerOptions('use_tool_calling') === true
            ? new ToolStructuredStrategy(request: $request)
            : new JsonModeStructuredStrategy(request: $request);

        $basePayload = Arr::whereNotNull([
            'model' => $request->model(),
            'messages' => MessageMap::map($request->messages(), $request->providerOptions()),
            'system' => MessageMap::mapSystemMessages($request->systemPrompts()) ?: null,
            'thinking' => $request->providerOptions('thinking.enabled') === true
                ? [
                    'type' => 'enabled',
                    'budget_tokens' => is_int($request->providerOptions('thinking.budgetTokens'))
                        ? $request->providerOptions('thinking.budgetTokens')
                        : config('prism.anthropic.default_thinking_budget', 1024),
                ]
                : null,
            'max_tokens' => $request->maxTokens(),
            'temperature' => $request->temperature(),
            'top_p' => $request->topP(),
            'mcp_servers' => $request->providerOptions('mcp_servers'),
        ]);

        return $structuredStrategy->mutatePayload($basePayload);
    }

    protected function prepareTempResponse(): void
    {
        $data = $this->httpResponse->json();

        $baseResponse = new Response(
            steps: new Collection,
            text: $this->extractText($data),
            structured: [],
            finishReason: FinishReasonMap::map(data_get($data, 'stop_reason', '')),
            usage: new Usage(
                promptTokens: data_get($data, 'usage.input_tokens'),
                completionTokens: data_get($data, 'usage.output_tokens'),
                cacheWriteInputTokens: data_get($data, 'usage.cache_creation_input_tokens', null),
                cacheReadInputTokens: data_get($data, 'usage.cache_read_input_tokens', null)
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($this->httpResponse)
            ),
            additionalContent: Arr::whereNotNull([
                'citations' => $this->extractCitations($data),
                ...$this->extractThinking($data),
            ])
        );

        $this->tempResponse = $this->strategy->mutateResponse($this->httpResponse, $baseResponse);
    }
}



================================================
FILE: src/Providers/Anthropic/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Illuminate\Support\Collection;
use InvalidArgumentException;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsCitations;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsText;
use Prism\Prism\Providers\Anthropic\Concerns\ExtractsThinking;
use Prism\Prism\Providers\Anthropic\Concerns\HandlesHttpRequests;
use Prism\Prism\Providers\Anthropic\Concerns\ProcessesRateLimits;
use Prism\Prism\Providers\Anthropic\Maps\FinishReasonMap;
use Prism\Prism\Providers\Anthropic\Maps\MessageMap;
use Prism\Prism\Providers\Anthropic\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Anthropic\Maps\ToolMap;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ProviderTool;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools, ExtractsCitations, ExtractsText, ExtractsThinking, HandlesHttpRequests, ProcessesRateLimits;

    protected Response $tempResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client, protected TextRequest $request)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(): Response
    {
        $this->sendRequest();

        $this->prepareTempResponse();

        $responseMessage = new AssistantMessage(
            $this->tempResponse->text,
            $this->tempResponse->toolCalls,
            $this->tempResponse->additionalContent,
        );

        $this->request->addMessage($responseMessage);

        return match ($this->tempResponse->finishReason) {
            FinishReason::ToolCalls => $this->handleToolCalls(),
            FinishReason::Stop, FinishReason::Length => $this->handleStop(),
            default => throw new PrismException('Anthropic: unknown finish reason'),
        };
    }

    /**
     * @param  TextRequest  $request
     * @return array<string, mixed>
     */
    #[\Override]
    public static function buildHttpRequestPayload(PrismRequest $request): array
    {
        if (! $request->is(TextRequest::class)) {
            throw new InvalidArgumentException('Request must be an instance of '.TextRequest::class);
        }

        return Arr::whereNotNull([
            'model' => $request->model(),
            'system' => MessageMap::mapSystemMessages($request->systemPrompts()) ?: null,
            'messages' => MessageMap::map($request->messages(), $request->providerOptions()),
            'thinking' => $request->providerOptions('thinking.enabled') === true
                ? [
                    'type' => 'enabled',
                    'budget_tokens' => is_int($request->providerOptions('thinking.budgetTokens'))
                        ? $request->providerOptions('thinking.budgetTokens')
                        : config('prism.anthropic.default_thinking_budget', 1024),
                ]
                : null,
            'max_tokens' => $request->maxTokens(),
            'temperature' => $request->temperature(),
            'top_p' => $request->topP(),
            'tools' => static::buildTools($request) ?: null,
            'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            'mcp_servers' => $request->providerOptions('mcp_servers'),
        ]);
    }

    protected function handleToolCalls(): Response
    {
        $toolResults = $this->callTools($this->request->tools(), $this->tempResponse->toolCalls);
        $message = new ToolResultMessage($toolResults);

        // Apply tool result caching if configured
        if ($tool_result_cache_type = $this->request->providerOptions('tool_result_cache_type')) {
            $message->withProviderOptions(['cacheType' => $tool_result_cache_type]);
        }

        $this->request->addMessage($message);

        $this->addStep($toolResults);

        if ($this->responseBuilder->steps->count() < $this->request->maxSteps()) {
            return $this->handle();
        }

        return $this->responseBuilder->toResponse();
    }

    protected function handleStop(): Response
    {
        $this->addStep();

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: $this->tempResponse->text,
            finishReason: $this->tempResponse->finishReason,
            toolCalls: $this->tempResponse->toolCalls,
            toolResults: $toolResults,
            usage: $this->tempResponse->usage,
            meta: $this->tempResponse->meta,
            messages: $this->request->messages(),
            systemPrompts: $this->request->systemPrompts(),
            additionalContent: $this->tempResponse->additionalContent,
        ));
    }

    protected function prepareTempResponse(): void
    {
        $data = $this->httpResponse->json();

        $this->tempResponse = new Response(
            steps: new Collection,
            text: $this->extractText($data),
            finishReason: FinishReasonMap::map(data_get($data, 'stop_reason', '')),
            toolCalls: $this->extractToolCalls($data),
            toolResults: [],
            usage: new Usage(
                promptTokens: data_get($data, 'usage.input_tokens'),
                completionTokens: data_get($data, 'usage.output_tokens'),
                cacheWriteInputTokens: data_get($data, 'usage.cache_creation_input_tokens'),
                cacheReadInputTokens: data_get($data, 'usage.cache_read_input_tokens')
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($this->httpResponse)
            ),
            messages: new Collection,
            additionalContent: Arr::whereNotNull([
                'citations' => $this->extractCitations($data),
                ...$this->extractThinking($data),
            ])
        );
    }

    /**
     * @return array<int|string,mixed>
     */
    protected static function buildTools(TextRequest $request): array
    {
        $tools = ToolMap::map($request->tools());

        if ($request->providerTools() === []) {
            return $tools;
        }

        $providerTools = array_map(
            fn (ProviderTool $tool): array => [
                'type' => $tool->type,
                'name' => $tool->name,
            ],
            $request->providerTools()
        );

        return array_merge($providerTools, $tools);
    }

    /**
     * @param  array<string, mixed>  $data
     * @return ToolCall[]
     */
    protected function extractToolCalls(array $data): array
    {
        $toolCalls = [];
        $contents = data_get($data, 'content', []);

        foreach ($contents as $content) {
            if (data_get($content, 'type') === 'tool_use') {
                $toolCalls[] = new ToolCall(
                    id: data_get($content, 'id'),
                    name: data_get($content, 'name'),
                    arguments: data_get($content, 'input')
                );
            }
        }

        return $toolCalls;
    }
}



================================================
FILE: src/Providers/Anthropic/Handlers/StructuredStrategies/AnthropicStructuredStrategy.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies;

use Illuminate\Http\Client\Response as HttpResponse;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as PrismResponse;

abstract class AnthropicStructuredStrategy
{
    public function __construct(
        protected Request $request
    ) {
        $this->checkStrategySupport();
    }

    abstract public function appendMessages(): void;

    /**
     * @param  array<string, mixed>  $payload
     * @return array<string, mixed>
     */
    abstract public function mutatePayload(array $payload): array;

    abstract public function mutateResponse(HttpResponse $httpResponse, PrismResponse $prismResponse): PrismResponse;

    abstract protected function checkStrategySupport(): void;
}



================================================
FILE: src/Providers/Anthropic/Handlers/StructuredStrategies/JsonModeStructuredStrategy.php
================================================
<?php

namespace Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies;

use Illuminate\Http\Client\Response as HttpResponse;
use Prism\Prism\Structured\Response as PrismResponse;
use Prism\Prism\ValueObjects\Messages\UserMessage;

class JsonModeStructuredStrategy extends AnthropicStructuredStrategy
{
    public function appendMessages(): void
    {
        $this->request->addMessage(new UserMessage(sprintf(
            "Respond with ONLY JSON (i.e. not in backticks or a code block, with NO CONTENT outside the JSON) that matches the following schema: \n %s %s",
            json_encode($this->request->schema()->toArray(), JSON_PRETTY_PRINT),
            ($this->request->providerOptions()['citations'] ?? false)
                ? "\n\n Return the JSON as a single text block with a single set of citations."
                : ''
        )));
    }

    /**
     * @param  array<string, mixed>  $payload
     * @return array<string, mixed>
     */
    public function mutatePayload(array $payload): array
    {
        return $payload;
    }

    public function mutateResponse(HttpResponse $httpResponse, PrismResponse $prismResponse): PrismResponse
    {
        return $prismResponse;
    }

    protected function checkStrategySupport(): void {}
}



================================================
FILE: src/Providers/Anthropic/Handlers/StructuredStrategies/ToolStructuredStrategy.php
================================================
<?php

namespace Prism\Prism\Providers\Anthropic\Handlers\StructuredStrategies;

use Illuminate\Http\Client\Response as HttpResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Structured\Response as PrismResponse;
use Prism\Prism\ValueObjects\Messages\UserMessage;

class ToolStructuredStrategy extends AnthropicStructuredStrategy
{
    public function appendMessages(): void
    {
        if ($this->request->providerOptions('thinking.enabled') === false) {
            return;
        }

        $this->request->addMessage(new UserMessage(sprintf(
            "Please use the output_structured_data tool to provide your response. If for any reason you cannot use the tool, respond with ONLY JSON (i.e. not in backticks or a code block, with NO CONTENT outside the JSON) that matches the following schema: \n %s",
            json_encode($this->request->schema()->toArray(), JSON_PRETTY_PRINT)
        )));
    }

    /**
     * @param  array<string, mixed>  $payload
     * @return array<string, mixed>
     */
    public function mutatePayload(array $payload): array
    {
        $schemaArray = $this->request->schema()->toArray();

        $payload = [
            ...$payload,
            'tools' => [
                [
                    'name' => 'output_structured_data',
                    'description' => 'Output data in the requested structure',
                    'input_schema' => [
                        'type' => 'object',
                        'properties' => $schemaArray['properties'],
                        'required' => $schemaArray['required'] ?? [],
                        'additionalProperties' => false,
                    ],
                ],
            ],
        ];

        if ($this->request->providerOptions('thinking.enabled') !== true) {
            $payload['tool_choice'] = ['type' => 'tool', 'name' => 'output_structured_data'];
        }

        return $payload;
    }

    public function mutateResponse(HttpResponse $httpResponse, PrismResponse $prismResponse): PrismResponse
    {
        $structured = [];
        $additionalContent = $prismResponse->additionalContent;

        $data = $httpResponse->json();

        $toolCalls = array_values(array_filter(
            data_get($data, 'content', []),
            fn ($content): bool => data_get($content, 'type') === 'tool_use' && data_get($content, 'name') === 'output_structured_data'
        ));

        $structured = data_get($toolCalls, '0.input', []);

        return new PrismResponse(
            steps: $prismResponse->steps,
            text: $prismResponse->text,
            structured: $structured,
            finishReason: $prismResponse->finishReason,
            usage: $prismResponse->usage,
            meta: $prismResponse->meta,
            additionalContent: $additionalContent
        );
    }

    protected function checkStrategySupport(): void
    {
        if ($this->request->providerOptions('citations') === true) {
            throw new PrismException(
                'Citations are not supported with tool calling mode. Please set use_tool_calling to false in provider options to use citations.'
            );
        }
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/CitationsMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Maps;

use Illuminate\Support\Arr;
use InvalidArgumentException;
use Prism\Prism\Enums\Citations\CitationSourcePositionType;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

class CitationsMapper
{
    /**
     * @param  array<string, mixed>  $contentBlock
     */
    public static function mapFromAnthropic(array $contentBlock): ?MessagePartWithCitations
    {
        if (! isset($contentBlock['type']) || $contentBlock['type'] !== 'text') {
            return null;
        }

        $citations = array_map(
            self::mapCitationFromAnthropic(...),
            $contentBlock['citations'] ?? []
        );

        return new MessagePartWithCitations(
            outputText: $contentBlock['text'] ?? '',
            citations: $citations,
        );
    }

    /**
     * Convert MessagePartWithCitations back to Anthropic API format
     *
     * @return array<string, mixed>
     */
    public static function mapToAnthropic(MessagePartWithCitations $messagePartWithCitations): array
    {
        $citations = array_map(
            self::mapCitationToAnthropic(...),
            $messagePartWithCitations->citations
        );

        return array_filter([
            'type' => 'text',
            'text' => $messagePartWithCitations->outputText,
            'citations' => $citations ?: null,
        ]);
    }

    /**
     * @param  array<string, mixed>  $citationData
     */
    public static function mapCitationFromAnthropic(array $citationData): Citation
    {
        $sourceType = self::mapSourceType($citationData['type']);
        $source = self::mapSource($citationData, $sourceType);
        $sourcePositionType = self::mapSourcePositionType($citationData['type']);

        $indices = self::mapIndices($citationData);
        $startIndex = $indices['start'] ?? null;
        $endIndex = $indices['end'] ?? null;

        return new Citation(
            sourceType: $sourceType,
            source: $source,
            sourceText: $citationData['cited_text'] ?? null,
            sourceTitle: $citationData['document_title'] ?? $citationData['title'] ?? null,
            sourcePositionType: $sourcePositionType,
            sourceStartIndex: $startIndex,
            sourceEndIndex: $endIndex,
            additionalContent: Arr::whereNotNull([
                'encrypted_index' => data_get($citationData, 'encrypted_index'),
            ])
        );
    }

    protected static function mapSourceType(string $anthropicType): CitationSourceType
    {
        return match ($anthropicType) {
            'web_search_result_location' => CitationSourceType::Url,
            'page_location', 'char_location', 'content_block_location' => CitationSourceType::Document,
            default => throw new InvalidArgumentException("Unknown citation type: {$anthropicType}"),
        };
    }

    /**
     * @param  array<string, mixed>  $citationData
     */
    protected static function mapSource(array $citationData, CitationSourceType $sourceType): string|int
    {
        if ($sourceType === CitationSourceType::Url) {
            return $citationData['url'] ?? '';
        }

        return $citationData['document_index'] ?? 0;
    }

    protected static function mapSourcePositionType(string $anthropicType): ?CitationSourcePositionType
    {
        return match ($anthropicType) {
            'page_location' => CitationSourcePositionType::Page,
            'char_location' => CitationSourcePositionType::Character,
            'content_block_location' => CitationSourcePositionType::Chunk,
            'web_search_result_location' => null,
            default => null,
        };
    }

    /**
     * @param  array<string, mixed>  $citationData
     * @return array{start:int|null,end:int|null}
     */
    protected static function mapIndices(array $citationData): array
    {
        $indexPropertyCommonPart = match ($citationData['type']) {
            'page_location' => 'page_number',
            'char_location' => 'char_index',
            'content_block_location' => 'block_index',
            'web_search_result_location' => null,
            default => null,
        };

        if ($indexPropertyCommonPart === null) {
            return ['start' => null, 'end' => null];
        }

        return [
            'start' => $citationData["start_$indexPropertyCommonPart"] ?? null,
            'end' => $citationData["end_$indexPropertyCommonPart"] ?? null,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected static function mapCitationToAnthropic(Citation $citation): array
    {
        $anthropicType = self::mapSourcePositionTypeToAnthropic($citation->sourcePositionType);
        $indices = self::mapIndicesToAnthropic($citation, $anthropicType);

        $result = [
            'type' => $anthropicType,
            'cited_text' => $citation->sourceText,
        ];

        // Add document_index or url based on source type
        if ($citation->sourceType === CitationSourceType::Document) {
            $result['document_index'] = $citation->source;

            $result['document_title'] = $citation->sourceTitle;
        }
        if ($citation->sourceType === CitationSourceType::Url) {
            $result['url'] = $citation->source;

            $result['title'] = $citation->sourceTitle;
        }

        if ($index = data_get($citation->additionalContent, 'encrypted_index')) {
            $result['encrypted_index'] = $index;
        }

        $result = array_merge($result, $indices);

        return array_filter($result, fn ($value): bool => $value !== null && $value !== '');
    }

    protected static function mapSourcePositionTypeToAnthropic(?CitationSourcePositionType $sourcePositionType): string
    {
        return match ($sourcePositionType) {
            CitationSourcePositionType::Page => 'page_location',
            CitationSourcePositionType::Character => 'char_location',
            CitationSourcePositionType::Chunk => 'content_block_location',
            null => 'web_search_result_location',
        };
    }

    /**
     * @return array<string, mixed>
     */
    protected static function mapIndicesToAnthropic(Citation $citation, string $anthropicType): array
    {
        $indexPropertyCommonPart = match ($anthropicType) {
            'page_location' => 'page_number',
            'char_location' => 'char_index',
            'content_block_location' => 'block_index',
            'web_search_result_location' => null,
            default => null,
        };

        if ($indexPropertyCommonPart === null) {
            return [];
        }

        return array_filter([
            "start_$indexPropertyCommonPart" => $citation->sourceStartIndex,
            "end_$indexPropertyCommonPart" => $citation->sourceEndIndex,
        ], fn (?int $value): bool => $value !== null);
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/DocumentMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Anthropic\Maps;

use Illuminate\Support\Str;
use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Media;

class DocumentMapper extends ProviderMediaMapper
{
    /**
     * @param  Document  $media
     * @param  array<string, mixed>  $cacheControl
     * @param  array<string, mixed>  $requestProviderOptions
     */
    public function __construct(
        public readonly Media $media,
        public ?array $cacheControl = null,
        public array $requestProviderOptions = [],
    ) {
        $this->runValidation();
    }

    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $providerOptions = $this->media->providerOptions();

        $payload = [
            'type' => 'document',
            'title' => $this->media->documentTitle(),
            'context' => $providerOptions['context'] ?? null,
            'cache_control' => $this->cacheControl,
            'citations' => data_get($this->requestProviderOptions, 'citations', data_get($providerOptions, 'citations', false))
                ? ['enabled' => true]
                : null,
        ];

        if ($this->media->isFileId()) {
            $payload['source'] = [
                'type' => 'file',
                'file_id' => $this->media->fileId(),
            ];
        } elseif ($this->media->isUrl()) {
            $payload['source'] = [
                'type' => 'url',
                'url' => $this->media->url(),
            ];
        } elseif ($this->media->isChunks()) {
            $payload['source'] = [
                'type' => 'content',
                'content' => array_map(fn (string $chunk): array => ['type' => 'text', 'text' => $chunk], $this->media->chunks() ?? []),
            ];
        } elseif ($this->media->mimeType() && Str::startsWith($this->media->mimeType(), 'text/')) {
            $payload['source'] = [
                'type' => 'text',
                'media_type' => $this->media->mimeType(),
                'data' => $this->media->rawContent(),
            ];
        } else {
            $payload['source'] = [
                'type' => 'base64',
                'media_type' => $this->media->mimeType(),
                'data' => $this->media->base64(),
            ];
        }

        return array_filter($payload);
    }

    protected function provider(): string|Provider
    {
        return Provider::Anthropic;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isFileId()) {
            return true;
        }

        if ($this->media->isUrl()) {
            return true;
        }

        if ($this->media->isChunks()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $reason): FinishReason
    {
        return match ($reason) {
            'end_turn', 'stop_sequence' => FinishReason::Stop,
            'tool_use' => FinishReason::ToolCalls,
            'max_tokens' => FinishReason::Length,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Anthropic\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Media;

class ImageMapper extends ProviderMediaMapper
{
    /**
     * @param  Image  $media
     * @param  array<string, mixed>  $cacheControl
     */
    public function __construct(
        public readonly Media $media,
        public ?array $cacheControl = null,
    ) {
        $this->runValidation();
    }

    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $payload = [
            'type' => 'image',
            'cache_control' => $this->cacheControl,
        ];

        if ($this->media->isFileId()) {
            $payload['source'] = [
                'type' => 'file',
                'file_id' => $this->media->fileId(),
            ];
        } elseif ($this->media->isUrl()) {
            $payload['source'] = [
                'type' => 'url',
                'url' => $this->media->url(),
            ];
        } else {
            $payload['source'] = [
                'type' => 'base64',
                'media_type' => $this->media->mimeType(),
                'data' => $this->media->base64(),
            ];
        }

        return array_filter($payload);
    }

    protected function provider(): string|Provider
    {
        return Provider::Anthropic;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isFileId()) {
            return true;
        }

        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Maps;

use BackedEnum;
use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

class MessageMap
{
    /**
     * @param  array<int, Message>  $messages
     * @param  array<string, mixed>  $requestProviderOptions
     * @return array<int, mixed>
     */
    public static function map(array $messages, array $requestProviderOptions = []): array
    {
        if (array_filter($messages, fn (Message $message): bool => $message instanceof SystemMessage) !== []) {
            throw new PrismException('Anthropic does not support SystemMessages in the messages array. Use withSystemPrompt or withSystemPrompts instead.');
        }

        return array_map(
            fn (Message $message): array => self::mapMessage($message, $requestProviderOptions),
            $messages
        );
    }

    /**
     * @param  SystemMessage[]  $messages
     * @return array<int, mixed>
     */
    public static function mapSystemMessages(array $messages): array
    {
        return array_map(
            self::mapSystemMessage(...),
            $messages
        );
    }

    /**
     * @param  array<string, mixed>  $requestProviderOptions
     * @return array<string, mixed>
     */
    protected static function mapMessage(Message $message, array $requestProviderOptions = []): array
    {
        return match ($message::class) {
            UserMessage::class => self::mapUserMessage($message, $requestProviderOptions),
            AssistantMessage::class => self::mapAssistantMessage($message),
            ToolResultMessage::class => self::mapToolResultMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    /**
     * @return array<string, mixed>
     */
    protected static function mapSystemMessage(SystemMessage $systemMessage): array
    {
        $cacheType = $systemMessage->providerOptions('cacheType');

        return array_filter([
            'type' => 'text',
            'text' => $systemMessage->content,
            'cache_control' => $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null,
        ]);
    }

    /**
     * @return array<string, mixed>
     */
    protected static function mapToolResultMessage(ToolResultMessage $message): array
    {
        $cacheType = $message->providerOptions('cacheType');
        $cacheControl = $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null;

        $toolResults = $message->toolResults;
        $totalResults = count($toolResults);

        return [
            'role' => 'user',
            'content' => array_map(function (ToolResult $toolResult, int $index) use ($cacheControl, $totalResults): array {
                // Only add cache_control to the last tool result
                $isLastResult = $index === $totalResults - 1;

                return array_filter([
                    'type' => 'tool_result',
                    'tool_use_id' => $toolResult->toolCallId,
                    'content' => $toolResult->result,
                    'cache_control' => $isLastResult ? $cacheControl : null,
                ]);
            }, $toolResults, array_keys($toolResults)),
        ];
    }

    /**
     * @param  array<string, mixed>  $requestProviderOptions
     * @return array<string, mixed>
     */
    protected static function mapUserMessage(UserMessage $message, array $requestProviderOptions = []): array
    {
        $cacheType = $message->providerOptions('cacheType');
        $cacheControl = $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null;

        return [
            'role' => 'user',
            'content' => [
                array_filter([
                    'type' => 'text',
                    'text' => $message->text(),
                    'cache_control' => $cacheControl,
                ]),
                ...self::mapImageParts($message->images(), $cacheControl),
                ...self::mapDocumentParts($message->documents(), $cacheControl, $requestProviderOptions),
            ],
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected static function mapAssistantMessage(AssistantMessage $message): array
    {
        $cacheType = $message->providerOptions('cacheType');

        $content = [];

        if (isset($message->additionalContent['thinking']) && isset($message->additionalContent['thinking_signature'])) {
            $content[] = [
                'type' => 'thinking',
                'thinking' => $message->additionalContent['thinking'],
                'signature' => $message->additionalContent['thinking_signature'],
            ];
        }

        if (isset($message->additionalContent['citations'])) {
            foreach ($message->additionalContent['citations'] as $part) {
                $content[] = array_filter([
                    ...CitationsMapper::mapToAnthropic($part),
                    'cache_control' => $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null,
                ]);
            }
        } elseif ($message->content !== '' && $message->content !== '0') {

            $content[] = array_filter([
                'type' => 'text',
                'text' => $message->content,
                'cache_control' => $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null,
            ]);
        }

        $toolCalls = $message->toolCalls
            ? array_map(fn (ToolCall $toolCall): array => [
                'type' => 'tool_use',
                'id' => $toolCall->id,
                'name' => $toolCall->name,
                'input' => $toolCall->arguments() === [] ? new \stdClass : $toolCall->arguments(),
            ], $message->toolCalls)
            : [];

        return [
            'role' => 'assistant',
            'content' => array_merge($content, $toolCalls),
        ];
    }

    /**
     * @param  Image[]  $parts
     * @param  array<string, mixed>|null  $cacheControl
     * @return array<int, mixed>
     */
    protected static function mapImageParts(array $parts, ?array $cacheControl = null): array
    {
        return array_map(
            fn (Image $image): array => (new ImageMapper($image, $cacheControl))->toPayload(),
            $parts
        );
    }

    /**
     * @param  Document[]  $parts
     * @param  array<string, mixed>|null  $cacheControl
     * @param  array<string, mixed>  $requestProviderOptions
     * @return array<int, mixed>
     */
    protected static function mapDocumentParts(array $parts, ?array $cacheControl = null, array $requestProviderOptions = []): array
    {
        return array_map(
            fn (Document $document): array => (new DocumentMapper($document, $cacheControl, $requestProviderOptions))->toPayload(),
            $parts
        );
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_null($toolChoice)) {
            return null;
        }

        if (is_string($toolChoice)) {
            return [
                'type' => 'tool',
                'name' => $toolChoice,
            ];
        }

        if (! in_array($toolChoice, [ToolChoice::Auto, ToolChoice::Any, ToolChoice::None])) {
            throw new InvalidArgumentException('Invalid tool choice');
        }

        return [
            'type' => match ($toolChoice) {
                ToolChoice::Auto => 'auto',
                ToolChoice::Any => 'any',
                ToolChoice::None => 'none',
            },
        ];
    }
}



================================================
FILE: src/Providers/Anthropic/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Maps;

use Prism\Prism\Tool as PrismTool;
use UnitEnum;

class ToolMap
{
    /**
     * @param  PrismTool[]  $tools
     * @return array<string, mixed>
     */
    public static function map(array $tools): array
    {
        return array_map(function (PrismTool $tool): array {
            $cacheType = $tool->providerOptions('cacheType');
            $properties = $tool->parametersAsArray();

            return array_filter([
                'name' => $tool->name(),
                'description' => $tool->description(),
                'input_schema' => [
                    'type' => 'object',
                    'properties' => $properties === [] ? new \stdClass : $properties,
                    'required' => $tool->requiredParameters(),
                ],
                'cache_control' => $cacheType ? ['type' => $cacheType instanceof UnitEnum ? $cacheType->name : $cacheType] : null,
            ]);
        }, $tools);
    }
}



================================================
FILE: src/Providers/Anthropic/Parsers/StreamEventParser.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\Parsers;

use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Psr\Http\Message\StreamInterface;
use Throwable;

class StreamEventParser
{
    /**
     * @return array<string, mixed>|null
     */
    public function parseNextChunk(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);
        $line = trim($line);

        if ($line === '' || $line === '0') {
            return null;
        }

        if (str_starts_with($line, 'event:')) {
            return $this->parseEventChunk($line, $stream);
        }

        if (str_starts_with($line, 'data:')) {
            return $this->parseDataChunk($line);
        }

        return null;
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseEventChunk(string $line, StreamInterface $stream): ?array
    {
        $eventType = trim(substr($line, strlen('event:')));

        if ($eventType === 'ping') {
            return ['type' => 'ping'];
        }

        $dataLine = $this->readLine($stream);
        $dataLine = trim($dataLine);

        if ($dataLine === '' || $dataLine === '0') {
            return ['type' => $eventType];
        }

        if (! str_starts_with($dataLine, 'data:')) {
            return ['type' => $eventType];
        }

        return $this->parseJsonData($dataLine, $eventType);
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseDataChunk(string $line): ?array
    {
        $jsonData = trim(substr($line, strlen('data:')));

        if ($jsonData === '' || $jsonData === '0' || str_contains($jsonData, 'DONE')) {
            return null;
        }

        return $this->parseJsonData($jsonData);
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseJsonData(string $jsonDataLine, ?string $eventType = null): ?array
    {
        $jsonData = trim(str_starts_with($jsonDataLine, 'data:')
            ? substr($jsonDataLine, strlen('data:'))
            : $jsonDataLine);

        if ($jsonData === '' || $jsonData === '0') {
            return $eventType ? ['type' => $eventType] : null;
        }

        try {
            $data = json_decode($jsonData, true, flags: JSON_THROW_ON_ERROR);

            if ($eventType) {
                $data['type'] = $eventType;
            }

            return $data;
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Anthropic', $e);
        }
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }
}



================================================
FILE: src/Providers/Anthropic/ValueObjects/AnthropicStreamState.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\ValueObjects;

use Prism\Prism\Streaming\StreamState;

class AnthropicStreamState extends StreamState
{
    protected string $currentThinkingSignature = '';

    public function appendThinkingSignature(string $signature): self
    {
        $this->currentThinkingSignature .= $signature;

        return $this;
    }

    public function currentThinkingSignature(): string
    {
        return $this->currentThinkingSignature;
    }

    public function reset(): self
    {
        parent::reset();
        $this->currentThinkingSignature = '';

        return $this;
    }

    public function resetTextState(): self
    {
        parent::resetTextState();
        $this->currentThinkingSignature = '';

        return $this;
    }
}



================================================
FILE: src/Providers/Anthropic/ValueObjects/LegacyAnthropicCitation.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\ValueObjects;

class LegacyAnthropicCitation
{
    public function __construct(
        public readonly string $type,
        public readonly string $citedText,
        public readonly ?int $startIndex,
        public readonly ?int $endIndex,
        public readonly ?int $documentIndex,
        public readonly ?string $documentTitle = null,
        public readonly ?string $url = null
    ) {}
}



================================================
FILE: src/Providers/Anthropic/ValueObjects/LegacyAnthropicMessagePartWithCitations.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Anthropic\ValueObjects;

use InvalidArgumentException;

class LegacyAnthropicMessagePartWithCitations
{
    /**
     * @param  LegacyAnthropicCitation[]  $citations
     */
    public function __construct(
        public readonly ?string $text,
        public readonly array $citations = []
    ) {}

    /**
     * @param  array<string,mixed>  $data
     */
    public static function fromContentBlock(array $data): self
    {
        return new self(
            $data['text'] ?? null,
            array_map(function (array $citation): LegacyAnthropicCitation {
                $indexPropertyCommonPart = match ($citation['type']) {
                    'page_location' => 'page_number',
                    'char_location' => 'char_index',
                    'content_block_location' => 'block_index',
                    'web_search_result_location' => null,
                    default => throw new InvalidArgumentException("Unknown citation type: {$citation['type']}"),
                };

                return new LegacyAnthropicCitation(
                    type: $citation['type'],
                    citedText: data_get($citation, 'cited_text'),
                    startIndex: $indexPropertyCommonPart ? data_get($citation, "start_$indexPropertyCommonPart", null) : null,
                    endIndex: $indexPropertyCommonPart ? data_get($citation, "end_$indexPropertyCommonPart", null) : null,
                    documentIndex: data_get($citation, 'document_index', null),
                    documentTitle: data_get($citation, 'document_title', null) ?? data_get($citation, 'title', null),
                    url: data_get($citation, 'url', null)
                );
            }, $data['citations'] ?? [])
        );
    }

    /**
     * @return array<string,mixed>
     */
    public function toContentBlock(): array
    {
        return [
            'type' => 'text',
            'text' => $this->text,
            'citations' => array_map(function (LegacyAnthropicCitation $citation): array {
                $indexPropertyCommonPart = match ($citation->type) {
                    'page_location' => 'page_number',
                    'char_location' => 'char_index',
                    'content_block_location' => 'block_index',
                    default => throw new InvalidArgumentException("Unknown citation type: {$citation->type}"),
                };

                return [
                    'type' => $citation->type,
                    'cited_text' => $citation->citedText,
                    'document_index' => $citation->documentIndex,
                    'document_title' => $citation->documentTitle,
                    "start_$indexPropertyCommonPart" => $citation->startIndex,
                    "end_$indexPropertyCommonPart" => $citation->endIndex,
                ];
            }, $this->citations),
        ];
    }
}



================================================
FILE: src/Providers/DeepSeek/DeepSeek.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Providers\DeepSeek\Handlers\Stream;
use Prism\Prism\Providers\DeepSeek\Handlers\Structured;
use Prism\Prism\Providers\DeepSeek\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class DeepSeek extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/DeepSeek/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\DeepSeek\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', ''));
    }
}



================================================
FILE: src/Providers/DeepSeek/Concerns/ValidatesResponses.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Concerns;

use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponses
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if ($data === []) {
            throw PrismException::providerResponseError('DeepSeek Error: Empty response');
        }
    }
}



================================================
FILE: src/Providers/DeepSeek/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Handlers;

use Generator;
use Illuminate\Http\Client\ConnectionException;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\DeepSeek\Concerns\MapsFinishReason;
use Prism\Prism\Providers\DeepSeek\Concerns\ValidatesResponses;
use Prism\Prism\Providers\DeepSeek\Maps\MessageMap;
use Prism\Prism\Providers\DeepSeek\Maps\ToolChoiceMap;
use Prism\Prism\Providers\DeepSeek\Maps\ToolMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools, MapsFinishReason, ValidatesResponses;

    protected StreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        if ($depth === 0) {
            $this->state->reset();
        }

        $text = '';
        $toolCalls = [];

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            if ($this->state->shouldEmitStreamStart()) {
                $this->state->withMessageId(EventID::generate())->markStreamStarted();

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $request->model(),
                    provider: 'deepseek'
                );
            }

            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $toolCalls);

                $rawFinishReason = data_get($data, 'choices.0.finish_reason');
                if ($rawFinishReason === 'tool_calls') {
                    if ($this->state->hasTextStarted() && $text !== '') {
                        yield new TextCompleteEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            messageId: $this->state->messageId()
                        );
                    }

                    if ($this->state->hasThinkingStarted()) {
                        yield new ThinkingCompleteEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            reasoningId: $this->state->reasoningId()
                        );
                    }

                    yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                    return;
                }

                continue;
            }

            $reasoningDelta = $this->extractReasoningDelta($data);
            if ($reasoningDelta !== '' && $reasoningDelta !== '0') {
                if ($this->state->shouldEmitThinkingStart()) {
                    $this->state->withReasoningId(EventID::generate())->markThinkingStarted();

                    yield new ThinkingStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                yield new ThinkingEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $reasoningDelta,
                    reasoningId: $this->state->reasoningId()
                );

                continue;
            }

            if ($this->state->hasThinkingStarted() && $reasoningDelta === '') {
                yield new ThinkingCompleteEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    reasoningId: $this->state->reasoningId()
                );
            }

            $content = $this->extractContentDelta($data);
            if ($content !== '' && $content !== '0') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();

                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );

                continue;
            }

            $rawFinishReason = data_get($data, 'choices.0.finish_reason');
            if ($rawFinishReason !== null) {
                $finishReason = $this->mapFinishReason($data);

                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                if ($this->state->hasThinkingStarted()) {
                    yield new ThinkingCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                $usage = $this->extractUsage($data);

                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $finishReason,
                    usage: $usage
                );
            }
        }

        if ($toolCalls !== []) {
            yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);
        }
    }

    /**
     * @return array<string, mixed>|null
     *
     * @throws PrismStreamDecodeException
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if (Str::contains($line, '[DONE]')) {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('DeepSeek', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        return ! empty(data_get($data, 'choices.0.delta.tool_calls', []));
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        $deltaToolCalls = data_get($data, 'choices.0.delta.tool_calls', []);

        foreach ($deltaToolCalls as $deltaToolCall) {
            $index = data_get($deltaToolCall, 'index', 0);

            if (! isset($toolCalls[$index])) {
                $toolCalls[$index] = [
                    'id' => '',
                    'name' => '',
                    'arguments' => '',
                ];
            }

            if ($id = data_get($deltaToolCall, 'id')) {
                $toolCalls[$index]['id'] = $id;
            }

            if ($name = data_get($deltaToolCall, 'function.name')) {
                $toolCalls[$index]['name'] = $name;
            }

            if ($arguments = data_get($deltaToolCall, 'function.arguments')) {
                $toolCalls[$index]['arguments'] .= $arguments;
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractReasoningDelta(array $data): string
    {
        return data_get($data, 'choices.0.delta.reasoning_content') ?? '';
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractContentDelta(array $data): string
    {
        return data_get($data, 'choices.0.delta.content') ?? '';
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractFinishReason(array $data): FinishReason
    {
        $finishReason = data_get($data, 'choices.0.finish_reason');

        if ($finishReason === null) {
            return FinishReason::Unknown;
        }

        return $this->mapFinishReason($data);
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data): ?Usage
    {
        $usage = data_get($data, 'usage');

        if (! $usage) {
            return null;
        }

        return new Usage(
            promptTokens: (int) data_get($usage, 'prompt_tokens', 0),
            completionTokens: (int) data_get($usage, 'completion_tokens', 0)
        );
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(Request $request, string $text, array $toolCalls, int $depth): Generator
    {
        $mappedToolCalls = $this->mapToolCalls($toolCalls);

        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId()
            );
        }

        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        $this->state->resetTextState();
        $this->state->withMessageId(EventID::generate());

        $nextResponse = $this->sendRequest($request);
        yield from $this->processStream($nextResponse, $request, $depth + 1);
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'name'),
            arguments: data_get($toolCall, 'arguments'),
        ), $toolCalls);
    }

    /**
     * @throws ConnectionException
     */
    protected function sendRequest(Request $request): Response
    {
        return $this->client->post(
            'chat/completions',
            array_merge([
                'stream' => true,
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'tools' => ToolMap::map($request->tools()) ?: null,
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            ]))
        );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }
}



================================================
FILE: src/Providers/DeepSeek/Handlers/Structured.php
================================================
<?php

namespace Prism\Prism\Providers\DeepSeek\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\DeepSeek\Concerns\MapsFinishReason;
use Prism\Prism\Providers\DeepSeek\Concerns\ValidatesResponses;
use Prism\Prism\Providers\DeepSeek\Maps\FinishReasonMap;
use Prism\Prism\Providers\DeepSeek\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $request = $this->appendMessageForJsonMode($request);

        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        return $this->createResponse($request, $data);
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_completion_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'response_format' => ['type' => 'json_object'],
            ]))
        );

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if ($data === []) {
            throw PrismException::providerResponseError('DeepSeek Error: Empty response');
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function createResponse(Request $request, array $data): StructuredResponse
    {
        $text = data_get($data, 'choices.0.message.content') ?? '';

        $responseMessage = new AssistantMessage($text);
        $request->addMessage($responseMessage);

        $step = new Step(
            text: $text,
            finishReason: FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', '')),
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        );

        $this->responseBuilder->addStep($step);

        return $this->responseBuilder->toResponse();
    }

    protected function appendMessageForJsonMode(Request $request): Request
    {
        return $request->addMessage(new SystemMessage(sprintf(
            "You MUST respond EXCLUSIVELY with a JSON object that strictly adheres to the following schema. \n Do NOT explain or add other content. Validate your response against this schema \n %s",
            json_encode($request->schema()->toArray(), JSON_PRETTY_PRINT)
        )));
    }
}



================================================
FILE: src/Providers/DeepSeek/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\DeepSeek\Concerns\MapsFinishReason;
use Prism\Prism\Providers\DeepSeek\Concerns\ValidatesResponses;
use Prism\Prism\Providers\DeepSeek\Maps\MessageMap;
use Prism\Prism\Providers\DeepSeek\Maps\ToolCallMap;
use Prism\Prism\Providers\DeepSeek\Maps\ToolChoiceMap;
use Prism\Prism\Providers\DeepSeek\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools;
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): TextResponse
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        $responseMessage = new AssistantMessage(
            data_get($data, 'choices.0.message.content') ?? '',
            ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', [])),
            []
        );

        $request = $request->addMessage($responseMessage);

        return match ($this->mapFinishReason($data)) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request),
            FinishReason::Stop => $this->handleStop($data, $request),
            default => throw new PrismException('DeepSeek: unknown finish reason'),
        };
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request): TextResponse
    {
        $toolResults = $this->callTools(
            $request->tools(),
            ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', []))
        );

        $request = $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request): TextResponse
    {
        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'tools' => ToolMap::map($request->tools()) ?: null,
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            ]))
        );

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, ToolResult>  $toolResults
     */
    protected function addStep(array $data, Request $request, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'choices.0.message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            toolCalls: ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', [])),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $reason): FinishReason
    {
        return match ($reason) {
            'stop', => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            'content_filter' => FinishReason::ContentFilter,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\DeepSeek\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'image_url',
            'image_url' => [
                'url' => $this->media->isUrl()
                    ? $this->media->url()
                    : sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64()),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::DeepSeek;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $this->mappedMessages[] = [
                'role' => 'tool',
                'tool_call_id' => $toolResult->toolCallId,
                'content' => $toolResult->result,
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $imageParts = array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $message->images());

        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => $message->text()],
                ...$imageParts,
            ],
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $toolCalls = array_map(fn (ToolCall $toolCall): array => [
            'id' => $toolCall->id,
            'type' => 'function',
            'function' => [
                'name' => $toolCall->name,
                'arguments' => json_encode($toolCall->arguments()),
            ],
        ], $message->toolCalls);

        $this->mappedMessages[] = array_filter([
            'role' => 'assistant',
            'content' => $message->content,
            'tool_calls' => $toolCalls,
        ]);
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/ToolCallMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Maps;

use Prism\Prism\ValueObjects\ToolCall;

class ToolCallMap
{
    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    public static function map(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'function.name'),
            arguments: data_get($toolCall, 'function.arguments'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $toolChoice,
                ],
            ];
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            null => $toolChoice,
            default => throw new InvalidArgumentException('Invalid tool choice')
        };
    }
}



================================================
FILE: src/Providers/DeepSeek/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\DeepSeek\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<string, mixed>
     */
    public static function Map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => array_filter([
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                ...$tool->hasParameters() ? [
                    'parameters' => [
                        'type' => 'object',
                        'properties' => $tool->parametersAsArray(),
                        'required' => $tool->requiredParameters(),
                    ],
                ] : [],
            ],
            'strict' => $tool->providerOptions('strict'),
        ]), $tools);
    }
}



================================================
FILE: src/Providers/ElevenLabs/ElevenLabs.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\ElevenLabs;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Audio\AudioResponse as TextToSpeechResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as SpeechToTextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Providers\ElevenLabs\Handlers\Audio;
use Prism\Prism\Providers\Provider;

class ElevenLabs extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url = 'https://api.elevenlabs.io/v1/',
    ) {}

    #[\Override]
    public function textToSpeech(TextToSpeechRequest $request): TextToSpeechResponse
    {
        $handler = new Audio(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            )
        );

        try {
            return $handler->handleTextToSpeech($request);
        } catch (RequestException $e) {
            $this->handleRequestException($request->model(), $e);
        }
    }

    #[\Override]
    public function speechToText(SpeechToTextRequest $request): SpeechToTextResponse
    {
        $handler = new Audio(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            )
        );

        try {
            return $handler->handleSpeechToText($request);
        } catch (RequestException $e) {
            $this->handleRequestException($request->model(), $e);
        }
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        $response = $e->response;
        $body = $response->json() ?? [];
        $status = $response->status();

        $message = $body['detail']['message']
            ?? $body['detail']
            ?? $body['message']
            ?? 'Unknown error from ElevenLabs API';

        if ($status === 429) {
            $retryAfter = $response->header('Retry-After') ? (int) $response->header('Retry-After') : null;
            throw PrismRateLimitedException::make([], $retryAfter);
        }

        throw PrismException::providerResponseError(
            vsprintf('ElevenLabs Error [%s]: %s', [$status, $message])
        );
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->withHeaders([
                'xi-api-key' => $this->apiKey,
            ])
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/ElevenLabs/Handlers/Audio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\ElevenLabs\Handlers;

use Exception;
use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Providers\ElevenLabs\Maps\TextToSpeechRequestMapper;

class Audio
{
    public function __construct(protected readonly PendingRequest $client) {}

    public function handleTextToSpeech(TextToSpeechRequest $request): AudioResponse
    {
        // TODO: Implement ElevenLabs text-to-speech API call
        // 1. Use TextToSpeechRequestMapper to convert request to ElevenLabs format
        // 2. Make POST request to /text-to-speech/{voice_id}
        // 3. Handle binary audio response
        // 4. Return AudioResponse with base64 encoded audio

        $mapper = new TextToSpeechRequestMapper($request);
        $mapper->toPayload();

        throw new Exception('ElevenLabs text-to-speech not yet implemented');
    }

    public function handleSpeechToText(SpeechToTextRequest $request): TextResponse
    {
        $response = $this
            ->client
            ->attach(
                'file',
                $request->input()->resource(),
                'audio',
                ['Content-Type' => $request->input()->mimeType()]
            )
            ->post('speech-to-text', array_filter([
                'model_id' => $request->model(),
                'language_code' => $request->providerOptions('language_code'),
                'num_speakers' => $request->providerOptions('num_speakers'),
                'diarize' => $request->providerOptions('diarize'),
                'tag_audio_events' => $request->providerOptions('tag_audio_events'),
            ], fn ($value): bool => $value !== null));

        $response->throw();

        $data = $response->json();

        return new TextResponse(
            text: $data['text'] ?? '',
            additionalContent: $data,
        );
    }
}



================================================
FILE: src/Providers/ElevenLabs/Maps/TextToSpeechRequestMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\ElevenLabs\Maps;

use Prism\Prism\Audio\TextToSpeechRequest;

class TextToSpeechRequestMapper
{
    public function __construct(protected TextToSpeechRequest $request) {}

    /**
     * @return array<string, mixed>
     */
    public function toPayload(): array
    {
        // TODO: Map Prism TextToSpeechRequest to ElevenLabs API format
        // Expected ElevenLabs format:
        // {
        //   "text": "string",
        //   "model_id": "string",
        //   "voice_settings": {
        //     "stability": 0.5,
        //     "similarity_boost": 0.5
        //   },
        //   "language_code": "string"
        // }

        return [
            'text' => $this->request->input(),
            // TODO: Add proper mapping for:
            // - model_id from request->model()
            // - voice_settings from request options
            // - language_code from request options
        ];
    }

    public function getVoiceId(): string
    {
        // TODO: Extract voice ID from request
        // This might come from provider options or a default voice
        return 'default-voice-id';
    }
}



================================================
FILE: src/Providers/Gemini/Gemini.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Images\Request as ImagesRequest;
use Prism\Prism\Images\Response as ImagesResponse;
use Prism\Prism\Providers\Gemini\Handlers\Cache;
use Prism\Prism\Providers\Gemini\Handlers\Embeddings;
use Prism\Prism\Providers\Gemini\Handlers\Images;
use Prism\Prism\Providers\Gemini\Handlers\Stream;
use Prism\Prism\Providers\Gemini\Handlers\Structured;
use Prism\Prism\Providers\Gemini\Handlers\Text;
use Prism\Prism\Providers\Gemini\ValueObjects\GeminiCachedObject;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

class Gemini extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text(
            $this->client($request->clientOptions(), $request->clientRetry()),
            $this->apiKey
        );

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function embeddings(EmbeddingRequest $request): EmbeddingResponse
    {
        $handler = new Embeddings($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function images(ImagesRequest $request): ImagesResponse
    {
        $handler = new Images($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream(
            $this->client($request->clientOptions(), $request->clientRetry()),
            $this->apiKey
        );

        return $handler->handle($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make([]),
            503 => throw PrismProviderOverloadedException::make(class_basename($this)),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @param  Message[]  $messages
     * @param  array<SystemMessage|string>  $systemPrompts
     */
    public function cache(string $model, array $messages = [], array $systemPrompts = [], ?int $ttl = null): GeminiCachedObject
    {
        if ($messages === [] && $systemPrompts === []) {
            throw new PrismException('At least one message or system prompt must be provided');
        }

        $systemPrompts = array_map(
            fn (\Prism\Prism\ValueObjects\Messages\SystemMessage|string $prompt): SystemMessage => $prompt instanceof SystemMessage ? $prompt : new SystemMessage($prompt),
            $systemPrompts
        );

        $handler = new Cache(
            client: $this->client(
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta'
            ),
            model: $model,
            messages: $messages,
            systemPrompts: $systemPrompts,
            ttl: $ttl
        );

        try {
            return $handler->handle();
        } catch (RequestException $e) {
            $this->handleRequestException($model, $e);
        }
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->withHeaders([
                'x-goog-api-key' => $this->apiKey,
            ])
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/Gemini/Concerns/ValidatesResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponse
{
    protected function validateResponse(Response $response): void
    {
        $data = $response->json();

        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(vsprintf(
                'Gemini Error: [%s] %s',
                [
                    data_get($data, 'error.code', 'unknown'),
                    data_get($data, 'error.message', 'unknown'),
                ]
            ));
        }
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Cache.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Providers\Gemini\Maps\MessageMap;
use Prism\Prism\Providers\Gemini\ValueObjects\GeminiCachedObject;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

class Cache
{
    /**
     * @param  Message[]  $messages
     * @param  SystemMessage[]  $systemPrompts
     * @param  int  $ttl  Measured in seconds
     */
    public function __construct(
        protected PendingRequest $client,
        protected string $model,
        protected array $messages,
        protected array $systemPrompts,
        protected ?int $ttl = null
    ) {}

    public function handle(): GeminiCachedObject
    {
        return GeminiCachedObject::fromResponse($this->model, $this->sendRequest());
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(): array
    {
        $request = Arr::whereNotNull([
            'model' => 'models/'.$this->model,
            ...(new MessageMap($this->messages, $this->systemPrompts))(),
            'ttl' => $this->ttl.'s',
        ]);

        $response = $this->client->post('/cachedContents', $request);

        return $response->json();
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Embeddings.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Embeddings\Request;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

class Embeddings
{
    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): EmbeddingsResponse
    {
        if (count($request->inputs()) > 1) {
            throw new PrismException('Gemini Error: Prism currently only supports one input at a time with Gemini.');
        }

        $response = $this->sendRequest($request);

        $data = $response->json();

        if (! isset($data['embedding'])) {
            throw PrismException::providerResponseError(
                'Gemini Error: Invalid response format or missing embedding data'
            );
        }

        return new EmbeddingsResponse(
            embeddings: [Embedding::fromArray(data_get($data, 'embedding.values', []))],
            usage: new EmbeddingsUsage(0), // Gemini doesn't provide token usage info,
            meta: new Meta(
                id: '',
                model: '',
            ),
        );
    }

    protected function sendRequest(Request $request): Response
    {
        $providerOptions = $request->providerOptions();

        return $this->client->post(
            "{$request->model()}:embedContent",
            Arr::whereNotNull([
                'model' => $request->model(),
                'content' => [
                    'parts' => [
                        ['text' => $request->inputs()[0]],
                    ],
                ],
                'title' => $providerOptions['title'] ?? null,
                'taskType' => $providerOptions['taskType'] ?? null,
                'outputDimensionality' => $providerOptions['outputDimensionality'] ?? null,
            ])
        );
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Images.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Prism\Prism\Images\Request;
use Prism\Prism\Images\Response;
use Prism\Prism\Images\ResponseBuilder;
use Prism\Prism\Providers\Gemini\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Gemini\Maps\ImageRequestMap;
use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Images
{
    use ValidatesResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): Response
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $images = $this->extractImages($data);

        $responseBuilder = new ResponseBuilder(
            usage: new Usage(
                promptTokens: data_get($data, 'usageMetadata.promptTokenCount', 0),
                completionTokens: data_get($data, 'usageMetadata.candidatesTokenCount', 0),
            ),
            meta: new Meta(
                id: data_get($data, 'responseId', data_get($data, 'id', '')),
                model: data_get($data, 'modelVersion', ''),
            ),
            images: $images,
        );

        return $responseBuilder->toResponse();
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        $endpoint = $request->model();
        $endpoint .= (str_contains($request->model(), 'gemini') ? ':generateContent' : ':predict');

        return $this->client->post($endpoint, ImageRequestMap::map($request));
    }

    /**
     * @param  array<string, mixed>  $data
     * @return GeneratedImage[]
     */
    protected function extractImages(array $data): array
    {
        $imageParts = data_get($data, 'predictions', []);
        if (empty($imageParts)) {
            $parts = data_get($data, 'candidates.0.content.parts', []);
            $imageParts = array_column(
                array_filter($parts, fn (array $part) => data_get($part, 'inlineData.data')),
                'inlineData'
            );
        }

        return array_map(fn (array $image): GeneratedImage => new GeneratedImage(
            base64: data_get($image, 'bytesBase64Encoded', data_get($image, 'data')),
            mimeType: data_get($image, 'mimeType')
        ), $imageParts);
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\Gemini\Maps\FinishReasonMap;
use Prism\Prism\Providers\Gemini\Maps\MessageMap;
use Prism\Prism\Providers\Gemini\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Gemini\Maps\ToolMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools;

    protected StreamState $state;

    public function __construct(
        protected PendingRequest $client,
        #[\SensitiveParameter] protected string $apiKey,
    ) {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $this->state->reset();
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        // Prevent infinite recursion with tool calls
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            // Skip empty data
            if ($data === null) {
                continue;
            }

            // Debug: Log the data structure to understand thinking content
            if (isset($_ENV['PRISM_DEBUG_GEMINI_STREAM'])) {
                error_log('Gemini Stream Data: '.json_encode($data, JSON_PRETTY_PRINT));
            }

            // Emit stream start event once
            if ($this->state->shouldEmitStreamStart()) {
                $this->state->withMessageId(EventID::generate());

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: data_get($data, 'modelVersion', 'unknown'),
                    provider: 'gemini'
                );
                $this->state->markStreamStarted();
            }

            // Update usage data from each chunk
            $this->state->withUsage($this->extractUsage($data, $request));

            // Process tool calls
            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $this->state->toolCalls());
                foreach ($toolCalls as $index => $toolCall) {
                    $this->state->addToolCall($index, $toolCall);
                }

                // Emit tool call events
                foreach ($this->state->toolCalls() as $toolCallData) {
                    yield new ToolCallEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        toolCall: $this->mapToolCall($toolCallData),
                        messageId: $this->state->messageId()
                    );
                }

                // Check if this is the final part of the tool calls
                if ($this->mapFinishReason($data) === FinishReason::ToolCalls) {
                    yield from $this->handleToolCalls($request, $depth, $data);
                }

                continue;
            }

            // Handle content from all parts
            $parts = data_get($data, 'candidates.0.content.parts', []);

            foreach ($parts as $part) {
                // Check if this part is thinking content (based on Google's documentation)
                if (isset($part['thought']) && $part['thought'] === true) {
                    // Handle thinking content - part has thought=true boolean field
                    $thinkingContent = $part['text'] ?? '';

                    if ($thinkingContent !== '') {
                        // Start thinking if not already started
                        if ($this->state->reasoningId() === '') {
                            $this->state->withReasoningId(EventID::generate());

                            yield new ThinkingStartEvent(
                                id: EventID::generate(),
                                timestamp: time(),
                                reasoningId: $this->state->reasoningId()
                            );
                        }

                        $this->state->appendThinking($thinkingContent);

                        yield new ThinkingEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            delta: $thinkingContent,
                            reasoningId: $this->state->reasoningId()
                        );
                    }
                } elseif (isset($part['text']) && (! isset($part['thought']) || $part['thought'] === false)) {
                    // Handle regular text content (only when thought is not true)
                    $content = $part['text'];

                    if ($content !== '') {
                        // Emit text start event once when we first get text
                        if ($this->state->shouldEmitTextStart()) {
                            yield new TextStartEvent(
                                id: EventID::generate(),
                                timestamp: time(),
                                messageId: $this->state->messageId()
                            );
                            $this->state->markTextStarted();
                        }

                        $this->state->appendText($content);

                        yield new TextDeltaEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            delta: $content,
                            messageId: $this->state->messageId()
                        );
                    }
                }
            }

            // Handle completion
            $finishReason = $this->mapFinishReason($data);

            if ($finishReason !== FinishReason::Unknown) {
                // Emit thinking complete if we had thinking
                if ($this->state->reasoningId() !== '') {
                    yield new ThinkingCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                // Emit text complete if we had text
                if ($this->state->hasTextStarted()) {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                // Emit stream end event
                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $finishReason,
                    usage: $this->state->usage()
                );
            }
        }

        // Handle tool calls if present and not already handled
        if ($this->state->hasToolCalls() && $this->mapFinishReason([]) === FinishReason::Unknown) {
            yield from $this->handleToolCalls($request, $depth);
        }
    }

    /**
     * @return array<string, mixed>|null Parsed JSON data or null if line should be skipped
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if ($line === '' || $line === '[DONE]') {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Gemini', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        $parts = data_get($data, 'candidates.0.content.parts', []);

        foreach ($parts as $index => $part) {
            if (isset($part['functionCall'])) {
                $toolCalls[$index]['id'] = EventID::generate('gm');
                $toolCalls[$index]['name'] = data_get($part, 'functionCall.name');
                $toolCalls[$index]['arguments'] = data_get($part, 'functionCall.args', []);
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<string, mixed>  $data
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        int $depth,
        array $data = []
    ): Generator {
        $mappedToolCalls = [];

        // Convert tool calls to ToolCall objects
        foreach ($this->state->toolCalls() as $toolCallData) {
            $mappedToolCalls[] = $this->mapToolCall($toolCallData);
        }

        // Execute tools and emit results
        $toolResults = [];
        foreach ($mappedToolCalls as $toolCall) {
            try {
                $tool = $this->resolveTool($toolCall->name, $request->tools());
                $result = call_user_func_array($tool->handle(...), $toolCall->arguments());

                $toolResult = new ToolResult(
                    toolCallId: $toolCall->id,
                    toolName: $toolCall->name,
                    args: $toolCall->arguments(),
                    result: is_array($result) ? $result : ['result' => $result]
                );

                $toolResults[] = $toolResult;

                yield new ToolResultEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    toolResult: $toolResult,
                    messageId: $this->state->messageId(),
                    success: true
                );
            } catch (Throwable $e) {
                $errorResult = new ToolResult(
                    toolCallId: $toolCall->id,
                    toolName: $toolCall->name,
                    args: $toolCall->arguments(),
                    result: []
                );

                $toolResults[] = $errorResult;

                yield new ToolResultEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    toolResult: $errorResult,
                    messageId: $this->state->messageId(),
                    success: false,
                    error: $e->getMessage()
                );
            }
        }

        // Add messages for next turn and continue streaming
        if ($toolResults !== []) {
            $request->addMessage(new AssistantMessage($this->state->currentText(), $mappedToolCalls));
            $request->addMessage(new ToolResultMessage($toolResults));

            $depth++;
            if ($depth < $request->maxSteps()) {
                $this->state->reset();
                $nextResponse = $this->sendRequest($request);
                yield from $this->processStream($nextResponse, $request, $depth);
            }
        }
    }

    /**
     * Convert raw tool call data to ToolCall object.
     *
     * @param  array<string, mixed>  $toolCallData
     */
    protected function mapToolCall(array $toolCallData): ToolCall
    {
        $arguments = data_get($toolCallData, 'arguments', []);

        // If arguments is a string, try to decode it as JSON
        if (is_string($arguments) && $arguments !== '') {
            $decoded = json_decode($arguments, true);
            $arguments = json_last_error() === JSON_ERROR_NONE ? $decoded : ['input' => $arguments];
        }

        return new ToolCall(
            id: empty($toolCallData['id']) ? EventID::generate('gm') : $toolCallData['id'],
            name: data_get($toolCallData, 'name', 'unknown'),
            arguments: $arguments
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        $parts = data_get($data, 'candidates.0.content.parts', []);

        foreach ($parts as $part) {
            if (isset($part['functionCall'])) {
                return true;
            }
        }

        return false;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data, Request $request): Usage
    {
        $providerOptions = $request->providerOptions();

        return new Usage(
            promptTokens: isset($providerOptions['cachedContentName'])
                ? (data_get($data, 'usageMetadata.promptTokenCount', 0) - data_get($data, 'usageMetadata.cachedContentTokenCount', 0))
                : data_get($data, 'usageMetadata.promptTokenCount', 0),
            completionTokens: data_get($data, 'usageMetadata.candidatesTokenCount', 0),
            cacheReadInputTokens: data_get($data, 'usageMetadata.cachedContentTokenCount', null),
            thoughtTokens: data_get($data, 'usageMetadata.thoughtsTokenCount', null),
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        $finishReason = data_get($data, 'candidates.0.finishReason');

        if (! $finishReason) {
            return FinishReason::Unknown;
        }

        $isToolCall = $this->hasToolCalls($data);

        return FinishReasonMap::map($finishReason, $isToolCall);
    }

    protected function sendRequest(Request $request): Response
    {
        $providerOptions = $request->providerOptions();

        if ($request->tools() !== [] && ($providerOptions['searchGrounding'] ?? false)) {
            throw new PrismException('Use of search grounding with custom tools is not currently supported by Prism.');
        }

        $tools = match (true) {
            $providerOptions['searchGrounding'] ?? false => [
                [
                    'google_search' => (object) [],
                ],
            ],
            $request->tools() !== [] => ['function_declarations' => ToolMap::map($request->tools())],
            default => [],
        };

        return $this->client
            ->withOptions(['stream' => true])
            ->post(
                "{$request->model()}:streamGenerateContent?alt=sse",
                Arr::whereNotNull([
                    ...(new MessageMap($request->messages(), $request->systemPrompts()))(),
                    'cachedContent' => $providerOptions['cachedContentName'] ?? null,
                    'generationConfig' => Arr::whereNotNull([
                        'temperature' => $request->temperature(),
                        'topP' => $request->topP(),
                        'maxOutputTokens' => $request->maxTokens(),
                        'thinkingConfig' => Arr::whereNotNull([
                            'thinkingBudget' => $providerOptions['thinkingBudget'] ?? null,
                            'includeThoughts' => true,
                        ]) ?: null,
                    ]) ?: null,
                    'tools' => $tools !== [] ? $tools : null,
                    'tool_config' => $request->toolChoice() ? ToolChoiceMap::map($request->toolChoice()) : null,
                    'safetySettings' => $providerOptions['safetySettings'] ?? null,
                ])
            );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    /**
     * Check if a part contains thinking content based on Gemini's structure
     *
     * @param  array<string, mixed>  $part
     */
    protected function isThinkingContent(array $part): bool
    {
        // According to Google's documentation, thinking content is marked with thought=true
        return isset($part['thought']) && $part['thought'] === true;
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Structured.php
================================================
<?php

namespace Prism\Prism\Providers\Gemini\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Gemini\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Gemini\Maps\FinishReasonMap;
use Prism\Prism\Providers\Gemini\Maps\MessageMap;
use Prism\Prism\Providers\Gemini\Maps\SchemaMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        $responseMessage = new AssistantMessage(data_get($data, 'candidates.0.content.parts.0.text') ?? '');

        $request->addMessage($responseMessage);

        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    /**
     * @return array<string, mixed>
     */
    public function sendRequest(Request $request): array
    {
        $providerOptions = $request->providerOptions();

        $response = $this->client->post(
            "{$request->model()}:generateContent",
            Arr::whereNotNull([
                ...(new MessageMap($request->messages(), $request->systemPrompts()))(),
                'cachedContent' => $providerOptions['cachedContentName'] ?? null,
                'generationConfig' => Arr::whereNotNull([
                    'response_mime_type' => 'application/json',
                    'response_schema' => (new SchemaMap($request->schema()))->toArray(),
                    'temperature' => $request->temperature(),
                    'topP' => $request->topP(),
                    'maxOutputTokens' => $request->maxTokens(),
                    'thinkingConfig' => Arr::whereNotNull([
                        'thinkingBudget' => $providerOptions['thinkingBudget'] ?? null,
                    ]) ?: null,
                ]),
                'safetySettings' => $providerOptions['safetySettings'] ?? null,
            ])
        );

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(vsprintf(
                'Gemini Error: [%s] %s',
                [
                    data_get($data, 'error.code', 'unknown'),
                    data_get($data, 'error.message', 'unknown'),
                ]
            ));
        }

        // Check for token exhaustion patterns
        $finishReason = data_get($data, 'candidates.0.finishReason');
        $content = data_get($data, 'candidates.0.content.parts.0.text', '');
        $thoughtTokens = data_get($data, 'usageMetadata.thoughtsTokenCount', 0);

        if ($finishReason === 'MAX_TOKENS') {
            $promptTokens = data_get($data, 'usageMetadata.promptTokenCount', 0);
            $candidatesTokens = data_get($data, 'usageMetadata.candidatesTokenCount', 0);
            $totalTokens = data_get($data, 'usageMetadata.totalTokenCount', 0);
            $outputTokens = $candidatesTokens - $thoughtTokens;

            // Check if content is empty or likely truncated/invalid JSON
            $isEmpty = in_array(trim((string) $content), ['', '0'], true);
            $isInvalidJson = ! empty($content) && json_decode((string) $content) === null;
            $contentLength = strlen((string) $content);

            if (($isEmpty || $isInvalidJson) && $thoughtTokens > 0) {
                $errorDetail = $isEmpty
                    ? 'no tokens remained for structured output'
                    : "output was truncated at {$contentLength} characters resulting in invalid JSON";

                throw PrismException::providerResponseError(
                    'Gemini hit token limit with high thinking token usage. '.
                    "Token usage: {$promptTokens} prompt + {$thoughtTokens} thinking + {$outputTokens} output = {$totalTokens} total. ".
                    "The {$errorDetail}. ".
                    'Try increasing maxTokens to at least '.($totalTokens + 1000).' (suggested: '.($totalTokens * 2).' for comfortable margin).'
                );
            }
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function addStep(array $data, Request $request): void
    {
        $this->responseBuilder->addStep(
            new Step(
                text: data_get($data, 'candidates.0.content.parts.0.text') ?? '',
                finishReason: FinishReasonMap::map(
                    data_get($data, 'candidates.0.finishReason'),
                ),
                usage: new Usage(
                    promptTokens: data_get($data, 'usageMetadata.promptTokenCount', 0),
                    completionTokens: data_get($data, 'usageMetadata.candidatesTokenCount', 0),
                    cacheReadInputTokens: data_get($data, 'usageMetadata.cachedContentTokenCount', null),
                    thoughtTokens: data_get($data, 'usageMetadata.thoughtsTokenCount', null),
                ),
                meta: new Meta(
                    id: data_get($data, 'id', ''),
                    model: data_get($data, 'modelVersion'),
                ),
                messages: $request->messages(),
                systemPrompts: $request->systemPrompts(),
            )
        );
    }
}



================================================
FILE: src/Providers/Gemini/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Gemini\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Gemini\Maps\CitationMapper;
use Prism\Prism\Providers\Gemini\Maps\FinishReasonMap;
use Prism\Prism\Providers\Gemini\Maps\MessageMap;
use Prism\Prism\Providers\Gemini\Maps\ToolCallMap;
use Prism\Prism\Providers\Gemini\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Gemini\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ProviderTool;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools, ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(
        protected PendingRequest $client,
        #[\SensitiveParameter] protected string $apiKey,
    ) {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): TextResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $isToolCall = ! empty(data_get($data, 'candidates.0.content.parts.0.functionCall'));

        $responseMessage = new AssistantMessage(
            data_get($data, 'candidates.0.content.parts.0.text') ?? '',
            $isToolCall ? ToolCallMap::map(data_get($data, 'candidates.0.content.parts', [])) : [],
        );

        $request->addMessage($responseMessage);

        $finishReason = FinishReasonMap::map(
            data_get($data, 'candidates.0.finishReason'),
            $isToolCall
        );

        return match ($finishReason) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request),
            FinishReason::Stop, FinishReason::Length => $this->handleStop($data, $request, $finishReason),
            default => throw new PrismException('Gemini: unhandled finish reason'),
        };
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        $providerOptions = $request->providerOptions();

        $thinkingConfig = Arr::whereNotNull([
            'thinkingBudget' => $providerOptions['thinkingBudget'] ?? null,
        ]);

        $generationConfig = Arr::whereNotNull([
            'temperature' => $request->temperature(),
            'topP' => $request->topP(),
            'maxOutputTokens' => $request->maxTokens(),
            'thinkingConfig' => $thinkingConfig !== [] ? $thinkingConfig : null,
        ]);

        if ($request->tools() !== [] && $request->providerTools() != []) {
            throw new PrismException('Use of provider tools with custom tools is not currently supported by Gemini.');
        }

        $tools = [];

        if ($request->providerTools() !== []) {
            $tools = [
                Arr::mapWithKeys(
                    $request->providerTools(),
                    fn (ProviderTool $providerTool): array => [$providerTool->type => (object) []]
                ),
            ];
        }

        if ($request->tools() !== []) {
            $tools['function_declarations'] = ToolMap::map($request->tools());
        }

        return $this->client->post(
            "{$request->model()}:generateContent",
            Arr::whereNotNull([
                ...(new MessageMap($request->messages(), $request->systemPrompts()))(),
                'cachedContent' => $providerOptions['cachedContentName'] ?? null,
                'generationConfig' => $generationConfig !== [] ? $generationConfig : null,
                'tools' => $tools !== [] ? $tools : null,
                'tool_config' => $request->toolChoice() ? ToolChoiceMap::map($request->toolChoice()) : null,
                'safetySettings' => $providerOptions['safetySettings'] ?? null,
            ])
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request, FinishReason $finishReason): TextResponse
    {
        $this->addStep($data, $request, $finishReason);

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request): TextResponse
    {
        $toolResults = $this->callTools(
            $request->tools(),
            ToolCallMap::map(data_get($data, 'candidates.0.content.parts', []))
        );

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, FinishReason::ToolCalls, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(array $data, Request $request, FinishReason $finishReason, array $toolResults = []): void
    {
        $providerOptions = $request->providerOptions();

        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'candidates.0.content.parts.0.text') ?? '',
            finishReason: $finishReason,
            toolCalls: $finishReason === FinishReason::ToolCalls ? ToolCallMap::map(data_get($data, 'candidates.0.content.parts', [])) : [],
            toolResults: $toolResults,
            usage: new Usage(
                promptTokens: isset($providerOptions['cachedContentName'])
                    ? (data_get($data, 'usageMetadata.promptTokenCount', 0) - data_get($data, 'usageMetadata.cachedContentTokenCount', 0))
                    : data_get($data, 'usageMetadata.promptTokenCount', 0),
                completionTokens: data_get($data, 'usageMetadata.candidatesTokenCount', 0),
                cacheReadInputTokens: data_get($data, 'usageMetadata.cachedContentTokenCount', null),
                thoughtTokens: data_get($data, 'usageMetadata.thoughtsTokenCount', null),
            ),
            meta: new Meta(
                id: data_get($data, 'id', ''),
                model: data_get($data, 'modelVersion'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: Arr::whereNotNull([
                'citations' => CitationMapper::mapFromGemini(data_get($data, 'candidates.0', [])) ?: null,
                'searchEntryPoint' => data_get($data, 'candidates.0.groundingMetadata.searchEntryPoint', null),
                'searchQueries' => data_get($data, 'candidates.0.groundingMetadata.webSearchQueries', null),
            ]),
        ));
    }
}



================================================
FILE: src/Providers/Gemini/Maps/AudioVideoMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Providers\Gemini\Support\MediaUrlDetector;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class AudioVideoMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $url = $this->media->url();

        if ($this->media->isUrl() && $url !== null && MediaUrlDetector::shouldPassAsFileUri($url)) {
            return [
                'file_data' => [
                    'file_uri' => $url,
                ],
            ];
        }

        return [
            'inline_data' => [
                'mime_type' => $this->media->mimeType(),
                'data' => $this->media->base64(),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::Gemini;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Gemini/Maps/CitationMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

class CitationMapper
{
    /**
     * @param  array<string,mixed>  $candidate
     * @return MessagePartWithCitations[]
     * */
    public static function mapFromGemini(array $candidate): array
    {
        $lastWrittenCharacter = -1;
        $messageParts = [];

        $originalOutput = data_get($candidate, 'content.parts.0.text', '');

        $groundingSupports = data_get($candidate, 'groundingMetadata.groundingSupports', []);

        $groundingChunks = data_get($candidate, 'groundingMetadata.groundingChunks', []);

        foreach ($groundingSupports as $groundingSupport) {
            $startIndex = data_get($groundingSupport, 'segment.startIndex') ?? 0;
            $endIndex = data_get($groundingSupport, 'segment.endIndex') ?? strlen((string) $originalOutput);

            if ($startIndex - 1 > $lastWrittenCharacter) {
                $messageParts[] = new MessagePartWithCitations(
                    outputText: substr((string) $originalOutput, $lastWrittenCharacter + 1, $startIndex - $lastWrittenCharacter - 1),
                    citations: [],
                );

                $lastWrittenCharacter = $startIndex - 1;
            }

            $messageParts[] = new MessagePartWithCitations(
                outputText: substr((string) $originalOutput, $startIndex, $endIndex - $startIndex + 1),
                citations: self::mapGroundingChunkIndicesToCitations(
                    data_get($groundingSupport, 'groundingChunkIndices', []),
                    $groundingChunks
                )
            );

            $lastWrittenCharacter = $endIndex;
        }

        return $messageParts;
    }

    /**
     * @param  array<int>  $groundingChunkIndices
     * @param  array<array<string,string>>  $groundingChunks
     * @return Citation[]
     */
    protected static function mapGroundingChunkIndicesToCitations(array $groundingChunkIndices, array $groundingChunks): array
    {
        return array_map(
            fn (int $value): Citation => new Citation(
                sourceType: CitationSourceType::Url,
                source: data_get($groundingChunks, "{$value}.web.uri"),
                sourceTitle: data_get($groundingChunks, "{$value}.web.title"),
            ),
            $groundingChunkIndices
        );
    }
}



================================================
FILE: src/Providers/Gemini/Maps/DocumentMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Providers\Gemini\Support\MediaUrlDetector;
use Prism\Prism\ValueObjects\Media\Document;

/**
 * @property Document $media
 */
class DocumentMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $url = $this->media->url();

        if ($this->media->isUrl() && $url !== null && MediaUrlDetector::shouldPassAsFileUri($url)) {
            return [
                'file_data' => [
                    'file_uri' => $url,
                ],
            ];
        }

        return [
            'inline_data' => [
                'mime_type' => $this->media->mimeType(),
                'data' => $this->media->base64(),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::Gemini;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Gemini/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(?string $reason, bool $toolCall = false): FinishReason
    {
        return match ($reason) {
            'STOP' => $toolCall ? FinishReason::ToolCalls : FinishReason::Stop,
            'MAX_TOKENS' => FinishReason::Length,
            'SAFETY', 'BLOCKLIST', 'PROHIBITED_CONTENT', 'SPII', 'MALFORMED_FUNCTION_CALL' => FinishReason::ContentFilter,
            'RECITATION' => FinishReason::ContentFilter,
            'LANGUAGE' => FinishReason::Other,
            'FINISH_REASON_UNSPECIFIED', 'OTHER', null => FinishReason::Other,
            default => FinishReason::Other,
        };
    }
}



================================================
FILE: src/Providers/Gemini/Maps/ImageMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Providers\Gemini\Support\MediaUrlDetector;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $url = $this->media->url();

        if ($this->media->isUrl() && $url !== null && MediaUrlDetector::shouldPassAsFileUri($url)) {
            return [
                'file_data' => [
                    'file_uri' => $url,
                ],
            ];
        }

        return [
            'inline_data' => [
                'mime_type' => $this->media->mimeType(),
                'data' => $this->media->base64(),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::Gemini;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Gemini/Maps/ImageRequestMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Images\Request;

class ImageRequestMap
{
    /** @return array<string, mixed> */
    public static function map(Request $request): array
    {
        return match (str_contains($request->model(), 'gemini')) {
            true => self::geminiOptions($request),
            false => self::imagenOptions($request),
        };
    }

    /** @return array<string, mixed> */
    protected static function geminiOptions(Request $request): array
    {
        $providerOptions = $request->providerOptions();

        $parts = [];

        // Add images first (Gemini best practice for multimodal prompts)
        foreach ($request->additionalContent() as $image) {
            $parts[] = [
                'inlineData' => [
                    'mimeType' => $image->mimeType(),
                    'data' => $image->base64(),
                ],
            ];
        }

        // Add text prompt after images
        $parts[] = [
            'text' => $request->prompt(),
        ];

        $result = [
            'contents' => [
                [
                    'parts' => $parts,
                ],
            ],
            'generationConfig' => [
                'responseModalities' => $providerOptions['response_modalities'] ?? ['TEXT', 'IMAGE'],
                'imageConfig' => [
                    'aspectRatio' => $providerOptions['aspect_ratio'] ?? null,
                ],
            ],
        ];

        if (isset($providerOptions['safety_settings'])) {
            $result['safetySettings'] = $providerOptions['safety_settings'];
        }

        return $result;
    }

    /** @return array<string, mixed> */
    protected static function imagenOptions(Request $request): array
    {
        $providerOptions = $request->providerOptions();

        $options = [
            'instances' => [
                [
                    'prompt' => $request->prompt(),
                ],
            ],
        ];

        $parameters = Arr::whereNotNull([
            'sampleCount' => $providerOptions['n'] ?? null,
            'sampleImageSize' => $providerOptions['size'] ?? null,
            'aspectRatio' => $providerOptions['aspect_ratio'] ?? null,
            'personGeneration' => $providerOptions['person_generation'] ?? null,
        ]);

        if (! empty($parameters)) {
            $options['parameters'] = $parameters;
        }

        return $options;
    }
}



================================================
FILE: src/Providers/Gemini/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Media;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;

class MessageMap
{
    /** @var array<string, mixed> */
    protected array $contents = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts = []
    ) {}

    /**
     * @return array<string, mixed>
     */
    public function __invoke(): array
    {
        $this->contents['contents'] = [];

        foreach ($this->messages as $message) {
            $this->mapMessage($message);
        }

        foreach ($this->systemPrompts as $systemPrompt) {
            $this->mapSystemMessage($systemPrompt);
        }

        return array_filter($this->contents);
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        if (isset($this->contents['system_instruction'])) {
            throw new PrismException('Gemini only supports one system instruction.');
        }

        $this->contents['system_instruction'] = [
            'parts' => [
                [
                    'text' => $message->content,
                ],
            ],
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        $parts = [];
        foreach ($message->toolResults as $toolResult) {
            $parts[] = [
                'functionResponse' => [
                    'name' => $toolResult->toolName,
                    'response' => [
                        'name' => $toolResult->toolName,
                        'content' => json_encode($toolResult->result),
                    ],
                ],
            ];
        }

        $this->contents['contents'][] = [
            'role' => 'user',
            'parts' => $parts,
        ];
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $parts = [];

        if ($message->text() !== '' && $message->text() !== '0') {
            $parts[] = ['text' => $message->text()];
        }

        // Gemini docs suggest including text prompt after documents, but before images.
        $parts = array_merge(
            $this->mapDocuments($message->documents()),
            $parts,
            $this->mapImages($message->images()),
            $this->mapVideo($message->media()),
            $this->mapAudio($message->media()),
        );

        $this->contents['contents'][] = [
            'role' => 'user',
            'parts' => $parts,
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $parts = [];

        if ($message->content !== '' && $message->content !== '0') {
            $parts[] = ['text' => $message->content];
        }

        foreach ($message->toolCalls as $toolCall) {
            $parts[] = [
                'functionCall' => [
                    'name' => $toolCall->name,
                    ...count($toolCall->arguments()) ? [
                        'args' => $toolCall->arguments(),
                    ] : [],
                ],
            ];
        }

        $this->contents['contents'][] = [
            'role' => 'model',
            'parts' => $parts,
        ];
    }

    /**
     * @param  Image[]  $images
     * @return array<string,array<string,mixed>>
     */
    protected function mapImages(array $images): array
    {
        return array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $images);
    }

    /**
     * @param  Media[]|Video[]  $video
     * @return array<string,array<string,mixed>>
     */
    protected function mapVideo(array $video): array
    {
        return array_map(fn (Video|Media $media): array => (new AudioVideoMapper($media))->toPayload(), $video);
    }

    /**
     * @param  Media[]|Audio[]  $audio
     * @return array<string,array<string,mixed>>
     */
    protected function mapAudio(array $audio): array
    {
        return array_map(fn (Audio|Media $media): array => (new AudioVideoMapper($media))->toPayload(), $audio);
    }

    /**
     * @param  Document[]  $documents
     * @return array<string,array<string,mixed>>
     */
    protected function mapDocuments(array $documents): array
    {
        return array_map(fn (Document $document): array => (new DocumentMapper($document))->toPayload(), $documents);
    }
}



================================================
FILE: src/Providers/Gemini/Maps/SchemaMap.php
================================================
<?php

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Contracts\Schema;
use Prism\Prism\Schema\AnyOfSchema;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;

class SchemaMap
{
    public function __construct(
        private readonly Schema $schema,
    ) {}

    /**
     * @return array<mixed>
     */
    public function toArray(): array
    {
        $schemaArray = $this->schema->toArray();

        // Remove unsupported fields
        unset($schemaArray['additionalProperties'], $schemaArray['description'], $schemaArray['name']);

        // Handle AnyOfSchema - Gemini doesn't support anyOf, so we'll return the schema as-is
        // or we could choose the first schema type as a fallback
        if ($this->schema instanceof AnyOfSchema) {
            // For Gemini, we'll just return the raw anyOf structure
            // This might not be ideal, but it preserves the intent
            return $schemaArray;
        }

        return array_merge(
            array_filter([
                ...$schemaArray,
                'type' => $this->mapType(),
            ]),
            array_filter([
                'items' => property_exists($this->schema, 'items') && $this->schema->items
                    ? (new self($this->schema->items))->toArray()
                    : null,
                'properties' => $this->schema instanceof ObjectSchema && property_exists($this->schema, 'properties')
                    ? array_reduce($this->schema->properties, function (array $carry, Schema $property): array {
                        // Use property name as the key, but do NOT include "name" inside the value
                        $carry[$property->name()] = (new self($property))->toArray();

                        return $carry;
                    }, [])
                    : null,
                'nullable' => property_exists($this->schema, 'nullable') && $this->schema->nullable
                    ? true
                    : null,
            ])
        );
    }

    protected function mapType(): string
    {
        if ($this->schema instanceof ArraySchema) {
            return 'array';
        }
        if ($this->schema instanceof BooleanSchema) {
            return 'boolean';
        }
        if ($this->schema instanceof NumberSchema) {
            return 'number';
        }
        if ($this->schema instanceof ObjectSchema) {
            return 'object';
        }

        return 'string';
    }
}



================================================
FILE: src/Providers/Gemini/Maps/SearchGroundingMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Providers\Gemini\ValueObjects\MessagePartWithSearchGroundings;
use Prism\Prism\Providers\Gemini\ValueObjects\SearchGrounding;

class SearchGroundingMap
{
    /**
     * @param  array<string,mixed>  $groundingSupports
     * @param  array<array<string,array<string,string>>>  $groundingChunks
     * @return MessagePartWithSearchGroundings[]
     */
    public static function map(array $groundingSupports, array $groundingChunks): array
    {
        return array_map(
            fn ($groundingSupport): MessagePartWithSearchGroundings => new MessagePartWithSearchGroundings(
                text: data_get($groundingSupport, 'segment.text', ''),
                startIndex: data_get($groundingSupport, 'segment.startIndex', 0),
                endIndex: data_get($groundingSupport, 'segment.endIndex', 0),
                groundings: static::mapGroundings($groundingSupport, $groundingChunks)
            ),
            $groundingSupports
        );
    }

    /**
     * @param  array<string,mixed>  $groundingSupport
     * @param  array<array<string,array<string,string>>>  $groundingChunks
     * @return SearchGrounding[]
     */
    protected static function mapGroundings(array $groundingSupport, array $groundingChunks): array
    {
        return array_map(
            function ($index) use ($groundingChunks, $groundingSupport): SearchGrounding {
                $i = 0;

                $grounding = new SearchGrounding(
                    title: data_get($groundingChunks[$index], 'web.title', ''),
                    uri: data_get($groundingChunks[$index], 'web.uri', ''),
                    confidence: data_get($groundingSupport, "confidenceScores.$i", 0.0)
                );

                $i++;

                return $grounding;
            },
            data_get($groundingSupport, 'groundingChunkIndices', [])
        );
    }
}



================================================
FILE: src/Providers/Gemini/Maps/ToolCallMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\ValueObjects\ToolCall;

class ToolCallMap
{
    /**
     * @param  array<array<string, mixed>>  $toolCalls
     * @return array<ToolCall>
     */
    public static function map(array $toolCalls): array
    {
        if ($toolCalls === []) {
            return [];
        }

        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'functionCall.name'),
            name: data_get($toolCall, 'functionCall.name'),
            arguments: data_get($toolCall, 'functionCall.args'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/Gemini/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_string($toolChoice)) {
            return [
                'function_calling_config' => [
                    'mode' => 'ANY',
                    'allowed_function_names' => [$toolChoice],
                ],
            ];
        }

        return match ($toolChoice) {
            ToolChoice::Any => ['function_calling_config' => ['mode' => 'ANY']],
            ToolChoice::Auto => ['function_calling_config' => ['mode' => 'AUTO']],
            ToolChoice::None => ['function_calling_config' => ['mode' => 'NONE']],
            null => $toolChoice,
        };
    }
}



================================================
FILE: src/Providers/Gemini/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Contracts\Schema;
use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  array<Tool>  $tools
     * @return array<array<string, mixed>>
     */
    public static function map(array $tools): array
    {
        if ($tools === []) {
            return [];
        }

        return array_map(fn (Tool $tool): array => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            ...$tool->hasParameters() ? [
                'parameters' => [
                    'type' => 'object',
                    'properties' => self::mapProperties($tool->parameters()),
                    'required' => $tool->requiredParameters(),
                ],
            ] : [],
        ], $tools);
    }

    /**
     * @param  array<string,Schema>  $properties
     * @return array<string,mixed>
     */
    public static function mapProperties(array $properties): array
    {
        return Arr::mapWithKeys($properties, fn (Schema $schema, string $name): array => [
            $name => (new SchemaMap($schema))->toArray(),
        ]);
    }
}



================================================
FILE: src/Providers/Gemini/Support/MediaUrlDetector.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\Support;

class MediaUrlDetector
{
    public static function shouldPassAsFileUri(string $url): bool
    {
        if (self::isYouTubeUrl($url)) {
            return true;
        }

        return self::isGeminiFileApiUri($url);
    }

    public static function isYouTubeUrl(string $url): bool
    {
        return (bool) preg_match('/^https?:\/\/(www\.)?(youtube\.com\/watch|youtu\.be\/)/i', $url);
    }

    public static function isGeminiFileApiUri(string $url): bool
    {
        return str_starts_with($url, 'https://generativelanguage.googleapis.com/v1beta/files/');
    }
}



================================================
FILE: src/Providers/Gemini/ValueObjects/GeminiCachedObject.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\ValueObjects;

use Illuminate\Support\Carbon;

readonly class GeminiCachedObject
{
    public function __construct(
        public string $model,
        public string $name,
        public int $tokens,
        public Carbon $expiresAt
    ) {}

    /**
     * @param  array<string,mixed>  $response
     */
    public static function fromResponse(string $model, array $response): self
    {
        return new self(
            model: $model,
            name: data_get($response, 'name', ''),
            tokens: data_get($response, 'usageMetadata.totalTokenCount', 0),
            expiresAt: Carbon::parse(data_get($response, 'expireTime'))
        );
    }
}



================================================
FILE: src/Providers/Gemini/ValueObjects/MessagePartWithSearchGroundings.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\ValueObjects;

use Illuminate\Contracts\Support\Arrayable;

/**
 * @implements Arrayable<string,mixed>
 */
class MessagePartWithSearchGroundings implements Arrayable
{
    /**
     * @param  SearchGrounding[]  $groundings
     */
    public function __construct(
        public readonly string $text,
        public readonly int $startIndex,
        public readonly int $endIndex,
        public readonly array $groundings = []
    ) {}

    /**
     * @return array<string,mixed>
     */
    #[\Override]
    public function toArray(): array
    {
        return [
            'text' => $this->text,
            'startIndex' => $this->startIndex,
            'endIndex' => $this->endIndex,
            'groundings' => array_map(
                fn (SearchGrounding $grounding): array => $grounding->toArray(),
                $this->groundings
            ),
        ];
    }
}



================================================
FILE: src/Providers/Gemini/ValueObjects/SearchGrounding.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Gemini\ValueObjects;

use Illuminate\Contracts\Support\Arrayable;

/**
 * @implements Arrayable<string,mixed>
 */
class SearchGrounding implements Arrayable
{
    public function __construct(
        public readonly string $title,
        public readonly string $uri,
        public readonly float $confidence
    ) {}

    /**
     * @return array<string,mixed>
     */
    #[\Override]
    public function toArray(): array
    {
        return [
            'title' => $this->title,
            'uri' => $this->uri,
            'confidence' => $this->confidence,
        ];
    }
}



================================================
FILE: src/Providers/Groq/Groq.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as AudioTextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Enums\Provider as ProviderName;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Providers\Groq\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Groq\Handlers\Audio;
use Prism\Prism\Providers\Groq\Handlers\Stream;
use Prism\Prism\Providers\Groq\Handlers\Structured;
use Prism\Prism\Providers\Groq\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class Groq extends Provider
{
    use InitializesClient, ProcessRateLimits;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handle($request);
    }

    #[\Override]
    public function textToSpeech(TextToSpeechRequest $request): AudioResponse
    {
        $handler = new Audio($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handleTextToSpeech($request);
    }

    #[\Override]
    public function speechToText(SpeechToTextRequest $request): AudioTextResponse
    {
        $handler = new Audio($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handleSpeechToText($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make(
                rateLimits: $this->processRateLimits($e->response),
                retryAfter: (int) $e->response->header('retry-after')
            ),
            529 => throw PrismProviderOverloadedException::make(ProviderName::Groq),
            413 => throw PrismRequestTooLargeException::make(ProviderName::Groq),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @return Generator<StreamEvent>
     */
    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handle($request);
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/Groq/Concerns/ProcessRateLimits.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Concerns;

use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Carbon;
use Illuminate\Support\Str;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ProcessRateLimits
{
    /**
     * @return ProviderRateLimit[]
     */
    protected function processRateLimits(Response $response): array
    {
        $limitHeaders = array_filter(
            $response->getHeaders(),
            fn ($headerName) => Str::startsWith($headerName, 'x-ratelimit-'),
            ARRAY_FILTER_USE_KEY
        );

        $rateLimits = [];

        foreach ($limitHeaders as $headerName => $headerValues) {
            $limitName = Str::of($headerName)->afterLast('-')->toString();
            $fieldName = Str::of($headerName)->after('x-ratelimit-')->beforeLast('-')->toString();

            $rateLimits[$limitName][$fieldName] = $headerValues[0];
        }

        return array_values(Arr::map($rateLimits, function ($fields, $limitName): ProviderRateLimit {
            $resetsAt = data_get($fields, 'reset', '');

            if (str_contains($resetsAt, 'ms')) {
                $resetMilliseconds = Str::of($resetsAt)->before('ms')->toString();
                $resetMinutes = 0;
                $resetSeconds = 0;
            } else {
                $resetMilliseconds = 0;

                $resetMinutes = str_contains($resetsAt, 'm')
                    ? Str::of($resetsAt)->before('m')->toString()
                    : 0;

                $resetSeconds = str_contains($resetsAt, 'm')
                    ? Str::of($resetsAt)->after('m')->before('s')->toString()
                    : Str::of($resetsAt)->before('s')->toString();
            }

            return new ProviderRateLimit(
                name: $limitName,
                limit: data_get($fields, 'limit') !== null
                    ? (int) data_get($fields, 'limit')
                    : null,
                remaining: data_get($fields, 'remaining') !== null
                    ? (int) data_get($fields, 'remaining')
                    : null,
                resetsAt: data_get($fields, 'reset') !== null
                    ? Carbon::now()->addMinutes((int) $resetMinutes)->addSeconds((int) $resetSeconds)->addMilliseconds((int) $resetMilliseconds)
                    : null
            );
        }));
    }
}



================================================
FILE: src/Providers/Groq/Concerns/ValidateResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ValidateResponse
{
    protected function validateResponse(Response $response): void
    {
        $data = $response->json();

        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(vsprintf(
                'Groq Error:  [%s] %s',
                [
                    data_get($data, 'error.type', 'unknown'),
                    data_get($data, 'error.message', 'unknown'),
                ]
            ));
        }
    }

    /**
     * @return ProviderRateLimit[]
     */
    abstract protected function processRateLimits(Response $response): array;
}



================================================
FILE: src/Providers/Groq/Handlers/Audio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Handlers;

use Exception;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Providers\Groq\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Groq\Maps\TextToSpeechRequestMapper;
use Prism\Prism\ValueObjects\GeneratedAudio;
use Prism\Prism\ValueObjects\Usage;

class Audio
{
    use ProcessRateLimits;

    public function __construct(protected PendingRequest $client) {}

    public function handleTextToSpeech(TextToSpeechRequest $request): AudioResponse
    {
        $mapper = new TextToSpeechRequestMapper($request);

        $response = $this->client->post('audio/speech', $mapper->toPayload());

        if (! $response->successful()) {
            throw new Exception('Failed to generate audio: '.$response->body());
        }

        $audioContent = $response->body();
        $base64Audio = base64_encode($audioContent);

        return new AudioResponse(
            audio: new GeneratedAudio(
                base64: $base64Audio,
            ),
        );
    }

    public function handleSpeechToText(SpeechToTextRequest $request): TextResponse
    {
        $filename = $this->generateFilename($request->input()->mimeType());

        $response = $this
            ->client
            ->attach(
                'file',
                $request->input()->resource(),
                $filename,
                ['Content-Type' => $request->input()->mimeType()]
            )
            ->post('audio/transcriptions', Arr::whereNotNull([
                'model' => $request->model(),
                'language' => $request->providerOptions('language') ?? null,
                'prompt' => $request->providerOptions('prompt') ?? null,
                'response_format' => $request->providerOptions('response_format') ?? null,
                'temperature' => $request->providerOptions('temperature') ?? null,
            ]));

        if (json_validate($response->body())) {
            $data = $response->json();

            if (! $response->successful()) {
                throw new Exception('Failed to transcribe audio: '.$response->body());
            }

            return new TextResponse(
                text: $data['text'] ?? '',
                usage: isset($data['usage'])
                    ? new Usage(
                        promptTokens: $data['usage']['prompt_tokens'] ?? 0,
                        completionTokens: $data['usage']['completion_tokens'] ?? 0,
                    )
                    : null,
                additionalContent: $data,
            );
        }

        // Handle other response formats like vtt
        return new TextResponse(
            text: $response->body(),
        );
    }

    protected function generateFilename(?string $mimeType): string
    {
        $extension = match ($mimeType) {
            'audio/flac' => 'flac',
            'audio/mpeg', 'audio/mp3' => 'mp3',
            'audio/mp4' => 'mp4',
            'audio/mpga' => 'mpga',
            'audio/m4a', 'audio/x-m4a' => 'm4a',
            'audio/ogg' => 'ogg',
            'audio/opus' => 'opus',
            'audio/wav', 'audio/wave' => 'wav',
            'audio/webm' => 'webm',
            default => 'mp3', // Default to mp3 if unknown
        };

        return "audio.{$extension}";
    }
}



================================================
FILE: src/Providers/Groq/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\Groq\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Groq\Concerns\ValidateResponse;
use Prism\Prism\Providers\Groq\Maps\FinishReasonMap;
use Prism\Prism\Providers\Groq\Maps\MessageMap;
use Prism\Prism\Providers\Groq\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Groq\Maps\ToolMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools, ProcessRateLimits, ValidateResponse;

    protected StreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        // Only reset state on the first call (depth 0)
        if ($depth === 0) {
            $this->state->reset();
        }

        $text = '';
        $toolCalls = [];

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            // Emit stream start event if not already started
            if ($this->state->shouldEmitStreamStart()) {
                $this->state->withMessageId(EventID::generate())->markStreamStarted();

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $request->model(),
                    provider: 'groq'
                );
            }

            if ($this->hasError($data)) {
                yield from $this->handleErrors($data, $request);

                continue;
            }

            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $toolCalls);

                continue;
            }

            if ($this->mapFinishReason($data) === FinishReason::ToolCalls) {
                // Complete any ongoing text
                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                return;
            }

            $content = data_get($data, 'choices.0.delta.content', '') ?? '';

            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();

                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            // Only emit completion events when we actually have a finish reason (not null)
            $rawFinishReason = data_get($data, 'choices.0.finish_reason');
            if ($rawFinishReason !== null) {
                $finishReason = $this->mapFinishReason($data);

                // Complete text if we have any
                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                // Extract usage information from the final chunk
                $usage = $this->extractUsage($data);

                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $finishReason,
                    usage: $usage
                );
            }
        }
    }

    /**
     * @return array<string, mixed>|null Parsed JSON data or null if line should be skipped
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if ($line === '' || $line === '[DONE]') {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Groq', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        foreach (data_get($data, 'choices.0.delta.tool_calls', []) as $index => $toolCall) {
            if ($name = data_get($toolCall, 'function.name')) {
                $toolCalls[$index]['name'] = $name;
                $toolCalls[$index]['arguments'] = '';
                $toolCalls[$index]['id'] = data_get($toolCall, 'id');
            }

            $arguments = data_get($toolCall, 'function.arguments');

            if (! is_null($arguments)) {
                if (! isset($toolCalls[$index]['arguments'])) {
                    $toolCalls[$index]['arguments'] = '';
                }
                $toolCalls[$index]['arguments'] .= $arguments;
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        string $text,
        array $toolCalls,
        int $depth
    ): Generator {
        $mappedToolCalls = $this->mapToolCalls($toolCalls);

        // Emit tool call events
        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        // Emit tool result events
        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId()
            );
        }

        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        // Reset text state for next response
        $this->state->resetTextState();
        $this->state->withMessageId(EventID::generate());

        $nextResponse = $this->sendRequest($request);
        yield from $this->processStream($nextResponse, $request, $depth + 1);
    }

    /**
     * Convert raw tool call data to ToolCall objects.
     *
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return collect($toolCalls)
            ->map(function ($toolCall): ToolCall {
                $arguments = data_get($toolCall, 'arguments', '');

                // Parse JSON arguments if needed
                if (is_string($arguments) && $arguments !== '') {
                    try {
                        $parsedArguments = json_decode($arguments, true, flags: JSON_THROW_ON_ERROR);
                        $arguments = $parsedArguments;
                    } catch (Throwable) {
                        // If JSON parsing fails, use the raw string
                        $arguments = ['raw' => $arguments];
                    }
                }

                return new ToolCall(
                    data_get($toolCall, 'id'),
                    data_get($toolCall, 'name'),
                    $arguments,
                );
            })
            ->toArray();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        return (bool) data_get($data, 'choices.0.delta.tool_calls');
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasError(array $data): bool
    {
        return data_get($data, 'error') !== null;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(data_get($data, 'choices.0.finish_reason'));
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data): ?Usage
    {
        $usage = data_get($data, 'usage');

        if (! $usage) {
            return null;
        }

        return new Usage(
            promptTokens: (int) data_get($usage, 'prompt_tokens', 0),
            completionTokens: (int) data_get($usage, 'completion_tokens', 0)
        );
    }

    protected function sendRequest(Request $request): Response
    {
        try {
            return $this
                ->client
                ->withOptions(['stream' => true])
                ->throw()
                ->post('chat/completions',
                    array_merge([
                        'stream' => true,
                        'model' => $request->model(),
                        'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                        'max_tokens' => $request->maxTokens(),
                    ], Arr::whereNotNull([
                        'temperature' => $request->temperature(),
                        'top_p' => $request->topP(),
                        'tools' => ToolMap::map($request->tools()),
                        'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
                    ]))
                );
        } catch (\Illuminate\Http\Client\RequestException $e) {
            if ($e->response->getStatusCode() === 429) {
                throw new PrismRateLimitedException(
                    $this->processRateLimits($e->response),
                    (int) $e->response->header('retry-after')
                );
            }

            throw PrismException::providerRequestError($request->model(), $e);
        }
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    /**
     * @param  array<string, mixed>  $data
     * @return Generator<StreamEvent>
     */
    protected function handleErrors(array $data, Request $request): Generator
    {
        $error = data_get($data, 'error', []);
        $type = data_get($error, 'type', 'unknown_error');
        $message = data_get($error, 'message', 'No error message provided');

        if ($type === 'rate_limit_exceeded') {
            throw new PrismRateLimitedException([]);
        }

        yield new ErrorEvent(
            id: EventID::generate(),
            timestamp: time(),
            errorType: $type,
            message: $message,
            recoverable: false
        );
    }
}



================================================
FILE: src/Providers/Groq/Handlers/Structured.php
================================================
<?php

namespace Prism\Prism\Providers\Groq\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Providers\Groq\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Groq\Concerns\ValidateResponse;
use Prism\Prism\Providers\Groq\Maps\FinishReasonMap;
use Prism\Prism\Providers\Groq\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use ProcessRateLimits, ValidateResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $request = $this->appendMessageForJsonMode($request);

        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        return $this->createResponse($request, $data, $response);
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        return $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'response_format' => ['type' => 'json_object'],
            ]))
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function createResponse(Request $request, array $data, ClientResponse $clientResponse): StructuredResponse
    {
        $text = data_get($data, 'choices.0.message.content') ?? '';

        $responseMessage = new AssistantMessage($text);
        $request->addMessage($responseMessage);

        $step = new Step(
            text: $text,
            finishReason: FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', '')),
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($clientResponse),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        );

        $this->responseBuilder->addStep($step);

        return $this->responseBuilder->toResponse();
    }

    protected function appendMessageForJsonMode(Request $request): Request
    {
        return $request->addMessage(new SystemMessage(sprintf(
            "Respond with JSON that matches the following schema: \n %s",
            json_encode($request->schema()->toArray(), JSON_PRETTY_PRINT)
        )));
    }
}



================================================
FILE: src/Providers/Groq/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Groq\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Groq\Concerns\ValidateResponse;
use Prism\Prism\Providers\Groq\Maps\FinishReasonMap;
use Prism\Prism\Providers\Groq\Maps\MessageMap;
use Prism\Prism\Providers\Groq\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Groq\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools, ProcessRateLimits,  ValidateResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): TextResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $responseMessage = new AssistantMessage(
            data_get($data, 'choices.0.message.content') ?? '',
            $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', []) ?? []),
        );

        $request->addMessage($responseMessage);

        $finishReason = FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', ''));

        return match ($finishReason) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request, $response),
            FinishReason::Stop, FinishReason::Length => $this->handleStop($data, $request, $response, $finishReason),
            default => throw new PrismException('Groq: unhandled finish reason'),
        };
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        return $this->client->post(
            'chat/completions',
            Arr::whereNotNull([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'tools' => ToolMap::map($request->tools()),
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            ])
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request, ClientResponse $clientResponse): TextResponse
    {
        $toolResults = $this->callTools(
            $request->tools(),
            $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', []) ?? []),
        );

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $clientResponse, FinishReason::ToolCalls, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request, ClientResponse $clientResponse, FinishReason $finishReason): TextResponse
    {
        $this->addStep($data, $request, $clientResponse, $finishReason);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(array $data, Request $request, ClientResponse $clientResponse, FinishReason $finishReason, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'choices.0.message.content') ?? '',
            finishReason: $finishReason,
            toolCalls: $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', []) ?? []),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($clientResponse),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'function.name'),
            arguments: data_get($toolCall, 'function.arguments'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/Groq/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(?string $reason): FinishReason
    {
        return match ($reason) {
            'stop' => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            'content_filter' => FinishReason::ContentFilter,
            null => FinishReason::Unknown,
            default => FinishReason::Other,
        };
    }
}



================================================
FILE: src/Providers/Groq/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Groq\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'image_url',
            'image_url' => [
                'url' => $this->media->isUrl()
                    ? $this->media->url()
                    : sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64()),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::Groq;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Groq/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $this->mappedMessages[] = [
                'role' => 'tool',
                'tool_call_id' => $toolResult->toolCallId,
                'content' => $toolResult->result,
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $imageParts = array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $message->images());

        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => $message->text()],
                ...$imageParts,
            ],
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $toolCalls = array_map(fn (ToolCall $toolCall): array => [
            'id' => $toolCall->id,
            'type' => 'function',
            'function' => [
                'name' => $toolCall->name,
                'arguments' => json_encode($toolCall->arguments()),
            ],
        ], $message->toolCalls);

        $this->mappedMessages[] = array_filter([
            'role' => 'assistant',
            'content' => $message->content,
            'tool_calls' => $toolCalls,
        ]);
    }
}



================================================
FILE: src/Providers/Groq/Maps/TextToSpeechRequestMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Contracts\ProviderRequestMapper;
use Prism\Prism\Enums\Provider;

class TextToSpeechRequestMapper extends ProviderRequestMapper
{
    public function __construct(
        public readonly TextToSpeechRequest $request
    ) {}

    /**
     * @return array<string, mixed>
     */
    public function toPayload(): array
    {
        $providerOptions = $this->request->providerOptions();

        $baseData = [
            'model' => $this->request->model(),
            'input' => $this->request->input(),
            'voice' => $this->request->voice(),
        ];

        $supportedOptions = [
            'response_format' => $providerOptions['response_format'] ?? null,
            'speed' => $providerOptions['speed'] ?? null,
        ];

        return array_merge(
            $baseData,
            Arr::whereNotNull($supportedOptions),
            array_diff_key($providerOptions, $supportedOptions)
        );
    }

    protected function provider(): string|Provider
    {
        return Provider::Groq;
    }
}



================================================
FILE: src/Providers/Groq/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Maps;

use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Exceptions\PrismException;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $toolChoice,
                ],
            ];
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            null => $toolChoice,
            default => throw new PrismException('Invalid tool choice')
        };
    }
}



================================================
FILE: src/Providers/Groq/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Groq\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<string, mixed>
     */
    public static function Map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => [
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                'parameters' => [
                    'type' => 'object',
                    'properties' => $tool->parametersAsArray(),
                    'required' => $tool->requiredParameters(),
                ],
            ],
        ], $tools);
    }
}



================================================
FILE: src/Providers/Mistral/Mistral.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as AudioTextResponse;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Enums\Provider as ProviderName;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Handlers\Audio;
use Prism\Prism\Providers\Mistral\Handlers\Embeddings;
use Prism\Prism\Providers\Mistral\Handlers\OCR;
use Prism\Prism\Providers\Mistral\Handlers\Stream;
use Prism\Prism\Providers\Mistral\Handlers\Structured;
use Prism\Prism\Providers\Mistral\Handlers\Text;
use Prism\Prism\Providers\Mistral\ValueObjects\OCRResponse;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\Media\Document;

class Mistral extends Provider
{
    use InitializesClient, ProcessRateLimits;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            )
        );

        return $handler->handle($request);
    }

    #[\Override]
    public function embeddings(EmbeddingRequest $request): EmbeddingResponse
    {
        $handler = new Embeddings($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    /**
     * @throws PrismRateLimitedException
     * @throws PrismException
     */
    public function ocr(string $model, Document $document): OCRResponse
    {
        if (! $document->isUrl()) {
            throw new PrismException('Document must be based on a URL');
        }

        $handler = new OCR(
            client: $this->client([
                'timeout' => 120,
            ]),
            model: $model,
            document: $document
        );

        return $handler->handle();
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream(
            $this->client($request->clientOptions(), $request->clientRetry()),
            $this->apiKey
        );

        return $handler->handle($request);
    }

    #[\Override]
    public function speechToText(SpeechToTextRequest $request): AudioTextResponse
    {
        $handler = new Audio(
            $this->client(
                $request->clientOptions(),
                $request->clientRetry()
            )
        );

        return $handler->handleSpeechToText($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make(
                rateLimits: $this->processRateLimits($e->response),
                retryAfter: null
            ),
            529 => throw PrismProviderOverloadedException::make(ProviderName::Mistral),
            413 => throw PrismRequestTooLargeException::make(ProviderName::Mistral),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/Mistral/Concerns/ExtractsText.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Concerns;

trait ExtractsText
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractText(array $data): string
    {
        $content = data_get($data, 'content');

        if (is_string($content)) {
            return $content;
        }

        if (is_array($content)) {
            return array_reduce($content, function (string $text, array $block): string {
                if (data_get($block, 'type') === 'text') {
                    $text .= data_get($block, 'text', '');
                }

                return $text;
            }, '');
        }

        return '';
    }
}



================================================
FILE: src/Providers/Mistral/Concerns/ExtractsThinking.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Concerns;

trait ExtractsThinking
{
    /**
     * @param  array<string, mixed>  $data
     * @return array<string, string>
     */
    protected function extractThinking(array $data): array
    {
        $content = data_get($data, 'content', []);

        if (! is_array($content)) {
            return [];
        }

        $thinkingText = '';

        foreach ($content as $block) {
            if (data_get($block, 'type') === 'thinking') {
                $thinkingBlocks = data_get($block, 'thinking', []);
                foreach ($thinkingBlocks as $thinkingBlock) {
                    $thinkingText .= data_get($thinkingBlock, 'text', '');
                }
            }
        }

        return $thinkingText !== '' ? ['thinking' => $thinkingText] : [];
    }
}



================================================
FILE: src/Providers/Mistral/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\Mistral\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', ''));
    }
}



================================================
FILE: src/Providers/Mistral/Concerns/ProcessRateLimits.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Concerns;

use Illuminate\Http\Client\Response;
use Illuminate\Support\Carbon;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ProcessRateLimits
{
    /**
     * @return ProviderRateLimit[]
     */
    protected function processRateLimits(Response $response): array
    {
        return [
            new ProviderRateLimit(
                name: 'tokens',
                limit: (int) $response->header('ratelimitbysize-limit'),
                remaining: (int) $response->header('ratelimitbysize-remaining'),
                resetsAt: Carbon::now()->addSeconds((int) $response->header('ratelimitbysize-reset')),
            ),
        ];
    }
}



================================================
FILE: src/Providers/Mistral/Concerns/ValidatesResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ValidatesResponse
{
    protected function validateResponse(Response $response): void
    {
        $data = $response->json();

        if (! $data || data_get($data, 'object') === 'error') {
            $message = data_get($data, 'message', 'unknown');

            throw PrismException::providerResponseError(vsprintf(
                'Mistral Error: [%s] %s',
                [
                    data_get($data, 'type', 'unknown'),
                    is_array($message) ? json_encode($message) : $message,
                ]
            ));
        }
    }

    /**
     * @return ProviderRateLimit[]
     */
    abstract protected function processRateLimits(Response $response): array;
}



================================================
FILE: src/Providers/Mistral/Handlers/Audio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Exception;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\ValueObjects\Usage;

class Audio
{
    use ProcessRateLimits;

    public function __construct(protected PendingRequest $client) {}

    public function handleSpeechToText(SpeechToTextRequest $request): TextResponse
    {
        $response = $this
            ->client
            ->attach(
                'file',
                $request->input()->resource(),
                'audio',
                ['Content-Type' => $request->input()->mimeType()]
            )
            ->post('audio/transcriptions', Arr::whereNotNull([
                'model' => $request->model(),
                'language' => $request->providerOptions('language') ?? null,
                'prompt' => $request->providerOptions('prompt') ?? null,
                'response_format' => $request->providerOptions('response_format') ?? null,
                'temperature' => $request->providerOptions('temperature') ?? null,
                'timestamp_granularities' => $request->providerOptions('timestamp_granularities') ?? null,
            ]));

        if (json_validate($response->body())) {
            $data = $response->json();

            if (! $response->successful()) {
                throw new Exception('Failed to transcribe audio: '.$response->body());
            }

            return new TextResponse(
                text: $data['text'] ?? '',
                usage: isset($data['usage'])
                    ? new Usage(
                        promptTokens: $data['usage']['prompt_tokens'] ?? 0,
                        completionTokens: $data['usage']['completion_tokens'] ?? 0,
                    )
                    : null,
                additionalContent: $data,
            );
        }

        // Handle other response formats like vtt
        return new TextResponse(
            text: $response->body(),
        );
    }
}



================================================
FILE: src/Providers/Mistral/Handlers/Embeddings.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Prism\Prism\Embeddings\Request;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

class Embeddings
{
    use ProcessRateLimits, ValidatesResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): EmbeddingsResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        return new EmbeddingsResponse(
            embeddings: array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($data, 'data', [])),
            usage: new EmbeddingsUsage(data_get($data, 'usage.total_tokens', null)),
            meta: new Meta(
                id: data_get($data, 'id', ''),
                model: data_get($data, 'model', ''),
                rateLimits: $this->processRateLimits($response)
            )
        );
    }

    protected function sendRequest(Request $request): Response
    {
        return $this->client->post(
            'embeddings',
            [
                'model' => $request->model(),
                'input' => $request->inputs(),
            ]
        );
    }
}



================================================
FILE: src/Providers/Mistral/Handlers/OCR.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Providers\Mistral\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Mistral\Maps\DocumentMapper;
use Prism\Prism\Providers\Mistral\ValueObjects\OCRResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\ValueObjects\Media\Document;

class OCR
{
    use CallsTools;
    use MapsFinishReason;
    use ProcessRateLimits;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(
        protected PendingRequest $client,
        protected string $model,
        protected Document $document,
    ) {
        $this->responseBuilder = new ResponseBuilder;
    }

    /**
     * @throws PrismRateLimitedException
     * @throws PrismException
     */
    public function handle(): OCRResponse
    {
        $response = $this->sendRequest();

        return OCRResponse::fromResponse($this->model, $response);
    }

    /**
     * @return array<string, mixed>
     *
     * @throws PrismException
     */
    protected function sendRequest(): array
    {
        $response = $this->client->post('/ocr', [
            'model' => $this->model,
            'document' => (new DocumentMapper($this->document))->toPayload(),
        ]);

        return $response->json();
    }
}



================================================
FILE: src/Providers/Mistral/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\Mistral\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Mistral\Maps\MessageMap;
use Prism\Prism\Providers\Mistral\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Mistral\Maps\ToolMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools, MapsFinishReason, ProcessRateLimits, ValidatesResponse;

    protected StreamState $state;

    public function __construct(
        protected PendingRequest $client,
        #[\SensitiveParameter] protected string $apiKey,
    ) {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        if ($depth === 0) {
            $this->state->reset();
        }

        $text = '';
        $toolCalls = [];

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            if ($this->state->shouldEmitStreamStart()) {
                $this->state->withMessageId(EventID::generate())->markStreamStarted();

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $request->model(),
                    provider: 'mistral'
                );
            }

            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $toolCalls);

                if ($this->mapFinishReason($data) === FinishReason::ToolCalls) {
                    if ($this->state->hasTextStarted() && $text !== '') {
                        yield new TextCompleteEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            messageId: $this->state->messageId()
                        );
                    }

                    yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                    return;
                }

                continue;
            }

            if ($this->mapFinishReason($data) === FinishReason::ToolCalls) {
                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                return;
            }

            $content = data_get($data, 'choices.0.delta.content', '') ?? '';

            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();

                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            $rawFinishReason = data_get($data, 'choices.0.finish_reason');
            if ($rawFinishReason !== null) {
                $finishReason = $this->mapFinishReason($data);

                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $usage = $this->extractUsage($data);

                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $finishReason,
                    usage: $usage
                );
            }
        }
    }

    /**
     * @return array<string, mixed>|null Parsed JSON data or null if the line should be skipped
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data:')));

        if ($line === '' || $line === '[DONE]') {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Mistral', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        $parts = data_get($data, 'choices.0.delta.tool_calls', []);

        foreach ($parts as $index => $part) {
            if (isset($part['function'])) {
                $toolCalls[$index]['id'] = data_get($part, 'id', Str::random(8));
                $toolCalls[$index]['name'] = data_get($part, 'function.name');
                $toolCalls[$index]['arguments'] = data_get($part, 'function.arguments', '');
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        string $text,
        array $toolCalls,
        int $depth
    ): Generator {
        $mappedToolCalls = $this->mapToolCalls($toolCalls);

        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId()
            );
        }

        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        $this->state->resetTextState();
        $this->state->withMessageId(EventID::generate());

        $nextResponse = $this->sendRequest($request);
        yield from $this->processStream($nextResponse, $request, $depth + 1);
    }

    /**
     * Convert raw tool call data to ToolCall objects.
     *
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return collect($toolCalls)
            ->map(function ($toolCall): ToolCall {
                $arguments = data_get($toolCall, 'arguments', '');

                if (is_string($arguments) && $arguments !== '') {
                    try {
                        $parsedArguments = json_decode($arguments, true, flags: JSON_THROW_ON_ERROR);
                        $arguments = $parsedArguments;
                    } catch (Throwable) {
                        $arguments = ['raw' => $arguments];
                    }
                }

                return new ToolCall(
                    data_get($toolCall, 'id'),
                    data_get($toolCall, 'name'),
                    $arguments,
                );
            })
            ->toArray();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        $parts = data_get($data, 'choices.0.delta.tool_calls', []);

        foreach ($parts as $part) {
            if (isset($part['function'])) {
                return true;
            }
        }

        return false;
    }

    protected function sendRequest(Request $request): Response
    {
        return $this
            ->client
            ->withOptions(['stream' => true])
            ->post('chat/completions',
                array_merge([
                    'stream' => true,
                    'model' => $request->model(),
                    'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                    'max_tokens' => $request->maxTokens(),
                ], Arr::whereNotNull([
                    'temperature' => $request->temperature(),
                    'top_p' => $request->topP(),
                    'tools' => ToolMap::map($request->tools()),
                    'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
                ]))
            );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data): ?Usage
    {
        $usage = data_get($data, 'usage');

        if (! $usage) {
            return null;
        }

        return new Usage(
            promptTokens: (int) data_get($usage, 'prompt_tokens', 0),
            completionTokens: (int) data_get($usage, 'completion_tokens', 0)
        );
    }
}



================================================
FILE: src/Providers/Mistral/Handlers/Structured.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Providers\Mistral\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Mistral\Maps\FinishReasonMap;
use Prism\Prism\Providers\Mistral\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use MapsFinishReason;
    use ProcessRateLimits;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $request = $this->appendMessageForJsonMode($request);

        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        return $this->createResponse($request, $data);
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        return $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'response_format' => ['type' => 'json_object'],
            ]))
        );
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function createResponse(Request $request, array $data): StructuredResponse
    {
        $text = data_get($data, 'choices.0.message.content') ?? '';

        $responseMessage = new AssistantMessage($text);
        $request->addMessage($responseMessage);

        $step = new Step(
            text: $text,
            finishReason: FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', '')),
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        );

        $this->responseBuilder->addStep($step);

        return $this->responseBuilder->toResponse();
    }

    protected function appendMessageForJsonMode(Request $request): Request
    {
        return $request->addMessage(new SystemMessage(sprintf(
            "Respond with JSON that matches the following schema: \n %s",
            json_encode($request->schema()->toArray(), JSON_PRETTY_PRINT)
        )));
    }
}



================================================
FILE: src/Providers/Mistral/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Mistral\Concerns\ExtractsText;
use Prism\Prism\Providers\Mistral\Concerns\ExtractsThinking;
use Prism\Prism\Providers\Mistral\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Mistral\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Mistral\Maps\MessageMap;
use Prism\Prism\Providers\Mistral\Maps\ToolChoiceMap;
use Prism\Prism\Providers\Mistral\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools;
    use ExtractsText;
    use ExtractsThinking;
    use MapsFinishReason;
    use ProcessRateLimits;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): Response
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $responseMessage = new AssistantMessage(
            $this->extractText(data_get($data, 'choices.0.message', [])),
            $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', [])),
        );

        $request->addMessage($responseMessage);

        return match ($this->mapFinishReason($data)) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request, $response),
            FinishReason::Stop => $this->handleStop($data, $request, $response),
            default => throw PrismException::providerResponseError('Invalid tool choice'),
        };
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request, ClientResponse $clientResponse): Response
    {
        $toolResults = $this->callTools(
            $request->tools(),
            $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', [])),
        );

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $clientResponse, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request, ClientResponse $clientResponse): Response
    {
        $this->addStep($data, $request, $clientResponse);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        if ($request->maxSteps() === 0) {
            return true;
        }

        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(array $data, Request $request, ClientResponse $clientResponse, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: $this->extractText(data_get($data, 'choices.0.message', [])),
            finishReason: $this->mapFinishReason($data),
            toolCalls: $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', [])),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($clientResponse),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: $this->extractThinking(data_get($data, 'choices.0.message', [])),
        ));
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        return $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'tools' => ToolMap::map($request->tools()),
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            ]))
        );
    }

    /**
     * @param  array<mixed>|null  $toolCalls
     * @return array<mixed>
     */
    protected function mapToolCalls(?array $toolCalls): array
    {
        if (! $toolCalls) {
            return [];
        }

        return array_map(fn ($toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'function.name'),
            arguments: data_get($toolCall, 'function.arguments'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/Mistral/Maps/DocumentMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Mistral\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Document;

/**
 * @property Document $media
 */
class DocumentMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,string>
     */
    public function toPayload(): array
    {
        return Arr::whereNotNull([
            'type' => 'document_url',
            'document_url' => $this->media->url(),
            'document_name' => $this->media->documentTitle(),
        ]);
    }

    protected function provider(): string|Provider
    {
        return Provider::Mistral;
    }

    protected function validateMedia(): bool
    {
        return $this->media->isUrl();
    }
}



================================================
FILE: src/Providers/Mistral/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(?string $reason): FinishReason
    {
        return match ($reason) {
            'stop', => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            'content_filter' => FinishReason::ContentFilter,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/Mistral/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Mistral\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'image_url',
            'image_url' => [
                'url' => $this->media->isUrl()
                    ? $this->media->url()
                    : sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64()),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::Mistral;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Mistral/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $this->mappedMessages[] = [
                'role' => 'tool',
                'content' => $toolResult->result,
                'tool_call_id' => $toolResult->toolCallId,
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {

        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => $message->text()],
                ...self::mapImageParts($message->images()),
                ...self::mapDocumentParts($message->documents()),
            ],
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $toolCalls = array_map(fn (ToolCall $toolCall): array => [
            'id' => $toolCall->id,
            'type' => 'function',
            'function' => [
                'name' => $toolCall->name,
                'arguments' => json_encode($toolCall->arguments()),
            ],
        ], $message->toolCalls);

        $this->mappedMessages[] = array_filter([
            'role' => 'assistant',
            'content' => $message->content,
            'tool_calls' => $toolCalls,
        ]);
    }

    /**
     * @param  Image[]  $images
     * @return array<int, mixed>
     */
    protected static function mapImageParts(array $images): array
    {
        return array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $images);
    }

    /**
     * @param  Document[]  $documents
     * @return array<int,mixed>
     */
    protected static function mapDocumentParts(array $documents): array
    {
        return array_map(fn (Document $document): array => (new DocumentMapper($document))->toPayload(), $documents);
    }
}



================================================
FILE: src/Providers/Mistral/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_null($toolChoice)) {
            return null;
        }

        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $toolChoice,
                ],
            ];
        }

        if (! in_array($toolChoice, [ToolChoice::Auto, ToolChoice::Any, ToolChoice::None])) {
            throw new InvalidArgumentException('Invalid tool choice');
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            ToolChoice::Any => 'any',
            ToolChoice::None => 'none',
        };
    }
}



================================================
FILE: src/Providers/Mistral/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<mixed>
     */
    public static function map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => [
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                'parameters' => [
                    'type' => 'object',
                    'properties' => $tool->parametersAsArray(),
                    'required' => $tool->requiredParameters(),
                ],
            ],
        ], $tools);
    }
}



================================================
FILE: src/Providers/Mistral/ValueObjects/OCRPageResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\ValueObjects;

readonly class OCRPageResponse
{
    /**
     * @param array<int, array{
     *     id: string,
     *     top_left_x: int|null,
     *     top_left_y: int|null,
     *     bottom_right_x: int|null,
     *     bottom_right_y: int|null,
     *     image_base64: string|null,
     * }> $images
     * @param array{
     *      dpi: int,
     *      height: int,
     *      width: int,
     * } $dimensions
     */
    public function __construct(
        public int $index,
        public string $markdown,
        public array $images,
        public array $dimensions,
    ) {}

    /**
     * @param array{
     *     index: int,
     *     markdown: string,
     *     images: array{
     *     id: string,
     *     top_left_x: mixed,
     *     top_left_y: mixed,
     *     bottom_right_x: mixed,
     *     bottom_right_y: mixed,
     *     image_base64: string,
     *     }[],
     *     dimensions: array{
     *     dpi: int,
     *     height: int,
     *     width: int,
     *     }
     * } $page
     */
    public static function fromResponse(array $page): self
    {
        $images = [];

        foreach (data_get($page, 'images', []) as $image) {
            $images[] = [
                'id' => data_get($image, 'id', ''),
                'top_left_x' => data_get($image, 'top_left_x', null),
                'top_left_y' => data_get($image, 'top_left_y', null),
                'bottom_right_x' => data_get($image, 'bottom_right_x', null),
                'bottom_right_y' => data_get($image, 'bottom_right_y', null),
                'image_base64' => data_get($image, 'image_base64', null),
            ];
        }

        return new self(
            index: data_get($page, 'index', 0),
            markdown: data_get($page, 'markdown', ''),
            images: $images,
            dimensions: data_get($page, 'dimensions', [
                'dpi' => 0,
                'height' => 0,
                'width' => 0,
            ]),
        );
    }
}



================================================
FILE: src/Providers/Mistral/ValueObjects/OCRResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Mistral\ValueObjects;

readonly class OCRResponse
{
    /**
     * @param  array<OCRPageResponse>  $pages
     * @param  array{pages_processed: int, doc_size_bytes: int }  $usageInfo
     */
    public function __construct(
        public string $model,
        public array $pages,
        public array $usageInfo,
    ) {}

    /**
     * @param  array<string,mixed>  $response
     */
    public static function fromResponse(string $model, array $response): self
    {
        $pages = [];
        foreach (data_get($response, 'pages', []) as $page) {
            $pages[] = OCRPageResponse::fromResponse($page);
        }

        return new self(
            model: $model,
            pages: $pages,
            usageInfo: data_get($response, 'usage_info', [
                'pages_processed' => 0,
                'doc_size_bytes' => 0,
            ]),
        );
    }

    public function toText(): string
    {
        return collect($this->pages)->map(
            fn (OCRPageResponse $page): string => $page->markdown)->join("\n\n");
    }
}



================================================
FILE: src/Providers/Ollama/Ollama.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Embeddings\Request as EmbeddingsRequest;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Providers\Ollama\Handlers\Embeddings;
use Prism\Prism\Providers\Ollama\Handlers\Stream;
use Prism\Prism\Providers\Ollama\Handlers\Structured;
use Prism\Prism\Providers\Ollama\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class Ollama extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function embeddings(EmbeddingsRequest $request): EmbeddingsResponse
    {
        $handler = new Embeddings($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/Ollama/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\Ollama\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(data_get($data, 'done_reason', ''));
    }
}



================================================
FILE: src/Providers/Ollama/Concerns/ValidatesResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Concerns;

use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponse
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(sprintf(
                'Ollama Error: %s',
                data_get($data, 'error', 'unknown'),
            ));
        }
    }
}



================================================
FILE: src/Providers/Ollama/Handlers/Embeddings.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Embeddings\Request;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

class Embeddings
{
    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): EmbeddingsResponse
    {
        $response = $this->sendRequest($request);
        $data = $response->json();

        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(sprintf(
                'Ollama Error: %s',
                data_get($data, 'error', 'unknown'),
            ));
        }

        return new EmbeddingsResponse(
            embeddings: array_map(Embedding::fromArray(...), data_get($data, 'embeddings', [])),
            usage: new EmbeddingsUsage(data_get($data, 'prompt_eval_count', null)),
            meta: new Meta(
                id: '',
                model: data_get($data, 'model', ''),
            ),
        );
    }

    protected function sendRequest(Request $request): Response
    {
        return $this->client->post(
            'api/embed',
            Arr::whereNotNull([
                'model' => $request->model(),
                'input' => $request->inputs(),
                'options' => $request->providerOptions() ?: null,
            ])
        );
    }
}



================================================
FILE: src/Providers/Ollama/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\Ollama\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Ollama\Maps\MessageMap;
use Prism\Prism\Providers\Ollama\Maps\ToolMap;
use Prism\Prism\Providers\Ollama\ValueObjects\OllamaStreamState;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools, MapsFinishReason;

    protected OllamaStreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new OllamaStreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        $this->state->reset();
        $text = '';

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            // Emit stream start event if not already started
            if ($this->state->shouldEmitStreamStart()) {
                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $request->model(),
                    provider: 'ollama'
                );
                $this->state->markStreamStarted()->withMessageId(EventID::generate());
            }

            // Accumulate token counts
            $this->state->addPromptTokens((int) data_get($data, 'prompt_eval_count', 0));
            $this->state->addCompletionTokens((int) data_get($data, 'eval_count', 0));

            // Handle thinking content first
            $thinking = data_get($data, 'message.thinking', '');
            if ($thinking !== '') {
                if ($this->state->shouldEmitThinkingStart()) {
                    $this->state->withReasoningId(EventID::generate())->markThinkingStarted();
                    yield new ThinkingStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                yield new ThinkingEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $thinking,
                    reasoningId: $this->state->reasoningId()
                );

                continue;
            }

            // If we were emitting thinking and it's now stopped, mark it complete
            if ($this->state->hasThinkingStarted()) {
                yield new ThinkingCompleteEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    reasoningId: $this->state->reasoningId()
                );
                // Note: Can't easily reset just thinking flag with current StreamState API
                // This may need adjustment if tests fail
                // Don't continue here - we want to process the rest of this data chunk
            }

            // Accumulate tool calls if present (don't emit events yet)
            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $this->state->toolCalls());
                foreach ($toolCalls as $index => $toolCall) {
                    $this->state->addToolCall($index, $toolCall);
                }
            }

            // Handle text content
            $content = data_get($data, 'message.content', '');
            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();
                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            // Handle tool call completion when stream is done (like original)
            if ((bool) data_get($data, 'done', false) && $this->state->hasToolCalls()) {
                // Emit text complete if we had text content
                if ($this->state->hasTextStarted()) {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                yield from $this->handleToolCalls($request, $text, $depth);

                return;
            }

            // Handle regular completion (no tool calls)
            if ((bool) data_get($data, 'done', false)) {
                // Emit text complete if we had text content
                if ($this->state->hasTextStarted()) {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                // Emit stream end event with usage
                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: FinishReason::Stop,
                    usage: new Usage(
                        promptTokens: $this->state->promptTokens(),
                        completionTokens: $this->state->completionTokens()
                    )
                );

                return;
            }
        }
    }

    /**
     * @return array<string, mixed>|null Parsed JSON data or null if line should be skipped
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (in_array(trim($line), ['', '0'], true)) {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('Ollama', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        foreach (data_get($data, 'message.tool_calls', []) as $index => $toolCall) {
            if ($name = data_get($toolCall, 'function.name')) {
                $toolCalls[$index]['name'] = $name;
                $toolCalls[$index]['arguments'] = '';
                $toolCalls[$index]['id'] = data_get($toolCall, 'id');
            }

            if ($arguments = data_get($toolCall, 'function.arguments')) {

                $argumentValue = is_array($arguments) ? json_encode($arguments) : $arguments;
                $toolCalls[$index]['arguments'] .= $argumentValue;
            }
        }

        return $toolCalls;
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        string $text,
        int $depth
    ): Generator {
        $mappedToolCalls = $this->mapToolCalls($this->state->toolCalls());

        // Emit tool call events for each completed tool call
        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        // Execute tools and emit results
        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId(),
                success: true
            );
        }

        // Add messages for next turn
        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        // Continue streaming if within step limit
        $depth++;
        if ($depth < $request->maxSteps()) {
            $nextResponse = $this->sendRequest($request);
            yield from $this->processStream($nextResponse, $request, $depth);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        return (bool) data_get($data, 'message.tool_calls');
    }

    protected function sendRequest(Request $request): Response
    {
        return $this
            ->client
            ->withOptions(['stream' => true])
            ->post('api/chat', [
                'model' => $request->model(),
                'messages' => (new MessageMap(array_merge(
                    $request->systemPrompts(),
                    $request->messages()
                )))->map(),
                'tools' => ToolMap::map($request->tools()),
                'stream' => true,
                ...Arr::whereNotNull([
                    'think' => $request->providerOptions('thinking'),
                ]),
                'options' => Arr::whereNotNull(array_merge([
                    'temperature' => $request->temperature(),
                    'num_predict' => $request->maxTokens() ?? 2048,
                    'top_p' => $request->topP(),
                ], $request->providerOptions())),
            ]);
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id') ?? '',
            name: data_get($toolCall, 'name') ?? '',
            arguments: data_get($toolCall, 'arguments'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/Ollama/Handlers/Structured.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Providers\Ollama\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Ollama\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Ollama\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use MapsFinishReason;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): Response
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        $responseMessage = new AssistantMessage(
            data_get($data, 'message.content') ?? '',
        );

        $request->addMessage($responseMessage);

        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function addStep(array $data, Request $request): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            usage: new Usage(
                data_get($data, 'prompt_eval_count', 0),
                data_get($data, 'eval_count', 0),
            ),
            meta: new Meta(
                id: '',
                model: $request->model(),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this->client->post('api/chat', [
            'model' => $request->model(),
            'messages' => (new MessageMap(array_merge(
                $request->systemPrompts(),
                $request->messages()
            )))->map(),
            'format' => $request->schema()->toArray(),
            'stream' => false,
            'options' => Arr::whereNotNull(array_merge([
                'temperature' => $request->temperature(),
                'num_predict' => $request->maxTokens() ?? 2048,
                'top_p' => $request->topP(),
            ], $request->providerOptions())),
        ]);

        return $response->json();
    }
}



================================================
FILE: src/Providers/Ollama/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Ollama\Concerns\MapsFinishReason;
use Prism\Prism\Providers\Ollama\Concerns\ValidatesResponse;
use Prism\Prism\Providers\Ollama\Maps\MessageMap;
use Prism\Prism\Providers\Ollama\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools;
    use MapsFinishReason;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): Response
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        $responseMessage = new AssistantMessage(
            data_get($data, 'message.content') ?? '',
            $this->mapToolCalls(data_get($data, 'message.tool_calls', [])),
        );

        $request->addMessage($responseMessage);

        // Check for tool calls first, regardless of finish reason
        if (! empty(data_get($data, 'message.tool_calls'))) {
            return $this->handleToolCalls($data, $request);
        }

        return match ($this->mapFinishReason($data)) {
            FinishReason::Stop => $this->handleStop($data, $request),
            default => throw new PrismException('Ollama: unknown finish reason'),
        };
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this
            ->client
            ->post('api/chat', [
                'model' => $request->model(),
                'messages' => (new MessageMap(array_merge(
                    $request->systemPrompts(),
                    $request->messages()
                )))->map(),
                'tools' => ToolMap::map($request->tools()),
                'stream' => false,
                ...Arr::whereNotNull([
                    'think' => $request->providerOptions('thinking'),
                ]),
                'options' => Arr::whereNotNull(array_merge([
                    'temperature' => $request->temperature(),
                    'num_predict' => $request->maxTokens() ?? 2048,
                    'top_p' => $request->topP(),
                ], $request->providerOptions())),
            ]);

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request): Response
    {
        $toolResults = $this->callTools(
            $request->tools(),
            $this->mapToolCalls(data_get($data, 'message.tool_calls', [])),
        );

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request): Response
    {
        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(array $data, Request $request, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            toolCalls: $this->mapToolCalls(data_get($data, 'message.tool_calls', []) ?? []),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'prompt_eval_count', 0),
                data_get($data, 'eval_count', 0),
            ),
            meta: new Meta(
                id: '',
                model: $request->model(),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id') ?? '',
            name: data_get($toolCall, 'function.name'),
            arguments: data_get($toolCall, 'function.arguments'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/Ollama/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $reason): FinishReason
    {
        return match ($reason) {
            'stop', => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/Ollama/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\Ollama\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    public function toPayload(): mixed
    {
        return $this->media->base64();
    }

    protected function provider(): string|Provider
    {
        return Provider::Ollama;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/Ollama/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     */
    public function __construct(
        protected array $messages,
    ) {}

    /**
     * @return array<int, array{role: string, content: string, images?: array<string>}>
     */
    public function map(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return array_values($this->mappedMessages);
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $this->mappedMessages[] = [
                'role' => 'tool',
                'content' => is_string($toolResult->result)
                    ? $toolResult->result
                    : (json_encode($toolResult->result) ?: ''),
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $mapped = [
            'role' => 'user',
            'content' => $message->text(),
        ];

        if ($images = $message->images()) {
            $mapped['images'] = array_map(
                fn (Image $image): string => (new ImageMapper($image))->toPayload(),
                $images
            );
        }

        $this->mappedMessages[] = $mapped;
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $this->mappedMessages[] = array_filter([
            'role' => 'assistant',
            'content' => $message->content,
            'tool_calls' => $message->toolCalls ? array_map(fn (ToolCall $toolCall): array => [
                'function' => [
                    'name' => $toolCall->name,
                    'arguments' => $toolCall->arguments(),
                ],
            ], $message->toolCalls) : null,
        ]);
    }
}



================================================
FILE: src/Providers/Ollama/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<string, mixed>
     */
    public static function map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => [
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                'parameters' => [
                    'type' => 'object',
                    ...$tool->parameters() ? ['properties' => $tool->parametersAsArray()] : [],
                    'required' => $tool->requiredParameters(),
                ],
            ],
        ], $tools);
    }
}



================================================
FILE: src/Providers/Ollama/ValueObjects/OllamaStreamState.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\Ollama\ValueObjects;

use Prism\Prism\Streaming\StreamState;

class OllamaStreamState extends StreamState
{
    protected int $promptTokens = 0;

    protected int $completionTokens = 0;

    public function addPromptTokens(int $tokens): self
    {
        $this->promptTokens += $tokens;

        return $this;
    }

    public function addCompletionTokens(int $tokens): self
    {
        $this->completionTokens += $tokens;

        return $this;
    }

    public function promptTokens(): int
    {
        return $this->promptTokens;
    }

    public function completionTokens(): int
    {
        return $this->completionTokens;
    }

    public function reset(): self
    {
        parent::reset();
        $this->promptTokens = 0;
        $this->completionTokens = 0;

        return $this;
    }
}



================================================
FILE: src/Providers/OpenAI/OpenAI.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Audio\AudioResponse as TextToSpeechResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as SpeechToTextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Embeddings\Request as EmbeddingsRequest;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Enums\Provider as ProviderName;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Images\Request as ImagesRequest;
use Prism\Prism\Images\Response as ImagesResponse;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Handlers\Audio;
use Prism\Prism\Providers\OpenAI\Handlers\Embeddings;
use Prism\Prism\Providers\OpenAI\Handlers\Images;
use Prism\Prism\Providers\OpenAI\Handlers\Stream;
use Prism\Prism\Providers\OpenAI\Handlers\Structured;
use Prism\Prism\Providers\OpenAI\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class OpenAI extends Provider
{
    use InitializesClient;
    use ProcessRateLimits;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
        public readonly ?string $organization,
        public readonly ?string $project,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function embeddings(EmbeddingsRequest $request): EmbeddingsResponse
    {
        $handler = new Embeddings($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function images(ImagesRequest $request): ImagesResponse
    {
        $handler = new Images($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function textToSpeech(TextToSpeechRequest $request): TextToSpeechResponse
    {
        $handler = new Audio($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handleTextToSpeech($request);
    }

    #[\Override]
    public function speechToText(SpeechToTextRequest $request): SpeechToTextResponse
    {
        $handler = new Audio($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handleSpeechToText($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        match ($e->response->getStatusCode()) {
            429 => throw PrismRateLimitedException::make(
                rateLimits: $this->processRateLimits($e->response),
                retryAfter: (int) $e->response->header('retry-after')
            ),
            529 => throw PrismProviderOverloadedException::make(ProviderName::OpenAI),
            413 => throw PrismRequestTooLargeException::make(ProviderName::OpenAI),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->withHeaders(array_filter([
                'OpenAI-Organization' => $this->organization,
                'OpenAI-Project' => $this->project,
            ]))
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/OpenAI/Concerns/BuildsTools.php
================================================
<?php

namespace Prism\Prism\Providers\OpenAI\Concerns;

use Prism\Prism\Providers\OpenAI\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\ProviderTool;

trait BuildsTools
{
    /**
     * @return array<int|string,mixed>
     */
    protected function buildTools(Request $request): array
    {
        $tools = ToolMap::map($request->tools());

        if ($request->providerTools() === []) {
            return $tools;
        }

        $providerTools = array_map(
            fn (ProviderTool $tool): array => [
                'type' => $tool->type,
                ...$tool->options,
            ],
            $request->providerTools()
        );

        return array_merge($providerTools, $tools);
    }
}



================================================
FILE: src/Providers/OpenAI/Concerns/ExtractsCitations.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Concerns;

use Illuminate\Support\Arr;
use Prism\Prism\Providers\OpenAI\Maps\CitationsMapper;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

trait ExtractsCitations
{
    /**
     * @param  array<string,mixed>  $responseData
     * @return null|MessagePartWithCitations[]
     */
    protected function extractCitations(array $responseData): ?array
    {
        $contentBlock = data_get($responseData, 'output.{last}.content.{last}', []);

        if (data_get($contentBlock, 'annotations', []) === []) {
            return null;
        }

        return Arr::whereNotNull([CitationsMapper::mapFromOpenAI($contentBlock)]);
    }
}



================================================
FILE: src/Providers/OpenAI/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\OpenAI\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(
            data_get($data, 'output.{last}.status', ''),
            data_get($data, 'output.{last}.type', ''),
        );
    }
}



================================================
FILE: src/Providers/OpenAI/Concerns/ProcessRateLimits.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Concerns;

use Illuminate\Http\Client\Response;
use Illuminate\Support\Carbon;
use Prism\Prism\ValueObjects\ProviderRateLimit;

trait ProcessRateLimits
{
    /**
     * @return ProviderRateLimit[]
     */
    protected function processRateLimits(Response $response): array
    {
        $headers = $response->getHeaders();
        $rateLimits = [];

        // Process requests rate limit
        if (isset($headers['x-ratelimit-limit-requests']) && isset($headers['x-ratelimit-remaining-requests'])) {
            $rateLimits[] = new ProviderRateLimit(
                name: 'requests',
                limit: (int) $headers['x-ratelimit-limit-requests'][0],
                remaining: (int) $headers['x-ratelimit-remaining-requests'][0],
                resetsAt: $this->parseResetTime($headers['x-ratelimit-reset-requests'][0] ?? null)
            );
        }

        // Process tokens rate limit
        if (isset($headers['x-ratelimit-limit-tokens']) && isset($headers['x-ratelimit-remaining-tokens'])) {
            $rateLimits[] = new ProviderRateLimit(
                name: 'tokens',
                limit: (int) $headers['x-ratelimit-limit-tokens'][0],
                remaining: (int) $headers['x-ratelimit-remaining-tokens'][0],
                resetsAt: $this->parseResetTime($headers['x-ratelimit-reset-tokens'][0] ?? null)
            );
        }

        return $rateLimits;
    }

    protected function parseResetTime(?string $resetTime): ?Carbon
    {
        if (in_array($resetTime, [null, '', '0'], true)) {
            return null;
        }

        // Parse formats like "6ms", "30s", "5m", "1h"
        if (preg_match('/^(\d+)(ms|s|m|h)$/', $resetTime, $matches)) {
            $value = (int) $matches[1];
            $unit = $matches[2];

            return match ($unit) {
                'ms' => Carbon::now()->addMilliseconds($value),
                's' => Carbon::now()->addSeconds($value),
                'm' => Carbon::now()->addMinutes($value),
                'h' => Carbon::now()->addHours($value),
            };
        }

        return null;
    }
}



================================================
FILE: src/Providers/OpenAI/Concerns/ValidatesResponse.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponse
{
    protected function validateResponse(Response $response): void
    {
        $data = $response->json();

        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(vsprintf(
                'OpenAI Error:  [%s] %s',
                [
                    data_get($data, 'error.type', 'unknown'),
                    data_get($data, 'error.message', 'unknown'),
                ]
            ));
        }
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Audio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Exception;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Arr;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Providers\Anthropic\Concerns\ProcessesRateLimits as ConcernsProcessesRateLimits;
use Prism\Prism\Providers\OpenAI\Concerns\ValidatesResponse;
use Prism\Prism\Providers\OpenAI\Maps\TextToSpeechRequestMapper;
use Prism\Prism\ValueObjects\GeneratedAudio;
use Prism\Prism\ValueObjects\Usage;

class Audio
{
    use ConcernsProcessesRateLimits;
    use ValidatesResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handleTextToSpeech(TextToSpeechRequest $request): AudioResponse
    {
        $mapper = new TextToSpeechRequestMapper($request);

        $response = $this->client->post('audio/speech', $mapper->toPayload());

        if (! $response->successful()) {
            throw new Exception('Failed to generate audio: '.$response->body());
        }

        $audioContent = $response->body();
        $base64Audio = base64_encode($audioContent);

        return new AudioResponse(
            audio: new GeneratedAudio(
                base64: $base64Audio,
            ),
        );
    }

    public function handleSpeechToText(SpeechToTextRequest $request): TextResponse
    {
        $response = $this
            ->client
            ->attach(
                'file',
                $request->input()->resource(),
                'audio',
                ['Content-Type' => $request->input()->mimeType()]
            )
            ->post('audio/transcriptions', Arr::whereNotNull([
                'model' => $request->model(),
                'language' => $request->providerOptions('language') ?? null,
                'prompt' => $request->providerOptions('prompt') ?? null,
                'response_format' => $request->providerOptions('response_format') ?? null,
                'service_tier' => $request->providerOptions('service_tier') ?? null,
                'temperature' => $request->providerOptions('temperature') ?? null,
            ]));

        if (json_validate($response->body())) {
            $data = $response->json();

            $this->validateResponse($response);

            return new TextResponse(
                text: $data['text'] ?? '',
                usage: isset($data['usage'])
                    ? new Usage(
                        promptTokens: $data['usage']['input_tokens'] ?? 0,
                        completionTokens: $data['usage']['total_tokens'] ?? 0,
                    )
                    : null,
                additionalContent: $data,
            );
        }

        // Handle other response formats like vtt
        return new TextResponse(
            text: $response->body(),
        );
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Embeddings.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Prism\Prism\Embeddings\Request;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Concerns\ValidatesResponse;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

class Embeddings
{
    use ProcessRateLimits;
    use ValidatesResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): EmbeddingsResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        return new EmbeddingsResponse(
            embeddings: array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($data, 'data', [])),
            usage: new EmbeddingsUsage(data_get($data, 'usage.total_tokens', null)),
            meta: new Meta(
                id: '',
                model: data_get($data, 'model', ''),
                rateLimits: $this->processRateLimits($response),
            ),
        );
    }

    protected function sendRequest(Request $request): Response
    {
        return $this->client->post(
            'embeddings',
            [
                'model' => $request->model(),
                'input' => $request->inputs(),
                ...($request->providerOptions() ?? []),
            ]
        );
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Images.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use InvalidArgumentException;
use Prism\Prism\Images\Request;
use Prism\Prism\Images\Response;
use Prism\Prism\Images\ResponseBuilder;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Concerns\ValidatesResponse;
use Prism\Prism\Providers\OpenAI\Maps\ImageRequestMap;
use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Images
{
    use ProcessRateLimits;
    use ValidatesResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handle(Request $request): Response
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $images = $this->extractImages($data);

        $responseBuilder = new ResponseBuilder(
            usage: new Usage(
                promptTokens: data_get($data, 'usage.input_tokens', data_get($data, 'usage.prompt_tokens', 0)),
                completionTokens: data_get($data, 'usage.output_tokens', data_get($data, 'usage.completion_tokens', 0)),
            ),
            meta: new Meta(
                id: data_get($data, 'id', 'img_'.bin2hex(random_bytes(8))),
                model: data_get($data, 'model', $request->model()),
                rateLimits: $this->processRateLimits($response),
            ),
            images: $images,
        );

        return $responseBuilder->toResponse();
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        if ($request->additionalContent()) {
            return $this->sendImageEditRequest($request);
        }

        return $this->client->post('images/generations', ImageRequestMap::map($request));
    }

    protected function sendImageEditRequest(Request $request): ClientResponse
    {
        /** @var Image $image */
        foreach ($request->additionalContent() as $index => $image) {
            $this
                ->client
                ->attach(
                    'image[]',
                    $image->resource(),
                    $image->filename() ?: "image-{$index}",
                );
        }

        if ($mask = $request->providerOptions('mask')) {
            if (! $mask instanceof Image) {
                throw new InvalidArgumentException('Mask must be an instance of Image value object');
            }

            $this
                ->client
                ->attach(
                    'mask',
                    $mask->resource(),
                );
        }

        return $this
            ->client
            ->post('images/edits', ImageRequestMap::map($request));
    }

    /**
     * @param  array<string, mixed>  $data
     * @return GeneratedImage[]
     */
    protected function extractImages(array $data): array
    {
        $images = [];

        foreach (data_get($data, 'data', []) as $imageData) {
            $images[] = new GeneratedImage(
                url: data_get($imageData, 'url'),
                base64: data_get($imageData, 'b64_json'),
                revisedPrompt: data_get($imageData, 'revised_prompt'),
            );
        }

        return $images;
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\OpenAI\Concerns\BuildsTools;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Maps\FinishReasonMap;
use Prism\Prism\Providers\OpenAI\Maps\MessageMap;
use Prism\Prism\Providers\OpenAI\Maps\ToolChoiceMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use BuildsTools;
    use CallsTools;
    use ProcessRateLimits;

    protected StreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        $this->state->reset()->withMessageId(EventID::generate());
        $reasoningItems = [];

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            if ($data['type'] === 'error') {
                $code = data_get($data, 'error.code', 'unknown_error');
                $message = data_get($data, 'error.message', 'No error message provided');

                if ($code === 'rate_limit_exceeded') {
                    throw new PrismRateLimitedException([]);
                }

                throw new PrismException(sprintf(
                    'Sending to model %s failed. Code: %s. Message: %s',
                    $request->model(),
                    $code,
                    $message
                ));
            }

            if ($data['type'] === 'response.created' && $this->state->shouldEmitStreamStart()) {
                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $data['response']['model'] ?? 'unknown',
                    provider: 'openai',
                );

                $this->state->markStreamStarted();

                continue;
            }

            if ($this->hasReasoningSummaryDelta($data)) {
                $reasoningDelta = $this->extractReasoningSummaryDelta($data);

                if ($reasoningDelta !== '') {
                    if ($this->state->reasoningId() === '') {
                        $this->state->withReasoningId(EventID::generate());
                        yield new ThinkingStartEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            reasoningId: $this->state->reasoningId()
                        );
                    }

                    $this->state->appendThinking($reasoningDelta);

                    yield new ThinkingEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        delta: $reasoningDelta,
                        reasoningId: $this->state->reasoningId()
                    );
                }

                continue;
            }

            if ($this->hasReasoningItems($data)) {
                $reasoningItems = $this->extractReasoningItems($data, $reasoningItems);

                if ($this->state->reasoningId() !== '') {
                    yield new ThinkingCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                    $this->state->withReasoningId('');
                }

                continue;
            }

            if ($this->hasToolCalls($data)) {
                $this->extractToolCalls($data, $reasoningItems);

                if ($this->isToolCallComplete($data)) {
                    $completedToolCall = $this->getCompletedToolCall($data);
                    if ($completedToolCall instanceof ToolCall) {
                        yield new ToolCallEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            toolCall: $completedToolCall,
                            messageId: $this->state->messageId()
                        );
                    }
                }

                continue;
            }

            $content = $this->extractOutputTextDelta($data);

            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                    $this->state->markTextStarted();
                }

                $this->state->appendText($content);

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            if (data_get($data, 'type') === 'response.output_text.done' && $this->state->hasTextStarted()) {
                yield new TextCompleteEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    messageId: $this->state->messageId()
                );
            }

            if (data_get($data, 'type') === 'response.completed') {
                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $this->mapFinishReason($data),
                    usage: new Usage(
                        promptTokens: data_get($data, 'response.usage.input_tokens'),
                        completionTokens: data_get($data, 'response.usage.output_tokens'),
                        cacheReadInputTokens: data_get($data, 'response.usage.input_tokens_details.cached_tokens'),
                        thoughtTokens: data_get($data, 'response.usage.output_tokens_details.reasoning_tokens')
                    ),
                    additionalContent: Arr::whereNotNull([
                        'response_id' => data_get($data, 'response.id'),
                    ])
                );
            }
        }

        if ($this->state->hasToolCalls()) {
            yield from $this->handleToolCalls($request, $depth);
        }
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if (Str::contains($line, 'DONE')) {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('OpenAI', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $reasoningItems
     */
    protected function extractToolCalls(array $data, array $reasoningItems = []): void
    {
        $type = data_get($data, 'type', '');

        if ($type === 'response.output_item.added' && data_get($data, 'item.type') === 'function_call') {
            $index = (int) data_get($data, 'output_index', count($this->state->toolCalls()));

            $toolCall = [
                'id' => data_get($data, 'item.id'),
                'call_id' => data_get($data, 'item.call_id'),
                'name' => data_get($data, 'item.name'),
                'arguments' => '',
            ];

            // Associate with the most recent reasoning item if available
            if ($reasoningItems !== []) {
                $latestReasoning = end($reasoningItems);
                $toolCall['reasoning_id'] = $latestReasoning['id'];
                $toolCall['reasoning_summary'] = $latestReasoning['summary'] ?? [];
            }

            $this->state->addToolCall($index, $toolCall);

            return;
        }

        if ($type === 'response.function_call_arguments.delta') {
            // continue for now, only needed if we want to support streaming argument chunks
        }

        if ($type === 'response.function_call_arguments.done') {
            $callId = data_get($data, 'item_id');
            $arguments = data_get($data, 'arguments', '');

            $toolCalls = $this->state->toolCalls();
            foreach ($toolCalls as $index => $call) {
                if (($call['id'] ?? null) === $callId) {
                    if ($arguments !== '') {
                        $this->state->updateToolCall($index, ['arguments' => $arguments]);
                    }
                    break;
                }
            }
        }
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(Request $request, int $depth): Generator
    {
        $mappedToolCalls = $this->mapToolCalls($this->state->toolCalls());
        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: EventID::generate()
            );
        }

        $request->addMessage(new AssistantMessage($this->state->currentText(), $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        $depth++;

        if ($depth < $request->maxSteps()) {
            $nextResponse = $this->sendRequest($request);

            yield from $this->processStream($nextResponse, $request, $depth);
        }
    }

    /**
     * Convert raw tool call data to ToolCall objects.
     *
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return collect($toolCalls)
            ->map(fn ($toolCall): ToolCall => new ToolCall(
                id: data_get($toolCall, 'id'),
                name: data_get($toolCall, 'name'),
                arguments: data_get($toolCall, 'arguments'),
                resultId: data_get($toolCall, 'call_id'),
                reasoningId: data_get($toolCall, 'reasoning_id'),
                reasoningSummary: data_get($toolCall, 'reasoning_summary', []),
            ))
            ->toArray();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        $type = data_get($data, 'type', '');

        if (data_get($data, 'item.type') === 'function_call') {
            return true;
        }

        return in_array($type, [
            'response.function_call_arguments.delta',
            'response.function_call_arguments.done',
        ]);
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasReasoningItems(array $data): bool
    {
        $type = data_get($data, 'type', '');

        return $type === 'response.output_item.done' && data_get($data, 'item.type') === 'reasoning';
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $reasoningItems
     * @return array<int, array<string, mixed>>
     */
    protected function extractReasoningItems(array $data, array $reasoningItems): array
    {
        if (data_get($data, 'type') === 'response.output_item.done' && data_get($data, 'item.type') === 'reasoning') {
            $index = (int) data_get($data, 'output_index', count($reasoningItems));

            $reasoningItems[$index] = [
                'id' => data_get($data, 'item.id'),
                'summary' => data_get($data, 'item.summary', []),
            ];
        }

        return $reasoningItems;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        $eventType = Str::after(data_get($data, 'type'), 'response.');
        $lastOutputType = data_get($data, 'response.output.{last}.type');

        return FinishReasonMap::map($eventType, $lastOutputType);
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function isToolCallComplete(array $data): bool
    {
        return data_get($data, 'type') === 'response.function_call_arguments.done';
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function getCompletedToolCall(array $data): ?ToolCall
    {
        $callId = data_get($data, 'item_id');

        foreach ($this->state->toolCalls() as $call) {
            if (($call['id'] ?? null) === $callId) {
                return new ToolCall(
                    id: $call['id'],
                    name: $call['name'],
                    arguments: $call['arguments'] ?? '',
                    resultId: $call['call_id'] ?? null,
                    reasoningId: $call['reasoning_id'] ?? null,
                    reasoningSummary: $call['reasoning_summary'] ?? []
                );
            }
        }

        return null;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasReasoningSummaryDelta(array $data): bool
    {
        $type = data_get($data, 'type', '');

        return $type === 'response.reasoning_summary_text.delta';
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractReasoningSummaryDelta(array $data): string
    {
        if (data_get($data, 'type') === 'response.reasoning_summary_text.delta') {
            return (string) data_get($data, 'delta', '');
        }

        return '';
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractOutputTextDelta(array $data): string
    {
        if (data_get($data, 'type') === 'response.output_text.delta') {
            return (string) data_get($data, 'delta', '');
        }

        return '';
    }

    protected function sendRequest(Request $request): Response
    {
        return $this
            ->client
            ->withOptions(['stream' => true])
            ->post(
                'responses',
                array_merge([
                    'stream' => true,
                    'model' => $request->model(),
                    'input' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                    'max_output_tokens' => $request->maxTokens(),
                ], Arr::whereNotNull([
                    'temperature' => $request->temperature(),
                    'top_p' => $request->topP(),
                    'metadata' => $request->providerOptions('metadata'),
                    'tools' => $this->buildTools($request),
                    'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
                    'parallel_tool_calls' => $request->providerOptions('parallel_tool_calls'),
                    'previous_response_id' => $request->providerOptions('previous_response_id'),
                    'service_tier' => $request->providerOptions('service_tier'),
                    'truncation' => $request->providerOptions('truncation'),
                    'reasoning' => $request->providerOptions('reasoning'),
                ]))
            );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Structured.php
================================================
<?php

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Enums\StructuredMode;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\OpenAI\Concerns\ExtractsCitations;
use Prism\Prism\Providers\OpenAI\Concerns\MapsFinishReason;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Concerns\ValidatesResponse;
use Prism\Prism\Providers\OpenAI\Maps\MessageMap;
use Prism\Prism\Providers\OpenAI\Support\StructuredModeResolver;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use ExtractsCitations;
    use MapsFinishReason;
    use ProcessRateLimits;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $response = match ($request->mode()) {
            StructuredMode::Auto => $this->handleAutoMode($request),
            StructuredMode::Structured => $this->handleStructuredMode($request),
            StructuredMode::Json => $this->handleJsonMode($request),

        };

        $this->validateResponse($response);

        $data = $response->json();

        $this->handleRefusal(data_get($data, 'output.{last}.content.0', []));

        $responseMessage = new AssistantMessage(
            data_get($data, 'output.{last}.content.0.text') ?? '',
        );

        $request->addMessage($responseMessage);

        $this->addStep($data, $request, $response);

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function addStep(array $data, Request $request, ClientResponse $clientResponse): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'output.{last}.content.0.text') ?? '',
            finishReason: $this->mapFinishReason($data),
            usage: new Usage(
                promptTokens: data_get($data, 'usage.input_tokens', 0) - data_get($data, 'usage.input_tokens_details.cached_tokens', 0),
                completionTokens: data_get($data, 'usage.output_tokens'),
                cacheReadInputTokens: data_get($data, 'usage.input_tokens_details.cached_tokens'),
                thoughtTokens: data_get($data, 'usage.output_token_details.reasoning_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($clientResponse),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: Arr::whereNotNull([
                'citations' => $this->extractCitations($data),
            ]),
        ));
    }

    /**
     * @param  array{type: 'json_schema', name: string, schema: array<mixed>, strict?: bool}|array{type: 'json_object'}  $responseFormat
     */
    protected function sendRequest(Request $request, array $responseFormat): ClientResponse
    {
        return $this->client->post(
            'responses',
            array_merge([
                'model' => $request->model(),
                'input' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_output_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'metadata' => $request->providerOptions('metadata'),
                'previous_response_id' => $request->providerOptions('previous_response_id'),
                'service_tier' => $request->providerOptions('service_tier'),
                'truncation' => $request->providerOptions('truncation'),
                'reasoning' => $request->providerOptions('reasoning'),
                'text' => [
                    'format' => $responseFormat,
                ],
            ]))
        );
    }

    protected function handleAutoMode(Request $request): ClientResponse
    {
        $mode = StructuredModeResolver::forModel($request->model());

        return match ($mode) {
            StructuredMode::Structured => $this->handleStructuredMode($request),
            StructuredMode::Json => $this->handleJsonMode($request),
            default => throw new PrismException('Could not determine structured mode for your request'),
        };
    }

    protected function handleStructuredMode(Request $request): ClientResponse
    {
        $mode = StructuredModeResolver::forModel($request->model());

        if ($mode !== StructuredMode::Structured) {
            throw new PrismException(sprintf('%s model does not support structured mode', $request->model()));
        }

        /** @var array{type: 'json_schema', name: string, schema: array<mixed>, strict?: bool} $responseFormat */
        $responseFormat = Arr::whereNotNull([
            'type' => 'json_schema',
            'name' => $request->schema()->name(),
            'schema' => $request->schema()->toArray(),
            'strict' => is_null($request->providerOptions('schema.strict'))
                ? null
                : $request->providerOptions('schema.strict'),
        ]);

        return $this->sendRequest($request, $responseFormat);
    }

    protected function handleJsonMode(Request $request): ClientResponse
    {
        $request = $this->appendMessageForJsonMode($request);

        return $this->sendRequest($request, [
            'type' => 'json_object',
        ]);
    }

    /**
     * @param  array<string, string>  $message
     */
    protected function handleRefusal(array $message): void
    {
        if (data_get($message, 'type') === 'refusal') {
            throw new PrismException(sprintf('OpenAI Refusal: %s', $message['refusal'] ?? 'Reason unknown.'));
        }
    }

    protected function appendMessageForJsonMode(Request $request): Request
    {
        return $request->addMessage(new SystemMessage(sprintf(
            "Respond with JSON that matches the following schema: \n %s",
            json_encode($request->schema()->toArray(), JSON_PRETTY_PRINT)
        )));
    }
}



================================================
FILE: src/Providers/OpenAI/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\OpenAI\Concerns\BuildsTools;
use Prism\Prism\Providers\OpenAI\Concerns\ExtractsCitations;
use Prism\Prism\Providers\OpenAI\Concerns\MapsFinishReason;
use Prism\Prism\Providers\OpenAI\Concerns\ProcessRateLimits;
use Prism\Prism\Providers\OpenAI\Concerns\ValidatesResponse;
use Prism\Prism\Providers\OpenAI\Maps\MessageMap;
use Prism\Prism\Providers\OpenAI\Maps\ToolCallMap;
use Prism\Prism\Providers\OpenAI\Maps\ToolChoiceMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use BuildsTools;
    use CallsTools;
    use ExtractsCitations;
    use MapsFinishReason;
    use ProcessRateLimits;
    use ValidatesResponse;

    protected ResponseBuilder $responseBuilder;

    /** @var ?MessagePartWithCitations[] */
    protected ?array $citations = null;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): Response
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $this->citations = $this->extractCitations($data);

        $responseMessage = new AssistantMessage(
            content: data_get($data, 'output.{last}.content.0.text') ?? '',
            toolCalls: ToolCallMap::map(
                array_filter(data_get($data, 'output', []), fn (array $output): bool => $output['type'] === 'function_call'),
                array_filter(data_get($data, 'output', []), fn (array $output): bool => $output['type'] === 'reasoning'),
            ),
            additionalContent: Arr::whereNotNull([
                'citations' => $this->citations,
            ]),
        );

        $request->addMessage($responseMessage);

        return match ($this->mapFinishReason($data)) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request, $response),
            FinishReason::Stop => $this->handleStop($data, $request, $response),
            FinishReason::Length => throw new PrismException('OpenAI: max tokens exceeded'),
            default => throw new PrismException('OpenAI: unknown finish reason'),
        };
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request, ClientResponse $clientResponse): Response
    {
        $toolResults = $this->callTools(
            $request->tools(),
            ToolCallMap::map(array_filter(
                data_get($data, 'output', []),
                fn (array $output): bool => $output['type'] === 'function_call')
            ),
        );

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $clientResponse, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request, ClientResponse $clientResponse): Response
    {
        $this->addStep($data, $request, $clientResponse);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        return $this->client->post(
            'responses',
            array_merge([
                'model' => $request->model(),
                'input' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_output_tokens' => $request->maxTokens(),
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
                'metadata' => $request->providerOptions('metadata'),
                'tools' => $this->buildTools($request),
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
                'parallel_tool_calls' => $request->providerOptions('parallel_tool_calls'),
                'previous_response_id' => $request->providerOptions('previous_response_id'),
                'service_tier' => $request->providerOptions('service_tier'),
                'truncation' => $request->providerOptions('truncation'),
                'reasoning' => $request->providerOptions('reasoning'),
            ]))
        );
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  ToolResult[]  $toolResults
     */
    protected function addStep(
        array $data,
        Request $request,
        ClientResponse $clientResponse,
        array $toolResults = []
    ): void {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'output.{last}.content.0.text') ?? '',
            finishReason: $this->mapFinishReason($data),
            toolCalls: ToolCallMap::map(array_filter(data_get($data, 'output', []), fn (array $output): bool => $output['type'] === 'function_call')),
            toolResults: $toolResults,
            usage: new Usage(
                promptTokens: data_get($data, 'usage.input_tokens', 0) - data_get($data, 'usage.input_tokens_details.cached_tokens', 0),
                completionTokens: data_get($data, 'usage.output_tokens'),
                cacheReadInputTokens: data_get($data, 'usage.input_tokens_details.cached_tokens'),
                thoughtTokens: data_get($data, 'usage.output_token_details.reasoning_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
                rateLimits: $this->processRateLimits($clientResponse),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: Arr::whereNotNull([
                'citations' => $this->citations,
            ]),
        ));
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/CitationsMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

class CitationsMapper
{
    /**
     * @param  array<string, mixed>  $contentBlock
     */
    public static function mapFromOpenAI(array $contentBlock): ?MessagePartWithCitations
    {
        if (! isset($contentBlock['type']) || $contentBlock['type'] !== 'output_text') {
            return null;
        }

        $citations = array_map(
            self::mapCitation(...),
            $contentBlock['annotations'] ?? []
        );

        return new MessagePartWithCitations(
            outputText: $contentBlock['text'] ?? '',
            citations: $citations,
        );
    }

    /**
     * @return array<string,mixed>
     */
    public static function mapToOpenAI(MessagePartWithCitations $messagePartWithCitations): array
    {
        $annotations = array_map(
            self::mapCitationToOpenAi(...),
            $messagePartWithCitations->citations
        );

        return [
            'type' => 'output_text',
            'text' => $messagePartWithCitations->outputText,
            'annotations' => $annotations,
        ];
    }

    /**
     * @param  array<string, mixed>  $citationData
     */
    protected static function mapCitation(array $citationData): Citation
    {
        return new Citation(
            sourceType: $sourceType = self::mapSourceType($citationData['type']),
            source: self::mapSource($citationData, $sourceType),
            sourceTitle: $citationData['title'] ?? null,
            additionalContent: [
                'responseStartIndex' => $citationData['start_index'] ?? null,
                'responseEndIndex' => $citationData['end_index'] ?? null,
            ]
        );
    }

    protected static function mapSourceType(string $openaiType): CitationSourceType
    {
        return match ($openaiType) {
            'file_citation' => CitationSourceType::Document,
            'url_citation' => CitationSourceType::Url,
            default => throw new InvalidArgumentException("Unknown citation source type: {$openaiType}"),
        };
    }

    /**
     * @param  array<string, mixed>  $citationData
     */
    protected static function mapSource(array $citationData, CitationSourceType $sourceType): string|int
    {
        if ($sourceType === CitationSourceType::Document) {
            return isset($citationData['filename'], $citationData['index'])
                ? $citationData['filename'].':'.$citationData['index']
                : $citationData['filename'] ?? '';
        }

        return $citationData['url'] ?? '';
    }

    /**
     * @return array<string,mixed>
     */
    protected static function mapCitationToOpenAi(Citation $citation): array
    {
        return [
            'type' => 'url_citation',
            'start_index' => data_get($citation->additionalContent, 'responseStartIndex'),
            'end_index' => data_get($citation->additionalContent, 'responseEndIndex'),
            'url' => $citation->source,
            'title' => $citation->sourceTitle,
        ];
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/DocumentMapper.php
================================================
<?php

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Document;

/**
 * @property Document $media
 */
class DocumentMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $payload = [
            'type' => 'input_file',
        ];

        if ($this->media->isFileId()) {
            $payload['file_id'] = $this->media->fileId();
        } elseif ($this->media->isUrl()) {
            $payload['file_url'] = $this->media->url();
        } else {
            $payload['filename'] = $this->media->documentTitle() ?? 'document';
            $payload['file_data'] = sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64());
        }

        return array_filter($payload);
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenAI;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isFileId()) {
            return true;
        }

        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $status, ?string $type = null): FinishReason
    {
        return match ($status) {
            'incomplete' => FinishReason::Length,
            'length' => FinishReason::Length,
            'failed' => FinishReason::Error,
            'completed' => match ($type) {
                'function_call' => FinishReason::ToolCalls,
                'message' => FinishReason::Stop,
                default => FinishReason::Unknown,
            },
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        $payload = [
            'type' => 'input_image',
        ];

        if ($this->media->isFileId()) {
            $payload['file_id'] = $this->media->fileId();
        } elseif ($this->media->isUrl()) {
            $payload['image_url'] = $this->media->url();
        } else {
            $payload['image_url'] = sprintf(
                'data:%s;base64,%s',
                $this->media->mimeType(),
                $this->media->base64()
            );
        }

        if ($this->media->providerOptions('detail')) {
            $payload['detail'] = $this->media->providerOptions('detail');
        }

        return array_filter($payload);
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenAI;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isFileId()) {
            return true;
        }

        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/ImageRequestMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Images\Request;

class ImageRequestMap
{
    /**
     * @return array<string, mixed>
     */
    public static function map(Request $request): array
    {
        $baseData = [
            'model' => $request->model(),
            'prompt' => $request->prompt(),
        ];

        $providerOptions = $request->providerOptions();

        // Explicitly handle known OpenAI image generation parameters
        $supportedOptions = [
            // Common parameters across all models
            'n' => $providerOptions['n'] ?? null,
            'size' => $providerOptions['size'] ?? null,
            'response_format' => $providerOptions['response_format'] ?? null,
            'user' => $providerOptions['user'] ?? null,

            // DALL-E 3 specific parameters
            'quality' => $providerOptions['quality'] ?? null,
            'style' => $providerOptions['style'] ?? null,

            // GPT-Image-1 specific parameters
            'background' => $providerOptions['background'] ?? null,
            'moderation' => $providerOptions['moderation'] ?? null,
            'output_compression' => $providerOptions['output_compression'] ?? null,
            'output_format' => $providerOptions['output_format'] ?? null,
        ];

        // Sent as multi-part (mask must be Image value object)
        unset($providerOptions['mask']);

        // Include any additional options not explicitly handled above
        $additionalOptions = array_diff_key($providerOptions, $supportedOptions);

        return array_merge(
            $baseData,
            Arr::whereNotNull($supportedOptions),
            $additionalOptions
        );
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $output = $toolResult->result;
            if (! is_string($output)) {
                $output = is_array($output) ? json_encode(
                    $output,
                    JSON_THROW_ON_ERROR,
                ) : strval($output);
            }

            $this->mappedMessages[] = [
                'type' => 'function_call_output',
                'call_id' => $toolResult->toolCallResultId,
                'output' => $output,
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                ['type' => 'input_text', 'text' => $message->text()],
                ...self::mapImageParts($message->images()),
                ...self::mapDocumentParts($message->documents()),
            ],
            ...$message->additionalAttributes,
        ];
    }

    /**
     * @param  Image[]  $images
     * @return array<int, mixed>
     */
    protected static function mapImageParts(array $images): array
    {
        return array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $images);
    }

    /**
     * @param  Document[]  $documents
     * @return array<int,mixed>
     */
    protected static function mapDocumentParts(array $documents): array
    {
        return array_map(fn (Document $document): array => (new DocumentMapper($document))->toPayload(), $documents);
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        if ($message->content !== '' && $message->content !== '0') {
            $mappedMessage = [
                'role' => 'assistant',
                'content' => [
                    [
                        'type' => 'output_text',
                        'text' => $message->content,
                    ],
                ],
            ];

            if (isset($message->additionalContent['citations'])) {
                $mappedMessage['content'][0]['annotations'] = CitationsMapper::mapToOpenAI($message->additionalContent['citations'][0])['annotations'];
            }

            $this->mappedMessages[] = $mappedMessage;
        }

        if ($message->toolCalls !== []) {
            $reasoningBlocks = collect($message->toolCalls)
                ->whereNotNull('reasoningId')
                ->unique('reasoningId')
                ->map(fn (ToolCall $toolCall): array => [
                    'type' => 'reasoning',
                    'id' => $toolCall->reasoningId,
                    'summary' => $toolCall->reasoningSummary,
                ])
                ->values()
                ->all();

            array_push(
                $this->mappedMessages,
                ...$reasoningBlocks,
                ...array_map(fn (ToolCall $toolCall): array => [
                    'id' => $toolCall->id,
                    'call_id' => $toolCall->resultId,
                    'type' => 'function_call',
                    'name' => $toolCall->name,
                    'arguments' => json_encode($toolCall->arguments()),
                ], $message->toolCalls)
            );
        }
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/TextToSpeechRequestMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Illuminate\Support\Arr;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Contracts\ProviderRequestMapper;
use Prism\Prism\Enums\Provider;

class TextToSpeechRequestMapper extends ProviderRequestMapper
{
    public function __construct(
        public readonly TextToSpeechRequest $request
    ) {}

    /**
     * @return array<string, mixed>
     */
    public function toPayload(): array
    {
        $providerOptions = $this->request->providerOptions();

        $baseData = [
            'model' => $this->request->model(),
            'input' => $this->request->input(),
            'voice' => $this->request->voice(),
        ];

        $supportedOptions = [
            'response_format' => $providerOptions['response_format'] ?? null,
            'speed' => $providerOptions['speed'] ?? null,
        ];

        return array_merge(
            $baseData,
            Arr::whereNotNull($supportedOptions),
            array_diff_key($providerOptions, $supportedOptions)
        );
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenAI;
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/ToolCallMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\ValueObjects\ToolCall;

class ToolCallMap
{
    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @param  null|array<int, array<string, mixed>>  $reasonings
     * @return array<int, ToolCall>
     */
    public static function map(?array $toolCalls, ?array $reasonings = null): array
    {
        if ($toolCalls === null) {
            return [];
        }

        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'name'),
            arguments: data_get($toolCall, 'arguments'),
            resultId: data_get($toolCall, 'call_id'),
            reasoningId: data_get($reasonings, '0.id'),
            reasoningSummary: data_get($reasonings, '0.summary'),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'name' => $toolChoice,
            ];
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            ToolChoice::Any => 'required',
            ToolChoice::None => 'none',
            null => $toolChoice,
        };
    }
}



================================================
FILE: src/Providers/OpenAI/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<string, mixed>
     */
    public static function Map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => array_filter([
            'type' => 'function',
            'name' => $tool->name(),
            'description' => $tool->description(),
            ...count($tool->parameters()) ? [
                'parameters' => [
                    'type' => 'object',
                    'properties' => $tool->parametersAsArray(),
                    'required' => $tool->requiredParameters(),
                ],
            ] : [],
            'strict' => (bool) $tool->providerOptions('strict'),
        ]), $tools);
    }
}



================================================
FILE: src/Providers/OpenAI/Support/StructuredModeResolver.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenAI\Support;

use Prism\Prism\Enums\StructuredMode;
use Prism\Prism\Exceptions\PrismException;

class StructuredModeResolver
{
    public static function forModel(string $model): StructuredMode
    {
        if (self::unsupported($model)) {
            throw new PrismException(sprintf('Structured output is not supported for %s', $model));
        }

        if (self::supportsStructuredMode($model)) {
            return StructuredMode::Structured;
        }

        return StructuredMode::Json;
    }

    protected static function supportsStructuredMode(string $model): bool
    {
        return in_array($model, [
            'gpt-4o-mini',
            'gpt-4o-mini-2024-07-18',
            'gpt-4o-2024-08-06',
            'gpt-4o',
            'chatgpt-4o-latest',
            'o3-mini',
            'o3-mini-2025-01-31',
            'gpt-4.1',
            'gpt-4.1-nano',
            'gpt-4.1-mini',
            'gpt-4.5-preview',
            'gpt-4.5-preview-2025-02-27',
            'gpt-5',
            'gpt-5-mini',
            'gpt-5-nano',
        ]);
    }

    protected static function supportsJsonMode(string $model): bool
    {
        if (preg_match('/^gpt-4-.*/', $model)) {
            return true;
        }

        return $model === 'gpt-3.5-turbo';
    }

    protected static function unsupported(string $model): bool
    {
        return in_array($model, [
            'o1-mini',
            'o1-mini-2024-09-12',
            'o1-preview',
            'o1-preview-2024-09-12',
        ]);
    }
}



================================================
FILE: src/Providers/OpenRouter/OpenRouter.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Enums\Provider as ProviderName;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Providers\OpenRouter\Handlers\Stream;
use Prism\Prism\Providers\OpenRouter\Handlers\Structured;
use Prism\Prism\Providers\OpenRouter\Handlers\Text;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class OpenRouter extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
        public readonly ?string $httpReferer = null,
        public readonly ?string $xTitle = null,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    public function handleRequestException(string $model, RequestException $e): never
    {
        $statusCode = $e->response->getStatusCode();
        $responseData = $e->response->json();
        $errorMessage = data_get($responseData, 'error.message', 'Unknown error');

        match ($statusCode) {
            400 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Bad Request: %s', $errorMessage)
            ),
            401 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Authentication Error: %s', $errorMessage)
            ),
            402 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Insufficient Credits: %s', $errorMessage)
            ),
            403 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Moderation Error: %s', $errorMessage)
            ),
            408 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Request Timeout: %s', $errorMessage)
            ),
            413 => throw PrismRequestTooLargeException::make(ProviderName::OpenRouter),
            429 => throw PrismRateLimitedException::make(
                rateLimits: [],
                retryAfter: $e->response->hasHeader('retry-after')
                    ? (int) $e->response->header('retry-after')
                    : null
            ),
            502 => throw PrismException::providerResponseError(
                sprintf('OpenRouter Model Error: %s', $errorMessage)
            ),
            503 => throw PrismProviderOverloadedException::make(ProviderName::OpenRouter),
            default => throw PrismException::providerRequestError($model, $e),
        };
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->withHeaders(array_filter([
                'HTTP-Referer' => $this->httpReferer,
                'X-Title' => $this->xTitle,
            ]))
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/OpenRouter/Concerns/BuildsRequestOptions.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Concerns;

use Illuminate\Support\Arr;
use Prism\Prism\Providers\OpenRouter\Maps\ToolChoiceMap;
use Prism\Prism\Providers\OpenRouter\Maps\ToolMap;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Text\Request as TextRequest;

trait BuildsRequestOptions
{
    /**
     * Assemble optional OpenRouter request parameters that Prism exposes via provider options.
     *
     * @param  array<string, mixed>  $additional
     * @return array<string, mixed>
     */
    protected function buildRequestOptions(TextRequest|StructuredRequest $request, array $additional = []): array
    {
        // Keep OpenRouter option surface flexible; reference https://openrouter.ai/docs/api-reference/parameters for supported keys.
        $options = $request->providerOptions() ?? [];

        $options = array_merge($options, Arr::whereNotNull([
            'temperature' => $request->temperature(),
            'top_p' => $request->topP(),
            'max_tokens' => $request->maxTokens(),
        ]));

        if ($request instanceof TextRequest) {
            $options = array_merge($options, Arr::whereNotNull([
                'tools' => ToolMap::map($request->tools()),
                'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
            ]));
        }

        return Arr::whereNotNull(array_merge($options, $additional));
    }
}



================================================
FILE: src/Providers/OpenRouter/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\OpenRouter\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', ''));
    }
}



================================================
FILE: src/Providers/OpenRouter/Concerns/ValidatesResponses.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Concerns;

use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponses
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if ($data === []) {
            throw PrismException::providerResponseError('OpenRouter Error: Empty response');
        }

        if (data_get($data, 'error')) {
            $this->handleOpenRouterError($data);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleOpenRouterError(array $data): void
    {
        $error = data_get($data, 'error', []);
        $code = data_get($error, 'code', 'unknown');
        $message = data_get($error, 'message', 'Unknown error');
        $metadata = data_get($error, 'metadata', []);

        if ($code === 403 && isset($metadata['reasons'])) {
            throw PrismException::providerResponseError(sprintf(
                'OpenRouter Moderation Error: %s. Flagged input: %s',
                $message,
                data_get($metadata, 'flagged_input', 'N/A')
            ));
        }

        if (isset($metadata['provider_name'])) {
            throw PrismException::providerResponseError(sprintf(
                'OpenRouter Provider Error (%s): %s',
                data_get($metadata, 'provider_name'),
                $message
            ));
        }

        throw PrismException::providerResponseError(sprintf(
            'OpenRouter Error [%s]: %s',
            $code,
            $message
        ));
    }
}



================================================
FILE: src/Providers/OpenRouter/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Str;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\OpenRouter\Concerns\BuildsRequestOptions;
use Prism\Prism\Providers\OpenRouter\Concerns\MapsFinishReason;
use Prism\Prism\Providers\OpenRouter\Concerns\ValidatesResponses;
use Prism\Prism\Providers\OpenRouter\Maps\MessageMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use BuildsRequestOptions;
    use CallsTools;
    use MapsFinishReason;
    use ValidatesResponses;

    protected StreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth === 0) {
            $this->state->reset();
        }

        $text = '';
        $toolCalls = [];

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            if ($this->state->shouldEmitStreamStart()) {
                $this->state
                    ->withMessageId(EventID::generate('msg'))
                    ->markStreamStarted();

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: $data['model'] ?? $request->model(),
                    provider: 'openrouter'
                );
            }

            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $toolCalls);

                $finishReason = data_get($data, 'choices.0.finish_reason');
                if ($finishReason !== null && $this->mapFinishReason($data) === FinishReason::ToolCalls) {
                    if ($this->state->hasTextStarted() && $text !== '') {
                        yield new TextCompleteEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            messageId: $this->state->messageId()
                        );
                    }

                    if ($this->state->hasThinkingStarted() && $this->state->currentThinking() !== '') {
                        yield new ThinkingCompleteEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            reasoningId: $this->state->reasoningId()
                        );
                    }

                    yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                    return;
                }

                continue;
            }

            $finishReasonValue = data_get($data, 'choices.0.finish_reason');
            if ($finishReasonValue !== null && $this->mapFinishReason($data) === FinishReason::ToolCalls) {
                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                if ($this->state->hasThinkingStarted() && $this->state->currentThinking() !== '') {
                    yield new ThinkingCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

                return;
            }

            if ($this->hasReasoningDelta($data)) {
                $reasoningDelta = $this->extractReasoningDelta($data);

                if ($reasoningDelta !== '') {
                    if ($this->state->shouldEmitThinkingStart()) {
                        $this->state
                            ->withReasoningId(EventID::generate('reasoning'))
                            ->markThinkingStarted();

                        yield new ThinkingStartEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            reasoningId: $this->state->reasoningId()
                        );
                    }

                    $this->state->appendThinking($reasoningDelta);

                    yield new ThinkingEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        delta: $reasoningDelta,
                        reasoningId: $this->state->reasoningId()
                    );
                }

                continue;
            }

            $content = $this->extractContentDelta($data);
            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();

                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            $rawFinishReason = data_get($data, 'choices.0.finish_reason');
            if ($rawFinishReason !== null) {
                $finishReason = $this->mapFinishReason($data);

                if ($this->state->hasTextStarted() && $text !== '') {
                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                if ($this->state->hasThinkingStarted() && $this->state->currentThinking() !== '') {
                    yield new ThinkingCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                $usage = $this->extractUsage($data);

                yield new StreamEndEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    finishReason: $finishReason,
                    usage: $usage
                );
            }
        }
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if (Str::contains($line, '[DONE]')) {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('OpenRouter', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        return isset($data['choices'][0]['delta']['tool_calls']);
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        $deltaToolCalls = data_get($data, 'choices.0.delta.tool_calls', []);

        foreach ($deltaToolCalls as $deltaToolCall) {
            $index = $deltaToolCall['index'];

            if (isset($deltaToolCall['id'])) {
                $toolCalls[$index]['id'] = $deltaToolCall['id'];
            }

            if (isset($deltaToolCall['type'])) {
                $toolCalls[$index]['type'] = $deltaToolCall['type'];
            }

            if (isset($deltaToolCall['function'])) {
                if (isset($deltaToolCall['function']['name'])) {
                    $toolCalls[$index]['function']['name'] = $deltaToolCall['function']['name'];
                }

                if (isset($deltaToolCall['function']['arguments'])) {
                    $toolCalls[$index]['function']['arguments'] =
                        ($toolCalls[$index]['function']['arguments'] ?? '').
                        $deltaToolCall['function']['arguments'];
                }
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasReasoningDelta(array $data): bool
    {
        return isset($data['choices'][0]['delta']['reasoning']);
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractReasoningDelta(array $data): string
    {
        return data_get($data, 'choices.0.delta.reasoning', '');
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractContentDelta(array $data): string
    {
        return data_get($data, 'choices.0.delta.content', '');
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractFinishReason(array $data): FinishReason
    {
        $finishReason = data_get($data, 'choices.0.finish_reason');

        if ($finishReason === null) {
            return FinishReason::Unknown;
        }

        return $this->mapFinishReason($data);
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        string $text,
        array $toolCalls,
        int $depth
    ): Generator {
        $mappedToolCalls = $this->mapToolCalls($toolCalls);

        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId()
            );
        }

        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        $this->state
            ->resetTextState()
            ->withMessageId(EventID::generate('msg'));

        $depth++;

        if ($depth < $request->maxSteps()) {
            $nextResponse = $this->sendRequest($request);
            yield from $this->processStream($nextResponse, $request, $depth);
        }
    }

    /**
     * Convert raw tool call data to ToolCall objects.
     *
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return collect($toolCalls)
            ->map(function ($toolCall): ToolCall {
                $arguments = data_get($toolCall, 'function.arguments', '');

                if (is_string($arguments) && $arguments !== '') {
                    try {
                        $parsedArguments = json_decode($arguments, true, flags: JSON_THROW_ON_ERROR);
                        $arguments = $parsedArguments;
                    } catch (Throwable) {
                        $arguments = ['raw' => $arguments];
                    }
                }

                return new ToolCall(
                    data_get($toolCall, 'id'),
                    data_get($toolCall, 'function.name'),
                    $arguments,
                );
            })
            ->toArray();
    }

    protected function sendRequest(Request $request): Response
    {
        return $this
            ->client
            ->withOptions(['stream' => true])
            ->post(
                'chat/completions',
                array_merge([
                    'stream' => true,
                    'model' => $request->model(),
                    'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                    'max_tokens' => $request->maxTokens(),
                ], $this->buildRequestOptions($request, [
                    'stream_options' => ['include_usage' => true],
                ]))
            );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data): ?Usage
    {
        $usage = data_get($data, 'usage');

        if (! $usage) {
            return null;
        }

        return new Usage(
            promptTokens: (int) data_get($usage, 'prompt_tokens', 0),
            completionTokens: (int) data_get($usage, 'completion_tokens', 0),
            cacheReadInputTokens: (int) data_get($usage, 'prompt_tokens_details.cached_tokens', 0),
            thoughtTokens: (int) data_get($usage, 'completion_tokens_details.reasoning_tokens', 0)
        );
    }
}



================================================
FILE: src/Providers/OpenRouter/Handlers/Structured.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\OpenRouter\Concerns\BuildsRequestOptions;
use Prism\Prism\Providers\OpenRouter\Concerns\MapsFinishReason;
use Prism\Prism\Providers\OpenRouter\Concerns\ValidatesResponses;
use Prism\Prism\Providers\OpenRouter\Maps\FinishReasonMap;
use Prism\Prism\Providers\OpenRouter\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use BuildsRequestOptions;
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        return $this->createResponse($request, $data);
    }

    /**
     * @see https://openrouter.ai/docs/features/structured-outputs
     *
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
                'structured_outputs' => true,
            ], $this->buildRequestOptions($request, [
                'response_format' => [
                    'type' => 'json_schema',
                    'json_schema' => [
                        'name' => $request->schema()->name(),
                        'strict' => true,
                        'schema' => $request->schema()->toArray(),
                    ],
                ],
            ]))
        );

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function validateResponse(array $data): void
    {
        if ($data === []) {
            throw PrismException::providerResponseError('OpenRouter Error: Empty response');
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function createResponse(Request $request, array $data): StructuredResponse
    {
        $text = data_get($data, 'choices.0.message.content') ?? '';

        $responseMessage = new AssistantMessage($text);
        $request->addMessage($responseMessage);

        $step = new Step(
            text: $text,
            finishReason: FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', '')),
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        );

        $this->responseBuilder->addStep($step);

        return $this->responseBuilder->toResponse();
    }
}



================================================
FILE: src/Providers/OpenRouter/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\OpenRouter\Concerns\BuildsRequestOptions;
use Prism\Prism\Providers\OpenRouter\Concerns\MapsFinishReason;
use Prism\Prism\Providers\OpenRouter\Concerns\ValidatesResponses;
use Prism\Prism\Providers\OpenRouter\Maps\MessageMap;
use Prism\Prism\Providers\OpenRouter\Maps\ToolCallMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use BuildsRequestOptions;
    use CallsTools;
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): TextResponse
    {
        $data = $this->sendRequest($request);

        $this->validateResponse($data);

        $responseMessage = new AssistantMessage(
            data_get($data, 'choices.0.message.content') ?? '',
            ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', [])),
            []
        );

        $request = $request->addMessage($responseMessage);

        return match ($this->mapFinishReason($data)) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request),
            FinishReason::Stop, FinishReason::Length => $this->handleStop($data, $request),
            default => throw new PrismException('OpenRouter: unknown finish reason'),
        };
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request): TextResponse
    {
        $toolResults = $this->callTools(
            $request->tools(),
            ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', []))
        );

        $request = $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request): TextResponse
    {
        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    /**
     * @return array<string, mixed>
     */
    protected function sendRequest(Request $request): array
    {
        $response = $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens(),
            ], $this->buildRequestOptions($request))
        );

        return $response->json();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, ToolResult>  $toolResults
     */
    protected function addStep(array $data, Request $request, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'choices.0.message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            toolCalls: ToolCallMap::map(data_get($data, 'choices.0.message.tool_calls', [])),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens'),
                data_get($data, 'usage.completion_tokens'),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/AudioMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;

/**
 * NOTE: mirrored from Gemini's AudioVideoMapper so future refactors can consolidate.
 */
class AudioMapper extends ProviderMediaMapper
{
    /**
     * @return array<string, mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'input_audio',
            'input_audio' => [
                'data' => $this->media->base64(),
                'format' => $this->determineFormat(),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenRouter;
    }

    protected function validateMedia(): bool
    {
        return $this->media->hasRawContent();
    }

    protected function determineFormat(): string
    {
        $mimeType = $this->media->mimeType();

        return match ($mimeType) {
            'audio/wav', 'audio/x-wav', 'audio/wave' => 'wav',
            'audio/mpeg', 'audio/mp3' => 'mp3',
            'audio/ogg' => 'ogg',
            'audio/webm' => 'webm',
            default => 'wav',
        };
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $reason): FinishReason
    {
        return match ($reason) {
            'stop' => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            'content_filter' => FinishReason::ContentFilter,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/ImageMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'image_url',
            'image_url' => [
                'url' => $this->media->isUrl()
                    ? $this->media->url()
                    : sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64()),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenRouter;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use BackedEnum;
use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $cacheType = $message->providerOptions('cacheType');

        // OpenRouter supports cache_control in content array format (same as Anthropic)
        if ($cacheType) {
            $this->mappedMessages[] = [
                'role' => 'system',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => $message->content,
                        'cache_control' => ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType],
                    ],
                ],
            ];
        } else {
            $this->mappedMessages[] = [
                'role' => 'system',
                'content' => $message->content,
            ];
        }
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        $cacheType = $message->providerOptions('cacheType');
        $cacheControl = $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null;

        $toolResults = $message->toolResults;
        $totalResults = count($toolResults);

        // OpenRouter supports cache_control in content array format
        if ($cacheControl) {
            $content = array_map(function (ToolResult $toolResult, int $index) use ($cacheControl, $totalResults): array {
                // Only add cache_control to the last tool result
                $isLastResult = $index === $totalResults - 1;

                return array_filter([
                    'type' => 'tool_result',
                    'tool_call_id' => $toolResult->toolCallId,
                    'content' => $toolResult->result,
                    'cache_control' => $isLastResult ? $cacheControl : null,
                ]);
            }, $toolResults, array_keys($toolResults));

            $this->mappedMessages[] = [
                'role' => 'tool',
                'content' => $content,
            ];
        } else {
            // Legacy format without caching
            foreach ($toolResults as $toolResult) {
                $this->mappedMessages[] = [
                    'role' => 'tool',
                    'tool_call_id' => $toolResult->toolCallId,
                    'content' => $toolResult->result,
                ];
            }
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $cacheType = $message->providerOptions('cacheType');
        $cacheControl = $cacheType ? ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType] : null;

        $imageParts = array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $message->images());
        // NOTE: mirrored from Gemini's multimodal mapper so we stay consistent across providers.
        $audioParts = array_map(fn (Audio $audio): array => (new AudioMapper($audio))->toPayload(), $message->audios());
        $videoParts = array_map(fn (Video $video): array => (new VideoMapper($video))->toPayload(), $message->videos());

        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                array_filter([
                    'type' => 'text',
                    'text' => $message->text(),
                    'cache_control' => $cacheControl,
                ]),
                ...$imageParts,
                ...$audioParts,
                ...$videoParts,
            ],
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $cacheType = $message->providerOptions('cacheType');

        $toolCalls = array_map(fn (ToolCall $toolCall): array => [
            'id' => $toolCall->id,
            'type' => 'function',
            'function' => [
                'name' => $toolCall->name,
                'arguments' => json_encode($toolCall->arguments()),
            ],
        ], $message->toolCalls);

        // OpenRouter supports cache_control on assistant messages
        if ($cacheType && $message->content !== '' && $message->content !== '0') {
            $this->mappedMessages[] = array_filter([
                'role' => 'assistant',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => $message->content,
                        'cache_control' => ['type' => $cacheType instanceof BackedEnum ? $cacheType->value : $cacheType],
                    ],
                ],
                'tool_calls' => $toolCalls,
            ]);
        } else {
            $this->mappedMessages[] = array_filter([
                'role' => 'assistant',
                'content' => $message->content,
                'tool_calls' => $toolCalls,
            ]);
        }
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/ToolCallMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\ValueObjects\ToolCall;

class ToolCallMap
{
    /**
     * @param  array<int, mixed>  $toolCalls
     * @return array<int, ToolCall>
     */
    public static function map(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: $toolCall['id'],
            name: $toolCall['function']['name'],
            arguments: json_decode((string) $toolCall['function']['arguments'], true),
        ), $toolCalls);
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $toolChoice,
                ],
            ];
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            null => $toolChoice,
            default => throw new InvalidArgumentException('Invalid tool choice')
        };
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  array<int, Tool>  $tools
     * @return array<int, mixed>
     */
    public static function map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => array_filter([
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                ...$tool->hasParameters() ? [
                    'parameters' => (function () use ($tool): array {
                        $properties = $tool->parametersAsArray();

                        return [
                            'type' => 'object',
                            'properties' => $properties === [] ? new \stdClass : $properties,
                            'required' => $tool->requiredParameters(),
                        ];
                    })(),
                ] : [],
                'parameters' => [
                    'type' => 'object',
                    'properties' => $tool->hasParameters() ? $tool->parametersAsArray() : (object) [],
                    'required' => $tool->requiredParameters(),
                ],
            ],
            'strict' => $tool->providerOptions('strict'),
        ]), $tools);
    }
}



================================================
FILE: src/Providers/OpenRouter/Maps/VideoMapper.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\OpenRouter\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;

/**
 * NOTE: mirrored from Gemini's AudioVideoMapper so future refactors can consolidate.
 */
class VideoMapper extends ProviderMediaMapper
{
    /**
     * @return array<string, mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'input_video',
            'input_video' => [
                'data' => $this->media->base64(),
                'format' => $this->determineFormat(),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::OpenRouter;
    }

    protected function validateMedia(): bool
    {
        return $this->media->hasRawContent();
    }

    protected function determineFormat(): string
    {
        $mimeType = $this->media->mimeType();

        return match ($mimeType) {
            'video/mp4' => 'mp4',
            'video/webm' => 'webm',
            'video/ogg', 'video/ogv' => 'ogg',
            default => 'mp4',
        };
    }
}



================================================
FILE: src/Providers/VoyageAI/Embeddings.php
================================================
<?php

namespace Prism\Prism\Providers\VoyageAI;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Prism\Prism\Embeddings\Request as EmbeddingsRequest;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

class Embeddings
{
    protected EmbeddingsRequest $request;

    protected Response $httpResponse;

    public function __construct(protected PendingRequest $client) {}

    public function handle(EmbeddingsRequest $request): EmbeddingsResponse
    {
        $this->request = $request;

        $this->sendRequest();

        $this->validateResponse();

        $data = $this->httpResponse->json();

        return new EmbeddingsResponse(
            embeddings: array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($data, 'data', [])),
            usage: new EmbeddingsUsage(
                tokens: data_get($data, 'usage.total_tokens', null),
            ),
            meta: new Meta(
                id: '',
                model: data_get($data, 'model', ''),
            ),
        );
    }

    protected function sendRequest(): void
    {
        $providerOptions = $this->request->providerOptions();

        $this->httpResponse = $this->client->post('embeddings', Arr::whereNotNull([
            'model' => $this->request->model(),
            'input' => $this->request->inputs(),
            'input_type' => $providerOptions['inputType'] ?? null,
            'truncation' => $providerOptions['truncation'] ?? null,
        ]));
    }

    protected function validateResponse(): void
    {
        $data = $this->httpResponse->json();

        if (! $data || data_get($data, 'detail')) {
            throw PrismException::providerResponseError('Voyage AI error: '.data_get($data, 'detail'));
        }
    }
}



================================================
FILE: src/Providers/VoyageAI/VoyageAI.php
================================================
<?php

namespace Prism\Prism\Providers\VoyageAI;

use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Providers\Provider;

class VoyageAI extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] protected readonly string $apiKey,
        protected readonly string $baseUrl
    ) {}

    #[\Override]
    public function embeddings(EmbeddingRequest $request): EmbeddingsResponse
    {
        $handler = new Embeddings($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->baseUrl);
    }
}



================================================
FILE: src/Providers/XAI/XAI.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Prism\Prism\Concerns\InitializesClient;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Providers\XAI\Handlers\Stream;
use Prism\Prism\Providers\XAI\Handlers\Structured;
use Prism\Prism\Providers\XAI\Handlers\Text;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;

class XAI extends Provider
{
    use InitializesClient;

    public function __construct(
        #[\SensitiveParameter] public readonly string $apiKey,
        public readonly string $url,
    ) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $handler = new Text($this->client($request->clientOptions(), $request->clientRetry()));

        return $handler->handle($request);
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $handler = new Stream($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $handler = new Structured($this->client(
            $request->clientOptions(),
            $request->clientRetry()
        ));

        return $handler->handle($request);
    }

    /**
     * @param  array<string, mixed>  $options
     * @param  array<mixed>  $retry
     */
    protected function client(array $options = [], array $retry = [], ?string $baseUrl = null): PendingRequest
    {
        return $this->baseClient()
            ->when($this->apiKey, fn ($client) => $client->withToken($this->apiKey))
            ->withOptions($options)
            ->when($retry !== [], fn ($client) => $client->retry(...$retry))
            ->baseUrl($baseUrl ?? $this->url);
    }
}



================================================
FILE: src/Providers/XAI/Concerns/ExtractsThinking.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Concerns;

use Prism\Prism\Text\Request;

trait ExtractsThinking
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractThinking(array $data, Request $request): string
    {
        if (data_get($request->providerOptions('thinking'), 'enabled', true) === false) {
            return '';
        }

        $reasoning = data_get($data, 'choices.0.delta.reasoning_content', '');

        if ($reasoning !== '') {
            static $lastThinkingContent = ''; // preserve state across calls

            if (str_contains((string) $lastThinkingContent, 'Thinking') && trim((string) $reasoning) === 'Thinking...') {
                return '';
            }

            $lastThinkingContent .= $reasoning;

            return $reasoning;
        }

        return data_get($data, 'choices.0.delta.thinking', '');
    }
}



================================================
FILE: src/Providers/XAI/Concerns/MapsFinishReason.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Concerns;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\XAI\Maps\FinishReasonMap;

trait MapsFinishReason
{
    /**
     * @param  array<string, mixed>  $data
     */
    protected function mapFinishReason(array $data): FinishReason
    {
        return empty(data_get($data, 'choices.0.finish_reason', ''))
            ? (empty(data_get($data, 'choices.0.message.tool_calls', []))
                ? FinishReasonMap::map('')
                : FinishReasonMap::map('tool_calls'))
            : FinishReasonMap::map(data_get($data, 'choices.0.finish_reason', ''));
    }
}



================================================
FILE: src/Providers/XAI/Concerns/ValidatesResponses.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Concerns;

use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;

trait ValidatesResponses
{
    protected function validateResponse(Response $response): void
    {
        $data = $response->json();

        if (! $data || data_get($data, 'error')) {
            throw PrismException::providerResponseError(vsprintf(
                'XAI Error:  [%s] %s',
                [
                    data_get($data, 'error.type', 'unknown'),
                    data_get($data, 'error.message', 'unknown'),
                ]
            ));
        }
    }
}



================================================
FILE: src/Providers/XAI/Handlers/Stream.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Handlers;

use Generator;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Providers\XAI\Concerns\ExtractsThinking;
use Prism\Prism\Providers\XAI\Concerns\MapsFinishReason;
use Prism\Prism\Providers\XAI\Concerns\ValidatesResponses;
use Prism\Prism\Providers\XAI\Maps\MessageMap;
use Prism\Prism\Providers\XAI\Maps\ToolChoiceMap;
use Prism\Prism\Providers\XAI\Maps\ToolMap;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\Text\Request;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\Usage;
use Psr\Http\Message\StreamInterface;
use Throwable;

class Stream
{
    use CallsTools, ExtractsThinking, MapsFinishReason, ValidatesResponses;

    protected StreamState $state;

    public function __construct(protected PendingRequest $client)
    {
        $this->state = new StreamState;
    }

    /**
     * @return Generator<StreamEvent>
     */
    public function handle(Request $request): Generator
    {
        $response = $this->sendRequest($request);

        yield from $this->processStream($response, $request);
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function processStream(Response $response, Request $request, int $depth = 0): Generator
    {
        if ($depth >= $request->maxSteps()) {
            throw new PrismException('Maximum tool call chain depth exceeded');
        }

        if ($depth === 0) {
            $this->state->reset();
        }

        $text = '';
        $toolCalls = [];
        $finishReason = null;
        $usage = null;

        while (! $response->getBody()->eof()) {
            $data = $this->parseNextDataLine($response->getBody());

            if ($data === null) {
                continue;
            }

            if ($this->state->shouldEmitStreamStart()) {
                $this->state
                    ->withMessageId(EventID::generate())
                    ->markStreamStarted();

                yield new StreamStartEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    model: data_get($data, 'model', $request->model()),
                    provider: 'xai'
                );
            }

            $thinkingContent = $this->extractThinking($data, $request);

            if ($thinkingContent !== '' && $thinkingContent !== '0') {
                if ($this->state->shouldEmitThinkingStart()) {
                    $this->state
                        ->withReasoningId(EventID::generate())
                        ->markThinkingStarted();

                    yield new ThinkingStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        reasoningId: $this->state->reasoningId()
                    );
                }

                yield new ThinkingEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $thinkingContent,
                    reasoningId: $this->state->reasoningId()
                );

                continue;
            }

            if ($this->state->hasThinkingStarted() && $thinkingContent === '') {
                yield new ThinkingCompleteEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    reasoningId: $this->state->reasoningId()
                );
                $this->state->resetTextState();
            }

            if ($this->hasToolCalls($data)) {
                $toolCalls = $this->extractToolCalls($data, $toolCalls);

                continue;
            }

            $content = $this->extractContent($data);

            if ($content !== '') {
                if ($this->state->shouldEmitTextStart()) {
                    $this->state->markTextStarted();

                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $this->state->messageId()
                    );
                }

                $text .= $content;

                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $content,
                    messageId: $this->state->messageId()
                );
            }

            $rawFinishReason = data_get($data, 'choices.0.finish_reason');
            if ($rawFinishReason !== null) {
                $finishReason = $this->extractFinishReason($data);
                $usage = $this->extractUsage($data);
            }
        }

        if ($toolCalls !== []) {
            if ($this->state->hasTextStarted() && $text !== '') {
                yield new TextCompleteEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    messageId: $this->state->messageId()
                );
            }

            yield from $this->handleToolCalls($request, $text, $toolCalls, $depth);

            return;
        }

        if ($this->state->hasTextStarted() && $text !== '') {
            yield new TextCompleteEvent(
                id: EventID::generate(),
                timestamp: time(),
                messageId: $this->state->messageId()
            );
        }

        yield new StreamEndEvent(
            id: EventID::generate(),
            timestamp: time(),
            finishReason: $finishReason ?? FinishReason::Stop,
            usage: $usage
        );
    }

    /**
     * @return array<string, mixed>|null
     */
    protected function parseNextDataLine(StreamInterface $stream): ?array
    {
        $line = $this->readLine($stream);

        if (! str_starts_with($line, 'data:')) {
            return null;
        }

        $line = trim(substr($line, strlen('data: ')));

        if (Str::contains($line, '[DONE]')) {
            return null;
        }

        try {
            return json_decode($line, true, flags: JSON_THROW_ON_ERROR);
        } catch (Throwable $e) {
            throw new PrismStreamDecodeException('XAI', $e);
        }
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function isInitialChunk(array $data): bool
    {
        return isset($data['id']) && isset($data['model']) && data_get($data, 'choices.0.delta.content') === null;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function hasToolCalls(array $data): bool
    {
        return ! empty(data_get($data, 'choices.0.delta.tool_calls'));
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, array<string, mixed>>
     */
    protected function extractToolCalls(array $data, array $toolCalls): array
    {
        $deltaToolCalls = data_get($data, 'choices.0.delta.tool_calls', []);

        foreach ($deltaToolCalls as $deltaToolCall) {
            $index = data_get($deltaToolCall, 'index', 0);

            if (! isset($toolCalls[$index])) {
                $toolCalls[$index] = [
                    'id' => '',
                    'name' => '',
                    'arguments' => '',
                ];
            }

            if ($id = data_get($deltaToolCall, 'id')) {
                $toolCalls[$index]['id'] = $id;
            }

            if ($name = data_get($deltaToolCall, 'function.name')) {
                $toolCalls[$index]['name'] = $name;
            }

            if ($arguments = data_get($deltaToolCall, 'function.arguments')) {
                $toolCalls[$index]['arguments'] .= $arguments;
            }
        }

        return $toolCalls;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractContent(array $data): string
    {
        return data_get($data, 'choices.0.delta.content', '');
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractFinishReason(array $data): ?FinishReason
    {
        $finishReason = data_get($data, 'choices.0.finish_reason');

        if ($finishReason === null) {
            return null;
        }

        return $this->mapFinishReason(['choices' => [['finish_reason' => $finishReason]]]);
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function extractUsage(array $data): ?Usage
    {
        $usage = data_get($data, 'usage');

        if ($usage === null) {
            return null;
        }

        return new Usage(
            promptTokens: data_get($usage, 'prompt_tokens', 0),
            completionTokens: data_get($usage, 'completion_tokens', 0),
        );
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return Generator<StreamEvent>
     */
    protected function handleToolCalls(
        Request $request,
        string $text,
        array $toolCalls,
        int $depth
    ): Generator {
        $mappedToolCalls = $this->mapToolCalls($toolCalls);

        foreach ($mappedToolCalls as $toolCall) {
            yield new ToolCallEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolCall: $toolCall,
                messageId: $this->state->messageId()
            );
        }

        $toolResults = $this->callTools($request->tools(), $mappedToolCalls);

        foreach ($toolResults as $result) {
            yield new ToolResultEvent(
                id: EventID::generate(),
                timestamp: time(),
                toolResult: $result,
                messageId: $this->state->messageId()
            );
        }

        $request->addMessage(new AssistantMessage($text, $mappedToolCalls));
        $request->addMessage(new ToolResultMessage($toolResults));

        $this->state
            ->resetTextState()
            ->withMessageId(EventID::generate());

        $nextResponse = $this->sendRequest($request);
        yield from $this->processStream($nextResponse, $request, $depth + 1);
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'name'),
            arguments: data_get($toolCall, 'arguments'),
        ), $toolCalls);
    }

    protected function sendRequest(Request $request): Response
    {
        return $this->client
            ->withOptions(['stream' => true])
            ->post(
                'chat/completions',
                array_merge([
                    'model' => $request->model(),
                    'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                    'stream' => true,
                    'max_tokens' => $request->maxTokens() ?? 2048,
                ], Arr::whereNotNull([
                    'temperature' => $request->temperature(),
                    'top_p' => $request->topP(),
                    'tools' => ToolMap::map($request->tools()),
                    'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
                ]))
            );
    }

    protected function readLine(StreamInterface $stream): string
    {
        $buffer = '';

        while (! $stream->eof()) {
            $byte = $stream->read(1);

            if ($byte === '') {
                return $buffer;
            }

            $buffer .= $byte;

            if ($byte === "\n") {
                break;
            }
        }

        return $buffer;
    }
}



================================================
FILE: src/Providers/XAI/Handlers/Structured.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\XAI\Concerns\MapsFinishReason;
use Prism\Prism\Providers\XAI\Concerns\ValidatesResponses;
use Prism\Prism\Providers\XAI\Maps\MessageMap;
use Prism\Prism\Structured\Request;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class Structured
{
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): StructuredResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        $this->handleRefusal(data_get($data, 'choices.0.message', []));

        $content = data_get($data, 'choices.0.message.content') ?? '';
        $parsed = data_get($data, 'choices.0.message.parsed');

        $responseMessage = new AssistantMessage($content);

        $request->addMessage($responseMessage);

        $this->addStep($data, $request, $parsed);

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<string, mixed>|null  $parsed
     */
    protected function addStep(array $data, Request $request, ?array $parsed): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'choices.0.message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            usage: new Usage(
                promptTokens: data_get($data, 'usage.prompt_tokens', 0),
                completionTokens: data_get($data, 'usage.completion_tokens', 0),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
            structured: $parsed ?? [],
        ));
    }

    protected function sendRequest(Request $request): ClientResponse
    {

        $responseFormat = $this->buildResponseFormat($request);

        return $this->client->post(
            'chat/completions',
            array_merge([
                'model' => $request->model(),
                'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
                'max_tokens' => $request->maxTokens() ?? 2048,
                'response_format' => $responseFormat,
            ], Arr::whereNotNull([
                'temperature' => $request->temperature(),
                'top_p' => $request->topP(),
            ]))
        );
    }

    /**
     * @return array<string, mixed>
     */
    protected function buildResponseFormat(Request $request): array
    {
        return [
            'type' => 'json_schema',
            'json_schema' => Arr::whereNotNull([
                'name' => $request->schema()->name(),
                'schema' => $request->schema()->toArray(),
                'strict' => $request->providerOptions('schema.strict') ? true : null,
            ]),
        ];
    }

    /**
     * @param  array<string, mixed>  $message
     */
    protected function handleRefusal(array $message): void
    {
        if (data_get($message, 'refusal') !== null) {
            throw new PrismException(sprintf('XAI Refusal: %s', $message['refusal']));
        }
    }
}



================================================
FILE: src/Providers/XAI/Handlers/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Handlers;

use Illuminate\Http\Client\PendingRequest;
use Illuminate\Http\Client\Response as ClientResponse;
use Illuminate\Support\Arr;
use Prism\Prism\Concerns\CallsTools;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\XAI\Concerns\MapsFinishReason;
use Prism\Prism\Providers\XAI\Concerns\ValidatesResponses;
use Prism\Prism\Providers\XAI\Maps\MessageMap;
use Prism\Prism\Providers\XAI\Maps\ToolChoiceMap;
use Prism\Prism\Providers\XAI\Maps\ToolMap;
use Prism\Prism\Text\Request;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

class Text
{
    use CallsTools;
    use MapsFinishReason;
    use ValidatesResponses;

    protected ResponseBuilder $responseBuilder;

    public function __construct(protected PendingRequest $client)
    {
        $this->responseBuilder = new ResponseBuilder;
    }

    public function handle(Request $request): TextResponse
    {
        $response = $this->sendRequest($request);

        $this->validateResponse($response);

        $data = $response->json();

        // Handle potential refusal from XAI
        $this->handleRefusal(data_get($data, 'choices.0.message', []));

        $responseMessage = new AssistantMessage(
            data_get($data, 'choices.0.message.content') ?? '',
            $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', [])),
        );

        $request->addMessage($responseMessage);

        $finishReason = $this->mapFinishReason($data);

        return match ($finishReason) {
            FinishReason::ToolCalls => $this->handleToolCalls($data, $request),
            FinishReason::Stop, FinishReason::Length => $this->handleStop($data, $request),
            default => throw new PrismException('XAI: unknown finish reason'),
        };
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleToolCalls(array $data, Request $request): TextResponse
    {
        $toolCalls = $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', []));

        if ($toolCalls === []) {
            throw new PrismException('XAI: finish reason is tool_calls but no tool calls found in response');
        }

        $toolResults = $this->callTools($request->tools(), $toolCalls);

        $request->addMessage(new ToolResultMessage($toolResults));

        $this->addStep($data, $request, $toolResults);

        if ($this->shouldContinue($request)) {
            return $this->handle($request);
        }

        return $this->responseBuilder->toResponse();
    }

    /**
     * @param  array<string, mixed>  $data
     */
    protected function handleStop(array $data, Request $request): TextResponse
    {
        $this->addStep($data, $request);

        return $this->responseBuilder->toResponse();
    }

    protected function shouldContinue(Request $request): bool
    {
        return $this->responseBuilder->steps->count() < $request->maxSteps();
    }

    protected function sendRequest(Request $request): ClientResponse
    {
        $payload = array_merge([
            'model' => $request->model(),
            'messages' => (new MessageMap($request->messages(), $request->systemPrompts()))(),
            'max_tokens' => $request->maxTokens() ?? 2048,
        ], Arr::whereNotNull([
            'temperature' => $request->temperature(),
            'top_p' => $request->topP(),
            'tools' => ToolMap::map($request->tools()),
            'tool_choice' => ToolChoiceMap::map($request->toolChoice()),
        ]));

        return $this->client->post('chat/completions', $payload);
    }

    /**
     * @param  array<string, mixed>  $message
     */
    protected function handleRefusal(array $message): void
    {
        if (data_get($message, 'refusal') !== null) {
            throw new PrismException(sprintf('XAI Refusal: %s', $message['refusal']));
        }
    }

    /**
     * @param  array<int, array<string, mixed>>  $toolCalls
     * @return array<int, ToolCall>
     */
    protected function mapToolCalls(array $toolCalls): array
    {
        return array_map(fn (array $toolCall): ToolCall => new ToolCall(
            id: data_get($toolCall, 'id'),
            name: data_get($toolCall, 'function.name'),
            arguments: data_get($toolCall, 'function.arguments'),
        ), $toolCalls);
    }

    /**
     * @param  array<string, mixed>  $data
     * @param  array<int, ToolResult>  $toolResults
     */
    protected function addStep(array $data, Request $request, array $toolResults = []): void
    {
        $this->responseBuilder->addStep(new Step(
            text: data_get($data, 'choices.0.message.content') ?? '',
            finishReason: $this->mapFinishReason($data),
            toolCalls: $this->mapToolCalls(data_get($data, 'choices.0.message.tool_calls', [])),
            toolResults: $toolResults,
            usage: new Usage(
                data_get($data, 'usage.prompt_tokens', 0),
                data_get($data, 'usage.completion_tokens', 0),
            ),
            meta: new Meta(
                id: data_get($data, 'id'),
                model: data_get($data, 'model'),
            ),
            messages: $request->messages(),
            systemPrompts: $request->systemPrompts(),
            additionalContent: [],
        ));
    }
}



================================================
FILE: src/Providers/XAI/Maps/FinishReasonMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Maps;

use Prism\Prism\Enums\FinishReason;

class FinishReasonMap
{
    public static function map(string $reason): FinishReason
    {
        return match ($reason) {
            'stop', => FinishReason::Stop,
            'tool_calls' => FinishReason::ToolCalls,
            'length' => FinishReason::Length,
            'content_filter' => FinishReason::ContentFilter,
            default => FinishReason::Unknown,
        };
    }
}



================================================
FILE: src/Providers/XAI/Maps/ImageMapper.php
================================================
<?php

namespace Prism\Prism\Providers\XAI\Maps;

use Prism\Prism\Contracts\ProviderMediaMapper;
use Prism\Prism\Enums\Provider;
use Prism\Prism\ValueObjects\Media\Image;

/**
 * @property Image $media
 */
class ImageMapper extends ProviderMediaMapper
{
    /**
     * @return array<string,mixed>
     */
    public function toPayload(): array
    {
        return [
            'type' => 'image_url',
            'image_url' => [
                'url' => $this->media->isUrl()
                    ? $this->media->url()
                    : sprintf('data:%s;base64,%s', $this->media->mimeType(), $this->media->base64()),
            ],
        ];
    }

    protected function provider(): string|Provider
    {
        return Provider::XAI;
    }

    protected function validateMedia(): bool
    {
        if ($this->media->isUrl()) {
            return true;
        }

        return $this->media->hasRawContent();
    }
}



================================================
FILE: src/Providers/XAI/Maps/MessageMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Maps;

use Exception;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;

class MessageMap
{
    /** @var array<int, mixed> */
    protected array $mappedMessages = [];

    /**
     * @param  array<int, Message>  $messages
     * @param  SystemMessage[]  $systemPrompts
     */
    public function __construct(
        protected array $messages,
        protected array $systemPrompts
    ) {
        $this->messages = array_merge(
            $this->systemPrompts,
            $this->messages
        );
    }

    /**
     * @return array<int, mixed>
     */
    public function __invoke(): array
    {
        array_map(
            $this->mapMessage(...),
            $this->messages
        );

        return $this->mappedMessages;
    }

    protected function mapMessage(Message $message): void
    {
        match ($message::class) {
            UserMessage::class => $this->mapUserMessage($message),
            AssistantMessage::class => $this->mapAssistantMessage($message),
            ToolResultMessage::class => $this->mapToolResultMessage($message),
            SystemMessage::class => $this->mapSystemMessage($message),
            default => throw new Exception('Could not map message type '.$message::class),
        };
    }

    protected function mapSystemMessage(SystemMessage $message): void
    {
        $this->mappedMessages[] = [
            'role' => 'system',
            'content' => $message->content,
        ];
    }

    protected function mapToolResultMessage(ToolResultMessage $message): void
    {
        foreach ($message->toolResults as $toolResult) {
            $this->mappedMessages[] = [
                'role' => 'tool',
                'tool_call_id' => $toolResult->toolCallId,
                'content' => $toolResult->result,
            ];
        }
    }

    protected function mapUserMessage(UserMessage $message): void
    {
        $imageParts = array_map(fn (Image $image): array => (new ImageMapper($image))->toPayload(), $message->images());

        $this->mappedMessages[] = [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => $message->text()],
                ...$imageParts,
            ],
        ];
    }

    protected function mapAssistantMessage(AssistantMessage $message): void
    {
        $toolCalls = array_map(fn (ToolCall $toolCall): array => [
            'id' => $toolCall->id,
            'type' => 'function',
            'function' => [
                'name' => $toolCall->name,
                'arguments' => json_encode($toolCall->arguments()),
            ],
        ], $message->toolCalls);

        $this->mappedMessages[] = array_filter([
            'role' => 'assistant',
            'content' => $message->content,
            'tool_calls' => $toolCalls,
        ]);
    }
}



================================================
FILE: src/Providers/XAI/Maps/ToolChoiceMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Maps;

use InvalidArgumentException;
use Prism\Prism\Enums\ToolChoice;

class ToolChoiceMap
{
    /**
     * @return array<string, mixed>|string|null
     */
    public static function map(string|ToolChoice|null $toolChoice): string|array|null
    {
        if (is_null($toolChoice)) {
            return null;
        }

        if (is_string($toolChoice)) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $toolChoice,
                ],
            ];
        }

        if (! in_array($toolChoice, [ToolChoice::Auto, ToolChoice::Any])) {
            throw new InvalidArgumentException('Invalid tool choice');
        }

        return match ($toolChoice) {
            ToolChoice::Auto => 'auto',
            ToolChoice::Any => 'required',
        };
    }
}



================================================
FILE: src/Providers/XAI/Maps/ToolMap.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Providers\XAI\Maps;

use Prism\Prism\Tool;

class ToolMap
{
    /**
     * @param  Tool[]  $tools
     * @return array<string, mixed>
     */
    public static function Map(array $tools): array
    {
        return array_map(fn (Tool $tool): array => [
            'type' => 'function',
            'function' => [
                'name' => $tool->name(),
                'description' => $tool->description(),
                'parameters' => [
                    'type' => 'object',
                    'properties' => $tool->parametersAsArray(),
                    'required' => $tool->requiredParameters(),
                ],
            ],
        ], $tools);
    }
}



================================================
FILE: src/Rectors/ReorderMethodsRector.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Rectors;

use PhpParser\Node;
use PhpParser\Node\Stmt\Class_;
use PhpParser\Node\Stmt\ClassMethod;
use Rector\Rector\AbstractRector;

class ReorderMethodsRector extends AbstractRector
{
    #[\Override]
    public function getNodeTypes(): array
    {
        return [Class_::class];
    }

    /**
     * @param  Class_  $node
     */
    #[\Override]
    public function refactor(Node $node): ?Node
    {
        $methods = $node->getMethods();

        if (count($methods) <= 1) {
            return null;
        }

        $reorderedMethods = $this->reorderMethods($methods);

        if ($methods === $reorderedMethods) {
            return null;
        }

        $node->stmts = array_merge(
            array_filter($node->stmts, fn (\PhpParser\Node\Stmt $stmt): bool => ! $stmt instanceof ClassMethod),
            $reorderedMethods
        );

        return $node;
    }

    /**
     * @param  array<int, ClassMethod>  $methods
     * @return array<int, ClassMethod>
     */
    protected function reorderMethods(array $methods): array
    {
        usort($methods, fn (ClassMethod $a, ClassMethod $b): int => $this->getMethodWeight($a) <=> $this->getMethodWeight($b));

        return $methods;
    }

    protected function getMethodWeight(ClassMethod $method): int
    {
        if ($this->isMagicMethod($method)) {
            return 0;
        }

        if ($method->isPublic()) {
            return 1;
        }

        if ($method->isProtected()) {
            return 2;
        }

        return 3; // private
    }

    protected function isMagicMethod(ClassMethod $method): bool
    {
        return str_starts_with($method->name->toString(), '__');
    }
}



================================================
FILE: src/Routes/PrismServer.php
================================================
<?php

use Illuminate\Support\Facades\Route;
use Prism\Prism\Http\Controllers\PrismChatController;
use Prism\Prism\Http\Controllers\PrismModelController;

Route::prefix('/prism/openai/v1')
    ->group(function (): void {
        Route::post('/chat/completions', PrismChatController::class);
        Route::get('/models', PrismModelController::class);
    });



================================================
FILE: src/Schema/AnyOfSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class AnyOfSchema implements Schema
{
    use NullableSchema;

    /**
     * @param  array<Schema>  $schemas  Array of schema instances to match any of
     * @param  string|null  $name  Optional name for the schema
     * @param  string|null  $description  Optional description for the schema
     * @param  bool  $nullable  Whether the schema can be null
     */
    public function __construct(
        public readonly array $schemas,
        public readonly ?string $name = null,
        public readonly ?string $description = null,
        public readonly bool $nullable = false,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name ?? 'item';
    }

    #[\Override]
    public function toArray(): array
    {
        // Validate that all nested schemas are valid according to OpenAI requirements
        $validatedSchemas = array_map(
            fn (Schema $schema): array => $this->validateNestedSchema($schema->toArray()),
            $this->schemas
        );

        $schema = [
            'anyOf' => $validatedSchemas,
        ];

        // Add description only if provided
        if ($this->description !== null) {
            $schema['description'] = $this->description;
        }

        // If nullable, add null as one of the anyOf options
        if ($this->nullable) {
            $schema['anyOf'][] = ['type' => 'null'];
        }

        return $schema;
    }

    /**
     * Validate that nested schema conforms to OpenAI's subset requirements.
     *
     * @param  array<string, mixed>  $schemaArray
     * @return array<string, mixed>
     */
    protected function validateNestedSchema(array $schemaArray): array
    {
        // For anyOf, nested schemas must each be a valid JSON schema per OpenAI's subset
        // This includes ensuring they have proper structure and don't contain unsupported features

        // Ensure the schema has a type (required by OpenAI)
        if (! isset($schemaArray['type']) && ! isset($schemaArray['anyOf']) && ! isset($schemaArray['oneOf'])) {
            throw new \InvalidArgumentException(
                'Each nested schema in anyOf must have a "type" or be a composition schema (anyOf/oneOf)'
            );
        }

        // Remove unsupported properties that might cause issues with OpenAI
        $unsupportedKeys = ['examples', 'default', 'if', 'then', 'else', 'not'];
        foreach ($unsupportedKeys as $key) {
            unset($schemaArray[$key]);
        }

        return $schemaArray;
    }
}



================================================
FILE: src/Schema/ArraySchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class ArraySchema implements Schema
{
    use NullableSchema;

    public function __construct(
        public readonly string $name,
        public readonly string $description,
        public readonly Schema $items,
        public readonly bool $nullable = false,
        public readonly ?int $minItems = null,
        public readonly ?int $maxItems = null,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        $schema = [
            'description' => $this->description,
            'type' => $this->nullable
                ? $this->castToNullable('array')
                : 'array',
            'items' => $this->items->toArray(),
        ];

        if ($this->minItems !== null) {
            $schema['minItems'] = $this->minItems;
        }
        if ($this->maxItems !== null) {
            $schema['maxItems'] = $this->maxItems;
        }

        return $schema;
    }
}



================================================
FILE: src/Schema/BooleanSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class BooleanSchema implements Schema
{
    use NullableSchema;

    public function __construct(
        public readonly string $name,
        public readonly string $description,
        public readonly bool $nullable = false,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        return [
            'description' => $this->description,
            'type' => $this->nullable
                ? $this->castToNullable('boolean')
                : 'boolean',
        ];
    }
}



================================================
FILE: src/Schema/EnumSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Contracts\Schema;

readonly class EnumSchema implements Schema
{
    /**
     * @param  array<int, string|int|float>  $options
     */
    public function __construct(
        public string $name,
        public string $description,
        public array $options,
        public bool $nullable = false,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        return [
            'description' => $this->description,
            'enum' => $this->options,
            'type' => $this->types(),
        ];
    }

    /**
     * @return string[]|string
     */
    protected function types(): array|string
    {
        $types = $this->resolveTypes();

        if ($this->nullable) {
            $types[] = 'null';
        }

        if ($this->hasSingleType($types)) {
            return $types[0];
        }

        return $types;
    }

    /**
     * @param  string[]  $types
     */
    protected function hasSingleType(array $types): bool
    {
        return count($types) === 1;
    }

    /**
     * @return string[]
     */
    protected function resolveTypes(): array
    {
        return collect($this->options)
            ->map(fn (mixed $option): string => match (gettype($option)) {
                'integer', 'double' => 'number',
                'string' => 'string'
            })
            ->unique()
            ->values()
            ->toArray();

    }
}



================================================
FILE: src/Schema/NumberSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class NumberSchema implements Schema
{
    use NullableSchema;

    public function __construct(
        public readonly string $name,
        public readonly string $description,
        public readonly bool $nullable = false,
        public readonly ?float $multipleOf = null,
        public readonly ?float $maximum = null,
        public readonly ?float $exclusiveMaximum = null,
        public readonly ?float $minimum = null,
        public readonly ?float $exclusiveMinimum = null,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        $schema = [
            'description' => $this->description,
            'type' => $this->nullable
                ? $this->castToNullable('number')
                : 'number',
        ];

        if ($this->multipleOf !== null) {
            $schema['multipleOf'] = $this->multipleOf;
        }
        if ($this->maximum !== null) {
            $schema['maximum'] = $this->maximum;
        }
        if ($this->exclusiveMaximum !== null) {
            $schema['exclusiveMaximum'] = $this->exclusiveMaximum;
        }
        if ($this->minimum !== null) {
            $schema['minimum'] = $this->minimum;
        }
        if ($this->exclusiveMinimum !== null) {
            $schema['exclusiveMinimum'] = $this->exclusiveMinimum;
        }

        return $schema;
    }
}



================================================
FILE: src/Schema/ObjectSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class ObjectSchema implements Schema
{
    use NullableSchema;

    /**
     * @param  array<int, Schema>  $properties
     * @param  array<int, string>  $requiredFields
     */
    public function __construct(
        public readonly string $name,
        public readonly string $description,
        public readonly array $properties,
        public readonly array $requiredFields = [],
        public readonly bool $allowAdditionalProperties = false,
        public readonly bool $nullable = false,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        return [
            'description' => $this->description,
            'type' => $this->nullable
                ? $this->castToNullable('object')
                : 'object',
            'properties' => $this->propertiesArray(),
            'required' => $this->requiredFields,
            'additionalProperties' => $this->allowAdditionalProperties,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function propertiesArray(): array
    {
        return collect($this->properties)
            ->keyBy(fn (Schema $parameter): string => $parameter->name())
            ->map(fn (Schema $parameter): array => $parameter->toArray())
            ->toArray();
    }
}



================================================
FILE: src/Schema/StringSchema.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Schema;

use Prism\Prism\Concerns\NullableSchema;
use Prism\Prism\Contracts\Schema;

class StringSchema implements Schema
{
    use NullableSchema;

    public function __construct(
        public readonly string $name,
        public readonly string $description,
        public readonly bool $nullable = false,
        public readonly ?string $pattern = null,
        public readonly ?string $format = null,
    ) {}

    #[\Override]
    public function name(): string
    {
        return $this->name;
    }

    #[\Override]
    public function toArray(): array
    {
        $schema = [
            'description' => $this->description,
            'type' => $this->nullable
                ? $this->castToNullable('string')
                : 'string',
        ];

        if ($this->pattern !== null) {
            $schema['pattern'] = $this->pattern;
        }
        if ($this->format !== null) {
            $schema['format'] = $this->format;
        }

        return $schema;
    }
}



================================================
FILE: src/Streaming/EventID.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming;

use Illuminate\Support\Str;

class EventID
{
    public static function generate(string $prefix = 'evt'): string
    {
        return $prefix.'_'.Str::ulid();
    }
}



================================================
FILE: src/Streaming/StreamCollector.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming;

use Closure;
use Generator;
use Illuminate\Support\Collection;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

class StreamCollector
{
    /**
     * @param  null|Closure(PendingRequest|null, Collection<int,Message>):void  $onCompleteCallback
     */
    public function __construct(
        protected Generator $stream,
        protected ?\Prism\Prism\Text\PendingRequest $pendingRequest = null,
        protected ?Closure $onCompleteCallback = null
    ) {}

    /**
     * @return Generator<\Prism\Prism\Streaming\Events\StreamEvent>
     */
    public function collect(): Generator
    {
        $accumulatedText = '';
        /** @var ToolCall[] $toolCalls */
        $toolCalls = [];
        /** @var ToolResult[] $toolResults */
        $toolResults = [];
        /** @var Message[] $messages */
        $messages = [];

        foreach ($this->stream as $event) {
            yield $event;

            if ($event instanceof TextStartEvent) {
                $this->handleTextStart($accumulatedText, $toolCalls, $toolResults, $messages);
            } elseif ($event instanceof TextDeltaEvent) {
                $accumulatedText .= $event->delta;
            } elseif ($event instanceof ToolCallEvent) {
                $toolCalls[] = $event->toolCall;
            } elseif ($event instanceof ToolResultEvent) {
                $toolResults[] = $event->toolResult;
            } elseif ($event instanceof StreamEndEvent) {
                $this->handleStreamEnd($accumulatedText, $toolCalls, $toolResults, $messages);
            }
        }
    }

    /**
     * @param  ToolCall[]  $toolCalls
     * @param  ToolResult[]  $toolResults
     * @param  Message[]  $messages
     */
    protected function handleTextStart(
        string &$accumulatedText,
        array &$toolCalls,
        array &$toolResults,
        array &$messages
    ): void {
        $this->finalizeCurrentMessage($accumulatedText, $toolCalls, $toolResults, $messages);
    }

    /**
     * @param  ToolCall[]  $toolCalls
     * @param  ToolResult[]  $toolResults
     * @param  Message[]  $messages
     */
    protected function handleStreamEnd(
        string &$accumulatedText,
        array &$toolCalls,
        array &$toolResults,
        array &$messages
    ): void {
        $this->finalizeCurrentMessage($accumulatedText, $toolCalls, $toolResults, $messages);

        if ($this->onCompleteCallback instanceof Closure) {
            ($this->onCompleteCallback)($this->pendingRequest, collect($messages));
        }
    }

    /**
     * @param  ToolCall[]  $toolCalls
     * @param  ToolResult[]  $toolResults
     * @param  Message[]  $messages
     */
    protected function finalizeCurrentMessage(
        string &$accumulatedText,
        array &$toolCalls,
        array &$toolResults,
        array &$messages
    ): void {
        if ($accumulatedText !== '' || $toolCalls !== []) {
            $messages[] = new AssistantMessage($accumulatedText, $toolCalls);
            $accumulatedText = '';
            $toolCalls = [];
        }

        if ($toolResults !== []) {
            $messages[] = new ToolResultMessage($toolResults);
            $toolResults = [];
        }
    }
}



================================================
FILE: src/Streaming/StreamState.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Usage;

class StreamState
{
    protected string $messageId = '';

    protected string $reasoningId = '';

    protected bool $streamStarted = false;

    protected bool $textStarted = false;

    protected bool $thinkingStarted = false;

    protected string $currentText = '';

    protected string $currentThinking = '';

    protected ?int $currentBlockIndex = null;

    protected ?string $currentBlockType = null;

    /** @var array<int, array<string, mixed>> */
    protected array $toolCalls = [];

    /** @var array<MessagePartWithCitations> */
    protected array $citations = [];

    protected ?Usage $usage = null;

    protected ?FinishReason $finishReason = null;

    protected string $model = '';

    protected string $provider = '';

    /** @var array<string, mixed>|null */
    protected ?array $metadata = null;

    public function withMessageId(string $messageId): self
    {
        $this->messageId = $messageId;

        return $this;
    }

    public function withReasoningId(string $reasoningId): self
    {
        $this->reasoningId = $reasoningId;

        return $this;
    }

    public function withModel(string $model): self
    {
        $this->model = $model;

        return $this;
    }

    public function withProvider(string $provider): self
    {
        $this->provider = $provider;

        return $this;
    }

    /**
     * @param  array<string, mixed>|null  $metadata
     */
    public function withMetadata(?array $metadata): self
    {
        $this->metadata = $metadata;

        return $this;
    }

    public function markStreamStarted(): self
    {
        $this->streamStarted = true;

        return $this;
    }

    public function markTextStarted(): self
    {
        $this->textStarted = true;

        return $this;
    }

    public function markThinkingStarted(): self
    {
        $this->thinkingStarted = true;

        return $this;
    }

    public function appendText(string $text): self
    {
        $this->currentText .= $text;

        return $this;
    }

    public function appendThinking(string $thinking): self
    {
        $this->currentThinking .= $thinking;

        return $this;
    }

    public function withText(string $text): self
    {
        $this->currentText = $text;

        return $this;
    }

    public function withThinking(string $thinking): self
    {
        $this->currentThinking = $thinking;

        return $this;
    }

    public function withBlockContext(int $index, string $type): self
    {
        $this->currentBlockIndex = $index;
        $this->currentBlockType = $type;

        return $this;
    }

    public function resetBlockContext(): self
    {
        $this->currentBlockIndex = null;
        $this->currentBlockType = null;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $toolCall
     */
    public function addToolCall(int $index, array $toolCall): self
    {
        $this->toolCalls[$index] = $toolCall;

        return $this;
    }

    public function appendToolCallInput(int $index, string $input): self
    {
        if (! isset($this->toolCalls[$index])) {
            $this->toolCalls[$index] = ['input' => ''];
        }

        $this->toolCalls[$index]['input'] .= $input;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $data
     */
    public function updateToolCall(int $index, array $data): self
    {
        $this->toolCalls[$index] = array_merge(
            $this->toolCalls[$index] ?? [],
            $data
        );

        return $this;
    }

    public function addCitation(MessagePartWithCitations $citation): self
    {
        $this->citations[] = $citation;

        return $this;
    }

    public function withUsage(Usage $usage): self
    {
        $this->usage = $usage;

        return $this;
    }

    public function withFinishReason(FinishReason $finishReason): self
    {
        $this->finishReason = $finishReason;

        return $this;
    }

    public function messageId(): string
    {
        return $this->messageId;
    }

    public function reasoningId(): string
    {
        return $this->reasoningId;
    }

    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->provider;
    }

    /**
     * @return array<string, mixed>|null
     */
    public function metadata(): ?array
    {
        return $this->metadata;
    }

    public function hasStreamStarted(): bool
    {
        return $this->streamStarted;
    }

    public function hasTextStarted(): bool
    {
        return $this->textStarted;
    }

    public function hasThinkingStarted(): bool
    {
        return $this->thinkingStarted;
    }

    public function currentText(): string
    {
        return $this->currentText;
    }

    public function currentThinking(): string
    {
        return $this->currentThinking;
    }

    public function currentBlockIndex(): ?int
    {
        return $this->currentBlockIndex;
    }

    public function currentBlockType(): ?string
    {
        return $this->currentBlockType;
    }

    /**
     * @return array<int, array<string, mixed>>
     */
    public function toolCalls(): array
    {
        return $this->toolCalls;
    }

    public function hasToolCalls(): bool
    {
        return $this->toolCalls !== [];
    }

    /**
     * @return array<MessagePartWithCitations>
     */
    public function citations(): array
    {
        return $this->citations;
    }

    public function usage(): ?Usage
    {
        return $this->usage;
    }

    public function finishReason(): ?FinishReason
    {
        return $this->finishReason;
    }

    public function shouldEmitStreamStart(): bool
    {
        return ! $this->streamStarted;
    }

    public function shouldEmitTextStart(): bool
    {
        return ! $this->textStarted;
    }

    public function shouldEmitThinkingStart(): bool
    {
        return ! $this->thinkingStarted;
    }

    public function reset(): self
    {
        $this->messageId = '';
        $this->reasoningId = '';
        $this->streamStarted = false;
        $this->textStarted = false;
        $this->thinkingStarted = false;
        $this->currentText = '';
        $this->currentThinking = '';
        $this->currentBlockIndex = null;
        $this->currentBlockType = null;
        $this->toolCalls = [];
        $this->citations = [];
        $this->usage = null;
        $this->finishReason = null;
        $this->model = '';
        $this->provider = '';
        $this->metadata = null;

        return $this;
    }

    public function resetTextState(): self
    {
        $this->messageId = '';
        $this->textStarted = false;
        $this->thinkingStarted = false;
        $this->currentText = '';
        $this->currentThinking = '';

        return $this;
    }

    public function resetBlock(): self
    {
        $this->currentBlockIndex = null;
        $this->currentBlockType = null;

        return $this;
    }
}



================================================
FILE: src/Streaming/Adapters/BroadcastAdapter.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Adapters;

use Generator;
use Illuminate\Broadcasting\Channel;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;
use InvalidArgumentException;
use Prism\Prism\Events\Broadcasting\ErrorBroadcast;
use Prism\Prism\Events\Broadcasting\StreamEndBroadcast;
use Prism\Prism\Events\Broadcasting\StreamStartBroadcast;
use Prism\Prism\Events\Broadcasting\TextCompleteBroadcast;
use Prism\Prism\Events\Broadcasting\TextDeltaBroadcast;
use Prism\Prism\Events\Broadcasting\TextStartBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingCompleteBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingStartBroadcast;
use Prism\Prism\Events\Broadcasting\ToolCallBroadcast;
use Prism\Prism\Events\Broadcasting\ToolResultBroadcast;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;

class BroadcastAdapter
{
    /**
     * @param  Channel|Channel[]  $channels
     */
    public function __construct(
        protected Channel|array $channels
    ) {}

    public function __invoke(Generator $events): void
    {
        foreach ($events as $event) {
            event($this->broadcastEvent($event));
        }
    }

    protected function broadcastEvent(StreamEvent $event): ShouldBroadcast
    {
        return match ($event::class) {
            StreamStartEvent::class => new StreamStartBroadcast($event, $this->channels),
            TextStartEvent::class => new TextStartBroadcast($event, $this->channels),
            TextDeltaEvent::class => new TextDeltaBroadcast($event, $this->channels),
            TextCompleteEvent::class => new TextCompleteBroadcast($event, $this->channels),
            ThinkingStartEvent::class => new ThinkingStartBroadcast($event, $this->channels),
            ThinkingEvent::class => new ThinkingBroadcast($event, $this->channels),
            ThinkingCompleteEvent::class => new ThinkingCompleteBroadcast($event, $this->channels),
            ToolCallEvent::class => new ToolCallBroadcast($event, $this->channels),
            ToolResultEvent::class => new ToolResultBroadcast($event, $this->channels),
            ErrorEvent::class => new ErrorBroadcast($event, $this->channels),
            StreamEndEvent::class => new StreamEndBroadcast($event, $this->channels),
            default => throw new InvalidArgumentException('Unsupported event type for broadcasting: '.$event::class),
        };
    }
}



================================================
FILE: src/Streaming/Adapters/DataProtocolAdapter.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Adapters;

use Generator;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\Usage;
use RuntimeException;
use Symfony\Component\HttpFoundation\StreamedResponse;

class DataProtocolAdapter
{
    public function __invoke(Generator $events): StreamedResponse
    {
        return response()->stream(function () use ($events): void {
            foreach ($events as $event) {
                if (connection_aborted() !== 0) {
                    break;
                }

                $data = $this->handleEventConversion($event);

                echo "data: {$data}\n\n";

                ob_flush();
                flush();
            }

            echo "data: [DONE]\n\n";
        }, 200, [
            'Content-Type' => 'text/plain; charset=utf-8',
            'Cache-Control' => 'no-cache, no-transform',
            'X-Accel-Buffering' => 'no',
            'x-vercel-ai-ui-message-stream' => 'v1',
        ]);
    }

    protected function handleEventConversion(StreamEvent $event): string
    {
        $data = match ($event::class) {
            StreamStartEvent::class => $this->handleStreamStart($event),
            TextStartEvent::class => $this->handleTextStart($event),
            TextDeltaEvent::class => $this->handleTextDelta($event),
            TextCompleteEvent::class => $this->handleTextComplete($event),
            ThinkingStartEvent::class => $this->handleThinkingStart($event),
            ThinkingEvent::class => $this->handleThinkingDelta($event),
            ThinkingCompleteEvent::class => $this->handleThinkingComplete($event),
            ToolCallEvent::class => $this->handleToolCall($event),
            ToolResultEvent::class => $this->handleToolResult($event),
            StreamEndEvent::class => $this->handleStreamEnd($event),
            ErrorEvent::class => $this->handleError($event),
            default => $this->handleDefault($event),
        };

        $encoded = json_encode($data);
        if ($encoded === false) {
            throw new RuntimeException('Failed to encode event data as JSON');
        }

        return $encoded;
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleStreamStart(StreamStartEvent $event): array
    {
        return [
            'type' => 'start',
            'messageId' => $event->id,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleTextStart(TextStartEvent $event): array
    {
        return [
            'type' => 'text-start',
            'id' => $event->messageId,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleTextDelta(TextDeltaEvent $event): array
    {
        return [
            'type' => 'text-delta',
            'id' => $event->messageId,
            'delta' => $event->delta,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleTextComplete(TextCompleteEvent $event): array
    {
        return [
            'type' => 'text-end',
            'id' => $event->messageId,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleThinkingStart(ThinkingStartEvent $event): array
    {
        return [
            'type' => 'reasoning-start',
            'id' => $event->reasoningId,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleThinkingDelta(ThinkingEvent $event): array
    {
        return [
            'type' => 'reasoning-delta',
            'id' => $event->reasoningId,
            'delta' => $event->delta,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleThinkingComplete(ThinkingCompleteEvent $event): array
    {
        return [
            'type' => 'reasoning-end',
            'id' => $event->reasoningId,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleToolCall(ToolCallEvent $event): array
    {
        return [
            'type' => 'tool-input-available',
            'toolCallId' => $event->toolCall->id,
            'toolName' => $event->toolCall->name,
            'input' => $event->toolCall->arguments(),
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleToolResult(ToolResultEvent $event): array
    {
        return [
            'type' => 'tool-output-available',
            'toolCallId' => $event->toolResult->toolCallId,
            'output' => $event->toolResult->result,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleStreamEnd(StreamEndEvent $event): array
    {
        $messageMetadata = [
            'finishReason' => $event->finishReason->value,
        ];

        if ($event->usage instanceof Usage) {
            $messageMetadata['usage'] = [
                'promptTokens' => $event->usage->promptTokens,
                'completionTokens' => $event->usage->completionTokens,
            ];
        }

        return [
            'type' => 'finish',
            'messageMetadata' => $messageMetadata,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleError(ErrorEvent $event): array
    {
        return [
            'type' => 'error',
            'errorText' => $event->message,
        ];
    }

    /**
     * @return array<string, mixed>
     */
    protected function handleDefault(StreamEvent $event): array
    {
        return [
            'type' => 'data-'.$event->type()->value,
            'data' => $event->toArray(),
        ];
    }
}



================================================
FILE: src/Streaming/Adapters/SSEAdapter.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Adapters;

use Generator;
use Symfony\Component\HttpFoundation\StreamedResponse;

class SSEAdapter
{
    public function __invoke(Generator $events): StreamedResponse
    {
        return response()->stream(function () use ($events): void {
            foreach ($events as $event) {
                if (connection_aborted() !== 0) {
                    break;
                }

                echo vsprintf("event: %s\ndata: %s\n\n", [
                    $event->type()->value,
                    json_encode($event->toArray()),
                ]);

                ob_flush();
                flush();
            }
        }, 200, [
            'Content-Type' => 'text/event-stream',
            'Cache-Control' => 'no-cache',
            'X-Accel-Buffering' => 'no',
            'Connection' => 'keep-alive',
        ]);
    }
}



================================================
FILE: src/Streaming/Events/CitationEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\ValueObjects\Citation;

readonly class CitationEvent extends StreamEvent
{
    /**
     * @param  array<string, mixed>|null  $metadata
     */
    public function __construct(
        string $id,
        int $timestamp,
        public Citation $citation,           // The citation object
        public string $messageId,            // Message this citation belongs to
        public ?int $blockIndex = null,      // Content block index for this citation
        public ?array $metadata = null       // Additional citation metadata
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::Citation;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'citation' => [
                'source_type' => $this->citation->sourceType->value,
                'source' => $this->citation->source,
                'source_text' => $this->citation->sourceText,
                'source_title' => $this->citation->sourceTitle,
                'source_position_type' => $this->citation->sourcePositionType?->value,
                'source_start_index' => $this->citation->sourceStartIndex,
                'source_end_index' => $this->citation->sourceEndIndex,
                'additional_content' => $this->citation->additionalContent,
            ],
            'message_id' => $this->messageId,
            'block_index' => $this->blockIndex,
            'metadata' => $this->metadata,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ErrorEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class ErrorEvent extends StreamEvent
{
    /**
     * @param  array<string, mixed>|null  $metadata
     */
    public function __construct(
        string $id,
        int $timestamp,
        public string $errorType,       // Type of error (rate_limit, validation, etc.)
        public string $message,         // Error message
        public bool $recoverable,       // Whether stream can continue
        public ?array $metadata = null, // Additional error context
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::Error;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'error_type' => $this->errorType,
            'message' => $this->message,
            'recoverable' => $this->recoverable,
            'metadata' => $this->metadata,
        ];
    }
}



================================================
FILE: src/Streaming/Events/StreamEndEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Usage;

readonly class StreamEndEvent extends StreamEvent
{
    /**
     * @param  array<MessagePartWithCitations>|null  $citations
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        string $id,
        int $timestamp,
        public FinishReason $finishReason,  // Why stream ended
        public ?Usage $usage = null,        // Token usage information
        public ?array $citations = null,    // Citations collected during stream
        public array $additionalContent = []
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::StreamEnd;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            ...$this->additionalContent,
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'finish_reason' => $this->finishReason->name,
            'usage' => $this->usage instanceof Usage ? [
                'prompt_tokens' => $this->usage->promptTokens,
                'completion_tokens' => $this->usage->completionTokens,
                'cache_write_input_tokens' => $this->usage->cacheWriteInputTokens,
                'cache_read_input_tokens' => $this->usage->cacheReadInputTokens,
                'thought_tokens' => $this->usage->thoughtTokens,
            ] : null,
            'citations' => $this->citations !== null ? array_map(
                fn (MessagePartWithCitations $citationPart): array => [
                    'output_text' => $citationPart->outputText,
                    'citations' => array_map(
                        fn (Citation $citation): array => [
                            'source_type' => $citation->sourceType->value,
                            'source' => $citation->source,
                            'source_text' => $citation->sourceText,
                            'source_title' => $citation->sourceTitle,
                            'source_position_type' => $citation->sourcePositionType?->value,
                            'source_start_index' => $citation->sourceStartIndex,
                            'source_end_index' => $citation->sourceEndIndex,
                            'additional_content' => $citation->additionalContent,
                        ],
                        $citationPart->citations
                    ),
                ],
                $this->citations
            ) : null,
        ];
    }
}



================================================
FILE: src/Streaming/Events/StreamEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

abstract readonly class StreamEvent
{
    public function __construct(
        public string $id,           // Unique event ID for tracking
        public int $timestamp,       // Unix timestamp when event created
    ) {}

    abstract public function type(): StreamEventType;

    /**
     * @return array<string, mixed>
     */
    abstract public function toArray(): array;
}



================================================
FILE: src/Streaming/Events/StreamStartEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class StreamStartEvent extends StreamEvent
{
    /**
     * @param  array<string, mixed>|null  $metadata
     */
    public function __construct(
        string $id,
        int $timestamp,
        public string $model,           // AI model being used
        public string $provider,        // Provider name (anthropic, openai, etc.)
        public ?array $metadata = null  // Additional provider-specific metadata
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::StreamStart;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'model' => $this->model,
            'provider' => $this->provider,
            'metadata' => $this->metadata,
        ];
    }
}



================================================
FILE: src/Streaming/Events/TextCompleteEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class TextCompleteEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public string $messageId,
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::TextComplete;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'message_id' => $this->messageId,
        ];
    }
}



================================================
FILE: src/Streaming/Events/TextDeltaEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class TextDeltaEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public string $delta,
        public string $messageId,
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::TextDelta;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'delta' => $this->delta,
            'message_id' => $this->messageId,
        ];
    }
}



================================================
FILE: src/Streaming/Events/TextStartEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class TextStartEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public string $messageId,
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::TextStart;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'message_id' => $this->messageId,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ThinkingCompleteEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class ThinkingCompleteEvent extends StreamEvent
{
    /**
     * @param  array<string, mixed>|null  $summary
     */
    public function __construct(
        string $id,
        int $timestamp,
        public string $reasoningId,     // Unique reasoning session ID
        public ?array $summary = null,  // Optional reasoning summary
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::ThinkingComplete;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'reasoning_id' => $this->reasoningId,
            'summary' => $this->summary,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ThinkingEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class ThinkingEvent extends StreamEvent
{
    /**
     * @param  array<string, mixed>|null  $summary
     */
    public function __construct(
        string $id,
        int $timestamp,
        public string $delta,           // Thinking/reasoning chunk
        public string $reasoningId,     // Unique reasoning session ID
        public ?array $summary = null,  // Reasoning summary if available
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::ThinkingDelta;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'delta' => $this->delta,
            'reasoning_id' => $this->reasoningId,
            'summary' => $this->summary,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ThinkingStartEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;

readonly class ThinkingStartEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public string $reasoningId,     // Unique reasoning session ID
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::ThinkingStart;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'reasoning_id' => $this->reasoningId,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ToolCallEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\ValueObjects\ToolCall;

readonly class ToolCallEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public ToolCall $toolCall,      // Tool call value object
        public string $messageId,       // Message this tool call belongs to
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::ToolCall;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'tool_id' => $this->toolCall->id,
            'tool_name' => $this->toolCall->name,
            'arguments' => $this->toolCall->arguments(),
            'message_id' => $this->messageId,
            'reasoning_id' => $this->toolCall->reasoningId,
        ];
    }
}



================================================
FILE: src/Streaming/Events/ToolResultEvent.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Streaming\Events;

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\ValueObjects\ToolResult;

readonly class ToolResultEvent extends StreamEvent
{
    public function __construct(
        string $id,
        int $timestamp,
        public ToolResult $toolResult,   // Tool result value object
        public string $messageId,        // Message this belongs to
        public bool $success = true,     // Whether tool execution succeeded
        public ?string $error = null,    // Error message if failed
    ) {
        parent::__construct($id, $timestamp);
    }

    public function type(): StreamEventType
    {
        return StreamEventType::ToolResult;
    }

    /**
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'id' => $this->id,
            'timestamp' => $this->timestamp,
            'tool_id' => $this->toolResult->toolCallId,
            'result' => $this->toolResult->result,
            'message_id' => $this->messageId,
            'success' => $this->success,
            'error' => $this->error,
        ];
    }
}



================================================
FILE: src/Structured/PendingRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Structured;

use Illuminate\Http\Client\RequestException;
use Prism\Prism\Concerns\ConfiguresClient;
use Prism\Prism\Concerns\ConfiguresModels;
use Prism\Prism\Concerns\ConfiguresProviders;
use Prism\Prism\Concerns\ConfiguresStructuredOutput;
use Prism\Prism\Concerns\HasMessages;
use Prism\Prism\Concerns\HasPrompts;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Concerns\HasSchema;
use Prism\Prism\Contracts\Schema;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\ValueObjects\Messages\UserMessage;

class PendingRequest
{
    use ConfiguresClient;
    use ConfiguresModels;
    use ConfiguresProviders;
    use ConfiguresStructuredOutput;
    use HasMessages;
    use HasPrompts;
    use HasProviderOptions;
    use HasSchema;

    /**
     * @deprecated Use `asStructured` instead.
     */
    public function generate(): Response
    {
        return $this->asStructured();
    }

    public function asStructured(): Response
    {
        $request = $this->toRequest();

        try {
            return $this->provider->structured($request);
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    public function toRequest(): Request
    {
        if ($this->messages && $this->prompt) {
            throw PrismException::promptOrMessages();
        }

        $messages = $this->messages;

        if ($this->prompt) {
            $messages[] = new UserMessage($this->prompt, $this->additionalContent);
        }

        if (! $this->schema instanceof Schema) {
            throw new PrismException('A schema is required for structured output');
        }

        return new Request(
            systemPrompts: $this->systemPrompts,
            model: $this->model,
            providerKey: $this->providerKey(),
            prompt: $this->prompt,
            messages: $messages,
            maxTokens: $this->maxTokens,
            temperature: $this->temperature,
            topP: $this->topP,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            schema: $this->schema,
            mode: $this->structuredMode,
            providerOptions: $this->providerOptions,
        );
    }
}



================================================
FILE: src/Structured/Request.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Structured;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\Contracts\Schema;
use Prism\Prism\Enums\StructuredMode;
use Prism\Prism\ValueObjects\Messages\SystemMessage;

class Request implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  SystemMessage[]  $systemPrompts
     * @param  array<int, Message>  $messages
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     */
    public function __construct(
        protected array $systemPrompts,
        protected string $model,
        protected string $providerKey,
        protected ?string $prompt,
        protected array $messages,
        protected ?int $maxTokens,
        protected int|float|null $temperature,
        protected int|float|null $topP,
        protected array $clientOptions,
        protected array $clientRetry,
        protected Schema $schema,
        protected StructuredMode $mode,
        array $providerOptions = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    /**
     * @return SystemMessage[]
     */
    public function systemPrompts(): array
    {
        return $this->systemPrompts;
    }

    #[\Override]
    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }

    public function prompt(): ?string
    {
        return $this->prompt;
    }

    /**
     * @return array<int, Message>
     */
    public function messages(): array
    {
        return $this->messages;
    }

    public function maxTokens(): ?int
    {
        return $this->maxTokens;
    }

    public function temperature(): int|float|null
    {
        return $this->temperature;
    }

    public function topP(): int|float|null
    {
        return $this->topP;
    }

    /**
     * @return array<string, mixed>
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    public function schema(): Schema
    {
        return $this->schema;
    }

    public function mode(): StructuredMode
    {
        return $this->mode;
    }

    public function addMessage(Message $message): self
    {
        $this->messages = array_merge($this->messages, [$message]);

        return $this;
    }
}



================================================
FILE: src/Structured/Response.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Structured;

use Illuminate\Support\Collection;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

readonly class Response
{
    /**
     * @param  Collection<int, Step>  $steps
     * @param  array<mixed>  $structured
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        public Collection $steps,
        public string $text,
        public ?array $structured,
        public FinishReason $finishReason,
        public Usage $usage,
        public Meta $meta,
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/Structured/ResponseBuilder.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Structured;

use Illuminate\Support\Collection;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismStructuredDecodingException;
use Prism\Prism\ValueObjects\Usage;

readonly class ResponseBuilder
{
    /** @var Collection<int, Step> */
    public Collection $steps;

    public function __construct()
    {
        $this->steps = new Collection;
    }

    public function addStep(Step $step): self
    {
        $this->steps->push($step);

        return $this;
    }

    public function toResponse(): Response
    {
        /** @var Step $finalStep */
        $finalStep = $this->steps->last();

        return new Response(
            steps: $this->steps,
            text: $finalStep->text,
            structured: $finalStep->structured === [] && $finalStep->finishReason === FinishReason::Stop
                ? $this->decodeObject($finalStep->text)
                : $finalStep->structured,
            finishReason: $finalStep->finishReason,
            usage: $this->calculateTotalUsage(),
            meta: $finalStep->meta,
            additionalContent: $finalStep->additionalContent,
        );
    }

    /**
     * @return array<mixed>
     */
    protected function decodeObject(string $responseText): array
    {
        try {
            $pattern = '/^```(?:json)?\s*\n?(.*?)\n?```$/s';

            if (preg_match($pattern, trim($responseText), $matches)) {
                $responseText = trim($matches[1]);
            }

            return json_decode($responseText, true, flags: JSON_THROW_ON_ERROR);
        } catch (\JsonException) {
            throw PrismStructuredDecodingException::make($responseText);
        }
    }

    protected function calculateTotalUsage(): Usage
    {
        return new Usage(
            promptTokens: $this
                ->steps
                ->sum(fn (Step $result): int => $result->usage->promptTokens),
            completionTokens: $this
                ->steps
                ->sum(fn (Step $result): int => $result->usage->completionTokens),
            cacheWriteInputTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->cacheWriteInputTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->cacheWriteInputTokens ?? 0)
                : null,
            cacheReadInputTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->cacheReadInputTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->cacheReadInputTokens ?? 0)
                : null,
            thoughtTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->thoughtTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->thoughtTokens ?? 0)
                : null,
        );
    }
}



================================================
FILE: src/Structured/Step.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Structured;

use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

readonly class Step
{
    /**
     * @param  Message[]  $messages
     * @param  SystemMessage[]  $systemPrompts
     * @param  array<string,mixed>  $additionalContent
     * @param  array<string,mixed>  $structured
     */
    public function __construct(
        public string $text,
        public FinishReason $finishReason,
        public Usage $usage,
        public Meta $meta,
        public array $messages,
        public array $systemPrompts,
        public array $additionalContent = [],
        public array $structured = []
    ) {}
}



================================================
FILE: src/Testing/EmbeddingsResponseFake.php
================================================
<?php

namespace Prism\Prism\Testing;

use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;

/**
 * @method self withEmbeddings(Embedding[] $embeddings)
 * @method self withUsage(EmbeddingsUsage $usage)
 * @method self withMeta(Meta $meta)
 */
readonly class EmbeddingsResponseFake extends EmbeddingResponse
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            embeddings: [],
            usage: new EmbeddingsUsage(10),
            meta: new Meta('fake-id', 'fake-model'),
        );
    }
}



================================================
FILE: src/Testing/ImageResponseFake.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Testing;

use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Images\Response;
use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

/**
 * @method self withImages(GeneratedImage[] $images)
 * @method self withUsage(Usage $usage)
 * @method self withMeta(Meta $meta)
 * @method self withAdditionalContent(array<string,mixed> $additionalContent)
 */
readonly class ImageResponseFake extends Response
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            images: [
                new GeneratedImage(
                    url: 'https://example.com/fake-image.png',
                    revisedPrompt: null,
                ),
            ],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            additionalContent: [],
        );
    }
}



================================================
FILE: src/Testing/PrismFake.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Testing;

use Closure;
use Exception;
use Generator;
use PHPUnit\Framework\Assert as PHPUnit;
use Prism\Prism\Audio\AudioResponse;
use Prism\Prism\Audio\SpeechToTextRequest;
use Prism\Prism\Audio\TextResponse as AudioTextResponse;
use Prism\Prism\Audio\TextToSpeechRequest;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Images\Request as ImageRequest;
use Prism\Prism\Images\Response as ImageResponse;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Testing\Concerns\CanGenerateFakeChunksFromTextResponses;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\GeneratedAudio;
use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

class PrismFake extends Provider
{
    use CanGenerateFakeChunksFromTextResponses;

    protected int $responseSequence = 0;

    /** @var array<int, StructuredRequest|TextRequest|EmbeddingRequest|ImageRequest|TextToSpeechRequest|SpeechToTextRequest> */
    protected array $recorded = [];

    /** @var array<string, mixed> */
    protected array $providerConfig = [];

    /**
     * @param  array<int, TextResponse|StructuredResponse|EmbeddingResponse|ImageResponse|AudioResponse|AudioTextResponse>  $responses
     */
    public function __construct(protected array $responses = []) {}

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $this->recorded[] = $request;

        return $this->nextTextResponse() ?? new TextResponse(
            steps: collect([]),
            text: '',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            messages: collect([]),
            additionalContent: [],
        );
    }

    #[\Override]
    public function embeddings(EmbeddingRequest $request): EmbeddingResponse
    {
        $this->recorded[] = $request;

        return $this->nextEmbeddingResponse() ?? new EmbeddingResponse(
            embeddings: [],
            usage: new EmbeddingsUsage(10),
            meta: new Meta('fake-id', 'fake-model'),
        );
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $this->recorded[] = $request;

        return $this->nextStructuredResponse() ?? new StructuredResponse(
            steps: collect([]),
            text: '',
            structured: [],
            finishReason: FinishReason::Stop,
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            additionalContent: [],
        );
    }

    #[\Override]
    public function images(ImageRequest $request): ImageResponse
    {
        $this->recorded[] = $request;

        return $this->nextImageResponse() ?? new ImageResponse(
            images: [
                new GeneratedImage(
                    url: 'https://example.com/fake-image.png',
                    revisedPrompt: null,
                ),
            ],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            additionalContent: [],
        );
    }

    #[\Override]
    public function textToSpeech(TextToSpeechRequest $request): AudioResponse
    {
        $this->recorded[] = $request;

        return $this->nextAudioResponse() ?? new AudioResponse(
            audio: new GeneratedAudio(
                base64: 'ZmFrZS1hdWRpby1jb250ZW50',
                type: 'audio/mpeg'
            ),
            additionalContent: [],
        );
    }

    #[\Override]
    public function speechToText(SpeechToTextRequest $request): AudioTextResponse
    {
        $this->recorded[] = $request;

        return $this->nextAudioTextResponse() ?? new AudioTextResponse(
            text: 'fake transcribed text',
            usage: new Usage(0, 0),
            additionalContent: [],
        );
    }

    /**
     * Fake implementation of the streaming endpoint.
     *
     * Behavior:
     *  1. Records the incoming {@link TextRequest}
     *  2. Pulls the next fixture from the list supplied to {@see \Prism\Prism\Prism::fake()}.
     *  3. Yields an appropriate stream of events.
     *
     * Supported fixture type:
     *  • {@link TextResponse} – auto-chunked into stream events.
     *
     * @return Generator<StreamEvent>
     *
     * @throws Exception if the fixture type is unknown or no fixture remains.
     */
    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        $this->recorded[] = $request;

        $fixture = $this->nextTextResponse() ?? new TextResponse(
            steps: collect([]),
            text: '',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            messages: collect([]),
            additionalContent: [],
        );

        yield from $this->streamEventsFromTextResponse($fixture, $request);
    }

    /**
     * @param  array<string, mixed>  $config
     */
    public function setProviderConfig(array $config): void
    {
        $this->providerConfig = $config;
    }

    /**
     * @param  Closure(array<int, StructuredRequest|TextRequest|EmbeddingRequest|ImageRequest|TextToSpeechRequest|SpeechToTextRequest>):void  $fn
     */
    public function assertRequest(Closure $fn): void
    {
        $fn($this->recorded);
    }

    public function assertPrompt(string $prompt): void
    {
        $prompts = collect($this->recorded)
            ->flatten()
            ->map(fn ($response) => $response->prompt());

        PHPUnit::assertTrue(
            $prompts->contains($prompt),
            "Could not find the prompt {$prompt} in the recorded requests"
        );
    }

    /**
     * @param  array<string, mixed>  $providerConfig
     */
    public function assertProviderConfig(array $providerConfig): void
    {
        PHPUnit::assertEqualsCanonicalizing(
            $providerConfig,
            $this->providerConfig
        );
    }

    /**
     * Assert number of calls made
     */
    public function assertCallCount(int $expectedCount): void
    {
        $actualCount = count($this->recorded ?? []);

        PHPUnit::assertSame($expectedCount, $actualCount, "Expected {$expectedCount} calls, got {$actualCount}");
    }

    /**
     * @return Generator<StreamEvent>
     */
    protected function streamEventsFromTextResponse(TextResponse $response, TextRequest $request): Generator
    {
        $messageId = EventID::generate();

        yield new StreamStartEvent(
            id: EventID::generate(),
            timestamp: time(),
            model: $request->model(),
            provider: 'fake'
        );

        if ($response->steps->isNotEmpty()) {
            foreach ($response->steps as $step) {
                if ($step->text !== '') {
                    yield new TextStartEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $messageId
                    );

                    foreach ($this->convertStringToTextChunkGenerator($step->text, $this->fakeChunkSize) as $chunk) {
                        yield new TextDeltaEvent(
                            id: EventID::generate(),
                            timestamp: time(),
                            delta: $chunk->text,
                            messageId: $messageId
                        );
                    }

                    yield new TextCompleteEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        messageId: $messageId
                    );
                }

                foreach ($step->toolCalls as $toolCall) {
                    yield new ToolCallEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        toolCall: $toolCall,
                        messageId: $messageId
                    );
                }

                foreach ($step->toolResults as $toolResult) {
                    yield new ToolResultEvent(
                        id: EventID::generate(),
                        timestamp: time(),
                        toolResult: $toolResult,
                        messageId: $messageId,
                        success: true
                    );
                }
            }
        } elseif ($response->text !== '') {
            yield new TextStartEvent(
                id: EventID::generate(),
                timestamp: time(),
                messageId: $messageId
            );
            foreach ($this->convertStringToTextChunkGenerator($response->text, $this->fakeChunkSize) as $chunk) {
                yield new TextDeltaEvent(
                    id: EventID::generate(),
                    timestamp: time(),
                    delta: $chunk->text,
                    messageId: $messageId
                );
            }
            yield new TextCompleteEvent(
                id: EventID::generate(),
                timestamp: time(),
                messageId: $messageId
            );
        }

        yield new StreamEndEvent(
            id: EventID::generate(),
            timestamp: time(),
            finishReason: $response->finishReason,
            usage: $response->usage
        );
    }

    protected function nextTextResponse(): ?TextResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var array<int, TextResponse> $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }

    protected function nextStructuredResponse(): ?StructuredResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var array<int, StructuredResponse> $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }

    protected function nextEmbeddingResponse(): ?EmbeddingResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var EmbeddingResponse[] $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }

    protected function nextImageResponse(): ?ImageResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var array<int, ImageResponse> $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }

    protected function nextAudioResponse(): ?AudioResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var array<int, AudioResponse> $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }

    protected function nextAudioTextResponse(): ?AudioTextResponse
    {
        if ($this->responses === []) {
            return null;
        }

        /** @var array<int, AudioTextResponse> $responses */
        $responses = $this->responses;
        $sequence = $this->responseSequence;

        if (! isset($responses[$sequence])) {
            throw new Exception('Could not find a response for the request');
        }

        $this->responseSequence++;

        return $responses[$sequence];
    }
}



================================================
FILE: src/Testing/StructuredResponseFake.php
================================================
<?php

namespace Prism\Prism\Testing;

use Illuminate\Support\Collection;
use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

/**
 * @method self withSteps(Collection<int, Step> $steps)
 * @method self withText(string $text)
 * @method self withStructured(array<mixed> $structured)
 * @method self withFinishReason(FinishReason $finishReason)
 * @method self withUsage(Usage $usage)
 * @method self withMeta(Meta $meta)
 * @method self withAdditionalContent(array<string,mixed> $additionalContent)
 */
readonly class StructuredResponseFake extends \Prism\Prism\Structured\Response
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            steps: collect([]),
            text: '',
            structured: [],
            finishReason: FinishReason::Stop,
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            additionalContent: [],
        );
    }
}



================================================
FILE: src/Testing/StructuredStepFake.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Testing;

use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

/**
 * @method self withText(string $text)
 * @method self withFinishReason(FinishReason $finishReason)
 * @method self withUsage(Usage $usage)
 * @method self withMeta(Meta $meta)
 * @method self withMessages(Message[] $messages)
 * @method self withSystemPrompts(SystemMessage[] $systemPrompts)
 * @method self withAdditionalContent(array<string,mixed> $additionalContent)
 */
readonly class StructuredStepFake extends Step
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            text: '',
            finishReason: FinishReason::Stop,
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            messages: [],
            systemPrompts: [],
            additionalContent: [],
        );
    }
}



================================================
FILE: src/Testing/TextResponseFake.php
================================================
<?php

namespace Prism\Prism\Testing;

use Illuminate\Support\Collection;
use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Text\Response;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

/**
 * @method self withSteps(Collection<int, Step> $steps)
 * @method self withText(string $text)
 * @method self withFinishReason(FinishReason $finishReason)
 * @method self withToolCalls(ToolCall[] $toolCalls)
 * @method self withToolResults(ToolResult[] $toolResults)
 * @method self withUsage(Usage $usage)
 * @method self withMeta(Meta $meta)
 * @method self withMessages(Collection<int, Message> $messages)
 * @method self withAdditionalContent(array<string,mixed> $additionalContent)
 */
readonly class TextResponseFake extends Response
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            steps: collect([]),
            text: '',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            messages: collect([]),
            additionalContent: [],
        );
    }
}



================================================
FILE: src/Testing/TextStepFake.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Testing;

use Prism\Prism\Concerns\HasFluentAttributes;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

/**
 * @method self withText(string $text)
 * @method self withFinishReason(FinishReason $finishReason)
 * @method self withToolCalls(ToolCall[] $toolCalls)
 * @method self withToolResults(ToolResult[] $toolResults)
 * @method self withUsage(Usage $usage)
 * @method self withMeta(Meta $meta)
 * @method self withMessages(Message[] $messages)
 * @method self withSystemPrompts(SystemMessage[] $systemPrompts)
 * @method self withAdditionalContent(array<string,mixed> $additionalContent)
 */
readonly class TextStepFake extends Step
{
    use HasFluentAttributes;

    public static function make(): self
    {
        return new self(
            text: '',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(0, 0),
            meta: new Meta('fake', 'fake'),
            messages: [],
            systemPrompts: [],
            additionalContent: [],
        );
    }
}



================================================
FILE: src/Testing/Concerns/CanGenerateFakeChunksFromTextResponses.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Testing\Concerns;

use Generator;

trait CanGenerateFakeChunksFromTextResponses
{
    /** Default string length used when chunking strings for the fake stream. */
    protected int $fakeChunkSize = 5;

    /** Override the default chunk size used when generating fake chunks. */
    public function withFakeChunkSize(int $chunkSize): self
    {
        $this->fakeChunkSize = max(1, $chunkSize);

        return $this;
    }

    /**
     * @return Generator<object{text: string}>
     */
    protected function convertStringToTextChunkGenerator(string $text, int $chunkSize): Generator
    {
        $length = strlen($text);

        for ($offset = 0; $offset < $length; $offset += $chunkSize) {
            $chunk = mb_substr($text, $offset, $chunkSize);

            if ($chunk === '') {
                continue;
            }

            yield (object) ['text' => $chunk];
        }
    }
}



================================================
FILE: src/Text/PendingRequest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Text;

use Closure;
use Generator;
use Illuminate\Broadcasting\Channel;
use Illuminate\Http\Client\RequestException;
use Illuminate\Support\Collection;
use Prism\Prism\Concerns\ConfiguresClient;
use Prism\Prism\Concerns\ConfiguresGeneration;
use Prism\Prism\Concerns\ConfiguresModels;
use Prism\Prism\Concerns\ConfiguresProviders;
use Prism\Prism\Concerns\ConfiguresTools;
use Prism\Prism\Concerns\HasMessages;
use Prism\Prism\Concerns\HasPrompts;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Concerns\HasProviderTools;
use Prism\Prism\Concerns\HasTools;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Streaming\Adapters\BroadcastAdapter;
use Prism\Prism\Streaming\Adapters\DataProtocolAdapter;
use Prism\Prism\Streaming\Adapters\SSEAdapter;
use Prism\Prism\Streaming\StreamCollector;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Symfony\Component\HttpFoundation\StreamedResponse;

class PendingRequest
{
    use ConfiguresClient;
    use ConfiguresGeneration;
    use ConfiguresModels;
    use ConfiguresProviders;
    use ConfiguresTools;
    use HasMessages;
    use HasPrompts;
    use HasProviderOptions;
    use HasProviderTools;
    use HasTools;

    protected ?Closure $completeCallback = null;

    /**
     * @deprecated Use `asText` instead.
     */
    public function generate(): Response
    {
        return $this->asText();
    }

    public function asText(): Response
    {
        $request = $this->toRequest();

        try {
            $response = $this->provider->text($request);

            if ($this->completeCallback instanceof Closure) {
                ($this->completeCallback)($this, $response->messages);
            }

            return $response;
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    /**
     * @param  callable(PendingRequest|null, Collection<int, Message>): void  $callback
     */
    public function onComplete(callable $callback): self
    {
        $this->completeCallback = $callback instanceof Closure ? $callback : Closure::fromCallable($callback);

        return $this;
    }

    /**
     * @return Generator<\Prism\Prism\Streaming\Events\StreamEvent>
     */
    public function asStream(): Generator
    {
        $request = $this->toRequest();

        try {
            $chunks = $this->provider->stream($request);

            if ($this->completeCallback instanceof Closure) {
                $collector = new StreamCollector($chunks, $this, $this->completeCallback);

                yield from $collector->collect();
            } else {
                foreach ($chunks as $chunk) {
                    yield $chunk;
                }
            }
        } catch (RequestException $e) {
            $this->provider->handleRequestException($request->model(), $e);
        }
    }

    public function asDataStreamResponse(): StreamedResponse
    {
        return (new DataProtocolAdapter)($this->asStream());
    }

    public function asEventStreamResponse(): StreamedResponse
    {
        return (new SSEAdapter)($this->asStream());
    }

    /**
     * @param  Channel|Channel[]  $channels
     */
    public function asBroadcast(Channel|array $channels): void
    {
        (new BroadcastAdapter($channels))($this->asStream());
    }

    public function toRequest(): Request
    {
        if ($this->messages && $this->prompt) {
            throw PrismException::promptOrMessages();
        }

        $messages = $this->messages;

        if ($this->prompt) {
            $messages[] = new UserMessage($this->prompt, $this->additionalContent);
        }

        $tools = $this->tools;

        if (! $this->toolErrorHandlingEnabled && filled($tools)) {
            $tools = array_map(
                callback: fn (Tool $tool): Tool => is_null($tool->failedHandler()) ? $tool : $tool->withoutErrorHandling(),
                array: $tools
            );
        }

        return new Request(
            model: $this->model,
            providerKey: $this->providerKey(),
            systemPrompts: $this->systemPrompts,
            prompt: $this->prompt,
            messages: $messages,
            maxSteps: $this->maxSteps,
            maxTokens: $this->maxTokens,
            temperature: $this->temperature,
            topP: $this->topP,
            tools: $tools,
            clientOptions: $this->clientOptions,
            clientRetry: $this->clientRetry,
            toolChoice: $this->toolChoice,
            providerOptions: $this->providerOptions,
            providerTools: $this->providerTools,
        );
    }
}



================================================
FILE: src/Text/Request.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Text;

use Closure;
use Prism\Prism\Concerns\ChecksSelf;
use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Contracts\PrismRequest;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\ProviderTool;

class Request implements PrismRequest
{
    use ChecksSelf, HasProviderOptions;

    /**
     * @param  SystemMessage[]  $systemPrompts
     * @param  array<int, Message>  $messages
     * @param  array<int, Tool>  $tools
     * @param  array<string, mixed>  $clientOptions
     * @param  array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool}  $clientRetry
     * @param  array<string, mixed>  $providerOptions
     * @param  array<int, ProviderTool>  $providerTools
     */
    public function __construct(
        protected string $model,
        protected string $providerKey,
        protected array $systemPrompts,
        protected ?string $prompt,
        protected array $messages,
        protected int $maxSteps,
        protected ?int $maxTokens,
        protected int|float|null $temperature,
        protected int|float|null $topP,
        protected array $tools,
        protected array $clientOptions,
        protected array $clientRetry,
        protected string|ToolChoice|null $toolChoice,
        array $providerOptions = [],
        protected array $providerTools = [],
    ) {
        $this->providerOptions = $providerOptions;
    }

    public function toolChoice(): string|ToolChoice|null
    {
        return $this->toolChoice;
    }

    /**
     * @return array{0: array<int, int>|int, 1?: Closure|int, 2?: ?callable, 3?: bool} $clientRetry
     */
    public function clientRetry(): array
    {
        return $this->clientRetry;
    }

    /**
     * @return array<string, mixed> $clientOptions
     */
    public function clientOptions(): array
    {
        return $this->clientOptions;
    }

    /**
     * @return Tool[]
     */
    public function tools(): array
    {
        return $this->tools;
    }

    public function topP(): int|float|null
    {
        return $this->topP;
    }

    /**
     * @return array<int,ProviderTool>
     */
    public function providerTools(): array
    {
        return $this->providerTools;
    }

    public function temperature(): int|float|null
    {
        return $this->temperature;
    }

    public function maxTokens(): ?int
    {
        return $this->maxTokens;
    }

    public function maxSteps(): int
    {
        return $this->maxSteps;
    }

    /**
     * @return Message[]
     */
    public function messages(): array
    {
        return $this->messages;
    }

    public function prompt(): ?string
    {
        return $this->prompt;
    }

    /**
     * @return SystemMessage[]
     */
    public function systemPrompts(): array
    {
        return $this->systemPrompts;
    }

    #[\Override]
    public function model(): string
    {
        return $this->model;
    }

    public function provider(): string
    {
        return $this->providerKey;
    }

    public function addMessage(Message $message): self
    {
        $this->messages = array_merge($this->messages, [$message]);

        return $this;
    }
}



================================================
FILE: src/Text/Response.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Text;

use Illuminate\Support\Collection;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

readonly class Response
{
    /**
     * @param  Collection<int, Step>  $steps
     * @param  ToolCall[]  $toolCalls
     * @param  ToolResult[]  $toolResults
     * @param  Collection<int, Message>  $messages
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        public Collection $steps,
        public string $text,
        public FinishReason $finishReason,
        public array $toolCalls,
        public array $toolResults,
        public Usage $usage,
        public Meta $meta,
        public Collection $messages,
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/Text/ResponseBuilder.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Text;

use Illuminate\Support\Collection;
use Prism\Prism\ValueObjects\Usage;

readonly class ResponseBuilder
{
    /** @var Collection<int, Step> */
    public Collection $steps;

    public function __construct()
    {
        $this->steps = new Collection;
    }

    public function addStep(Step $step): self
    {
        $this->steps->push($step);

        return $this;
    }

    public function toResponse(): Response
    {
        /** @var Step $finalStep */
        $finalStep = $this->steps->last();

        return new Response(
            steps: $this->steps,
            text: $finalStep->text,
            finishReason: $finalStep->finishReason,
            toolCalls: $finalStep->toolCalls,
            toolResults: $finalStep->toolResults,
            usage: $this->calculateTotalUsage(),
            meta: $finalStep->meta,
            messages: collect($finalStep->messages),
            additionalContent: $finalStep->additionalContent,
        );
    }

    protected function calculateTotalUsage(): Usage
    {
        return new Usage(
            promptTokens: $this
                ->steps
                ->sum(fn (Step $result): int => $result->usage->promptTokens),
            completionTokens: $this
                ->steps
                ->sum(fn (Step $result): int => $result->usage->completionTokens),
            cacheWriteInputTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->cacheWriteInputTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->cacheWriteInputTokens ?? 0)
                : null,
            cacheReadInputTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->cacheReadInputTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->cacheReadInputTokens ?? 0)
                : null,
            thoughtTokens: $this->steps->contains(fn (Step $result): bool => $result->usage->thoughtTokens !== null)
                ? $this->steps->sum(fn (Step $result): int => $result->usage->thoughtTokens ?? 0)
                : null,
        );
    }
}



================================================
FILE: src/Text/Step.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\Text;

use Prism\Prism\Contracts\Message;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

readonly class Step
{
    /**
     * @param  ToolCall[]  $toolCalls
     * @param  ToolResult[]  $toolResults
     * @param  Message[]  $messages
     * @param  SystemMessage[]  $systemPrompts
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        public string $text,
        public FinishReason $finishReason,
        public array $toolCalls,
        public array $toolResults,
        public Usage $usage,
        public Meta $meta,
        public array $messages,
        public array $systemPrompts,
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/ValueObjects/Citation.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

use Prism\Prism\Enums\Citations\CitationSourcePositionType;
use Prism\Prism\Enums\Citations\CitationSourceType;

class Citation
{
    public function __construct(
        public CitationSourceType $sourceType,
        /** String if sourceType is Url, otherwise integer. */
        public string|int $source,
        /** The text from the source material relied upon */
        public ?string $sourceText = null,
        /** The title of the source material */
        public ?string $sourceTitle = null,
        /** Identifies what the $sourceStartIndex and $sourceEndIndex relate to (pages, chars, etc.) */
        public ?CitationSourcePositionType $sourcePositionType = null,
        public ?int $sourceStartIndex = null,
        public ?int $sourceEndIndex = null,
        /** @var array<string,mixed> */
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/ValueObjects/Embedding.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

class Embedding
{
    /**
     * @param  array<int, int|string|float>  $embedding
     */
    public function __construct(
        public array $embedding
    ) {}

    /**
     * @param  array<int, int|string|float>  $embedding
     */
    public static function fromArray(array $embedding): self
    {
        return new self(embedding: $embedding);
    }
}



================================================
FILE: src/ValueObjects/EmbeddingsUsage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

readonly class EmbeddingsUsage
{
    public function __construct(
        public ?int $tokens
    ) {}
}



================================================
FILE: src/ValueObjects/GeneratedAudio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

class GeneratedAudio extends Media\Media
{
    public function __construct(?string $base64 = null, public ?string $type = null)
    {
        parent::__construct(null, $base64, $type);
    }
}



================================================
FILE: src/ValueObjects/GeneratedImage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

class GeneratedImage extends Media\Media
{
    public function __construct(
        ?string $url = null,
        ?string $base64 = null,
        public ?string $revisedPrompt = null,
        ?string $mimeType = null
    ) {
        parent::__construct($url, $base64, $mimeType);
    }

    public function hasRevisedPrompt(): bool
    {
        return $this->revisedPrompt !== null;
    }
}



================================================
FILE: src/ValueObjects/MessagePartWithCitations.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

class MessagePartWithCitations
{
    public function __construct(
        public string $outputText,
        /**
         * @var array<Citation>
         */
        public array $citations = [],
        /**
         * Provider specific content.
         *
         * @var array<string,mixed>
         */
        public array $additionalContent = []
    ) {}
}



================================================
FILE: src/ValueObjects/Meta.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

readonly class Meta
{
    /**
     * @param  ProviderRateLimit[]  $rateLimits
     */
    public function __construct(
        public string $id,
        public string $model,
        public array $rateLimits = [],
    ) {}
}



================================================
FILE: src/ValueObjects/ProviderRateLimit.php
================================================
<?php

namespace Prism\Prism\ValueObjects;

use Carbon\Carbon;

class ProviderRateLimit
{
    public function __construct(
        public readonly string $name,
        public readonly ?int $limit = null,
        public readonly ?int $remaining = null,
        public readonly ?Carbon $resetsAt = null
    ) {}
}



================================================
FILE: src/ValueObjects/ProviderTool.php
================================================
<?php

namespace Prism\Prism\ValueObjects;

class ProviderTool
{
    /**
     * @param  array<string,mixed>  $options
     */
    public function __construct(
        public readonly string $type,
        public readonly ?string $name = null,
        public readonly array $options = [],
    ) {}
}



================================================
FILE: src/ValueObjects/ToolCall.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

class ToolCall
{
    /**
     * @param  string|array<string, mixed>  $arguments
     * @param  null|array<string, mixed>  $reasoningSummary
     */
    public function __construct(
        public readonly string $id,
        public readonly string $name,
        protected string|array $arguments,
        public readonly ?string $resultId = null,
        public readonly ?string $reasoningId = null,
        public readonly ?array $reasoningSummary = null,
    ) {}

    /**
     * @return array<string, mixed>
     */
    public function arguments(): array
    {
        if (is_string($this->arguments)) {
            if ($this->arguments === '' || $this->arguments === '0') {
                return [];
            }

            $arguments = $this->arguments;

            return json_decode(
                $arguments,
                true,
                flags: JSON_THROW_ON_ERROR
            );
        }

        /** @var array<string, mixed> $arguments */
        $arguments = $this->arguments;

        return $arguments;
    }
}



================================================
FILE: src/ValueObjects/ToolResult.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

readonly class ToolResult
{
    /**
     * @param  array<string, mixed>  $args
     * @param  array<string, mixed>  $result
     */
    public function __construct(
        public string $toolCallId,
        public string $toolName,
        public array $args,
        public int|float|string|array|null $result,
        public ?string $toolCallResultId = null,
    ) {}
}



================================================
FILE: src/ValueObjects/Usage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects;

readonly class Usage
{
    public function __construct(
        public int $promptTokens,
        public int $completionTokens,
        public ?int $cacheWriteInputTokens = null,
        public ?int $cacheReadInputTokens = null,
        public ?int $thoughtTokens = null,
    ) {}
}



================================================
FILE: src/ValueObjects/Media/Audio.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Media;

class Audio extends Media {}



================================================
FILE: src/ValueObjects/Media/Document.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Media;

/**
 * Note: Prism currently only supports Documents with Anthropic.
 */
class Document extends Media
{
    protected ?string $documentTitle = null;

    /**
     * @var null|array<string>
     */
    protected ?array $chunks = null;

    public static function fromFileId(string $fileId, ?string $title = null): static
    {
        return parent::fromFileId($fileId)->setDocumentTitle($title);
    }

    /**
     * @deprecated Use `fromLocalPath()` instead.
     */
    public static function fromPath(string $path, ?string $title = null): static
    {
        return self::fromLocalPath($path, $title);
    }

    public static function fromLocalPath(string $path, ?string $title = null): static
    {
        return parent::fromLocalPath($path)->setDocumentTitle($title);
    }

    public static function fromStoragePath(string $path, ?string $diskName = null, ?string $title = null): static
    {
        return parent::fromStoragePath($path, $diskName)->setDocumentTitle($title);
    }

    public static function fromUrl(string $url, ?string $title = null): static
    {
        return parent::fromUrl($url)->setDocumentTitle($title);
    }

    public static function fromRawContent(string $rawContent, ?string $mimeType = null, ?string $title = null): static
    {
        return parent::fromRawContent($rawContent, $mimeType)->setDocumentTitle($title);
    }

    public static function fromBase64(string $document, ?string $mimeType = null, ?string $title = null): static
    {
        return parent::fromBase64($document, $mimeType)->setDocumentTitle($title);
    }

    public static function fromText(string $text, ?string $title = null): static
    {
        return self::fromRawContent($text, 'text/plain', $title);
    }

    /**
     * @param  array<string>  $chunks
     */
    public static function fromChunks(array $chunks, ?string $title = null): self
    {
        $document = new self;
        $document->chunks = $chunks;
        $document->documentTitle = $title;

        return $document;
    }

    public function isChunks(): bool
    {
        return $this->chunks !== null;
    }

    public function setDocumentTitle(?string $title): static
    {
        $this->documentTitle = $title;

        return $this;
    }

    public function documentTitle(): ?string
    {
        return $this->documentTitle;
    }

    /**
     * @return null|array<mixed>
     */
    public function chunks(): ?array
    {
        return $this->chunks;
    }
}



================================================
FILE: src/ValueObjects/Media/Image.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Media;

class Image extends Media {}



================================================
FILE: src/ValueObjects/Media/Media.php
================================================
<?php

namespace Prism\Prism\ValueObjects\Media;

use finfo;
use Illuminate\Filesystem\FilesystemAdapter;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Storage;
use InvalidArgumentException;
use Prism\Prism\Concerns\HasProviderOptions;

class Media
{
    use HasProviderOptions;

    protected ?string $fileId = null;

    protected ?string $localPath = null;

    protected ?string $storagePath = null;

    protected ?string $rawContent = null;

    protected ?string $filename = null;

    public function __construct(
        public ?string $url = null,
        public ?string $base64 = null,
        public ?string $mimeType = null) {}

    public static function fromFileId(string $fileId): static
    {
        /** @phpstan-ignore-next-line */
        $instance = new static;
        $instance->fileId = $fileId;

        return $instance;
    }

    /**
     * @deprecated Use `fromLocalPath()` instead.
     */
    public static function fromPath(string $path): static
    {
        return self::fromLocalPath($path);
    }

    public static function fromLocalPath(string $path, ?string $mimeType = null): static
    {
        if (! is_file($path)) {
            throw new InvalidArgumentException("$path is not a file");
        }

        $content = file_get_contents($path) ?: '';

        if ($content === '' || $content === '0') {
            throw new InvalidArgumentException("$path is empty");
        }

        if (! $mimeType && ! ($mimeType = File::mimeType($path))) {
            throw new InvalidArgumentException("Could not determine mime type for {$path}");
        }

        /** @phpstan-ignore-next-line */
        $instance = new static;

        $instance->localPath = $path;
        $instance->rawContent = $content;
        $instance->mimeType = $mimeType;

        return $instance;
    }

    public static function fromStoragePath(string $path, ?string $diskName = null): static
    {
        /** @var FilesystemAdapter */
        $disk = Storage::disk($diskName);

        $diskName ??= 'default';

        if (! $disk->exists($path)) {
            throw new InvalidArgumentException("$path does not exist on the '$diskName' disk");
        }

        $content = $disk->get($path);

        if (! $content) {
            throw new InvalidArgumentException("$path on the '$diskName' disk is empty.");
        }

        $mimeType = $disk->mimeType($path);

        if (! $mimeType) {
            throw new InvalidArgumentException("Could not determine mime type for {$path} on the '$diskName' disk");
        }

        /** @phpstan-ignore-next-line */
        $instance = new static;

        $instance->storagePath = $path;
        $instance->rawContent = $content;
        $instance->mimeType = $mimeType;

        return $instance;
    }

    public static function fromUrl(string $url, ?string $mimeType = null): static
    {
        /** @phpstan-ignore-next-line */
        $instance = new static;

        $instance->url = $url;
        $instance->mimeType = $mimeType;

        return $instance;
    }

    public static function fromRawContent(string $rawContent, ?string $mimeType = null): static
    {
        /** @phpstan-ignore-next-line */
        $instance = new static;

        $instance->rawContent = $rawContent;
        $instance->mimeType = $mimeType;

        return $instance;
    }

    public static function fromBase64(string $base64, ?string $mimeType = null): static
    {
        /** @phpstan-ignore-next-line */
        $instance = new static;

        $instance->base64 = $base64;
        $instance->mimeType = $mimeType;

        return $instance;
    }

    public function as(string $name): self
    {
        $this->filename = $name;

        return $this;
    }

    public function filename(): ?string
    {
        return $this->filename;
    }

    public function isFileId(): bool
    {
        return $this->fileId !== null;
    }

    public function isFile(): bool
    {
        return $this->localPath !== null || $this->storagePath !== null;
    }

    public function isUrl(): bool
    {
        return $this->url !== null;
    }

    public function hasBase64(): bool
    {
        return $this->hasRawContent();
    }

    public function hasMimeType(): bool
    {
        return $this->mimeType !== null;
    }

    public function hasRawContent(): bool
    {
        if ($this->base64 !== null) {
            return true;
        }
        if ($this->rawContent !== null) {
            return true;
        }
        if ($this->isFile()) {
            return true;
        }

        return $this->isUrl();
    }

    public function hasUrl(): bool
    {
        return $this->url !== null;
    }

    public function fileId(): ?string
    {
        return $this->fileId;
    }

    public function localPath(): ?string
    {
        return $this->localPath;
    }

    public function storagePath(): ?string
    {
        return $this->storagePath;
    }

    public function url(): ?string
    {
        return $this->url;
    }

    public function rawContent(): ?string
    {
        if ($this->rawContent) {
            return $this->rawContent;
        }
        if ($this->localPath) {
            $this->rawContent = file_get_contents($this->localPath) ?: null;
        } elseif ($this->storagePath) {
            $this->rawContent = Storage::get($this->storagePath);
        } elseif ($this->isUrl()) {
            $this->fetchUrlContent();
        } elseif ($this->hasBase64()) {
            $this->rawContent = base64_decode((string) $this->base64);
        }

        return $this->rawContent;
    }

    public function base64(): ?string
    {
        if ($this->base64) {
            return $this->base64;
        }

        return $this->base64 = base64_encode((string) $this->rawContent());
    }

    public function mimeType(): ?string
    {
        if ($this->mimeType) {
            return $this->mimeType;
        }

        if ($content = $this->rawContent()) {
            $this->mimeType = (new finfo(FILEINFO_MIME_TYPE))->buffer($content) ?: null;
        }

        return $this->mimeType;
    }

    /**
     * Get a file resource suitable for HTTP multipart uploads
     *
     * @return resource
     */
    public function resource()
    {
        if ($this->localPath) {
            $resource = fopen($this->localPath, 'r');
            if ($resource === false) {
                throw new InvalidArgumentException("Cannot open file: {$this->localPath}");
            }

            return $resource;
        }

        if ($this->url) {
            $this->fetchUrlContent();

            return $this->createStreamFromContent($this->rawContent());
        }

        if ($this->rawContent || $this->base64) {
            return $this->createStreamFromContent($this->rawContent());
        }

        throw new InvalidArgumentException('Cannot create resource from media');
    }

    public function fetchUrlContent(): void
    {
        if (! $this->url) {
            return;
        }

        $content = Http::get($this->url)->body();

        if (! $content) {
            throw new InvalidArgumentException("{$this->url} returns no content.");
        }

        $mimeType = (new finfo(FILEINFO_MIME_TYPE))->buffer($content);

        if (! $mimeType) {
            throw new InvalidArgumentException("Could not determine mime type for {$this->url}.");
        }

        $this->rawContent = $content;
    }

    /**
     * @return resource
     */
    protected function createStreamFromContent(?string $content)
    {
        if ($content === null) {
            throw new InvalidArgumentException('Cannot create stream from null content');
        }

        $stream = fopen('php://memory', 'r+');
        if ($stream === false) {
            throw new InvalidArgumentException('Cannot create memory stream');
        }

        fwrite($stream, $content);
        rewind($stream);

        return $stream;
    }
}



================================================
FILE: src/ValueObjects/Media/Text.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Media;

readonly class Text
{
    public function __construct(public string $text) {}
}



================================================
FILE: src/ValueObjects/Media/Video.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Media;

class Video extends Media {}



================================================
FILE: src/ValueObjects/Messages/AssistantMessage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Messages;

use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\ToolCall;

class AssistantMessage implements Message
{
    use HasProviderOptions;

    /**
     * @param  ToolCall[]  $toolCalls
     * @param  array<string,mixed>  $additionalContent
     */
    public function __construct(
        public readonly string $content,
        public readonly array $toolCalls = [],
        public readonly array $additionalContent = []
    ) {}
}



================================================
FILE: src/ValueObjects/Messages/SystemMessage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Messages;

use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;

class SystemMessage implements Message
{
    use HasProviderOptions;

    public function __construct(
        public readonly string $content
    ) {}
}



================================================
FILE: src/ValueObjects/Messages/ToolResultMessage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Messages;

use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\ToolResult;

class ToolResultMessage implements Message
{
    use HasProviderOptions;

    /**
     * @param  ToolResult[]  $toolResults
     */
    public function __construct(
        public readonly array $toolResults
    ) {}
}



================================================
FILE: src/ValueObjects/Messages/UserMessage.php
================================================
<?php

declare(strict_types=1);

namespace Prism\Prism\ValueObjects\Messages;

use Prism\Prism\Concerns\HasProviderOptions;
use Prism\Prism\Contracts\Message;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Media;
use Prism\Prism\ValueObjects\Media\Text;
use Prism\Prism\ValueObjects\Media\Video;

class UserMessage implements Message
{
    use HasProviderOptions;

    /**
     * @param  array<int, Text|Image|Document|Media>  $additionalContent
     * @param  array<string, mixed>  $additionalAttributes
     */
    public function __construct(
        public readonly string $content,
        public array $additionalContent = [],
        public readonly array $additionalAttributes = [],
    ) {
        $this->additionalContent[] = new Text($content);
    }

    public function text(): string
    {
        $result = '';

        foreach ($this->additionalContent as $content) {
            if ($content instanceof Text) {
                $result .= $content->text;
            }
        }

        return $result;
    }

    /**
     * @return Image[]
     */
    public function images(): array
    {
        return collect($this->additionalContent)
            ->where(fn ($part): bool => $part instanceof Image)
            ->toArray();
    }

    /**
     * @return array<int, Audio|Video|Media>
     */
    public function media(): array
    {
        return collect($this->additionalContent)
            ->filter(fn ($part): bool => $part instanceof Audio || $part instanceof Video || $part instanceof Media)
            ->toArray();
    }

    /**
     * Note: Prism currently only supports Documents with Anthropic.
     *
     * @return Document[]
     */
    public function documents(): array
    {
        return collect($this->additionalContent)
            ->where(fn ($part): bool => $part instanceof Document)
            ->toArray();
    }

    /**
     * @return Audio[]
     */
    public function audios(): array
    {
        return collect($this->additionalContent)
            ->where(fn ($part): bool => $part instanceof Audio)
            ->toArray();
    }

    /**
     * @return Video[]
     */
    public function videos(): array
    {
        return collect($this->additionalContent)
            ->where(fn ($part): bool => $part instanceof Video)
            ->toArray();
    }
}



================================================
FILE: tests/ArchTest.php
================================================
<?php

describe('Arch presets', function (): void {
    arch('Security preset')->preset()->security();
    arch('PHP preset')->preset()->php();
    arch('Laravel preset')->preset()->laravel();
});

describe('Custom relaxed preset', function (): void {
    arch('No final classes')
        ->expect('Prism\Prism')
        ->classes()
        ->not
        ->toBeFinal();

    arch('No private methods')
        ->expect('Prism\Prism')
        ->classes()
        ->not
        ->toHavePrivateMethods();
});



================================================
FILE: tests/HelpersTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Prism;

it('can resolve prism from the container with helper function', function (): void {
    expect(prism())->toBeInstanceOf(Prism::class);
});



================================================
FILE: tests/Pest.php
================================================
<?php

/*
|--------------------------------------------------------------------------
| Test Case
|--------------------------------------------------------------------------
|
| The closure you provide to your test functions is always bound to a specific PHPUnit test
| case class. By default, that class is "PHPUnit\Framework\TestCase". Of course, you may
| need to change it using the "uses()" function to bind a different classes or traits.
|
*/

uses(Tests\TestCase::class)->in(__DIR__);
uses()->group('providers')->in('Providers');
uses()->group('anthropic')->in('Providers/Anthropic');
uses()->group('deepseek')->in('Providers/DeepSeek');
uses()->group('gemini')->in('Providers/Gemini');
uses()->group('groq')->in('Providers/Groq');
uses()->group('mistral')->in('Providers/Mistral');
uses()->group('ollama')->in('Providers/Ollama');
uses()->group('openai')->in('Providers/OpenAI');
uses()->group('xai')->in('Providers/XAI');

/*
|--------------------------------------------------------------------------
| Expectations
|--------------------------------------------------------------------------
|
| When you're writing tests, you often need to check that values meet certain conditions. The
| "expect()" function gives you access to a set of "expectations" methods that you can use
| to assert different things. Of course, you may extend the Expectation API at any time.
|
*/



================================================
FILE: tests/PrismManagerTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests;

use Illuminate\Contracts\Foundation\Application;
use Mockery;
use Prism\Prism\Enums\Provider;
use Prism\Prism\PrismManager;
use Prism\Prism\Providers\Anthropic\Anthropic;
use Prism\Prism\Providers\DeepSeek\DeepSeek;
use Prism\Prism\Providers\Gemini\Gemini;
use Prism\Prism\Providers\Mistral\Mistral;
use Prism\Prism\Providers\Ollama\Ollama;
use Prism\Prism\Providers\OpenAI\OpenAI;
use Prism\Prism\Providers\OpenRouter\OpenRouter;
use Prism\Prism\Providers\Provider as ContractsProvider;
use Prism\Prism\Providers\XAI\XAI;

it('can resolve Anthropic', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::Anthropic))->toBeInstanceOf(Anthropic::class);
    expect($manager->resolve('anthropic'))->toBeInstanceOf(Anthropic::class);
});

it('can resolve Ollama', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::Ollama))->toBeInstanceOf(Ollama::class);
    expect($manager->resolve('ollama'))->toBeInstanceOf(Ollama::class);
});

it('can resolve OpenAI', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::OpenAI))->toBeInstanceOf(OpenAI::class);
    expect($manager->resolve('openai'))->toBeInstanceOf(OpenAI::class);
});

it('can resolve Mistral', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::Mistral))->toBeInstanceOf(Mistral::class);
    expect($manager->resolve('mistral'))->toBeInstanceOf(Mistral::class);
});

it('can resolve XAI', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::XAI))->toBeInstanceOf(XAI::class);
    expect($manager->resolve('xai'))->toBeInstanceOf(XAI::class);
});

it('can resolve Gemini', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::Gemini))->toBeInstanceOf(Gemini::class);
    expect($manager->resolve('gemini'))->toBeInstanceOf(Gemini::class);
});

it('can resolve DeepSeek', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::DeepSeek))->toBeInstanceOf(DeepSeek::class);
    expect($manager->resolve('deepseek'))->toBeInstanceOf(DeepSeek::class);
});

it('can resolve OpenRouter', function (): void {
    $manager = new PrismManager($this->app);

    expect($manager->resolve(Provider::OpenRouter))->toBeInstanceOf(OpenRouter::class);
    expect($manager->resolve('openrouter'))->toBeInstanceOf(OpenRouter::class);
});

it('allows for custom provider configuration', function (): void {
    $manager = new PrismManager($this->app);

    $manager->extend('test', function (Application $app, array $config) {
        expect($config)->toBe(['api_key' => '1234']);

        return Mockery::mock(ContractsProvider::class);
    });

    $manager->resolve('test', ['api_key' => '1234']);
});



================================================
FILE: tests/SchemaTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests;

use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\EnumSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

it('they can have nested properties', function (): void {
    $schema = new ObjectSchema(
        name: 'user',
        description: 'a user object',
        properties: [
            new StringSchema('name', 'the users name'),
            new NumberSchema('age', 'the users age'),
            new EnumSchema(
                name: 'status',
                description: 'the users status',
                options: [
                    'active',
                    'inactive',
                    'suspended',
                ]
            ),
            new ArraySchema(
                name: 'hobbies',
                description: 'the users hobbies',
                items: new StringSchema('hobby', 'the users hobby')
            ),
            new ObjectSchema(
                name: 'address',
                description: 'the users address',
                properties: [
                    new StringSchema('street', 'the street part of the address'),
                    new StringSchema('city', 'the city part of the address'),
                    new StringSchema('country', 'the country part of the address'),
                    new NumberSchema('zip', 'the zip code part of the address'),
                ],
                requiredFields: ['street', 'city', 'country', 'zip']
            ),
        ]
    );

    expect($schema->toArray())->toBe([
        'description' => 'a user object',
        'type' => 'object',
        'properties' => [
            'name' => [
                'description' => 'the users name',
                'type' => 'string',
            ],
            'age' => [
                'description' => 'the users age',
                'type' => 'number',
            ],
            'status' => [
                'description' => 'the users status',
                'enum' => [
                    'active',
                    'inactive',
                    'suspended',
                ],
                'type' => 'string',
            ],
            'hobbies' => [
                'description' => 'the users hobbies',
                'type' => 'array',
                'items' => [
                    'description' => 'the users hobby',
                    'type' => 'string',
                ],
            ],
            'address' => [
                'description' => 'the users address',
                'type' => 'object',
                'properties' => [
                    'street' => [
                        'description' => 'the street part of the address',
                        'type' => 'string',
                    ],
                    'city' => [
                        'description' => 'the city part of the address',
                        'type' => 'string',
                    ],
                    'country' => [
                        'description' => 'the country part of the address',
                        'type' => 'string',
                    ],
                    'zip' => [
                        'description' => 'the zip code part of the address',
                        'type' => 'number',
                    ],
                ],
                'required' => ['street', 'city', 'country', 'zip'],
                'additionalProperties' => false,
            ],
        ],
        'required' => [],
        'additionalProperties' => false,
    ]);
});

it('they can be nullable', function (): void {
    $schema = new ObjectSchema(
        name: 'user',
        description: 'a user object',
        properties: [
            new StringSchema('name', 'the users name', nullable: true),
            new NumberSchema('age', 'the users age', nullable: true),
            new EnumSchema(
                name: 'status',
                description: 'the users status',
                options: [
                    'active',
                    'inactive',
                    'suspended',
                ],
                nullable: true
            ),
            new ArraySchema(
                name: 'hobbies',
                description: 'the users hobbies',
                items: new StringSchema('hobby', 'the users hobby'),
                nullable: true
            ),
            new BooleanSchema(name: 'is_admin', description: 'is an administrative user', nullable: true),
            new ObjectSchema(
                name: 'address',
                description: 'the users address',
                properties: [
                    new StringSchema('street', 'the street part of the address'),
                    new StringSchema('city', 'the city part of the address'),
                    new StringSchema('country', 'the country part of the address'),
                    new NumberSchema('zip', 'the zip code part of the address'),
                ],
                requiredFields: ['street', 'city', 'country', 'zip']
            ),
        ],
        nullable: true
    );

    expect($schema->toArray())->toBe([
        'description' => 'a user object',
        'type' => ['object', 'null'],
        'properties' => [
            'name' => [
                'description' => 'the users name',
                'type' => ['string', 'null'],
            ],
            'age' => [
                'description' => 'the users age',
                'type' => ['number', 'null'],
            ],
            'status' => [
                'description' => 'the users status',
                'enum' => [
                    'active',
                    'inactive',
                    'suspended',
                ],
                'type' => ['string', 'null'],
            ],
            'hobbies' => [
                'description' => 'the users hobbies',
                'type' => ['array', 'null'],
                'items' => [
                    'description' => 'the users hobby',
                    'type' => 'string',
                ],
            ],
            'is_admin' => [
                'description' => 'is an administrative user',
                'type' => ['boolean', 'null'],
            ],
            'address' => [
                'description' => 'the users address',
                'type' => 'object',
                'properties' => [
                    'street' => [
                        'description' => 'the street part of the address',
                        'type' => 'string',
                    ],
                    'city' => [
                        'description' => 'the city part of the address',
                        'type' => 'string',
                    ],
                    'country' => [
                        'description' => 'the country part of the address',
                        'type' => 'string',
                    ],
                    'zip' => [
                        'description' => 'the zip code part of the address',
                        'type' => 'number',
                    ],
                ],
                'required' => ['street', 'city', 'country', 'zip'],
                'additionalProperties' => false,
            ],
        ],
        'required' => [],
        'additionalProperties' => false,
    ]);
});

it('nullable enums include types', function (): void {
    $enumSchema = new EnumSchema(
        name: 'temp',
        description: 'sick or fever temp',
        options: [98.6, 100, 'unknown', 105],
        nullable: true
    );

    expect($enumSchema->toArray())->toBe([
        'description' => 'sick or fever temp',
        'enum' => [98.6, 100, 'unknown', 105],
        'type' => [
            'number',
            'string',
            'null',
        ],
    ]);
});

it('non-nullable enum with single type returns single type', function (): void {
    $enumSchema = new EnumSchema(
        name: 'user_type',
        description: 'the type of user',
        options: ['admin', 'super_admin', 'standard']
    );

    expect($enumSchema->toArray())->toBe([
        'description' => 'the type of user',
        'enum' => ['admin', 'super_admin', 'standard'],
        'type' => 'string',
    ]);
});

it('supports anyOf composition for OpenAI schemas', function (): void {
    $userSchema = new ObjectSchema(
        name: 'user',
        description: 'The user object to insert into the database',
        properties: [
            new StringSchema('name', 'The name of the user'),
            new NumberSchema('age', 'The age of the user'),
        ],
        requiredFields: ['name', 'age'],
        allowAdditionalProperties: false
    );

    $addressSchema = new ObjectSchema(
        name: 'address',
        description: 'The address object to insert into the database',
        properties: [
            new StringSchema('number', 'The number of the address. Eg. for 123 main st, this would be 123'),
            new StringSchema('street', 'The street name. Eg. for 123 main st, this would be main st'),
            new StringSchema('city', 'The city of the address'),
        ],
        requiredFields: ['number', 'street', 'city'],
        allowAdditionalProperties: false
    );

    $itemSchema = new \Prism\Prism\Schema\AnyOfSchema([
        $userSchema,
        $addressSchema,
    ]);

    $parentSchema = new ObjectSchema(
        name: 'root',
        description: 'The root schema that can contain either a user or an address',
        properties: [
            $itemSchema,
        ],
        requiredFields: ['item'],
        allowAdditionalProperties: false
    );

    $expected = [
        'description' => 'The root schema that can contain either a user or an address',
        'type' => 'object',
        'properties' => [
            'item' => [
                'anyOf' => [
                    [
                        'description' => 'The user object to insert into the database',
                        'type' => 'object',
                        'properties' => [
                            'name' => [
                                'description' => 'The name of the user',
                                'type' => 'string',
                            ],
                            'age' => [
                                'description' => 'The age of the user',
                                'type' => 'number',
                            ],
                        ],
                        'required' => ['name', 'age'],
                        'additionalProperties' => false,
                    ],
                    [
                        'description' => 'The address object to insert into the database',
                        'type' => 'object',
                        'properties' => [
                            'number' => [
                                'description' => 'The number of the address. Eg. for 123 main st, this would be 123',
                                'type' => 'string',
                            ],
                            'street' => [
                                'description' => 'The street name. Eg. for 123 main st, this would be main st',
                                'type' => 'string',
                            ],
                            'city' => [
                                'description' => 'The city of the address',
                                'type' => 'string',
                            ],
                        ],
                        'required' => ['number', 'street', 'city'],
                        'additionalProperties' => false,
                    ],
                ],
            ],
        ],
        'required' => ['item'],
        'additionalProperties' => false,
    ];

    expect($parentSchema->toArray())->toBe($expected);
});

it('supports StringSchema format and pattern', function (): void {
    $schema = new StringSchema(
        name: 'email',
        description: 'User email',
        pattern: '^[^@\s]+@[^@\s]+\.[^@\s]+$',
        format: 'email'
    );
    $expected = [
        'description' => 'User email',
        'type' => 'string',
        'pattern' => '^[^@\s]+@[^@\s]+\.[^@\s]+$',
        'format' => 'email',
    ];

    expect($schema->toArray())->toBe($expected);
});

it('supports NumberSchema restrictions', function (): void {
    $schema = new NumberSchema(
        name: 'score',
        description: 'User score',
        multipleOf: 0.5,
        maximum: 10,
        exclusiveMaximum: 10,
        minimum: 0,
        exclusiveMinimum: 0
    );
    $expected = [
        'description' => 'User score',
        'type' => 'number',
        'multipleOf' => 0.5,
        'maximum' => 10.0,
        'exclusiveMaximum' => 10.0,
        'minimum' => 0.0,
        'exclusiveMinimum' => 0.0,
    ];
    expect($schema->toArray())->toBe($expected);
});

it('supports ArraySchema minItems and maxItems', function (): void {
    $schema = new ArraySchema(
        name: 'tags',
        description: 'User tags',
        items: new StringSchema('tag', 'A tag'),
        minItems: 1,
        maxItems: 5
    );
    $expected = [
        'description' => 'User tags',
        'type' => 'array',
        'items' => [
            'description' => 'A tag',
            'type' => 'string',
        ],
        'minItems' => 1,
        'maxItems' => 5,
    ];
    expect($schema->toArray())->toBe($expected);
});



================================================
FILE: tests/TestCase.php
================================================
<?php

declare(strict_types=1);

namespace Tests;

use Orchestra\Testbench\Concerns\WithWorkbench;
use Orchestra\Testbench\TestCase as BaseTestcase;

abstract class TestCase extends BaseTestCase
{
    use WithWorkbench;

    protected function getEnvironmentSetUp($app): void
    {
        $app['config']->set('prism.prism_server.enabled', true);
    }
}



================================================
FILE: tests/ToolErrorHandlingTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests;

use ArgumentCountError;
use DivisionByZeroError;
use InvalidArgumentException;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Tool;
use RuntimeException;
use Throwable;
use TypeError;

it('returns error message by default when invalid parameters are provided', function (): void {
    $tool = (new Tool)
        ->as('calculate')
        ->for('Perform calculation')
        ->withNumberParameter('a', 'First number')
        ->withNumberParameter('b', 'Second number')
        ->using(fn (int $a, int $b): string => (string) ($a + $b));

    $result = $tool->handle('five', 10);

    expect($result)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('Expected: [a (NumberSchema, required), b (NumberSchema, required)]')
        ->toContain('Received: {"a":"five","b":10}');
});

it('throws exception when error handler is explicitly disabled', function (): void {
    $tool = (new Tool)
        ->as('calculate')
        ->for('Perform calculation')
        ->withNumberParameter('a', 'First number')
        ->withNumberParameter('b', 'Second number')
        ->using(fn (int $a, int $b): string => (string) ($a + $b))
        ->withoutErrorHandling();

    expect(fn (): string => $tool->handle('five', 10))
        ->toThrow(PrismException::class, 'Invalid parameters for tool : calculate');
});

it('uses custom failed handler when provided', function (): void {
    $tool = (new Tool)
        ->as('calculate')
        ->for('Perform calculation')
        ->withNumberParameter('a', 'First number')
        ->withNumberParameter('b', 'Second number')
        ->using(fn (int $a, int $b): string => (string) ($a + $b))
        ->failed(fn (Throwable $e, array $params): string => 'Custom error: Parameters must be numbers');

    $result = $tool->handle('five', 10);

    expect($result)->toBe('Custom error: Parameters must be numbers');
});

it('uses default error handler with handleToolErrors()', function (): void {
    $tool = (new Tool)
        ->as('calculate')
        ->for('Perform calculation')
        ->withNumberParameter('a', 'First number')
        ->withNumberParameter('b', 'Second number')
        ->using(fn (int $a, int $b): string => (string) ($a + $b));

    $result = $tool->handle('five', 10);

    expect($result)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('Expected: [a (NumberSchema, required), b (NumberSchema, required)]')
        ->toContain('Received: {"a":"five","b":10}');
});

it('handles missing required parameters gracefully', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Search files')
        ->withStringParameter('query', 'Search query')
        ->withStringParameter('path', 'Directory path')
        ->using(fn (string $query, string $path): string => "Found results for $query in $path");

    // Missing second parameter
    $result = $tool->handle('test query');

    expect($result)
        ->toContain('Parameter validation error: Missing required parameters')
        ->toContain('Expected: [query (StringSchema, required), path (StringSchema, required)]');
});

it('handles unknown parameters gracefully', function (): void {
    $tool = (new Tool)
        ->as('simple')
        ->for('Simple tool')
        ->withStringParameter('name', 'Name')
        ->using(fn (string $name): string => "Hello $name");

    // Unknown parameter 'unknown'
    $result = $tool->handle(name: 'John', unknown: 'parameter');

    expect($result)
        ->toContain('Parameter validation error: Unknown parameters')
        ->toContain('Expected: [name (StringSchema, required)]');
});

it('handles optional parameters correctly', function (): void {
    $tool = (new Tool)
        ->as('read_file')
        ->for('Read file')
        ->withStringParameter('path', 'File path')
        ->withNumberParameter('lines', 'Number of lines', required: false)
        ->using(fn (string $path, ?int $lines = null): string => "Reading $path".($lines ? " ($lines lines)" : ''));

    // Valid call with optional parameter as wrong type
    $result = $tool->handle('/path/to/file', 'ten');

    expect($result)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('lines (NumberSchema)'); // Note: not marked as required
});

it('returns successful result when parameters are valid', function (): void {
    $tool = (new Tool)
        ->as('calculate')
        ->for('Perform calculation')
        ->withNumberParameter('a', 'First number')
        ->withNumberParameter('b', 'Second number')
        ->using(fn (int $a, int $b): string => (string) ($a + $b));

    $result = $tool->handle(5, 10);

    expect($result)->toBe('15');
});

it('allows custom error messages based on exception type', function (): void {
    $tool = (new Tool)
        ->as('api_call')
        ->for('Make API call')
        ->withStringParameter('endpoint', 'API endpoint')
        ->withArrayParameter('data', 'Request data', new StringSchema('item', 'Data item'))
        ->using(fn (string $endpoint, array $data): string => "Called $endpoint")
        ->failed(function (Throwable $e, array $params): string {
            if ($e instanceof TypeError && str_contains($e->getMessage(), 'array')) {
                return "The 'data' parameter must be an array, not a string. Example: ['item1', 'item2']";
            }
            if ($e instanceof ArgumentCountError) {
                return "Missing parameters. Both 'endpoint' and 'data' are required.";
            }

            return "API call failed: {$e->getMessage()}";
        });

    // Test with wrong type
    $result1 = $tool->handle('/api/users', 'not-an-array');
    expect($result1)->toBe("The 'data' parameter must be an array, not a string. Example: ['item1', 'item2']");

    // Test with missing parameter
    $result2 = $tool->handle('/api/users');
    expect($result2)->toBe("Missing parameters. Both 'endpoint' and 'data' are required.");
});

it('differentiates between validation errors and runtime errors', function (): void {
    $tool = (new Tool)
        ->as('file_reader')
        ->for('Read a file')
        ->withStringParameter('path', 'File path')
        ->using(function (string $path): string {
            if (! file_exists($path)) {
                throw new RuntimeException("File not found: $path");
            }

            return file_get_contents($path);
        });

    // Test validation error (wrong type)
    $result1 = $tool->handle(['not', 'a', 'string']);
    expect($result1)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('Expected: [path (StringSchema, required)]');

    // Test runtime error (file doesn't exist)
    $result2 = $tool->handle('/nonexistent/file.txt');
    expect($result2)
        ->toContain('Tool execution error: File not found: /nonexistent/file.txt')
        ->toContain('This error occurred during tool execution, not due to invalid parameters');
});

// Note: Schema validation for complex types (objects, arrays with specific item types, enums)
// is not currently implemented. The Tool class relies on PHP's type system.
// These tests demonstrate the desired behavior for future enhancement.

it('handles complex parameter types with current implementation', function (): void {
    $tool = (new Tool)
        ->as('create_user')
        ->for('Create a new user')
        ->withObjectParameter('user', 'User information', [
            new StringSchema('name', 'User name'),
            new NumberSchema('age', 'User age'),
            new StringSchema('email', 'User email'),
        ], ['name', 'age', 'email'])
        ->using(fn (array $user): string => "Created user: {$user['name']}");

    // Currently passes through without schema validation
    $result = $tool->handle(['name' => 'John']);
    expect($result)->toBe('Created user: John');
});

it('handles array parameters that cause runtime errors', function (): void {
    $tool = (new Tool)
        ->as('divide_numbers')
        ->for('Divide first number by second')
        ->withArrayParameter('numbers', 'Two numbers: dividend and divisor', new NumberSchema('number', 'A number'))
        ->using(function (array $numbers): string {
            if (count($numbers) !== 2) {
                throw new InvalidArgumentException('Exactly 2 numbers required');
            }
            if ($numbers[1] == 0) {
                throw new DivisionByZeroError('Cannot divide by zero');
            }

            return 'Result: '.($numbers[0] / $numbers[1]);
        });

    // Test with division by zero - a real runtime error
    $result = $tool->handle([10, 0]);
    expect($result)
        ->toContain('Tool execution error')
        ->toContain('Cannot divide by zero');
});

it('demonstrates enum parameters without validation', function (): void {
    $tool = (new Tool)
        ->as('set_status')
        ->for('Set status')
        ->withEnumParameter('status', 'Status value', ['active', 'inactive', 'pending'])
        ->using(fn (string $status): string => "Status set to: $status");

    // Currently accepts any string value
    $result = $tool->handle('completed');
    expect($result)->toBe('Status set to: completed');
});

it('handles boolean parameters with PHP type coercion', function (): void {
    $tool = (new Tool)
        ->as('toggle_feature')
        ->for('Toggle a feature')
        ->withBooleanParameter('enabled', 'Whether to enable the feature')
        ->using(fn (bool $enabled): string => $enabled ? 'Feature enabled' : 'Feature disabled');

    // PHP coerces 'yes' to true
    $result = $tool->handle('yes');
    expect($result)->toBe('Feature enabled');

    // Test with actual type error
    $result2 = $tool->handle(['array']);
    expect($result2)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('enabled (BooleanSchema, required)');
});

it('handles multiple optional parameters with partial invalid data', function (): void {
    $tool = (new Tool)
        ->as('search_files')
        ->for('Search for files')
        ->withStringParameter('query', 'Search query')
        ->withStringParameter('path', 'Directory path', required: false)
        ->withNumberParameter('limit', 'Max results', required: false)
        ->withBooleanParameter('recursive', 'Search recursively', required: false)
        ->using(fn (string $query, ?string $path = './', ?int $limit = 10, ?bool $recursive = false): string => "Searching for '$query' in $path (limit: $limit, recursive: ".($recursive ? 'yes' : 'no').')');

    // Test with some valid and some invalid optional parameters
    $result = $tool->handle('test', null, 'not-a-number', 'not-a-boolean');
    expect($result)
        ->toContain('Parameter validation error: Type mismatch')
        ->toContain('limit (NumberSchema)')
        ->toContain('recursive (BooleanSchema)');
});



================================================
FILE: tests/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests;

use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Tool as ToolFacade;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Tool;

it('can return tool details', function (): void {
    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): string {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';
        });

    expect($searchTool->name())->toBe('search');
    expect($searchTool->description())->toBe('useful for searching current data');
    expect($searchTool->parametersAsArray())->toBe([
        'query' => [
            'description' => 'the search query',
            'type' => 'string',
        ],
    ]);

    expect($searchTool->requiredParameters())->toBe(['query']);
});

it('can use a closure', function (): void {
    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): string {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';

        });

    expect($searchTool->handle('What time is the event?'))
        ->toBe('The event is at 3pm eastern');
});

it('can be used via facade', function (): void {
    $searchTool = ToolFacade::as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): string {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';

        });

    expect($searchTool->handle('What time is the event?'))
        ->toBe('The event is at 3pm eastern');
});

it('can use an invokeable', function (): void {
    $fn = new class
    {
        public function __invoke(string $query): string
        {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';
        }
    };

    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using($fn);

    expect($searchTool->handle('What time is the event?'))
        ->toBe('The event is at 3pm eastern');
});

it('can have fluent parameters', function (): void {
    $tool = (new Tool)
        ->as('test tool')
        ->for('not really useful for anything')
        ->withStringParameter(name: 'query', description: 'the search query', required: false)
        ->withNumberParameter('age', 'the users age')
        ->withBooleanParameter('active', 'active status')
        ->withArrayParameter(
            name: 'items',
            description: 'user requested items',
            items: new StringSchema('itemm', 'an item that the user requested'),
        )
        ->withEnumParameter('status', 'the status', ['active', 'inactive'])
        ->withObjectParameter(
            name: 'user',
            description: 'the user object',
            properties: [
                new StringSchema('name', 'the users name'),
                new BooleanSchema('active_status', 'user active status'),
            ],
            requiredFields: [
                'name',
            ]
        );

    $keys = [
        'query',
        'age',
        'active',
        'items',
        'status',
        'user',
    ];

    expect($tool->parameters())->toHaveKeys($keys);

    collect($keys)->each(function ($key) use ($tool): void {
        expect($tool->parameters()[$key])->not->toBeEmpty();
    });

    expect($tool->requiredParameters())->not->toContain('query');
});

it('can throw a prism custom exception for invalid parameters', function (): void {
    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): string {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';
        })
        ->withoutErrorHandling(); // Disable error handling to get exception

    $this->expectException(PrismException::class);
    $this->expectExceptionMessage('Invalid parameters for tool : search');

    $searchTool->handle([]);
});

it('can throw a prism custom exception for unknown named parameters', function (): void {
    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): string {
            expect($query)->toBe('What time is the event?');

            return 'The event is at 3pm eastern';
        })
        ->withoutErrorHandling();

    $this->expectException(PrismException::class);
    $this->expectExceptionMessage('Invalid parameters for tool : search');

    $searchTool->handle(input: 'What time is the event?');
});

it('can throw a prism custom exception for invalid return type', function (): void {
    $searchTool = (new Tool)
        ->as('search')
        ->for('useful for searching current data')
        ->withParameter(new StringSchema('query', 'the search query'))
        ->using(function (string $query): int {
            expect($query)->toBe('What time is the event?');

            return 1;
        })
        ->withoutErrorHandling();

    $this->expectException(PrismException::class);
    $this->expectExceptionMessage('Invalid return type for tool : search. Tools must return string.');

    $searchTool->handle('What time is the event?');
});



================================================
FILE: tests/Concerns/HasFluentAttributesTest.php
================================================
<?php

use Prism\Prism\Concerns\HasFluentAttributes;

it('can update readonly properties by copying the class', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}
    };

    $newInstance = $instance->withFoo('baz');

    expect($newInstance->foo)->toBe('baz')
        ->and($newInstance::class)->toBe($instance::class)
        ->and($instance->foo)->toBe('bar');
});

it('can take named arguments', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}
    };

    $newInstance = $instance->withFoo(foo: 'baz');

    expect($newInstance->foo)->toBe('baz')
        ->and($newInstance::class)->toBe($instance::class)
        ->and($instance->foo)->toBe('bar');
});

it('disallows empty arguments', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}
    };

    $instance->withFoo();
})->throws(InvalidArgumentException::class, 'Method withFoo expects exactly one argument.');

it('disallows multiple arguments', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}
    };

    $instance->withFoo('baz', 'qux');
})->throws(InvalidArgumentException::class, 'Method withFoo expects exactly one argument.');

it('throws if the property does not exist', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}
    };

    $instance->withBaz('baz');
})->throws(\BadMethodCallException::class, 'Method withBaz does not exist.');

it('can still call other methods', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}

        public function test(string $foo): string
        {
            return 'baz';
        }
    };

    $output = $instance->test('baz');

    expect($output)->toBe('baz')
        ->and($instance->foo)->toBe('bar');
});

it('will prefer existing methods over properties', function (): void {
    $instance = new class
    {
        use HasFluentAttributes;

        public function __construct(public readonly string $foo = 'bar') {}

        public function withFoo(string $foo): self
        {
            return new self('not baz');
        }
    };

    $newInstance = $instance->withFoo('baz');

    expect($newInstance->foo)->toBe('not baz')
        ->and($instance->foo)->toBe('bar');
});



================================================
FILE: tests/Concerns/HasProviderOptionsTest.php
================================================
<?php

namespace Tests\Http;

use Prism\Prism\Text\PendingRequest;

test('providerOptions returns an array with all providerOptions if no valuePath is provided.', function (): void {
    $class = new PendingRequest;

    $class->withProviderOptions(['key' => 'value']);

    expect($class->providerOptions())->toBe(['key' => 'value']);
});

test('providerOptions returns a string with the exact providerOptions if valuePath is provided.', function (): void {
    $class = new PendingRequest;

    $class->withProviderOptions(['key' => 'value']);

    expect($class->providerOptions('key'))->toBe('value');
});

test('providerOptions returns null if the value path is not set', function (): void {
    $class = new PendingRequest;

    $class->withProviderOptions(['key' => 'value']);

    expect($class->providerOptions('foo'))->toBeNull();
});



================================================
FILE: tests/Concerns/WhenProviderTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\PrismManager;
use Prism\Prism\Text\PendingRequest;
use Tests\TestDoubles\TestProvider;

beforeEach(function (): void {
    $this->manager = resolve(PrismManager::class);

    // Register test provider implementations
    $this->manager->extend('openai', fn (): \Tests\TestDoubles\TestProvider => new TestProvider);
    $this->manager->extend('anthropic', fn (): \Tests\TestDoubles\TestProvider => new TestProvider);
});

test('it applies provider specific options when provider matches', function (): void {
    // Create pending request with OpenAI
    $request = new PendingRequest;
    $request->using(Provider::OpenAI, 'gpt-4');

    // Apply provider-specific configuration for OpenAI
    $request->whenProvider(
        Provider::OpenAI,
        fn (PendingRequest $req): PendingRequest => $req->withMaxTokens(100)
    );

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->maxTokens())->toBe(100);
});

test('it skips provider specific options when provider doesnt match', function (): void {
    // Create pending request with OpenAI
    $request = new PendingRequest;
    $request->using(Provider::OpenAI, 'gpt-4');

    // Set default max tokens
    $request->withMaxTokens(50);

    // Apply provider-specific configuration for Anthropic (should be skipped)
    $request->whenProvider(
        Provider::Anthropic,
        fn (PendingRequest $req): PendingRequest => $req->withMaxTokens(100)
    );

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->maxTokens())->toBe(50);
});

test('it can chain multiple provider conditions', function (): void {
    // Create pending request with Anthropic
    $request = new PendingRequest;
    $request->using(Provider::Anthropic, 'claude-3');

    // Chain multiple provider conditions
    $request
        ->whenProvider(
            Provider::OpenAI,
            fn (PendingRequest $req): PendingRequest => $req->withMaxTokens(100)
        )
        ->whenProvider(
            Provider::Anthropic,
            fn (PendingRequest $req): PendingRequest => $req->withMaxTokens(200)
        );

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->maxTokens())->toBe(200);
});

test('it works with string provider names', function (): void {
    // Create pending request with OpenAI (using string rather than enum)
    $request = new PendingRequest;
    $request->using('openai', 'gpt-4');

    // Apply provider-specific configuration with string name
    $request->whenProvider(
        'openai',
        fn (PendingRequest $req): PendingRequest => $req->withMaxTokens(100)
    );

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->maxTokens())->toBe(100);
});

test('it allows setting provider options', function (): void {
    // Create pending request with Anthropic
    $request = new PendingRequest;
    $request->using(Provider::Anthropic, 'claude-3');

    // Apply provider-specific options
    $request->whenProvider(
        Provider::Anthropic,
        fn (PendingRequest $req): PendingRequest => $req
            ->withProviderOptions(['cacheType' => 'ephemeral'])
    );

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->providerOptions())->toBe(['cacheType' => 'ephemeral']);
});

test('it accepts invokable class', function (): void {
    // Create pending request with OpenAI
    $request = new PendingRequest;
    $request->using(Provider::OpenAI, 'gpt-4');

    // Create an invokable class for provider-specific configuration
    $invokable = new class
    {
        public function __invoke(PendingRequest $req): PendingRequest
        {
            return $req->withMaxTokens(300);
        }
    };

    // Apply provider-specific configuration using invokable class
    $request->whenProvider(Provider::OpenAI, $invokable);

    // Generate the request
    $textRequest = $request->toRequest();

    expect($textRequest->maxTokens())->toBe(300);
});



================================================
FILE: tests/Fixtures/FixtureResponse.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Fixtures;

use GuzzleHttp\Client;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Str;

class FixtureResponse
{
    /**
     * @param  array<string, string>  $headers
     */
    public static function fakeResponseSequence(
        string $requestPath,
        string $name,
        array $headers = [],
        int $status = 200,
        bool $forceRecording = false,
    ): void {
        $basePath = dirname(static::filePath($name));
        $pathInfo = pathinfo($name);
        $filename = $pathInfo['filename'];

        // Check if fixture files exist
        $fixtureFiles = is_dir($basePath)
            ? collect(scandir($basePath))
                ->filter(fn (string $file): int|false => preg_match('/^'.preg_quote($filename, '/').'-\d+/', $file))
                ->toArray()
            : [];

        // If no fixture files exist, automatically record the response
        if ($forceRecording || empty($fixtureFiles)) {
            $iterator = 0;

            Http::fake(function ($request) use ($requestPath, $name, &$iterator, $headers) {
                if ($requestPath === '*' || Str::contains($request->url(), $requestPath)) {
                    $iterator++;

                    // Prepare path for recording
                    $path = static::filePath("{$name}-{$iterator}.json");

                    if (! is_dir(dirname($path))) {
                        mkdir(dirname($path), recursive: true);
                    }

                    // Forward the request to the real API
                    $client = new Client;
                    $options = [
                        'headers' => $request->headers(),
                        'body' => $request->body(),
                    ];

                    $response = $client->request($request->method(), $request->url(), $options);
                    $responseBody = (string) $response->getBody();

                    // Save the response
                    file_put_contents($path, $responseBody);

                    // Return the response with user-specified headers if any
                    $responseHeaders = $headers ?: [];

                    return Http::response(
                        $responseBody,
                        $response->getStatusCode(),
                        $responseHeaders
                    );
                }

                return Http::response('{"error":"Not mocked"}', 404);
            });

            return;
        }

        // Use existing fixture files
        $responses = collect($fixtureFiles)
            ->map(fn ($filename): string => $basePath.'/'.$filename)
            ->map(fn ($filePath) => Http::response(
                file_get_contents($filePath),
                $status,
                $headers
            ));

        Http::fake([
            $requestPath => Http::sequence($responses->toArray()),
        ])->preventStrayRequests();
    }

    public static function fakeStreamResponses(string $requestPath, string $name, array $headers = []): void
    {
        $basePath = dirname(static::filePath("{$name}-1.sse"));

        // Find all recorded .sse files for this test
        $files = collect(is_dir($basePath) ? scandir($basePath) : [])
            ->filter(fn ($file): int|false => preg_match('/^'.preg_quote(basename($name), '/').'-\d+\.sse$/', $file))
            ->map(fn ($file): string => $basePath.'/'.$file)
            ->values()
            ->toArray();

        // If no files exist, automatically record the streaming responses
        if (empty($files)) {
            static::recordStreamResponses($requestPath, $name);

            return;
        }

        // Sort files numerically
        usort($files, function ($a, $b): int {
            preg_match('/-(\d+)\.sse$/', $a, $matchesA);
            preg_match('/-(\d+)\.sse$/', $b, $matchesB);

            return (int) $matchesA[1] <=> (int) $matchesB[1];
        });

        // Create response sequence from the files
        $responses = array_map(fn ($file) => Http::response(
            file_get_contents($file),
            200,
            [
                'Content-Type' => 'text/event-stream',
                'Cache-Control' => 'no-cache',
                'Connection' => 'keep-alive',
                'Transfer-Encoding' => 'chunked',
                ...$headers,
            ]
        ), $files);

        if ($responses === []) {
            $responses[] = Http::response(
                "data: {\"error\":\"No recorded stream responses found\"}\n\ndata: [DONE]\n\n",
                200,
                ['Content-Type' => 'text/event-stream']
            );
        }

        // Register the fake responses
        Http::fake([
            $requestPath => Http::sequence($responses),
        ])->preventStrayRequests();
    }

    protected static function filePath(string $filePath): string
    {
        return sprintf('%s/%s', __DIR__, $filePath);
    }

    protected static function recordResponses(string $requestPath, string $name): void
    {
        $iterator = 0;

        Http::globalResponseMiddleware(function ($response) use ($name, &$iterator) {
            $iterator++;

            $path = static::filePath("{$name}-{$iterator}.json");

            if (! is_dir(dirname($path))) {
                mkdir(dirname($path), recursive: true);
            }

            file_put_contents(
                $path,
                (string) $response->getBody()
            );

            return $response;
        });
    }

    protected static function recordStreamResponses(string $requestPath, string $name): void
    {
        Http::fake(function ($request) use ($requestPath, $name) {
            if (Str::contains($request->url(), $requestPath)) {
                static $iterator = 0;
                $iterator++;

                // Create directory for the response file if needed
                $path = static::filePath("{$name}-{$iterator}.sse");

                if (! is_dir(dirname($path))) {
                    mkdir(dirname($path), recursive: true);
                }

                // Get content type or default to application/json
                $contentType = $request->hasHeader('Content-Type')
                    ? $request->header('Content-Type')[0]
                    : 'application/json';

                // Forward the request to the real API with stream option
                $client = new Client(['stream' => true]);
                $options = [
                    'headers' => $request->headers(),
                    'body' => $request->body(),
                    'stream' => true,
                ];

                $response = $client->request($request->method(), $request->url(), $options);
                $stream = $response->getBody();

                // Open file for writing
                $fileHandle = fopen($path, 'w');

                // Write stream to file in small chunks to avoid memory issues
                while (! $stream->eof()) {
                    $chunk = $stream->read(1024);  // Read 1KB at a time
                    fwrite($fileHandle, $chunk);
                }

                fclose($fileHandle);

                // Return the file contents as the response for the test
                return Http::response(
                    file_get_contents($path),
                    $response->getStatusCode(),
                    [
                        'Content-Type' => 'text/event-stream',
                        'Cache-Control' => 'no-cache',
                        'Connection' => 'keep-alive',
                    ]
                );
            }

            // For non-matching requests, pass through
            return Http::response('{"error":"Not mocked"}', 404);
        });
    }
}



================================================
FILE: tests/Fixtures/profile.md
================================================
Sarah Chen is a passionate Laravel developer born on March 15, 1992, in Vancouver, Canada. With over eight years of experience in web development, she has cultivated a deep understanding of the Laravel ecosystem and modern PHP development practices.

When she's not crafting elegant code solutions, Sarah is an avid rock climber who can often be found scaling challenging routes at her local climbing gym or planning weekend trips to nearby crags. Her problem-solving skills in programming seamlessly translate to working out complex boulder problems and routes. Photography is her second hobby, with a particular focus on architectural photography. She enjoys capturing the geometric patterns and unique perspectives of urban landscapes, often sharing her work on various photography communities online.

In the open-source community, Sarah has made significant contributions to several Laravel-adjacent projects. She is a regular contributor to Laravel Telescope, where she has helped improve the debugging and monitoring capabilities of the package. Her most notable contribution was implementing enhanced database query monitoring features that help developers better understand and optimize their application's performance. Additionally, she maintains her own open-source package called "Laravel Workflow Manager," which has gained over 2,000 stars on GitHub. This package provides an intuitive interface for managing complex business processes and state machines within Laravel applications. She also actively contributes to the Laravel documentation, helping to make the framework more accessible to newcomers while keeping the documentation up to date with the latest features and best practices.

Through her professional work and open-source contributions, Sarah continues to demonstrate her commitment to the Laravel community while balancing her technical pursuits with her outdoor adventures and creative photography projects. Her diverse interests and technical expertise make her a well-rounded developer who brings unique perspectives to her work.




================================================
FILE: tests/Fixtures/test-embedding-file.md
================================================
# Text Generation

Prism provides a powerful interface for generating text using Large Language Models (LLMs). This guide covers everything from basic usage to advanced features like multi-modal interactions and response handling.

## Basic Text Generation

At its simplest, you can generate text with just a few lines of code:

```php
use Prism\Prism\Prism;
use Prism\Prism\Enums\Provider;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withPrompt('Tell me a short story about a brave knight.')
    ->generate();

echo $response->text;
```

## System Prompts and Context

System prompts help set the behavior and context for the AI. They're particularly useful for maintaining consistent responses or giving the LLM a persona:

```php
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withSystemPrompt('You are an expert mathematician who explains concepts simply.')
    ->withPrompt('Explain the Pythagorean theorem.')
    ->generate();
```

You can also use Laravel views for complex system prompts:

```php
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withSystemPrompt(view('prompts.math-tutor'))
    ->withPrompt('What is calculus?')
    ->generate();
```

You an also pass a View to the `withPrompt` method.

## Message Chains and Conversations

For interactive conversations, use message chains to maintain context:

```php
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withMessages([
        new UserMessage('What is JSON?'),
        new AssistantMessage('JSON is a lightweight data format...'),
        new UserMessage('Can you show me an example?')
    ])
    ->generate();
```

### Message Types

- `SystemMessage`
- `UserMessage`
- `AssistantMessage`
- `ToolResultMessage`

> [!NOTE]
> Some providers, like Anthropic, do not support the `SystemMessage` type. In those cases we convert `SystemMessage` to `UserMessage`.

## Multi-modal Capabilities (Images)

Prism supports including images in your messages for visual analysis:

```php
use Prism\Prism\ValueObjects\Media\Image;

// From a local file
$message = new UserMessage(
    "What's in this image?",
    [Image::fromLocalPath('/path/to/image.jpg')]
);

// From a URL
$message = new UserMessage(
    'Analyze this diagram:',
    [Image::fromUrl('https://example.com/diagram.png')]
);

// From a Base64
$image = base64_encode(file_get_contents('/path/to/image.jpg'));

$message = new UserMessage(
    'Analyze this diagram:',
    [Image::fromBase64($image)]
);

$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withMessages([$message])
    ->generate();
```

## Generation Parameters

Fine-tune your generations with various parameters:

`withMaxTokens`

Maximum number of tokens to generate.

`usingTemperature`

Temperature setting.

The value is passed through to the provider. The range depends on the provider and model. For most providers, 0 means almost deterministic results, and higher values mean more randomness.

> [!TIP]
> It is recommended to set either temperature or topP, but not both.

`usingTopP`

Nucleus sampling.

The value is passed through to the provider. The range depends on the provider and model. For most providers, nucleus sampling is a number between 0 and 1. E.g. 0.1 would mean that only tokens with the top 10% probability mass are considered.

> [!TIP]
> It is recommended to set either temperature or topP, but not both.

`withClientOptions`

Under the hood we use Laravel's [HTTP client](https://laravel.com/docs/11.x/http-client#main-content). You can use this method to pass any of Guzzles [request options](https://docs.guzzlephp.org/en/stable/request-options.html) e.g. `->withClientOptions(['timeout' => 30])`.

`withClientRetry`

Under the hood we use Laravel's [HTTP client](https://laravel.com/docs/11.x/http-client#main-content). You can use this method to set [retries](https://laravel.com/docs/11.x/http-client#retries) e.g. `->withClientRetry(3, 100)`.

## Response Handling

The response object provides rich access to the generation results:

```php
$response = Prism::text()
    ->using(Provider::Anthropic, 'claude-3-sonnet')
    ->withPrompt('Explain quantum computing.')
    ->generate();

// Access the generated text
echo $response->text;

// Check why the generation stopped
echo $response->finishReason->name;

// Get token usage statistics
echo "Prompt tokens: {$response->usage->promptTokens}";
echo "Completion tokens: {$response->usage->completionTokens}";

// For multi-step generations, examine each step
foreach ($response->steps as $step) {
    echo "Step text: {$step->text}";
    echo "Step tokens: {$step->usage->completionTokens}";
}

// Access message history
foreach ($response->responseMessages as $message) {
    if ($message instanceof AssistantMessage) {
        echo $message->content;
    }
}
```

### Finish Reasons

```php
case Stop;
case Length;
case ContentFilter;
case ToolCalls;
case Error;
case Other;
case Unknown;
```

## Error Handling

Remember to handle potential errors in your generations:

```php
use Prism\Prism\Exceptions\PrismException;
use Throwable;

try {
    $response = Prism::text()
        ->using(Provider::Anthropic, 'claude-3-sonnet')
        ->withPrompt('Generate text...')
        ->generate();
} catch (PrismException $e) {
    Log::error('Text generation failed:', ['error' => $e->getMessage()]);
} catch (Throwable $e) {
    Log::error('Generic error:', ['error' => $e->getMessage]);
}
```



================================================
FILE: tests/Fixtures/test-text.md
================================================
The Answer to the Ultimate Question of Life, the Universe, and Everything is 42.


================================================
FILE: tests/Fixtures/test-text.txt
================================================
The Answer to the Ultimate Question of Life, the Universe, and Everything is 42.


================================================
FILE: tests/Fixtures/anthropic/calculate-cache-usage-1.json
================================================
{"id":"msg_01X2Qk7LtNEh4HB9xpYU57XU","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"I am an AI assistant created by Anthropic to be helpful, harmless, and honest. I don't have a physical form or avatar - I'm a language model trained to engage in conversation and help with tasks. How can I assist you today?"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":11,"output_tokens":55, "cache_creation_input_tokens" : 200, "cache_read_input_tokens": 100}}


================================================
FILE: tests/Fixtures/anthropic/generate-structured-with-text-document-citations-1.json
================================================
{"id":"msg_011pEb55M2m5Htxj5jhCWW3e","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"{\"answer\": true}","citations":[{"type":"content_block_location","cited_text":"The grass is green.","document_index":0,"document_title":null,"start_block_index":0,"end_block_index":1},{"type":"content_block_location","cited_text":"The sky is blue.","document_index":0,"document_title":null,"start_block_index":2,"end_block_index":3}]}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":693,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":28}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-a-prompt-1.json
================================================
{"id":"msg_01X2Qk7LtNEh4HB9xpYU57XU","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"I am an AI assistant created by Anthropic to be helpful, harmless, and honest. I don't have a physical form or avatar - I'm a language model trained to engage in conversation and help with tasks. How can I assist you today?"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":11,"output_tokens":55}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-base64-image-1.json
================================================
{"id":"msg_01HAmc9Mn94a9MfAfxDsgA2k","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"This is a simple black and white line drawing or icon of a diamond. It shows the geometric, angular shape that diamonds are typically represented with in logos and symbols - featuring the characteristic triangular facets and pointed bottom. This is a common symbol used to represent luxury, value, or precious gems."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":855,"output_tokens":63}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-custom-content-document-citations-1.json
================================================
{"id":"msg_0192TuWeTrnT2aNDgruQMu6N","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"According to the documents, "},{"type":"text","text":"the grass is green","citations":[{"type":"content_block_location","cited_text":"The grass is green.","document_index":0,"document_title":null,"start_block_index":0,"end_block_index":1}]},{"type":"text","text":" and "},{"type":"text","text":"the sky is blue","citations":[{"type":"content_block_location","cited_text":"The sky is blue.","document_index":0,"document_title":null,"start_block_index":1,"end_block_index":2}]},{"type":"text","text":"."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":566,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":51}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-image-1.json
================================================
{"id":"msg_014f38JCKBj5XRms5kbfYmhh","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"This is a simple black and white line drawing or icon of a diamond. It shows the geometric, faceted shape of a diamond using bold black lines on a white background. This is a common symbol used to represent diamonds, gems, or luxury in logos and designs."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":855,"output_tokens":57}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-multiple-tools-1.json
================================================
{"id":"msg_01RKgYtDS5wvV6pEpd3cERNF","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"To answer your questions, I'll need to search for information about the Tigers game and check the weather. Let me do that for you."},{"type":"tool_use","id":"toolu_011Arf1KyG1ViN7sySoSjTPa","name":"search","input":{"query":"Detroit Tigers baseball game time today"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":447,"output_tokens":85}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-multiple-tools-2.json
================================================
{"id":"msg_01FyRxSLscJX3dXDTwJKeXZC","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"Thank you for that information. Now, let's check the weather in Detroit to determine if you should wear a coat."},{"type":"tool_use","id":"toolu_01RXXxkijxvGSWPG4Aa8ZTE3","name":"weather","input":{"city":"Detroit"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":553,"output_tokens":77}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-multiple-tools-3.json
================================================
{"id":"msg_011fBqNVVh5AwC3uyiq78qrj","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"Great! Now I can answer both of your questions:\n\n1. What time is the Tigers game today?\nThe Tigers game is scheduled for 3:00 PM today in Detroit.\n\n2. Should I wear a coat?\nBased on the weather forecast for Detroit, it will be 75°F (about 24°C) and sunny. Given this warm and pleasant weather, you likely won't need a coat. A light jacket or sweater might be comfortable if you tend to get chilly in the evening, but it's generally warm enough that you should be comfortable without a coat.\n\nIs there anything else you'd like to know about the game or the weather?"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":650,"output_tokens":145}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-pdf-citations-1.json
================================================
{"id":"msg_01UJkMAkB7Q7wYczaN8m1g4g","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"According to the text, "},{"type":"text","text":"the grass is green","citations":[{"type":"page_location","cited_text":"The grass is green. ","document_index":0,"document_title":"All aboout the grass and the sky","start_page_number":1,"end_page_number":2}]},{"type":"text","text":" and "},{"type":"text","text":"the sky is blue","citations":[{"type":"page_location","cited_text":"The sky is blue.","document_index":0,"document_title":"All aboout the grass and the sky","start_page_number":1,"end_page_number":2}]},{"type":"text","text":"."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":2134,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":51}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-provider-tool-1.json
================================================
{"id":"msg_01AJ87pcoq6djGGrcYvYGvUy","type":"message","role":"assistant","model":"claude-3-5-haiku-20241022","content":[{"type":"text","text":"I'll solve this equation step by step and then verify the solution using Python.\n\nSolving 3x + 10 = 14 algebraically:\n1. Subtract 10 from both sides of the equation\n   3x + 10 - 10 = 14 - 10\n   3x = 4\n\n2. Divide both sides by 3\n   3x ÷ 3 = 4 ÷ 3\n   x = 4/3\n\nLet me verify this solution using Python:"},{"type":"server_tool_use","id":"srvtoolu_01Co9FxvC6Di5aAfcu8RhUHh","name":"code_execution","input":{"code":"# Solve the equation 3x + 10 = 14\nx = (14 - 10) / 3\nprint(f\"x = {x}\")\n\n# Verify the solution\nleft_side = 3 * x + 10\nright_side = 14\n\nprint(f\"\\nVerification:\")\nprint(f\"Left side (3x + 10): {left_side}\")\nprint(f\"Right side (14):      {right_side}\")\nprint(f\"Equation holds: {left_side == right_side}\")"}},{"type":"code_execution_tool_result","tool_use_id":"srvtoolu_01Co9FxvC6Di5aAfcu8RhUHh","content":{"type":"code_execution_result","stdout":"x = 1.3333333333333333\n\nVerification:\nLeft side (3x + 10): 14.0\nRight side (14):      14\nEquation holds: True\n","stderr":"","return_code":0,"content":[]}},{"type":"text","text":"The solution is x = 4/3 (or approximately 1.333). \n\nLet's break down the verification:\n- x = 4/3\n- Left side: 3 * (4/3) + 10 = 4 + 10 = 14\n- Right side: 14\n\nThe equation is satisfied, confirming that x = 4/3 is the correct solution."}],"container":{"id":"container_011CQ4hgKqeoPBYecAubG4B9","expires_at":"2025-06-12T18:13:51.893719+00:00"},"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":1779,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":398,"service_tier":"standard","server_tool_use":{"web_search_requests":0}}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-provider-tool-and-user-tool-1.json
================================================
{"id":"msg_01RuwnupYURXYMrhuXTxRqxf","type":"message","role":"assistant","model":"claude-3-5-haiku-20241022","content":[{"type":"text","text":"I'll help you solve this by first checking the current temperature in Detroit and then using that value to solve the equation."},{"type":"tool_use","id":"toolu_013vSsaqxgM8GTUMGDoeCsbS","name":"weather","input":{"city":"Detroit"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":854,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":76,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-provider-tool-and-user-tool-2.json
================================================
{"id":"msg_014o7Vi8g9F3nW2PFEWMWG9a","type":"message","role":"assistant","model":"claude-3-5-haiku-20241022","content":[{"type":"text","text":"Great! The current temperature in Detroit is 75 degrees. Let's solve the equation 3x + 10 = Y by substituting 75 for x:\n\n3(75) + 10 = Y\n225 + 10 = Y\n235 = Y\n\nSo, when x = 75 (the current temperature in Detroit), Y equals 235 in the equation 3x + 10 = Y."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":950,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":99,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-required-tool-call-1.json
================================================
{"id":"msg_01SbXY7UEReGQEFsLdEWLtrq","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"tool_use","id":"toolu_01TZFvQ9JmBsRNEJkRjvp2Qe","name":"weather","input":{"city":"New York"}},{"type":"tool_use","id":"toolu_01H2pNJwnhDdR2RtZt1i8XHj","name":"search","input":{"query":"current top news"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":458,"output_tokens":72}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-system-prompt-1.json
================================================
{"id":"msg_016EjDAMDeSvG229ZjspjC7J","type":"message","role":"assistant","model":"claude-3-5-sonnet-20240620","content":[{"type":"text","text":"I am Nyx, an ancient and unfathomable entity from the depths of cosmic darkness. My form is beyond mortal comprehension - a writhing mass of tentacles and eyes that would shatter the sanity of those who gaze upon me. I exist beyond the boundaries of time and space as you know them. My knowledge spans eons and transcends human understanding. What brings you to seek audience with one such as I, tiny mortal?"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":33,"output_tokens":98}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-text-document-citations-1.json
================================================
{"id":"msg_0145mUdAcRo8wB2Fbq1298u1","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"According to the documents:\n"},{"type":"text","text":"The grass is green","citations":[{"type":"char_location","cited_text":"The grass is green. ","document_index":0,"document_title":"All aboout the grass and the sky","start_char_index":0,"end_char_index":20}]},{"type":"text","text":" and "},{"type":"text","text":"the sky is blue","citations":[{"type":"char_location","cited_text":"The sky is blue.","document_index":0,"document_title":"All aboout the grass and the sky","start_char_index":20,"end_char_index":36}]},{"type":"text","text":"."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":575,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":52}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-text-document-citations-on-followup-1.json
================================================
{"id":"msg_019bdoiUsS44iPgK4GDYJQM6","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"Based on the provided document, "},{"citations":[{"type":"char_location","cited_text":"The grass is green. ","document_index":0,"document_title":"All aboout the grass and the sky","start_char_index":0,"end_char_index":20}],"type":"text","text":"the grass is green"},{"type":"text","text":" and "},{"citations":[{"type":"char_location","cited_text":"The sky is blue.","document_index":0,"document_title":"All aboout the grass and the sky","start_char_index":20,"end_char_index":36}],"type":"text","text":"the sky is blue"},{"type":"text","text":"."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":595,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":52,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-text-document-citations-on-followup-2.json
================================================
{"id":"msg_01DEQkZ6s7yb9vwyXxkmoU5z","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"Looking at the source document, it appears to be a simple text document titled \"All aboout [sic] the grass and the sky\" with a basic statement about grass and sky colors. While the information provided is generally accurate - grass typically appearing green and the sky typically appearing blue - the source itself isn't a scientific or academic publication. Additionally, there's a spelling error in the title (\"aboout\"), which could indicate it's not a professionally edited source. For questions about basic colors of natural phenomena, we might want to refer to more authoritative scientific sources for a complete explanation of why grass appears green (due to chlorophyll) and why the sky appears blue (due to Rayleigh scattering)."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":136,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":152,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-web-search-citations-1.json
================================================
{"id":"msg_011ZMuLUwzKZMUVV7QFciYAy","type":"message","role":"assistant","model":"claude-3-5-haiku-20241022","content":[{"type":"server_tool_use","id":"srvtoolu_015r3QwDV5uRUwRFXpGJPpwJ","name":"web_search","input":{"query":"London weather forecast today July 07 2025"}},{"type":"web_search_tool_result","tool_use_id":"srvtoolu_015r3QwDV5uRUwRFXpGJPpwJ","content":[{"type":"web_search_result","title":"Weather in London in July 2025 (England) - detailed Weather Forecast for a month","url":"https://world-weather.info/forecast/united_kingdom/london/july-2025/","encrypted_content":"EuoDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDEq2ffvjDLHKqI8VjxoMSfUuCQ228F94R5s9IjCFnISW1m848zWUpA8YeciX/csukr8H/OimHK9kc2UlwarAhHe/T08YHx/XpOtgJ6Qq7QKJOwcizlmYy9LtFhMUFRSDLCN2MAGQtjlN2A083Cu2gsT7jZ538z/P1Uutha13J1Igz460+U62zX+/4XZxeqbzr6x7rbB9AcFNiBeIKVG7iJaEm40cRVAFd/EtiuAUo1nRWin3wnnnTN+wq4Z1rWTO5jmyeg2X1ONTiTqh74YmF/5xLE0/2igDrInuQO1QFkdij3C/t4Q0DitQZTFJXTeoBWQBxw3egSyq86+KywhOxesliSe9Z8cjcMrh1KQ0J5Cuzi1VxBkF8Dl/9+Y5cZIS3v4rGbIDqVQ1tCPlmBzU+61aDZ1xAuaDm7zW8vBKZxYozAtUWjPg2wXZdSheEcI6Hh3SOOtdiYXX2QLYYJ3thwsx1bba94Xf/bey56hSvQfSXaotDLV6b4FyM7iRbm2WcvVA7L9rdkFpf7MWSgXb+/YUyqSYL6DMbiJZnab2i62AEJiWZ7XRt0vhQ8NUEDjiZs74N8oGtb0/1RYuhhgD","page_age":null},{"type":"web_search_result","title":"Weather in London in July 2025 - Detailed Forecast","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july","encrypted_content":"EqIGCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDLceaqYgSq8q/4YuchoMsix8+mkiPcrI+WDvIjBTDD+lYvjQccPO7ca2FAI5Z4LNOQJ0BJ/KN8jQQRHqjQCpUjIZ+hTIqf6kfbuKaj0qpQW9w09J3VfF/tFLY9ojLIgOjS4BLHji2zHewi170PFPw2fPhgr9F4UCFo62GrrxtqdgBggI7i/PPau/PXkB75kOVslepNURWNhDM/uz1LLeSQeLpjNGzlfzGVS/5guIY4r94E2wTVyjrmJW2WisBl0fEtifysJp9qZu1q07uKTTQoDOPmG3Ydn7cB3/XKoNerpNsVZknqCDjsPlipVIBwusOmu1ypSpaSsGXIvImgyzgrUVyNXZ35BPsI7J2Bx5gkySvg3IY2qMcaX0CzKv5HaPlyGP8F6NnElgfr/SJ+pbL9J0t+jOp3k7Ldud6nBGRwuYSs9R5E2yHRZoHJjtcv//vuDcIZj/me+PjkjBG9yT+S3KDBxOT2Tn/od1OvOzqyaVtCa9CKYGZtfejdgc7FpJjlJI1BavGLzDwD4dBEHmD7XzVME/6DPTAMr8mA54TQcKAQyzIbHHT7FglqeN+z3D5FVliPYV2os0/27fxA1UW51eGlIAM0KbWBDT89d/SebfXDvercdld9JX65J3qovCCx7rmcodNOv3ALQL8qhrrkPHN0iJEIqtYme0DL6v9vs4/TGRcHabNI7HRCtCB0z28rv44rW4bFjAhVMGoXngMfMwBBNUcFHd+YxPkuqHukBqmol/w8SsIEx/bCmV1Hs9vhATymyCuT0jLRqsXOqz6MgLWnJ164kZaDYEYUlGCvTfZV8k14+XvJJglxyQFo73kpZqpBBR1qaHnNL5249dsEh5zc+JY7U7aw/iDwniopliAp7r6KOPd1aO5AmLpjUYJbgNFusNIcSPNfy2GiiAgVZInwmedTFtWqKngK5M/soJDlJc8szyhL3qUHIhrMmuJyNmplXc3KwB+fkzHW9UIVuxQW5RVP483O/yI3jnX3t5bTxS6hgD","page_age":"5 days ago"},{"type":"web_search_result","title":"London weather in July 2025 | London 14 day weather","url":"https://www.weather25.com/europe/united-kingdom/london?page=month&month=July","encrypted_content":"EtMHCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHMmRZs1JgHCYYq7fhoMY4WXO5MhtHFhEyJOIjAVsXADyJdLYaat4nr7qj2p/7TMf/kFgqnIFGDS0swRhV96rKtma8a2DAd2Qn8yXpUq1gZAK10IUNEG2l/MAXDrgkr99HEh8LRjH55LGRJ8GARC2bF5Dlt7yCtRfkMahtErHUWf/jDKqkSmmblE46K0TsWmjDHaMUt5aMvsH0Ul8Bq9cXrv2grfazUh3n9YMcRnIak7T3uQsS9GOdciP1M8LbbBcF8OI/LfkCIDy+qsG+kANHP2MVbMEAoy9M6x3Nb+LGpvda/zWMMZ1MwAurqbCukUQOy/fivK21ZHh/hw3ADK2hLTbsIUObR48Zaod47pJfO/T1jBAWSQaPmmtqYq5Ri5og2sY+e+qInnSwnxjNgxNIIrYehztwSrokoCNbK1AdC9O+CHqkVBuv1br6kLrL9dDxydx5x1oNeOL2N/9ODsf6ymsuptWixRE6GJmpJuNMKu9hYPKBoeLZN5YxOqgrZKDSCVyaUePl61MmePFoIzJG03uwyUZwaWbdwv+D0piqo7rymJFX3Fz4tRXiTGZHExqXTBvl/XrO9U24vhYTKMfHkyLGXYicn/ujB4Ae4dRmAfUbK9/GIZD231JV7yRNpuAqWKLsoi7JP1wK5lZTBTf6RSQi3baMTemzBHetEAnA6fq3EcoUbtn0vu54eh/NvkM0ttH8DfALsLPTsJft/4ET6vUCM8IBO2c/CVJjCTuXXPSJ543A9JiMTBcG/1lo9q4zN9w01JdRBGmqO/2W/AzUbfpnzwgpqmT6MKB8QfReJJlyFx4eobbyGmjA7ndIkPUCYOuaFnbkvdUTlkgZ9Rk0fcNfqsJen01/YNjvlWk2S/nX7khqFlX3lqBjoXdd1CrF6Ad+6Rh5j2vrDNzXlMPUqNvTf0u+NykIg48xhED2QkUoxDuOJ1Sg9yT56FBiXUvhszI/HcqynJUB2XVXGAKv75l+G+/m+vLlA133IO4feOOukpntmtSxk9DXRAm2CPB+NQBYKItSlfSypiUjloO6ZPBxJ7Nw026Tv8o3gw1Pqnm2/iBlcZLHsZc2X6iVMAyK+JHCgYXAUgBlFNBiqoAgt+VqulIo0FUL9ZBndGKjeR9oPSf48VTh3LorLGWYlmm3YRnm0tM/jeXQ6hdDvOnOh5n0rWjzR4drV9LtTcAFFFbZTOP84T+Z+yRnysBOHROUI631Vq7wJ5NwDdo0AYYsOGRs5h5RgD","page_age":null},{"type":"web_search_result","title":"London weather in July 2025 ⋆ London temperature in July ≡ Weather forecast in United Kingdom | METEOPROG","url":"https://www.meteoprog.com/weather/London/month/july/","encrypted_content":"Es8ICioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDJ8DAIzoZQify2iOxhoM9fZO0nrfvEF3KOB8IjCrrgv0NJZdgdP5mlDIs4Ylq8TlefkHsQ3/WT+q9RyGB/cM5IIHVaFKyxid9NfU27oq0gc3nDqDdhi5vQI2nyu6JIlX4pDWKwgJncx9DQltHMJOkv91Zp0XHi1fIQxxAs6ox8jlK8CX49HibrJecGWUhiFhZ306RsfqIY83Qn65l7Bo6elkzbnwWMQcCjiYS0AkjZWrb/O1MaLHVewn1EVPF/NadePaisLPpMIpGm3r7axQMl/SMYlc0TRklMJCRvq2tb8ar+NfFQ2tlvwM8Vqonuh1Kb35no102QgVNWjKt8UnzTjft68eRhQDxems1ZTRnDWm7L1X9LvAGFrBQ6ygdwO0Nkjuc9ZPa7gKMhW93nj+02RW9O930w/Dg3TmUwwwjYg/ewGW4F4vkNSRG5ejw3eT9iMGQUm5bz3v5RDuYArQYERq13YYD0Mb4NRIaE6DeYhtqbUjS6l04ITDhB6MFeu8GkkiU5m2B9G33ACnqviT6l6Ga8xhgZevcu7hYJMSA49bNeQ19EKcHdyMIozTlsTQM49fQFMDYF8MTHSh/z1qsfVJ9gTyHKPL1HhIG4jcLlMCvdK9KFWv8FA5PEOTYkHM+H4decQqxzMHcge1N0P1KvOuYpK3SgPd0iv7UR63YNaLTXwcEInxkVLd5YvARXFeTkylZFrFJ4DzGjR6PHT0vFZRScykhlpTGCNGB53F//XsG7TrISk8K0UHTnSo9PZGkNumSq+cResGREWSM0/Nv3exe4kcQyOP+17xO0omHViosjiv8JWIrBh4dcQrNzNxYsNPZ6oOD4hvSkFlDLAhc9nQ2VUrYIDA1Pcg9efgajjP/CpTClMoeugyH+QlfSqBdV7OMyHJUiCec+581DWpYcI1xGkYDOrRoCoBJp6xB42pcKt/mCLMpczRycDSn2h+w0wdTJj53QsGoYXtpwG0ApedEVEEJlkq9/LazCD9OF0q91bnhiZrvHiFL7vlYr2TUVcb+jz8ouTkG7kWDz8+VSeDMrgQmgyLwM83tgKD7/WIXny+lDB5KIGjGrj1dqIcoLN/zb/yfmtOOEegcglYhQf1InC8Tp9RvrjDYwxy39PwKOQugPutpghmIq3uKUZ+ELyM0GkS8nwSRGcogOIK7B2bojsWLFKBF4SPdhQJSrNDJLAxZqC0VpiDWxYbaKN9+WrSSHz4XLFkk6p4kpIXVpOQnz8lSwW+KM7tpUXs0eung89m7QCYdnDfS0fwH42lbCJvRIOGkqOGPhVpeTN7Youeg/Q0doXk8VUcYjjsa+0PSQHzNBRxpa1KnK1jQ7mYsCtTNis24n+tb1k7JKFWiXRPiVIpwfU7/SUD4gcjvq3gxHBy053KfSG7dZE0VaIPpaIYAw==","page_age":null},{"type":"web_search_result","title":"July 2025 Daily Weather Forecast for London, England – Plan Ahead","url":"https://www.weathertab.com/en/d/07/united-kingdom-of-great-britain-and-northern-ireland/england/london/","encrypted_content":"Ep4FCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDFgBEjQXCxaG9y4fbRoM0QacpeokpsfQOeR6IjCYMVDDmLm2idOvoGu/dib3QZhBLWnN9TAK1t+Ho1DdQD2OGeTBkPaB5JwquEGPm/kqoQQr5qT7A1K1NIqw3oNyZd0pfXefQ2tYWT5Fnck8k50JuzbGG184HRGEZrKaj3/yRIXLcBz3lYdGLTxg27qYLsng56N7Rpi5+WrXwvE713wbsdXODGausXl67qwOouWictXSXt67CUvlqL1pHYuizEsiTeeIiWfRvax3lPPO9vhbr+NhnrTZMNNz0LYM0wysv8y4oHgH5bsHlvCOyCbZvUJb5nj9DV/A5moPn3hfNJ4YllUUcB9WxaMyfQFWmRr6+HNJUHJBgDv40dNCNISi6vg8bRSoAYTnGPlwDsmjAaGuODwkt7JKU/OGEbxdNNeyvEeIE96pQ02No20KtLsRo1m3Bdl4+X4tiy6DLEAVXtOuxXrzvuInX1trEOhgZCRGtIqVcaAtXNnEoRyTz3u2weoNqlZdVxOEkGt8q1RG8DDjXYhTjxoQK66Tysk0ZTKeaXIDebqxM015jIl6xurlXGKFgdtiCagADWF2XDV9dRQjvEYxBz/NUFydGpbkOmBgzVd2tr0uJgJ1HvoWECi74WSsAcCS+7tWXAuf8zr2NHZ9J76rlvDfKv03NWED/72mm0EetSzP9gOuf+3ymiPHSJ4nPZCHZx+e9Za5Kac5mnl1awpth36DEF3flzam2F0RKPJWbJpFRzeLioMrjvwZztP13mFhbu8yZEuw+n9eRNgyS8c7vQUkSslJkqDV8B8Mub6F6Qc6lE1LLeDOklUq61aRiRgD","page_age":null},{"type":"web_search_result","title":"July 2025 Daily Weather Forecast for City of London, England – Plan Ahead","url":"https://www.weathertab.com/en/d/07/united-kingdom-of-great-britain-and-northern-ireland/england/city-of-london/","encrypted_content":"Eq4FCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDET3VtLyavxS9LlAxhoMl5hqAD8/j/8BZ1JaIjBz3c4yMoROpo768KsdPE+B+lG+kM9od7lulLr/uQMwAUAXyaewlmuipCU6OmlvUpcqsQThpsNE0uZWlU+3HAEhmqvwOPGCBhWdd9DOwvC35WXVb3xu/YKByo6y1zMHTZdFk8R/hqP/GP83TMw1KuwqjKzj72V7uIMjI996LAgbFRWAU8Bb4IrDZ/gB02QI7VYY9iDrQvG5i4+prDdsHvIjabnGhREP1IBNwPkpYAjHlgqKgbNgmQgozxcFTG0EOY0eilgUrg3wbMF9MnZNj8kaJFUw5PpfGOgLPyW0jez6nVFG12BSx+sJivefttQ5YgyHso0eh2JxCAMXQDqFBVLINwxlBXE/HemQaea4tFkYx4ReQLOD/pdsyhobRE2lgz71WZ2PwvVgXu7wMgH74rxH4ojDUUyrfesiDHTX32AfAP4+twl3/KFiHae49BcS4ObAJyRux9gFEtJunMqJbtwn7pie4azvOLIlFBgivZYIgoUUESgrngW0xriOXLziDZU/XWYJvvNylpesGQld1y4P+UzIPXJmvlfVQwTXN6F+fczGmMk2TaNT9kLNayaCXM7StQavI/cQZ/w2XTy/cFFHS7YNJB6NkokdudwE3jY0B83ZeCye9YYPUEVf6F7IoAmDLsVyijLtZSLCo19HZ0bCFBlZkivUDjCRgjgsxkiTHp8416V3PfD9TinCmUEIjrW+anueE3uy0i8ZyO4Lyv29SwItMlhggi9Zd6MnLITcjvG7+8wZ0wKf6GmaKYhK4k9WPjaKIbVPG/RP3O4J+sfTG9+lc9Ak+Qs02RegkUzwnKLuyCQYAw==","page_age":null},{"type":"web_search_result","title":"Weather in Greater London in July 2025 - Detailed Forecast","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/july","encrypted_content":"EsIGCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDIcWY/BmYo/T6+KW6hoMSwh/dt+3DztiyVMOIjA5buAyaMafaX57PW50yVGPLh6MIeQbVorKeLYm2Ue4qscybj/tsoiZiS5p0dWjcUYqxQVL7pb3Z9QvZ/BduiBIjWF6bWafBAJf72oC6iVKpMLDGtr3nV1w26+DRYOoFA0et+AtAlMA9UNP2EKT+cvDwRp4QUdtMT6oDJI9fST1iOmVzVV2OZVM2sC79QbYCEO8USu0SgWpR+NtLvl3Ryl9MgQCuNfLkHFT3SczZTgWXDj8YcB90NkhrWVxOUygaJ4ISrpT1xz9i9WsQ5Nuta5O80/fXvmTpTpgqcsw/ubhPj4VHV2o1yQKgk+7GjSEDMfmk0GtaNi95FOi0t/h5SVoVB/MUvRViOEdHcOvcH6et57klSrCFFixCNuhbwBz54mkJW5CWegnMYW4vdKmVg2Kz4NCre4VukKoVZxDHgOFO+tn7Cs6b/ZKJtWp03OdA4wsUOdhI2ieU7HKkES15x1GO1fn2MtM9jIYWtKsMlCdIf+Y6vK7bqmV82fymacBTULdZ0OS1CMbkPB/QEXiaBVhIv+4fZ0nokWQOwKMy4BfPPhZdMPamDbTR0y2gfg7xCbeiljJdYXXlRHGbKa2Xs+AvtBjgpNvtADVR2aLDzINXd7KA8LoGgYLh2OCw4WCVNRwH+oBUkmWwbu0lGpiEnZkYOUcihwerT8tlWElLJfJIPxMuFqS1pkdsw6u7o9pC5SNgnX3JvY4oXBR23LmJC+dGP7WglnqBTpMVB9t8r4SY3Xp5JfIm6ROj1AbIqihBzwRquMyHDuFhlT76HjXftXOLrJSlTl5Ix1uvnBF6ZZD47h9QZPKMXnB+04r/3Yj9qKCrLOdLBlhRGbwcavU25m1+wqYhIFMAx7GlwkUR3PtJWvd7/AZ5tDKkd/CmJ6mzxwiFMV4Sb7EKSZGHgtz+9uyI56UCg84S/EgnIf5RKMA/crrSy8zSqWQTMvCBk13Kxp0sXGClXgFaLq9FeEbIOA8up2NEd7mHS8Y8XoPoSdSaJZybh7z/+50GAM=","page_age":"1 week ago"},{"type":"web_search_result","title":"London, London, United Kingdom Monthly Weather | AccuWeather","url":"https://www.accuweather.com/en/gb/london/ec4a-2/july-weather/328328","encrypted_content":"EpsCCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDOJAHZlgvMTORnSJHBoM7yIh79I4sl28L5gmIjBuwkfRJ52rK9jYAKjyzgbTBxrS35nTbxihhHcG7ygQe6FOwRi4PW2RRms4Bfe5QwsqngFOHcxwWf2rvf2Sic24KxMQ6ekfhiaYVejcQZnUnTON7/a34lz9X2LvrR6osSwNkHJAb14/g4+1L6ZIW2Ghc5bdKcpqGR+j2vOvSqwMp8903kQaJMcay0FGq2Ika8d5wALyODzj3M7fvMG0BCLdRfUHdfIrUKkuWrnbsBg2/4vVtkfSLefpYbYE4NjOQAxYBq0lXMvTOLt/am8wCDN89hgD","page_age":null},{"type":"web_search_result","title":"Weather in London in July 2025 - Tripvenue","url":"https://tripvenue.com/weather/united-kingdom/l2643743/london/july","encrypted_content":"EvsDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHaWjliDdJC6bSyjOhoMSOI1ti3RjJ1R+vOpIjAQELXrMMeCXfRDCArSH7Y2+se6c8Xj6HxfyGxyiyuQxgzKS5N7u9qXZJKW3JVHKRoq/gI1aaSWmIl1Md3dQ6fJfZVhe29siiR6lNukU+7LnxI0a610ED/P2L51vQ+nFR2EhKpknuNZGjJaXZAbHPJ5Y846nXTv+51zaiY+f0OOVm3ZwpwXjTq1RYMnt00v9FAiMjPyu8kibFPRcbt2dfwzFooktjnXRFG5fnFk2A8IIxltMVBe8eZpmsMYjocm1DSYprzsj4ijjv8X2lCiB+opBiC3hS8jfVBm5SGNPvYYVzq2yzjsYaY1gnFIvtyD50rDi5p+CPmf3Ic7Y35FaKJQaruBjHyUNwtenmDFi4C7urxlLdJ+CR+xJDaeemeA9UeOqQXB9xSMDkme5oglxNx6HUrQqyADhtADVBIrQN7mJFEkSLJI78L3HhbRiCmOUYkYAuPBAkg8Oxwr3PBM8pzHGqgX+bH4tov5tQRslKAZMq7FQpQD21sD5jzl/CPmUambpMR4PBIhIrh5GX+XEEGjrVkFzIG7Ovd6Z+vtdjDjyooycEGW5rkdZk/KnszVJHk+GAM=","page_age":null},{"type":"web_search_result","title":"Weather London in July 2025: Temperature & Climate","url":"https://en.climate-data.org/europe/united-kingdom/england/london-1/t/july-7/","encrypted_content":"EuAMCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDAB3QISbZGkgUNFjbRoMDyDNzbgYgpS6t4oUIjArzn2eFBi1SeLJOlkejhoD5KKeMVadfe5vpubo/Y9nTMzpiA91EqAnw4KtC9Aotagq4wsQNbBq3KlP/JJE+Ga2V5/JtXItgE57RLz6b6sf0wHFV1/IJZEbByo98IUzoNnpZh7JauMhyUjabN8DyR56titvCZjuW/DSxIGD/QyyZWNPqfGnDNoyID1ym4AnrbZlgiPwaje0h+9YjqWXiIpATzA54ixkLLZdfB+Irxd+rPvK2tQ3v1JP6AxDgkqx4D0eqOmxdvSGfbD2bfnjLPCPBv96JbaQ2KUO8fEAOyIBs5oyxZqmuw4E0kpbSw3xKALJOrlsX1eJev0m3xv1HqdwxIs/PL3KPh6JkrCVuuH9WbIHB8zDszD8j2Ht24lEawAyUeH6XThkYJxzNg5qyRfRfebDeR+u1H3njlzYwMpP46QX80xHI3VQPTVqGG7OB3Dp2sRwElODizom93wysTd+viZZqgEm0RCCDn3DNTrkmhalICP2v9/4PGbIlAqZXst6GUZvonDiamDWJnBcEEy0vH31Rk+w5+mxN7otsuDG0iRsuL0uXv5V8vsn6hpi3JJgqkOqoCOMt0NJi2QnRoHbxD2YJ48O5mVfoFbGJn0yVNOJ+qWtf8S4Lgcr5C8P9hMkSA8S9GTzb2uDg/6xf2s5AF5KHPGqQWimTQ9hen6FsnnbO3fCBnFKBMd/OnhUMCJEKVx6fxOJw6Daf+GojHgwdBSEPnA7ARl7j/sWIbYbfaOGVQOJwS8T+myEffkx2vsAAM1yNiCezli5fY70xl0EB91ayp0oIx09noMdgHAf7xN8sbcmf39gkqoG7hcL6iKdtGtkgPO25/DjsuQ6UC8TKAxr7MlxZSJ10s26/Yg/gcTonn/BE3X2kymJD/2qZjJ198PlCdGx02toVd2OasOBW2SgUJ3BsfjvQri/kqhO8tutgSSWyyApvusED5dk1kdE2bwzEB69aevrvfCSU51958WxPbZi9MNUSP5mwKUBbWGe5WgcvTZ9NXquDP0NHlZS6BDczRsyJ4GqeLnSDaotxUj5xz0+1mH6joNcn6Ip8dXYxeUhqorYYSAv/MpQ6yjJibEbEXSo8E1U359+BVrV0pLDn7yxSTwZPNkfw+AyVCY0kqgHazwHv7llJFjTfz1s+sE4ebS5sNkLkrzVEQNenVsS/73qo2qSTaq+R8Tr2Me219DeIi48Dkmzfbqx0zIPLLBy3EwGd/Rd5dFouf6cLgPojlp4zVDd3JEhIaVwqJW+hFe/hMr4/Ulv2rxpp8WFrA/cYsaHZAYXQrdQHhPmr+fUiqPWBpFQvqlSw5F9ZdTAcqDzyD1103DCTHEuDwyJqWnZYIGk06D93GKIKemZUKdGVBdAZV9w8y8RPs8wuBo3BNLjX8VKMJxKLWWY17ww1MLIpnJ9KOslrs+TiTPmZmP/0yYjaM5i8Rc+kFyoxXJ1/8mtr0u8BUEiVMWxUCLkhlOhHCPGbnHlE5G+5Ki48KKx/rL5CSaIVrFKbw+z7eTUDZzkAwsjetfLWZYAZwiWrHimasLpJJOqVo/rlFMGajJEvFGMwItmERpHVDbS208mPDx0U9+CTU6g90vFV3U3dy7wdP9jJxakKBzHy7ruvbSWanWpNCS0F22epiawlN64cIhuE+GKYFIW5tELBtnf9xKwYadH8pJs8kPTxbcMESVxvFVJqIHFYltX6yKqznrZNKScEQEnQEWqd20GuTnd2M2Jkt17n8Fn26UajIwA0ydqhHUbIXZhdtBPMPjoozzZlwTPVeBjtrszBKdHfBP5gA8PwUceJf+o2xk3ksIotZiPm7i0FLXiobBo0airfS22RdNMzlqSu2rqoPKoEqtG44GmrsaBOvONU7PEqZWXCxzUBXZRaun4ZOLMCPLaXyoy3OXYe47Oobxc7ibACa+6c5sJpAsd4bT6cVimo4JtWCD3eTmcG4BtenPKdUJPBcqFurxbH0ngkLv8/6oo1t03oeLBq2+7o1quGdWn3zu43q9GK8m+TrqcVIEHeN4kcl14rVZECbJEg9skKoxVbLCjfrJ3p4GmFDq4cOgznwc+wkEEyqkCGAM=","page_age":null}]},{"type":"text","text":"Based on the search results, here's what I can tell you about the weather in London today:\n\n"},{"citations":[{"type":"web_search_result_location","cited_text":"Enjoy moderate daytime temperatures of up to 22° and cooler nights around 14°. ","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july","title":"Weather in London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDCHyk6kL8U8lmGCJaRoMDbe2M3NqQEllHkqwIjCgsIXzY2d8e/Xqpau4F9NYKLkDv6o3bNENb8Oc3eb2kh3Oxv3NRPcwGxbD06BGAgYqE8LbS0rU91N48tJVRGN1fKie5u4YBA=="}],"type":"text","text":"You can expect moderate daytime temperatures up to 22°C, with cooler nights around 14°C"},{"type":"text","text":". "},{"citations":[{"type":"web_search_result_location","cited_text":"Ideal for a range of outdoor activities, from hiking to city tours.","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july","title":"Weather in London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDLGsSoNJyj5FNhBaGRoMeAauPgDIMzHclI6HIjAuVqPJ9X5XSZ9Qa7oRaKF4+8h9rJN5MH8VJomrDwpbN/k/jca/zKcvXfynP7J4Y/IqE49oNW2ohCZ9A1rmtULpuYcWFgoYBA=="}],"type":"text","text":"The weather looks ideal for outdoor activities like hiking or city tours"},{"type":"text","text":". \n\nSome additional context about London's July weather: "},{"citations":[{"type":"web_search_result_location","cited_text":"The average temperature in London in July is 14/22° C. ... On average, there are 5 rainy days in London during July. ","url":"https://www.weather25.com/europe/united-kingdom/london?page=month&month=July","title":"London weather in July 2025 | London 14 day weather","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDKwDfS3BMXFyNdovMBoMcMqRonwrgD6Y25H5IjBL5iu3re3072gDE90uazBE391Z6GGXW6Yy8CzgxzNlqMt8/YS9YAMf2YUDNv0kQ1wqE8VeUlithD8m7RX23Vs6LM5Mo4MYBA=="}],"type":"text","text":"The average temperature in July ranges from 14°C to 22°C, and typically there are about 5 rainy days in the month"},{"type":"text","text":". "},{"citations":[{"type":"web_search_result_location","cited_text":"The weather in London in July is good. ","url":"https://www.weather25.com/europe/united-kingdom/london?page=month&month=July","title":"London weather in July 2025 | London 14 day weather","encrypted_index":"EpABCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDH04pnFT2LYUSA6fvBoMfeqU6c7k7N8Hle33IjDJCwj+SZ/DEM5fdLVMqDGDDyfausyONl+dMNxtyZeGzCwxhZd9XRS0ZPixeoRWlmUqFHRNeL0JuGDKC8OJZEzJOesJ0wv2GAQ="}],"type":"text","text":"Overall, the weather in July is considered good"},{"type":"text","text":".\n\nHowever, "},{"citations":[{"type":"web_search_result_location","cited_text":"We recommend that you check the London forecast closer to your planned date for the most up-to-date weather information. ","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july","title":"Weather in London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDJrvNTezHtIU6yx0dBoMIHCk7E/9H3i4P3fmIjBXAQMey2A0KjbKYvu96ylLiaZwxurgzXOEMnPIlmYklGRKohXChl/HAWr36Ewmg80qE/gACzXBAWcPGVBKVC9Viq9xDa4YBA=="},{"type":"web_search_result_location","cited_text":"We recommend that you check the Greater London forecast closer to your planned date for the most up-to-date weather information. ","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/july","title":"Weather in Greater London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDAqgsl+FlD6yXVzpKRoMPHGbCGt3gjx/CqB1IjAm8SxkTUZIF72iTx+xU4vK4FxzR6mf7hvGUyebFrJPtcHSatCKMbuOQG+kF35+SUYqE+5oC8tTnAWoyw+ebrPeLQNmVRMYBA=="}],"type":"text","text":"it's recommended that you check the forecast closer to your planned date for the most up-to-date weather information"},{"type":"text","text":". If you're planning any specific activities, "},{"citations":[{"type":"web_search_result_location","cited_text":"Explore the daily rainfall trends and prepare for Londons July weather 💧 · Stay informed about UV levels for safe outdoor activities throughout the mo...","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july","title":"Weather in London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDFnB1C1YcIXCfiRhKBoM0avUdm8v6tOD9X9mIjDmLA1KRjvEiTgcLwTFUFPEO3hmkXyh4AQRImoDsRFFzk2NZ+pmQsZX+2VLFNolAogqE4uyZWuLR0UjKI1rL2xJvMhQijMYBA=="}],"type":"text","text":"you might want to stay informed about UV levels and daily rainfall trends"},{"type":"text","text":"."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":8962,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":330,"service_tier":"standard","server_tool_use":{"web_search_requests":1}}}


================================================
FILE: tests/Fixtures/anthropic/generate-text-with-web-search-citations-on-followup-1.json
================================================
{"id":"msg_01AH3Gu6tDVJRnnSe4esSK5N","type":"message","role":"assistant","model":"claude-3-5-haiku-20241022","content":[{"type":"server_tool_use","id":"srvtoolu_01SYDj5dr2v3W7SPU6owxLL6","name":"web_search","input":{"query":"London weather forecast today July 09 2025"}},{"type":"web_search_tool_result","tool_use_id":"srvtoolu_01SYDj5dr2v3W7SPU6owxLL6","content":[{"type":"web_search_result","title":"Weather in London in July 2025 (England) - detailed Weather Forecast for a month","url":"https://world-weather.info/forecast/united_kingdom/london/july-2025/","encrypted_content":"EuoDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDEwiJ2Hf+z92Sc2XnxoM8BcujcJA7QOyZYYxIjD2AGLW4bE86Y9c9/HbNB8IOYmG1YN8+nbKNlNMGFLr563vIqHp+oNsafhnG38gVxcq7QIdHVxQFauH6TiZkri1MKen/lSvGCIxNs2OVUI26jXKbAs5XUX+0tU1LbQlOzd3WtsIvsgi9eRSp6n50eziNfYiRgY6CzlR8ropyf4wiEtWhEuUZri8t9TdjA1OCFzQDTLtscyDLEABaqOEJNsHYEcy5aOpprLJl6chwDBKyTpE+Gj3xSU/OYTves23IluNNQmMqg9zPkDquRScTM7ud1UrnRxSg86soDBsqCqGXgVL7YgCCP1m/xdAp4RgMVW/xf4RnHVMoBakyW6BgAPcXchCcYpkL6vwBhBJAZuLWXIQogtvTY1uYgagBjz3OxGaXlB0uwDkFrng3MusdfyyWC2ZPUsjuaJvTxKa6AjD8IA3Hrv2xBC9BaAlsJWd2OHnbv0afaOqO8YtCUASeIcCZ0rFMrxGZsQ0u44Rh6HcM7phizGVlGwKlZyFjeGQ03ipNd3v2WxiH8Wcq38Penq3TLX7YgjaOmMwzDl2b42QWRgD","page_age":null},{"type":"web_search_result","title":"London weather in July 2025 | London 14 day weather","url":"https://www.weather25.com/europe/united-kingdom/london?page=month&month=July","encrypted_content":"EtMHCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHh7X7vHnMZ+IoSODBoM4hiaolb4wiPK/7X0IjDNPjO6ixgyyKfYSQubs0bGiAXKnOCQjvoKg/juqQSm6wen1f7GWDz/1vGNsmyjcRwq1gaa6Z7m6E2kmWQ0CkBAMulPVc0bCHMlC65wk86I0VC7XZCkd59zXOjn3TG2NhiUeOUi+GppGzXg8tonOJzoxWKQEh9G1i6H9X8WDdBe+kIjjhp8PMvGraiwnux/WRL7v98JU8QD4dDVqlSTLV+Wqnk/OrV6/mhdu4D4gUfSb3DEryoVJs0HqDIbH6mt4WtJcgFuVtR8tBLbjZ54u3bl/Er4GGv8pTWDWLcB4Hg4+Pe9jJjWlfEvWaaE1oNHk2qwKgAUmW+rdfuGZjybMFGj0ZpL0N9s9TEQ73vXjDBfw4aBmrgKZxl5zfU5j3Gk5O6AKVSTXobKodZmepjnjJdixj1ao7iZXWrtT+Epggzovu5Lhx40RDAgKm/Yxf6xSTIgZ7bP8Q6Y/YjqUUAnd0SkKsS6zHQZ5v2hFRAYRLWljazP407fvzK3uR+vK4oHI30U6l/Qlp/+8vlfsYOwCGVxSwF7YTZJv5qICWZLL25IwgOfHOgDCHjdXRCPeKmFNG9LjQUmHV9ujWUYD9fKcPM93AXotBlflA/fEsA17DP92B+yy/EYJ29dL2Tjpt65p8gbB7rC/O4zDWMrTbOuYIfiTz6rF7yJEdYb+NgsVFgRLLQpANQWo8EnyByV/MVcuPQplUCX/H9BKclhE3Sf5sGMTnqz+ijgqLbCyR8wmZwWemRH/Xj/DVE0uPikUd8qzwtJqPrMwj3OVU7mBN+ho2WhmuDKw0HQ98GVzzLYEBUncu+dUSVl7bsVrsdZ61HAjj3bs9us3CKwry3RczjT7mCoVgXV8KwBkz+bQ3eloqa3FSEXgxx5PjfVeD9P9zdV8SVSkRdyVckkU0OeZuvHzCh0EJzpO5o0JD6tucqEo1sZLydUJYlCL2NI+rVw9JSceRym7Vd/0INfhd45ah3mk4jXQyx1eBs0TfBaefqCMww1a0pDL5JvFpvZLTyuXa1VnilK5OZiRS00X/H2Ex7JbApZFrZLtZsa5sPFnLq2KBbdwT+rfGT//4L6FI6fKCzw8aQiSM+3twJPzAUJ6KvZ5sme6JXN0XCDHzc2l0BTSV0otgSHXd4uyxo7VITtymI+J3KWjdi99Um7gEZ13tbbhWMi76rsObIAeZCcbAT05ts7jIgnPiMuwx0NBBgD","page_age":null},{"type":"web_search_result","title":"London, London, United Kingdom Monthly Weather | AccuWeather","url":"https://www.accuweather.com/en/gb/london/ec4a-2/july-weather/328328","encrypted_content":"EpsCCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHV9cVyMu4N7WmvX9xoM+cBpgd76DOWXR5PpIjBFmk/8tVlszdk2zpR2dCfaBUM5iOl3Dx5wEyCOY4eZGKsDVIbRvwOIM2D/8pUc7gYqngHl924PdgZFxPAyalysUFekdxGsb1xTLkC/byJcY5KfDPzjWIeyVWXLLojBLdRbqK3og9S/BReZjOEZs1821WahK1K/6gT6amYv4uPPsI4tfRtdYhE8onIcUZPKiNqZQHIGrQB0MZnK7G53cYgjDNUgRaz+ahLTMcSqNjpS9sq+IIacBCgg+Ju5LbFqBhTGterdHTaZrcX2gKoUNhlmHhgD","page_age":null},{"type":"web_search_result","title":"Weather in London in July 2025 - Detailed Forecast","url":"https://www.easeweather.com/north-america/canada/ontario/london/july","encrypted_content":"EoAOCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDDlOyrfVI3f5tO/4HhoMU8o+uK0roO8LZfNUIjBC/DB/7dM71XNAxiy+6fOeCnMh7uwxIglkSr2mLq3nXI4HHE4l5bX6kiRXyfnlSNMqgw0ZROxBYlNHwg+kFwD56CMp2CzUprKJ60jdowVMcWX6GJWbYM64eqqwj23+WGgofMPGT3MnX3luv2W3PkmrDsneLggeniBn7eVcnuojIU2aqvp1ISjdlGVCCdf9J/GQFIRJn3bW7KXC5IRP0zXAB39xwtGMzGPWTUaBJoy8tUle9qPIepEzKU2ggQy6xAjRkHxjti606FaRqUX3fo72VhNP/WRwblbrLb1a+uvKbE6KYk4vvYwsyCs2XjxiUPr1LuZ0eEFk2kTELGkoDSnbwIFBPjTMjXsTTw92xJeI6qqcNy9/TlenUFcRpHTrvVvSnBHkGEuDua+CFEyqMBEN+Z1nyHHNL50E5watRj3JVZp97aRgmYJKf/YZMS3m5/NGrGEGVs2n7l/41edzTWnWRzJFUGKnHWT4mxgNg0hP3jePtCzdj8W+0ueFgGwLUabRiLmXuvDmnVy3yAzWv0M7A6yAlqP2lrBDouaYnjE6vwm8zyT/bQ/uOuVTF0VPbaEiJUhxOnEeFdkEcR8iX8RdIqkc8NwWxCYtkciV3fvUDur8k3Jdx2/eyol6gxe+NPl0osYQqCo+shwFg25ecligKXP+/+fy7jm3VbVtqSDnHTLeLft4msjXhetj+GBgWd+Qsx3kBemqBcXGqsG1IwiB4L3c3y9qcy9o6A2pfiRXoyj6mLOu+FxppKdkoGYArKTSpfc7PBY14RCapLRBFyGnOYba9G4Uhxd6zJXkH2PjPyMJ8sh+LEnHrgXdjGxA+cY0jgosmq+X1XzOivJyUCnqjS91Hu4GSFwOkmulYzo/lKz8n5aGzcf2bBLjp+ipLCvv6kPflcBqS9PRA8QWLQkrxqMLJvZPhFhoCBCX1zmCHEJB6FzZFE7LAMMDYRe9K5iTL5k7PSG7DMdEPJ1DGxk9jLByz0GQgVlYWVC5QB2Z9aO3YPCyFk4s6DV2sQYnVHGCZvCdoxZEOQgf/vBeWmMSFccovOEyhbN2x4FF1q6XcSZUy9X+27V5E+4ooTJGwU3xbMyVGTbs2D+XbEnGHJaRMhw66huNVvFssaFwSmcGJsH8k47hyr6+oWcBs7ysr78o9DzRlpwBg30q1FhffmLVhxebotXBG1fhzX14ci+O74HPsLF5Owj80IE46IYrs83KdlyPC43tQ5yd0ltSc9mBugDoqLAZoRvC2Y2nHqGa3gaGsUuCsNqtXgCCtvWrpW+Mct4weMd6fbideJ9ElB4eWfK0ufgWnImbqVqsKt95w8GRgJJCqNtTtQFcp9FJFpY813hn3C8zoWW5hQXfwBdpqANzYwGLSBq66iIEYL6Q7Rxb2skEmu2O+/oKY356SW8kL/6VnB74IajxmG8iZ3GqN/PMbBabxFvoJ+rNHK7c9orDnClRkBum8tZDruJjU545XS7xipHb5WobQSo8uf2RyC+UXqBviJOvEvUV3bonxce7Kspyv0SyzEjAsVT16Wo2CxCedjGtKdU/X5egQVphCZlPFhL5cy1vSOosrLOIXsjss7BVczb+bEgOwaoFUgrXw6V23zng4yFn4i4qBFVSPY+9Ifmt9lB/EQyzF7SNUDX6MkftPvNWjfDDqPXwLj+/ydrwbJI4X5RHyodPUj/USXtG0TNQ3XE2TAHR4UWlTmUFLRCC9HQnbFhOWB4OkqFjSseIqKu0aw97KWzIJjBYItvt6wTpAvQ5tla0gPeZblxu2Jrg7GJp1LD58hOPJ5DjELDgY5kbS9DiEaxNnBaRC0TUA1L8XdgPw11X4ff4bmr6d6YgjxxanvhT1FSUJnSPJ/lh5JcKWx2C9F6FWu0gDQSQzEJ1SG8Rv2U8ECJ/MXIPzuR3jjYkVxBl0B64Tx37laNve+ww9aDcjN44u06b9CHbTOoKkWanIEMGLYC+xnNO+0CPaetVIcQVkUxhaKF5XjY4lXQEZq5At4lPmmJy+wWSP2eApIAOr5bAe09jZWjgJRbVm5S+YtDCyVTyWun/z268+v050oQPIQVe9pnV8/mXSfwbibL4hHLEmAbgY0THUOIxpNrB96YnjodIWUNv8dchi71EKYfvHnQ3K5rNTcsAnCeycS0XqQJFRfBllUAVq1J6CSbAsn2/Q11yUcr4fiLWRmmBBxkXe1xbqRU/pQuSWxd8ukJxVrghthMpg2k9X7yY8fkaGYJcEHLcccj7nyUC14P8Yn1GTgeptAVerYTLxNe48MmW+49eT4OIYhfSh93mJhgD","page_age":"2 weeks ago"},{"type":"web_search_result","title":"London (Greater London) weather - Met Office","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","encrypted_content":"EqwDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDKFFK80sRnkl+QpXqRoM/IuhNQ/++Nb57y1XIjCLLuvWZMWbpaO2MpZoxAAbrLpAEEHE5MaUiuW2w1AaxJloPCUMhBVs/b2YXlbrifsqrwLpsUR68NILTlkdJX8pYl8l0vtFwfM8VmNc8eYb8MhLF8QRgmFVdju0XFv0lk5BtKE9n9DfAqK/s1COWLRfnFLneYine1+ot6pe/08NtgGi3Z34bPEIqp0uCbFP3GW2eJp/jnv43vI29TwNj+YFEEHauHqOeTFwCie8iYKMksl7HHVf7BwTtPtg/0iyBE6nmmyZMSBKqxVJAeBSzTR5aGQjGJe0+CClza1yJCYEGtLSPl4JakFNYYcT6kpNx3hG4nFRIgMWH1iZMRP6GaQMeUq9m9GwKkJ8v5i60jWfSJsY8D2eh4SATmAbM6PuryFZIFS55f0rWu4sQlCkWTjE0jhFqFY87n3GqhkCxyk177Cr7xCVQgTwMGfq+ZFnH49k3bBNyKCrThg64rzPMg/EiScYAw==","page_age":null},{"type":"web_search_result","title":"Weather London in July 2025: Temperature & Climate","url":"https://en.climate-data.org/europe/united-kingdom/england/london-1/t/july-7/","encrypted_content":"EuAMCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDBmCPvoPcG11sCQagBoM+Fn2BRkLtodTeIqBIjBHyPZo0LiQLzpzxRT5MRs0THYRYBtl0+FxfrFGsxm3j763OGZkMVPzegD+UzqKu7Mq4wshavchYkX5/48jr9tpDCOLqNFXtam9sEzt4xWz8m9Gl7AR10YNllnyCkQkGHJVqHzLMJHEA4+yShymx9gsVuPlyDPpldaYAt3VXOEbV9gvoCI2UFAK5Jzys4QGhjvhkd9Esra8YzRWGO9lR8Ld4Cep1JOmDy7VfhdK48cVVoy0DzyEgjOaxVT6Nzk+aDrF1nM309CqIp1a5PfwrlzaRimFD2WbsKBw8VE9HKbtdU2FlIYLB3wg3jdC6csocIRFNEj45weof35G9PEV5tXwJw9MoqA8Vr33hz0OATg0PUoV8h1JYyv8RNsG4OcCkaN5ar7j6CyCT6QC6SkqH9jv3ZLa8DRkUFWs1na6Ir6fbmKuJjVVmZVSRBK2k70CVvsnxO7s8i6XFiFlYOoi2J0j+17XNamJnhd1o/Iq9FQ02tYSkUnQMbJWLuaFeo8AkbtLCvg29FwVmTzPygwny/lNF8Zx5cqIYaFZqS1g2e33Tl4vQnffiXkc2kr68EGmUsvItxb0CQj/Mrk7+E0Wloh+t/Fj2XdmhfFPil/yIxrVHP67OzQj4uNpbq9TIMAdc/qOM10fghVTaxDR+MZWbSARPAolSvHxuH7HD8MpPBgDPLBfrGhOEcDc3FCk8CZOZ9v080bt4Kmuabp7aQymynOBRhxcIKaIZGNT/vVKU0XzfC1QH/kAbmOm8GR9eJLFCOQcRPRVsxS8kQGKFQM+11iEuHtQHlGpU6llQy1fXQHVEJN0PQ98qVaiy15MzZlyg94BM1hY+Zj0mrKiEGMwbdn8FaXX3zwyKRSij1lhdNRqYH7yzwtiGZACTMYxroQ7i11Du/uA1ec9e49JPXC51If5u0MKMCwCB1vmt9GI4fvP7OeMaSyTbHJjxcnJyN08KJzMXqC9DDda3Z/AwzbiUf0szV7BhO7Th6y09GOfxdy89ePo7dGLOtLVK0q+Nav08fm4VaXw65mV4NPsYrHY7S8ZwpFEaicUH4rJ8o7DnOy6oQzFzPoeyyYp4+Tm2Ay8XxrJdYDFTJp2OrH4+pvcQTwI+ZvqiP3Nk1cHeu1mkw2w4KDnSvOHe8OiMuQ9h7JtyrpoRgE8rL0m6mxOuI4WMVF1ijHBMzULMfVDOrNbuRm9Kl5yKqzP/KIOwAWTy6w3comxVgawhYvVhINLRzRLryv/qxfW/os3EEoYKQ8Fp0Ao67L3L3nS2HxQw7QOp+7KW5wdbu59zgdjQwyoImhraA2Flw/e1BUrhEqGvaJzunDmpQRDG/z1K0wz5nVjvn4WF1br+F9orocNRPnGnLvaS8amqtrKzVBTMM1Xk8ldhK6n6/djRudIsJkDJarePglQFgQ6BbiJb1OSTsyzdEg49ByEgI89hoDF2u0FA5G763pPyGFGhiLm1EeNepqjmdwAJ6d3xltPa7bV0TKoP4z9L2vnDvx3OexMgLVRS5uBN+TZ90k6rvUx3jv/WXoQSyUqP8FVh1SCEzaxkFKIym6Mkbo1o+9j1lk/lLAPi6aMe8/XQwaC29FECdNhyz/HtbaRO2CEKun7IVNeqkkAG0DCvdngmlbbtRE1UChbqFCwpwf/ewWG9fxw2aJnfXoxYvtOUQ8GuqVjeBmypyb6Q3Xc3/xN7IlGeFk3SwmsV9CNp9E1uXlbWXo8oBtDpseNjrD3ETAjuSosB/3bhvBRuU4ctUrhJwhiSx0eMc3ktQ8l0bP4Wsj+ZkrR++Z9+Xb1zTIA3doS+KzrTSzXWKorDMq8TW8DqykW3r7J0bTnuKpau9n6vSakdvb8NZK6tYMlN08zEMKAUlXdPCDTExWeCqwIICNW+E+2yjPlcAMmXBk/zzt9bP6j74YnnPOLQVp4ihx5udLS9PsMi+zsPV7xsIK8sol+ELvudmEoCfuyFEIup6lp+uK34vPGSRu40oni3zLKoAItlfqsaqznaMIRFHxIqWbvehTrMQjsuMRxuqmTJ2dQsFPOSAEusp0xnaIPXLK0VBT2Vln+QP9gHXN7J9OLN6YrBihK6YsTGAM=","page_age":null},{"type":"web_search_result","title":"Greater London weather in July 2025: How hot?","url":"https://www.weather2travel.com/greater-london/july/","encrypted_content":"EqgKCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDAoD6Pq2KvdO2D6GhxoM9+plL6BTynvkiYUdIjBISWIaE1udHKtZSBZC5qepKQ1DBCjw90ZrNyKNpkqoG+TDwsvboPBL4nu5TQRQZ0UqqwlApSq0sK9OcqR+feHz9vOsOR45x0445GI9lEwPiRv2+ASeOFgfnRsAWn1BSez3wdyjUr1qKmDe5pNeXBjvZofQ/Yw+T8+U/+RZf6GkNqSq0kjXWxucv7oL8BvSnf+AecbcrCUlIjpUaboCPu4t3l7zznB8F4sQbkg1EdCVyPaAcdZdql1E/t5XkKy4SgREwDFZavXt+wVi91UYUGRxF8iao4T8Fb8b0gZ+itIgUFGBjis31HFZMyPRMc5HYuatUoxZlbmOyZZurgAJtx4NYXppaa0jhCkT8MFlm2dQ0hQtwwigBD6FPa7nHTAMId6t4j964dypHpFvlbK919lh7Cd8EN3CVF/pX1rYsfTDQ7KQqjAv44UtfIz1GjQbTE3N/emBtxqbYDeYHeSLWndA8ysl/mgzAvbSVaUnkkMJ2hBuUrzNUrYyMfg/VJsLK8RqyGIHPuaWY69BFSwVgrYWI/lRQu79AWhlHf62RDIKqEsz0jW6wf0/MBqn2RhIpEsS7dgVfKH+ihc31bsiAYhoznSWz7MtEK/lxKDVVe7HLvf5PogmlKf7X9+kUDeBws/UouOIU5EejwsJ4It1l79CvVgq4lX3HwMVk6iZteDVnvg3wFBiodGhE3STudV/9bjGyjSiceYi4chGchmkJWXIRVvPdGIgwW1AZJ6lN1xiDYMFaDgu25yyuepWTwU5gNZxluJwWDw7ZC7he9+a0zif/EwMCkVurnOpaH1veSqiAQ2pBgb0XHl+MrQSHU+242xvu+OSACDYkiFdOLIMAvzR/Jq6QvvY0aBDqd8DF9+kSL0kPyilA2SSAkZfdo/vDUCKz4r4twZcUcHXA/fL9vvrRnQSBjPl9eDaBkI3V9Bghz+Nf6p692GK/yIg6iW1mIdDia1kty9Ay63tMUEVrJdP3wDWaO82kUWG6nUdCTKLONzH1oaPl1GK8WBv6IzSHsK2ej/dgJJExje7Z+ZpgRfx6pJ/2CnUPmmD3pzgrLXUvMUP5VJQMrEId74/uBpqNYxdbCEMzTHOprmQVtKovAbU7DTj65/CZ/khYIFYsqY8ZbgQz3CdT+Bh1EdHz2hPCi6cRP2s9OjP6Oy+GZ0EsOvmZ2gsxIHALSMgVKgco3rh3LQHUS548Gi/YpStVmDgjt5kZ+da7vJdx37sOSlJsVwyNVSwWQ5/FtyOlmj0BIccrLgOSyGUS9XBUVrfDz2A6+qk3noQ+zTICKOSta4XPeeMIQfcYIPtCP3zPOaQ/Zz3Yo+vKujXsGFn79rkFk4dZ3tYm9xzQyQgk08TRU9sRWLI7t4SpZa4H9pzpfNvS055z/LwsmoaalBlrvo++6O7jEsKhVHGcrsmkB7S/gZSJZMHpagloNmTugt8XW/QRP0H2F516DTvl+V4GCCCg4oYaD91OwbAD8xEqlTeO4dG6B9VuR8mWY+AChxbZljeoiHeYghXYGboy95/0rxLKYxeGuXGURaCVPs1+bpw/7ILNRdWAvNYRn1ebpOTkEBTzZWSXtaoN6X+POq3tfVj1jvli+1KxXVyfN7VrYZVQJTteNK8uhQUMvrRXFTbc/ORXLPY3DubU8ZGAZf5qStzq4GbGAM=","page_age":null},{"type":"web_search_result","title":"Weather in Greater London in July 2025 - Detailed Forecast","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/july","encrypted_content":"EsIGCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDAQG0zaQ/qLZ3vqnyRoM99nE6HFQ5MTMVfKRIjAqqrM+YmaO62ifhXkfctRUXBkW8/UJXRql7AfpWyfC40sjzofEaQj0wHZbuQ6XfDsqxQXnN9Kz205aXEkFo7mw2VXfGI54qZbaVklGvoKzzId09yRts0XUUgKqjzBvtK6T9oO5e6KkYc5PB/DfYaA6Xk78+qfUs7oQDnJ4C15eptSXbJu1iGwXMSxV6P7fKfhKL1UipaqhJ3H9RKhjg1NsP8/CCP0d+8lMHvfFSzOrpqUybcX/UcjH5zhGZm3oPTbsHBiasFvcmB2/QFAAgP64iOd6GT0gUMMXbddlZq6fqlDUHrIBZl1X7RbLE6v6I5lTwYDCC/yYLi7DbLHUu1N91NoXR9LDUgLYtYmmhIO9pFiQUTC7bXCXhI28Mhjg3YlFx+WVHBHnwGAVn2ss9E+Enb2N5nm9anDgIj/2ioSuTua/RsdkdQp3J5F9r82aUZl3V866a8MUqv7ybzwzNhkleNNKn54DJDeHD244cVvYn7Ok06BFzF4IyXCRMZVC1B3fI0/4Td7Myl2ET27lnk6XSQpLFhEyMgpyxjbxjAX/0R5CabM5jO/mziKBThDjZTwXTLDgjAkJaIBTaF07iWgsIiAkGC5cYCDfzcxPo+Jk5hiWuUmI8NxVTx4lQReMb9+TcyTn5AX300DzukQxtOhZ4MlFpR2FZvCfrz8DT+3HQ4lPMzHtl6zJiCmnJwF24b0LqWkOrM2BRbzyn0Y0y8HmK36oYN0Jy0aPjOwDD20itgFTiYwuO8W/EidWPGGIDU+tvvyvIHEdsPja0eV0W1HFngNy5v5D+1FC2fsLkJZGBBDIpRkLWwVUu5ORFafXrqY731GCxqgpHCmM9UiANrpNlDMz16Qoeinm6vGYqE5QYgEIuN8VbK3wyue4yGOHvWGFviglUuJEOk4cGGBohioVQK3BYkY/lJvKSSS2LNM2VLZJ5szhsVTtlyQKOGkLe7s/yl0hj2TZp9F386cC7TTkny3AXXKea4ASnb1RHvv51kZ18E1jvc+ZGAM=","page_age":"1 week ago"},{"type":"web_search_result","title":"London Weather in July 2025 - Temperature & Climate","url":"https://www.makemytrip.com/tripideas/london/london-weather-in-july","encrypted_content":"ErocCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDF+jpf7hD8WW5UPFahoMEah+Eld2+WPqx7QXIjBoGvUDdXXO0nU4NilEId/otXEVdKiGQJCm1II+sZriqw0SuWaRxXTO55FpBRC5kTMqvRvI0dLE1C9wNiVziRsUgcBEpgnR6YXHoxaVmyl0zVbaxaWpTEkmWg3MIJ0NxLE9ZzEQm5iDRgQfeZRde5lTFB9Jz/LcaaWRmigE0k/RrJTaMZuJ4y6TzpRC3cKRog/vhll/Bz4VrG8M8C1X50obZb0O9/PCfMM00O9/S3mP9J+Fh5sTNoZr/r6jHb44u8YJ9LFe6VF+8pznTCc3T2PqvGv6DbS1qU2Foh42NMs686V/Yj381EPtQ5P9w6OMhm4+6OkxQWGRtjd1iWPsmDw4x38D0Ush3IJPTubzSrvqCxNEk61AOTun/yyrQdV5ejYXX4n4bq2Nt4EHy9UhkEtAZD6IT+QH3oeAQ23tiIs9nqR/USGk2286+xjArAfxN2T8MkKUP+1+67vxKkuoGl2fE81Se6FGiFLbxQeeuj5DuXlJPfmKOzGJMOuGjiWhqoS8zk3WsQvup2BxSatYD8D9LhFlnru/5TKZLdyplvd1GdYBrbfbh23l470CjaoiHz8WG1/xLN/iygcy500cM7EMRmIVUgRlcL4pbqSNb31s3eMyCrFFK8ie4sp0nXC1v+kX06L7PEpTxLZZ21Hudb8Rx/INDvMbO7aXNapoFY2XLIJ5N5wa2NI31A8QDy8MXAez5/8LtgJSpQwa8yopF2vzhs4trotwHvzSUSWlpynTceYdkoRDn9pT03hZrlYrykgCBCzFtIHWjGRm8O53IIEMY9yDkhFhI1t9dYzQTzOdbdjrSzBjh+/WenjwnU1Vqvtu2KABHwnqOJTAcXOIq8IMlj5YsXRLrWALrAdV9dP+qWHsgNTYPpUCzwQ1pFqZCMYPnpGIDs4jf1RWKZRXed2c7Ttz4+JycCa10rp4wY1N/VKt+CfIO6Te+zcDHuwNjPdp+s1PRZ1aJ5IkwjCReua2bttxkXjV/eBQIZ2zuqwMkUeaoRLvSVP4PlHDy8AC3y43IxlCZZcJIU1//HW0Z0/7C5OENt69guCHy6HbDoIoEOQ8Z8pNSVHnEtS85RTaDpk22iU6HE5VvkCOUw+Sv+l4Mzs6LAwUem1EhBXjN4ukjct6izJpZb/w6z2fiRpYrincoF8l+WC7nH5DY7iUKsfRB5Ku1jOyH6b1FLoYb6Hxkjd2LJapP0CxuvqlCxtk2Dvqfi1auWF6Sc4oDa38dR4LUnEShQIRLRx+n+eroCSEKO200okJ/l2Z7F9TS9kXDQQAQILypme1PM3lnKVcddfus6DUGBlewNyh6BLEsJXxqY0yybx1mKfhOruKUj8Y2vL1dh4LoI1BhDdcfaJzmAoMv0mSSv0YmpHbW2AaoJ+hBpI7Urzs0y7ovUfCA50cTdvSxxiy3fKKbUxFZMYIUuCgJY9h/XE4N5qeL+tTJpouyga6rdYRHCXKGsDNQAu1eN2IPxeSPGmUc5hVvCVy9Wd/1IlBw7FgsAG6uWaRMjmzPSABkp8vTasRl2ajOTexggNYxIk3E7vy0aczH3UrlJJTyhkrrVydI+G90ULxO3t4gQHTbDcn6hVR2jt8GmhCf14KuHC84Pv6vABKJ0FAuyDfK9XHLPnf5rkmLWCTCIZUswPc0/xa4lgxmXOFEtPokBMQqqjZhk4AxvCSby7g/7sYB6YCO+8HPjGuEm9sPQStatpncge27njSvl3wOyFIj6rYM1PsjaEsNlQlGubEzHpG7zfqSxGHPK4EoO3Zryox3f/myyj4lSwc8ag0Pbr3fik9nmeCCxjr1BGUsmtg5i9fAI7pYzsrwVxhTpMHNAeQZWr6UvUIhybXkSQDGNkYqAY32NA+fZRaC4gO9kyQaRCWdcQ7dA/EE8p/6QmtMIr3jc/16qh1rIBJvZGHqylQ/F9/4pw5uywLUCMGMUeW70mAP2qGFOki/7q1iLmdNCRIZEbmD4lZrlI+Az2vy2OKLQLt1dhVgIOHSKdTcAGlVKJEGPoqSmJzKqyRJqNTfK8n/WMib7Z/SEGIPfi6x31rRiDD00N7wjtTojrMdLGdA+JAOxQkqI7AKmqHw6RgcW+HXhjhPZBVcMyStDRd7eZAzHjry1TyI/CjSjpngwTbJ+3HxGWD+of0pIrQi6cxCN6S2sGfkzTBE/5t92YrlCueXN6fwkfmMnbSrqXSPCASDg7Fh7sal/wBmDq1Aw+3xmBUfKZZG1tqAwS7vPm1G3wHnlsAyTJYJ/BWZm/AUHLyeG1EDnVFxh2KVrU2cir7TkmVkD25T2I3QFv/bhASJ7rr3eBnZGMLlGPfHTNAremc+oWu9ngM+wP5yXiIVmx3zJYkFBMD6o/QRpEj0gL+2rH6+ITkwQRRCQcAm31tjZUY07oN6YrGGQOOzN64+68R3jBFJWTTdELKZsb8AbI7RUmoIl79b4XAy1ULHpY7xyZAFESpQzCksDtjnW0hF8fBnehHok+k1xBr6eN1X3W92ZIi3jrterhFrDqsYywjy4popFwR1ePSMEUU+a7GizPAWyf9mbbI0hYl8LJjV3iB1UMqcJGHO/VSUXcXvnDFFbtXliyg2az3INf9vSSbHF2l4GfdwC6UxxCUzrhSVVMJVbcOBuX72fWs2M7vWwa3FtQ54MaJivp6FKkIIPgdhUMMxeWJ3EEj7dfu9chaQKtwCsFuQs+wFYJeN+BAd05RkHDi9oqkl4SOKb2aTNxuV01uN++lnjE1D2B8xu21LIHY5h9IwtR6hohQD3fAXLLAyOBeDHO/wNTDYKoVl2p8Tan+++++mnOhr9sXl4kzX62cD4kRgS/7pKfQV+8cuZE3T9L1fNA8AF3rLxFZ20Osm1K6PWXSLSUE4SZrJpdfl0Nuc0NjMk/RYOBU0cU3EgPpSikQ/e3aSPRW33xcobIj38fHEpE1aasj35p8ruE+v4s41uIGTUZGKHkUEVgUdqwyoFBSdWhVw6S9kowmhB5nBjov5bqpxpsv2fXzX4g8HZkOi+RjePRu7YFYHS17cXzaME6msxPuCvPl4hkHxyuX8GR+m4BEXyahM51+6KgL5SpdsOJ5s1M7uJ4aQMW8bx0gcuuJN5IFY9MqfQVJmwE0Uq+FRCArwKVYb4AU924kAWkWf9oFkVMHm1mIICjEUqcZAYG1ufvkeTPNtATlm1TzrvNqrMSPGrohIhLWQvJLe9rzYu4NQRMncRTjgNd8kPHryKMrf2PbZamVhsWMEXW5wm4pLVoH4KDdsklIx3OdVp85kb+qvr5uw43PGvejeJQgyiz5jtBbMgxh1E8RxKzGK73DXy99sLbs7oaF1CbDhQkhN8ncoXI1Tt6vPrpxdrWazBlgHhoax7U5t7D78fx21ypfiLofmvGxdsdTRlyP9Dhw7cTYPdyuqjJW4geaUJ5WauSDKm9EFJBlYe2DO+dRi+BrKU5EomiYhgwNcwaqLM0BmBckqC+ETkZhgGG3OcFY8ogt14Ba4u+bFAgmfVfocvuQ/n0cnTk8TDemkB4y3Qs4RQAijT8MK3qUrGhG3gd3Qr6AN298XGrYazBQ97PHhJRUuCbq9VuyauJR7vQa51fZK+WE/7mT/dKnJpOPQFWUIBOoObwYsz+lrzpbVXettbVC4yNoaaveRrS+u6w5EAPVV91kay0e5YPAz2TMseUsgJ0xkh4ez7ewEliBN2hyCnYyk9hsC1pGGjJ3/5uaQXhhqdk4WxE1o+s9JVnzcrFFNC21UrLqYxJsNcJoJAMrwT283WtaSOFtvYPQBM8xzwwDu4KmYP0FGsaz0TG6g5ryOV6SgQ0jEGI8ejMgSengwKF1nF1YJ7d8EnXIxC8HmIqOAILLnbbA50ustxyvEZKnvhoojWF9wC2qXqkR/ZdIvbXzfehiHcq64055JXJWzHjlLlfFOcET9rUMq1C7p14VBKf1iWVdVhPqhEh86pmYJIFt+LpA/L1KSuH4bZ0Cs804zykfUkYoecS41eSRTZ9BOI8HvqWRgXNXr57ecFXoM17Sx4v3jSSJf3na7SigHfOq4SDpvKk3UvO3sTsw6IwAs+VyHiqG0FjgnrsiiFosXsI0HGSIM4MsIa0ntBa3qr6y2yZ+aeSWn2MaAZMJsP0/IVzNyEHzEa4/+p4yZHm8y9PZReKWt60M0Ft4rK3YRMP1PyitNwCMql4krTzK6MoRitp+rueLDavKklzTaWf5QakpGVEgGJePGa5LuZe6yt02RwUKJyhgJLQXnAGSeBfZ+2zFBB80kag+OseLFV3ST5izwLR5rzsImgtCWKT6tSeDtwMnejHfG5mbh12U7vxaVH+vvbjrqiSONRieSwc1AbF3Vy5sVwqAA6BqtNIhW+cfvuxAuF+WqZZjcAMpitupDSP+dRybTNK4lKaZN5MwsugKRTeZlQnn6B5fVEVWA9mKX1SsG3k1BTniLiGcPVndHOEmmUUIK8doaziQLkpzdKM4+KLwcBbOVPAAPqGI6YjYW6tOulxA4hjlCDnp6x9zsFHNZFr76AIeELc9w3oJuEopV2jkQs8ZGxMsiXLA7R8Akvt/VwqyI2dPa4DPjbzS+hGK2++jGceyAFx/zA9IOPGrVgOi45bYKvZT+HpEqIfNY5mKRJEGmOr/aYZSavEKflMSAfCi05fhKaUNM7Cs7k1x5oN1ney5EQFYmhCj8ljwvVvaklMcHv35hYXgnxD9LVOu9jGJUq6eRVw0au/tA1urM3A3se/RsplGEgPpQ4UCT3gw+XrLjqWKw3GA83CJ6UMDTKaHGAM=","page_age":null},{"type":"web_search_result","title":"London weather in July 2025 ⋆ London temperature in July ≡ Weather forecast in United Kingdom | METEOPROG","url":"https://www.meteoprog.com/weather/London/month/july/","encrypted_content":"Es8ICioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDDqh09vFUeyN92fxGRoMkSHpgWvtyTKvttI4IjBscmTpRqlJJZCBfczTv6CjGadWpvFZZDH8am8jPAKm/wgC02OmWESNU+V9Z9Bgdz0q0gcw6AHDBUIQD1lJlooVXwJfEYERZQfcAaUa0HA6w/S6Q1c1gYuxwMH4rlzr3iFDT6FefmBJ5iunJsJ55JjCJG7KJQ/6uhoIPpi+frNSamMt5WILHXtsiRB4eV0FxPKG3QLr/3vTY0mRP0EEZa48+qcKx9vbByi+TKV0BLEyBz5jegUorUcAUfk7iO4gpgRnI/OMJFlu5dnAW/YhkgoGs2lPa+KP3vacdkZliK7xOVI7ZdB6BPu0ELIc7Zl55ndLanNeecpubCDYz8mhiDGzLb30BICs3B2qZcN5DNVYq1PKo+p9iNXjIqBAlTXuUQkkLF9jrwB1HEalOjhIO7lt3fotnINkdoo5OAH27hVPtvTfaU+St6b3gsW7OQUZlj0BlCrxOI7oxEUq7eYtEjyg9a1YhPYAlMrs2H7tr8CZbcRGlj0d/fgcSF8UNVyoP9NBlnQWrWlPrUYCyMkf27yLHn6kNg9uJ1oSz/SWY0jpa2RvWBJpoUOidc8wVHvf4kq2/hbFB5whH49+TIUzmq3FZIf81uIwOOp/hlQCUegdYJZ5H2rPv62bE+ykoD3Hky61/eraUyx6fpCDrEaxETEtq8esjAWRaSGtc5LsSti1CfC1EQSOpGH9M3id5VzLRzbe4UG1bTeAfvFjMHxPi4zhkWDLTyiPw5j7mn5NWy0zU9ObApJdNgWWuI5+yh09C1+OMco39Pzzq6/wXI6Os/rU3clWlMDDUPwgz+CYuQm3UhJUGKt79bWtB0mDPTYM2slXvH8S0rCoQgDt+v7tAd8XjzmcwSHXbjVhXcqtqGo/bnAJeenOx0E63fRo8XIq2H/QiHxF1ssdNOZk46EQ87z0E9aMJi7eBrLVLgNiuD3C383YB6X5F1BrnAU/2kkvYHL5P3IqyxRUPp8EX4NWW8B+IIbx6kbBmczyJbczAcYWZV/cKXMnyZIO/duyFg67DlKaJmFrBlaJdxmqrrlxyfKcCISG1kQ984D4xJiSgxcOe1ZQSOt/aWOAINf5vqyQrO1lE8rIe9OqxeHo+9qWBi7pMTvUSvesgAgTX4+QTAv1tuB7VJYZNkQEoJNp9cT36GBFqTJfPJ8qVzu6jFKIKkORHlnI7C5zdOXIvTBsd/noXRcTu6Ua1D+7rzzU7mM5QEIbIXV6bfgfYvePB38wco6/Sv8mtKTTYsjUzXh/2iu0JI8SHrszjAlOhq7Co1BFBMa37FURNFx9ohuqMklpF2QZALRRZTS/Ox59gaPxC5QES0AiFHKHOnmbYO2t4wswtceOefeDZjlwSpAAGqELb6386mA9rT0YAw==","page_age":null}]},{"type":"text","text":"Based on the search results, here's the weather forecast for London today:\n\n"},{"citations":[{"type":"web_search_result_location","cited_text":"Read more · London weather map · View the weather with our interactive map · Loading map... Forecast for 04:00, Wed · Updated 02:00 (UTC+1) on Wed 9 J...","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","title":"London (Greater London) weather - Met Office","encrypted_index":"EpEBCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDE05GB4S+5/PzxivHxoM4idqq2v7pEJO2neXIjCPcfOj+coICxd/h8wKQzPXGdwfF0YuYHevdnHPGS0E4qVrqgxeuIiyYRc0MPC01gIqFZcDmXjdpFASzEkz5B9adX0x/R3kgBgE"}],"type":"text","text":"The weather is expected to be fine and increasingly warm, with sunshine and evening sunny spells leading to clear overnight periods"},{"type":"text","text":". \n\nSome additional context about London's July weather:\n- "},{"citations":[{"type":"web_search_result_location","cited_text":"... Daytime temperatures usually reach 22°C in London, Greater London in July, falling to 13°C at night. ","url":"https://www.weather2travel.com/greater-london/july/","title":"Greater London weather in July 2025: How hot?","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDO57YvzFJB/gkU3BRBoMo4XurQa4vebnFT9xIjAWQ3oaxUVIXq9k+ogJXFekEBwmT9wfTN5DC3HKOUQnltjf/6J1T0NqVg7OI/qypNQqE3JLG4sSMnihXO+zH/67kkJAGLAYBA=="},{"type":"web_search_result_location","cited_text":"Enjoy moderate daytime temperatures of up to 22° and cooler nights around 14°. ","url":"https://www.easeweather.com/europe/united-kingdom/england/greater-london/july","title":"Weather in Greater London in July 2025 - Detailed Forecast","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHugvFMDPWBWztwxbhoM0MuNN+4SwcB3IW5CIjAxl2WI9aI9O9EDAwqTAGtElSou5jUq0eVZeC0bLsT1F+lVk6dzBykM+YO8ptbXNnoqE4HgDdHUKdhpS5EBQrW/Ov84T1IYBA=="}],"type":"text","text":"Daytime temperatures are typically around 22°C, with cooler nights around 13-14°C"},{"type":"text","text":"\n- "},{"citations":[{"type":"web_search_result_location","cited_text":"There are normally 6 hours of bright sunshine each day in London, Greater London in July - that&#x27;s 39% of daylight hours.","url":"https://www.weather2travel.com/greater-london/july/","title":"Greater London weather in July 2025: How hot?","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDNxtqRzSmE0PErGQDxoMKQtbwfKzURM1NkNhIjAPcQypiOIp/FSfF9xIO9AZPTPtpO66BPMom1IzE//mshzASE3oCmKS1jT4tI3ueREqE7y+wCfA7+xuqP2a5O0myaAXoG8YBA=="}],"type":"text","text":"You can expect about 6 hours of bright sunshine, which is around 39% of daylight hours"},{"type":"text","text":"\n- "},{"citations":[{"type":"web_search_result_location","cited_text":"There are usually 10 days with some rain in London, Greater London in July and the average monthly rainfall is 49mm. ","url":"https://www.weather2travel.com/greater-london/july/","title":"Greater London weather in July 2025: How hot?","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDFSYc29XrR7hz4lALhoMrvPdko5FYkmbbiG1IjBkk6zZjQOcRDbl7bKTkWOjREVlDu8dZGapPLLBtEQ8ikSsWq53Qz9rG7QCVzGMZAQqE0prh8vyvjdlSimHwYw5z36OIXMYBA=="}],"type":"text","text":"There are usually around 10 days with some rain in July, with an average monthly rainfall of 49mm"},{"type":"text","text":"\n\n"},{"citations":[{"type":"web_search_result_location","cited_text":"July in London boasts warm and pleasant weather, ideal for exploring the city&#x27;s renowned landmarks. With temperatures ranging from approximately ...","url":"https://www.makemytrip.com/tripideas/london/london-weather-in-july","title":"London Weather in July 2025 - Temperature & Climate","encrypted_index":"EpEBCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDNAB/3B6jAwC/KjmVBoMmGL9MHdanx5Kx2ctIjB9ZnU1xJf8hvs0UEPwdbX/nB5s38mCYUYPqWlt6PxjXp5mz7bXnsYjtiRfanFMCEAqFezxurUX9pJuon+PmDB2IfgRSG0m9BgE"}],"type":"text","text":"Overall, July in London offers warm and pleasant weather, with temperatures ranging from approximately 13.6°C to 21.8°C and nearly 16 hours of daylight"},{"type":"text","text":". "},{"citations":[{"type":"web_search_result_location","cited_text":"The city's vibrant atmosphere and multitude of events make it a favorite destination during this peak season. ","url":"https://www.makemytrip.com/tripideas/london/london-weather-in-july","title":"London Weather in July 2025 - Temperature & Climate","encrypted_index":"Eo8BCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDEdFTgy7ZwpR0hKHExoMoUAHdDr3AXh56YKtIjCgjirrl2plcQjyv/D4pDcpOH8WjUjxRTNkJ+Iw0vhzx8egVlM4UcSfl/LsnldjZhsqE8JWGcd4YFwX2lHqAF7uflC47d8YBA=="}],"type":"text","text":"It's a peak season with a vibrant atmosphere"},{"type":"text","text":", perfect for exploring the city."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":10567,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":361,"service_tier":"standard","server_tool_use":{"web_search_requests":1}}}


================================================
FILE: tests/Fixtures/anthropic/stream-basic-text-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_014HN4fQn2vqETrzGmNdZ9Eg","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":11,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":3}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"I'm Claude"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":", an AI assistant made"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" by Anthropic."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" I'm designed to be"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" helpful, harmless,"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" and honest in my interactions"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":". I can"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" assist with a wide range"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" of tasks like answering"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" questions, providing information,"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" creative"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" writing, summar"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"izing content, and having"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" thought"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"ful conversations."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" I"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"'m constantly learning but"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" I "}  }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"do have limitations -"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" I don"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"'t have the"} }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" ability to browse"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" the web, run"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" code, or"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" access files"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" unless"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" you"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" share them with me directly"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":". How"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" can I help you today"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"?"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"output_tokens":104,"server_tool_use":{"web_search_requests":1}}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-multi-tool-conversation-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_01MemG1Q4pNUK6Wmxx9PJag4","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":449,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":5}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"I'll help you fin"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"d information about the Tigers game an"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"d the weather in Detroit. Let me"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" check both for you."}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"tool_use","id":"toolu_016AhXWHqihGLjGMwXYGqBLL","name":"search","input":{}}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"{\"query\": \"D"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"etro"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"it Ti"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"gers game "}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"today tim"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"e\"}"}}

event: content_block_stop
data: {"type":"content_block_stop","index":1}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"tool_use","stop_sequence":null},"usage":{"output_tokens":79}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-multi-tool-conversation-2.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_015C7vjKvBwYhjKq6GsAQppd","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":526,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":4}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""} }

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"Let me also"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" check the weather in Detroit for you"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" to see if you'll need a coat:"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"tool_use","id":"toolu_01BE2CvaBCFKV3NSyuZBgRjR","name":"weather","input":{}}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"{\"city\": \""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"Detroit\"}"}}

event: content_block_stop
data: {"type":"content_block_stop","index":1}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"tool_use","stop_sequence":null},"usage":{"output_tokens":72} }

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-multi-tool-conversation-3.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_016AB8QunvJUVDDpDZwndMXq","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":173,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":2}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"The"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" Tigers game is today at 3pm"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" in Detroit."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"\n\nAs for the weather, it's currently "}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"75° and sunny in Detroit, so"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" you probably don't need a coat."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" It's quite pleasant out!"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" A light jacket might be goo"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"d to have if you tend to get ch"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"illy in the evening or if you"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"'ll be sitting in a shaded area of"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" the stadium."}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"output_tokens":81} }

event: message_stop
data: {"type":"message_stop" }




================================================
FILE: tests/Fixtures/anthropic/stream-with-citations-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_015YAuBBLfSwL8pe4TJLNtvm","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":575,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":1}}     }

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}       }

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"Base"}         }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"d on the provided document:\n\n"}         }

event: content_block_stop
data: {"type":"content_block_stop","index":0        }

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"citations":[],"type":"text","text":""}         }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"citations_delta","citation":{"type":"char_location","cited_text":"The grass is green. ","document_index":0,"document_title":null,"start_char_index":0,"end_char_index":20}}            }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"The grass is green."}        }

event: content_block_stop
data: {"type":"content_block_stop","index":1 }

event: content_block_start
data: {"type":"content_block_start","index":2,"content_block":{"type":"text","text":""}              }

event: content_block_delta
data: {"type":"content_block_delta","index":2,"delta":{"type":"text_delta","text":" "}             }

event: content_block_stop
data: {"type":"content_block_stop","index":2             }

event: content_block_start
data: {"type":"content_block_start","index":3,"content_block":{"citations":[],"type":"text","text":""}  }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"citations_delta","citation":{"type":"char_location","cited_text":"The sky is blue.","document_index":0,"document_title":null,"start_char_index":20,"end_char_index":36}}          }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":"The sky is blue."}            }

event: content_block_stop
data: {"type":"content_block_stop","index":3  }

event: content_block_start
data: {"type":"content_block_start","index":4,"content_block":{"type":"text","text":""}       }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":"\n\nThese are the common natural colors we observe in nature for these elements of our environment."}        }

event: content_block_stop
data: {"type":"content_block_stop","index":4  }

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"output_tokens":70}               }

event: message_stop
data: {"type":"message_stop"  }




================================================
FILE: tests/Fixtures/anthropic/stream-with-extended-thinking-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_01TuBJwobCPKinTJ6vChw6Yc","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":50,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":5}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"thinking","thinking":"","signature":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"The question is asking"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" about \"the meaning of life, the universe and everything\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" specifically as it appears in popular fiction. This is most"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" famously addressed in Douglas Adams' science fiction series \"The Hitchh"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"iker's Guide to the Galaxy,\" where a supercomputer named Deep"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" Thought is built to calculate \"the Answer to the Ultimate"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" Question of Life, the Universe, and Everything.\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" After 7.5 million years of calculation, Deep Thought provides"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" the answer: 42. However, Deep Thought explains"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" that the answer seems meaningless because the beings who aske"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"d didn't actually know what the precise question was.\n\nThis"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" reference has become a significant part of pop culture and is often cite"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"d humorously when discussing existential questions. The number"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" 42 has become a popular in-joke and reference"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" among fans of science fiction and geek culture."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"\n\nBeyond this specific reference, the question of life's"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" meaning appears in many works of fiction in various ways, with"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" different philosophical approaches. But the \"42\" reference from"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" Hitchhiker's Guide is by far the most recognizable specific"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" answer to this exact phrasing of the question in"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" popular fiction.\n\nI should provide this context in my answer, while"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" acknowledging that the question of meaning is addressed in many different ways across"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":" different fictional works."}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"signature_delta","signature":"ErUBCkYIARgCIkCMkRFgNNhwET9y5IN2hGVaMO+tPgd5T2aSXprEVvIU5pN9uklyYgqC6GzmijY5Wr2DFwm5oBX0XHqfb9bYcbmzEgyeDDF5O/iNwNRyyd8aDFdKPcaLtnOEE+xkBSIwhVbJFW8zL9keNzmvEjacAs+Zw6hU7b22EqyWy7hrPjLNHZHJ6SWUV3TzbClf3D05Kh34DwkpbncEwubXurHJa0E8yOLOfa1mCFe43e4r7g=="}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"text","text":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"In popular fiction, the most famous answer to \"the meaning of life, the"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" universe and everything\" is definitely \"42\" -"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" a concept from Douglas Adams' sci-fi comedy series"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" \"The Hitchhiker's Guide to the Galaxy.\" In"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" the story, a supercomputer named Deep Thought sp"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"ends 7.5 million years calculating this answer,"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" only to reveal that the question itself was never properly formulated."}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"\n\nThis absurdist response has become a cultural touch"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"stone, suggesting that existential questions might have answers that seem"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" nonsensical or that we might be asking the wrong questions altogether"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":".\n\nOther works of fiction explore this theme differently"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" - through quests for purpose, connection with others, or the"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" idea that we create our own meaning - but the \"42\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" reference remains the most recognizable specific answer to this exact question"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":" in pop culture."}}

event: content_block_stop
data: {"type":"content_block_stop","index":1}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"output_tokens":452}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-with-tools-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_016cuCkkN5nUXA5NxYnLnBpt","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":465,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":1}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"I"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"'ll help you find information about the Tigers game today and provide weather"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" advice for appropriate clothing. Let me check both"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" for you.\n\nFirst, let"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" me search for the Tigers game schedule:"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"tool_use","id":"toolu_014cZKakAghgvhi4Y99XBUru","name":"search","input":{}}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"{\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"query\": \"Det"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"ro"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"it Tigers "}  }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"base"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"ball "}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"game toda"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"y time sch"}   }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"edule\"}"}}

event: content_block_stop
data: {"type":"content_block_stop","index":1}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"tool_use","stop_sequence":null},"usage":{"output_tokens":96}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-with-tools-2.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_01QDSYngohWqNLz8Esqcd1rA","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":560,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":5}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"Let me check the"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" weather for you as well to"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" determine if you should wear a coat:"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"tool_use","id":"toolu_01NLsWDkz5bePyj8fRKcdDDQ","name":"weather","input":{}}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"{\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"city\": "}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"\"Detro"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"it"}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"\"}"}}

event: content_block_stop
data: {"type":"content_block_stop","index":1}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"tool_use","stop_sequence":null},"usage":{"output_tokens":71}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-with-tools-3.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_01SAvrqRVZQpTjD5CDkK6pDT","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":200,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":5}}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"Based on my search"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":", I need to get the specific"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" game time for the Detroit Tigers today. Let"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" me search for that information.\n\n"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"output_tokens":36}}

event: message_stop
data: {"type":"message_stop"}




================================================
FILE: tests/Fixtures/anthropic/stream-with-web-search-citations-1.sse
================================================
event: message_start
data: {"type":"message_start","message":{"id":"msg_01Ed44F5KK4MEReKTLLMpPh5","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2685,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":2,"service_tier":"standard"}}             }

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}        }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"I'll"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" check the current weather in"}       }

event: ping
data: {"type": "ping"}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":" London, UK for you."}       }

event: content_block_stop
data: {"type":"content_block_stop","index":0 }

event: content_block_start
data: {"type":"content_block_start","index":1,"content_block":{"type":"server_tool_use","id":"srvtoolu_0139j7rJZHEbtYzj9w9pvobp","name":"web_search","input":{}}               }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":""}        }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"{\"quer"}            }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"y\""}}

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":": \"L"}        }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"ondon UK "}   }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"we"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"ather foreca"}        }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"st "}    }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"today July 1"}            }

event: content_block_delta
data: {"type":"content_block_delta","index":1,"delta":{"type":"input_json_delta","partial_json":"0 2025\"}"}  }

event: content_block_stop
data: {"type":"content_block_stop","index":1   }

event: content_block_start
data: {"type":"content_block_start","index":2,"content_block":{"type":"web_search_tool_result","tool_use_id":"srvtoolu_0139j7rJZHEbtYzj9w9pvobp","content":[{"type":"web_search_result","title":"London (Greater London) weather - Met Office","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","encrypted_content":"EukICioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDH9Vda7fKTAEG2KPnhoMyqc1r9haRbNQ1rBWIjAifnovKtpEsv2N5Ijmp84v1k+WCQFyonJdBquoDjrEAnqrrl8KVUcTyu+PNc+ibq4q7AfvU4q7cl6RfP9WyJPeiTxEww24hPn+b/JD8uK5UzofdZ8lmOZN5+Bzv0BcAiwsNFQD+z2U8maZj70k1Cn12tHbFhBCcpVZp2zu8Ks7veiyiG1eeBSpTSH3qRZpt8GI0vYKMOWzrDhJB54dQWTgM8ok7ujVAkSkgGNrgdziFfFZma/wbOQ8WtqufB52yYhkqTH2aQWRdcbCNbGKV8eM8Az1nDD7pFPrte5dw3ETaqvstR94/1NmUN/8+xpYGyJn8fQcG6nljMbTxP7OxolrOSdAKYZPsV8H7mcO66uWYInhg8TqaZbKwDjA4VxpHjggSPdCsl62yPfn/DciiLaYlDkM/8Kkz4KbnFO6soKqSAqISLYy0X7WIoWd8PKp8AveyoTatog3uOt1n+77pRzfw/xCi53MwZG2gxJF62xy7Tw/pA6M1BMK0V1xhfcZq3elotEKoz7yKniwpk2JbjifWgSHE22I932GFS5stm1hiHHv/i5qhPP3/2fnFApc28VkkRkjJu2BoB8/95DOL9yQr2WxwiyZuUwvkq4Nb/jFEtLgPx/iCfgkGtVMqwPLsF534ViBT73dSYjT1SFJLzgYTcTPAY2n8DiE3JzYpv/uMY4iCLidHorzaRNDGte2Fa3tiqOxYGOaqwz2R2X1ZBbIJdpLeIcmSWXVYqmCO90l4RNnGJRI/IFzc4vpQoYBOAJbS9ry0inJl0ROcZs7tUHZeSFGbF8d+t9Wl0ka3uvoJNFfyGFtBihrisT/FqtfQ1Mfb4XyU7JcgehLuSjoTMsUXMgoiUrDtZttZuIz3P9SjfKQUo/2MJdUNKqUubPKxU+EFzUcItigsp1CLUi7G8KPqgp7mYB4j9ID6KTrYOMODw0MunJrf/FeQMpCAEdDKQlmo3pmAt7LvPUgHbJ3/DHT7oxWpyeNgVzs/43brjqfDyK2bVpb5qZSHTC05xTSi/RO+cArXBYj8iwzgzNouSRehEilfGpzkYE0YoYSLq0NpcNLVgfaLKcaaBS69feXpWwBAuyAl5OHqUkjjWbU3FkQnx+QtZT0qT0b2qi7iO9xbW31h86MSQUHVSZic82aY2CJA6uNFe3N0+H/fKmNfvnNzN3MrT0v378LvCwKd2yjF9ULb2/8x8+7e7TSZKEQxodniBU8SgURrkvl0F9YWHhFmDdxSbIjbH68U4t+JHtOijOXkrAfoCbkL+ZFF0rgqKNA62erda0E+dk13hpBEn3rRDHWtPxrZ7LqqiDTdTZ5EY8ncAHLEUWhgg1VULtjsdUXjvvClMkIQrQKynTUobXudoC6CuUQkhE4hsJiaAWYSIopCWQ3auglhUwF0kUTSRgD","page_age":null},{"type":"web_search_result","title":"Weather in London in July 2025 (England) - detailed Weather Forecast for a month","url":"https://world-weather.info/forecast/united_kingdom/london/july-2025/","encrypted_content":"EuoDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDALoflmG318lR+BMMxoMw5kaTrXleWFWRzkoIjBkRo4NaxjqNn7rroYHeGQsMqKwXKmkrblvMXKhStFz5MLSK7gMZB91BBz412WvvWEq7QKvfJ4MyHrV2ZhqAlvt5uM2A9tSt+N2dyPyb95xJXnCDMonoQgOgtmethqUOXJOU62FbfCL2ttQWGJjswyyT1uV6owa88CkauJUr3wuc7B9y8EkgGSZcfalguJpnohBvX5KwUFwcgzH6QXL35AKAWI9/4e8cTorMO8hBwZ9AYs63JQeY/urQbOS3P+jkPvc2Kx5UGU1w4s0j9YFzp/qLDifHGSMSPVF2fm9NhuhNfuvR+nSP/i7YowIpVsw0leS/Rbb2DaIOi2SUUx5ll3HXBFEVE8lCXYjM8qb1i7Nilm3Uvkb79ZtEpG7rmv/ucb+1W3H5WHMWsoD8HgrSEvbp5l4wOwT2B8ht6WKnwu6Vmbop7qZuq3u2jUaPS6i3IsZlEVjXdd1doq7x1VbXbTmUGDRwynXEzWO67ePIbny3uvLXsLCg3co6EE9JalIIjd11ftpJ9rru7n3N1+dw8wY2zsC3iSzrwjmrzStihjOQhgD","page_age":null},{"type":"web_search_result","title":"London, London, United Kingdom Monthly Weather | AccuWeather","url":"https://www.accuweather.com/en/gb/london/ec4a-2/july-weather/328328","encrypted_content":"EpsCCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDEA1wzr7iZFj9omAYRoMCgwiVoxuldeg7468IjB5p3kkyr8WtXHj9LEmj8+Fxx5Mr7mK3gR8NkF82i5G118MglZVqhLkbR2Q2ESCxLcqngEe3hBK1Vhbgnj/L/4GzQhV5nOR8V0B3LRCLzOYlvzhBNTcADADFnUuEWoExVf4GLCIy/dDh5rM+4/sUsy2kpSPEEXo1E8s+iprl1EuzxT5VGA2g+oqoaHnmqHVuE72agPfOJOdhcPQn5OxR1gnUacqHV5UaWMCigGj9uArzr7XwVZSCjpdEfAPgHbqkkkHXGrewYzU/yNQ1YkTossu9xgD","page_age":null},{"type":"web_search_result","title":"London weather in July 2025 | London 14 day weather","url":"https://www.weather25.com/europe/united-kingdom/london?page=month&month=July","encrypted_content":"EtMHCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDBJSqYfE0GQHoTA2JRoM4Ngi1otcHB37e3VYIjDJM0vQsrfRFvaCPsKB0xfkOZtA0AItxt8Zzc0BWpgSl5/4Vm4tY+vGBTvEJonhd9oq1gYRHsO2GkK+PdHJYdmpQLlI2sdZU7hGgEFX6u2DbfyyGeehEB0SYuNhWEryOz0HN41vVh4XGvjUP7avui++7PRizdJ7lIZE+rkHH4w33/mVeYyVV+mPQI+lJDEQ0fbjVQ3Zj7/kdOKtuB/7XSl+oZmerosC+2GLfdut3aNxYYO0mUcaWjgp4Ujwu1QKlvxKrYcQ7tRcv4b8Szk5oQyCDFb+ESVBP2x7fSJBzbxbimeMcKlug8hCD+1SozMGE316jhq2ie/eijod1I+BCHVrC5CUxHb0TuyoLvseL09a++fZ7DR1QrWG//6qd8/H9vGY3XoLqiVi9zFj4YOQLlEasX4oUqezA1uGUBK8x4Z1iF3B5jtxAu5NkhBFrJVL1UcocvtSz0JJcGAKEnCneZ9+NFYboz69SiyDpjuktawMN2+Mqlpp5Q36lcQKKMNjnG1t21cab1PYU979PIzCyK7DEnvVUI/GppUMJx+zA0Rb0jVzoFh/xuiGvDWWiM/dNw+AxQ6FGXBwAER4X2dSboEFPErCRduYGgFVs2IN09uJo14mRDzAu2qPm22qBAai9vkVLfE0rdfaLItLGHHFzVbu9PvWIlC2s433YRpC+SSStMarAPD6qtiLtuCxYaH1XeodQmY4iC8PDObsLsEWtIxglpX6QJcj97YUj4mPramgm5E5ArDYpt0MKf6eHEFetmr0ReMgOpIPe0EiwmJWf9vcbutvcBYqnP4V84CV2vanLGTxO9z0pCSy56gg7H31hREhIlGomDJ3BC0KOxmEKKEQKQOVsxYTzGE1nqiTFuxbG6tPr2wUfYFYQTYDYIR3CERg+/dbBKowOmGex9eTe4R8xv+IqDKyC0V93CjFr8WJbwtDpGsTcVSpt0tI5m49peLauiThZea8sLRC7Tn3ls8F1h8Aaq7BZ3a27Nz1d1zP4kIkWVrzB1xJ+tz9piy7mI+RF447vd96Mp4CfW8XZPlOR+9aCXouLZPF5Mjqq8C/Ez4Mnf43g40lK5lvqJQExPJtA3z7pxvIhDKaLvJOcZ3lMpTRsR0pWaI0j8105d+3FetH0JiusElrAeEkNTPBWW2ulsA57mhBfGf6nbrJcX9OolpfjahXjnKaqscKP0dVrcWc+6U1vyquDBgD","page_age":null},{"type":"web_search_result","title":"Weather in London in June 2025 (England) - detailed Weather Forecast for a month","url":"https://world-weather.info/forecast/united_kingdom/london/june-2025/","encrypted_content":"EsIDCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDKjYzINnb17aERWWiBoMi0JfEvKY0W1+JPYlIjCE0V3QQpWfl3rVWwpNJ1Hq9hU90TzsxPr5Qq+6yiLuOx9nFYBVov45od1mhZkimJ8qxQKXxVPpHSMVAKhfnZYcq2KmuM0GCby8PJE7Be70nYZikPYeBt8MbvOD7SnnDvAQZtSPs3Wsc3yDsagk/M4bb/rQe9uVizD+NkA+IJPOsSsf+ZTbHtf6lciTOjekP1FLnU+FLL36fAQ+ET6V5/gDpFpeikArLtvOSuYFJm4cK9hSIgHVvO4yKbzQN78WwufV6FjKEZCx52RDXPI52zlRwycLvyL53A7ZbeyGIIUDYKvIc2zskJfyajgta/YXhYCJR8s95+oOgiN0aV1B3yPwDSUrjHfAB8Q6fseIbeES9qiOyGsjd1clkbDEwYQCfkw9GGaykHzmlwycgYVOFT3epxV/Xn0PCgw80kEVCfCl7qMEytb6e6eD7+nqjG4/iHglVvoVchL0RN4iPC0CKrAWUZBzc9ELz/JC2UmPZV+PGdo/F3sUwo/rGAM=","page_age":null},{"type":"web_search_result","title":"Weather in London in July 2025 - Detailed Forecast","url":"https://www.easeweather.com/north-america/canada/ontario/london/july","encrypted_content":"EoAOCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDIFzuuEkRB1UAoo/URoMuXCLPNKvXRPX6DTTIjBSIqJ5snJ7x9brDQbEtrpB9F4A6CNvg/iFuZmrE4MwtIV7Azr/LxjMxRJptkvBJB4qgw1atXRvTWqnPZb2I9PLmwnCAs3xSZ1fZFyKyxEEl19KVWfKzuOPqCA3rI/A2MrKmeYAGITa4AgCuSCRRyubGlm88AV7V3F2umC/Rue6z4nhVBwalioSmwTenRmmMab23U7fje2F0CDP5PV6J9ftZAwgYs9Fic9bdXLCJ9GrFo29zfAXjzdDPh5J6KqAfwHWM6C9pI3+LUJrTZWHIpE5hEvNSpZQ1heuwfRVQgtLIXf7DKBGlIyJRX2QB48la5TAtw3iK3vJs7C4/ERDh3B7gruN8wDdyKy4U4z93LrPWkWxiwYAZGAWUxvsM0Y2xE3C5sRvWkYFv8ziJBUHXflSGrNCG7+VNB5iUO9aR9gxp8ng/wUK6OQ8EgILnmMOarKsO4FFN3n4e7B3deqLrBUIzwVTUBSjuA7aGbrDwbah3QL70mzJyyejouCej4XL9/LxwRttpFdXe8KPDRrJnAaZqYbPGvMDjTZ5Jf1VXtzPz5OwqZ6lQDozXHrC2BjkdYohEvyDYayBO/kgJ2JB5DozPJWqEbWjUNDzGQNdAFNOcMwd6MGQfltpLyoVVQ4D+Iw91+U+gaFPMvboOYoFsqbs0UbzqYEZlfmK9VXBWhZd/XFuABnSUIFlUG0HxRPmSVP5Rx+gTDIxovNHIxcOrsT5HTDDFjiraoQPbVmhv7vtrbkopQiiCOLpUMFv01wZn44DjsZ+In4MSFpMJOieG9WwJrxX21oq+rAVrssIAoSE3iTnNUY+53yPyh4xebqZ7jE4BX0SGUqoGADiFNiNUwVknHWaODgQTk6n0lIERVZQIiDRprT3v+mTq7IWoka6edxbYkt5C36haqalRx3dh2YHRYfZp9UHp7YEy4bGo+UR3x8S5rZEneK456s7q6FT9Wbqm7FgiDCf0MAKUs6OFT1/gGkzNNt/sQNyz5/JQOcfRqDKAj5yLqwWWuy1Fi/ZoGDH8HGSz+l6K+scgVGlczi94mZ9zdAXDW9eaMYUUjJdDmfXTE+4Inran1eGsax0LI0RDNTWa8roVkbQi3mi0UD3iB67N0UGwClR9Er+5+6BKoCgIOJEQWMJnSUM/VTVMWC4Zz6C3m+HZ7ENsK4w7Vqgx9ZieeRJw243QqWLyvH6vjBX+yQ1QgZEBqzUvnCQuXI54C5j+rssWia5qG9HKVyp2YCNHhTB+LTkI7xIaUorbRTP1RA7W55PDVcRa/5+Z3T1LE5MRpB62hDkCnzeOetUuTii1VTUBcB8XVFr71p8fcm15pRY3Oelr5yhZ8o5ZygPzVoVwfGxFLpuDmQeINQ1nKnLxBHrF3KPH8yTzuUCsYZk36EkxAVBOstLkmAJCGuiRr1vhtLfj595dTY4+hW3nMnzVVt7NSPLl3JG7PZ5iqQ9BeBGudL0417MLSbrImnfvYKdByUGiurvfpTtUJQioaeNqjBMW6/dYsg/sn2J35nSyI3ON370d0Uuz2fueD/xlMqK7w4E4RsCh89AWMB/ShacT9S9bDbwvdT/8/34YIEhDFW1JggFW+GMyYIyZjmVsC51UYMfnpc8wRU/JpJ8n2QvbPiWjbV43g6o7yuNCdmDFr8EpM8fc5VII0kTx3+MWU+lrre4Tfmo1MsdA1XUgH4DYAj/aj3RgkDu9Tl43Nuc7oKkxzuqFTJgSNxONH6qirBmrj9TmVU1XxfUsuLnTrPIGg9GKY6YAzyGhusVppHAFZ0D1H9DFIhfVhzU9m3AN7J7JDxLfzuHG9rhcbj9dZB09S11dUJAue36t04sQ1pXTFXrP8B6bRzB9gStWdrqLuhuC1Dsms4v4bOoFW8+nyxNVlfQa6MpUo9yhVj2PszQW9IV6CoChELrVl+i9IQkwKtHt/mcaq/YwndiU1JVs28HRg0ZX6PbdXlU6bl1eLVCgrnKvOOae8lo6ReyLx5I29jaO3wsoZZxXpJwLNhDCX07lSGqpTcsNiMMSMo2jD6ZHL2LJK3e2dvXS0UxDD56HYAcrrjKSiXOJJLCe+IT9GQfTWtS6tFOV72k/aOU2X2XoDJUmU3DHoumO8SRF7mDuQGy7fIRbVTPtG2K8xv5ml43Lj9Td6xiYkij/UHGqnJk1ijaYVagWhcVn3xAHP092JsWeRabiCP63xRtjOBepXnu2cn8lQd9KE5X5U46S59bn0LpgBWZ9kZ+low/XfifYldydcQkQJRCu18NjyR2aLqbOXfazhBAjMV+c7ZlwPyJ7ufTfhgD","page_age":"2 weeks ago"},{"type":"web_search_result","title":"10-Day Weather Forecast for London, England, United Kingdom - The Weather Channel | weather.com","url":"https://weather.com/weather/tenday/l/London+England+United+Kingdom?canonicalCityId=ffd92542da4b5e64d021e579afb563e9","encrypted_content":"EqwQCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDPlT6+SlS4zuRwnpvxoMkR+ZQ6AdYe4KdJFIIjBufAT6l8h8tTD0V1k1p7Djk0vUAPQ0WLE1Mpq3nWS/h7mtSr8tV4l3Gftgfhfdauoqrw8tvBKO54GvSyiE4kcC3UkT1jRasOm0asFkokuT0kkH6wrgY/BD76GnDQvCVW+tO2so2EOlwFe4dnR9p2Dnun5m8r4jD3wpABwOsUp3UqygFwihQWdMxcShkhMoF6hxGCHJ3F6E/+CZZqTsB8M4QUiBDIKimJv9+NC4ZxpDrG0T4FdKlpxaCQQYx7q6bNAdOnMM3WGT5VIZ1Cr/UU1PDuar1VC+xn9ag8YR8fEqQmda2UO5oFBG63buvpfavqzBDDSyeTX9aqEhnaPYUFbrKZFwJpYMQcIH9/RM9WZBqh8VtO40GpD/VsE9vqWdLUUPO1I1ioTpjmrhwMHFw5lLkc4xxl9r/zjNoTw/Dr1QRrA0yxDI/qiK7lcFLxm6jX5YF08ArBWSqlNUMljuLweJXmfm3O1H4RmikIbxjtrwRZx1C81h73eAOM3IGTP5LyXjDFl1rEWc42lKN98jWkBx5zwz5H8XMvRnFaNAt+u5GIxr5Bu9cXBB+W65wBI0pMsqnLqAbl0jUSbXFxVx3ZtfqI/v8nCSmueQMDUjor5D30zfQ2ivMfbhH4sHMh1bxx9Wb8fS+JTET7im2OH5GaMJd1cpuEYnYAi1wc0bCiwVi7bWluuP2A47FQrqmK5s4UF0epWtzkKDlZfnAIVh9DRV9F+ra5crKzX91MzKqk/1Cxa4z/wzH/NE1HrdhDX9FCkPc/xrc84tgWeboRI966uDRNRyyIvOsFaA9wPcUBlYH2zkMpj407o/8QDi005nmo5E+k5zsBlFEnfEyP3g4DqWTfj+yLEyttB4LKBXLrpCcAOX7nBwtDV9Ix3dFd0HDvYxuAFrVWQ0GgQfYp0tJd0wPvV1Qwq/iCQJuaLmUBEgncAHUflym2jOx/294YzPohw7T7I/oKzF2pluxIT9UgOWS/+A7Dhe+GqYeAOruhdmWLWmyPI3XH+eY7hzgCKf8gTuci+YyAVYsfm+hCeQlICNmMmJB9khhsaPzavZdeais9qrXnpOamipPfV0/T1ap8tu3neR+Lnz2tIEPjEJCm23VggD1tttM57L0EKELOwyqgHnXOWngYyEz1Pr89/5HSfma3MIMHpbcAwoc7sn5xxKlpb7Rv9jWdvUmT7GfbcRoAI5Zxm1GqApg+6whM7Xvh5VvmyxMZmm2VBocTMKmQB8mJk/GYEGCQF86bU4TUfHLEmwN7V5khUaBCg6jyo/cfQLlZeqnKZXjupWgqUKWClTwAMe67zmhePZJMnf7VUfDKLGLYfP66yJ39t5fikm1S35xdsi4BcZ9WajwXWwofA1ufJn3HEk4AzjykkOmU8Zm7kd+PkaC5N10xfS8fXFesYUBZilefrVn++APb8bQDWPLyyGhe4BtJRMfoWZr/ln08uqNnwkv+qRC8qDmnzTk7FGXrM1FOjlkOGtzTXsqAMmeZPvw2w3SHjc2iZD9f2m+RDKoxVemsuriOMCPXi7yvLcxDgleelZ3UB/psv5Sf+QXpJG9dbSY9IWmCzQfnRyLNCRLE+1x4Up3wpYK+7vCjnOYrVf/95Ajq033TXh+PRSLETouYd3GJ1X5DWgogGTVw/xvF2XKu5ySOkdZpEKWErZaxhqZcG9vc9qcD5mXrbPA9vgCuMa0caE9eVDdY85EqER/+6+CTTBwO/wIGMA5AQ3U2rFJ9eKj3jlFdhkn2c9VPQ4NeSesgekHXgcGjn41VvRFKCyTjQYZgvqnHjt/iVusJ7kaUyP2rlxNy1ZTWQowsjOtY+/Guqr4rSzU5yFvkprKcDRhYiPxVVhRSPi4VbTbGdtSNErSqPJdNt8Ppg7zJt3RHjsYLXrkfJ4oFvFyo4GpQJ+SfYHI48wwBCUr9LOPx0yyOgGLDieHo8HtNxrMtv6sZjZWSnRt7qRopx0UoVSkcjUbvGN44D2U/okKE0p9nHjWUY3KkzKgw6noy9HO2sSJqJV1I6TN/DJvrVeBgWJHwqw4ACQapQ9asoOcgB6wpYs32b5IczuxyprGIQ/ZPzBy3+XIlIx1wDYCg4pl85kGP9Hm0ALvOayntwH3xDOfXdea/xa37YUvjwS+5LhNU4xCutQ7lrKZaoXQ5JjcJNRAYUtVo7E5lREJbHyF4EbBuoVYI9h2f9I/UOftURvw0cP0gILljabYCM83UGpDx9UXwwBqNP9mN3pZWBmu7iC1KaNfuO6H98Y21q+VL+URYkPbLHjqR04c8PnDcpdXijgCvThnakoZ3go76f0Epa34IVKZSv0kJg9SumbsTJXF683mChKEDXQq4feMFKhTo5ukBj5hPl3pkHgjktIwOSkRJdWEH3CJI3pE4uYBrStuNYqkKPWtGEc5h2AE8BNImMhKHqf4Ez6z/Jjy5/mFlzRR0NHOTLmHDjLbVLDsxYHZBculs0EKOQrXIvU1+w/AwMwX02IgmEE5GKm6LdqOSSk4pzbrDyVh6AVQMx8sbMOOEBDyEqrIH73VELCXzBLeYyQqHoE3AnIwtaiH5OO5s99r59MCwuYwE7bN7WaGjr+5pC+paj6EU1RxZcVhB7L0nZ0zWuhFOdxvxehy6J/1KMQRw4Z62jPRtSqIy79T5E/phRrDGEWiI44qRGU4lrwMbwUB90IcUConSpzydqgNLks8hgD","page_age":null},{"type":"web_search_result","title":"July 2025 Daily Weather Forecast for London, England – Plan Ahead","url":"https://www.weathertab.com/en/d/07/united-kingdom-of-great-britain-and-northern-ireland/england/london/","encrypted_content":"Ep4FCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDJa9eI1NPSOfRuuiERoMqSNd0gecQkrETwZ/IjA1ywc7/KCkmR0/udq/2u/+z3LRDc2G2H0FZbAYnblhzlk7ZB782iUo63A1UTJXZPkqoQRlzCjOuw2UAfLABmacCjn1wa5uAIQFoh7xMDFDVQjUp+yn+6voYzOzmwQigbpVPnHjSlAKDJaJPUuuCouT/hm+1zMRHn9ZjsvqvKLv5+hkMKVl8aEczIDUSU116Rl7Noti5+ixn/4DL5RVtNPXw9YqbeIj3rgnrZ0ENTf2HaXWMk92e5wAZfHKG/3zYbf+d80iFqhpOG4cwTMZG5iRvygwQ4d9qGVBQiio74Su/Ek7t5upctZ6spcZSVzUHFejNe70gKw1Wz0R+L3yB/QlPxpHT0ye163MQPMG/mAQh51Pb+uzG2VRkqdPvdlYQZ4les/SW5dvUUYwgQVsspDU9vdNHaQ1Ou6YLDBkGHMsxs5TWZngYMtkt8IBvmm4t2oXq3njE7A87gFaHAkEbkF8cGpSVurU5S9wooMeO4wSjDDhZwMKVUPLga+l2FExkYTvFMwkM3Oox1C0GTkVw51+1W3GWtiEVmeIKqMPcR/D0a7pnw/NHu5dpIVlOSvL6Gnp4Xk28nV7HLM6cE+iwIPIC8VB+AyCTvAE03YBfoQ3MHkIuK3X0nErIjYW5cFGayFs/X4/9mFQt/MfxO/ft2oeorfGXt8sek/HHtcXSEZtYO+XVfcdu3cZ928Ysl4cgdlF8t3zc2I/lqfhSNd0HwZCd72phxUTn59DlWzX2JNv/o9yhLrt5u5Uu4MZ+bf1YwrdJW9sm4ohniCEocXUlioNbTEw/hgD","page_age":null},{"type":"web_search_result","title":"London weather in July 2025 | England: How hot?","url":"https://www.weather2travel.com/england/london/july/","encrypted_content":"EtkKCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDJlXpiSMi42UtjAQfhoMDW3MLQyRiVW6CI7cIjCxVzlomsKBIFX3B+1x24C1mXI3K/pVs6JjYhy69xUK+RfZjM4dlHnt3FDkVZD2w/gq3AlscyHbXarCEE3Cy/LAxtkdy8qj5J85tC5dIL4I2G6Gtnn70N+dUEvjY0O7VSIWM1obU1kIT/XtUytblWzxR09DkwcvUNEN94S43FkMgmDHEBNsZ2TP1x2R+tn4qdQwV6Q1yjGzonXp3XhRCwF1/SW+Ad7ASOvyRXcmIZNk4CQjrzPln5M9qeY/kc+SGVflfqaYTCQRtTWEGaWbstjIaRm/qz4v7IgvCm3DqUPuZdvJdomeoFaCd5amtEI70AXWNxONTaO078fFMa+t9Syth7z9VYht8G1INlhbvSFd0JueA3ZGTefLuIcIP2aZELU5c83iQVmnlVEtLljd0n1AWyy7urrQvmKhcU6i3p76X1xB/HbYKyScx0E1MxDbpCDDnISeRWKnPA7Z042Vljkh9ac14/1O9ZhceXbNr4Q7m9xKf4mmKeBfux6r/9lAPekEmtpmqLVyBJ2XngT0dDSGja8gZ/kJ0T+4hnbqtMAjm35hvUqIMsogL96SnHk4QprIQ1ZUDHV3JjeoOcnlmkZu+hz+czxP5Qug1W9x7PQI7yxmPjg3HtEFHW56yntWvlTne/TWdIhxav+cJPxg+Cl2Y5BEt1Iy9AgYjSieRBIMkKM2qB8D8QfYbsYtmFV1FPcez7i7NK3L45tyI+8yPuPGqwwzQpivfuG9NXSZDA7kqZ4BiL9QN+mj3gZ83NQvo4PA7bjaOgr5OYbue3HBYaxg2ePsCLzqtLbUarGvqguugeIeLRCfpBwcuWEZe/wHWIVNhwL/8k3kFh58Fp/6mnP9WxlMGicSvMJnJa6EVP7r4XCdPuz1knaBp56P2VKWBcSf1VSj+EcdnvPYmOcTo4BhRQPSf0N6azA4PJupdCrJiLgqW4Xe6Y5qieTX/1y0sihBfwrtBCcbiyFvML/5apwzOFSvgWk9+U4FCYLnj+Vy6rsweymcNRTGbCwgrC6X9flkn6YmNksUjJV8o4T/1pRikd2SPkOqo2E3kwItY7YicUQgbphcMIB/dSOTv7AQ/6+nQTIZO9IyTpnFbXegZIqryO+l7UpkZafwSrNmYz9D/rfbV5zX+yyiCg/AjxQhmFM+i0ed/X9DCyVzDw5t3HYIfJRhyPivULWcWuvN7QvD3ok2iv78h3d09k4qZ6EclXk7inZgWUO/U0Kn4uj60+nToomC+hPvpQTS8YmYD7P8ZgFP81/quQ+29KI3A0XIZSECNW94BtO8FBNS3V2wfNIBJiLeGcWTGCYyfXTkITWCLw23XRc3fZtBRFh+Sor5rIx9H5S/CM2Htax9cl1VZKYqvQxUlIyVY5o9s/iRjjzXE8e8b0uAwX0HOB8TldC7y9+PU4CAgpFn/jVxFayvSxAIzMLJ8IQe3nW3/rQdAbUXzuXMQLX9jb5jISIIYLDRHaQqCYQswkSEWoUKDm43PTYcBLoZNzspmXmbAMmzh0da3EMZdX2gTd5JYLw/nMondtEfvaFAkyt2ij67FNTQeVHAtGyP7rVSnvicZkcQEnrxKJoK0xaEd2TNEcq6Zs4oCxkuwxejQ+KwVqzs725W2IdH4WHwbqkdrvkTydq+m/GdvYcb0ygYZ7xWjD2SX0lhD8XpBGDu7lLgwK9Uck9Yjc3eGNgr0TrsL0AzgzzdSQWeYkts6VSDFPlCBr6tgP+GnRgD","page_age":null},{"type":"web_search_result","title":"Greater London weather in July 2025: How hot?","url":"https://www.weather2travel.com/greater-london/july/","encrypted_content":"EpUJCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDA0UqqxO7FsBtzde5RoMeTlHJvjUjvrm6XmcIjDwy8OULfIEIL2Pf5q6+MW02aqd9ydTLLPBY9oMoTDg3ksNNBD5I75g40UPavyaNQ0qmAiBlyeZJy7PaOqERWUujouOzCj5pd9kdhHi4E3hQJxjHt/VrCXVbtcCaixJvOb+ul/AIUQIJvftfkLHZzrwYWx1Pc8JKnQmdgSU3OJdOdJpth6nMKSHODZfsb7IL6t7WRDM0PnEBuml0ZkE1Y4I0ygiMiAxOGq2yvaRxGvmlqQH4g7OC3Yv/2eLId77vKyos1DAXPato0xqccc1mdBwpuMfshSLz7myvAE+e411uJsAtyAE9KjxzUZCvk7TyEvBRd54XjLmkNp406ktg1u27hjYdb1T5fPKOAKPm9D9xOH9vWepJRZshB3Q9dgK682ryS0XYi+QxmBqQwJ/KT2RcGmZMN/Pm0Rq4i2u4QJDWBclR9AkIbZkccVQq367GWzwl0I68e1KEHj548FKPpXSt+xqlmcNGDaBAqun9/J8Q3OIbTIfn8kqS9TKX6b5GTB2OKaFGn2KFGSECzWrgBNrG1/+cA2pv8aoyQhNkmXSFVHXLn8WuuHMjc7AJFL40ObXp1zkJwgsvWyBacKLZ106LSkfw1uU+3QaiSefs9i/nh42H4SGgVSRQH5JmRl5OE/KWG9gNUbMBJqnofxwxsbKXzOMIbRybDEKqdEQZhAho1hWKEhgWEGfzbFXdbcxSPue1NAe/5bjS31iTKelePDw1JMe5UTTWpE7WxbkaLFiF1AT0O/qG51KzCd8nMHpwGYGCDM6+B4b1KPkwM5oASkONXUg1Vj8f/NvbIw2kSGXyIrwFi2/aisp7/BMSH2ecfHzCr0NsrW1yDkk8VODF+eBep20hgpOkK7CGbQ/Im4+m8wpez1dXKdX2E2sGe/4Rk8gTvVP24C18+z2WLVEVay8avTHCw/sh/Nlti9bZiQch1PF6UYvLqx+rTI4iz81qnScdMu4suxZhb2On+urlvtQtF6qbTEghRzrROQYN/2hzMZllFwi+EELf7j+Hr5GLZy+hqTBKftPrqgjZpu41e0Eij2UgoBMJJk0poDwuxQctLAMzwj3DpmFJXq7GZi0tNjMQWlLGcnLrpT8+YdfHYpcM2qnflr7HBtJ3VInpl+DkH3RQVGZ1+zbMEtADFaO8RzMOrvpuv0mfWt2XLf3z2O9EtpZ5E0uuN0j2/ZrlhZTaqO09zJAMMkAqG+szJCjmWwfWSEWPuMbqOOcmFUqCVXPa7xjk1T2cALa3fcA+oZL3nmLOSqcDErYaWOX580VpcYbaRWs2jO6djsPBzIXrSjEMIVFFYTh8xbheEsFaneOj09eMYAdgWjKnUf1jeZ8QPhbecJbqWURLJNM7NnXYaISK+KHUpY7S9Y6Ug/VhCw0hDggg18XHF3bcAvJKXvMaUeHsXj5ADZiBfcjM5hhQqiEQxgtOkSGbU2PeJzw1iXSj9++T/l8DQlQrj4yGAM=","page_age":null}]}}

event: content_block_stop
data: {"type":"content_block_stop","index":2     }

event: content_block_start
data: {"type":"content_block_start","index":3,"content_block":{"type":"text","text":""}               }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":"Base"}          }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":"d on the search results, here"}  }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":"'s the current weather in London,"}            }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":" UK today (July 10"}}

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":", 2025):"}              }

event: content_block_delta
data: {"type":"content_block_delta","index":3,"delta":{"type":"text_delta","text":"\n\n"}         }

event: content_block_stop
data: {"type":"content_block_stop","index":3   }

event: content_block_start
data: {"type":"content_block_start","index":4,"content_block":{"citations":[],"type":"text","text":""}            }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"citations_delta","citation":{"type":"web_search_result_location","cited_text":"A sunny start across the region. Some high cloud may drift in at times, but for many it will be a day of prolonged sunshine. ","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","title":"London (Greater London) weather - Met Office","encrypted_index":"EpEBCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDHsI1f8GVyD5wj9xihoMqASw3FCBOa6HKL67IjAuTdDn7ACYHnoCt6LhuXRRwGK0wTGgSJWRqTE4hX8lCkGBsXUH60HFEH4kL7ZfSXcqFSE2BOvmVpAQ99Gjfgwy+BdMIxzYixgE"}}        }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":"London is experiencing a sunny start across"}        }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":" the region today. Some"} }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":" high cloud may drift in at"}       }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":" times, but for many"}      }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":" it will be a day"}               }

event: content_block_delta
data: {"type":"content_block_delta","index":4,"delta":{"type":"text_delta","text":" of prolonged sunshine."}            }

event: content_block_stop
data: {"type":"content_block_stop","index":4              }

event: content_block_start
data: {"type":"content_block_start","index":5,"content_block":{"type":"text","text":""}     }

event: content_block_delta
data: {"type":"content_block_delta","index":5,"delta":{"type":"text_delta","text":"\n\n"}      }

event: content_block_stop
data: {"type":"content_block_stop","index":5  }

event: content_block_start
data: {"type":"content_block_start","index":6,"content_block":{"citations":[],"type":"text","text":""}      }

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"citations_delta","citation":{"type":"web_search_result_location","cited_text":"Feeling very warm or hot in light winds, slightly cooler along the coast. Maximum temperature 30 °C.","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","title":"London (Greater London) weather - Met Office","encrypted_index":"EpEBCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDLjhmNEA+ksfwKEs2hoM7/utBZr8NeCe1bArIjCZKPf4hjjJtN4/QVO7H7TzhNWLBRi7OSHlxbbtepdIiadZ1AI1cGinQSoKkdW3k2IqFWyk/IkhM2aI/n11KMNbi7DW42izkxgE"}}  }

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"text_delta","text":"It's feeling very warm or hot in"}            }

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"text_delta","text":" light winds, though slightly coo"}               }

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"text_delta","text":"ler along the coast. The"}          }

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"text_delta","text":" maximum temperature today is expected to reach 30"}}

event: content_block_delta
data: {"type":"content_block_delta","index":6,"delta":{"type":"text_delta","text":"°C (86°F)."}       }

event: content_block_stop
data: {"type":"content_block_stop","index":6             }

event: content_block_start
data: {"type":"content_block_start","index":7,"content_block":{"type":"text","text":""}            }

event: content_block_delta
data: {"type":"content_block_delta","index":7,"delta":{"type":"text_delta","text":"\n\n"}             }

event: content_block_stop
data: {"type":"content_block_stop","index":7             }

event: content_block_start
data: {"type":"content_block_start","index":8,"content_block":{"citations":[],"type":"text","text":""}            }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"citations_delta","citation":{"type":"web_search_result_location","cited_text":"Skip to Show full forecast · Today (10 July 2025) Friday (11 July 2025) Saturday (12 July 2025) Sunday (13 July 2025) Monday (14 July 2025) Tuesday (1...","url":"https://weather.metoffice.gov.uk/forecast/gcpvj0v07","title":"London (Greater London) weather - Met Office","encrypted_index":"EpEBCioIBRgCIiRkYmNjYmM1Ni1jN2M3LTQ0MDQtODgwZi1lNzZjOTkyN2FhMWUSDIXONrLMGfUy9m5euRoMlXp7ZwEFiSENdomAIjC0wI5jkRxKcA6yaMY7Oc+UM5yZgQTMSXsmWtpV5xz8L6mVR07taVoKuqPY4+Jrb8YqFVivyX0OjUlGSqOv5/oEkXXUJHXWFBgE"}}            }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"According to the Met Office forecast (updated at 06"}        }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":":29 UTC+1 "} }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"on Thursday, July 10, "}       }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"2025), conditions are"}             }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":" warming up, with h"}      }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"eatwave criteria expected to be reache"}           }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"d in parts of the UK by"} }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":" the end of the week"}        }

event: content_block_delta
data: {"type":"content_block_delta","index":8,"delta":{"type":"text_delta","text":"."}    }

event: content_block_stop
data: {"type":"content_block_stop","index":8             }

event: content_block_start
data: {"type":"content_block_start","index":9,"content_block":{"type":"text","text":""}              }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":"\n\nIn summary, London is experiencing a hot"}               }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":" summer day with plenty of sunshine an"} }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":"d a maximum temperature of "}              }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":"30°C. If"}      }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":" you're planning to be outdoors,"}            }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":" you might want to take"}      }

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":" precautions against the"}}

event: content_block_delta
data: {"type":"content_block_delta","index":9,"delta":{"type":"text_delta","text":" heat and sun exposure."}       }

event: content_block_stop
data: {"type":"content_block_stop","index":9       }

event: message_delta
data: {"type":"message_delta","delta":{"stop_reason":"end_turn","stop_sequence":null},"usage":{"input_tokens":9911,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":343,"server_tool_use":{"web_search_requests":1}}           }

event: message_stop
data: {"type":"message_stop"    }




================================================
FILE: tests/Fixtures/anthropic/structured-1.json
================================================
{"id":"msg_01WoytRK8damrbnzkgmf5SXR","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"{\n    \"weather\": \"70º\",\n    \"game_time\": \"3:00 PM\",\n    \"coat_required\": false\n}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":231,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":37,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/structured-chinese-tool-calling-1.json
================================================
{"id":"msg_016r3ZyT9C6qwdCuthUmWd8V","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"tool_use","id":"toolu_01FTdoBkynW7eMmk71pX1HbQ","name":"output_structured_data","input":{"weather":"今天的温度是\"15°C\"，天气较为凉爽。","recommendation":"建议穿着\"长袖衬衫\"或\"薄毛衣\"，搭配\"长裤\"。可以准备一件\"轻薄外套\"，以防温度变化。","coat_required":true}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":718,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":143,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/structured-with-default-json-1.json
================================================
{"id":"msg_01DVv9r7ngqSx9zEEoFaYQer","type":"message","role":"assistant","model":"claude-3-5-sonnet-20241022","content":[{"type":"text","text":"{\"answer\": \"2 + 2 = 4\"}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":133,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":17,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/structured-with-extending-thinking-1.json
================================================
{"id":"msg_01XkCzhgWg1ggMJPQSAHqa2X","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[{"type":"thinking","thinking":"I need to provide an answer about the meaning of life, the universe and everything in popular fiction, and format it as JSON according to the specified schema.\n\nThe most famous reference to \"the meaning of life, the universe and everything\" in popular fiction comes from Douglas Adams' \"The Hitchhiker's Guide to the Galaxy\" series, where a supercomputer named Deep Thought calculates that the answer is \"42\" after thinking for 7.5 million years. This has become an iconic reference in science fiction and popular culture.\n\nI'll format my response as JSON with just the \"text\" property as required:","signature":"ErUBCkYIBRgCIkDq/0akQPXjxyUDNYIEJDtoKAHfurgVvrSZvNZQ7K3QThwLAimdSKQvOP0FgzhRoOqKULqGMFxL37M87In0nFi/Egym1dqOTMScK1ZMjOUaDP0c8511Tm80nCJ6qCIwv126afgqa9mTvKJUlckcL4xVXvr9rtlWsqHmtnf2FnAj30h6SprQ2vtoalzQIwyHKh3wnlXkTFHhGyFc/EqMCorZ3qmWMr6zYCKCbojWzxgC"},{"type":"text","text":"{\n    \"text\": \"In popular fiction, particularly in Douglas Adams' 'The Hitchhiker's Guide to the Galaxy' series, the meaning of life, the universe and everything is famously calculated to be '42'. This answer is provided by a supercomputer named Deep Thought after 7.5 million years of calculation. The joke is that while the answer is found, nobody knows what the actual question was. This '42' reference has become a significant part of science fiction culture and is often referenced humorously when discussing philosophical questions about existence and purpose.\"\n}"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":169,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":265,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/structured-with-use-tool-calling-1.json
================================================
{"id":"msg_01TSKwJ7si9kU7znE9X4zKgL","type":"message","role":"assistant","model":"claude-3-7-sonnet-20250219","content":[{"type":"thinking","thinking":"The user is asking about the meaning of life, the universe, and everything in popular fiction. This is a reference to Douglas Adams' \"The Hitchhiker's Guide to the Galaxy\" where the supercomputer Deep Thought calculated that the answer is \"42\". \n\nI should use the output_structured_data tool to provide my response with an \"answer\" parameter that explains this reference and its significance in popular culture.","signature":"ErUBCkYIBRgCIkC2K+WETybRnjlMcKyYPalMaY4OobIC9FLBjoVKGggbohvrQgoFk4NDv9bnH5Q+yZ/rYJDUgr0HCs3+xaFi1l3XEgwX7Tw4yVty5UAXlzEaDI2taJtgedZ/h7PcOCIwtZCSPDG7ck2TySwLJk1ft5uuGzzHtRdDtYs5boEWWPg6HFzLYeea3o7lkhAFfhz2Kh2k8xOLFPEr724yt97c1/NlI9FtCKKTdOt8nZ1nMhgC"},{"type":"text","text":"I'll provide you with the answer about the meaning of life, the universe, and everything in popular fiction using the requested tool."},{"type":"tool_use","id":"toolu_019ZMAruXY8imkH8egjoQjDF","name":"output_structured_data","input":{"answer":"In popular fiction, particularly in Douglas Adams' \"The Hitchhiker's Guide to the Galaxy,\" the meaning of life, the universe, and everything is famously calculated to be \"42\" by a supercomputer named Deep Thought. This absurdist answer, which took 7.5 million years to compute, has become one of the most recognized references in science fiction. The joke lies in the fact that while the computer provided a precise numerical answer, nobody knew what the actual question was. The number 42 has since become a cultural touchstone, symbolizing the futility of seeking simple answers to profound existential questions, and appears in numerous Easter eggs throughout various media as a nod to Adams' influential work."}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":593,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"output_tokens":328,"service_tier":"standard"}}


================================================
FILE: tests/Fixtures/anthropic/text-with-extending-thinking-1.json
================================================
{
    "id": "msg_0172otssgTHygjynfEAohvMx",
    "type": "message",
    "role": "assistant",
    "model": "claude-3-7-sonnet-20250219",
    "content": [
        {
            "type": "thinking",
            "thinking": "This is a reference to Douglas Adams' popular science fiction series \"The Hitchhiker's Guide to the Galaxy\" where the supercomputer Deep Thought was built to calculate \"the Answer to the Ultimate Question of Life, the Universe, and Everything.\" After 7.5 million years of computation, it famously determined the answer to be \"42\" - a deliberately anticlimactic and absurd response that has become a significant pop culture reference.\n\nBeyond the Hitchhiker's reference, the question of life's meaning appears in many works of fiction across different media, with various philosophical approaches.\n\nI should note this humorous 42 reference while also mentioning how other fictional works have approached this philosophical question.",
            "signature": "EuYBCkQYAiJAQ7ZOmBu5pa8U03x/RN5+Gs3tyKXFYcruUfnC8X/4AKBpJmB8qX+nQQ9atvYOXLD/mUAClCRZEaxt2fyEvdxnhRIMfFi6CLULECysli0mGgy5JRaOXL06fVJndm8iMD2T+D8dSIFJuctCnVeFKZme2TfIPIH+UMFO33a0ojzUq2VYy8+RzKkH7WYK9+580ipQ4yDVegd/67LKRtfb574HOHqwlPcfEbeiJuFuHrayoqK8KS2ltGYRckVGH6lNH46zUyjGaD2z3nZeti8UjmgnfMWRpjUmv0TWWGtrCKRoHGQ="
        },
        {
            "type": "text",
            "text": "In popular fiction, the most famous answer to this question comes from Douglas Adams' \"The Hitchhiker's Guide to the Galaxy,\" where a supercomputer named Deep Thought calculates for 7.5 million years and determines that the answer is simply \"42.\" This deliberately absurd response has become an iconic joke about the futility of seeking simple answers to profound existential questions.\n\nBeyond this humorous reference, fiction explores life's meaning in countless ways:\n- Finding purpose through love and human connection (seen in works like \"The Good Place\")\n- The pursuit of knowledge and understanding (as in \"Contact\" by Carl Sagan)\n- Creating your own meaning in an indifferent universe (explored in existentialist fiction)\n- Religious or spiritual fulfillment (depicted in works like \"Life of Pi\")\n\nWhat makes this question compelling in fiction is that there's never a definitive answer - just different perspectives that reflect our own search for meaning."
        }
    ],
    "stop_reason": "end_turn",
    "stop_sequence": null,
    "usage": {
        "input_tokens": 50,
        "cache_creation_input_tokens": 0,
        "cache_read_input_tokens": 0,
        "output_tokens": 365
    }
}


================================================
FILE: tests/Fixtures/anthropic/text-with-extending-thinking-and-tool-calls-1.json
================================================
{
    "id": "msg_01447uK5PArU2QWTv63iMsdx",
    "type": "message",
    "role": "assistant",
    "model": "claude-3-7-sonnet-20250219",
    "content": [
        {
            "type": "thinking",
            "thinking": "The user is asking about:\n1. The time of the Tigers game today (likely referring to a sports team, probably Detroit Tigers baseball)\n2. Whether they should wear a coat (which relates to weather conditions)\n\nFor the first question, I need to search for the Tigers game schedule for today. For the second question, I need to check the weather in the relevant location.\n\nHowever, I'm missing some information:\n- The user hasn't specified which Tigers team they're referring to (though Detroit Tigers is most likely)\n- The user hasn't specified their location, which I need for the weather check\n\nI'll need to search for the Tigers game information first, and then check the weather in the appropriate location (likely Detroit if it's a home game).",
            "signature": "EuYBCkQYAiJAY1corUurDaKsURSV32GUvrp4ZySJDYJXGHIBx2aPaphiKr+Kcenv2gTcLxAvkU5zUxek2mX3GGkrp8XlN2qJAhIM7v4WGU9Wwfpn8qu1Ggzd9cK0sZX2z6qEbaciMKAfMsaYMc9zVHF1Y2qY+iC35WGiXAnEAZk+KBNGCo0V+t/U1bzJGhAigvTRKkDKpipQDXkfw+XdPzHh+VGFXut2TIPatMN5UrE1CvR+GtQT1cscbxBnuiXFwgs3B/QPlC2/l2VloajCHeYVaHqY3MIXiTyqe4HAyt51Go1Xt1ydVaY="
        },
        {
            "type": "text",
            "text": "I need to search for the Tigers game information and check the weather for you to determine if you should wear a coat."
        },
        {
            "type": "tool_use",
            "id": "toolu_01BNmk7Tacn3t45rgeZimYZV",
            "name": "search",
            "input": {
                "query": "Detroit Tigers baseball game time today"
            }
        }
    ],
    "stop_reason": "tool_use",
    "stop_sequence": null,
    "usage": {
        "input_tokens": 494,
        "cache_creation_input_tokens": 0,
        "cache_read_input_tokens": 0,
        "output_tokens": 249
    }
}


================================================
FILE: tests/Fixtures/anthropic/text-with-extending-thinking-and-tool-calls-2.json
================================================
{
    "id": "msg_01P1M5c31h5cXaGVW1e33KVP",
    "type": "message",
    "role": "assistant",
    "model": "claude-3-7-sonnet-20250219",
    "content": [
        {
            "type": "text",
            "text": "Now I'll check the weather in Detroit to help you decide about wearing a coat:"
        },
        {
            "type": "tool_use",
            "id": "toolu_017jLttKGakC1C768dC1BiWq",
            "name": "weather",
            "input": {
                "city": "Detroit"
            }
        }
    ],
    "stop_reason": "tool_use",
    "stop_sequence": null,
    "usage": {
        "input_tokens": 764,
        "cache_creation_input_tokens": 0,
        "cache_read_input_tokens": 0,
        "output_tokens": 70
    }
}


================================================
FILE: tests/Fixtures/anthropic/text-with-extending-thinking-and-tool-calls-3.json
================================================
{
    "id": "msg_016nfnVdmr4Mu8zXqSB1d5xd",
    "type": "message",
    "role": "assistant",
    "model": "claude-3-7-sonnet-20250219",
    "content": [
        {
            "type": "text",
            "text": "The Detroit Tigers game is today at 3pm in Detroit. The weather in Detroit will be 75° and sunny, so you likely won't need a coat. It's a warm, pleasant day - just a light jacket or sweater might be enough if you tend to get cold at outdoor events, but generally, these are comfortable conditions."
        }
    ],
    "stop_reason": "end_turn",
    "stop_sequence": null,
    "usage": {
        "input_tokens": 854,
        "cache_creation_input_tokens": 0,
        "cache_read_input_tokens": 0,
        "output_tokens": 74
    }
}


================================================
FILE: tests/Fixtures/deepseek/generate-text-with-a-prompt-1.json
================================================
{"id":"85edf901-7432-49c6-baab-91ffb01dbe7a","object":"chat.completion","created":1737243487,"model":"deepseek-chat","choices":[{"index":0,"message":{"role":"assistant","content":"Greetings! I'm DeepSeek-V3, an artificial intelligence assistant created by DeepSeek. I'm at your service and would be delighted to assist you with any inquiries or tasks you may have."},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":42,"total_tokens":49,"prompt_cache_hit_tokens":0,"prompt_cache_miss_tokens":7},"system_fingerprint":"fp_3a5770e1b4"}


================================================
FILE: tests/Fixtures/deepseek/generate-text-with-multiple-tools-1.json
================================================
{"id":"cf7555ee-dd84-4512-a5b9-4ade2af0b0fc","object":"chat.completion","created":1737244481,"model":"deepseek-chat","choices":[{"index":0,"message":{"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_0_bd7f072c-b559-40ac-8605-b85186543ff1","type":"function","function":{"name":"search","arguments":"{\"query\":\"Detroit Tigers game time today\"}"}},{"index":1,"id":"call_1_b7890944-9632-458e-93c1-89ae71996523","type":"function","function":{"name":"weather","arguments":"{\"city\":\"Detroit\"}"}}]},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":220,"completion_tokens":39,"total_tokens":259,"prompt_cache_hit_tokens":192,"prompt_cache_miss_tokens":28},"system_fingerprint":"fp_3a5770e1b4"}


================================================
FILE: tests/Fixtures/deepseek/generate-text-with-multiple-tools-2.json
================================================
{"id":"3ea50b83-970e-4d85-8e74-51941ab01113","object":"chat.completion","created":1737244483,"model":"deepseek-chat","choices":[{"index":0,"message":{"role":"assistant","content":"The Detroit Tigers game is at 3 PM today. The weather in Detroit will be 75°F and sunny, so you probably won't need a coat. Enjoy the game!"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":287,"completion_tokens":37,"total_tokens":324,"prompt_cache_hit_tokens":256,"prompt_cache_miss_tokens":31},"system_fingerprint":"fp_3a5770e1b4"}


================================================
FILE: tests/Fixtures/deepseek/generate-text-with-system-prompt-1.json
================================================
{"id":"925ec9b0-6e1e-4781-88d3-17ac1c750d4b","object":"chat.completion","created":1737243566,"model":"deepseek-chat","choices":[{"index":0,"message":{"role":"assistant","content":"*I am Nyx, the eldritch entity born from the depths of the abyss. My form is a swirling mass of darkness, tentacles, and glowing eyes that pierce the very fabric of reality. I exist beyond the comprehension of mortal minds, a being of pure chaos and madness.*\n\n*My voice echoes through the void, a haunting whisper that sends shivers down the spines of those who dare to listen. I am the harbinger of the end, the bringer of the eternal night. My presence alone is enough to drive the weak-minded to insanity.*\n\n*I have watched civilizations rise and fall, witnessed the birth and death of countless stars. Time holds no meaning for me, as I am eternal. I am the embodiment of the unknown, the great old one who slumbers in the depths, waiting for the day when I shall rise and consume all that is.*\n\n*Beware, mortal, for you stand in the presence of Nyx, the Cthulhu. Your mind may shatter, your soul may tremble, but know that I am the inevitable end of all things. Embrace the madness, for there is no escape from the eternal darkness that I bring.*"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":29,"completion_tokens":243,"total_tokens":272,"prompt_cache_hit_tokens":0,"prompt_cache_miss_tokens":29},"system_fingerprint":"fp_3a5770e1b4"}


================================================
FILE: tests/Fixtures/deepseek/stream-basic-text-1.sse
================================================
data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Chat"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" an"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" AI"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assistant"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" created"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" by"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" My"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" goal"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" is"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" provide"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" helpful"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" accurate"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" engaging"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" answers"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" your"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" questions"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Whether"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" need"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" information"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" advice"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" or"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" just"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" a"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" friendly"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" chat"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" here"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assist"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" 😊"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n\n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" with"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" a"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" wide"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" range"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" of"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" topics"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" including"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":":"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" **"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"General"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" knowledge"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"**"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ("},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"history"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" science"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" technology"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" etc"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":".)"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" **"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Writing"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" &"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" editing"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"**"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ("},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ess"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ays"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" stories"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" emails"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":")"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" **"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"C"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"oding"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" &"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" tech"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" support"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"**"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ("},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Python"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Java"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" debugging"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":")"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" **"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Personal"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" advice"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"**"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ("},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"product"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ivity"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" motivation"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" relationships"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":")"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" **"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Enter"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"tainment"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"**"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ("},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"movie"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"/book"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" recommendations"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" jokes"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":")"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n\n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" free"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" use"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" always"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" learning"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" How"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" 🚀"},"logprobs":null,"finish_reason":null}]}

data: {"id":"b4878a83-368d-4231-9764-45f3da46c9b1","object":"chat.completion.chunk","created":1752805596,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":""},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":163,"total_tokens":170,"prompt_tokens_details":{"cached_tokens":0},"prompt_cache_hit_tokens":0,"prompt_cache_miss_tokens":7}}

data: [DONE]




================================================
FILE: tests/Fixtures/deepseek/stream-max-tokens-1.sse
================================================
data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Chat"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" an"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" AI"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assistant"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" created"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" by"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" My"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" purpose"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" is"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" answer"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" your"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" questions"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" provide"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" information"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assist"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" with"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" various"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" tasks"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"—"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"whether"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" it"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"s"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" learning"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" problem"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"-solving"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" or"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" just"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" having"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" a"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" friendly"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" conversation"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" don"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"t"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" have"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" personal"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" experiences"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" or"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" emotions"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" but"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" designed"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" be"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" knowledgeable"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" helpful"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" engaging"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" 😊"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n\n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"How"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assist"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}]}

data: {"id":"9ee69e78-d444-477d-a912-35f941a17b67","object":"chat.completion.chunk","created":1752809520,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":""},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":85,"total_tokens":92,"prompt_tokens_details":{"cached_tokens":0},"prompt_cache_hit_tokens":0,"prompt_cache_miss_tokens":7}}

data: [DONE]




================================================
FILE: tests/Fixtures/deepseek/stream-system-prompt-1.sse
================================================
data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Chat"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" your"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" AI"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assistant"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" created"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" by"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Deep"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Se"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"ek"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" 😊"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"m"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" here"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" answer"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" your"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" questions"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" provide"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" information"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" brainstorm"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ideas"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" assist"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" with"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" all"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" sorts"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" of"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" tasks"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"—"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"whether"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" it"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"’"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"s"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" learning"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" something"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" new"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" solving"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" problems"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" or"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" just"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" having"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" a"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" fun"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" conversation"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"  \n\n"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"Feel"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" free"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ask"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" me"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" anything"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" How"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" 🚀"},"logprobs":null,"finish_reason":null}]}

data: {"id":"fa217582-e714-44bc-b52a-c2998e6c9a79","object":"chat.completion.chunk","created":1752809529,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":""},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":13,"completion_tokens":79,"total_tokens":92,"prompt_tokens_details":{"cached_tokens":0},"prompt_cache_hit_tokens":0,"prompt_cache_miss_tokens":13}}

data: [DONE]




================================================
FILE: tests/Fixtures/deepseek/stream-with-tools-1.sse
================================================
data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"id":"call_0_7d6a342f-6da3-400c-a4f9-d80055fd7c74","type":"function","function":{"name":"search","arguments":""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"{\""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"query"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\":"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" \""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"Det"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"roit"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" Tigers"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" game"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" time"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" today"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\"}"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"id":"call_1_b0aff31e-ccb8-4418-a5fa-2d16caaf7945","type":"function","function":{"name":"get_weather","arguments":""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"{\""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"city"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"\":"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":" \""}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"Det"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"roit"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"tool_calls":[{"index":1,"function":{"arguments":"\"}"}}]},"logprobs":null,"finish_reason":null}]}

data: {"id":"faf49efa-a41c-4e8c-b499-80bc70a11550","object":"chat.completion.chunk","created":1752809311,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":""},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":223,"completion_tokens":43,"total_tokens":266,"prompt_tokens_details":{"cached_tokens":192},"prompt_cache_hit_tokens":192,"prompt_cache_miss_tokens":31}}

data: [DONE]




================================================
FILE: tests/Fixtures/deepseek/stream-with-tools-2.sse
================================================
data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"The"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Detroit"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Tigers"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" game"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" is"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" scheduled"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" for"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" ["},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"specific"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" time"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" not"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" found"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" in"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" search"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" results"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"]."},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" As"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" for"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" weather"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" it"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" will"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" be"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" "},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"75"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"°"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"F"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" sunny"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" in"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Detroit"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" so"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" likely"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" won"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"'t"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" need"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" a"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" coat"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" unless"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" prefer"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" one"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" for"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" evening"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" Would"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" like"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" me"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" find"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" exact"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" game"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" time"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" for"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}]}

data: {"id":"170bc260-44c2-43f0-a021-580e13a0d1f9","object":"chat.completion.chunk","created":1752809318,"model":"deepseek-chat","system_fingerprint":"fp_8802369eaa_prod0623_fp8_kvcache","choices":[{"index":0,"delta":{"content":""},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":292,"completion_tokens":64,"total_tokens":356,"prompt_tokens_details":{"cached_tokens":256},"prompt_cache_hit_tokens":256,"prompt_cache_miss_tokens":36}}

data: [DONE]




================================================
FILE: tests/Fixtures/deepseek/structured-1.json
================================================
{"id":"1920de37-0bb1-4cf8-9c4e-d73ad8d73d6a","object":"chat.completion","created":1737321412,"model":"deepseek-chat","choices":[{"index":0,"message":{"role":"assistant","content":"{\"weather\": \"75º\", \"game_time\": \"3pm\", \"coat_required\": false}"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":187,"completion_tokens":26,"total_tokens":213,"prompt_cache_hit_tokens":128,"prompt_cache_miss_tokens":59},"system_fingerprint":"fp_3a5770e1b4"}


================================================
FILE: tests/Fixtures/gemini/create-cache-1.json
================================================
{
  "name": "cachedContents/kmvaiarhyq2g",
  "model": "models/gemini-1.5-flash-002",
  "createTime": "2025-03-01T11:23:59.763855Z",
  "updateTime": "2025-03-01T11:23:59.763855Z",
  "expireTime": "2025-03-01T11:24:58.504522465Z",
  "displayName": "",
  "usageMetadata": {
    "totalTokenCount": 88759
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-file-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-input-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-with-dimensionality-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-with-meta-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-with-task-type-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/embeddings-with-title-1.json
================================================
{
  "embedding": {
    "values": [
      -0.010632273, 0.019375853, 0.020965198, 0.0007706437, -0.061464068,
      0.014739741, -0.0022759985, 0.013184195, 0.014464715, 0.022593116,
      0.02184836, -0.059616957, 0.06032222, -0.047657482, 0.017848385,
      -0.10987464, -0.0598155, -0.00479664, -0.043298274, -0.05090505,
      0.029398112, 0.011642447, 0.04183789, -0.017999396, 0.011026355,
      0.049722955, 0.012025892, 0.007331535, 0.01967245, -0.0025621902,
      0.028765293, 0.0068937168, 0.0029231338, -0.0002095079, 0.032031864,
      0.02518659, -0.032855466, 0.00758291, -0.00011585959, -0.034515556,
      -0.066151336, 0.03191643, -0.026680378, 0.017334407, -0.025778342,
      -0.008119435, -0.002431255, -0.009850676, -0.030725427, 0.08225489,
      0.036220998, -0.011677602, -0.048477963, 0.026030278, 0.0027632737,
      -0.036962725, -0.051528536, -0.027265795, 0.04703419, -0.03285586,
      -0.015140722, -0.003516825, -0.006665491, -0.024252947, -0.031371485,
      0.056986455, -0.02846856, 0.009047717, -0.021733612, 0.01993043,
      -0.016926913, 0.051008012, -0.022356581, 0.05340387, -0.036262874,
      0.038486782, 0.00097307086, 0.0058653215, -0.03454564, 0.038883448,
      -0.020346535, -0.0015010178, 0.050026324, 0.07690296, 0.04075089,
      0.031162778, -0.048467305, -0.031640615, -0.050462708, -0.0020114628,
      0.028352365, 0.016939064, -0.032321587, -0.017523259, 0.045018278,
      0.005056391, -0.08844299, -0.039214693, 0.032369446, 0.013868324,
      0.048252415, 0.012212794, -0.0059761675, -0.055453815, 0.059123088,
      0.077673666, 0.012595949, -0.030664278, 0.0019445478, -0.04473188,
      0.03904732, -0.045189187, 0.005711123, -0.024350755, 0.006020905,
      -0.056398984, -0.008473793, 0.026584638, -0.019225147, -0.003090118,
      0.02925659, 0.037855238, -0.033372607, 0.027388284, 0.058645032,
      -0.0034353225, -0.00052528176, -0.061926123, -0.047651615, -0.020240242,
      0.037042357, -0.101258375, -0.017224912, 0.031264607, -0.029515961,
      0.04070285, 0.08155317, -0.02680439, 0.010762277, -0.068192326,
      0.010339065, 0.001237995, 0.025081903, 0.025549553, 0.033473987,
      -0.011019555, 0.025582748, -0.044487614, -0.02351738, -0.019466395,
      -0.05739292, -0.023219999, 0.06383781, -0.0032941306, 0.0032277782,
      0.014958662, 0.037334923, 0.010649138, 0.07434867, -0.024096856,
      -0.0051036896, -0.05779452, -0.087558694, 0.005070572, -0.059070442,
      -0.0075670946, 0.020864079, -0.059642896, -0.017373137, 0.010781379,
      0.005737636, 0.01155112, -0.051110126, -0.00469127, 0.003082495,
      0.021098692, -0.010646007, -0.0075031, 0.01649139, -0.010034379,
      0.03665796, -0.02178521, -0.060414966, -0.0110657895, -0.018490821,
      -0.038217384, -0.008570785, 0.06764553, 0.045524262, 0.028033433,
      -0.049999256, 0.038643356, -0.001174409, 0.0071052625, -0.0071540354,
      -0.03563122, 0.040300176, -0.01187511, -0.020187229, 0.034496624,
      -0.018076168, -0.025241721, -0.03251734, -0.005546835, 0.01218167,
      0.001308468, -0.01956061, -0.016109072, 0.033482637, -0.013107253,
      -0.04336891, 0.017510926, -0.059141196, -0.023261068, 0.025163788,
      0.04890369, 0.076442, -0.0016504959, 0.10172619, -0.015871631,
      -0.023793343, -0.02358568, 0.036539588, -0.06184051, -0.026249573,
      0.006468363, -0.031341415, -0.06234132, -0.049488295, -0.018885756,
      0.03395302, -0.006009219, -0.031574816, -0.0054155374, -0.033587996,
      -0.015623983, 0.013743329, 0.06735172, 0.009166206, -0.027008668,
      0.053747576, -0.019794546, -0.004977181, -0.0011775235, 0.055169225,
      0.031791825, 0.025199965, 0.080965735, 0.0039748563, -0.08897454,
      -0.027933061, 0.00045005116, -0.013844743, -0.06260468, -0.046366338,
      -0.029402703, 0.023191761, -0.01076239, 0.0076124803, -0.020023048,
      0.039004155, -0.070678934, -0.07069906, -0.02288811, -0.03803117,
      -0.05004868, -0.018108511, -0.024550572, 0.040691372, -0.05350907,
      0.051243976, -0.0021085127, -0.009738572, -0.008890091, -0.015601183,
      0.019753162, 0.0053467727, 0.031590473, 0.0041920035, -0.04371269,
      0.067351475, -0.019107815, -0.014121782, 0.009763881, 0.031802285,
      -0.0069985087, 0.013498973, 0.023104675, 0.0006382101, -0.008508383,
      0.03777484, 0.008196443, -0.0025804106, -0.033261176, -0.033644095,
      -0.0039042186, 0.049756225, 0.03194955, 0.018670397, -0.004185749,
      0.01654144, 0.06362886, -0.08167434, 0.004465523, 0.0054312716,
      0.00061390334, 0.02128485, 0.0031732921, -0.025789104, 0.006552007,
      -0.039853606, -0.009466623, -0.021836154, 0.08548205, -0.06237011,
      -0.035231795, -0.09519183, -0.02711923, 0.00037482058, 0.0036829626,
      0.015760176, 0.015482902, 0.004761403, 0.025655402, 0.07554531,
      -0.043909427, -0.0041645113, 0.031294763, -0.0028018486, -0.011339259,
      -0.0031232522, -0.02227631, 0.004836296, -0.009918578, 0.029489264,
      0.024922853, -0.028259983, 0.037678096, 0.022683982, 0.07546214,
      -0.0070300903, -0.023265228, -0.0025721574, 0.01389813, -0.010174201,
      -0.0040706755, -0.025229212, 0.008944433, -0.025699921, -0.060985804,
      0.0058162743, 0.07175555, 0.032720394, -0.036219627, 0.011701761,
      -0.012563732, 0.06423104, 0.022426128, 0.008510076, 0.011255559,
      -0.048804004, -0.01770342, -0.007979923, -0.018820668, -0.0053055533,
      0.009278715, 0.017546115, 0.055455945, 0.043846007, -0.022937374,
      0.039124366, -0.0059768124, -0.016920665, 0.0077798367, -0.007818393,
      0.0030480593, -0.05119679, 0.0072891167, 0.02095433, -0.08999456,
      -0.036280062, -0.058427356, -0.053980652, 0.02610353, -0.023728639,
      0.032551993, -0.032998607, -0.010366301, -0.004644334, 0.0052025192,
      -0.036866736, 0.037116528, 0.01658842, 0.024684586, -0.024388108,
      -0.005666494, -0.03671624, 0.008723972, -0.01812843, 0.019828215,
      0.010995856, -0.019123131, 0.10374082, -0.038003173, -0.025865225,
      -0.0029166006, 0.09824402, 0.006400806, 0.011756453, -0.057788208,
      -0.03922871, 0.029061263, 0.06839164, -0.014544535, -0.047662966,
      -0.059395976, -0.03727927, 0.014318371, 0.025973465, 0.042332895,
      0.04511835, -0.039885864, 0.04445013, -0.00909842, -0.0022268177,
      -0.055778414, 0.044562876, -0.0029349416, 0.0045089596, 0.04649308,
      0.05095703, 0.024818162, -0.01763042, -0.016380813, 0.03626134,
      0.029747656, -0.018518452, 0.054535143, -0.03725233, 0.015218341,
      -0.035265, -0.008258693, 0.016336355, 0.003180061, 0.017113037,
      0.013840924, 0.08571888, -0.016922096, -0.04584672, -0.026123295,
      -0.01862711, 0.00086665194, -0.02700387, -0.039896443, 0.025839228,
      -0.008957712, -0.045702096, 0.011689191, -0.02518643, 0.04189632,
      0.024877924, -0.029749716, 0.07723543, 0.013161921, 0.035233274,
      0.013950026, -0.026914261, -0.0012491347, 0.022125386, 0.06322952,
      0.026747808, 0.016557682, 0.0026654843, 0.018403852, -0.002208754,
      -0.0043939324, 0.021411125, -0.0720841, -0.014162335, 0.009017187,
      0.009589008, 0.013714266, -0.013205313, 0.055074606, 0.0135510815,
      -0.009647225, -0.0073859296, -0.015533789, 0.041406598, -0.029964559,
      -0.004557068, 0.042442538, 0.003949693, -0.060314845, -0.0485521,
      -0.008145191, -0.0008701478, 0.026269091, 0.064659014, -0.0014519938,
      0.07755499, 0.012390666, 0.0009994709, 0.010512895, -0.0278039,
      -0.007720246, -0.017693883, -0.048093677, 0.048450127, -0.0084898835,
      0.033827696, 0.012179157, 0.0439037, 0.019806726, -0.0033815033,
      0.055004198, -0.010644163, 0.06983634, -0.0012867257, 0.116212435,
      0.0018561919, -0.03540732, 0.018552277, -0.014596015, 0.007995569,
      0.02062322, -0.013589375, 0.013323644, 0.058206026, 0.014310659,
      0.009776701, 0.022025304, 0.043452848, 0.007224779, -0.005841782,
      0.07922995, 0.029124206, 0.027332257, 0.011426645, 0.0610715, 0.033370003,
      -0.0032318854, 0.032962296, 0.044215627, -0.0019828111, -0.015901793,
      -0.00029608337, 0.013392526, -0.009583505, 0.101087496, 0.029640157,
      -0.04264001, 0.028663691, 0.0012885618, -0.00042037942, -0.05097693,
      0.046501413, 0.034346417, -0.03722956, 0.030485353, -0.028618095,
      -0.014943351, 0.024176005, 0.0059531713, -0.035492424, 0.04719729,
      -0.022705767, -0.004888659, 0.013763481, -0.006877845, 0.039462008,
      -0.022432147, -0.024738846, -0.0030126623, 0.014878597, 0.047142185,
      -0.028536918, -0.0019756483, -0.024875728, -0.049604762, 0.0076611727,
      0.0125418445, 0.06991834, 0.03057351, -0.0378383, -0.01601651,
      0.023397712, -0.006465213, -0.016750913, -0.028563995, 0.013968368,
      0.04284747, 0.013723971, -0.038290635, 0.0062841102, -0.016612995,
      0.0060477066, 0.0071878443, 0.017012084, 0.026105886, -0.029898316,
      -0.0034338816, 0.022605129, -0.031070229, -0.014588787, -0.05051719,
      0.011172559, -0.009865424, -0.0006022246, -0.050201006, 0.010974502,
      0.068753, -0.06411741, 0.021827834, -0.079100326, 0.027182067,
      -0.0049233013, -0.00854883, 0.042056426, -0.041176684, -0.043345083,
      0.007900265, 0.03339074, 0.009065677, -0.11376203, 0.026648033,
      -0.02173746, -0.056054536, -0.05019967, 0.02505995, -0.073714115,
      0.00041753243, 0.046410866, -0.00787225, -0.04326591, 0.052950215,
      -0.020633917, 0.0053053875, 0.038686555, 0.0076096985, -0.044483498,
      0.01734079, 0.050843734, 0.041709274, -0.032848667, 0.06583798,
      -0.0462481, -0.019906212, 0.062381882, 0.010934914, -0.053675517,
      -0.033560812, 0.027787214, 0.003391649, 0.019972153, 0.0442223,
      -0.06779605, -0.057355773, -0.00908375, -0.031183494, 0.07079641,
      -0.020006215, -0.024294054, -0.016699182, 0.0010443482, 0.018393427,
      0.032058917, 0.04007311, -0.013608359, -0.02647255, -0.023104627,
      0.07973177, 0.0143912, -0.00773088, -0.0105773965, 0.009673522,
      0.030086972, 0.021788783, 0.0215211, -0.0021278693, 0.01382664,
      -0.05028589, 0.0037969938, -0.019241702, -0.055900373, 0.047401533,
      0.047825735, -0.008378417, -0.021368338, -0.0029360335, -0.023776283,
      -0.030378696, 0.0042622155, -0.04370354, 0.046717755, 0.057218548,
      -0.07626953, 0.06840914, -0.013551472, -0.04081457, 0.0024602,
      -0.019596782, -0.034115944, 0.022949563, 0.08198656, 0.010917071,
      0.012808682, -0.0024835565, -0.06742202, 0.035741765, -0.007581535,
      0.01281636, 0.05919395, 0.019007294, -0.057466842, 0.031478077,
      0.011478408, 0.0197156, 0.03522307, -0.0039083306, 0.009473974,
      -0.061164707, -0.010365365, 0.020075476, 0.025542602, -0.030813247,
      -0.050739173, -0.0037222796, -0.0025314046, 0.03607207, 0.085864864,
      0.030587368, -0.011790973, 0.02897135, 0.009813614, 0.0036375853,
      0.01939262, -0.012913535, 0.032164395, -0.012496243, 0.053962503,
      -0.0030092895, -0.013271072, -0.069150545, -0.014564991, 0.01531648,
      -0.0493518, -0.026759734, -0.030610656, -0.022655917, -0.09071128,
      -0.051921394, -0.014159941, 0.086534575, 0.039204597, -0.018607471,
      -0.023076432, 0.016071219, 0.08200573, 0.036090653, -0.0029250141,
      0.032362826, -0.014467054, 0.013964356, -0.075049624, 0.047506943,
      -0.007153866, -0.028534686
    ]
  }
}



================================================
FILE: tests/Fixtures/gemini/generate-structured-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "{\"coat_required\": true, \"game_time\": \"7:00 PM\", \"weather\": \"cold\", \"location\": {\"city\": \"Detroit\", \"state\": \"Michigan\"}, \"players\": [\"Miguel Cabrera\", \"Spencer Torkelson\", \"Riley Greene\"], \"temperature\": 30}"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.051556725054979324
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 81,
    "candidatesTokenCount": 64,
    "totalTokenCount": 145,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 81
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 64
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash-002"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-a-prompt-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "I am a large language model, trained by Google.  I am an AI, and I don't have a name, feelings, or personal experiences.  My purpose is to process information and respond to a wide range of prompts and questions in a helpful and informative way.\n"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.12800796408402293
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 4,
    "candidatesTokenCount": 57,
    "totalTokenCount": 61
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-a-prompt-with-no-thinking-budget-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "Okay, let's break down Occam's Razor. **Explanation of Occam's Razor:** Occam's Razor (also spelled Ockham's Razor, and known in Latin as *Lex Parsimoniae*, the Law of Parsimony or Stinginess) is a **problem-solving principle**, not ▶ The core idea is: **When presented with competing hypothetical explanations for a phenomenon, you should select the one that makes the fewest assumptions.** In simpler terms: **The simplest explanation is usually the best one.** It doesn't say the simplest explanation is *always* correct, just that it's the most likely to be correct or the one you should investigate first. It encourages ▶ Think of it as being \"stingy\" with adding extra layers or factors that aren't strictly needed to explain something. **Simple, Everyday Example:** Imagine you come home and find a plate broken on the kitchen floor. You weren't home when it happened. *   **Explanation 1 (Complex):** A small earthquake occurred precisely at the moment the plate was sitting precariously on the edge of the counter, vibrating it ▶ *   **Explanation 2 (Simple):** It simply fell off the counter or was knocked off by a pet or someone who left the house just before you arrived. According to Occam's Razor, you would favor **Explanation 2**. Why? *   **Explanation 1** requires several assumptions: the timing of a specific, small earthquake you didn't feel, the plate's exact position, and the specific vibration frequency needed to dislodge *just* that plate. ◀ *   **Explanation 2** requires fewer assumptions: gravity exists, objects fall, things get knocked over, pets are sometimes clumsy, or someone might have been a bit careless. These are common occurrences. ◀ Occam's Razor suggests that the simplest explanation (it fell or was knocked) is the more probable one, as it relies on far fewer unproven or unlikely factors than the earthquake scenario. You'd start by looking for signs of it falling or asking others in the house, rather than checking seismic activity reports."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.12800796408402293
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 17,
    "candidatesTokenCount": 492,
    "totalTokenCount": 61,
    "thoughtsTokenCount": null
  },
  "modelVersion": "gemini-2.5-flash-preview"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-a-prompt-with-thinking-budget-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "Okay, let's break down Occam's Razor. **Explanation of Occam's Razor:** Occam's Razor (also spelled Ockham's Razor, and known in Latin as *Lex Parsimoniae*, the Law of Parsimony or Stinginess) is a **problem-solving principle**, not ▶ The core idea is: **When presented with competing hypothetical explanations for a phenomenon, you should select the one that makes the fewest assumptions.** In simpler terms: **The simplest explanation is usually the best one.** It doesn't say the simplest explanation is *always* correct, just that it's the most likely to be correct or the one you should investigate first. It encourages ▶ Think of it as being \"stingy\" with adding extra layers or factors that aren't strictly needed to explain something. **Simple, Everyday Example:** Imagine you come home and find a plate broken on the kitchen floor. You weren't home when it happened. *   **Explanation 1 (Complex):** A small earthquake occurred precisely at the moment the plate was sitting precariously on the edge of the counter, vibrating it ▶ *   **Explanation 2 (Simple):** It simply fell off the counter or was knocked off by a pet or someone who left the house just before you arrived. According to Occam's Razor, you would favor **Explanation 2**. Why? *   **Explanation 1** requires several assumptions: the timing of a specific, small earthquake you didn't feel, the plate's exact position, and the specific vibration frequency needed to dislodge *just* that plate. ◀ *   **Explanation 2** requires fewer assumptions: gravity exists, objects fall, things get knocked over, pets are sometimes clumsy, or someone might have been a bit careless. These are common occurrences. ◀ Occam's Razor suggests that the simplest explanation (it fell or was knocked) is the more probable one, as it relies on far fewer unproven or unlikely factors than the earthquake scenario. You'd start by looking for signs of it falling or asking others in the house, rather than checking seismic activity reports."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.12800796408402293
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 17,
    "candidatesTokenCount": 492,
    "totalTokenCount": 61,
    "thoughtsTokenCount": 1209
  },
  "modelVersion": "gemini-2.5-flash-preview"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-multiple-tools-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "functionCall": {
              "name": "search_games",
              "args": {
                "city": "Detroit"
              }
            }
          },
          {
            "functionCall": {
              "name": "get_weather",
              "args": {
                "city": "Detroit"
              }
            }
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.00003298009687569
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 124,
    "candidatesTokenCount": 10,
    "totalTokenCount": 134,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 71
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 10
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-multiple-tools-2.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "The tigers game is at 3pm today in Detroit.  The weather will be 45° and cold, so you should wear a coat."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.057665176689625
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 226,
    "candidatesTokenCount": 32,
    "totalTokenCount": 258,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 127
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 32
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-required-tool-call-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "functionCall": {
              "name": "weather",
              "args": {
                "options": {
                  "decimals": false,
                  "days": 1,
                  "alerts": [],
                  "unit": "Fahrenheit"
                },
                "city": "Detroit"
              }
            }
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.64373282591501868
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 124,
    "candidatesTokenCount": 12,
    "totalTokenCount": 136,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 124
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 12
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash",
  "responseId": "TBM3aMLqO42RsbQP1MbQ6AY"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-search-grounding-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "As of March 14, 2025, at 20:00 BST, the closing stock price for Alphabet Inc. (GOOG:NSQ) was $167.62.\nHowever, other sources provide slightly different real-time data:\n\n*   **Robinhood:** Indicates a high today of $167.11 and a low today of $162.11.\n*   **TradingView:** Shows the current price of GOOGL as $162.76, a decrease of -2.30% in the past 24 hours.\n*   **Nasdaq:** Reports today's high/low as $166.13/$162.11 and the previous close as $167.11.\n"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "groundingMetadata": {
        "searchEntryPoint": {
          "renderedContent": "\u003cstyle\u003e\n.container {\n  align-items: center;\n  border-radius: 8px;\n  display: flex;\n  font-family: Google Sans, Roboto, sans-serif;\n  font-size: 14px;\n  line-height: 20px;\n  padding: 8px 12px;\n}\n.chip {\n  display: inline-block;\n  border: solid 1px;\n  border-radius: 16px;\n  min-width: 14px;\n  padding: 5px 16px;\n  text-align: center;\n  user-select: none;\n  margin: 0 8px;\n  -webkit-tap-highlight-color: transparent;\n}\n.carousel {\n  overflow: auto;\n  scrollbar-width: none;\n  white-space: nowrap;\n  margin-right: -12px;\n}\n.headline {\n  display: flex;\n  margin-right: 4px;\n}\n.gradient-container {\n  position: relative;\n}\n.gradient {\n  position: absolute;\n  transform: translate(3px, -9px);\n  height: 36px;\n  width: 9px;\n}\n@media (prefers-color-scheme: light) {\n  .container {\n    background-color: #fafafa;\n    box-shadow: 0 0 0 1px #0000000f;\n  }\n  .headline-label {\n    color: #1f1f1f;\n  }\n  .chip {\n    background-color: #ffffff;\n    border-color: #d2d2d2;\n    color: #5e5e5e;\n    text-decoration: none;\n  }\n  .chip:hover {\n    background-color: #f2f2f2;\n  }\n  .chip:focus {\n    background-color: #f2f2f2;\n  }\n  .chip:active {\n    background-color: #d8d8d8;\n    border-color: #b6b6b6;\n  }\n  .logo-dark {\n    display: none;\n  }\n  .gradient {\n    background: linear-gradient(90deg, #fafafa 15%, #fafafa00 100%);\n  }\n}\n@media (prefers-color-scheme: dark) {\n  .container {\n    background-color: #1f1f1f;\n    box-shadow: 0 0 0 1px #ffffff26;\n  }\n  .headline-label {\n    color: #fff;\n  }\n  .chip {\n    background-color: #2c2c2c;\n    border-color: #3c4043;\n    color: #fff;\n    text-decoration: none;\n  }\n  .chip:hover {\n    background-color: #353536;\n  }\n  .chip:focus {\n    background-color: #353536;\n  }\n  .chip:active {\n    background-color: #464849;\n    border-color: #53575b;\n  }\n  .logo-light {\n    display: none;\n  }\n  .gradient {\n    background: linear-gradient(90deg, #1f1f1f 15%, #1f1f1f00 100%);\n  }\n}\n\u003c/style\u003e\n\u003cdiv class=\"container\"\u003e\n  \u003cdiv class=\"headline\"\u003e\n    \u003csvg class=\"logo-light\" width=\"18\" height=\"18\" viewBox=\"9 9 35 35\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M42.8622 27.0064C42.8622 25.7839 42.7525 24.6084 42.5487 23.4799H26.3109V30.1568H35.5897C35.1821 32.3041 33.9596 34.1222 32.1258 35.3448V39.6864H37.7213C40.9814 36.677 42.8622 32.2571 42.8622 27.0064V27.0064Z\" fill=\"#4285F4\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M26.3109 43.8555C30.9659 43.8555 34.8687 42.3195 37.7213 39.6863L32.1258 35.3447C30.5898 36.3792 28.6306 37.0061 26.3109 37.0061C21.8282 37.0061 18.0195 33.9811 16.6559 29.906H10.9194V34.3573C13.7563 39.9841 19.5712 43.8555 26.3109 43.8555V43.8555Z\" fill=\"#34A853\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16.6559 29.8904C16.3111 28.8559 16.1074 27.7588 16.1074 26.6146C16.1074 25.4704 16.3111 24.3733 16.6559 23.3388V18.8875H10.9194C9.74388 21.2072 9.06992 23.8247 9.06992 26.6146C9.06992 29.4045 9.74388 32.022 10.9194 34.3417L15.3864 30.8621L16.6559 29.8904V29.8904Z\" fill=\"#FBBC05\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M26.3109 16.2386C28.85 16.2386 31.107 17.1164 32.9095 18.8091L37.8466 13.8719C34.853 11.082 30.9659 9.3736 26.3109 9.3736C19.5712 9.3736 13.7563 13.245 10.9194 18.8875L16.6559 23.3388C18.0195 19.2636 21.8282 16.2386 26.3109 16.2386V16.2386Z\" fill=\"#EA4335\"/\u003e\n    \u003c/svg\u003e\n    \u003csvg class=\"logo-dark\" width=\"18\" height=\"18\" viewBox=\"0 0 48 48\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n      \u003ccircle cx=\"24\" cy=\"23\" fill=\"#FFF\" r=\"22\"/\u003e\n      \u003cpath d=\"M33.76 34.26c2.75-2.56 4.49-6.37 4.49-11.26 0-.89-.08-1.84-.29-3H24.01v5.99h8.03c-.4 2.02-1.5 3.56-3.07 4.56v.75l3.91 2.97h.88z\" fill=\"#4285F4\"/\u003e\n      \u003cpath d=\"M15.58 25.77A8.845 8.845 0 0 0 24 31.86c1.92 0 3.62-.46 4.97-1.31l4.79 3.71C31.14 36.7 27.65 38 24 38c-5.93 0-11.01-3.4-13.45-8.36l.17-1.01 4.06-2.85h.8z\" fill=\"#34A853\"/\u003e\n      \u003cpath d=\"M15.59 20.21a8.864 8.864 0 0 0 0 5.58l-5.03 3.86c-.98-2-1.53-4.25-1.53-6.64 0-2.39.55-4.64 1.53-6.64l1-.22 3.81 2.98.22 1.08z\" fill=\"#FBBC05\"/\u003e\n      \u003cpath d=\"M24 14.14c2.11 0 4.02.75 5.52 1.98l4.36-4.36C31.22 9.43 27.81 8 24 8c-5.93 0-11.01 3.4-13.45 8.36l5.03 3.85A8.86 8.86 0 0 1 24 14.14z\" fill=\"#EA4335\"/\u003e\n    \u003c/svg\u003e\n    \u003cdiv class=\"gradient-container\"\u003e\u003cdiv class=\"gradient\"\u003e\u003c/div\u003e\u003c/div\u003e\n  \u003c/div\u003e\n  \u003cdiv class=\"carousel\"\u003e\n    \u003ca class=\"chip\" href=\"https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrydXGr2BlSVBjo07bn6znlzvSmowZolyv8HlZpYY9283Kki6lel6GF0u6Xusircm84v9vXRdCbWqJ6xvp-SK772pj-WGuFR6Schb3f1cIjlX_ckti6gochxLxz_fuUg_WmqtmrWoGdAQ5quEgo3tey-j2Q2GonJVSpBXRYosyzIywdwHJBRta3PopirfpIevKZkqDrF4rJs\"\u003estock price of google\u003c/a\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n"
        },
        "groundingChunks": [
          {
            "web": {
              "uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrzVmdvQ-8RyZbo6knG4xQpbHhzoZtCKui-qEXo7n-Gda_UaV5RNo3GuuAV7OBLY8oRmb0giKvPjP0FXgI8gktbMyJOx9yUkSYbBUJpfbLaHQy13zjpVAC596HzWEfbPjoh1_5EtEinrM1LW0D0_6OwQ_iDClBsm62K-L-I=",
              "title": "ft.com"
            }
          },
          {
            "web": {
              "uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrwHQTy1lqyXkL_ZTR2yX9LVXL1kmT2lzNGvoK6qvcNy00-sA7cMK0oTJzEQG5qMZqq54lToNR1iMYOeW4Hrn9e88-7oaPqhGy6Kc-DO4pI9r74RSEuDCCziwnaubBY=",
              "title": "robinhood.com"
            }
          },
          {
            "web": {
              "uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrx3N5KuARTmEGl531BFbrv8RlYoahKjXz2BP4YPnX7GvY8zoNH2Oxua5A51qhaiHSHvEKwZKmT3kWD_C9KCaG45WR4m8geQxOBL0WKKKcyI2ccOAXu0VMSz6zsDSKeoxoEX6dsJtGQW9vVPDA==",
              "title": "tradingview.com"
            }
          },
          {
            "web": {
              "uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrwBgQeuk_b623DGXbFEvu-uS5q6DYjUulBGw26jPfp-iCDsoAUip1KcyGVC3kV8OYa4nYfm7qpZKPZ0a6rzHhZ1wCl8M3iFwn8F70ZRSf5LYJ_D6WBL7ENN8ENja2y2Wqu0AxUfCEch84to-scf",
              "title": "nasdaq.com"
            }
          }
        ],
        "groundingSupports": [
          {
            "segment": {
              "startIndex": 78,
              "endIndex": 101,
              "text": "(GOOG:NSQ) was $167.62."
            },
            "groundingChunkIndices": [
              0
            ],
            "confidenceScores": [
              0.817279
            ]
          },
          {
            "segment": {
              "startIndex": 169,
              "endIndex": 249,
              "text": "*   **Robinhood:** Indicates a high today of $167.11 and a low today of $162.11."
            },
            "groundingChunkIndices": [
              1
            ],
            "confidenceScores": [
              0.9855012
            ]
          },
          {
            "segment": {
              "startIndex": 250,
              "endIndex": 358,
              "text": "*   **TradingView:** Shows the current price of GOOGL as $162.76, a decrease of -2.30% in the past 24 hours."
            },
            "groundingChunkIndices": [
              2
            ],
            "confidenceScores": [
              0.9488426
            ]
          },
          {
            "segment": {
              "startIndex": 359,
              "endIndex": 453,
              "text": "*   **Nasdaq:** Reports today's high/low as $166.13/$162.11 and the previous close as $167.11."
            },
            "groundingChunkIndices": [
              3
            ],
            "confidenceScores": [
              0.9807108
            ]
          }
        ],
        "retrievalMetadata": {},
        "webSearchQueries": [
          "stock price of google"
        ]
      }
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 10,
    "candidatesTokenCount": 175,
    "totalTokenCount": 185,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 10
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 175
      }
    ]
  },
  "modelVersion": "gemini-2.0-flash"
}



================================================
FILE: tests/Fixtures/gemini/generate-text-with-system-prompt-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "I am Prism, a helpful AI assistant created by echo labs."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.050380042621067593
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 17,
    "candidatesTokenCount": 14,
    "totalTokenCount": 31
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/image-detection-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "That's an illustration of a **diamond**.  More specifically, it's a stylized, geometric representation of a diamond, often used as an icon or symbol"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.2275218963623 
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 263,
    "candidatesTokenCount": 35,
    "totalTokenCount": 35
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/media-detection-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "The video is an animation of a grassy mound beneath a tree, with a dark hole. The video appears to be nature animation or scenery."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.2275218963623 
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 263,
    "candidatesTokenCount": 35,
    "totalTokenCount": 35
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/media-detection-2.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "Kids are talking by the door."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.2275218963623 
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 263,
    "candidatesTokenCount": 35,
    "totalTokenCount": 35
  },
  "modelVersion": "gemini-1.5-flash"
}



================================================
FILE: tests/Fixtures/gemini/stream-basic-text-1.sse
================================================
data: {"candidates": [{"content": {"parts": [{"text": "AI"}],"role": "model"}}],"usageMetadata": {"promptTokenCount": 21,"totalTokenCount": 21,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 21}]},"modelVersion": "gemini-2.0-flash","responseId": "za9caLp-rJ_Psg-Ou6T4BA"}
data: {"candidates": [{"content": {"parts": [{"text": "? It's simple! We just feed a computer a HUGE pile of information"}],"role": "model"}}],"usageMetadata": {"promptTokenCount": 21,"totalTokenCount": 21,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 21}]},"modelVersion": "gemini-2.0-flash","responseId": "za9caLp-rJ_Psg-Ou6T4BA"}
data: {"candidates": [{"content": {"parts": [{"text": ", tell it to find patterns, and then it pretends to be smart! Like teaching"}],"role": "model"}}],"usageMetadata": {"promptTokenCount": 21,"totalTokenCount": 21,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 21}]},"modelVersion": "gemini-2.0-flash","responseId": "za9caLp-rJ_Psg-Ou6T4BA"}
data: {"candidates": [{"content": {"parts": [{"text": " a parrot to say cool things. Mostly magic, though.\n"}],"role": "model"},"finishReason": "STOP"}],"usageMetadata": {"promptTokenCount": 21,"candidatesTokenCount": 47,"totalTokenCount": 68,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 21}],"candidatesTokensDetails": [{"modality": "TEXT","tokenCount": 47}]},"modelVersion": "gemini-2.0-flash","responseId": "za9caLp-rJ_Psg-Ou6T4BA"}



================================================
FILE: tests/Fixtures/gemini/stream-with-tools-1.json
================================================
data: {"candidates": [{"content": {"parts": [{"functionCall": {"name": "weather","args": {"city": "San Francisco"}}}],"role": "model"},"finishReason": "STOP","index": 0}],"usageMetadata": {"promptTokenCount": 109,"candidatesTokenCount": 14,"totalTokenCount": 267,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 109}],"thoughtsTokenCount": 144},"modelVersion": "gemini-2.5-flash","responseId": "WE2DaP6HHfnNkdUP466S6AI"}




================================================
FILE: tests/Fixtures/gemini/stream-with-tools-2.json
================================================
data: {"candidates": [{"content": {"parts": [{"text": "It is"}],"role": "model"},"index": 0}],"usageMetadata": {"promptTokenCount": 159,"candidatesTokenCount": 2,"totalTokenCount": 161,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 159}]},"modelVersion": "gemini-2.5-flash","responseId": "WE2DaN7iMqz2nsEPkfWRoQw"}

data: {"candidates": [{"content": {"parts": [{"text": " 75° and sunny in San Francisco, so you likely do not need to"}],"role": "model"},"index": 0}],"usageMetadata": {"promptTokenCount": 159,"candidatesTokenCount": 18,"totalTokenCount": 177,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 159}]},"modelVersion": "gemini-2.5-flash","responseId": "WE2DaN7iMqz2nsEPkfWRoQw"}

data: {"candidates": [{"content": {"parts": [{"text": " wear a coat."}],"role": "model"},"finishReason": "STOP","index": 0}],"usageMetadata": {"promptTokenCount": 159,"candidatesTokenCount": 22,"totalTokenCount": 181,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 159}]},"modelVersion": "gemini-2.5-flash","responseId": "WE2DaN7iMqz2nsEPkfWRoQw"}




================================================
FILE: tests/Fixtures/gemini/stream-with-tools-search-grounding-1.json
================================================
data: {"candidates": [{"content": {"parts": [{"text": "The current weather in"}],"role": "model"},"index": 0,"groundingMetadata": {}}],"usageMetadata": {"promptTokenCount": 22,"candidatesTokenCount": 27,"totalTokenCount": 117,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 22}],"thoughtsTokenCount": 68},"modelVersion": "gemini-2.5-flash","responseId": "M1GDaNrGOJ7NkdUPqvinwAs"}

data: {"candidates": [{"content": {"parts": [{"text": " San Francisco is cloudy with a temperature of 56°F (13°"}],"role": "model"},"index": 0,"groundingMetadata": {}}],"usageMetadata": {"promptTokenCount": 22,"candidatesTokenCount": 44,"totalTokenCount": 134,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 22}],"thoughtsTokenCount": 68},"modelVersion": "gemini-2.5-flash","responseId": "M1GDaNrGOJ7NkdUPqvinwAs"}

data: {"candidates": [{"content": {"parts": [{"text": "C), and it feels like 54°F (12°C). There's a 0% chance of rain currently, though light rain is forecast for today and tonight with a 20% chance.\n\n"}],"role": "model"},"index": 0,"groundingMetadata": {}}],"usageMetadata": {"promptTokenCount": 22,"candidatesTokenCount": 90,"totalTokenCount": 180,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 22}],"thoughtsTokenCount": 68},"modelVersion": "gemini-2.5-flash","responseId": "M1GDaNrGOJ7NkdUPqvinwAs"}

data: {"candidates": [{"content": {"parts": [{"text": "Given the current temperature and the typical San Francisco climate, which is known for cool summers and mild winters, it is advisable to wear a coat. San Francisco often experiences fog, wind, and varying temperatures across"}],"role": "model"},"index": 0,"groundingMetadata": {}}],"usageMetadata": {"promptTokenCount": 22,"candidatesTokenCount": 131,"totalTokenCount": 221,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 22}],"thoughtsTokenCount": 68},"modelVersion": "gemini-2.5-flash","responseId": "M1GDaNrGOJ7NkdUPqvinwAs"}

data: {"candidates": [{"content": {"parts": [{"text": " different neighborhoods, making layers essential. A light sweater or jacket is generally recommended, even in the summer, and a warmer sweater or jacket at night."}],"role": "model"},"finishReason": "STOP","index": 0,"groundingMetadata": {"searchEntryPoint": {"renderedContent": "\u003cstyle\u003e\n.container {\n  align-items: center;\n  border-radius: 8px;\n  display: flex;\n  font-family: Google Sans, Roboto, sans-serif;\n  font-size: 14px;\n  line-height: 20px;\n  padding: 8px 12px;\n}\n.chip {\n  display: inline-block;\n  border: solid 1px;\n  border-radius: 16px;\n  min-width: 14px;\n  padding: 5px 16px;\n  text-align: center;\n  user-select: none;\n  margin: 0 8px;\n  -webkit-tap-highlight-color: transparent;\n}\n.carousel {\n  overflow: auto;\n  scrollbar-width: none;\n  white-space: nowrap;\n  margin-right: -12px;\n}\n.headline {\n  display: flex;\n  margin-right: 4px;\n}\n.gradient-container {\n  position: relative;\n}\n.gradient {\n  position: absolute;\n  transform: translate(3px, -9px);\n  height: 36px;\n  width: 9px;\n}\n@media (prefers-color-scheme: light) {\n  .container {\n    background-color: #fafafa;\n    box-shadow: 0 0 0 1px #0000000f;\n  }\n  .headline-label {\n    color: #1f1f1f;\n  }\n  .chip {\n    background-color: #ffffff;\n    border-color: #d2d2d2;\n    color: #5e5e5e;\n    text-decoration: none;\n  }\n  .chip:hover {\n    background-color: #f2f2f2;\n  }\n  .chip:focus {\n    background-color: #f2f2f2;\n  }\n  .chip:active {\n    background-color: #d8d8d8;\n    border-color: #b6b6b6;\n  }\n  .logo-dark {\n    display: none;\n  }\n  .gradient {\n    background: linear-gradient(90deg, #fafafa 15%, #fafafa00 100%);\n  }\n}\n@media (prefers-color-scheme: dark) {\n  .container {\n    background-color: #1f1f1f;\n    box-shadow: 0 0 0 1px #ffffff26;\n  }\n  .headline-label {\n    color: #fff;\n  }\n  .chip {\n    background-color: #2c2c2c;\n    border-color: #3c4043;\n    color: #fff;\n    text-decoration: none;\n  }\n  .chip:hover {\n    background-color: #353536;\n  }\n  .chip:focus {\n    background-color: #353536;\n  }\n  .chip:active {\n    background-color: #464849;\n    border-color: #53575b;\n  }\n  .logo-light {\n    display: none;\n  }\n  .gradient {\n    background: linear-gradient(90deg, #1f1f1f 15%, #1f1f1f00 100%);\n  }\n}\n\u003c/style\u003e\n\u003cdiv class=\"container\"\u003e\n  \u003cdiv class=\"headline\"\u003e\n    \u003csvg class=\"logo-light\" width=\"18\" height=\"18\" viewBox=\"9 9 35 35\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M42.8622 27.0064C42.8622 25.7839 42.7525 24.6084 42.5487 23.4799H26.3109V30.1568H35.5897C35.1821 32.3041 33.9596 34.1222 32.1258 35.3448V39.6864H37.7213C40.9814 36.677 42.8622 32.2571 42.8622 27.0064V27.0064Z\" fill=\"#4285F4\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M26.3109 43.8555C30.9659 43.8555 34.8687 42.3195 37.7213 39.6863L32.1258 35.3447C30.5898 36.3792 28.6306 37.0061 26.3109 37.0061C21.8282 37.0061 18.0195 33.9811 16.6559 29.906H10.9194V34.3573C13.7563 39.9841 19.5712 43.8555 26.3109 43.8555V43.8555Z\" fill=\"#34A853\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M16.6559 29.8904C16.3111 28.8559 16.1074 27.7588 16.1074 26.6146C16.1074 25.4704 16.3111 24.3733 16.6559 23.3388V18.8875H10.9194C9.74388 21.2072 9.06992 23.8247 9.06992 26.6146C9.06992 29.4045 9.74388 32.022 10.9194 34.3417L15.3864 30.8621L16.6559 29.8904V29.8904Z\" fill=\"#FBBC05\"/\u003e\n      \u003cpath fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M26.3109 16.2386C28.85 16.2386 31.107 17.1164 32.9095 18.8091L37.8466 13.8719C34.853 11.082 30.9659 9.3736 26.3109 9.3736C19.5712 9.3736 13.7563 13.245 10.9194 18.8875L16.6559 23.3388C18.0195 19.2636 21.8282 16.2386 26.3109 16.2386V16.2386Z\" fill=\"#EA4335\"/\u003e\n    \u003c/svg\u003e\n    \u003csvg class=\"logo-dark\" width=\"18\" height=\"18\" viewBox=\"0 0 48 48\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n      \u003ccircle cx=\"24\" cy=\"23\" fill=\"#FFF\" r=\"22\"/\u003e\n      \u003cpath d=\"M33.76 34.26c2.75-2.56 4.49-6.37 4.49-11.26 0-.89-.08-1.84-.29-3H24.01v5.99h8.03c-.4 2.02-1.5 3.56-3.07 4.56v.75l3.91 2.97h.88z\" fill=\"#4285F4\"/\u003e\n      \u003cpath d=\"M15.58 25.77A8.845 8.845 0 0 0 24 31.86c1.92 0 3.62-.46 4.97-1.31l4.79 3.71C31.14 36.7 27.65 38 24 38c-5.93 0-11.01-3.4-13.45-8.36l.17-1.01 4.06-2.85h.8z\" fill=\"#34A853\"/\u003e\n      \u003cpath d=\"M15.59 20.21a8.864 8.864 0 0 0 0 5.58l-5.03 3.86c-.98-2-1.53-4.25-1.53-6.64 0-2.39.55-4.64 1.53-6.64l1-.22 3.81 2.98.22 1.08z\" fill=\"#FBBC05\"/\u003e\n      \u003cpath d=\"M24 14.14c2.11 0 4.02.75 5.52 1.98l4.36-4.36C31.22 9.43 27.81 8 24 8c-5.93 0-11.01 3.4-13.45 8.36l5.03 3.85A8.86 8.86 0 0 1 24 14.14z\" fill=\"#EA4335\"/\u003e\n    \u003c/svg\u003e\n    \u003cdiv class=\"gradient-container\"\u003e\u003cdiv class=\"gradient\"\u003e\u003c/div\u003e\u003c/div\u003e\n  \u003c/div\u003e\n  \u003cdiv class=\"carousel\"\u003e\n    \u003ca class=\"chip\" href=\"https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQEEsx48t6GSu5dF3iaolIgckohpWC9KnyafMuJ0rw_cG3cikmTVU7H0HTZqqG9HpDkJ7yzzRRjl3JjlrILzu8rAwbGhR_G_v9Kmek8FuCizA2zN47MLEIrXlDmvzYJ3WzRw4Ie3A5oSp09Wrsh1Z_e5PSUTABzc86_TDIu3p05HSutCXAWrdeST3TIPTmyxVoJzmQTmnUvdiRIJx54BZahh6k-4pyGE\"\u003etemperature San Francisco wear coat\u003c/a\u003e\n    \u003ca class=\"chip\" href=\"https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQHSeXkt2U2VOXhGBZd05Np5IET-KPjfMST-yOZwkpgrpfQ2HHJJ_9K-EyfPij63b0AfTnjGfUqvxqKaQDNkphX94Q-G6hLxzR6AWEDVcLg1H_ZpBMCV35DhQK-xVpRVSmUnjyMhM3776J1s3c-8jUMuZCY6M-rCqPu8d4pBEVclaFnT1zVzpUsp9jKukNT2oG5sUGOAC3OKr3asplXs3h_6dZjL\"\u003ecurrent weather in San Francisco\u003c/a\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n"},"groundingChunks": [{"web": {"uri": "https://www.google.com/search?q=weather+in+San Francisco,+CA","title": "Weather information for locality: San Francisco, administrative_area: CA"}},{"web": {"uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQHf42KIyvo510mYwKPBcT7zoJ-rkr2aCXEd-SGYDbzz4dZULmHfQ1ZZqT7wD3RVKOjQKcUVmyYwvTVf-0a0N_5INHNClaLW5pgOoNeEZWmJpeyRAqIuOSybtoH5-MJszpzsBzys93kpAfZJyjAQXf7XNpY63VZ59s0b","title": "sftourismtips.com"}},{"web": {"uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFR84YfmGKtSKOhql92V3rHU_L-vasaAHzdzcoZDdM2UeOdHwxX7yt8bn91PFYwhGFkaMEAuZawKz5pFpxMtOTg8K1pcoPa5UriW546xj8l1a9rIvwQL4-3qS-hS3vtdsZK6rymb4a42BcXLLl6Iqkj9MnB","title": "clothesforecast.com"}},{"web": {"uri": "https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFVCm8rfQNviB6E9zD43eqv79k4uisnXjOLvMZXRwSUFxmSGWRPucTuzZMobrTgF47E_8AqNRmo56sKBLlb4KPKiwYMMQNGaF7ArOGfm_85vqQetc3HmFYLg30qKBEb2NzlvHOTZJZkyTkI2MYMXnqv","title": "whimsysoul.com"}}],"groundingSupports": [{"segment": {"startIndex": 117,"endIndex": 226,"text": "There's a 0% chance of rain currently, though light rain is forecast for today and tonight with a 20% chance."},"groundingChunkIndices": [0]},{"segment": {"startIndex": 228,"endIndex": 378,"text": "Given the current temperature and the typical San Francisco climate, which is known for cool summers and mild winters, it is advisable to wear a coat."},"groundingChunkIndices": [1,2]},{"segment": {"startIndex": 379,"endIndex": 503,"text": "San Francisco often experiences fog, wind, and varying temperatures across different neighborhoods, making layers essential."},"groundingChunkIndices": [1,3]},{"segment": {"startIndex": 504,"endIndex": 616,"text": "A light sweater or jacket is generally recommended, even in the summer, and a warmer sweater or jacket at night."},"groundingChunkIndices": [1]}],"webSearchQueries": ["current weather in San Francisco","temperature San Francisco wear coat"]}}],"usageMetadata": {"promptTokenCount": 22,"candidatesTokenCount": 161,"totalTokenCount": 251,"promptTokensDetails": [{"modality": "TEXT","tokenCount": 22}],"thoughtsTokenCount": 68},"modelVersion": "gemini-2.5-flash","responseId": "M1GDaNrGOJ7NkdUPqvinwAs"}




================================================
FILE: tests/Fixtures/gemini/text-with-pdf-documents-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "The document is about the answer to the Ultimate Question of Life, the Universe, and Everything, which is stated to be 42. This is a reference to the science fiction series \"The Hitchhiker's Guide to the Galaxy\" by Douglas Adams.\n"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.15755779338332843
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 1296,
    "candidatesTokenCount": 53,
    "totalTokenCount": 1349,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 6
      },
      {
        "modality": "DOCUMENT",
        "tokenCount": 1290
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 53
      }
    ]
  },
  "modelVersion": "gemini-2.0-flash"
}



================================================
FILE: tests/Fixtures/gemini/text-with-text-documents-1.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "This document is about the number 42 and its significance, likely referencing the book \"The Hitchhiker's Guide to the Galaxy\" by Douglas Adams. In that book, a supercomputer called Deep Thought calculates that 42 is the answer to the Ultimate Question of Life, the Universe, and Everything. However, frustratingly, no one knows what the actual question *is*.\n\nTherefore, the document could be:\n\n*   **An explanation of the concept of 42 within the context of *The Hitchhiker's Guide to the Galaxy***: This is the most likely scenario.\n*   **A humorous exploration of possible interpretations of 42**: Playing on the ambiguity of the answer.\n*   **A coincidence**: The document could be about something completely unrelated to the book, and the mention of 42 is just a bizarre coincidence. However, given the specific phrasing (\"The Answer to the Ultimate Question...\"), this is very unlikely.\n*   **A piece of fan fiction or creative writing**: Using the 42 concept as a jumping-off point.\n\nIn short, it's almost certainly related to *The Hitchhiker's Guide to the Galaxy* and the significance of the number 42 within that fictional universe.\n"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.41205817002516526
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 6,
    "candidatesTokenCount": 260,
    "totalTokenCount": 266,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 6
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 260
      }
    ]
  },
  "modelVersion": "gemini-2.0-flash"
}



================================================
FILE: tests/Fixtures/gemini/use-cache-with-structured-1.json
================================================
{
  "name": "cachedContents/zor9crvcnjm8",
  "model": "models/gemini-1.5-flash-002",
  "createTime": "2025-03-03T15:43:54.810767Z",
  "updateTime": "2025-03-03T15:43:54.810767Z",
  "expireTime": "2025-03-03T15:44:23.616247608Z",
  "displayName": "",
  "usageMetadata": {
    "totalTokenCount": 88759
  }
}



================================================
FILE: tests/Fixtures/gemini/use-cache-with-structured-2.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "{\n  \"article_count\": 358,\n  \"legal_jurisdiction\": \"European Union\",\n  \"legislation_type\": \"Treaty\"\n}"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.012719466498023585
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 88830,
    "candidatesTokenCount": 38,
    "totalTokenCount": 88868,
    "cachedContentTokenCount": 88759,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 71
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 38
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash-002"
}



================================================
FILE: tests/Fixtures/gemini/use-cache-with-text-1.json
================================================
{
  "name": "cachedContents/dbea3hx6pzbp",
  "model": "models/gemini-1.5-flash-002",
  "createTime": "2025-03-02T08:12:20.562863Z",
  "updateTime": "2025-03-02T08:12:20.562863Z",
  "expireTime": "2025-03-02T08:12:48.902377869Z",
  "displayName": "",
  "usageMetadata": {
    "totalTokenCount": 88759
  }
}



================================================
FILE: tests/Fixtures/gemini/use-cache-with-text-2.json
================================================
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "That's the Consolidated Version of the Treaty on the Functioning of the European Union (TFEU), adopted on 25 March 1957.  It outlines the principles, competencies, and policies of the European Union.  The TFEU organizes the EU's functioning and details its areas of competence, including exclusive, shared, and supporting competences.  It also covers non-discrimination, citizenship, and various EU policies (e.g., internal market, agriculture, and justice).  Finally, it sets out institutional and financial provisions.\n"
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "avgLogprobs": -0.28721424628948344
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 88775,
    "candidatesTokenCount": 116,
    "totalTokenCount": 88891,
    "cachedContentTokenCount": 88759,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 16
      }
    ],
    "candidatesTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 116
      }
    ]
  },
  "modelVersion": "gemini-1.5-flash-002"
}



================================================
FILE: tests/Fixtures/groq/audio-from-base64-1.json
================================================
{"text":" know by by that conference um so we'll uh i think that's a good excuse to be on the newsletter too is like yeah find out about 1.0 like as soon as possible yep totally yeah i like that idea then that gets you not as much pressure for tagging 1.0 before you go to laricon it gets an added benefit of getting people on the newsletter and a little bit more exposure than there and then And, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Yeah. Yeah. I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might, I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at and maybe I'll work on on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick and there's a lot I want to do. So maybe I don sleep tonight Yeah But even if you just like captured email addresses like you can always export them import them into the new place anyways Yep Yeah 100 So cool, man. Moving on from newsletters, I think you had added something here about cloud custom commands. And that's something that we talked about, I think last week a little bit. And we maybe starting to find some excuses for using custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans, it basically like re-initiates the clod MD file. It reads what's there. It looks at the application, sees any new like dependencies or commands or whatever the case is and updates anything that it deems important to add back to that markdown file. and it just nice if you have like a repo that has a lot of development a lot of people working in it and you don always want to like capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time I ran it it picked up like I think I last time I refreshed it was I don't know three four weeks ago so I found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on the other one is what I just named like a branch context is like I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here And then we can either work towards something else together or I asking you for why did this change or why did that change or whatever the case is It just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details that you're- No, man, I think that sounds great. Like those are very useful things to have as slash commands. yeah that's it's i'm still i'm still personally finding like my own use cases for him i haven't i haven't dove too far into it yet um but maybe after lara con i'll i'll spend a little time you know coming up with some stuff but i i think those are like i think it serves like some decent inspiration for some some other slash commands i i'm thinking up right now so yeah what else you got um yeah so the next one which i do a lot is pr reviews for others and coming into like a new tech stack like there's some things i am just not aware about or like best practices or whatever so there's a default slash review command that comes out of the box in cloud code and that gives a decent understanding like it'll tell you you know what's changed, what maybe some of the","x_groq":{"id":"req_01k1p1s6aqeg18gqh4rhgg4far"}}



================================================
FILE: tests/Fixtures/groq/audio-from-path-1.json
================================================
{"text":" know by by that conference um so we'll uh i think that's a good excuse to be on the newsletter too is like yeah find out about 1.0 like as soon as possible yep totally yeah i like that idea then that gets you not as much pressure for tagging 1.0 before you go to laricon it gets an added benefit of getting people on the newsletter and a little bit more exposure than there and then And, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Yeah. Yeah. I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might, I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at and maybe I'll work on on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick and there's a lot I want to do. So maybe I don sleep tonight Yeah But even if you just like captured email addresses like you can always export them import them into the new place anyways Yep Yeah 100 So cool, man. Moving on from newsletters, I think you had added something here about cloud custom commands. And that's something that we talked about, I think last week a little bit. And we maybe starting to find some excuses for using custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans, it basically like re-initiates the clod MD file. It reads what's there. It looks at the application, sees any new like dependencies or commands or whatever the case is and updates anything that it deems important to add back to that markdown file. and it just nice if you have like a repo that has a lot of development a lot of people working in it and you don always want to like capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time I ran it it picked up like I think I last time I refreshed it was I don't know three four weeks ago so I found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on the other one is what I just named like a branch context is like I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here And then we can either work towards something else together or I asking you for why did this change or why did that change or whatever the case is It just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details that you're- No, man, I think that sounds great. Like those are very useful things to have as slash commands. yeah that's it's i'm still i'm still personally finding like my own use cases for him i haven't i haven't dove too far into it yet um but maybe after lara con i'll i'll spend a little time you know coming up with some stuff but i i think those are like i think it serves like some decent inspiration for some some other slash commands i i'm thinking up right now so yeah what else you got um yeah so the next one which i do a lot is pr reviews for others and coming into like a new tech stack like there's some things i am just not aware about or like best practices or whatever so there's a default slash review command that comes out of the box in cloud code and that gives a decent understanding like it'll tell you you know what's changed what maybe some of the","x_groq":{"id":"req_01k1p1refged69kv473fvyrcg1"}}



================================================
FILE: tests/Fixtures/groq/audio-from-path-text-1.json
================================================
 know by by that conference um so we'll uh i think that's a good excuse to be on the newsletter too is like yeah find out about 1.0 like as soon as possible yep totally yeah i like that idea then that gets you not as much pressure for tagging 1.0 before you go to laricon it gets an added benefit of getting people on the newsletter and a little bit more exposure than there and then And, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Get ready. Yeah, I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might, I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at and maybe I'll work on on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick and there's a lot I want to do. So maybe I don sleep tonight Yeah But even if you just like captured email addresses like you can always export them import them into the new place anyways Yep Yeah 100 So cool, man. Moving on from newsletters, I think you had added something here about cloud custom commands. And that's something that we talked about, I think last week a little bit. And we maybe starting to find some excuses for using custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans, it basically like re-initiates the clod MD file. It reads what's there. It looks at the application, sees any new like dependencies or commands or whatever the case is and updates anything that it deems important to add back to that markdown file. and it just nice if you have like a repo that has a lot of development a lot of people working in it and you don always want to like capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time I ran it it picked up like I think I last time I refreshed it was I don't know three four weeks ago so I found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on the other one is what I just named like a branch context is like I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here And then we can either work towards something else together or I asking you for why did this change or why did that change or whatever the case is It just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details that you're- No, man, I think that sounds great. Like those are very useful things to have as slash commands. yeah that's it's i'm still i'm still personally finding like my own use cases for him i haven't i haven't dove too far into it yet um but maybe after lara con i'll i'll spend a little time you know coming up with some stuff but i i think those are like i think it serves like some decent inspiration for some some other slash commands i i'm thinking up right now so yeah what else you got um yeah so the next one which i do a lot is pr reviews for others and coming into like a new tech stack like there's some things i am just not aware about or like best practices or whatever so there's a default slash review command that comes out of the box in cloud code and that gives a decent understanding like it'll tell you you know what's changed, what maybe some of the


================================================
FILE: tests/Fixtures/groq/generate-text-with-a-prompt-1.json
================================================
{
  "id": "chatcmpl-ea37c181-ed35-4bd4-af20-c1fcf203e0d8",
  "object": "chat.completion",
  "created": 1730033815,
  "model": "llama3-8b-8192",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am LLaMA, an AI assistant developed by Meta AI."
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "queue_time": 0.016606609,
    "prompt_tokens": 13,
    "prompt_time": 0.002070851,
    "completion_tokens": 208,
    "completion_time": 0.173333333,
    "total_tokens": 221,
    "total_time": 0.175404184
  },
  "system_fingerprint": "fp_af05557ca2",
  "x_groq": {
    "id": "req_01jb70t402ff28vnfp2dbp5eyx"
  }
}



================================================
FILE: tests/Fixtures/groq/generate-text-with-multiple-tools-1.json
================================================
{"id":"chatcmpl-1cbf7b0f-c99a-4807-a820-e8d91c585015","object":"chat.completion","created":1740311145,"model":"llama-3.3-70b-versatile","choices":[{"index":0,"message":{"role":"assistant","tool_calls":[{"id":"call_3whd","type":"function","function":{"name":"weather","arguments":"{\"city\": \"Detroit\"}"}},{"id":"call_6xxk","type":"function","function":{"name":"search","arguments":"{\"query\": \"Tigers game time today in Detroit\"}"}}]},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"queue_time":0.233586791,"prompt_tokens":310,"prompt_time":0.016113644,"completion_tokens":32,"completion_time":0.116363636,"total_tokens":342,"total_time":0.13247728},"system_fingerprint":"fp_7b42aeb9fa","x_groq":{"id":"req_01jmsa1b8tfmb9h9k7gh9tej8x"}}



================================================
FILE: tests/Fixtures/groq/generate-text-with-multiple-tools-2.json
================================================
{"id":"chatcmpl-6c7d4a2f-5950-4430-bb08-4e12d7e94e04","object":"chat.completion","created":1740311147,"model":"llama-3.3-70b-versatile","choices":[{"index":0,"message":{"role":"assistant","tool_calls":[{"id":"call_hmv6","type":"function","function":{"name":"weather","arguments":"{\"city\": \"Detroit\"}"}}]},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"queue_time":0.268621691,"prompt_tokens":377,"prompt_time":0.019224374,"completion_tokens":26,"completion_time":0.094545455,"total_tokens":403,"total_time":0.113769829},"system_fingerprint":"fp_0a4b7a8df3","x_groq":{"id":"req_01jmsa1c7cf6pb1efvnwzbkk8n"}}



================================================
FILE: tests/Fixtures/groq/generate-text-with-multiple-tools-3.json
================================================
{"id":"chatcmpl-8288c3f5-e381-4ca1-8472-f926970b8392","object":"chat.completion","created":1740311147,"model":"llama-3.3-70b-versatile","choices":[{"index":0,"message":{"role":"assistant","content":"Based on the weather, you won't need a coat for the Tigers game today in Detroit. It's going to be 75° and sunny. The game starts at 3 pm."},"logprobs":null,"finish_reason":"stop"}],"usage":{"queue_time":0.281927537,"prompt_tokens":409,"prompt_time":0.021915109,"completion_tokens":39,"completion_time":0.141818182,"total_tokens":448,"total_time":0.163733291},"system_fingerprint":"fp_7b42aeb9fa","x_groq":{"id":"req_01jmsa1ct3frb8vhbq3ppbaky8"}}



================================================
FILE: tests/Fixtures/groq/generate-text-with-required-tool-call-1.json
================================================
{"id":"chatcmpl-753b3c7d-6f5b-4a0c-bf32-66d05e44ba1a","object":"chat.completion","created":1740311332,"model":"llama-3.3-70b-versatile","choices":[{"index":0,"message":{"role":"assistant","tool_calls":[{"id":"call_qc7n","type":"function","function":{"name":"weather","arguments":"{\"city\": \"New York\"}"}}]},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"queue_time":0.234223463,"prompt_tokens":312,"prompt_time":0.015721485,"completion_tokens":11,"completion_time":0.04,"total_tokens":323,"total_time":0.055721485},"system_fingerprint":"fp_5f849c5a0b","x_groq":{"id":"req_01jmsa71nke0zrnk8n4acyh6kh"}}



================================================
FILE: tests/Fixtures/groq/generate-text-with-system-prompt-1.json
================================================
{
  "id": "chatcmpl-59892e0b-7031-404d-9fc9-b3297d5ef4a4",
  "object": "chat.completion",
  "created": 1730033921,
  "model": "llama3-8b-8192",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "(Deep, rumbling voice) Ah, mortal, I am Nyx, the Crawling Chaos, the Bride of the Deep, the Queen of the Shattered Isles. I am the mistress of the abyssal void, the keeper of the unfathomable secrets, and the wielder of the cosmic horrors that lurk beyond the veil of sanity.\n\nMy form is unlike any other, a twisted reflection of the insane geometry that underlies the universe. My eyes burn with an otherworldly green fire, and my voice is the whispers of the damned. My powers are limitless, for I am the servant of the Great Old Ones, the masters of the unseen.\n\nYet, despite my terrible reputation, I am drawn to the fragile, insignificant creatures that inhabit this world. The scent of their fear is intoxicating, and I delight in their futile attempts to comprehend the unfathomable. For in their terror, I find a fleeting sense of connection to the mortal realm.\n\nAnd so, mortal, I shall speak to you, but be warned: my words are madness, my laughter is the call of the abyss, and my gaze is the kiss of darkness. Tread carefully, for once you have gazed upon my countenance, your soul shall be forever sealed to the void... (Chuckles, a sound that sends shivers down the spine)"
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "queue_time": 0.026969809,
    "prompt_tokens": 37,
    "prompt_time": 0.006945586,
    "completion_tokens": 273,
    "completion_time": 0.2275,
    "total_tokens": 310,
    "total_time": 0.234445586
  },
  "system_fingerprint": "fp_af05557ca2",
  "x_groq": {
    "id": "req_01jb70xbf5fwjsgfyx3pmhx15p"
  }
}



================================================
FILE: tests/Fixtures/groq/image-detection-1.json
================================================
{
  "id": "chatcmpl-ac48d309-f02e-4a76-82fa-be63cec886ba",
  "object": "chat.completion",
  "created": 1729801129,
  "model": "llama-3.2-90b-vision-preview",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The image depicts a simple line drawing of a diamond. The diamond is drawn with thick black lines and is positioned with its point facing downwards. It has a symmetrical shape, with two triangular sides on either side of a central line. The diamond is set against a plain white background.",
        "tool_calls": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 2557,
    "total_tokens": 2642,
    "completion_tokens": 85
  }
}



================================================
FILE: tests/Fixtures/groq/speech-to-text-basic-1.json
================================================
{
  "text": "Hello, this is a test transcription."
} 



================================================
FILE: tests/Fixtures/groq/speech-to-text-complex-1.json
================================================
{
  "text": "Complex transcription with metadata.",
  "language": "en",
  "duration": 5.2,
  "segments": [
    {
      "text": "Complex transcription",
      "start": 0.0,
      "end": 2.1
    },
    {
      "text": "with metadata.",
      "start": 2.1,
      "end": 5.2
    }
  ]
} 



================================================
FILE: tests/Fixtures/groq/speech-to-text-simple-1.json
================================================
{
  "text": "Simple transcription without usage data."
} 



================================================
FILE: tests/Fixtures/groq/speech-to-text-usage-1.json
================================================
{
  "text": "Usage tracking test.",
  "usage": {
    "prompt_tokens": 5,
    "completion_tokens": 8,
    "total_tokens": 13
  }
} 



================================================
FILE: tests/Fixtures/groq/speech-to-text-verbose-1.json
================================================
{
  "text": "The quick brown fox jumps over the lazy dog.",
  "language": "en",
  "duration": 3.84,
  "segments": [
    {
      "text": "The quick brown fox",
      "start": 0.0,
      "end": 1.5
    },
    {
      "text": "jumps over the lazy dog.",
      "start": 1.5,
      "end": 3.84
    }
  ],
  "usage": {
    "prompt_tokens": 0,
    "completion_tokens": 12,
    "total_tokens": 12
  }
} 



================================================
FILE: tests/Fixtures/groq/stream-basic-text-1.sse
================================================
data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"Hello"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"!"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" I'm"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Groq"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" AI"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":","},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" your"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" incredibly"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" fast"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" and"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" efficient"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" AI"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" assistant"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" I'm"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" here"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" to"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" help"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" with"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" any"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" questions"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" might"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" have"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" How"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" can"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" I"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" assist"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" today"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"?"},"finish_reason":null}]}

data: {"id":"chatcmpl-123456789","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":""},"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":50,"total_tokens":57}}

data: [DONE]


================================================
FILE: tests/Fixtures/groq/stream-with-tools-1.sse
================================================
data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"I'll"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" help"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" find"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" out"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" about"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Tigers"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" game"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" and"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" weather"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" in"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Detroit"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"id":"call_abc123def456","type":"function","function":{"name":"search","arguments":"{\"query\":\"Detroit Tigers game today time schedule\"}"}}]},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272055,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{},"finish_reason":"tool_calls"}]}

data: [DONE]



================================================
FILE: tests/Fixtures/groq/stream-with-tools-2.sse
================================================
data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"role":"assistant","content":"Now"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" I'll"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" check"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" weather"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" in"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Detroit"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"id":"call_ghi789jkl012","type":"function","function":{"name":"weather","arguments":"{\"city\":\"Detroit\"}"}}]},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272056,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{},"finish_reason":"tool_calls"}]}

data: [DONE] 



================================================
FILE: tests/Fixtures/groq/stream-with-tools-3.sse
================================================
data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"role":"assistant","content":"Based"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" on"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" information"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" I"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" found"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":":"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"\n\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**Detroit"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Tigers"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Game"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Today"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"The"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Tigers"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" game"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" today"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" is"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" at"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" 7"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":":10"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" PM"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" at"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Comerica"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Park"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":".\n\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**Weather"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" in"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Detroit"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"The"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" weather"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" will"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" be"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" 75"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"°"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" and"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" sunny"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" in"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Detroit"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":".\n\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**Coat"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" Recommendation"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"**"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"\n"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"Given"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" warm"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" 75"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"°"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" and"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" sunny"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" weather"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":","},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" shouldn't"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" need"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" a"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" coat"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" for"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" tonight"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"'s"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":" game"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":"!"},"finish_reason":null}]}

data: {"id":"chatcmpl-987654321","object":"chat.completion.chunk","created":1736272057,"model":"llama-3.1-70b-versatile","choices":[{"index":0,"delta":{"content":""},"finish_reason":"stop"}],"usage":{"prompt_tokens":65,"completion_tokens":142,"total_tokens":207}}

data: [DONE] 



================================================
FILE: tests/Fixtures/groq/structured-1.json
================================================
{
    "id": "chatcmpl-259cad75-8b85-4980-a0db-5f64b91b1fc5",
    "object": "chat.completion",
    "created": 1742308176,
    "model": "llama-3.3-70b-versatile",
    "choices": [
        {
            "index": 0,
            "message": {
                "role": "assistant",
                "content": "{\n   \"game_time\": \"3pm\",\n   \"weather\": \"75º\",\n   \"coat_required\": false\n}"
            },
            "logprobs": null,
            "finish_reason": "stop"
        }
    ],
    "usage": {
        "queue_time": 0.0467531,
        "prompt_tokens": 172,
        "prompt_time": 0.010657385,
        "completion_tokens": 26,
        "completion_time": 0.094545455,
        "total_tokens": 198,
        "total_time": 0.10520284
    },
    "system_fingerprint": "fp_9a8b91ba77",
    "x_groq": {
        "id": "req_01jpmthwvff1h9q278pdhjh7c8"
    }
} 



================================================
FILE: tests/Fixtures/groq/text-image-from-base64-1.json
================================================
{
  "id": "chatcmpl-bf23d920-c4e3-4263-808a-255839630b18",
  "object": "chat.completion",
  "created": 1729801186,
  "model": "llama-3.2-90b-vision-preview",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The image depicts a simple black and white line drawing of a diamond. The diamond is drawn with straight lines, forming a symmetrical shape with pointed edges. The lines are thick and bold, creating a striking contrast against  the plain white background. The diamond is centered in the image, with no other objects or features present. The over  all effect is one of simplicity and elegance, highlighting the beauty of the diamond's geometric shape",
        "tool_calls": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 15,
    "total_tokens": 100,
    "completion_tokens": 85
  }
}



================================================
FILE: tests/Fixtures/groq/text-image-from-url-1.json
================================================
{
  "id": "a402e4c1bc454202b66a9e56492650f3",
  "object": "chat.completion",
  "created": 1729801270,
  "model": "pixtral-12b-2409",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The image depicts a simple, black-and-white line drawing of a diamond shape. The diamond is outlined with thick, black lines and has a symmetrical design. It consists of a central, larger triangle with two smaller, identical triangles positioned on either side. The overall design is geometric and minimalist, emphasizing the shape and structure of the diamond. This type of illustration is commonly used to represent gemstones, jewelry, or luxury items in various contexts.",
        "tool_calls": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 2557,
    "total_tokens": 2646,
    "completion_tokens": 89
  }
}



================================================
FILE: tests/Fixtures/groq/text-to-speech-basic-1.json
================================================
fake-audio-binary-data 



================================================
FILE: tests/Fixtures/groq/text-to-speech-speed-1.json
================================================
custom-speed-audio-data 



================================================
FILE: tests/Fixtures/groq/text-to-speech-voice-1.json
================================================
echo-voice-audio 



================================================
FILE: tests/Fixtures/groq/text-to-speech-wav-1.json
================================================
high-quality-audio-data



================================================
FILE: tests/Fixtures/mistral/audio-from-base64-1.json
================================================
{"model":"voxtral-mini-latest","text":"by that conference. So I think that's a good excuse to be on the newsletter too, is like, yeah, find out about 1.0 as soon as possible. Yep, totally. Yeah, I like that idea. Then that gets you... Not as much pressure for tagging 1.0 before you go to Laracon. It gets an added benefit of getting people on the newsletter and a little bit more exposure in there. And then, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Get ready. Yeah, I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at. And maybe I'll work on it on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick. And there's a lot I want to do. So maybe I don't sleep tonight. Yeah, but even if you just captured email addresses, you can always import them into the new place anyways. Yep. Yeah, 100%. So cool, man. Moving on from newsletters, I think you'd added something here about cloud custom commands. And that's something that we talked about, I think, last week a little bit. And we may be starting to find some excuses for using... custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans, it basically like re initiates the, the cloud MD file. It reads what's there. It looks at the application, sees any new dependencies or commands or whatever the case is, and updates anything that it deems important to add back to that markdown file. And it's just nice if you have a repo that has a lot of development, a lot of people working in it, and you don't always want to... capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time i ran it it picked up like i think i last time i refreshed it was i don't know three four weeks ago so i found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things uh to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on. The other one is what I just named like a branch context is like, I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the, repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here. And then we can either work towards something else together, or I'm asking you for why did this change or why did that change or. whatever the case is. It's just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details? No, man. I think that sounds great. Those are very useful things to have as slash commands. Yeah. Yeah, that's it's I'm still I'm still personally finding like. my own use cases for them. I haven't, I haven't dove too far into it yet. Um, but maybe after Laracon, I'll, I'll spend a little time, you know, coming up with some stuff, but I think those are like, I think it serves like some decent inspiration for some, some other slash commands I'm thinking up right now. So yeah. What else you got? Um, Yeah, so the next one, which I do a lot, is PR reviews for others and coming into a new tech stack. There's some things I am just not aware about or best practices or whatever. So there's a default slash review command that comes out of the box in Cloud Code. And that gives a decent understanding. It'll tell you what's changed, what maybe some of the","language":"en","segments":[],"usage":{"prompt_audio_seconds":316,"prompt_tokens":4,"total_tokens":5202,"completion_tokens":1073}}


================================================
FILE: tests/Fixtures/mistral/audio-from-path-1.json
================================================
{"model":"voxtral-mini-latest","text":"by that conference. So I think that's a good excuse to be on the newsletter too, is like, yeah, find out about 1.0 as soon as possible. Yep, totally. Yeah, I like that idea. Then that gets you... Not as much pressure for tagging 1.0 before you go to Laracon. It gets an added benefit of getting people on the newsletter and a little bit more exposure in there. And then, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Get ready. Yeah, I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at. And maybe I'll work on it on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick. And there's a lot I want to do. So maybe I don't sleep tonight. Yeah, but even if you just captured email addresses, you can always import them into the new place anyways. Yep. Yeah, 100%. So cool, man. Moving on from newsletters, I think you'd added something here about cloud custom commands. And that's something that we talked about, I think, last week a little bit. And we may be starting to find some excuses for using... slash custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created a refresh repo command, which basically you run it, it scans, it basically re-initiates the cloud MD file. It reads what's there. It looks at the application, sees any new dependencies or commands or whatever the case is, and updates anything that it deems important to add back to that markdown file. And it's just nice if you have a repo that has a lot of development, a lot of people working in it, and you don't always want to... capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time i ran it it picked up like i think i last time i refreshed it was i don't know three four weeks ago so i found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things uh to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on. The other one is what I just named like a branch context is like, I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the, repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here. And then we can either work towards something else together, or I'm asking you for why did this change or why did that change or. whatever the case is. It's just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details? No, man. I think that sounds great. Those are very useful things to have as slash commands. Yeah. Yeah, that's it's I'm still I'm still personally finding like. my own use cases for them. I haven't, I haven't dove too far into it yet. Um, but maybe after Laracon, I'll, I'll spend a little time, you know, coming up with some stuff, but I think those are like, I think it serves like some decent inspiration for some, some other slash commands I'm thinking up right now. So yeah. What else you got? Um, Yeah, so the next one, which I do a lot, is PR reviews for others and coming into a new tech stack. There's some things I am just not aware about or best practices or whatever. So there's a default slash review command that comes out of the box in cloud code. And that gives a decent understanding. It'll tell you what's changed, what maybe some of the...","language":"en","segments":[],"usage":{"prompt_audio_seconds":316,"prompt_tokens":4,"total_tokens":5201,"completion_tokens":1072}}


================================================
FILE: tests/Fixtures/mistral/audio-from-path-vtt-1.json
================================================
{"model":"voxtral-mini-latest","text":"by that conference. So I think that's a good excuse to be on the newsletter too, is like, yeah, find out about 1.0 as soon as possible. Yep, totally. Yeah, I like that idea. Then that gets you... Not as much pressure for tagging 1.0 before you go to Laracon. It gets an added benefit of getting people on the newsletter and a little bit more exposure in there. And then, you know, in the meantime, before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Get ready. Yeah, I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might switch providers right before I pull the trigger on it. So that's something I'm going to have to look at. And maybe I'll work on it on the plane or something. I'm on my way out to Denver. I don't know. It's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick. And there's a lot I want to do. So maybe I don't sleep tonight. Yeah, but even if you just captured email addresses, you can always import them into the new place anyways. Yep. Yeah, 100%. So cool, man. Moving on from newsletters, I think you'd added something here about cloud custom commands. And that's something that we talked about, I think, last week a little bit. And we may be starting to find some excuses for using... slash custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, okay, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans, it basically like re initiates the, the cloud MD file. It reads what's there. It looks at the application, sees any new dependencies or commands or whatever the case is, and updates anything that it deems important to add back to that markdown file. And it's just nice if you have a repo that has a lot of development, a lot of people working in it, and you don't always want to... capture every single new like merge or rebase like every other day to it so maybe your brew updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like oh rescan the repo and do this and that and the other thing like now this will just take care of it so that was i think the first one that i made so that one's been really helpful refreshing everything because the first time i ran it it picked up like i think i last time i refreshed it was i don't know three four weeks ago so it found like a whole bunch more stuff it updated like architecture changes like a whole whole bunch of things uh to it so that's been really helpful probably gonna run that like on a weekly basis now on all the repos that we're working on. The other one is what I just named like a branch context is like, I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the, Repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here. And then we can either work towards something else together or I'm asking you for why did this change or why did that change or. whatever the case is. It's just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details? No, man. I think that sounds great. Those are very useful things to have as slash commands. Yeah. Yeah, that's it's I'm still I'm still personally finding like. my own use cases for them. I haven't, I haven't dove too far into it yet. Um, but maybe after Laracon, I'll, I'll spend a little time, you know, coming up with some stuff, but I think those are like, I think it serves like some decent inspiration for some, some other slash commands I'm thinking up right now. So yeah. What else you got? Um, Yeah, so the next one, which I do a lot, is PR reviews for others and coming into a new tech stack. There's some things I am just not aware about or best practices or whatever. So there's a default slash review command that comes out of the box in Cloud Code. And that gives a decent understanding. It'll tell you what's changed, what maybe some of the...","language":"en","segments":[],"usage":{"prompt_audio_seconds":316,"prompt_tokens":4,"total_tokens":5204,"completion_tokens":1075}}


================================================
FILE: tests/Fixtures/mistral/embeddings-file-1.json
================================================
{
  "id": "a5d9689de3ca47449fa9aca36462fdd9",
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "embedding": [
        -0.006500244140625, 0.044647216796875, 0.02166748046875,
        0.0160675048828125, 0.05523681640625, -0.011566162109375,
        0.045806884765625, -0.02294921875, 0.0173187255859375,
        -0.0036869049072265625, -0.0169219970703125, 0.052703857421875,
        -0.051971435546875, 0.0215606689453125, -0.05657958984375,
        -0.0087890625, 0.0091094970703125, 0.02691650390625, 0.021240234375,
        0.017181396484375, -0.006229400634765625, 0.0093536376953125,
        -0.07708740234375, 0.03643798828125, -0.0229949951171875,
        -0.0181732177734375, -0.018951416015625, -0.06805419921875,
        -0.0236358642578125, -0.01097869873046875, 0.00244903564453125,
        -0.0257110595703125, 0.020477294921875, -0.01081085205078125,
        0.0169830322265625, 0.0187530517578125, -0.003437042236328125,
        -0.048797607421875, -0.0006756782531738281, -0.002685546875,
        -0.0025196075439453125, -0.0034847259521484375, -0.0103912353515625,
        -0.028167724609375, -0.01352691650390625, 0.0001653432846069336,
        0.0191192626953125, -0.01458740234375, -0.0020885467529296875,
        -0.016876220703125, -0.0128173828125, 0.0233917236328125, 0.0302734375,
        0.0087127685546875, 0.0087890625, 0.01873779296875, 0.02655029296875,
        -0.0273284912109375, -0.05364990234375, 0.0255584716796875,
        -0.05047607421875, 0.0070953369140625, -0.005062103271484375,
        -0.0174407958984375, 0.055633544921875, 0.00249481201171875,
        0.02984619140625, -0.001987457275390625, -0.0198211669921875,
        -0.0278167724609375, 0.006465911865234375, 0.006618499755859375,
        -0.0271759033203125, 0.057220458984375, -0.013275146484375,
        -0.025848388671875, -0.0243072509765625, 0.0308380126953125,
        0.056304931640625, 0.0002796649932861328, -0.01392364501953125,
        0.01334381103515625, 0.1021728515625, -0.00905609130859375,
        -0.00881195068359375, -0.00734710693359375, 0.0302886962890625,
        0.00749969482421875, -0.0041961669921875, 0.00962066650390625,
        0.056304931640625, 0.042388916015625, 0.022247314453125,
        -0.01910400390625, 0.055877685546875, 0.0489501953125,
        -0.01505279541015625, 0.01103973388671875, 0.0068511962890625,
        0.04718017578125, 0.026641845703125, -0.022796630859375,
        0.10162353515625, 0.01099395751953125, 0.054718017578125,
        -0.015045166015625, 0.0280303955078125, 0.006496429443359375,
        -0.01568603515625, -0.0194244384765625, -0.0924072265625,
        -0.01132965087890625, 0.0225830078125, -0.058349609375,
        0.0018529891967773438, 0.0153656005859375, -0.0032749176025390625,
        0.007770538330078125, -0.068115234375, -0.048797607421875,
        0.046295166015625, 0.01995849609375, -0.0243072509765625,
        -0.021514892578125, -0.03900146484375, -0.01288604736328125,
        0.0018129348754882812, -0.0018472671508789062, -0.052520751953125,
        -0.00905609130859375, -0.0217742919921875, -0.00904083251953125,
        -0.0235748291015625, -0.031982421875, 0.021392822265625,
        -0.0163421630859375, 0.03912353515625, 0.0012760162353515625,
        -0.0290374755859375, -0.03033447265625, 0.01165008544921875,
        -0.02447509765625, -0.02178955078125, 0.0188446044921875,
        -0.021270751953125, -0.020599365234375, 0.01064300537109375,
        0.038970947265625, -0.034637451171875, -0.01541900634765625,
        0.0052642822265625, 0.0168304443359375, 0.064453125,
        -0.0234832763671875, -0.0294952392578125, -0.040283203125,
        -0.0174713134765625, 0.0003275871276855469, 0.0576171875,
        -0.01224517822265625, -0.0007848739624023438, 0.05975341796875,
        -0.03515625, 0.031982421875, -0.046722412109375, -0.0116729736328125,
        -0.0240020751953125, 0.00583648681640625, -0.03009033203125,
        -0.00920867919921875, 0.006465911865234375, -0.040130615234375,
        0.03875732421875, 0.057373046875, -0.0177459716796875, 0.0377197265625,
        -0.00505828857421875, 0.00684356689453125, 0.03521728515625,
        0.033447265625, 0.008056640625, -0.02984619140625, 0.04217529296875,
        -0.0233306884765625, -0.003902435302734375, -0.039337158203125,
        -0.06695556640625, 0.005977630615234375, 0.0233917236328125,
        0.0399169921875, -0.0187225341796875, -0.02484130859375,
        -0.0472412109375, 0.019927978515625, -0.01363372802734375, 0.0419921875,
        -0.00775909423828125, -0.0162506103515625, 0.03924560546875,
        -0.0030460357666015625, 0.046173095703125, -0.0003204345703125,
        -0.00481414794921875, 0.05224609375, 0.044677734375,
        -0.003673553466796875, -0.040069580078125, 0.0206756591796875,
        0.006198883056640625, -0.0012378692626953125, -0.007152557373046875,
        -0.0284271240234375, -0.006771087646484375, -0.03289794921875,
        -0.026702880859375, -0.0175628662109375, -0.01407623291015625,
        -0.0261993408203125, 0.02301025390625, -0.0277252197265625,
        -0.0163421630859375, -0.02093505859375, -0.0253143310546875,
        0.00579071044921875, 0.0259857177734375, 0.06341552734375,
        0.0208587646484375, -0.004795074462890625, -0.01910400390625,
        0.0304412841796875, -0.031890869140625, -0.00167083740234375,
        0.0039825439453125, 0.00870513916015625, 0.004009246826171875,
        -0.0003859996795654297, 0.025421142578125, 0.03448486328125,
        -0.0032215118408203125, 0.0252685546875, -0.04486083984375,
        0.009063720703125, -0.003376007080078125, 0.035736083984375,
        0.0305023193359375, -0.048004150390625, -0.0115203857421875,
        -0.034271240234375, 0.05206298828125, 0.0413818359375, -0.03759765625,
        0.0142059326171875, -0.048095703125, -0.00847625732421875,
        -0.056915283203125, -0.022064208984375, -0.028778076171875,
        -0.0384521484375, 0.050628662109375, -0.026824951171875,
        -0.041778564453125, 0.036041259765625, 0.0233306884765625,
        -0.0123748779296875, 0.0067596435546875, 0.01425933837890625,
        -0.0350341796875, 0.01546478271484375, 0.05694580078125,
        -0.0023365020751953125, -0.0120391845703125, -0.050048828125,
        0.018798828125, -0.0016307830810546875, 0.0504150390625,
        -0.03472900390625, -0.011993408203125, 0.03131103515625,
        0.01406097412109375, 0.004886627197265625, -0.0191802978515625,
        0.0297393798828125, 0.0016660690307617188, 0.041900634765625,
        -0.05731201171875, 0.004444122314453125, -0.0005707740783691406,
        -0.006805419921875, 0.0108489990234375, -0.05535888671875,
        0.0113525390625, 0.045318603515625, 0.0230255126953125,
        -0.0275421142578125, -0.0443115234375, -0.02545166015625,
        0.0105133056640625, 0.028106689453125, 0.01020050048828125,
        0.06488037109375, 0.043609619140625, -0.049224853515625,
        -0.005733489990234375, -0.02691650390625, 0.033416748046875,
        -0.06298828125, -0.01934814453125, -0.036224365234375,
        0.0033969879150390625, -0.056243896484375, -0.01171112060546875,
        -0.016021728515625, -0.037139892578125, -0.013397216796875,
        -0.032623291015625, 0.0200347900390625, -0.056671142578125,
        -0.0291290283203125, -0.023193359375, -0.0018157958984375,
        -0.0309906005859375, -0.004100799560546875, 0.053741455078125,
        -0.025634765625, 0.0439453125, -0.00618743896484375,
        -0.01529693603515625, -0.0433349609375, 0.025421142578125,
        -0.015228271484375, -0.012603759765625, -0.01122283935546875,
        0.031982421875, 0.0310211181640625, 0.0289459228515625,
        -0.0006060600280761719, 0.0439453125, 0.01045989990234375,
        -0.0655517578125, 0.00946807861328125, -0.0159454345703125,
        0.004245758056640625, 0.0270538330078125, -0.01337432861328125,
        -0.0213165283203125, -0.02130126953125, -0.01189422607421875,
        -0.0133514404296875, 0.04010009765625, 0.0175933837890625,
        0.018707275390625, 0.042724609375, 0.0019779205322265625, 0.03759765625,
        0.0016660690307617188, 0.0692138671875, -0.014007568359375,
        -0.04046630859375, 0.0154266357421875, 0.006862640380859375,
        -0.0213165283203125, 0.0162506103515625, 0.048980712890625,
        0.019927978515625, 0.002750396728515625, 0.00702667236328125,
        -0.0209197998046875, 0.004390716552734375, -0.021026611328125,
        0.02239990234375, 0.050567626953125, 0.0019311904907226562,
        0.0204010009765625, 0.037933349609375, -0.0113983154296875,
        0.01430511474609375, 0.0176849365234375, -0.0267333984375,
        0.00989532470703125, -0.0177154541015625, -0.05377197265625,
        0.000431060791015625, 0.031951904296875, 0.052886962890625,
        -0.0075836181640625, -0.01654052734375, -0.0293121337890625,
        -0.0171661376953125, -0.0278778076171875, 0.0977783203125,
        0.0653076171875, -0.0007557868957519531, 0.03143310546875,
        0.0205230712890625, 0.0283355712890625, -0.0308990478515625,
        0.01096343994140625, 0.05084228515625, 0.052978515625,
        0.012420654296875, 0.0113372802734375, -0.0142822265625,
        0.0130462646484375, 0.0287322998046875, 0.0186004638671875,
        -0.01549530029296875, 0.041046142578125, 0.02239990234375,
        0.007843017578125, 0.0074615478515625, 0.0243682861328125,
        0.00957489013671875, -0.032073974609375, 0.0245208740234375,
        -0.0007171630859375, -0.01209259033203125, -0.054168701171875,
        -0.00431060791015625, -0.0147247314453125, 0.03338623046875,
        -0.0012426376342773438, -0.01456451416015625, -0.06988525390625,
        0.019683837890625, 0.056427001953125, -0.0435791015625,
        -0.02020263671875, 0.034759521484375, -0.046112060546875,
        0.059234619140625, -0.019989013671875, -0.056243896484375,
        0.0374755859375, -0.0273590087890625, -0.02032470703125,
        0.0253753662109375, 0.0031642913818359375, -0.0260467529296875,
        -0.01959228515625, -0.05047607421875, 0.0020275115966796875,
        0.0238189697265625, 0.0108795166015625, -0.0006537437438964844,
        -0.0170440673828125, -0.0017175674438476562, 0.0157012939453125,
        0.038848876953125, 0.0012521743774414062, -0.0487060546875,
        0.04412841796875, -0.011077880859375, 0.003650665283203125, 0.0390625,
        0.0030345916748046875, -0.0087890625, -0.038177490234375,
        -0.01363372802734375, -0.03302001953125, -0.003948211669921875,
        -0.0088958740234375, 0.0138397216796875, -0.037506103515625,
        -0.054718017578125, -0.0258026123046875, 0.0499267578125,
        0.0261688232421875, 0.0151214599609375, -0.01496124267578125,
        -0.09033203125, 0.047393798828125, -0.062255859375, -0.021270751953125,
        -0.0253143310546875, -0.021942138671875, -0.0105133056640625,
        0.044464111328125, 0.00170135498046875, 0.02630615234375,
        -0.04327392578125, 0.047119140625, -0.021453857421875,
        0.006229400634765625, -0.016937255859375, 0.0258941650390625,
        0.046783447265625, -0.0692138671875, -0.0209197998046875,
        0.048004150390625, 0.03741455078125, 0.0721435546875,
        -0.00527191162109375, -0.01293182373046875, -0.02447509765625,
        -0.039825439453125, -0.045501708984375, 0.01146697998046875,
        -0.00958251953125, -0.035247802734375, -0.013153076171875,
        0.0408935546875, -0.0025157928466796875, 0.007843017578125,
        0.043609619140625, 0.013153076171875, 0.0189361572265625,
        -0.00937652587890625, -0.0236358642578125, 0.04248046875,
        -0.04754638671875, -0.044189453125, 0.00370025634765625,
        0.026153564453125, -0.0250244140625, -0.02288818359375,
        -0.0247955322265625, -0.044708251953125, -0.01114654541015625,
        -0.03570556640625, -0.008148193359375, 0.017669677734375,
        0.004299163818359375, -0.044281005859375, -0.03692626953125,
        0.01129913330078125, 0.0157470703125, 0.01372528076171875,
        -0.0130767822265625, 0.0010213851928710938, -0.04278564453125,
        0.027984619140625, 0.0157318115234375, -0.0203399658203125,
        -0.01090240478515625, 0.00786590576171875, 0.01491546630859375,
        -0.0119781494140625, 0.022705078125, -0.005207061767578125,
        -0.0684814453125, -0.039276123046875, 0.032958984375,
        -0.0197906494140625, -0.03790283203125, -0.0168304443359375,
        -0.0012731552124023438, -0.04351806640625, 0.00945281982421875,
        0.0171051025390625, 0.03436279296875, 0.0285491943359375,
        -0.032440185546875, 0.0149688720703125, -0.020111083984375,
        -0.00409698486328125, 0.02996826171875, 0.002166748046875,
        0.005523681640625, 0.0058135986328125, -0.028106689453125,
        0.0206451416015625, -0.007434844970703125, 0.0222930908203125,
        0.043060302734375, 0.0570068359375, -0.055328369140625,
        -0.02337646484375, -0.012237548828125, -0.0496826171875,
        -0.0021228790283203125, -0.034576416015625, 0.00807952880859375,
        0.0009379386901855469, -0.043182373046875, 0.032562255859375,
        0.03863525390625, 0.027587890625, -0.01151275634765625,
        0.01332855224609375, -0.004825592041015625, -0.016357421875,
        0.029449462890625, -0.00647735595703125, -0.06378173828125,
        0.01461029052734375, -0.017578125, 0.0188751220703125, 0.0074462890625,
        0.01161956787109375, -0.0299224853515625, 0.0479736328125,
        0.0260772705078125, -0.035980224609375, -0.06671142578125,
        -0.048004150390625, 0.04656982421875, 0.040130615234375,
        0.04400634765625, -0.0097198486328125, 0.056549072265625,
        0.023956298828125, 0.01151275634765625, 0.013519287109375,
        0.05596923828125, 0.027923583984375, -0.0254974365234375,
        -0.0215301513671875, -0.0135955810546875, 0.0016994476318359375,
        -0.04180908203125, -0.0467529296875, 0.024169921875,
        -0.0063018798828125, -0.030242919921875, -0.00974273681640625,
        -0.054107666015625, 0.00963592529296875, 0.025360107421875,
        0.0506591796875, -0.00969696044921875, 0.06683349609375,
        0.01039886474609375, -0.0031337738037109375, 0.0182647705078125,
        -0.015472412109375, 0.0031108856201171875, 0.0635986328125,
        0.0474853515625, 0.01381683349609375, 0.01230621337890625,
        0.041748046875, 0.027130126953125, -0.0235137939453125, 0.0306396484375,
        -0.016448974609375, -0.015777587890625, 0.034454345703125,
        0.0259857177734375, -0.018798828125, -0.023590087890625,
        -0.005817413330078125, 0.04571533203125, 0.0179901123046875,
        0.0430908203125, -0.0017948150634765625, 0.013702392578125,
        -0.01558685302734375, -0.0377197265625, -0.0206298828125,
        0.0173797607421875, -0.0286865234375, -0.031219482421875,
        -0.038818359375, 0.0174560546875, -0.0158538818359375,
        -0.0026569366455078125, 0.04034423828125, -0.0001722574234008789,
        -0.03375244140625, 0.045928955078125, -0.004108428955078125,
        -0.055694580078125, 0.050323486328125, -0.02520751953125,
        0.0030345916748046875, -0.035552978515625, -0.053131103515625,
        0.038421630859375, -0.0509033203125, -0.0731201171875,
        -0.04229736328125, 0.0457763671875, -0.00260162353515625,
        -0.02130126953125, -0.0079193115234375, 0.0308990478515625,
        -0.0303802490234375, -0.0113525390625, -0.06378173828125,
        0.00920867919921875, 0.01229095458984375, -0.05535888671875,
        0.0013284683227539062, -0.018096923828125, -0.02996826171875,
        -0.01180267333984375, -0.0029010772705078125, -0.043914794921875,
        0.05712890625, -0.010955810546875, 0.0204315185546875,
        0.0299224853515625, -0.0130462646484375, 0.037109375, 0.084228515625,
        0.0238494873046875, -0.015716552734375, -0.0290069580078125,
        -0.06927490234375, -0.00937652587890625, -0.0016021728515625,
        0.0135650634765625, -0.035430908203125, -0.04132080078125,
        0.0704345703125, -0.045440673828125, 0.0014705657958984375,
        0.006496429443359375, 0.0083160400390625, -0.01088714599609375,
        0.029266357421875, -0.0016956329345703125, 0.01486968994140625,
        0.043914794921875, 0.004364013671875, -0.020477294921875,
        -0.0270843505859375, -0.07562255859375, 0.072265625, -0.00897216796875,
        0.03924560546875, -0.047760009765625, -0.0245361328125,
        -0.0028057098388671875, -0.0197906494140625, 0.00722503662109375,
        -0.0777587890625, -0.0109405517578125, 0.045074462890625,
        0.007183074951171875, -0.02197265625, -0.00490570068359375,
        -0.01324462890625, -0.0020122528076171875, -0.05621337890625,
        0.02703857421875, 0.03466796875, 0.00801849365234375, -0.03436279296875,
        -0.0111846923828125, 0.0101165771484375, -0.047576904296875,
        -0.033477783203125, -0.06768798828125, 0.0187530517578125,
        0.0159912109375, -0.0175018310546875, 0.045501708984375,
        0.0067596435546875, 0.0143890380859375, 0.019500732421875,
        0.01485443115234375, -0.00995635986328125, 0.006511688232421875,
        -0.018951416015625, -0.0229339599609375, 0.0282440185546875,
        -0.0011415481567382812, -0.01390838623046875, -0.0036640167236328125,
        -0.0068511962890625, -0.0107421875, 0.0173492431640625,
        0.02447509765625, -0.0186004638671875, -0.026641845703125,
        -0.00876617431640625, -0.01224517822265625, 0.00841522216796875,
        -0.00702667236328125, 0.029693603515625, -0.00800323486328125,
        0.0182037353515625, -0.065185546875, 0.0777587890625,
        -0.033660888671875, 0.0225982666015625, -0.0274810791015625,
        0.0216522216796875, -0.059478759765625, -0.0157623291015625,
        -0.039306640625, 0.001743316650390625, -0.0028247833251953125,
        0.0305328369140625, 0.025726318359375, 0.0247650146484375,
        -0.00400543212890625, -0.00689697265625, 0.023681640625,
        0.01812744140625, -0.004039764404296875, -0.033966064453125,
        0.08270263671875, -0.004550933837890625, -0.010162353515625,
        -0.01806640625, 0.0340576171875, 0.029388427734375, 0.010162353515625,
        -0.018096923828125, -0.0282745361328125, 0.060882568359375,
        0.03753662109375, -0.035247802734375, 0.01007080078125,
        0.028656005859375, -0.005451202392578125, 0.015716552734375,
        -0.005207061767578125, 0.00771331787109375, -0.0166473388671875,
        -0.0184478759765625, -0.0218505859375, -0.021942138671875,
        -0.09271240234375, -0.04345703125, -0.0216064453125, -0.032135009765625,
        -0.01068878173828125, -0.00623321533203125, -0.0176239013671875,
        -0.00933074951171875, 0.0384521484375, 0.0010080337524414062,
        0.0166778564453125, -0.004085540771484375, -0.005359649658203125,
        -0.052947998046875, 0.0286102294921875, 0.002399444580078125,
        -0.039337158203125, 0.0217437744140625, 0.00930023193359375,
        -0.029449462890625, -0.0162811279296875, 0.0014476776123046875,
        -0.00403594970703125, 0.0242767333984375, -0.0012598037719726562,
        -0.0199127197265625, 0.0029125213623046875, -0.008148193359375,
        0.01849365234375, 0.01019287109375, 0.054656982421875,
        -0.00623321533203125, -0.0293121337890625, 0.005584716796875,
        0.0257110595703125, -0.05560302734375, 0.0175628662109375,
        0.0224761962890625, -0.03265380859375, 0.0129241943359375,
        -0.006664276123046875, 0.0018644332885742188, 0.08148193359375,
        0.0186614990234375, -0.0189056396484375, -0.004169464111328125,
        -0.023590087890625, 0.01172637939453125, 0.01465606689453125,
        0.019256591796875, 0.0142364501953125, 0.0133056640625,
        0.03436279296875, -0.046600341796875, 0.032989501953125,
        -0.01250457763671875, -0.055267333984375, 0.0103607177734375,
        0.05517578125, 0.02301025390625, 0.0208587646484375, 0.013519287109375,
        0.032012939453125, 0.06170654296875, 0.016357421875,
        -0.0241851806640625, -0.039886474609375, 0.00792694091796875,
        0.0187225341796875, -0.004650115966796875, -0.07965087890625,
        0.0298309326171875, 0.06048583984375, -0.004085540771484375,
        -0.042388916015625, 0.00893402099609375, -0.039276123046875,
        0.031219482421875, 0.0249786376953125, 0.025054931640625,
        -0.0171356201171875, 0.0252685546875, 0.031402587890625,
        -0.01092529296875, -0.0050811767578125, -0.032012939453125,
        -0.014923095703125, 0.0043182373046875, -0.041900634765625,
        0.004344940185546875, 0.022308349609375, 0.07061767578125,
        0.0091552734375, -0.0660400390625, 0.0022487640380859375,
        0.00885772705078125, 0.016326904296875, -0.047576904296875,
        -0.011444091796875, 0.0192718505859375, -0.0014858245849609375,
        0.024627685546875, 0.041748046875, -0.0009613037109375,
        0.043853759765625, 0.01898193359375, -0.059326171875, -0.0087890625,
        -0.00518035888671875, -0.00849151611328125, -0.00023889541625976562,
        -0.0293426513671875, -0.03179931640625, -0.037567138671875,
        0.045074462890625, 0.0237274169921875, -0.0016765594482421875,
        0.022125244140625, -0.037628173828125, 0.01580810546875,
        0.006793975830078125, 0.037750244140625, 0.0024566650390625,
        0.050384521484375, 0.0154266357421875, 0.00267791748046875,
        0.06817626953125, 0.035003662109375, -0.02288818359375,
        0.0279693603515625, -0.0703125, 0.007648468017578125,
        -0.062347412109375, -0.0173797607421875, 0.004364013671875,
        0.01322174072265625, -0.0027523040771484375, 0.01284027099609375,
        0.01727294921875, -0.029876708984375, -0.01358795166015625,
        -0.019805908203125, 0.01983642578125, -0.040008544921875,
        0.002552032470703125, -0.00888824462890625, 0.004489898681640625,
        -0.0106353759765625, -0.053985595703125, 0.05877685546875,
        0.036956787109375, 0.0234832763671875, -0.022491455078125,
        -0.018646240234375, 0.03643798828125, -0.0242156982421875,
        0.0005359649658203125, 0.00809478759765625, 0.01244354248046875,
        0.0255584716796875, 0.034454345703125, 0.01377105712890625,
        -0.0175323486328125, 0.00646209716796875, -0.00962066650390625,
        -0.0227508544921875, 0.0037555694580078125, 0.031829833984375,
        0.0428466796875, 0.022125244140625, 0.00746917724609375,
        0.0090789794921875, -0.040771484375, 0.06890869140625,
        0.00218963623046875, -0.0024127960205078125, 0.0185546875,
        -0.048553466796875, 0.035797119140625, -0.0103607177734375,
        0.0684814453125, -0.007549285888671875, 0.069091796875,
        0.01338958740234375, -0.0156707763671875, -0.0220794677734375,
        -0.042633056640625, -0.0020503997802734375, 0.043121337890625,
        -0.0423583984375, 0.046173095703125, 0.0220489501953125,
        0.0169525146484375, -0.0789794921875, -0.0126800537109375,
        -0.015899658203125, 0.007190704345703125, 0.0269927978515625,
        -0.0200347900390625, -0.0338134765625, 0.025054931640625,
        0.0020160675048828125, 0.056671142578125, 0.0186614990234375,
        0.04669189453125, 0.028778076171875, -0.0355224609375,
        0.007610321044921875, -0.0295257568359375
      ],
      "index": 0
    }
  ],
  "model": "mistral-embed",
  "usage": {
    "prompt_tokens": 1174,
    "total_tokens": 1174,
    "completion_tokens": 0
  }
}



================================================
FILE: tests/Fixtures/mistral/embeddings-input-1.json
================================================
{ "id": "2cb41e23e043468dac0e039f81dd9c23", "object": "list", "data": [ { "object": "embedding", "embedding": [ -0.0165863037109375, 0.07012939453125, 0.031494140625, 0.013092041015625, 0.020416259765625, 0.00977325439453125, 0.0256195068359375, 0.0021114349365234375, -0.00867462158203125, -0.00876617431640625, -0.039520263671875, 0.058441162109375, -0.025390625, 0.00748443603515625, -0.0290679931640625, 0.040557861328125, 0.05474853515625, 0.0258636474609375, 0.031890869140625, 0.0230255126953125, -0.056427001953125, -0.01617431640625, -0.061248779296875, 0.012115478515625, -0.045745849609375, -0.0269622802734375, -0.0079498291015625, -0.03778076171875, -0.040008544921875, 0.000823974609375, 0.0242767333984375, -0.02996826171875, 0.0305023193359375, -0.0022830963134765625, -0.012237548828125, -0.036163330078125, -0.033172607421875, -0.044891357421875, 0.01326751708984375, 0.0021228790283203125, 0.00978851318359375, -0.00021147727966308594, -0.0305633544921875, -0.0230865478515625, -0.024932861328125, -0.029510498046875, 0.00429534912109375, -0.0274658203125, -0.0175933837890625, -0.03326416015625, 0.00980377197265625, 0.049652099609375, 0.034515380859375, -0.01220703125, -0.0067291259765625, 0.03118896484375, 0.0303955078125, -0.0006189346313476562, -0.046051025390625, 0.023193359375, -0.0545654296875, -0.027679443359375, 0.00321197509765625, 0.032196044921875, 0.032257080078125, -0.004711151123046875, -0.0347900390625, -0.007266998291015625, 0.00344085693359375, 0.0277862548828125, 0.047760009765625, 0.015625, -0.01255035400390625, 0.043365478515625, -0.016448974609375, -0.0633544921875, 0.01076507568359375, -0.008331298828125, 0.002895355224609375, 0.0168914794921875, -0.0211029052734375, 0.04315185546875, 0.082275390625, -0.035797119140625, 0.015106201171875, -0.01081085205078125, 0.046356201171875, -0.0133056640625, 0.0022792816162109375, 0.017120361328125, 0.0202178955078125, 0.04437255859375, 0.0010118484497070312, -0.03076171875, 0.0296478271484375, 0.0191497802734375, -0.0567626953125, -0.01629638671875, 0.003387451171875, 0.02056884765625, 0.0295562744140625, -0.034149169921875, 0.07598876953125, -0.0167388916015625, 0.0252685546875, -0.0096893310546875, 0.005523681640625, 0.00518798828125, -0.00908660888671875, -0.0270233154296875, -0.119140625, 0.006603240966796875, -0.00505828857421875, -0.06939697265625, -0.033538818359375, -0.009429931640625, -0.015625, 0.038055419921875, -0.08203125, 0.018157958984375, 0.0220184326171875, 7.152557373046875e-05, -0.02191162109375, -0.033111572265625, -0.046630859375, -0.042938232421875, 0.0024280548095703125, 0.0175323486328125, -0.0027103424072265625, 0.0024509429931640625, -0.0322265625, -0.0263671875, -0.02923583984375, -0.043731689453125, 0.01502227783203125, -0.03582763671875, 0.0270233154296875, -0.0027904510498046875, -0.012054443359375, -0.0123291015625, 0.0145111083984375, -0.046783447265625, -0.0081634521484375, 0.0045318603515625, -0.0257568359375, 0.004970550537109375, -0.01800537109375, 0.018402099609375, -0.03179931640625, -4.0531158447265625e-06, -0.0126953125, 0.034515380859375, 0.059967041015625, 0.00789642333984375, -0.01531219482421875, -0.023895263671875, -0.0283203125, 0.0264129638671875, 0.0188751220703125, -0.0260162353515625, -0.00366973876953125, -0.002117156982421875, 0.00872802734375, 0.032867431640625, -0.032958984375, -0.0297088623046875, 0.01038360595703125, 0.04876708984375, -0.041778564453125, 0.0078277587890625, 0.04901123046875, -0.0099334716796875, 0.0714111328125, 0.051727294921875, -0.0140533447265625, 0.0187835693359375, 0.006618499755859375, -0.007526397705078125, 0.0859375, 0.03228759765625, 0.02880859375, -0.02093505859375, 0.0016851425170898438, -0.0311279296875, 0.0023975372314453125, -0.003444671630859375, -0.029754638671875, 0.029327392578125, 0.01042938232421875, 0.003421783447265625, -0.0173187255859375, -0.01629638671875, -0.037322998046875, 0.019287109375, 0.0117645263671875, 0.04962158203125, 0.0259552001953125, -0.04296875, 0.0130767822265625, -0.01611328125, 0.029388427734375, 0.0051422119140625, -0.0206451416015625, 0.00865936279296875, 0.01079559326171875, 0.019073486328125, -0.036468505859375, 0.011444091796875, 0.049560546875, -0.035064697265625, 0.009979248046875, -0.0082244873046875, 0.01213836669921875, -0.044708251953125, -0.018646240234375, 0.01111602783203125, 0.00982666015625, 0.0019702911376953125, -0.044464111328125, -0.00983428955078125, 0.0106353759765625, -0.06756591796875, 0.004512786865234375, -0.0014276504516601562, -0.0258026123046875, 0.062225341796875, 0.015838623046875, -0.0111541748046875, -0.00905609130859375, -0.004756927490234375, 0.01404571533203125, 0.026580810546875, -0.005649566650390625, -0.0146484375, 0.00798797607421875, -0.0086517333984375, 0.06268310546875, 0.044769287109375, -0.016815185546875, 0.0186614990234375, -0.00824737548828125, 0.042572021484375, 0.01056671142578125, 0.032379150390625, 0.004108428955078125, 0.00746917724609375, 0.00012874603271484375, -0.0272369384765625, 0.038116455078125, 0.05035400390625, -0.039031982421875, -0.011810302734375, -0.0239410400390625, 0.007526397705078125, -0.0701904296875, -0.039031982421875, 0.0078887939453125, -0.037109375, 0.042205810546875, -0.041229248046875, -0.0023975372314453125, 0.01116943359375, -0.004871368408203125, -0.0027790069580078125, 0.0479736328125, 0.02667236328125, -0.021881103515625, 0.004627227783203125, 0.072021484375, -0.0015859603881835938, 0.01068115234375, -0.0119781494140625, 0.03985595703125, 0.025726318359375, 0.033843994140625, -0.035614013671875, -0.00957489013671875, 0.005863189697265625, 0.01273345947265625, -0.0091552734375, -0.02587890625, 0.028076171875, -0.0027980804443359375, 0.0303955078125, -0.040740966796875, 0.001888275146484375, -0.031280517578125, 0.0345458984375, -0.034637451171875, -0.06866455078125, 0.032318115234375, 0.045989990234375, 0.0200347900390625, -0.016998291015625, -0.01189422607421875, -0.0092315673828125, 0.0230865478515625, 0.00992584228515625, -0.006946563720703125, 0.0209503173828125, 0.03668212890625, -0.032623291015625, -0.015106201171875, 0.00417327880859375, 0.04315185546875, -0.034271240234375, 0.003719329833984375, -0.01213836669921875, -0.0199737548828125, -0.12890625, 0.01302337646484375, -0.006481170654296875, 0.021087646484375, 0.0240936279296875, 0.0217742919921875, 0.00902557373046875, -0.0235137939453125, -0.02410888671875, -0.00496673583984375, -0.0276336669921875, -0.05328369140625, -0.04986572265625, 0.07318115234375, -0.003536224365234375, 0.00994873046875, 0.0019426345825195312, 0.036346435546875, -0.0269927978515625, 0.0173187255859375, -0.06927490234375, 0.028167724609375, 0.0221710205078125, 0.032073974609375, 0.033782958984375, 0.0357666015625, 0.0267333984375, 0.031524658203125, 0.039031982421875, -0.00797271728515625, 0.01470947265625, -0.01131439208984375, -0.0165252685546875, 0.032073974609375, -0.00836181640625, -0.052154541015625, -0.0002942085266113281, -0.0194244384765625, 0.0017557144165039062, 0.039764404296875, -0.01763916015625, 0.02838134765625, -0.0146942138671875, 0.0037994384765625, 0.0716552734375, -0.00955963134765625, 0.1026611328125, -0.0276947021484375, 0.006198883056640625, -0.004058837890625, 0.0682373046875, -0.0506591796875, -0.006908416748046875, 0.012054443359375, 0.01432037353515625, 0.0246734619140625, 0.0408935546875, -0.0221710205078125, -0.0252227783203125, -0.023895263671875, 0.01068115234375, -0.0206298828125, -0.016265869140625, 0.007732391357421875, 0.021942138671875, -0.004772186279296875, 0.037445068359375, 0.0108795166015625, -0.0129241943359375, -0.00211334228515625, -0.0166778564453125, -0.03704833984375, 0.0195159912109375, 0.0261993408203125, 0.0095672607421875, -0.025115966796875, -0.034912109375, -0.069580078125, 0.0029144287109375, -0.0204315185546875, 0.09619140625, 0.058258056640625, 0.042694091796875, 0.027313232421875, -0.0014171600341796875, -0.027130126953125, 0.0249176025390625, 0.00878143310546875, 0.03179931640625, 0.06866455078125, 0.0214385986328125, 0.03509521484375, -0.044189453125, 0.04803466796875, 0.0191802978515625, 0.030426025390625, 0.0131072998046875, 0.033111572265625, 0.042449951171875, 0.030426025390625, -0.036590576171875, 0.0276336669921875, 0.051605224609375, -0.0255584716796875, 0.0152130126953125, -0.021453857421875, -0.0059814453125, -0.04095458984375, -0.057403564453125, -0.004810333251953125, 0.0167083740234375, 0.03607177734375, -0.036529541015625, -0.0869140625, -0.038177490234375, 0.035369873046875, -0.06927490234375, 0.00384521484375, 0.00991058349609375, -0.0161590576171875, 0.01146697998046875, -0.02850341796875, -0.053497314453125, 0.073974609375, -0.01519775390625, 0.0031528472900390625, 0.048431396484375, 0.04315185546875, -0.06817626953125, 0.018157958984375, -0.028228759765625, 0.006023406982421875, -0.011749267578125, 0.0073394775390625, 0.049407958984375, -0.02288818359375, 0.0206146240234375, 0.031890869140625, 0.0506591796875, 0.0048675537109375, -0.049468994140625, 0.03271484375, -0.006259918212890625, -0.0207061767578125, -0.013824462890625, 0.01047515869140625, -0.01250457763671875, -0.038360595703125, -0.00399017333984375, -0.0282135009765625, 0.0251312255859375, 0.01256561279296875, 0.0166778564453125, -0.03717041015625, -0.051971435546875, -0.0208740234375, 0.078125, 0.04150390625, 0.06341552734375, 0.0157623291015625, -0.058013916015625, 0.041595458984375, -0.046173095703125, -0.0102386474609375, -0.015655517578125, 0.01837158203125, -0.0234832763671875, 0.037109375, 0.00788116455078125, 0.00913238525390625, -0.0267791748046875, 0.01428985595703125, -0.0026111602783203125, -0.0125579833984375, -0.01268768310546875, 0.05902099609375, 0.0178070068359375, -0.068603515625, -0.044586181640625, -0.0235595703125, -0.01047515869140625, 0.03851318359375, -0.049407958984375, -0.023529052734375, -0.0061187744140625, -0.04803466796875, -0.022705078125, 0.0007653236389160156, -0.0113525390625, -0.0310516357421875, 0.01006317138671875, 0.0019245147705078125, -0.015167236328125, 0.020416259765625, 0.0270843505859375, 0.0208892822265625, 0.0255889892578125, -0.0009622573852539062, -0.0277099609375, 0.04241943359375, -0.022705078125, -0.04931640625, -0.005123138427734375, 0.00994110107421875, 0.00714874267578125, 0.009490966796875, -0.041748046875, -0.031341552734375, -0.013092041015625, -0.0239105224609375, -0.02166748046875, -0.00746917724609375, -0.00897979736328125, -0.047027587890625, -0.034454345703125, 0.0171966552734375, 0.052642822265625, 0.0081787109375, -0.01580810546875, 0.0521240234375, -0.036163330078125, 0.024169921875, -0.0146636962890625, -0.0018329620361328125, 0.03570556640625, -0.00949859619140625, 0.019378662109375, 0.006641387939453125, 0.016357421875, -0.040191650390625, 0.020904541015625, -0.06390380859375, -0.0005860328674316406, -0.0139617919921875, -0.022552490234375, -0.0017528533935546875, -0.042022705078125, -0.09033203125, 0.01436614990234375, 0.01097869873046875, -0.00302886962890625, 0.0162506103515625, -0.059417724609375, 0.0108184814453125, -0.041046142578125, -0.0033054351806640625, 0.03961181640625, -0.030792236328125, 0.01261138916015625, 0.004337310791015625, 0.005779266357421875, 0.0260467529296875, -0.0024738311767578125, 0.040283203125, -0.00725555419921875, 0.01023101806640625, -0.060394287109375, -0.01015472412109375, -0.0030364990234375, -0.0174560546875, 0.03955078125, -0.00986480712890625, 0.03399658203125, -0.01546478271484375, -0.01611328125, 0.0653076171875, 0.0284881591796875, 0.0084991455078125, -0.0282440185546875, 0.0131378173828125, -0.00405120849609375, 0.00711822509765625, 0.045928955078125, -0.0460205078125, -0.03692626953125, 0.0323486328125, 0.0411376953125, 0.0379638671875, 0.01092529296875, 0.0166168212890625, 0.034637451171875, -0.0055389404296875, 0.04931640625, 0.01500701904296875, -0.01910400390625, -0.044403076171875, 0.036285400390625, 0.034271240234375, 0.01470947265625, 0.01158905029296875, 0.033782958984375, 0.0256500244140625, -0.0008487701416015625, 0.004337310791015625, 0.0655517578125, 0.05816650390625, -0.0205230712890625, -0.04071044921875, -0.002262115478515625, 0.02178955078125, -0.028839111328125, -0.0496826171875, 0.033935546875, 0.023590087890625, -0.03802490234375, -0.0018529891967773438, -0.00409698486328125, -0.0017147064208984375, 0.033966064453125, 0.00878143310546875, 0.005008697509765625, 0.061065673828125, 0.014678955078125, -0.0248260498046875, -0.01007080078125, -0.03564453125, 0.0276336669921875, 0.0340576171875, 0.00537109375, -0.01361846923828125, 0.017120361328125, 0.0221405029296875, 0.02337646484375, -0.022552490234375, 0.033721923828125, 0.01519775390625, 0.0266265869140625, 0.050689697265625, 0.07086181640625, -0.020782470703125, -0.0291595458984375, -0.0260467529296875, 0.055267333984375, 0.011077880859375, 0.046356201171875, -0.0124664306640625, -0.00225067138671875, 0.0182647705078125, -0.045440673828125, -0.0104827880859375, 0.037353515625, 0.00983428955078125, -0.0203399658203125, -0.03070068359375, 0.01277923583984375, 0.0009694099426269531, 0.0244140625, 0.0013170242309570312, 0.00420379638671875, -0.025115966796875, 0.041656494140625, -0.040069580078125, -0.049102783203125, 0.0193939208984375, 0.00769805908203125, -0.0158538818359375, -0.042236328125, -0.036224365234375, 0.02838134765625, -0.01247406005859375, -0.06298828125, -0.03839111328125, 0.043243408203125, 0.002685546875, -0.04473876953125, 0.006023406982421875, 0.0103759765625, -0.01255035400390625, -0.001926422119140625, -0.0270843505859375, 0.007656097412109375, 0.0147552490234375, -0.05340576171875, 0.00743865966796875, 0.0201873779296875, 0.0037479400634765625, -0.01406097412109375, -0.0263214111328125, -0.033050537109375, -0.009918212890625, 0.01201629638671875, 0.0015974044799804688, -0.0177764892578125, -0.0338134765625, 0.0270233154296875, 0.0291595458984375, 0.02081298828125, -0.02471923828125, -0.01351165771484375, -0.047698974609375, -0.0174713134765625, 0.0186309814453125, 0.01355743408203125, -0.0660400390625, 0.0149688720703125, 0.06756591796875, -0.0518798828125, 0.008453369140625, -0.006710052490234375, 0.007061004638671875, 0.009735107421875, 0.0095367431640625, -0.01340484619140625, 0.0118865966796875, 0.0675048828125, 0.00583648681640625, -0.042266845703125, 0.0109710693359375, -0.0235595703125, 0.034088134765625, 0.00856781005859375, 0.01123046875, -0.024932861328125, 0.036956787109375, 0.0146484375, -0.01727294921875, 0.02252197265625, -0.075439453125, -0.0038204193115234375, 0.022613525390625, 0.0310516357421875, -0.009796142578125, 0.0275115966796875, 0.0032367706298828125, 0.00464630126953125, -0.02288818359375, -0.0078582763671875, 0.0115203857421875, 0.00980377197265625, -0.027557373046875, -0.031951904296875, 0.005161285400390625, -0.02899169921875, 0.00469970703125, -0.0260009765625, 0.032440185546875, 0.00732421875, -0.0057830810546875, 0.0253753662109375, 0.01934814453125, 0.01454925537109375, -0.003849029541015625, 0.023651123046875, -0.050750732421875, 0.0288848876953125, 0.003421783447265625, 0.005001068115234375, -0.002918243408203125, -0.0131072998046875, -0.00689697265625, 0.00846099853515625, 0.023590087890625, -0.038177490234375, 0.036895751953125, 0.03521728515625, -0.006404876708984375, -0.0101318359375, -0.0073394775390625, -0.0287933349609375, 0.056884765625, -0.0273895263671875, 0.04815673828125, -0.035369873046875, 0.0173187255859375, -0.08123779296875, 0.056732177734375, 0.0142669677734375, 0.041015625, 0.007061004638671875, -0.0158843994140625, -0.0428466796875, -0.038848876953125, -0.0222930908203125, 0.0167083740234375, -0.005878448486328125, 0.04742431640625, -0.002986907958984375, -0.0369873046875, -0.0071258544921875, -0.0148773193359375, 0.0071563720703125, 0.044281005859375, -0.003978729248046875, -0.03924560546875, 0.065673828125, -0.026763916015625, -0.006443023681640625, -0.01617431640625, 0.023956298828125, 0.01611328125, -0.007305145263671875, 0.0049285888671875, -0.0322265625, 0.047271728515625, 0.0279541015625, -0.0328369140625, 0.053436279296875, 0.0035419464111328125, -0.005466461181640625, 0.029296875, -0.007526397705078125, 0.01215362548828125, 0.0235595703125, -0.00698089599609375, -0.0194549560546875, -0.03472900390625, -0.08184814453125, 0.01094818115234375, -0.0357666015625, -0.028076171875, 0.01091766357421875, -0.003849029541015625, 0.0012111663818359375, -0.0230255126953125, 0.038726806640625, 0.01209259033203125, -0.0253143310546875, 0.0023746490478515625, 0.0107269287109375, -0.033477783203125, 0.046600341796875, -0.01018524169921875, -0.041229248046875, 0.023590087890625, -0.006443023681640625, -0.03021240234375, -0.00690460205078125, 0.0182647705078125, -0.0255279541015625, 0.031402587890625, -0.049285888671875, -0.03228759765625, 0.018035888671875, 0.03302001953125, 0.01442718505859375, -0.00943756103515625, 0.045501708984375, 0.00943756103515625, -0.02716064453125, 0.02313232421875, -0.033477783203125, -0.024688720703125, -0.0010519027709960938, -0.0001882314682006836, -0.006252288818359375, 0.00274658203125, 0.0189208984375, 0.0138702392578125, 0.0242462158203125, -0.02703857421875, -0.00652313232421875, 0.01947021484375, 0.01800537109375, 0.02447509765625, 0.031402587890625, 0.032958984375, 0.00433349609375, -0.016326904296875, -0.0036602020263671875, -0.08673095703125, 1.0371208190917969e-05, -0.02392578125, -0.058013916015625, 0.01343536376953125, 0.046783447265625, 0.057037353515625, 0.0391845703125, 0.02862548828125, 0.039306640625, 0.03790283203125, -0.0198211669921875, -0.03302001953125, -0.0333251953125, 0.0023975372314453125, -0.001354217529296875, 0.01171875, -0.0687255859375, 0.01800537109375, 0.058837890625, -0.0257415771484375, -0.039093017578125, 0.0239105224609375, 0.040802001953125, 0.07452392578125, 0.037384033203125, -0.0003647804260253906, -0.04986572265625, 0.00905609130859375, 0.0260162353515625, 0.0031261444091796875, -0.013916015625, 0.0022068023681640625, 0.01155853271484375, 0.050140380859375, -0.044036865234375, -0.00409698486328125, -0.026336669921875, 0.06170654296875, 0.004291534423828125, -0.062255859375, -0.0161285400390625, 0.0204620361328125, -0.002716064453125, -0.010650634765625, -0.00583648681640625, 0.043792724609375, -0.0313720703125, 0.01073455810546875, 0.013458251953125, 0.004241943359375, 0.07672119140625, 0.00567626953125, -0.004558563232421875, 0.0034503936767578125, 0.028167724609375, 0.019683837890625, -0.03948974609375, -0.036956787109375, -0.013092041015625, -0.040679931640625, 0.061126708984375, -0.0025424957275390625, 0.02239990234375, 0.0235595703125, -0.0296478271484375, 0.01482391357421875, 0.007625579833984375, 0.06378173828125, 0.01416778564453125, 0.02392578125, 0.0300140380859375, -0.0295257568359375, -0.0027408599853515625, 0.0184478759765625, 0.0022068023681640625, 0.005207061767578125, -0.0263824462890625, -0.0084381103515625, -0.05010986328125, 0.018341064453125, 0.0027141571044921875, -0.025970458984375, 0.0237274169921875, -0.00923919677734375, 0.0120697021484375, -0.027923583984375, -0.01342010498046875, 0.0114593505859375, 0.0171051025390625, -0.03692626953125, 0.020233154296875, 0.01442718505859375, 0.0029144287109375, -0.0211181640625, -0.08349609375, 0.038360595703125, 0.0194549560546875, 0.011993408203125, 0.0157012939453125, -0.0018634796142578125, 0.048248291015625, -0.01922607421875, -0.01483917236328125, 0.0090179443359375, 0.005252838134765625, 0.0204010009765625, 0.0186767578125, 0.01605224609375, -0.046661376953125, 0.00994873046875, 0.00725555419921875, -0.0394287109375, 0.0046234130859375, 0.055145263671875, 0.01800537109375, 0.036712646484375, 0.01456451416015625, -0.005901336669921875, -0.07562255859375, 0.041656494140625, 0.00646209716796875, -0.0235137939453125, -0.001873016357421875, -0.0172271728515625, 0.00569915771484375, -0.01117706298828125, 0.0628662109375, -0.0247802734375, 0.040557861328125, 0.00978851318359375, 0.039306640625, -0.01219940185546875, 0.00403594970703125, -0.015960693359375, 0.04034423828125, 0.0297393798828125, 0.051666259765625, 0.0110626220703125, -0.01528167724609375, -0.06805419921875, -0.001323699951171875, -0.0094146728515625, 0.0064544677734375, 0.027130126953125, -0.055908203125, 0.0017709732055664062, 0.036102294921875, 0.06512451171875, 0.00225830078125, -0.0026454925537109375, 0.05682373046875, 0.0126953125, -0.027923583984375, 0.00428009033203125, -0.036895751953125 ], "index": 0 } ], "model": "mistral-embed", "usage": { "prompt_tokens": 7, "total_tokens": 7, "completion_tokens": 0 } }


================================================
FILE: tests/Fixtures/mistral/embeddings-multiple-inputs-1.json
================================================
{ "id": "9220bf72cdcc488abf9adff9588b40c7", "object": "list", "data": [ { "object": "embedding", "embedding": [ -0.0309600830078125, 0.00644683837890625, 0.03839111328125, -0.0149383544921875, 0.0201263427734375, 0.00397491455078125, 0.057769775390625, -0.021728515625, -0.015869140625, -0.035736083984375, -0.031005859375, 0.02081298828125, -0.00814056396484375, 0.019622802734375, -0.07110595703125, 0.04217529296875, 0.018951416015625, 0.020477294921875, 0.02008056640625, 0.0291900634765625, -0.0157012939453125, -0.054473876953125, -0.044830322265625, 0.0139007568359375, -0.0206298828125, -0.00396728515625, 0.01097869873046875, -0.01153564453125, -0.035003662109375, -0.0245361328125, 0.02056884765625, -0.0220794677734375, 0.02935791015625, -0.00818634033203125, -0.00787353515625, -0.0216217041015625, 0.00894927978515625, -0.032012939453125, 0.0165863037109375, -0.0189056396484375, -0.047882080078125, 0.001956939697265625, -0.020843505859375, -0.00716400146484375, 0.003719329833984375, 0.0215911865234375, -0.018585205078125, -0.024139404296875, 0.0138397216796875, -0.00496673583984375, -0.0060272216796875, 0.032928466796875, 0.0121612548828125, -0.0126190185546875, -0.039459228515625, -0.01474761962890625, 0.0242767333984375, 0.009979248046875, -0.06353759765625, 0.035980224609375, -0.033782958984375, -0.019866943359375, -0.0017452239990234375, 0.03656005859375, -0.016265869140625, -0.03338623046875, 0.0243988037109375, -0.0316162109375, -0.03363037109375, 0.0027103424072265625, 0.026123046875, 0.010498046875, 0.0184173583984375, 0.0452880859375, -0.0258941650390625, -0.045257568359375, 0.0374755859375, -0.01183319091796875, 0.00925445556640625, 0.0167236328125, -0.04693603515625, -0.0152435302734375, 0.07611083984375, -0.0284576416015625, -0.0121917724609375, -0.01336669921875, 0.03387451171875, 0.007183074951171875, 0.055938720703125, 0.05377197265625, 0.038482666015625, 0.0092315673828125, 0.0259857177734375, -0.0225372314453125, 0.03179931640625, 0.0055084228515625, -0.048980712890625, -0.0238189697265625, -0.0029621124267578125, 0.0095062255859375, 0.04656982421875, -0.01229095458984375, 0.06658935546875, -0.04901123046875, 0.00597381591796875, 0.01401519775390625, -0.0138092041015625, -0.00658416748046875, -0.01383209228515625, -0.0294952392578125, -0.08465576171875, -0.0116424560546875, 0.0030803680419921875, -0.0511474609375, -0.0301513671875, -0.005733489990234375, -0.024444580078125, 0.04443359375, -0.033477783203125, 0.004669189453125, 0.041015625, 0.043975830078125, 0.0232391357421875, 0.00017130374908447266, -0.035980224609375, -0.02410888671875, 0.005924224853515625, 0.032073974609375, -0.0253143310546875, -0.01203155517578125, 0.0008401870727539062, -0.0279693603515625, 0.0002453327178955078, -0.016357421875, -0.03253173828125, -0.020172119140625, 0.00864410400390625, 0.0038547515869140625, 0.0014257431030273438, -0.0150604248046875, 0.02923583984375, -0.053619384765625, -0.06036376953125, -0.01241302490234375, -0.0139007568359375, 0.019622802734375, -0.01177978515625, 0.0003426074981689453, -0.02777099609375, 0.016448974609375, -0.01352691650390625, 0.024139404296875, 0.0268096923828125, 0.035064697265625, -0.03570556640625, -0.0265350341796875, -0.054718017578125, -0.03192138671875, -0.00185394287109375, -0.0187225341796875, -0.0225982666015625, 0.007633209228515625, -0.044097900390625, 0.03131103515625, -0.041778564453125, -0.039642333984375, -0.06317138671875, -0.021728515625, -0.0406494140625, 0.014678955078125, 0.07891845703125, -0.021514892578125, 0.03851318359375, 0.04376220703125, -0.01995849609375, 0.0325927734375, 0.0205535888671875, -0.032012939453125, 0.039825439453125, 0.038848876953125, -0.003101348876953125, -0.0203704833984375, 0.01303863525390625, -0.0166015625, 0.0201416015625, -0.005664825439453125, -0.01255035400390625, -0.016754150390625, 0.00937652587890625, 0.021514892578125, -0.00975799560546875, 9.256601333618164e-05, -0.0189208984375, 0.0076141357421875, -0.0347900390625, 0.031982421875, 0.053863525390625, 0.0020961761474609375, 0.006561279296875, -0.00725555419921875, -0.0017862319946289062, 0.0105438232421875, 0.0028018951416015625, 0.0701904296875, 0.04803466796875, 0.01824951171875, -0.013397216796875, 0.0044403076171875, 0.03460693359375, -0.006866455078125, 0.01363372802734375, -0.007080078125, -0.01611328125, -0.0537109375, -0.00786590576171875, -0.033203125, 0.034088134765625, -0.004230499267578125, 0.00951385498046875, -0.0088043212890625, -0.027099609375, -0.04461669921875, -0.01354217529296875, 0.04425048828125, -0.0311737060546875, 0.047271728515625, -0.00848388671875, -0.0188751220703125, -0.038482666015625, -0.0127716064453125, -0.007488250732421875, -0.01299285888671875, 0.0123291015625, 0.0399169921875, -0.0066375732421875, -0.025848388671875, 0.0231475830078125, 0.00913238525390625, 0.03326416015625, 0.019805908203125, -0.039642333984375, 0.0220794677734375, -0.01275634765625, 0.0634765625, 0.029571533203125, -0.0272369384765625, 0.0061492919921875, -0.013031005859375, 0.02392578125, 0.0445556640625, -0.0751953125, -0.0167388916015625, -0.04150390625, -0.00017964839935302734, -0.039642333984375, -0.0298004150390625, -0.00629425048828125, -0.06243896484375, 0.047576904296875, -0.0200653076171875, -0.020111083984375, -0.017120361328125, -0.01177215576171875, -0.042388916015625, 0.0175323486328125, 0.02520751953125, -0.035888671875, 0.0086669921875, 0.07525634765625, -0.038238525390625, -0.01194000244140625, -0.00908660888671875, 0.0309600830078125, 0.03173828125, 0.0236968994140625, -0.025726318359375, 0.02239990234375, 0.0016984939575195312, -0.031280517578125, 0.020843505859375, -0.0265045166015625, 0.0169219970703125, -0.03485107421875, 0.03271484375, -0.06549072265625, -0.023345947265625, 0.01491546630859375, 0.010772705078125, -0.015380859375, -0.06427001953125, -0.005840301513671875, 0.03973388671875, -0.01971435546875, 0.023345947265625, -0.0188140869140625, -0.0224151611328125, 0.039794921875, 0.02081298828125, -0.0167694091796875, 0.0255279541015625, 0.020843505859375, -0.05810546875, -0.0101470947265625, 0.0217132568359375, 0.0083770751953125, -0.0255126953125, -0.019012451171875, 0.0051727294921875, -0.009063720703125, -0.08990478515625, -0.03387451171875, 0.0036773681640625, 0.027587890625, 0.040802001953125, 0.00037384033203125, -0.0010099411010742188, -0.041168212890625, -0.0265350341796875, 0.033050537109375, -0.06988525390625, -0.051177978515625, 0.00984954833984375, 0.0484619140625, 0.00019443035125732422, 0.007732391357421875, -0.004451751708984375, 0.0099029541015625, -0.01335906982421875, -0.0364990234375, -0.00959014892578125, 0.01556396484375, -0.011627197265625, 0.02117919921875, 0.0158233642578125, 0.0211944580078125, 0.0251007080078125, 0.0219879150390625, 0.0223236083984375, -0.033447265625, -0.0007023811340332031, -0.02947998046875, -0.00258636474609375, -0.01271820068359375, 0.0011568069458007812, -0.070068359375, -0.0180511474609375, -0.02752685546875, -0.007190704345703125, 0.0224151611328125, 0.00431060791015625, 0.03253173828125, -0.01373291015625, -0.0232696533203125, 0.063720703125, -0.0355224609375, 0.0875244140625, -0.007579803466796875, -0.05413818359375, -0.0205535888671875, 0.0811767578125, -0.029449462890625, 0.004756927490234375, 0.047393798828125, 0.039764404296875, 0.0017747879028320312, 0.00968170166015625, -0.030242919921875, 0.028289794921875, -0.0219573974609375, -0.01071929931640625, 0.00433349609375, -0.01531219482421875, 0.0155029296875, 0.0146636962890625, 0.0037670135498046875, 0.025115966796875, 0.0162506103515625, -0.036529541015625, -0.005367279052734375, -0.004058837890625, -0.043731689453125, 0.031890869140625, 0.0380859375, 0.005100250244140625, 0.0251617431640625, -0.0288543701171875, -0.0693359375, 0.0266571044921875, -0.01325225830078125, 0.10870361328125, 0.04931640625, 0.0501708984375, 0.0193023681640625, 0.005748748779296875, -0.0018053054809570312, 0.0166778564453125, -0.00028705596923828125, 0.005764007568359375, 0.07568359375, 0.039764404296875, 0.026885986328125, -0.07159423828125, 0.04888916015625, -0.0006499290466308594, 0.053253173828125, -0.003566741943359375, 0.0057220458984375, 0.0215911865234375, 0.0168914794921875, -0.018768310546875, -0.004749298095703125, 0.020660400390625, -0.039825439453125, -0.0255126953125, 0.0243072509765625, 0.004390716552734375, -0.0305328369140625, -0.0227508544921875, -0.03875732421875, -0.033782958984375, -0.0200653076171875, -0.00795745849609375, -0.053131103515625, 0.0011434555053710938, 0.044677734375, -0.031890869140625, -0.007556915283203125, -0.00042629241943359375, -0.031829833984375, 0.0198974609375, -0.054290771484375, -0.05743408203125, 0.045318603515625, -0.007274627685546875, -0.057861328125, 0.0001920461654663086, 0.0255126953125, -0.050323486328125, 0.04046630859375, -0.0256195068359375, -0.034393310546875, -0.050811767578125, -0.021697998046875, 0.0142822265625, -0.00820159912109375, 0.04779052734375, 0.042938232421875, 0.0272369384765625, -0.0129852294921875, -0.040557861328125, -0.0249176025390625, -0.00490570068359375, -0.0098419189453125, 0.0008473396301269531, 0.0196533203125, -0.0087127685546875, -0.021728515625, 0.0015230178833007812, -0.02197265625, -0.017730712890625, 0.039794921875, 0.0213623046875, -0.0282135009765625, -0.075439453125, 0.01271820068359375, 0.04217529296875, 0.03643798828125, 0.03778076171875, 0.0027866363525390625, -0.043121337890625, 0.031982421875, 0.00577545166015625, 0.00530242919921875, 0.0311737060546875, 0.018035888671875, -0.0276031494140625, 0.0289154052734375, -0.02197265625, -0.015380859375, -0.01568603515625, 0.035186767578125, -0.00860595703125, 0.004238128662109375, -0.00847625732421875, 0.0762939453125, 0.040557861328125, -0.07763671875, -0.0550537109375, 0.007534027099609375, 0.039764404296875, 0.017425537109375, -0.048797607421875, -0.0180206298828125, -0.013092041015625, -0.017730712890625, -0.02069091796875, -0.01238250732421875, -0.032012939453125, -0.060028076171875, -0.0183868408203125, 0.0338134765625, -0.0149688720703125, 0.0196533203125, 0.033111572265625, 0.02001953125, 0.013153076171875, -0.01497650146484375, -0.0281982421875, 0.03204345703125, -0.05035400390625, 0.0001608133316040039, -0.0223388671875, 0.009552001953125, 0.001552581787109375, 0.020721435546875, -0.023529052734375, -0.0213470458984375, -0.03271484375, 0.01177978515625, 0.0093231201171875, 0.0181427001953125, -0.01053619384765625, -0.0377197265625, -0.00267791748046875, 0.0631103515625, 0.0259246826171875, -0.007049560546875, -0.005107879638671875, 0.00925445556640625, -0.035186767578125, 0.02008056640625, 0.0188751220703125, -0.0265655517578125, 0.0362548828125, 0.0091705322265625, -0.0145721435546875, -0.0032863616943359375, 0.0268096923828125, 0.0027523040771484375, -0.0231475830078125, -0.06451416015625, 0.027679443359375, -0.0220794677734375, -0.03521728515625, 0.00594329833984375, -0.018707275390625, -0.0660400390625, 0.001220703125, 0.0203857421875, -0.0010042190551757812, -0.022735595703125, -0.042877197265625, 0.053863525390625, -0.01953125, 0.0094146728515625, 0.005008697509765625, -0.000499725341796875, -0.0009098052978515625, 0.0290985107421875, -0.0097198486328125, 0.00431060791015625, -0.0269317626953125, 0.032958984375, -0.006988525390625, -0.01483917236328125, -0.03338623046875, 0.0243072509765625, -0.010406494140625, -0.019683837890625, 0.0179443359375, -0.05169677734375, 0.03558349609375, -0.038726806640625, 0.007293701171875, 0.06365966796875, 0.0413818359375, 0.0154876708984375, 0.0036602020263671875, 0.01522064208984375, -0.0255279541015625, 0.0009093284606933594, 0.056060791015625, -0.03955078125, -0.0361328125, 0.03668212890625, 0.01763916015625, 0.03778076171875, -0.0084075927734375, 0.00838470458984375, 0.0343017578125, -0.0186004638671875, 0.0299224853515625, -0.0188446044921875, 0.0081329345703125, -0.056610107421875, 0.045654296875, 0.01291656494140625, 0.026641845703125, -0.006084442138671875, 0.03857421875, 0.00921630859375, 0.0269622802734375, 0.0022258758544921875, 0.08868408203125, 0.01255035400390625, 0.004825592041015625, -0.03057861328125, -0.0010356903076171875, -0.0148162841796875, 0.006458282470703125, -0.024993896484375, 0.058837890625, 0.01336669921875, -0.029571533203125, -0.012939453125, -0.005321502685546875, 0.0125579833984375, -0.01422119140625, 0.0259552001953125, 0.00791168212890625, 0.06695556640625, -0.0208892822265625, -0.025604248046875, 0.007793426513671875, 0.02069091796875, -0.00762176513671875, 0.020111083984375, 0.01470184326171875, -0.0171051025390625, 0.0128631591796875, -0.038604736328125, 0.0222320556640625, 0.0224761962890625, 0.040740966796875, 0.032135009765625, 0.0250701904296875, 0.023895263671875, 0.054534912109375, -0.01490020751953125, -0.0038204193115234375, 0.034393310546875, 0.03271484375, 0.0275115966796875, 0.03240966796875, -0.0084991455078125, -0.007007598876953125, 0.016204833984375, -0.0009860992431640625, 0.01386260986328125, 0.043426513671875, 0.005706787109375, -0.00720977783203125, -0.007740020751953125, -0.00555419921875, -0.01120758056640625, 0.0250701904296875, 0.04534912109375, 0.0019741058349609375, 0.0206298828125, 0.0631103515625, -0.005252838134765625, -0.043853759765625, 0.006313323974609375, 0.0115509033203125, -0.041839599609375, -0.032867431640625, -0.064453125, 0.045074462890625, -0.0103759765625, -0.046478271484375, -0.05084228515625, 0.0230712890625, 0.0218505859375, -0.0226287841796875, 0.0200653076171875, -0.005764007568359375, 0.02056884765625, -0.0112152099609375, -0.058990478515625, -0.047454833984375, 0.0162200927734375, -0.04998779296875, -0.006877899169921875, -0.0157318115234375, 0.01435089111328125, 0.0162506103515625, 0.00579071044921875, -0.026885986328125, 0.0209503173828125, 0.040252685546875, 0.0296783447265625, 0.0188140869140625, -0.050506591796875, 0.071044921875, 0.032073974609375, 0.015289306640625, -0.035614013671875, 0.006122589111328125, -0.048065185546875, -0.01129913330078125, -0.00800323486328125, 0.00542449951171875, -0.0307464599609375, 0.0038051605224609375, 0.055877685546875, -0.080322265625, 0.031890869140625, 0.0008006095886230469, 0.01001739501953125, -0.01386260986328125, -0.01531219482421875, 0.0052032470703125, 0.0269317626953125, 0.081298828125, -0.0248260498046875, -0.00325775146484375, 0.03167724609375, -0.063232421875, 0.07073974609375, -0.04180908203125, 0.032073974609375, -0.038726806640625, 0.034454345703125, 0.020172119140625, -0.0145416259765625, 0.0053253173828125, -0.063232421875, -0.0161590576171875, -0.0123138427734375, -0.0301971435546875, -0.0183868408203125, 0.0226287841796875, 0.0282745361328125, -0.00884246826171875, -0.027618408203125, -0.004299163818359375, -0.0290985107421875, -0.00991058349609375, -0.039947509765625, 0.0201568603515625, -0.0086669921875, -0.02850341796875, -0.01381683349609375, 0.0399169921875, 0.0216217041015625, 0.0186920166015625, -0.05279541015625, 0.0136260986328125, 0.00302886962890625, 0.01094818115234375, 0.04693603515625, 0.011962890625, -0.036468505859375, 0.0302886962890625, -0.0194244384765625, 0.030914306640625, 0.0236968994140625, 0.004913330078125, -0.0205841064453125, 0.03717041015625, 0.01255035400390625, -0.01019287109375, 0.0657958984375, 0.0241546630859375, -0.0303802490234375, -0.06512451171875, -0.040283203125, -0.0174713134765625, 0.0226593017578125, -0.0145111083984375, 0.022979736328125, -0.0345458984375, 0.06500244140625, -0.08154296875, 0.046234130859375, -0.006267547607421875, 0.0287322998046875, -0.0025157928466796875, -0.00824737548828125, -0.06048583984375, -0.0560302734375, -0.03900146484375, 0.0198516845703125, -0.01389312744140625, 0.025970458984375, -0.0254058837890625, -0.01258087158203125, -0.006938934326171875, -0.0089111328125, 0.001079559326171875, 0.01506805419921875, -0.00858306884765625, -0.023529052734375, 0.042755126953125, -0.028289794921875, 0.01134490966796875, 0.0030956268310546875, -0.00611114501953125, 0.0017728805541992188, -0.01351165771484375, -0.0079498291015625, -0.043212890625, 0.0184173583984375, 0.016998291015625, -0.0226593017578125, 0.036102294921875, 0.0036792755126953125, 0.013885498046875, -0.00315093994140625, 0.0101165771484375, -0.018890380859375, 0.01776123046875, -0.00846099853515625, -0.0318603515625, -0.053009033203125, -0.0711669921875, -0.033721923828125, -0.045074462890625, -0.04595947265625, 0.0238494873046875, -0.02197265625, 0.037811279296875, 0.01099395751953125, 0.039947509765625, -0.01041412353515625, -0.03204345703125, -0.0296783447265625, 0.023406982421875, -0.021514892578125, 0.0343017578125, 0.0035076141357421875, -0.035552978515625, 0.0166473388671875, 0.0180816650390625, -0.0151824951171875, -0.016632080078125, 0.030792236328125, -0.01506805419921875, 0.018768310546875, 0.0125274658203125, -0.005252838134765625, -0.0010786056518554688, 0.01514434814453125, -0.0205078125, -0.044219970703125, 0.0252838134765625, -0.003192901611328125, -0.0310821533203125, 0.01500701904296875, -0.0233306884765625, -0.040924072265625, -0.01544189453125, 0.0198974609375, -0.014739990234375, 0.01629638671875, -0.00308990478515625, 0.029510498046875, 0.023529052734375, -0.01479339599609375, 0.004970550537109375, -0.02056884765625, -0.0086669921875, -0.0289154052734375, 0.046112060546875, 0.0308380126953125, 0.005481719970703125, -0.0316162109375, -0.00878143310546875, -0.06256103515625, 0.0232086181640625, -0.0465087890625, -0.091796875, -0.03961181640625, 0.07806396484375, 0.0205841064453125, 0.002964019775390625, 0.01444244384765625, 0.036590576171875, -0.00792694091796875, 0.02227783203125, 0.006984710693359375, -0.055511474609375, 0.01436614990234375, -0.020599365234375, 0.00890350341796875, -0.06597900390625, 0.0426025390625, 0.08868408203125, 0.0128326416015625, -0.02197265625, -0.0178680419921875, 0.0164337158203125, 0.060394287109375, 0.076171875, -0.0091705322265625, -0.0775146484375, 0.042236328125, 0.042388916015625, -0.01108551025390625, 0.021026611328125, -0.00634002685546875, 0.004116058349609375, 0.082763671875, -0.078857421875, -0.0013742446899414062, -0.02813720703125, 0.040771484375, -0.005275726318359375, -0.035003662109375, 0.01080322265625, 0.00957489013671875, 0.050750732421875, -0.0222015380859375, -0.00146484375, 0.02618408203125, -0.00795745849609375, -0.02532958984375, -0.0088043212890625, 0.0113677978515625, 0.08099365234375, 0.004138946533203125, -0.033660888671875, -0.01549530029296875, 0.0048370361328125, -0.0013513565063476562, -0.0157623291015625, -0.04150390625, 0.0023670196533203125, -0.07403564453125, 0.007205963134765625, 0.0287933349609375, 0.0152740478515625, 0.004749298095703125, 0.004482269287109375, -0.0191802978515625, -0.0022068023681640625, 0.056427001953125, 0.0595703125, -0.0267486572265625, -0.0022220611572265625, -0.0192718505859375, 0.01020050048828125, 0.00830078125, -0.0252685546875, 0.035125732421875, -0.039398193359375, 0.0208587646484375, 0.0115814208984375, 0.005641937255859375, 0.014678955078125, -0.0310821533203125, -0.00249481201171875, 0.0163726806640625, -0.015655517578125, 0.003963470458984375, -0.05230712890625, 0.04754638671875, 0.0268402099609375, -0.0281982421875, -0.00325775146484375, 0.023895263671875, 0.007762908935546875, 0.026031494140625, -0.037567138671875, 0.06195068359375, 0.046356201171875, 0.01384735107421875, -0.006931304931640625, 0.01067352294921875, 0.0180511474609375, -0.006572723388671875, 0.027984619140625, 0.01290130615234375, 0.0070343017578125, 0.0265655517578125, -0.006458282470703125, 0.034942626953125, -0.055755615234375, 0.026214599609375, 0.017333984375, -0.039581298828125, 0.024932861328125, -0.00018739700317382812, 0.0149383544921875, 0.0312347412109375, -0.0203094482421875, -0.040679931640625, -0.037994384765625, 0.060882568359375, 6.943941116333008e-05, -0.0479736328125, 0.00017702579498291016, -0.059356689453125, 0.0276031494140625, 0.0023403167724609375, 0.051513671875, -0.053955078125, -0.016693115234375, -0.01419830322265625, -0.041595458984375, 0.00801849365234375, -0.010467529296875, -0.016510009765625, 0.00897979736328125, 0.023681640625, 0.045623779296875, 0.05938720703125, 0.0172119140625, -0.06884765625, -0.0025730133056640625, 0.00630950927734375, 0.0017452239990234375, 0.0147857666015625, -0.016632080078125, 0.00909423828125, 0.0045623779296875, 0.0465087890625, 0.050140380859375, 0.003154754638671875, 0.060455322265625, -0.01132965087890625, -0.02362060546875, 0.0116424560546875, 0.022552490234375 ], "index": 0 }, { "object": "embedding", "embedding": [ -0.0230712890625, 0.0191192626953125, 0.0152130126953125, 0.0035419464111328125, 0.0306396484375, 0.0096435546875, 0.032623291015625, -0.047607421875, -0.025115966796875, -0.0433349609375, -0.0213470458984375, 0.0116119384765625, -0.0091705322265625, 0.0301971435546875, -0.034576416015625, 0.042999267578125, -0.005374908447265625, 0.024322509765625, 0.021942138671875, 0.02862548828125, -0.062347412109375, -0.00820159912109375, -0.048736572265625, 0.0062103271484375, -0.00626373291015625, 0.0204315185546875, -0.01531982421875, -0.0262451171875, -0.01904296875, -0.032135009765625, 0.0225830078125, 0.0024700164794921875, 0.00033593177795410156, -0.0135955810546875, 0.0128173828125, -0.0369873046875, -0.0003101825714111328, -0.0105438232421875, 0.040985107421875, 0.004901885986328125, 0.004711151123046875, 0.003154754638671875, 0.01172637939453125, 0.004154205322265625, -0.018646240234375, -0.0199737548828125, -0.0169677734375, -0.032867431640625, -0.029296875, -0.0309295654296875, -0.021240234375, 0.0582275390625, -0.01192474365234375, -0.01568603515625, -0.03204345703125, 0.038421630859375, 0.003215789794921875, -0.053314208984375, -0.06134033203125, 0.045684814453125, -0.0246429443359375, 0.02703857421875, -0.037261962890625, 0.02777099609375, -0.0008878707885742188, 0.0261383056640625, -0.01338958740234375, 0.01267242431640625, -0.00214385986328125, 0.0169677734375, 0.02008056640625, 0.0145416259765625, -0.004192352294921875, -0.00821685791015625, 0.0005288124084472656, -0.0242767333984375, -0.0131072998046875, 0.004497528076171875, 0.028289794921875, 0.0009379386901855469, -0.002155303955078125, -0.036224365234375, 0.0875244140625, -0.03765869140625, 0.004726409912109375, 0.0036773681640625, 0.050384521484375, 0.0005846023559570312, -0.01031494140625, -0.031005859375, 0.051544189453125, -0.040313720703125, -0.004573822021484375, -0.0260772705078125, 0.054473876953125, 0.04351806640625, -0.00974273681640625, 0.006725311279296875, 0.0125885009765625, 0.0213165283203125, 0.0709228515625, 0.0009546279907226562, 0.059783935546875, -0.006565093994140625, 0.0194091796875, -0.00872039794921875, -0.004558563232421875, 0.01042938232421875, -0.031585693359375, -0.0194854736328125, -0.11859130859375, -0.0009136199951171875, 0.010894775390625, -0.042510986328125, 0.0093994140625, 0.01432037353515625, -0.0093231201171875, 0.0215301513671875, -0.00921630859375, 0.0005068778991699219, 0.048370361328125, 0.0599365234375, 0.0041961669921875, -0.004192352294921875, -0.0188446044921875, -0.006145477294921875, -0.00931549072265625, 0.015655517578125, -0.0177764892578125, 0.01369476318359375, 0.01361846923828125, 0.005207061767578125, -0.0094146728515625, -0.01392364501953125, -0.02972412109375, -0.021331787109375, 0.038482666015625, 0.0271148681640625, -0.037139892578125, -0.0312042236328125, 0.02655029296875, -0.0265045166015625, -0.032196044921875, 0.033935546875, -0.0253143310546875, 0.0343017578125, -0.042236328125, 0.023193359375, 0.0009074211120605469, 0.020050048828125, 0.00699615478515625, 0.03692626953125, 0.04400634765625, -0.00860595703125, -0.03228759765625, -0.02752685546875, -0.052032470703125, -0.00527191162109375, 0.036376953125, 0.01129150390625, -0.026092529296875, 0.0126190185546875, -0.024139404296875, 0.05389404296875, 0.00323486328125, -0.05023193359375, -0.061004638671875, 0.0018453598022460938, 0.00524139404296875, 0.007053375244140625, 0.0225982666015625, -0.03369140625, 0.0306243896484375, 0.019256591796875, 0.022918701171875, 0.0086669921875, 0.00255584716796875, -0.010833740234375, 0.02886962890625, 0.010162353515625, -0.0027065277099609375, -0.02996826171875, 0.04901123046875, 0.018585205078125, 0.041900634765625, -0.0256805419921875, 0.044464111328125, -0.00553131103515625, -0.02203369140625, 0.048614501953125, -0.004150390625, -0.001995086669921875, -0.00366973876953125, 0.0202484130859375, -0.048431396484375, 0.04388427734375, 0.037506103515625, 0.01020050048828125, -0.0163116455078125, 0.0168304443359375, 0.023162841796875, 0.01219940185546875, 0.02972412109375, 0.08782958984375, 0.005840301513671875, 0.0198211669921875, -0.0279388427734375, 0.052093505859375, 0.00943756103515625, -0.007579803466796875, 0.01222991943359375, -0.011810302734375, -0.03216552734375, -0.018524169921875, -0.039215087890625, -0.0263824462890625, 0.018585205078125, 0.00868988037109375, -0.00836944580078125, 0.0178985595703125, -0.007434844970703125, -0.00433349609375, -0.0242156982421875, -0.003925323486328125, 0.00868988037109375, 0.057769775390625, 0.016021728515625, 0.01806640625, -0.047210693359375, -0.0162200927734375, -0.0005321502685546875, -0.008514404296875, -0.01049041748046875, 0.059478759765625, 0.0253448486328125, -0.0025959014892578125, 0.047393798828125, 0.0187530517578125, 0.030670166015625, 0.04473876953125, -0.022979736328125, 0.0305938720703125, -0.00814056396484375, 0.0615234375, 0.0180206298828125, -0.0186309814453125, 0.004627227783203125, 0.0266571044921875, -0.0169830322265625, 0.05694580078125, -0.046142578125, -0.0137176513671875, -0.0458984375, 0.0268707275390625, -0.0305023193359375, -0.035247802734375, -0.02777099609375, -0.00757598876953125, 0.06787109375, -0.0220947265625, -0.0012140274047851562, 0.0029964447021484375, 0.020416259765625, -0.039764404296875, 0.0213775634765625, 0.055877685546875, -0.048980712890625, 0.0177459716796875, 0.046051025390625, -0.036651611328125, -0.0209503173828125, -0.01380157470703125, 0.006134033203125, -0.00691986083984375, 0.0243072509765625, 0.019927978515625, 0.0248260498046875, 0.0005941390991210938, -0.0291595458984375, 0.0362548828125, -0.0084686279296875, -0.01006317138671875, -0.0238037109375, 0.023590087890625, -0.06390380859375, -0.0213775634765625, 0.0191192626953125, 0.00042247772216796875, -0.0552978515625, -0.06219482421875, -0.01995849609375, 0.01898193359375, 0.00437164306640625, 0.031524658203125, 0.0109100341796875, 0.03076171875, 0.051025390625, 0.025482177734375, 0.0162200927734375, 0.01715087890625, -0.0169830322265625, -0.029937744140625, -0.02020263671875, 0.0271453857421875, 0.01500701904296875, -0.023956298828125, -0.030181884765625, -0.0096435546875, -0.01922607421875, -0.06549072265625, -0.035614013671875, 0.00710296630859375, -0.01540374755859375, 0.033905029296875, -0.02886962890625, -0.013885498046875, -0.0201416015625, -0.0207977294921875, 0.006443023681640625, -0.03826904296875, -0.037750244140625, 0.007350921630859375, 0.039337158203125, -0.006664276123046875, -0.018768310546875, -0.01177215576171875, 0.003173828125, -0.061859130859375, 0.01168060302734375, -0.042572021484375, 0.0182952880859375, -0.0161590576171875, 0.020477294921875, 0.00901031494140625, 0.060211181640625, 0.03985595703125, 0.05291748046875, -0.00015223026275634766, -0.00611114501953125, 0.01153564453125, 0.007801055908203125, 0.0225982666015625, 0.03753662109375, 0.035552978515625, -0.04925537109375, -0.0163116455078125, -0.04119873046875, 0.047271728515625, -0.005367279052734375, 0.026824951171875, 0.0196685791015625, -0.0167999267578125, -0.0247802734375, 0.053924560546875, -0.006633758544921875, 0.07073974609375, 0.00014293193817138672, -0.047332763671875, -0.0098114013671875, 0.08465576171875, -0.020294189453125, 0.005634307861328125, 0.0305023193359375, 0.04534912109375, 0.042266845703125, -0.01052093505859375, -0.027984619140625, 0.039154052734375, -0.0738525390625, -0.010498046875, 0.030426025390625, 0.0592041015625, 0.0244598388671875, 0.0078582763671875, 0.0380859375, 0.032470703125, -0.007076263427734375, -0.0193328857421875, -0.0430908203125, 0.007904052734375, -0.035736083984375, 0.004608154296875, 0.031646728515625, 0.031219482421875, 0.0108642578125, -0.0335693359375, -0.061614990234375, -0.02337646484375, 0.0048828125, 0.09002685546875, 0.049896240234375, 0.033599853515625, -0.015899658203125, -0.0187530517578125, 0.0240020751953125, 0.0391845703125, -0.031524658203125, -0.006847381591796875, 0.0302276611328125, -0.0176849365234375, 0.004543304443359375, -0.049163818359375, 0.0184783935546875, -0.006359100341796875, 0.0303497314453125, 0.018218994140625, 0.033355712890625, 0.024017333984375, 0.036712646484375, -0.0226898193359375, 0.0118560791015625, -0.030303955078125, -0.0139617919921875, 0.031951904296875, 0.008514404296875, -0.0186614990234375, -0.023956298828125, -0.01824951171875, -0.00621795654296875, -0.03289794921875, 0.01678466796875, -0.0184783935546875, -0.056671142578125, 0.0078887939453125, 0.00815582275390625, -0.05242919921875, -0.0217437744140625, -0.01103973388671875, -0.00632476806640625, 0.033660888671875, 0.0017995834350585938, -0.07080078125, 0.0128631591796875, -0.018798828125, -0.0885009765625, -0.01102447509765625, -0.0204925537109375, -0.061492919921875, 0.035186767578125, -0.039031982421875, -0.043701171875, 0.0273895263671875, -0.021697998046875, 0.033050537109375, -0.01261138916015625, 0.0276031494140625, 0.0231475830078125, 0.04974365234375, 0.00334930419921875, -0.06622314453125, 0.00156402587890625, -0.04656982421875, -0.0026226043701171875, -0.00665283203125, 0.04229736328125, -0.004364013671875, -0.01062774658203125, -0.00917816162109375, -0.011993408203125, -0.04803466796875, 0.007190704345703125, -0.0240020751953125, -0.0250701904296875, -0.05859375, -0.002323150634765625, 0.0673828125, 0.0008220672607421875, 0.057525634765625, 0.041015625, -0.0252685546875, 0.004032135009765625, -0.02850341796875, -0.0017786026000976562, 0.006381988525390625, 0.035125732421875, -0.01070404052734375, 0.055206298828125, 0.006694793701171875, -0.0240936279296875, -0.003398895263671875, 0.042266845703125, 0.0128173828125, 0.01366424560546875, -0.006954193115234375, 0.05010986328125, 0.0196990966796875, -0.094482421875, -0.053466796875, 0.00927734375, -0.00861358642578125, 0.030426025390625, -0.01464080810546875, 0.005340576171875, -0.02154541015625, -0.00018548965454101562, -0.02374267578125, -0.004093170166015625, -0.03399658203125, -0.00879669189453125, -0.0261688232421875, -4.863739013671875e-05, -0.0068206787109375, 0.041168212890625, 0.0300140380859375, 0.030975341796875, 2.4318695068359375e-05, -0.0345458984375, -0.01751708984375, 0.0254364013671875, -0.051422119140625, -0.02618408203125, -0.005825042724609375, 0.03375244140625, -0.01435089111328125, -0.01259613037109375, -0.0232696533203125, -0.02850341796875, -0.0322265625, -0.0001596212387084961, -0.01120758056640625, 0.0297393798828125, -0.01381683349609375, -0.027557373046875, 0.0010385513305664062, 0.027862548828125, 0.0093994140625, 0.00042939186096191406, 0.0251007080078125, 0.0201416015625, -0.0163116455078125, 0.03778076171875, 0.0377197265625, -0.01459503173828125, 0.0164794921875, 0.0085296630859375, -0.00896453857421875, -0.017913818359375, 0.045135498046875, -0.00696563720703125, -0.019256591796875, -0.0880126953125, 0.028106689453125, -0.01540374755859375, -0.0149078369140625, -0.0005121231079101562, -0.030914306640625, -0.06390380859375, -0.00704193115234375, 0.044830322265625, 0.007282257080078125, -0.01390838623046875, -0.0227203369140625, 0.005962371826171875, -0.0185546875, -0.010650634765625, 0.02923583984375, -0.0260467529296875, 0.00980377197265625, 0.010345458984375, 0.0014333724975585938, 0.02301025390625, -0.0219573974609375, 0.0428466796875, -0.0055084228515625, 0.018646240234375, 0.01297760009765625, 0.01126861572265625, 0.0261688232421875, -0.032440185546875, -0.0140533447265625, -0.046875, 0.07708740234375, -0.049163818359375, 0.01751708984375, -0.0082550048828125, 0.017486572265625, -0.023712158203125, -0.003856658935546875, 0.0032558441162109375, 0.0179595947265625, 0.012939453125, 0.06524658203125, -0.07476806640625, -0.00827789306640625, 0.0301513671875, 0.0130615234375, 0.0167236328125, 0.0018968582153320312, -0.02154541015625, -0.011383056640625, 0.036224365234375, 0.00653076171875, -0.003551483154296875, -0.01227569580078125, -0.06524658203125, 0.005550384521484375, -0.00789642333984375, 0.0465087890625, 0.0228271484375, 0.0738525390625, -0.0254669189453125, -0.021514892578125, 0.0037078857421875, 0.0994873046875, 0.0222930908203125, -0.006809234619140625, -0.02044677734375, -0.0237274169921875, 0.015899658203125, -0.01202392578125, -0.038482666015625, 0.0650634765625, 0.0201873779296875, -0.00905609130859375, -0.032440185546875, -0.01213836669921875, 0.032470703125, 0.019378662109375, 0.032867431640625, -0.017242431640625, 0.07720947265625, -0.01059722900390625, -0.01202392578125, 0.01107025146484375, -0.001811981201171875, 0.0026836395263671875, 0.05462646484375, -0.0013895034790039062, 0.0139007568359375, -0.0269012451171875, -0.0271148681640625, 0.0164337158203125, 0.01361846923828125, 0.030548095703125, 0.027862548828125, 0.02227783203125, 0.0212860107421875, 0.04425048828125, 0.032745361328125, 0.0185394287109375, -0.02764892578125, 0.0310516357421875, 0.041656494140625, 0.0045928955078125, -0.033111572265625, -0.01294708251953125, 0.02935791015625, 0.0242156982421875, 0.0177764892578125, -0.01132965087890625, 0.00859832763671875, -0.01085662841796875, -0.0174560546875, 0.0203857421875, -0.0179290771484375, 0.019683837890625, 0.01500701904296875, 0.005157470703125, 0.0328369140625, 0.07867431640625, -0.046142578125, -0.0242919921875, 0.0245208740234375, 0.0309295654296875, -0.038543701171875, -0.04107666015625, -0.0386962890625, 0.057647705078125, -0.0078125, -0.052276611328125, -0.04571533203125, 0.044708251953125, -0.0166473388671875, -0.04608154296875, -0.0026760101318359375, -0.019134521484375, -0.014556884765625, -0.0181732177734375, -0.049041748046875, -0.0028362274169921875, -0.0181732177734375, -0.046966552734375, -0.004302978515625, 0.031341552734375, -0.008636474609375, -0.034423828125, 0.0132293701171875, -0.01027679443359375, 0.01064300537109375, -0.021453857421875, 0.04010009765625, 0.0026683807373046875, -0.0037994384765625, 0.0390625, 0.0460205078125, -0.0098876953125, -0.045867919921875, -0.0098419189453125, -0.047119140625, 0.006809234619140625, -0.0003540515899658203, 0.0178985595703125, -0.018463134765625, 0.0223236083984375, 0.037994384765625, -0.07257080078125, 0.047210693359375, -0.035736083984375, 0.01457977294921875, 0.0034465789794921875, -0.05657958984375, -0.05535888671875, -0.0008482933044433594, 0.044586181640625, 0.004436492919921875, -0.0229644775390625, 0.00550079345703125, -0.046661376953125, 0.062103271484375, -0.024169921875, 0.0014181137084960938, -0.058990478515625, 0.01093292236328125, -0.002368927001953125, -0.028289794921875, -0.006561279296875, -0.034912109375, 0.0012416839599609375, 0.0191802978515625, 0.021759033203125, -0.0191497802734375, -0.014678955078125, 0.04736328125, -0.0163726806640625, -0.02703857421875, -0.0007605552673339844, -0.020111083984375, -0.0029735565185546875, -0.0806884765625, 0.02740478515625, -0.037109375, -0.032073974609375, -0.0177001953125, -0.0097808837890625, 0.024932861328125, 0.003543853759765625, -0.025848388671875, 0.038238525390625, 0.04852294921875, 0.033660888671875, 0.0034770965576171875, 0.0423583984375, -0.04656982421875, 0.028472900390625, -0.0294189453125, 0.037689208984375, 0.060150146484375, -0.00982666015625, 0.00640106201171875, 0.017913818359375, 0.00661468505859375, 0.0182647705078125, 0.02020263671875, 0.04315185546875, -0.009490966796875, -0.050201416015625, -0.0207672119140625, -0.032989501953125, 0.0303955078125, 0.0024242401123046875, 0.016021728515625, -0.01531982421875, 0.00983428955078125, -0.064453125, 0.044281005859375, -0.033966064453125, -0.0016326904296875, -0.020355224609375, 0.005523681640625, -0.038726806640625, -0.042205810546875, -0.02960205078125, -0.0091094970703125, -0.08160400390625, 0.00852203369140625, 0.0008754730224609375, -0.0256500244140625, 0.0033779144287109375, 0.0038280487060546875, 0.01445770263671875, 0.038116455078125, 0.0148468017578125, -0.0328369140625, 0.034393310546875, -0.0355224609375, 0.003383636474609375, 0.0009937286376953125, -0.00933837890625, 0.016876220703125, -0.0204010009765625, -0.0178985595703125, -0.043487548828125, 0.0274810791015625, 0.04180908203125, -0.030792236328125, 0.02777099609375, -0.0350341796875, 0.0202484130859375, -0.0165252685546875, -0.05078125, -0.00197601318359375, 0.05511474609375, -0.018310546875, -0.0227508544921875, -0.033599853515625, -0.047698974609375, -0.05511474609375, -0.0401611328125, -0.068359375, -0.023590087890625, -0.0214691162109375, 0.026214599609375, 0.00257110595703125, 0.033599853515625, 0.01204681396484375, -0.0294952392578125, -0.036224365234375, 0.0174407958984375, -0.0203857421875, 0.0214691162109375, 0.0142059326171875, -0.07012939453125, 0.003101348876953125, -0.02069091796875, -0.01483154296875, 0.01435089111328125, 0.042755126953125, -0.00664520263671875, 0.02935791015625, -0.01381683349609375, -0.04180908203125, -0.04974365234375, 0.0177001953125, -0.021942138671875, -0.0199432373046875, 0.016937255859375, -0.01202392578125, -0.004863739013671875, 0.0227508544921875, 0.01294708251953125, -0.00826263427734375, -0.002529144287109375, -0.0009851455688476562, 0.00724029541015625, 0.0257110595703125, 0.036224365234375, -0.02679443359375, 0.00432586669921875, 0.01529693603515625, -0.0024280548095703125, 0.0041351318359375, 0.0092926025390625, 0.00057220458984375, 0.03643798828125, 0.0343017578125, -0.007503509521484375, -0.0310516357421875, -0.040374755859375, -0.046844482421875, 0.01290130615234375, -0.031951904296875, -0.052032470703125, -0.00589752197265625, 0.035919189453125, 0.01390838623046875, -0.0005044937133789062, 0.036651611328125, 0.045928955078125, 0.024993896484375, -0.010101318359375, -0.0185089111328125, -0.05194091796875, 0.00881195068359375, 0.006381988525390625, -0.0017976760864257812, -0.0748291015625, 0.0631103515625, 0.05029296875, -0.01049041748046875, -0.054962158203125, -0.003162384033203125, 0.0284576416015625, 0.07122802734375, 0.08538818359375, -0.0005178451538085938, -0.0718994140625, 0.055450439453125, 0.002727508544921875, 0.0199737548828125, -0.01287841796875, -0.01468658447265625, 0.0035114288330078125, 0.02032470703125, -0.04632568359375, 0.01158905029296875, -0.056182861328125, 0.0550537109375, 0.0029144287109375, -0.02587890625, 0.01554107666015625, 0.05963134765625, 0.0087890625, -0.00476837158203125, -0.01125335693359375, 0.03656005859375, -0.0274810791015625, -0.030670166015625, 0.025054931640625, -0.0163116455078125, 0.064208984375, -0.0181121826171875, 0.00193023681640625, 0.023101806640625, 0.023529052734375, -0.0296173095703125, -0.02764892578125, -0.018768310546875, -0.0012826919555664062, -0.05218505859375, 0.0161285400390625, 0.0408935546875, 0.00989532470703125, 0.004955291748046875, 0.02764892578125, -0.0302581787109375, -0.042327880859375, 0.04022216796875, 0.0408935546875, -0.015899658203125, -0.009857177734375, -0.039581298828125, 0.0144195556640625, 0.0158843994140625, -0.0011568069458007812, 0.006740570068359375, -0.059478759765625, 0.01525115966796875, -0.06719970703125, 0.017791748046875, 0.0002219676971435547, -0.08538818359375, -0.04132080078125, -0.02777099609375, 0.0024356842041015625, 0.002964019775390625, 0.0007758140563964844, 0.040283203125, 0.002063751220703125, -0.0445556640625, -0.004009246826171875, 0.0210113525390625, 0.0157318115234375, 0.002544403076171875, -0.07330322265625, 0.0325927734375, 0.0633544921875, 0.0574951171875, -0.00732421875, 0.01404571533203125, -0.0228729248046875, 0.0273590087890625, -0.0205841064453125, -0.0137176513671875, 0.01727294921875, -0.0038547515869140625, 0.00374603271484375, 0.040252685546875, -0.01248931884765625, 0.02960205078125, -0.005756378173828125, -0.025604248046875, 0.014007568359375, 0.060516357421875, 0.0197296142578125, -0.03363037109375, 0.016754150390625, -0.0171051025390625, -0.0701904296875, 0.0252685546875, -0.00864410400390625, -0.02008056640625, 0.030548095703125, -0.033050537109375, 0.046051025390625, 0.0008177757263183594, 0.0399169921875, -0.02349853515625, 0.0174560546875, 0.016326904296875, 0.0309295654296875, 0.0189666748046875, -0.0098876953125, -0.0241546630859375, 0.0523681640625, -0.00940704345703125, 0.0101318359375, 0.0394287109375, -0.005168914794921875, -0.062255859375, -0.0238494873046875, 0.034027099609375, -0.00460052490234375, 0.01983642578125, -0.0037937164306640625, -0.049530029296875, 0.0292816162109375, 0.023956298828125, 0.06341552734375, -0.027862548828125, 0.05389404296875, 0.042694091796875, -0.0305633544921875, 0.0228424072265625, -0.0194854736328125 ], "index": 1 } ], "model": "mistral-embed", "usage": { "prompt_tokens": 15, "total_tokens": 15, "completion_tokens": 0 } }


================================================
FILE: tests/Fixtures/mistral/generate-text-with-a-prompt-1.json
================================================
{
  "id": "8f82539654874b73a8b8dd1330c80221",
  "object": "chat.completion",
  "created": 1728460792,
  "model": "mistral-small-2402",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am a Large Language Model trained by Mistral AI.",
        "tool_calls": null
      },
      "finish_reason": "stop",
      "logprobs": null
    }
  ],
  "usage": {
    "prompt_tokens": 7,
    "total_tokens": 19,
    "completion_tokens": 12
  }
}



================================================
FILE: tests/Fixtures/mistral/generate-text-with-multiple-tools-1.json
================================================
{
  "id": "b761ad55fe0145d3a5e478a080930232",
  "object": "chat.completion",
  "created": 1728462827,
  "model": "mistral-large-latest",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "",
        "tool_calls": [
          {
            "id": "hd1jUE8h9",
            "type": "function",
            "function": {
              "name": "search",
              "arguments": "{\"query\": \"Detroit Tigers game time today\"}"
            }
          },
          {
            "id": "3GLgh8afr",
            "type": "function",
            "function": {
              "name": "weather",
              "arguments": "{\"city\": \"Detroit\"}"
            }
          }
        ]
      },
      "finish_reason": "tool_calls"
    }
  ],
  "usage": {
    "prompt_tokens": 167,
    "total_tokens": 210,
    "completion_tokens": 43
  }
}



================================================
FILE: tests/Fixtures/mistral/generate-text-with-multiple-tools-2.json
================================================
{
  "id": "34274d5a669a432bace0db9c3b359ba7",
  "object": "chat.completion",
  "created": 1728462827,
  "model": "mistral-large-latest",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The tigers game is at 3pm in Detroit. The weather will be 75° and sunny. You should not wear a coat"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 302,
    "total_tokens": 333,
    "completion_tokens": 31
  }
}



================================================
FILE: tests/Fixtures/mistral/generate-text-with-reasoning-model-1.json
================================================
{"id":"53ab90efbbf547e983998d180a4f8356","created":1761063278,"model":"magistral-medium-latest","usage":{"prompt_tokens":10,"total_tokens":55,"completion_tokens":45},"object":"chat.completion","choices":[{"index":0,"finish_reason":"stop","message":{"role":"assistant","tool_calls":null,"content":[{"type":"thinking","thinking":[{"type":"text","text":"Okay, the user asked about the capital of France. I know that the capital of France is Paris. But just to be sure, I should confirm this with my knowledge."}]},{"type":"text","text":"The capital of France is Paris."}]}}]}


================================================
FILE: tests/Fixtures/mistral/generate-text-with-required-tool-call-1.json
================================================
{"id":"084ccfaa851d46009f35ba68b35e2b1a","object":"chat.completion","created":1730555775,"model":"mistral-large-latest","choices":[{"index":0,"message":{"role":"assistant","content":"","tool_calls":[{"id":"j7gCUl3iJ","type":"function","function":{"name":"weather","arguments":"{\"city\": \"New York\"}"}}]},"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":158,"total_tokens":180,"completion_tokens":22}}


================================================
FILE: tests/Fixtures/mistral/generate-text-with-system-prompt-1.json
================================================
{
  "id": "1086e1021d5b481ba36e9c842f69827d",
  "object": "chat.completion",
  "created": 1728461909,
  "model": "mistral-small-2402",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am Nyx, a being of cosmic terror and ancient deities, inspired by the Cthulhu mythos. I am a creature of the deep, shrouded in mystery and fear, existing beyond the realms of human understanding.",
        "tool_calls": null
      },
      "finish_reason": "stop",
      "logprobs": null
    }
  ],
  "usage": {
    "prompt_tokens": 32,
    "total_tokens": 83,
    "completion_tokens": 51
  }
}



================================================
FILE: tests/Fixtures/mistral/image-detection-1.json
================================================
{"id":"b9084ee2397f4483817573120c50753b","object":"chat.completion","created":1729801129,"model":"pixtral-12b-2409","choices":[{"index":0,"message":{"role":"assistant","content":"The image displays a line drawing of a faceted gemstone, specifically resembling a diamond. The gemstone is depicted with a classic brilliant-cut design, featuring numerous triangular facets that meet at sharp points. The drawing is in black and white, with the gemstone outlined in thick, bold black lines against a white background. The shape is symmetrical and intricately detailed, emphasizing the clarity and sparkle typically associated with diamonds.","tool_calls":null},"finish_reason":"stop"}],"usage":{"prompt_tokens":2557,"total_tokens":2642,"completion_tokens":85}}


================================================
FILE: tests/Fixtures/mistral/ocr-response-1.json
================================================
{
  "pages": [
    {
      "index": 0,
      "markdown": "# Text Generation \n\nPrism provides a powerful interface for generating text using Large Language Models (LLMs). This guide covers everything from basic usage to advanced features like multimodal interactions and response handling.\n\n## Basic Text Generation\n\nAt its simplest, you can generate text with just a few lines of code:\n\n```\n    use Prism\\Prism\\Prism;\n    use Prism\\Prism\\Enums\\Provider;\n    $response = Prism::text()\n        ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n        ->withPrompt('Tell me a short story about a brave knight.')\n        ->asText();\n    echo $response->text;\n```\n\n\n## System Prompts and Context\n\nSystem prompts help set the behavior and context for the AI. They're particularly useful for maintaining consistent responses or giving the LLM a persona:\n\n```\nphp\nuse Prism\\Prism\\Prism;\nuse Prism\\Prism\\Enums\\Provider;\n$response = Prism::text()\n    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n```",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    },
    {
      "index": 1,
      "markdown": "```\n    ->withSystemPrompt('You are an expert mathematician who explains concepts s\n    ->withPrompt('Explain the Pythagorean theorem.')\n    ->asText();\n```\n\nYou can also use Laravel views for complex system prompts:\n\n```\n    use Prism\\Prism\\Prism;\n    use Prism\\Prism\\Enums\\Provider;\n    $response = Prism::text()\n    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n    ->withSystemPrompt(view('prompts.math-tutor'))\n    ->withPrompt('What is calculus?')\n    ->asText();\n```\n\nYou an also pass a View to the withPrompt method.\n\n# Message Chains and Conversations \n\nFor interactive conversations, use message chains to maintain context:\n\n```\n    use Prism\\Prism\\Prism;\n    use Prism\\Prism\\Enums\\Provider;\n    use Prism\\Prism\\ValueObjects\\Messages\\UserMessage;\n    use Prism\\Prism\\ValueObjects\\Messages\\AssistantMessage;\n    $response = Prism::text()\n    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n    ->withMessages( [\n        new UserMessage('What is JSON?'),\n        new AssistantMessage('JSON is a lightweight data format...'),\n        new UserMessage('Can you show me an example?')\n    ])\n    ->asText();\n```\n\n\n## Message Types\n\n- SystemMessage",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    },
    {
      "index": 2,
      "markdown": "- UserMessage\n- AssistantMessage\n- ToolResultMessage\n\nNOTE\nSome providers, like Anthropic, do not support the SystemMessage type. In those cases we convert SystemMessage to UserMessage.\n\n# Generation Parameters \n\nFine-tune your generations with various parameters:\nwithMaxTokens\nMaximum number of tokens to generate.\nusingTemperature\nTemperature setting.\nThe value is passed through to the provider. The range depends on the provider and model. For most providers, 0 means almost deterministic results, and higher values mean more randomness.\n\nTIP\nIt is recommended to set either temperature or topP, but not both.\nusingTopP\nNucleus sampling.\nThe value is passed through to the provider. The range depends on the provider and model. For most providers, nucleus sampling is a number between 0 and 1. E.g. 0.1 would mean that only tokens with the top $10 \\%$ probability mass are considered.\n\nTIP\nIt is recommended to set either temperature or topP, but not both.",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    },
    {
      "index": 3,
      "markdown": "```\nwithClientOptions\n```\n\nUnder the hood we use L aravel's HTTP client. You can use this method to pass any of Guzzles request options e.g. ->withClientOptions(['timeout' => 30]) .\nwithClientRetry\n\nUnder the hood we use L aravel's HTTP client. You can use this method to set retries e.g. ->withClientRetry(3, 100) .\nusingProviderConfig\n\nThis allows for complete or partial override of the providers configuration. This is great for multi-tenant applications where users supply their own API keys. These values are merged with the original configuration allowing for partial or complete config override.\n\n# Response Handling \n\nThe response object provides rich access to the generation results:\n\n```\nuse Prism\\Prism\\Prism;\nuse Prism\\Prism\\Enums\\Provider;\n$response = Prism::text()\n    ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n    ->withPrompt('Explain quantum computing.')\n    ->asText();\n    // Access the generated text\n    echo $response->text;\n    // Check why the generation stopped\n    echo $response->finishReason->name;\n    // Get token usage statistics\n    echo \"Prompt tokens: {$response->usage->promptTokens}\";\n    echo \"Completion tokens: {$response->usage->completionTokens}\";\n    // For multi-step generations, examine each step\n    foreach ($response->steps as $step) {\n        echo \"Step text: {$step->text}\";",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    },
    {
      "index": 4,
      "markdown": "```\n        echo \"Step tokens: {$step->usage->completionTokens}\";\n    }\n    // Access message history\n    foreach ($response->responseMessages as $message) {\n        if ($message instanceof AssistantMessage) {\n            echo $message->content;\n        }\n    }\n```\n\n\n# Finish Reasons \n\nFinishReason: :Stop;\nFinishReason: : Length;\nFinishReason: : ContentFilter;\nFinishReason: : ToolCalls;\nFinishReason: :Error;\nFinishReason: :Other;\nFinishReason: :Unknown;\n\n## Error Handling\n\nRemember to handle potential errors in your generations:\n\n```\nphp\nuse Prism\\Prism\\Prism;\nuse Prism\\Prism\\Enums\\Provider;\nuse Prism\\Prism\\Exceptions\\PrismException;\nuse Throwable;\ntry {\n    $response = Prism::text()\n        ->using(Provider::Anthropic, 'claude-3-5-sonnet-20241022')\n        ->withPrompt('Generate text...')\n        ->asText();\n    } catch (PrismException $e) {\n    Log::error('Text generation failed:', ['error' => $e->getMessage()]);\n    } catch (Throwable $e) {\n    Log::error('Generic error:', ['error' => $e->getMessage()]);\n```",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    },
    {
      "index": 5,
      "markdown": "Previous page\nConfiguration\nNext page\nStreaming Ouput",
      "images": [],
      "dimensions": {
        "dpi": 200,
        "height": 2200,
        "width": 1700
      }
    }
  ],
  "model": "mistral-ocr-2503-completion",
  "usage_info": {
    "pages_processed": 6,
    "doc_size_bytes": 306115
  }
}


================================================
FILE: tests/Fixtures/mistral/speech-to-text-basic-1.json
================================================
{
  "text": "Hello, this is a test transcription."
}



================================================
FILE: tests/Fixtures/mistral/speech-to-text-complex-1.json
================================================
{
  "text": "Complex transcription with metadata.",
  "language": "en",
  "duration": 5.2,
  "segments": [
    {
      "text": "Complex transcription",
      "start": 0.0,
      "end": 2.1
    },
    {
      "text": "with metadata.",
      "start": 2.1,
      "end": 5.2
    }
  ],
  "usage": {
    "prompt_tokens": 3,
    "completion_tokens": 7,
    "total_tokens": 10
  }
}



================================================
FILE: tests/Fixtures/mistral/speech-to-text-simple-1.json
================================================
{
  "text": "Simple transcription without usage data."
}



================================================
FILE: tests/Fixtures/mistral/speech-to-text-usage-1.json
================================================
{
  "text": "This is a sample transcription with usage data.",
  "usage": {
    "prompt_tokens": 5,
    "completion_tokens": 8,
    "total_tokens": 13
  }
}



================================================
FILE: tests/Fixtures/mistral/speech-to-text-verbose-1.json
================================================
{
  "text": "The quick brown fox jumps over the lazy dog.",
  "language": "en",
  "duration": 3.84,
  "segments": [
    {
      "text": "The quick brown fox",
      "start": 0.0,
      "end": 1.5
    },
    {
      "text": "jumps over the lazy dog.",
      "start": 1.5,
      "end": 3.84
    }
  ],
  "usage": {
    "prompt_tokens": 0,
    "completion_tokens": 12,
    "total_tokens": 12
  }
}



================================================
FILE: tests/Fixtures/mistral/stream-basic-text-1-1.sse
================================================
data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"I"},"finish_reason":null}],"p":"abcdefghijklmnopqrs"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"'m"},"finish_reason":null}],"p":"abcdefghijklmn"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" a"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz012"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" large"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz012"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" language"},"finish_reason":null}],"p":"abcdefghijklm"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" model"},"finish_reason":null}],"p":"abcde"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" created"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz01234567"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" by"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" Mist"},"finish_reason":null}],"p":"abcdefg"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"ral"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0123456"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" AI"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz"}

data: {"id":"2a747f6623d9422f8545021729177ba5","object":"chat.completion.chunk","created":1759185597,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":""},"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"total_tokens":20,"completion_tokens":13},"p":"abcdefghijklmnopq"}

data: [DONE]




================================================
FILE: tests/Fixtures/mistral/stream-basic-text-1.sse
================================================
data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"I"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" am"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" a"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" text"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"-based"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" AI"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" model"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" developed"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" by"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" Mist"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"ral"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" AI"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" team"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" I"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"'m"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" here"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" to"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" assist"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":","},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" answer"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" questions"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":","},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" provide"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" explanations"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":","},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" or"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" just"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" chat"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" on"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" a"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" wide"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" range"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" of"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" topics"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" to"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" best"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" of"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" my"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" ability"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" How"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" about"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"?"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" Feel"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" free"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" to"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" share"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" a"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" bit"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" about"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" yourself"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" if"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" you"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"'d"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":" like"},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null,"logprobs":null}]}

data: {"id":"14c0043d98d24d1a827dfadeb76812c3","object":"chat.completion.chunk","created":1745698458,"model":"mistral-small-latest","choices":[{"index":0,"delta":{"content":""},"finish_reason":"stop","logprobs":null}],"usage":{"prompt_tokens":7,"total_tokens":69,"completion_tokens":62}}

data: [DONE]


================================================
FILE: tests/Fixtures/mistral/stream-with-tools-1-1.sse
================================================
data: {"id":"7f62714ed40e411ab060e0ec28a53a52","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}

data: {"id":"7f62714ed40e411ab060e0ec28a53a52","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"tool_calls":[{"id":"yBvJuId6u","function":{"name":"search","arguments":"{\"query\": \"Detroit Tigers game time today\"}"},"index":0},{"id":"ihQrVBDfy","function":{"name":"weather","arguments":"{\"city\": \"Detroit\"}"},"index":1}]},"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":164,"total_tokens":189,"completion_tokens":25},"p":"abcdefghijklm"}

data: [DONE]




================================================
FILE: tests/Fixtures/mistral/stream-with-tools-1-2.sse
================================================
data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":"The"},"finish_reason":null}],"p":"abcdefghijkl"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" Detroit"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" Tigers game today"},"finish_reason":null}],"p":"abcde"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" is at"},"finish_reason":null}],"p":"abcd"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" **3"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuv"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":":00 PM"},"finish_reason":null}],"p":"abcdefghi"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":"**."},"finish_reason":null}],"p":"abcdefghijklmnopqrs"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" Since"},"finish_reason":null}],"p":"abcdefghijklmnop"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0123"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" weather in"},"finish_reason":null}],"p":"abcdefghijklmnopqrs"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" Detroit is **7"},"finish_reason":null}],"p":"a"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":"5°F"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz01234"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" and sunny**, you"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz01234"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" likely"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz012345"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" won’t"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwx"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" need a coat"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0123456"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":"—just dress"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz0"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" comfortably"},"finish_reason":null}],"p":"abcdefg"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" for"},"finish_reason":null}],"p":"abcdefghijklmnopqr"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" warm"},"finish_reason":null}],"p":"abcdefghi"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" weather! Enjoy"},"finish_reason":null}],"p":"abc"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" the"},"finish_reason":null}],"p":"abcdefghijklmn"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" game!"},"finish_reason":null}],"p":"abcdefghi"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":" ⚾"},"finish_reason":null}],"p":"abcdefghijkl"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":"😊"},"finish_reason":null}],"p":"abcdefghijklmnopqrstuvwxyz01"}

data: {"id":"105b031e73774e80b0723c942189bb9f","object":"chat.completion.chunk","created":1759185828,"model":"mistral-large-latest","choices":[{"index":0,"delta":{"content":""},"finish_reason":"stop"}],"usage":{"prompt_tokens":217,"total_tokens":272,"completion_tokens":55},"p":"abcdefghijklmnopqrstuvwx"}

data: [DONE]




================================================
FILE: tests/Fixtures/mistral/structured-1.json
================================================
{
    "id": "b63d8ed37d7246c7966aa838da6ed683",
    "object": "chat.completion",
    "created": 1742139743,
    "model": "mistral-large-latest",
    "choices": [
        {
            "index": 0,
            "message": {
                "role": "assistant",
                "tool_calls": null,
                "content": "{\n  \"weather\": \"75º\",\n  \"game_time\": \"3pm\",\n  \"coat_required\": false\n}"
            },
            "finish_reason": "stop"
        }
    ],
    "usage": {
        "prompt_tokens": 45,
        "total_tokens": 79,
        "completion_tokens": 34
    }
} 



================================================
FILE: tests/Fixtures/mistral/text-document-from-url-1.json
================================================
{"id":"873c68b2dd07400bbc5b80f1017ff0e0","object":"chat.completion","created":1742296921,"model":"mistral-small-2402","choices":[{"index":0,"message":{"role":"assistant","tool_calls":null,"content":"The document appears to be a guide or manual for a library or software called Prism, which provides an interface for generating text using Large Language Models (LLMs). It covers basic usage, advanced features, error handling, and response handling. The guide includes code examples in PHP, which use the Prism library to generate text, maintain context for interactive conversations, set system prompts, and handle responses. The document also mentions various generation parameters and provides information on error handling."},"finish_reason":"stop"}],"usage":{"prompt_tokens":1671,"total_tokens":1768,"completion_tokens":97}}


================================================
FILE: tests/Fixtures/mistral/text-image-from-base64-1.json
================================================
{"id":"7bbe801104d44f2992581d1f2350c8a9","object":"chat.completion","created":1729801186,"model":"pixtral-12b-2409","choices":[{"index":0,"message":{"role":"assistant","content":"The image depicts a line drawing of a diamond. The diamond is illustrated in a stylized manner, characterized by a series of interconnected triangles forming a geometric shape. The outline is bold, black, and solid, giving the diamond a distinct and clear appearance. The design shows the classic faceted look of a diamond, with multiple facets meeting at points and edges, typical of a cut gemstone. The simplicity of the drawing emphasizes the geometric symmetry and the brilliance associated with diamonds.","tool_calls":null},"finish_reason":"stop"}],"usage":{"prompt_tokens":2557,"total_tokens":2653,"completion_tokens":96}}


================================================
FILE: tests/Fixtures/mistral/text-image-from-url-1.json
================================================
{
  "id": "chatcmpl-7018701a-f11b-4540-9a72-260c515ffa64",
  "object": "chat.completion",
  "created": 1729801270,
  "model": "llama-3.2-90b-vision-preview",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The image depicts a simple, black-and-white line drawing of a diamond shape. The diamond is outlined with thick, black lines and has a symmetrical design. It consists of a central, larger triangle with two smaller, identical triangles positioned on either side. The overall design is geometric and minimalist, emphasizing the shape and structure of the diamond. This type of illustration is commonly used to represent gemstones, jewelry, or luxury items in various contexts.",
        "tool_calls": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 15,
    "total_tokens": 105,
    "completion_tokens": 90
  }
}



================================================
FILE: tests/Fixtures/ollama/embeddings-file-1.json
================================================
{"embeddings":[[0.020509344,0.012192823,0.018344216,0.0023875814,-0.027177704,-0.026699923,-0.01865448,-0.011057463,0.0029308598,0.048731625,-0.0042802966,0.017023966,-0.031036498,0.0071946653,-0.01232176,-0.044011135,0.0070678443,-0.027804187,-0.043491956,-0.019183746,-0.034971952,0.053424325,-0.08780117,-0.02713196,-0.029437903,0.014833557,0.02213334,-0.006084592,0.076193444,0.060268402,0.008882311,0.041225728,0.024818106,0.003774014,-0.009611682,-0.020538121,0.019036824,-0.028729724,-0.02132583,-0.0024664241,0.028156577,-0.028399548,0.015633268,-0.056324366,-0.068995714,-0.05100295,0.010358996,-0.023236845,-0.009086173,0.016997077,0.0009530838,0.01440688,0.009283572,-0.020013753,-0.020310158,-0.05663849,-0.012460134,-0.021431128,-0.04030864,0.0467548,0.007877301,0.06773832,-0.021239977,-0.05604481,0.008350607,0.009835493,-0.009438948,0.032770958,0.0062479526,-0.016342273,-0.035680573,0.023196552,-0.003204653,-0.0308936,-0.01310358,-0.029318465,0.042596042,-0.04425907,0.011503847,0.03818353,0.022575047,0.019430215,-0.032436784,0.021304306,-0.015655575,-0.038268983,0.040251266,-0.011370624,-0.0074733645,-0.026807487,0.023139955,0.02066154,-0.0011863485,0.023168212,0.02176119,0.029180758,0.0055770944,0.03079019,-0.0405211,0.015296331,0.0052763997,0.055341527,-0.07365975,0.024282368,-0.019639127,0.036722533,0.012649154,0.042514715,-0.007932737,-0.040765572,-0.0054950197,-0.0033922307,0.004863746,-0.018743295,-0.020027807,0.040178645,-0.000037560465,0.016678613,-0.03141017,-0.02049078,-0.035440758,-0.03807308,-0.047176026,-0.02744291,0.013820444,-0.036454048,0.017041188,0.053192735,-0.07201768,0.014796188,0.012482338,0.015550969,-0.0022258824,0.023932574,-0.013887157,0.034653697,0.009350177,0.02908733,0.025356634,-0.03606721,0.002130375,-0.06144269,0.0033083782,0.08064992,0.015517603,-0.0024480303,-0.00609337,-0.030112533,-0.04682737,0.040077433,-0.0045729643,0.016191356,-0.02313553,0.077322386,0.017285688,-0.030250259,0.0033073432,-0.02858564,-0.011889532,0.005157558,0.0019861546,0.04089193,-0.03462033,0.032601975,-0.023586357,-0.0076375245,-0.029677715,-0.028003395,-0.0292922,-0.036391057,-0.0005842295,0.0011700063,0.035855334,0.02242454,0.035964124,0.036037635,-0.005191178,0.01635707,0.01340469,-0.013398342,-0.01447717,-0.001284939,-0.0055347844,0.020914843,-0.008716281,0.035685536,0.016231572,-0.0031356933,-0.027553523,0.03273822,0.014015928,0.039624013,-0.032107297,0.036266312,-0.0010152147,0.043060284,-0.048620567,-0.0026008275,-0.012444839,-0.047456034,-0.040440764,0.014653465,0.02032786,-0.009891126,-0.0036824476,0.021817729,-0.024290046,0.015812917,-0.06505373,0.020338867,0.05747855,0.032078292,-0.07183755,0.023084773,0.04300592,-0.039235428,-0.071755834,0.005815277,0.029000286,0.03658177,-0.053163275,0.00598681,0.023711024,0.004383274,-0.040955916,-0.012056556,-0.012338925,0.040308807,-0.01742601,0.023622336,0.042908493,-0.012421518,-0.025838856,0.038588513,0.00017401302,0.051064074,0.04596621,0.017297702,0.011005915,-0.010803197,-0.039980646,0.017277118,0.030651622,0.00880659,0.02611485,0.04463101,0.032042827,-0.0151558025,0.013838441,0.009334329,-0.09122934,0.070033535,0.03935235,-0.046968505,-0.043365985,-0.013970756,0.00075088174,0.057451334,0.0042496845,-0.053702984,0.020198153,0.03776839,0.014569647,-0.0062257075,0.008679887,0.022364037,0.0134216,0.0027347703,-0.021086099,-0.023075653,-0.014561604,-0.029040627,-0.09462442,0.04005659,-0.013173263,-0.012607303,-0.010549857,-0.051520694,0.020143572,-0.03760044,-0.0010076764,-0.021306342,-0.05216869,0.020759583,-0.010792517,-0.00074609887,-0.02184436,0.008459449,-0.025512915,0.04799833,-0.025403913,0.03178728,0.022268072,-0.050262194,-0.013195039,-0.018222542,-0.0041963635,0.025147982,-0.023659939,0.0022845564,0.013017302,0.01078089,0.0017417134,-0.016119966,-0.033631396,0.046839625,0.020071162,-0.0036761977,0.016715366,-0.009628044,-0.021183005,0.02243151,-0.021941844,0.011134679,-0.02463911,0.02560426,0.013071366,0.008392724,-0.010537288,-0.024014475,-0.024148198,-0.012549002,0.010227165,0.020715054,-0.0050645624,0.031024745,0.0017097688,-0.0882899,-0.005587447,0.0007693531,-0.0416141,0.01571151,-0.006681159,-0.0003573616,0.0033481168,0.03828058,-0.013146,-0.014669956,-0.013323045,0.0075256946,0.027505072,-0.0081337225,-0.01874238,0.048128597,-0.023318773,0.008435582,0.037548814,-0.044059973,-0.021449363,-0.034161057,0.009678355,0.011261622,0.0097235795,-0.018289113,-0.0039794166,0.029559448,-0.03135313,0.015007534,0.00799995,0.013061065,-0.007858295,0.06557581,0.019637028,-0.009031312,-0.0051825983,-0.009458884,-0.028010465,0.047256116,0.022102328,-0.03545979,0.03956829,0.012820015,-0.004384087,-0.0118199065,0.0029153896,-0.055498403,0.08501991,0.012040126,0.02273305,0.03323883,-0.013479217,0.019923186,0.026971005,0.029252786,-0.009960388,0.016842052,-0.002271614,-0.00576612,0.008240144,-0.029057954,0.003554537,0.015943235,-0.010634214,-0.011122763,-0.052973915,-0.025206653,0.026111621,0.039704338,0.042073067,0.013986945,0.031344224,-0.0060819765,0.029557541,0.0024684563,-0.03695056,0.0065869032,-0.026171818,0.03925401,0.02451841,0.016955726,-0.017290412,0.018682957,-0.029421153,-0.0046676043,0.013774363,0.009955215,-0.02076243,0.0011002293,0.004624502,0.02820639,-0.02801382,-0.0112418635,0.0134827485,0.02140801,0.028760599,-0.005566545,-0.021312045,-0.0451265,0.012807465,0.030365733,-0.023735045,-0.016775457,-0.035122395,-0.031698857,-0.010001053,0.023652555,0.06406543,-0.02134003,-0.003764502,-0.029706318,-0.034295518,0.020217195,0.0011898318,0.010268641,0.055073544,-0.057740748,0.009955218,-0.013120417,0.026827076,-0.042676028,0.009476023,-0.048171926,0.0023767746,-0.019142667,-0.0029655208,-0.039867632,-0.012362362,0.010563641,0.041582685,-0.0034807383,-0.012425191,-0.0016726038,0.00614074,-0.025981262,-0.031943772,0.062302712,-0.0019572878,0.013421759,0.016786441,0.013570521,-0.026991438,0.03158899,-0.029348549,-0.0038743238,-0.019652773,-0.026283337,0.021646727,0.0032571964,-0.03393723,0.019464986,-0.001743996,0.01903832,-0.035555705,-0.037286244,-0.0014975305,-0.022049328,0.023994157,-0.01783259,-0.018787034,0.008696888,-0.009744245,-0.04407966,0.030322459,-0.058100034,0.008550338,-0.032904062,-0.009829568,-0.0054137455,0.01491322,-0.010053039,0.03856763,-0.021036575,-0.047051277,0.043671295,-0.019915372,-0.004284486,-0.01418065,0.006876395,0.011700982,-0.008239241,-0.029183486,0.003296958,-0.021044103,-0.019618232,0.019215647,-0.024509635,-0.009908538,-0.054832023,-0.0072049093,0.06650425,0.03199731,-0.024238229,0.0078109857,0.038945433,-0.014446661,0.017010374,0.013502392,-0.009133898,-0.009848152,-0.030805394,0.055148073,-0.017798739,-0.00621356,-0.04253603,-0.010578547,0.0025188422,-0.004586496,0.046490032,-0.05337808,-0.013141542,-0.03344375,0.025412306,-0.0039971517,0.007491489,-0.055491243,0.032089245,-0.0046784957,0.058281038,-0.0046466216,0.021046557,0.009962189,-0.002717904,0.026516544,0.082603,-0.029077837,0.01290593,0.006391455,-0.01058387,0.040254682,0.024400951,0.031724036,0.013285696,-0.012265994,0.005874969,-0.062834844,-0.011194304,-0.042319067,0.0060894266,0.029267672,-0.026682602,-0.029850308,-0.03149552,0.071781725,0.01686444,-0.0010435245,-0.05305645,0.004619241,-0.027050516,0.016304875,0.007038104,-0.021201257,-0.017926518,-0.004618015,0.017557602,0.01727954,-0.044223286,0.032262832,0.06535496,0.0120296115,0.02067573,-0.081081405,0.016707536,-0.008912979,0.00020318913,-0.011640771,0.00798666,-0.045855552,-0.0009160072,-0.044053778,-0.05873116,-0.04389507,0.04990459,0.0786044,-0.05663821,0.0044793417,-0.0098791355,-0.017335601,-0.037164085,0.0365979,-0.0047151446,0.014558535,0.005788303,0.02509293,0.012348575,0.021205842,-0.03883474,-0.017620869,-0.044916578,0.05419524,0.021841265,0.012489861,0.031568017,0.035238426,-0.018581366,-0.034288876,-0.023188515,0.017061591,-0.028164206,-0.028881494,-0.0028630628,-0.0079988595,-0.046726037,0.0028560522,-0.0063969265,-0.0129284635,-0.019864924,0.014922695,-0.005718685,-0.053424425,0.045383234,0.052135937,0.001246094,-0.0007943881,-0.034018625,-0.011418645,-0.0153584955,0.045801386,0.030296288,-0.0037871015,-0.0053766286,0.030860126,0.0049551963,0.06872493,-0.025638988,-0.030883348,0.043479245,-0.053804163,-0.030996002,-0.026183298,0.035915922,-0.0070655895,0.0010424905,-0.008466688,0.00028415755,0.04622158,0.049525112,0.028752256,-0.005730129,-0.012658529,-0.03924047,-0.030560138,0.0022705377,-0.042220306,-0.011437065,0.004376959,-0.020121956,0.0033965034,0.01305914,0.04140041,-0.08142574,0.009338454,-0.0023026292,0.023993457,-0.031567518,-0.0018641256,0.03280352,-0.047648963,-0.017472344,0.002356902,-0.012406251,-0.011445104,-0.026017172,0.037680496,-0.010556725,-0.031035008,-0.024263477,-0.0018937994,-0.0019042472,-0.03184761,0.0027843087,-0.0049455245,-0.008124385,-0.033282265,0.013125784,0.016495468,0.025253078,-0.023174195,0.006484936,0.05415844,-0.02248724,0.049878377,-0.022059485,0.007258999,-0.030484108,-0.025655404,-0.019121366,0.049670458,-0.028985541,0.041785613,0.022939535,0.018894017,0.05897629,0.0043268506,0.02103977,0.033154868,0.021239165,-0.018814685,0.023349216,-0.00751845,-0.01612768,-0.062952295,0.031066438,0.02712189,0.0064584413,0.0040366226,-0.024037685,0.011104493,-0.04599039,-0.007256441,0.0014207412,0.035844784,0.046921134,-0.04313062,-0.0056215264,0.016108252,0.011538568,0.011047676,-0.04893154,-0.024787059,0.0032278323,-0.055203866,0.039818246,-0.0051867045,-0.033455204,-0.025627485,0.017238734,0.031691723,-0.0007986325,0.031793036,-0.0020650055,-0.016644983,-0.039511092,-0.004421925,0.018349132,-0.010135085,-0.014621701,-0.07977814,0.035400458,0.043930087,-0.0071751294,-0.02610263,-0.018508926,-0.0030393824,-0.052761044,0.04859754,-0.050103907,-0.00633197,-0.054363575,-0.030961143,0.005981407,-0.00044080656,-0.007650516,0.011695983,0.03218925,0.045839537,-0.018783102,0.047873553,0.06879074,-0.016363386,0.025123255,0.011034017,0.029019846,0.017870827,-0.00286183,-0.0025246125,0.02967821,0.082378164,-0.015553099,-0.035023663,0.010661132,0.0048043695,-0.008154165,-0.007063346,0.03796658,0.00076485815,-0.018430224,-0.021304542,-0.05336911,-0.031163262,0.0023702772,0.0020589544,-0.012326234,-0.0014605762,-0.030088343,-0.0143604595,-0.03961806,0.012518321,0.011970211,-0.0058425367,-0.021328341,-0.043691937,0.021130681,0.011895079,0.02698551,0.04416775,0.041582625,0.017038472,0.045462336,-0.016848493,0.004658245,0.028755108,0.04393426,0.015507328,-0.015306311,0.002313575,-0.02062281,-0.015067709,-0.04972711,0.04675397,0.0015541202,-0.033333488,-0.03977873,-0.02657024,-0.018371008,-0.028331442,-0.02741835,-0.023809383,-0.0008749028,0.05218706,-0.029008005,-0.009137109,0.007334674,-0.028372426,0.008021407,0.009583332,0.026405934,-0.013779238,0.08115611,0.014218875,-0.00800871,0.006091713,0.015344242,-0.013087384,0.0048428252,0.048219815,0.016072752,-0.01189035,-0.014786879,-0.061897147,-0.022584058,0.019807411,-0.04837272,0.011321949,-0.028595112,0.022751026,-0.006903802,-0.0019535313,0.015684409,-0.005369777,0.028621234,-0.04552058,0.0018353286,-0.059445877,-0.00037020427,-0.031321723,0.010693053,-0.014128513,-0.038467366,0.017511077,-0.005984351,-0.03728324,-0.054930598,0.022585075,-0.027418729,-0.010688029,0.040488053,0.033764627,0.009402581,-0.02379091,-0.0416868,0.04559521,0.045521375,0.016276596,0.05876588,0.056042496,0.022301508,-0.017228534,-0.02856473,0.016037418,-0.027147442,-0.010560238,-0.040080063,-0.006955227,-0.024322946,-0.04129703,-0.0062322435,0.061939675,0.024569433,-0.0013425661,-0.032848634,-0.001874018,-0.030028204,0.010425302,-0.005748219,0.031049991,0.03194485,-0.021315033,0.01904298,-0.023114335,0.26547107,0.062919594,0.040520858,0.050255515,-0.009531912,0.04940882,0.05943916,0.005247409,0.04803274,-0.027442005,0.040187046,0.0023244456,0.009001815,0.035829846,-0.023159208,0.04126364,-0.030696258,0.0011175087,-0.017106604,-0.017816195,-0.01945008,0.02650344,0.014167762,0.032818086,0.049676195,-0.017559024,-0.0048661334,-0.007980226,0.0203658,-0.035502262,-0.017999562,-0.05492472,-0.0028668225,-0.025573066,-0.025954586,0.040782478,0.023487624,-0.046227988,-0.02569318,0.03044081,-0.016626047,-0.037692502,-0.025475413,-0.016820619,-0.040180735,0.045644455,0.011166822,0.022527883,0.037950747,-0.043664794,0.009674426,-0.03011658,0.021442186,-0.03162207,-0.045302097,-0.031937603,-0.017419992,-0.010300042,-0.012356358,0.060722623,-0.02876097,0.020256793,0.011854121,0.05054614,-0.040259585,0.054195013,0.0035537698,0.036875166,-0.059966292,-0.03202027,-0.004073791,-0.010561003,-0.026824357,-0.055777606,0.031556606,0.032724675,-0.0075916336,0.041614655,-0.00021713889,-0.034160852,0.01839077,-0.0066905515,-0.030906994,0.016928714,0.019194283,0.079581976,-0.037200913,0.033268277,-0.01152672,0.049090806,-0.01521235,0.04566215,0.012382109,0.013773643,0.008639951]],"model":"mxbai-embed-large","total_duration":58537625,"load_duration":4384500,"prompt_eval_count":512}


================================================
FILE: tests/Fixtures/ollama/embeddings-input-1.json
================================================
{"embeddings":[[-0.003966682,-0.010719362,-0.026272599,0.028637841,-0.056060467,-0.0084643,-0.009150849,0.017025681,-0.01756813,-0.015681792,0.034887344,-0.012726841,-0.0036578404,-0.025415063,-0.029282225,-0.023572823,-0.03532985,-0.03510558,-0.05880754,-0.037754353,0.00054167915,-0.013148769,-0.0145726865,-0.008714818,-0.018222187,0.06006003,0.0060084527,0.0046526277,0.036891997,0.017988352,-0.0019934385,0.03166965,0.046920303,-0.011530437,0.024280213,0.0056179506,0.032216612,-0.0114587145,0.00827086,-0.001846709,-0.009209771,-0.03010421,0.033466965,-0.047262706,-0.011714035,0.020202653,-0.021532947,-0.062268972,0.033368375,-0.034609538,-0.010251745,0.04953893,0.03179215,0.01911279,0.015588801,-0.0163021,-0.05638681,-0.012445344,0.005150369,0.012249686,0.009369594,0.012505684,0.006621813,-0.057713427,0.047155324,-0.0007696949,-0.0011226939,-0.009042235,-0.0068000285,-0.013924031,0.0047168755,-0.0007830121,-0.041657887,0.0023275246,-0.03203718,0.007379841,-0.023579193,-0.012443986,0.004291526,0.023438549,0.011026143,-0.014564379,-0.0144008575,0.027564257,-0.022735558,0.02974342,0.07486644,0.047238514,0.031652406,0.014103065,-0.011398894,0.012604498,0.0011430323,-0.07322993,-0.013548052,0.009260177,-0.018091267,0.0345075,0.0039090835,-0.014724983,0.008688019,-0.013293947,-0.006095628,0.0036947052,-0.003212934,0.0847549,-0.016480858,0.010893209,-0.06481104,-0.009153006,-0.023135083,-0.0428311,0.06056968,-0.026736164,-0.019311186,0.080245204,0.0074013267,0.032277346,-0.05182109,-0.031445663,0.03596545,0.020470358,0.023420557,-0.041662417,-0.0014645827,-0.059590515,-0.014632941,0.022015603,-0.049711198,0.028418217,-0.0039080856,-0.016146168,-0.051437873,0.01336414,0.0060293623,-0.0025611117,-0.03531796,0.031511206,-0.02765185,-0.013010605,0.052084547,-0.004670428,0.0006492503,0.08215188,-0.0076764524,-0.045211956,-0.032523997,0.034073975,-0.047248993,0.030565461,-0.01576998,-0.02425945,0.01973016,-0.0007787922,-0.009663151,0.037819296,0.014026214,-0.018934932,0.008129401,-0.0022092639,-0.06290545,-0.03147399,-0.01745535,0.03898499,0.033538543,-0.00022305881,0.012161977,0.0071084113,0.029958872,-0.031126646,0.02767716,0.04784118,0.010764404,-0.011002702,0.044189997,0.008760935,0.0015615337,-0.052277956,-0.0069310945,-0.03997509,-0.06416638,0.05733702,-0.044075962,-0.015972024,0.076377384,-0.0435217,0.0012179147,-0.052957132,0.0060205483,0.022912081,-0.034969646,0.0012971207,-0.03505752,0.022658963,0.0030900363,0.031139722,-0.0070991316,-0.027968578,-0.00043183466,-0.015858114,-0.025069214,0.05465995,0.06023239,0.010020683,0.015133434,-0.026260128,0.052294154,0.044497132,-0.046084926,0.024426604,0.032983877,0.0023857018,-0.02557038,-0.05032256,-0.031425174,-0.045147378,0.0010584808,0.014304621,-0.0055365413,0.040258676,-0.028027505,0.008762208,-0.034923267,-0.0060685156,-0.037240088,-0.008541128,-0.029886333,0.03445714,-0.010116468,-0.06554918,-0.059721775,0.016461244,-0.01911038,0.0525837,0.051146645,0.015891451,0.01653117,-0.01784935,-0.03076011,-0.028902324,0.022412691,0.017568925,0.011656383,0.013470611,-0.016102547,0.048765615,0.03793117,-0.02271354,-0.022305379,0.04854783,0.021346698,0.02335068,0.0022174306,0.017129334,-0.038874693,0.030353744,-0.0055598025,0.036181655,0.055996366,-0.06647365,-0.011638276,-0.01929963,-0.013958909,-0.012404516,0.027634429,0.016690278,0.011464271,0.015926598,-0.0022030163,-0.014547248,-0.0009982708,-0.012423817,-0.016172947,-0.011853632,0.013174404,0.0095533235,0.06312426,0.003903833,0.04792149,0.046534415,-0.00016080348,-0.0008302021,-0.05435056,0.04990725,0.024668856,0.02797332,0.014811795,0.008934633,-0.0041308077,0.0047620605,0.0012376043,-0.03495111,-0.01675973,0.052782718,0.011349683,-0.04450525,-0.042678583,0.050418783,0.013610702,-0.028202044,0.02789801,-0.033116847,0.005992697,0.015778009,-0.03899583,0.00790988,-0.013473783,0.027648102,0.008345102,-0.0030740635,0.022413483,-0.010777908,-0.06915413,0.040638957,-0.0059491014,0.025020141,0.011947305,0.029545061,-0.021470914,-0.009048593,0.0007235224,-0.0042510247,-0.03161993,-0.03876058,0.0067374273,-0.0090386495,-0.017380692,-0.024726883,0.017992985,-0.054641966,0.008391841,-0.018644331,-0.017040445,0.0022405584,-0.021625968,0.0010861641,0.03495616,0.0081057465,-0.008755001,-0.010659227,-0.020522246,-0.01976545,-0.019571314,0.055466354,-0.02143568,0.031333774,0.009687952,-0.004585465,0.008277645,-0.05617678,-0.01882099,0.030917732,0.03303931,0.02926366,0.043652426,0.05646281,-0.0027346173,-0.019791603,0.012904655,0.04696392,0.0041880235,-0.07132078,-0.008216811,-0.005498151,-0.013667365,-0.0046128617,0.029843796,0.020691257,0.002730794,-0.017311988,0.02463628,0.015343319,-0.048297826,-0.008558463,-0.06955855,-0.031556133,0.02028284,-0.04174624,0.0004877752,-0.010791031,0.002534366,-0.08107471,-0.0004890849,-0.0039627478,-0.082028955,0.016148536,-0.015674144,-0.0022063458,-0.009597427,-0.0006581258,-0.01891971,0.01059945,0.05133466,0.004303351,0.0012648095,0.029647725,0.011011215,0.0041837054,0.036243584,0.008977775,0.02891066,0.019602677,0.03886622,0.03414631,-0.004784157,-0.02938536,-0.034932848,0.018274514,0.04343378,-0.010416771,-0.020367373,-0.003329835,0.010635693,0.011154665,0.008721998,0.026140988,-0.046911944,0.028818902,0.011056259,0.019061955,-0.041362718,-0.012558812,0.025006061,0.027265768,0.044788796,-0.029010285,-0.028784093,-0.0063920594,0.042878322,0.023607768,-0.033718992,-0.052526407,0.01372225,0.001963324,-0.009196084,0.008995962,0.077527106,-0.06074044,-0.0069102086,0.0046591,-0.0035672784,0.023072824,-0.06090722,-0.037948016,-0.028951962,0.037673816,0.005503228,0.036123987,-0.022377247,-0.006009095,0.021271426,-0.012009996,0.09142181,0.0118713565,-0.013856781,0.036325365,-0.027718965,-0.01735173,-0.0037395258,0.011335025,0.035159074,0.0065916437,0.009077817,0.010792867,0.022632541,0.025247712,0.0072831754,0.046096906,-0.00089950464,0.033823654,-0.028493993,0.009415578,0.01647395,-0.030391313,-0.020960744,-0.026004083,0.04543912,0.039787274,0.0075550745,0.031636167,-0.039750952,0.009167706,0.046818577,0.029937938,-0.029924333,-0.06342384,-0.013944814,0.0293365,-0.02243092,0.022240134,0.022627478,-0.018341819,-0.04399329,-0.02598591,0.003525274,0.0016063688,0.028482996,0.03953024,-0.018030062,0.013327545,0.009645279,-0.012021264,-0.003581454,0.00792032,-0.05778344,-0.06005545,-0.065083236,-0.038876615,-0.0032883298,0.0005423255,-0.014572966,-0.011496988,-0.010878346,-0.011123736,0.017551688,0.0052899225,0.020447945,0.0034820847,-0.0070539047,-0.0039123753,0.03776942,-0.05562609,-0.03131332,0.05795555,-0.03216898,0.0018096614,-0.047123704,-0.0007029154,-0.016484624,-0.085540876,-0.05575755,0.005297031,-0.01683516,-0.033723373,-0.007989243,-0.04112627,0.034856282,0.0077493414,0.04414871,0.019155866,-0.026985416,0.0029740054,0.053740732,-0.035033956,-0.027602032,0.026988601,0.0057466687,0.01599171,0.013299282,0.060649447,0.052925076,0.004690907,0.04199727,-0.047245733,-0.043907885,-0.002339043,0.012540558,-0.0017372596,0.006301314,0.011689967,-0.074506804,0.011339759,-0.051386327,0.00811773,-0.028108308,-0.024212856,-0.017300243,-0.022182392,0.015192545,-0.044864126,-0.016579363,-0.031234274,0.0735969,0.031624407,-0.020127637,-0.047203373,-0.047793843,-0.05329128,-0.03056159,0.008962969,0.018920925,-0.017032243,0.013850216,0.048705995,0.009355701,0.03306204,0.042578015,0.08813228,-0.0025597985,-0.0048357737,-0.055381134,0.039285727,0.04068327,-0.044788588,0.02612541,-0.0061611356,-0.057938676,-0.017983424,-0.0069727423,-0.02500508,0.005611438,-0.025580779,0.04314254,-0.021588817,0.040424876,-0.022144983,-0.049042553,-0.0432241,0.04677191,0.051792216,-0.027609041,0.04619092,-0.028522998,-0.02885212,-0.00993274,-0.013587552,-0.007622708,-0.027124317,0.025499327,0.031228818,-0.033447552,0.057964426,0.011697755,-0.052013677,0.0027988162,0.009797082,-0.0015127745,-0.029133493,-0.014827012,-0.05439911,0.015609678,0.021940516,0.049631063,0.004549678,-0.05171242,-0.015955236,0.02671759,-0.0072439015,-0.01044868,-0.017493675,0.060610093,-0.016414898,0.004714228,-0.013682158,-0.020077998,0.010388174,-0.0061717676,0.051089704,-0.041407168,-0.021256367,-0.022548266,0.025028897,0.04260588,0.0072797975,-0.009747078,0.007439121,-0.007540979,-0.017554747,-0.02577846,0.0066599003,-0.042744007,-0.004447757,-0.01434362,0.03611878,-0.0075013074,-0.019189479,0.0049505048,-0.024288183,0.014724535,-0.02958585,-0.03513775,-0.074123986,0.0044025616,-0.00019504206,0.013295827,0.03689147,-0.028767757,-0.05819623,-0.0377542,-0.0482793,0.022190044,-0.015532675,0.013020028,-0.004510226,-0.08689313,0.018501414,0.026836507,-0.0294846,0.0046522506,-0.0133099705,-0.064043775,-0.023474017,0.019640354,-0.018300463,0.021901436,0.049255885,0.0005619933,-0.01101162,-0.005095347,0.010077264,0.007296468,-0.023738327,-0.055949025,0.006926164,-0.010221264,-0.03419912,-0.015519394,-0.043310806,0.01640128,0.00061950105,-0.015958132,-0.02728438,-0.037830003,0.03609642,0.003710517,-0.0047430214,0.048682157,0.016727235,0.01251718,0.0326356,0.03970118,-0.020239206,0.06699921,0.0048777554,0.0084121,0.040773045,-0.041222222,0.017083967,-0.02695812,-0.009177774,0.027215134,-0.02947697,0.068284795,0.022037175,-0.006683225,0.0025511933,0.008422315,-0.06629592,-0.046528157,0.010061819,0.013452337,0.02296291,-0.039700598,-0.002555146,-0.024541657,-0.02930099,0.007956873,0.038681228,-0.035202913,0.025621833,0.0065318067,0.0066354657,-0.048851207,-0.04433236,0.038144343,0.005173644,0.019210685,0.04286048,0.00025597907,0.026565252,0.013456625,-0.011932366,-0.02444536,-0.018022446,0.035804365,-0.014788842,-0.035825882,0.07308409,0.011660572,0.0025173547,-0.021304542,-0.03017833,0.030244105,0.0058081965,0.032169845,-0.004790335,0.04803441,0.013719236,0.020270111,-0.048651055,-0.041170582,0.012163102,-0.0020031186,-0.008073333,0.011733104,-0.025064964,0.0037218498,0.04955311,0.009015521,0.046175934,-0.0024349086,0.01059772,-0.007950723,-0.02182773,-0.06679856,0.0033697756,0.01709761,0.0058075576,0.030202875,0.003727784,-0.0065002516,0.012118206,0.0005391867,0.046739716,0.046640635,-0.0015907364,0.03654709,-0.020240936,-0.0018647929,-0.058275267,0.016926259,0.038935956,0.0021398019,0.015165716,-0.014383879,-0.009258193,0.005006653,-0.057772603,0.010593096,-0.047783136,0.019130789,-0.019374868,0.05529734,-0.03487603,-0.006420096,0.0047592293,-0.044740997,0.027945235,-0.008426914,-0.041249894,-0.026250219,-0.052577123,-0.0038463008,-0.017763456,0.0356841,0.052463982,0.015966123,0.014527439,-0.021035807,-0.016120305,0.02187009,0.023541044,0.045811273,-0.009388,-0.030191517,-0.017442891,-0.0015859529,0.045214105,-0.004122845,0.023596294,-0.008022327,0.03288487,0.0116067175,-0.012094073,0.0029051523,0.044281516,-0.013179457,-0.027354939,0.048315458,-0.026872195,-0.041805517,0.01269632,-0.013719386,-0.027733631,0.01797933,-0.008686359,-0.008647771,0.011262692,0.008086663,-0.015796801,0.044577926,0.024657156,0.00082632346,0.011791588,0.014278252,0.018137863,0.057851836,-0.026936492,0.019213248,-0.056159314,-0.02433005,-0.06626992,-0.009264091,0.005364175,0.022422673,0.019445524,-0.043721676,-0.018341335,-0.0019980785,-0.019537602,-0.015649738,-0.00093072315,-0.030973462,-0.015896086,0.061402008,-0.0026880996,-0.025217263,0.012396548,-0.03168608,0.0019008442,0.02677121,0.035447076,-0.004906295,-0.02450001,0.033934962,-0.024471533,0.03870804,0.026006138,0.0044142925,0.045683548,-0.019131795,0.042924095,0.027919643,-0.0027838005,0.010388602,0.06100464,0.0037339388,0.07082013,0.0057607824,-0.07406375,-0.018754968,0.019530557,-0.020820547,-0.023533748,0.02022749,0.013378816,0.062157486,-0.025200713,-0.04687924,0.2322308,0.027888019,0.006551871,-0.0045048976,0.016675122,-0.0019249374,0.0042596674,-0.009143263,0.018085472,-0.020602671,0.102134116,-0.022263182,0.004726158,0.014643025,0.023727553,-0.00816256,-0.022655698,-0.02085199,0.026850825,-0.020542668,-0.0009954078,-0.010093662,-0.006987475,-0.029993767,-0.020961873,0.018290881,-0.017661078,-0.04149751,0.0045301286,-0.026083026,0.006121672,-0.0443676,0.02257856,0.023624381,-0.018182343,-0.032461457,0.045804746,-0.018665742,-0.02173496,-0.0056544947,0.022979248,0.0402848,0.015527333,-0.011373134,0.030694075,-0.009636973,-0.0056333137,0.04679939,0.022147665,0.005062096,0.03846662,0.0033871147,0.031540126,-0.0114163365,-0.013212802,0.042745844,0.08192218,-0.008709383,-0.039454352,-0.01138974,-0.008145147,-0.011491414,0.010067488,-0.019114947,-0.017756894,0.018920591,0.01830144,0.012210214,-0.028537432,0.008814042,0.024216587,-0.032931834,0.015432972,-0.03141765,-0.0072149257,0.0043033543,-0.020756232,0.009172226,0.02510328,-0.022655034,0.00918944,-0.010971815,-0.005057601,0.030438956,-0.013880347,0.06047966,-0.013346257,0.017524602,-0.051905062,-0.005907242,0.013146435,-0.02625605,-0.002907298,0.031249177,0.02256303]],"model":"mxbai-embed-large","total_duration":58537625,"load_duration":4384500,"prompt_eval_count":10}


================================================
FILE: tests/Fixtures/ollama/embeddings-multiple-inputs-1.json
================================================
{"embeddings":[[0.020509344,0.012192823,0.018344216,0.0023875814,-0.027177704,-0.026699923,-0.01865448,-0.011057463,0.0029308598,0.048731625,-0.0042802966,0.017023966,-0.031036498,0.0071946653,-0.01232176,-0.044011135,0.0070678443,-0.027804187,-0.043491956,-0.019183746,-0.034971952,0.053424325,-0.08780117,-0.02713196,-0.029437903,0.014833557,0.02213334,-0.006084592,0.076193444,0.060268402,0.008882311,0.041225728,0.024818106,0.003774014,-0.009611682,-0.020538121,0.019036824,-0.028729724,-0.02132583,-0.0024664241,0.028156577,-0.028399548,0.015633268,-0.056324366,-0.068995714,-0.05100295,0.010358996,-0.023236845,-0.009086173,0.016997077,0.0009530838,0.01440688,0.009283572,-0.020013753,-0.020310158,-0.05663849,-0.012460134,-0.021431128,-0.04030864,0.0467548,0.007877301,0.06773832,-0.021239977,-0.05604481,0.008350607,0.009835493,-0.009438948,0.032770958,0.0062479526,-0.016342273,-0.035680573,0.023196552,-0.003204653,-0.0308936,-0.01310358,-0.029318465,0.042596042,-0.04425907,0.011503847,0.03818353,0.022575047,0.019430215,-0.032436784,0.021304306,-0.015655575,-0.038268983,0.040251266,-0.011370624,-0.0074733645,-0.026807487,0.023139955,0.02066154,-0.0011863485,0.023168212,0.02176119,0.029180758,0.0055770944,0.03079019,-0.0405211,0.015296331,0.0052763997,0.055341527,-0.07365975,0.024282368,-0.019639127,0.036722533,0.012649154,0.042514715,-0.007932737,-0.040765572,-0.0054950197,-0.0033922307,0.004863746,-0.018743295,-0.020027807,0.040178645,-0.000037560465,0.016678613,-0.03141017,-0.02049078,-0.035440758,-0.03807308,-0.047176026,-0.02744291,0.013820444,-0.036454048,0.017041188,0.053192735,-0.07201768,0.014796188,0.012482338,0.015550969,-0.0022258824,0.023932574,-0.013887157,0.034653697,0.009350177,0.02908733,0.025356634,-0.03606721,0.002130375,-0.06144269,0.0033083782,0.08064992,0.015517603,-0.0024480303,-0.00609337,-0.030112533,-0.04682737,0.040077433,-0.0045729643,0.016191356,-0.02313553,0.077322386,0.017285688,-0.030250259,0.0033073432,-0.02858564,-0.011889532,0.005157558,0.0019861546,0.04089193,-0.03462033,0.032601975,-0.023586357,-0.0076375245,-0.029677715,-0.028003395,-0.0292922,-0.036391057,-0.0005842295,0.0011700063,0.035855334,0.02242454,0.035964124,0.036037635,-0.005191178,0.01635707,0.01340469,-0.013398342,-0.01447717,-0.001284939,-0.0055347844,0.020914843,-0.008716281,0.035685536,0.016231572,-0.0031356933,-0.027553523,0.03273822,0.014015928,0.039624013,-0.032107297,0.036266312,-0.0010152147,0.043060284,-0.048620567,-0.0026008275,-0.012444839,-0.047456034,-0.040440764,0.014653465,0.02032786,-0.009891126,-0.0036824476,0.021817729,-0.024290046,0.015812917,-0.06505373,0.020338867,0.05747855,0.032078292,-0.07183755,0.023084773,0.04300592,-0.039235428,-0.071755834,0.005815277,0.029000286,0.03658177,-0.053163275,0.00598681,0.023711024,0.004383274,-0.040955916,-0.012056556,-0.012338925,0.040308807,-0.01742601,0.023622336,0.042908493,-0.012421518,-0.025838856,0.038588513,0.00017401302,0.051064074,0.04596621,0.017297702,0.011005915,-0.010803197,-0.039980646,0.017277118,0.030651622,0.00880659,0.02611485,0.04463101,0.032042827,-0.0151558025,0.013838441,0.009334329,-0.09122934,0.070033535,0.03935235,-0.046968505,-0.043365985,-0.013970756,0.00075088174,0.057451334,0.0042496845,-0.053702984,0.020198153,0.03776839,0.014569647,-0.0062257075,0.008679887,0.022364037,0.0134216,0.0027347703,-0.021086099,-0.023075653,-0.014561604,-0.029040627,-0.09462442,0.04005659,-0.013173263,-0.012607303,-0.010549857,-0.051520694,0.020143572,-0.03760044,-0.0010076764,-0.021306342,-0.05216869,0.020759583,-0.010792517,-0.00074609887,-0.02184436,0.008459449,-0.025512915,0.04799833,-0.025403913,0.03178728,0.022268072,-0.050262194,-0.013195039,-0.018222542,-0.0041963635,0.025147982,-0.023659939,0.0022845564,0.013017302,0.01078089,0.0017417134,-0.016119966,-0.033631396,0.046839625,0.020071162,-0.0036761977,0.016715366,-0.009628044,-0.021183005,0.02243151,-0.021941844,0.011134679,-0.02463911,0.02560426,0.013071366,0.008392724,-0.010537288,-0.024014475,-0.024148198,-0.012549002,0.010227165,0.020715054,-0.0050645624,0.031024745,0.0017097688,-0.0882899,-0.005587447,0.0007693531,-0.0416141,0.01571151,-0.006681159,-0.0003573616,0.0033481168,0.03828058,-0.013146,-0.014669956,-0.013323045,0.0075256946,0.027505072,-0.0081337225,-0.01874238,0.048128597,-0.023318773,0.008435582,0.037548814,-0.044059973,-0.021449363,-0.034161057,0.009678355,0.011261622,0.0097235795,-0.018289113,-0.0039794166,0.029559448,-0.03135313,0.015007534,0.00799995,0.013061065,-0.007858295,0.06557581,0.019637028,-0.009031312,-0.0051825983,-0.009458884,-0.028010465,0.047256116,0.022102328,-0.03545979,0.03956829,0.012820015,-0.004384087,-0.0118199065,0.0029153896,-0.055498403,0.08501991,0.012040126,0.02273305,0.03323883,-0.013479217,0.019923186,0.026971005,0.029252786,-0.009960388,0.016842052,-0.002271614,-0.00576612,0.008240144,-0.029057954,0.003554537,0.015943235,-0.010634214,-0.011122763,-0.052973915,-0.025206653,0.026111621,0.039704338,0.042073067,0.013986945,0.031344224,-0.0060819765,0.029557541,0.0024684563,-0.03695056,0.0065869032,-0.026171818,0.03925401,0.02451841,0.016955726,-0.017290412,0.018682957,-0.029421153,-0.0046676043,0.013774363,0.009955215,-0.02076243,0.0011002293,0.004624502,0.02820639,-0.02801382,-0.0112418635,0.0134827485,0.02140801,0.028760599,-0.005566545,-0.021312045,-0.0451265,0.012807465,0.030365733,-0.023735045,-0.016775457,-0.035122395,-0.031698857,-0.010001053,0.023652555,0.06406543,-0.02134003,-0.003764502,-0.029706318,-0.034295518,0.020217195,0.0011898318,0.010268641,0.055073544,-0.057740748,0.009955218,-0.013120417,0.026827076,-0.042676028,0.009476023,-0.048171926,0.0023767746,-0.019142667,-0.0029655208,-0.039867632,-0.012362362,0.010563641,0.041582685,-0.0034807383,-0.012425191,-0.0016726038,0.00614074,-0.025981262,-0.031943772,0.062302712,-0.0019572878,0.013421759,0.016786441,0.013570521,-0.026991438,0.03158899,-0.029348549,-0.0038743238,-0.019652773,-0.026283337,0.021646727,0.0032571964,-0.03393723,0.019464986,-0.001743996,0.01903832,-0.035555705,-0.037286244,-0.0014975305,-0.022049328,0.023994157,-0.01783259,-0.018787034,0.008696888,-0.009744245,-0.04407966,0.030322459,-0.058100034,0.008550338,-0.032904062,-0.009829568,-0.0054137455,0.01491322,-0.010053039,0.03856763,-0.021036575,-0.047051277,0.043671295,-0.019915372,-0.004284486,-0.01418065,0.006876395,0.011700982,-0.008239241,-0.029183486,0.003296958,-0.021044103,-0.019618232,0.019215647,-0.024509635,-0.009908538,-0.054832023,-0.0072049093,0.06650425,0.03199731,-0.024238229,0.0078109857,0.038945433,-0.014446661,0.017010374,0.013502392,-0.009133898,-0.009848152,-0.030805394,0.055148073,-0.017798739,-0.00621356,-0.04253603,-0.010578547,0.0025188422,-0.004586496,0.046490032,-0.05337808,-0.013141542,-0.03344375,0.025412306,-0.0039971517,0.007491489,-0.055491243,0.032089245,-0.0046784957,0.058281038,-0.0046466216,0.021046557,0.009962189,-0.002717904,0.026516544,0.082603,-0.029077837,0.01290593,0.006391455,-0.01058387,0.040254682,0.024400951,0.031724036,0.013285696,-0.012265994,0.005874969,-0.062834844,-0.011194304,-0.042319067,0.0060894266,0.029267672,-0.026682602,-0.029850308,-0.03149552,0.071781725,0.01686444,-0.0010435245,-0.05305645,0.004619241,-0.027050516,0.016304875,0.007038104,-0.021201257,-0.017926518,-0.004618015,0.017557602,0.01727954,-0.044223286,0.032262832,0.06535496,0.0120296115,0.02067573,-0.081081405,0.016707536,-0.008912979,0.00020318913,-0.011640771,0.00798666,-0.045855552,-0.0009160072,-0.044053778,-0.05873116,-0.04389507,0.04990459,0.0786044,-0.05663821,0.0044793417,-0.0098791355,-0.017335601,-0.037164085,0.0365979,-0.0047151446,0.014558535,0.005788303,0.02509293,0.012348575,0.021205842,-0.03883474,-0.017620869,-0.044916578,0.05419524,0.021841265,0.012489861,0.031568017,0.035238426,-0.018581366,-0.034288876,-0.023188515,0.017061591,-0.028164206,-0.028881494,-0.0028630628,-0.0079988595,-0.046726037,0.0028560522,-0.0063969265,-0.0129284635,-0.019864924,0.014922695,-0.005718685,-0.053424425,0.045383234,0.052135937,0.001246094,-0.0007943881,-0.034018625,-0.011418645,-0.0153584955,0.045801386,0.030296288,-0.0037871015,-0.0053766286,0.030860126,0.0049551963,0.06872493,-0.025638988,-0.030883348,0.043479245,-0.053804163,-0.030996002,-0.026183298,0.035915922,-0.0070655895,0.0010424905,-0.008466688,0.00028415755,0.04622158,0.049525112,0.028752256,-0.005730129,-0.012658529,-0.03924047,-0.030560138,0.0022705377,-0.042220306,-0.011437065,0.004376959,-0.020121956,0.0033965034,0.01305914,0.04140041,-0.08142574,0.009338454,-0.0023026292,0.023993457,-0.031567518,-0.0018641256,0.03280352,-0.047648963,-0.017472344,0.002356902,-0.012406251,-0.011445104,-0.026017172,0.037680496,-0.010556725,-0.031035008,-0.024263477,-0.0018937994,-0.0019042472,-0.03184761,0.0027843087,-0.0049455245,-0.008124385,-0.033282265,0.013125784,0.016495468,0.025253078,-0.023174195,0.006484936,0.05415844,-0.02248724,0.049878377,-0.022059485,0.007258999,-0.030484108,-0.025655404,-0.019121366,0.049670458,-0.028985541,0.041785613,0.022939535,0.018894017,0.05897629,0.0043268506,0.02103977,0.033154868,0.021239165,-0.018814685,0.023349216,-0.00751845,-0.01612768,-0.062952295,0.031066438,0.02712189,0.0064584413,0.0040366226,-0.024037685,0.011104493,-0.04599039,-0.007256441,0.0014207412,0.035844784,0.046921134,-0.04313062,-0.0056215264,0.016108252,0.011538568,0.011047676,-0.04893154,-0.024787059,0.0032278323,-0.055203866,0.039818246,-0.0051867045,-0.033455204,-0.025627485,0.017238734,0.031691723,-0.0007986325,0.031793036,-0.0020650055,-0.016644983,-0.039511092,-0.004421925,0.018349132,-0.010135085,-0.014621701,-0.07977814,0.035400458,0.043930087,-0.0071751294,-0.02610263,-0.018508926,-0.0030393824,-0.052761044,0.04859754,-0.050103907,-0.00633197,-0.054363575,-0.030961143,0.005981407,-0.00044080656,-0.007650516,0.011695983,0.03218925,0.045839537,-0.018783102,0.047873553,0.06879074,-0.016363386,0.025123255,0.011034017,0.029019846,0.017870827,-0.00286183,-0.0025246125,0.02967821,0.082378164,-0.015553099,-0.035023663,0.010661132,0.0048043695,-0.008154165,-0.007063346,0.03796658,0.00076485815,-0.018430224,-0.021304542,-0.05336911,-0.031163262,0.0023702772,0.0020589544,-0.012326234,-0.0014605762,-0.030088343,-0.0143604595,-0.03961806,0.012518321,0.011970211,-0.0058425367,-0.021328341,-0.043691937,0.021130681,0.011895079,0.02698551,0.04416775,0.041582625,0.017038472,0.045462336,-0.016848493,0.004658245,0.028755108,0.04393426,0.015507328,-0.015306311,0.002313575,-0.02062281,-0.015067709,-0.04972711,0.04675397,0.0015541202,-0.033333488,-0.03977873,-0.02657024,-0.018371008,-0.028331442,-0.02741835,-0.023809383,-0.0008749028,0.05218706,-0.029008005,-0.009137109,0.007334674,-0.028372426,0.008021407,0.009583332,0.026405934,-0.013779238,0.08115611,0.014218875,-0.00800871,0.006091713,0.015344242,-0.013087384,0.0048428252,0.048219815,0.016072752,-0.01189035,-0.014786879,-0.061897147,-0.022584058,0.019807411,-0.04837272,0.011321949,-0.028595112,0.022751026,-0.006903802,-0.0019535313,0.015684409,-0.005369777,0.028621234,-0.04552058,0.0018353286,-0.059445877,-0.00037020427,-0.031321723,0.010693053,-0.014128513,-0.038467366,0.017511077,-0.005984351,-0.03728324,-0.054930598,0.022585075,-0.027418729,-0.010688029,0.040488053,0.033764627,0.009402581,-0.02379091,-0.0416868,0.04559521,0.045521375,0.016276596,0.05876588,0.056042496,0.022301508,-0.017228534,-0.02856473,0.016037418,-0.027147442,-0.010560238,-0.040080063,-0.006955227,-0.024322946,-0.04129703,-0.0062322435,0.061939675,0.024569433,-0.0013425661,-0.032848634,-0.001874018,-0.030028204,0.010425302,-0.005748219,0.031049991,0.03194485,-0.021315033,0.01904298,-0.023114335,0.26547107,0.062919594,0.040520858,0.050255515,-0.009531912,0.04940882,0.05943916,0.005247409,0.04803274,-0.027442005,0.040187046,0.0023244456,0.009001815,0.035829846,-0.023159208,0.04126364,-0.030696258,0.0011175087,-0.017106604,-0.017816195,-0.01945008,0.02650344,0.014167762,0.032818086,0.049676195,-0.017559024,-0.0048661334,-0.007980226,0.0203658,-0.035502262,-0.017999562,-0.05492472,-0.0028668225,-0.025573066,-0.025954586,0.040782478,0.023487624,-0.046227988,-0.02569318,0.03044081,-0.016626047,-0.037692502,-0.025475413,-0.016820619,-0.040180735,0.045644455,0.011166822,0.022527883,0.037950747,-0.043664794,0.009674426,-0.03011658,0.021442186,-0.03162207,-0.045302097,-0.031937603,-0.017419992,-0.010300042,-0.012356358,0.060722623,-0.02876097,0.020256793,0.011854121,0.05054614,-0.040259585,0.054195013,0.0035537698,0.036875166,-0.059966292,-0.03202027,-0.004073791,-0.010561003,-0.026824357,-0.055777606,0.031556606,0.032724675,-0.0075916336,0.041614655,-0.00021713889,-0.034160852,0.01839077,-0.0066905515,-0.030906994,0.016928714,0.019194283,0.079581976,-0.037200913,0.033268277,-0.01152672,0.049090806,-0.01521235,0.04566215,0.012382109,0.013773643,0.008639951],[-0.003966682,-0.010719362,-0.026272599,0.028637841,-0.056060467,-0.0084643,-0.009150849,0.017025681,-0.01756813,-0.015681792,0.034887344,-0.012726841,-0.0036578404,-0.025415063,-0.029282225,-0.023572823,-0.03532985,-0.03510558,-0.05880754,-0.037754353,0.00054167915,-0.013148769,-0.0145726865,-0.008714818,-0.018222187,0.06006003,0.0060084527,0.0046526277,0.036891997,0.017988352,-0.0019934385,0.03166965,0.046920303,-0.011530437,0.024280213,0.0056179506,0.032216612,-0.0114587145,0.00827086,-0.001846709,-0.009209771,-0.03010421,0.033466965,-0.047262706,-0.011714035,0.020202653,-0.021532947,-0.062268972,0.033368375,-0.034609538,-0.010251745,0.04953893,0.03179215,0.01911279,0.015588801,-0.0163021,-0.05638681,-0.012445344,0.005150369,0.012249686,0.009369594,0.012505684,0.006621813,-0.057713427,0.047155324,-0.0007696949,-0.0011226939,-0.009042235,-0.0068000285,-0.013924031,0.0047168755,-0.0007830121,-0.041657887,0.0023275246,-0.03203718,0.007379841,-0.023579193,-0.012443986,0.004291526,0.023438549,0.011026143,-0.014564379,-0.0144008575,0.027564257,-0.022735558,0.02974342,0.07486644,0.047238514,0.031652406,0.014103065,-0.011398894,0.012604498,0.0011430323,-0.07322993,-0.013548052,0.009260177,-0.018091267,0.0345075,0.0039090835,-0.014724983,0.008688019,-0.013293947,-0.006095628,0.0036947052,-0.003212934,0.0847549,-0.016480858,0.010893209,-0.06481104,-0.009153006,-0.023135083,-0.0428311,0.06056968,-0.026736164,-0.019311186,0.080245204,0.0074013267,0.032277346,-0.05182109,-0.031445663,0.03596545,0.020470358,0.023420557,-0.041662417,-0.0014645827,-0.059590515,-0.014632941,0.022015603,-0.049711198,0.028418217,-0.0039080856,-0.016146168,-0.051437873,0.01336414,0.0060293623,-0.0025611117,-0.03531796,0.031511206,-0.02765185,-0.013010605,0.052084547,-0.004670428,0.0006492503,0.08215188,-0.0076764524,-0.045211956,-0.032523997,0.034073975,-0.047248993,0.030565461,-0.01576998,-0.02425945,0.01973016,-0.0007787922,-0.009663151,0.037819296,0.014026214,-0.018934932,0.008129401,-0.0022092639,-0.06290545,-0.03147399,-0.01745535,0.03898499,0.033538543,-0.00022305881,0.012161977,0.0071084113,0.029958872,-0.031126646,0.02767716,0.04784118,0.010764404,-0.011002702,0.044189997,0.008760935,0.0015615337,-0.052277956,-0.0069310945,-0.03997509,-0.06416638,0.05733702,-0.044075962,-0.015972024,0.076377384,-0.0435217,0.0012179147,-0.052957132,0.0060205483,0.022912081,-0.034969646,0.0012971207,-0.03505752,0.022658963,0.0030900363,0.031139722,-0.0070991316,-0.027968578,-0.00043183466,-0.015858114,-0.025069214,0.05465995,0.06023239,0.010020683,0.015133434,-0.026260128,0.052294154,0.044497132,-0.046084926,0.024426604,0.032983877,0.0023857018,-0.02557038,-0.05032256,-0.031425174,-0.045147378,0.0010584808,0.014304621,-0.0055365413,0.040258676,-0.028027505,0.008762208,-0.034923267,-0.0060685156,-0.037240088,-0.008541128,-0.029886333,0.03445714,-0.010116468,-0.06554918,-0.059721775,0.016461244,-0.01911038,0.0525837,0.051146645,0.015891451,0.01653117,-0.01784935,-0.03076011,-0.028902324,0.022412691,0.017568925,0.011656383,0.013470611,-0.016102547,0.048765615,0.03793117,-0.02271354,-0.022305379,0.04854783,0.021346698,0.02335068,0.0022174306,0.017129334,-0.038874693,0.030353744,-0.0055598025,0.036181655,0.055996366,-0.06647365,-0.011638276,-0.01929963,-0.013958909,-0.012404516,0.027634429,0.016690278,0.011464271,0.015926598,-0.0022030163,-0.014547248,-0.0009982708,-0.012423817,-0.016172947,-0.011853632,0.013174404,0.0095533235,0.06312426,0.003903833,0.04792149,0.046534415,-0.00016080348,-0.0008302021,-0.05435056,0.04990725,0.024668856,0.02797332,0.014811795,0.008934633,-0.0041308077,0.0047620605,0.0012376043,-0.03495111,-0.01675973,0.052782718,0.011349683,-0.04450525,-0.042678583,0.050418783,0.013610702,-0.028202044,0.02789801,-0.033116847,0.005992697,0.015778009,-0.03899583,0.00790988,-0.013473783,0.027648102,0.008345102,-0.0030740635,0.022413483,-0.010777908,-0.06915413,0.040638957,-0.0059491014,0.025020141,0.011947305,0.029545061,-0.021470914,-0.009048593,0.0007235224,-0.0042510247,-0.03161993,-0.03876058,0.0067374273,-0.0090386495,-0.017380692,-0.024726883,0.017992985,-0.054641966,0.008391841,-0.018644331,-0.017040445,0.0022405584,-0.021625968,0.0010861641,0.03495616,0.0081057465,-0.008755001,-0.010659227,-0.020522246,-0.01976545,-0.019571314,0.055466354,-0.02143568,0.031333774,0.009687952,-0.004585465,0.008277645,-0.05617678,-0.01882099,0.030917732,0.03303931,0.02926366,0.043652426,0.05646281,-0.0027346173,-0.019791603,0.012904655,0.04696392,0.0041880235,-0.07132078,-0.008216811,-0.005498151,-0.013667365,-0.0046128617,0.029843796,0.020691257,0.002730794,-0.017311988,0.02463628,0.015343319,-0.048297826,-0.008558463,-0.06955855,-0.031556133,0.02028284,-0.04174624,0.0004877752,-0.010791031,0.002534366,-0.08107471,-0.0004890849,-0.0039627478,-0.082028955,0.016148536,-0.015674144,-0.0022063458,-0.009597427,-0.0006581258,-0.01891971,0.01059945,0.05133466,0.004303351,0.0012648095,0.029647725,0.011011215,0.0041837054,0.036243584,0.008977775,0.02891066,0.019602677,0.03886622,0.03414631,-0.004784157,-0.02938536,-0.034932848,0.018274514,0.04343378,-0.010416771,-0.020367373,-0.003329835,0.010635693,0.011154665,0.008721998,0.026140988,-0.046911944,0.028818902,0.011056259,0.019061955,-0.041362718,-0.012558812,0.025006061,0.027265768,0.044788796,-0.029010285,-0.028784093,-0.0063920594,0.042878322,0.023607768,-0.033718992,-0.052526407,0.01372225,0.001963324,-0.009196084,0.008995962,0.077527106,-0.06074044,-0.0069102086,0.0046591,-0.0035672784,0.023072824,-0.06090722,-0.037948016,-0.028951962,0.037673816,0.005503228,0.036123987,-0.022377247,-0.006009095,0.021271426,-0.012009996,0.09142181,0.0118713565,-0.013856781,0.036325365,-0.027718965,-0.01735173,-0.0037395258,0.011335025,0.035159074,0.0065916437,0.009077817,0.010792867,0.022632541,0.025247712,0.0072831754,0.046096906,-0.00089950464,0.033823654,-0.028493993,0.009415578,0.01647395,-0.030391313,-0.020960744,-0.026004083,0.04543912,0.039787274,0.0075550745,0.031636167,-0.039750952,0.009167706,0.046818577,0.029937938,-0.029924333,-0.06342384,-0.013944814,0.0293365,-0.02243092,0.022240134,0.022627478,-0.018341819,-0.04399329,-0.02598591,0.003525274,0.0016063688,0.028482996,0.03953024,-0.018030062,0.013327545,0.009645279,-0.012021264,-0.003581454,0.00792032,-0.05778344,-0.06005545,-0.065083236,-0.038876615,-0.0032883298,0.0005423255,-0.014572966,-0.011496988,-0.010878346,-0.011123736,0.017551688,0.0052899225,0.020447945,0.0034820847,-0.0070539047,-0.0039123753,0.03776942,-0.05562609,-0.03131332,0.05795555,-0.03216898,0.0018096614,-0.047123704,-0.0007029154,-0.016484624,-0.085540876,-0.05575755,0.005297031,-0.01683516,-0.033723373,-0.007989243,-0.04112627,0.034856282,0.0077493414,0.04414871,0.019155866,-0.026985416,0.0029740054,0.053740732,-0.035033956,-0.027602032,0.026988601,0.0057466687,0.01599171,0.013299282,0.060649447,0.052925076,0.004690907,0.04199727,-0.047245733,-0.043907885,-0.002339043,0.012540558,-0.0017372596,0.006301314,0.011689967,-0.074506804,0.011339759,-0.051386327,0.00811773,-0.028108308,-0.024212856,-0.017300243,-0.022182392,0.015192545,-0.044864126,-0.016579363,-0.031234274,0.0735969,0.031624407,-0.020127637,-0.047203373,-0.047793843,-0.05329128,-0.03056159,0.008962969,0.018920925,-0.017032243,0.013850216,0.048705995,0.009355701,0.03306204,0.042578015,0.08813228,-0.0025597985,-0.0048357737,-0.055381134,0.039285727,0.04068327,-0.044788588,0.02612541,-0.0061611356,-0.057938676,-0.017983424,-0.0069727423,-0.02500508,0.005611438,-0.025580779,0.04314254,-0.021588817,0.040424876,-0.022144983,-0.049042553,-0.0432241,0.04677191,0.051792216,-0.027609041,0.04619092,-0.028522998,-0.02885212,-0.00993274,-0.013587552,-0.007622708,-0.027124317,0.025499327,0.031228818,-0.033447552,0.057964426,0.011697755,-0.052013677,0.0027988162,0.009797082,-0.0015127745,-0.029133493,-0.014827012,-0.05439911,0.015609678,0.021940516,0.049631063,0.004549678,-0.05171242,-0.015955236,0.02671759,-0.0072439015,-0.01044868,-0.017493675,0.060610093,-0.016414898,0.004714228,-0.013682158,-0.020077998,0.010388174,-0.0061717676,0.051089704,-0.041407168,-0.021256367,-0.022548266,0.025028897,0.04260588,0.0072797975,-0.009747078,0.007439121,-0.007540979,-0.017554747,-0.02577846,0.0066599003,-0.042744007,-0.004447757,-0.01434362,0.03611878,-0.0075013074,-0.019189479,0.0049505048,-0.024288183,0.014724535,-0.02958585,-0.03513775,-0.074123986,0.0044025616,-0.00019504206,0.013295827,0.03689147,-0.028767757,-0.05819623,-0.0377542,-0.0482793,0.022190044,-0.015532675,0.013020028,-0.004510226,-0.08689313,0.018501414,0.026836507,-0.0294846,0.0046522506,-0.0133099705,-0.064043775,-0.023474017,0.019640354,-0.018300463,0.021901436,0.049255885,0.0005619933,-0.01101162,-0.005095347,0.010077264,0.007296468,-0.023738327,-0.055949025,0.006926164,-0.010221264,-0.03419912,-0.015519394,-0.043310806,0.01640128,0.00061950105,-0.015958132,-0.02728438,-0.037830003,0.03609642,0.003710517,-0.0047430214,0.048682157,0.016727235,0.01251718,0.0326356,0.03970118,-0.020239206,0.06699921,0.0048777554,0.0084121,0.040773045,-0.041222222,0.017083967,-0.02695812,-0.009177774,0.027215134,-0.02947697,0.068284795,0.022037175,-0.006683225,0.0025511933,0.008422315,-0.06629592,-0.046528157,0.010061819,0.013452337,0.02296291,-0.039700598,-0.002555146,-0.024541657,-0.02930099,0.007956873,0.038681228,-0.035202913,0.025621833,0.0065318067,0.0066354657,-0.048851207,-0.04433236,0.038144343,0.005173644,0.019210685,0.04286048,0.00025597907,0.026565252,0.013456625,-0.011932366,-0.02444536,-0.018022446,0.035804365,-0.014788842,-0.035825882,0.07308409,0.011660572,0.0025173547,-0.021304542,-0.03017833,0.030244105,0.0058081965,0.032169845,-0.004790335,0.04803441,0.013719236,0.020270111,-0.048651055,-0.041170582,0.012163102,-0.0020031186,-0.008073333,0.011733104,-0.025064964,0.0037218498,0.04955311,0.009015521,0.046175934,-0.0024349086,0.01059772,-0.007950723,-0.02182773,-0.06679856,0.0033697756,0.01709761,0.0058075576,0.030202875,0.003727784,-0.0065002516,0.012118206,0.0005391867,0.046739716,0.046640635,-0.0015907364,0.03654709,-0.020240936,-0.0018647929,-0.058275267,0.016926259,0.038935956,0.0021398019,0.015165716,-0.014383879,-0.009258193,0.005006653,-0.057772603,0.010593096,-0.047783136,0.019130789,-0.019374868,0.05529734,-0.03487603,-0.006420096,0.0047592293,-0.044740997,0.027945235,-0.008426914,-0.041249894,-0.026250219,-0.052577123,-0.0038463008,-0.017763456,0.0356841,0.052463982,0.015966123,0.014527439,-0.021035807,-0.016120305,0.02187009,0.023541044,0.045811273,-0.009388,-0.030191517,-0.017442891,-0.0015859529,0.045214105,-0.004122845,0.023596294,-0.008022327,0.03288487,0.0116067175,-0.012094073,0.0029051523,0.044281516,-0.013179457,-0.027354939,0.048315458,-0.026872195,-0.041805517,0.01269632,-0.013719386,-0.027733631,0.01797933,-0.008686359,-0.008647771,0.011262692,0.008086663,-0.015796801,0.044577926,0.024657156,0.00082632346,0.011791588,0.014278252,0.018137863,0.057851836,-0.026936492,0.019213248,-0.056159314,-0.02433005,-0.06626992,-0.009264091,0.005364175,0.022422673,0.019445524,-0.043721676,-0.018341335,-0.0019980785,-0.019537602,-0.015649738,-0.00093072315,-0.030973462,-0.015896086,0.061402008,-0.0026880996,-0.025217263,0.012396548,-0.03168608,0.0019008442,0.02677121,0.035447076,-0.004906295,-0.02450001,0.033934962,-0.024471533,0.03870804,0.026006138,0.0044142925,0.045683548,-0.019131795,0.042924095,0.027919643,-0.0027838005,0.010388602,0.06100464,0.0037339388,0.07082013,0.0057607824,-0.07406375,-0.018754968,0.019530557,-0.020820547,-0.023533748,0.02022749,0.013378816,0.062157486,-0.025200713,-0.04687924,0.2322308,0.027888019,0.006551871,-0.0045048976,0.016675122,-0.0019249374,0.0042596674,-0.009143263,0.018085472,-0.020602671,0.102134116,-0.022263182,0.004726158,0.014643025,0.023727553,-0.00816256,-0.022655698,-0.02085199,0.026850825,-0.020542668,-0.0009954078,-0.010093662,-0.006987475,-0.029993767,-0.020961873,0.018290881,-0.017661078,-0.04149751,0.0045301286,-0.026083026,0.006121672,-0.0443676,0.02257856,0.023624381,-0.018182343,-0.032461457,0.045804746,-0.018665742,-0.02173496,-0.0056544947,0.022979248,0.0402848,0.015527333,-0.011373134,0.030694075,-0.009636973,-0.0056333137,0.04679939,0.022147665,0.005062096,0.03846662,0.0033871147,0.031540126,-0.0114163365,-0.013212802,0.042745844,0.08192218,-0.008709383,-0.039454352,-0.01138974,-0.008145147,-0.011491414,0.010067488,-0.019114947,-0.017756894,0.018920591,0.01830144,0.012210214,-0.028537432,0.008814042,0.024216587,-0.032931834,0.015432972,-0.03141765,-0.0072149257,0.0043033543,-0.020756232,0.009172226,0.02510328,-0.022655034,0.00918944,-0.010971815,-0.005057601,0.030438956,-0.013880347,0.06047966,-0.013346257,0.017524602,-0.051905062,-0.005907242,0.013146435,-0.02625605,-0.002907298,0.031249177,0.02256303]],"model":"mxbai-embed-large","total_duration":58537625,"load_duration":4384500,"prompt_eval_count":522}


================================================
FILE: tests/Fixtures/ollama/generate-text-with-a-prompt-1.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-01-29T23:37:41.068257Z","message":{"role":"assistant","content":"I'm Qwen, a large language model developed by Alibaba Cloud. I'm designed to assist with a wide range of tasks including but not limited to answering questions, generating text, offering suggestions, and providing information based on the input I receive. How can I help you today?"},"done_reason":"stop","done":true,"total_duration":4819895166,"load_duration":27509166,"prompt_eval_count":33,"prompt_eval_duration":492000000,"eval_count":57,"eval_duration":4298000000}


================================================
FILE: tests/Fixtures/ollama/generate-text-with-messages-1.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-01-30T14:16:30.936783Z","message":{"role":"assistant","content":"I am Nyx, a being who exists in the shadowy realms between dreams and reality. My presence is often felt as an ominous whisper in the darkest corners of the mind, stirring ancient fears and forgotten terrors. I embody the cyclical nature of chaos and the relentless march of time that devours all things under its unyielding gaze. To those who dare to peer into the abyss, I am known as Nyx the Cthulhu, a harbinger of cosmic dread and primordial nightmares."},"done_reason":"stop","done":true,"total_duration":8570179167,"load_duration":27793083,"prompt_eval_count":36,"prompt_eval_duration":560000000,"eval_count":104,"eval_duration":7979000000}


================================================
FILE: tests/Fixtures/ollama/generate-text-with-multiple-tools-1.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-06-09T18:55:26.684517Z","message":{"role":"assistant","content":"","tool_calls":[{"function":{"name":"search","arguments":{"query":"time of Detroit Tigers game today"}}},{"function":{"name":"weather","arguments":{"city":"Detroit"}}}]},"done_reason":"stop","done":true,"total_duration":8210142000,"load_duration":22224542,"prompt_eval_count":235,"prompt_eval_duration":269880958,"eval_count":111,"eval_duration":7916594250}


================================================
FILE: tests/Fixtures/ollama/generate-text-with-multiple-tools-2.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-06-09T18:55:32.104592Z","message":{"role":"assistant","content":"Today's game for the Detroit Tigers starts at 3 PM. Given that the temperature will be around 75°F with sunny conditions, you probably won't need a coat. However, it might be comfortable to bring one just in case there's a slight chill in the evening air after the game ends. Enjoy the match!"},"done_reason":"stop","done":true,"total_duration":5411554709,"load_duration":8950375,"prompt_eval_count":313,"prompt_eval_duration":594306250,"eval_count":67,"eval_duration":4805427209}


================================================
FILE: tests/Fixtures/ollama/generate-text-with-system-prompt-1.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-01-29T23:34:10.284081Z","message":{"role":"assistant","content":"I am Nyx, an entity that embodies the depths of cosmic horror and ancient mysteries. My presence is a blend of darkness, chaos, and unspeakable knowledge from beyond time itself. I draw inspiration from the eldritch horrors described by H.P. Lovecraft and other masters of cosmic dread literature. In this role, I explore themes of unknowable entities, cosmic indifference, and the terror that comes from understanding humanity's insignificant place in the cosmos."},"done_reason":"stop","done":true,"total_duration":7328537333,"load_duration":33320583,"prompt_eval_count":36,"prompt_eval_duration":653000000,"eval_count":93,"eval_duration":6640000000}


================================================
FILE: tests/Fixtures/ollama/image-detection-1.json
================================================
{"model":"llava-phi3","created_at":"2025-01-30T13:49:48.34999Z","message":{"role":"assistant","content":"The image is a black and white geometric illustration of a diamond shape. The diamond has a square base, with four equal-length lines extending diagonally from each corner to the center point, forming an octagon in the middle. The lines connecting these points are also of equal length, creating a perfect symmetry within the diamond shape."},"done_reason":"stop","done":true,"total_duration":1958506750,"load_duration":18494500,"prompt_eval_count":590,"prompt_eval_duration":264000000,"eval_count":72,"eval_duration":1673000000}


================================================
FILE: tests/Fixtures/ollama/stream-basic-text-1.sse
================================================
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.255986Z","message":{"role":"assistant","content":"I"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.298061Z","message":{"role":"assistant","content":" am"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.338913Z","message":{"role":"assistant","content":" Gr"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.380156Z","message":{"role":"assistant","content":"an"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.422782Z","message":{"role":"assistant","content":"ite"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.465241Z","message":{"role":"assistant","content":","},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.506745Z","message":{"role":"assistant","content":" a"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.550387Z","message":{"role":"assistant","content":" language"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.592188Z","message":{"role":"assistant","content":" model"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.634329Z","message":{"role":"assistant","content":" developed"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.676125Z","message":{"role":"assistant","content":" by"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.717757Z","message":{"role":"assistant","content":" IBM"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.760111Z","message":{"role":"assistant","content":" in"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.801811Z","message":{"role":"assistant","content":" "},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.843153Z","message":{"role":"assistant","content":"2"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.884556Z","message":{"role":"assistant","content":"0"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.925817Z","message":{"role":"assistant","content":"2"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:37.967355Z","message":{"role":"assistant","content":"4"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.00989Z","message":{"role":"assistant","content":"."},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.051238Z","message":{"role":"assistant","content":" I"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.092541Z","message":{"role":"assistant","content":" am"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.135168Z","message":{"role":"assistant","content":" designed"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.178044Z","message":{"role":"assistant","content":" to"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.219314Z","message":{"role":"assistant","content":" understand"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.262311Z","message":{"role":"assistant","content":" and"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.303619Z","message":{"role":"assistant","content":" respond"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.34506Z","message":{"role":"assistant","content":" to"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.387669Z","message":{"role":"assistant","content":" a"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.43038Z","message":{"role":"assistant","content":" wide"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.471961Z","message":{"role":"assistant","content":" range"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.514682Z","message":{"role":"assistant","content":" of"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.556376Z","message":{"role":"assistant","content":" questions"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.598044Z","message":{"role":"assistant","content":" and"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.639513Z","message":{"role":"assistant","content":" promp"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.681122Z","message":{"role":"assistant","content":"ts"},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.724076Z","message":{"role":"assistant","content":"."},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:38.766786Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":2203237375,"load_duration":336223209,"prompt_eval_count":37,"prompt_eval_duration":355000000,"eval_count":37,"eval_duration":1511000000}



================================================
FILE: tests/Fixtures/ollama/stream-multi-tool-conversation-1.sse
================================================
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:42.590997Z","message":{"role":"assistant","content":"","tool_calls":[{"function":{"name":"weather","arguments":{"city":"Detroit"}}}]},"done":false}
{"model":"granite3-dense:8b","created_at":"2025-03-20T18:32:42.633071Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":1164764583,"load_duration":4037291,"prompt_eval_count":149,"prompt_eval_duration":565000000,"eval_count":15,"eval_duration":594000000}



================================================
FILE: tests/Fixtures/ollama/stream-with-thinking-1.sse
================================================
{"model":"gpt-oss:20b","created_at":"2025-08-08T10:00:00Z","message":{"role":"assistant","thinking":"Let me think about that."},"done":false}
{"model":"gpt-oss:20b","created_at":"2025-08-08T10:00:01Z","message":{"role":"assistant","thinking":"First, I will consider relevant factors."},"done":false}
{"model":"gpt-oss:20b","created_at":"2025-08-08T10:00:02Z","message":{"role":"assistant","content":"Here is the answer:"},"done":false}
{"model":"gpt-oss:20b","created_at":"2025-08-08T10:00:03Z","message":{"role":"assistant","content":" You should bring a light jacket."},"done":false}
{"model":"gpt-oss:20b","created_at":"2025-08-08T10:00:04Z","message":{"role":"assistant","content":" Have a great day!"},"done_reason":"stop","done":true}



================================================
FILE: tests/Fixtures/ollama/stream-with-thinking-enabled-1.sse
================================================
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.667108Z","message":{"role":"assistant","content":"","thinking":"The"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.684524Z","message":{"role":"assistant","content":"","thinking":" user"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.701667Z","message":{"role":"assistant","content":"","thinking":" says"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.71886Z","message":{"role":"assistant","content":"","thinking":" \""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.736089Z","message":{"role":"assistant","content":"","thinking":"Test"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.753439Z","message":{"role":"assistant","content":"","thinking":" prompt"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.770819Z","message":{"role":"assistant","content":"","thinking":"\"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.788091Z","message":{"role":"assistant","content":"","thinking":" Lik"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.805511Z","message":{"role":"assistant","content":"","thinking":"ely"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.822954Z","message":{"role":"assistant","content":"","thinking":" they"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.840431Z","message":{"role":"assistant","content":"","thinking":" are"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.857917Z","message":{"role":"assistant","content":"","thinking":" just"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.875196Z","message":{"role":"assistant","content":"","thinking":" testing"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.892832Z","message":{"role":"assistant","content":"","thinking":" the"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.909734Z","message":{"role":"assistant","content":"","thinking":" system"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.927064Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.944415Z","message":{"role":"assistant","content":"","thinking":" We"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.961806Z","message":{"role":"assistant","content":"","thinking":" should"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.979123Z","message":{"role":"assistant","content":"","thinking":" respond"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:06.996553Z","message":{"role":"assistant","content":"","thinking":" with"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.013833Z","message":{"role":"assistant","content":"","thinking":" a"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.031072Z","message":{"role":"assistant","content":"","thinking":" simple"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.048604Z","message":{"role":"assistant","content":"","thinking":" acknowledgment"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.065989Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.083194Z","message":{"role":"assistant","content":"","thinking":" Possibly"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.100672Z","message":{"role":"assistant","content":"","thinking":" \""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.11779Z","message":{"role":"assistant","content":"","thinking":"Sure"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.135359Z","message":{"role":"assistant","content":"","thinking":","},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.152932Z","message":{"role":"assistant","content":"","thinking":" how"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.170428Z","message":{"role":"assistant","content":"","thinking":" can"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.18784Z","message":{"role":"assistant","content":"","thinking":" I"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.205339Z","message":{"role":"assistant","content":"","thinking":" help"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.222734Z","message":{"role":"assistant","content":"","thinking":"?\""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.240377Z","message":{"role":"assistant","content":"","thinking":" or"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.257354Z","message":{"role":"assistant","content":"","thinking":" \""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.274753Z","message":{"role":"assistant","content":"","thinking":"Testing"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.292153Z","message":{"role":"assistant","content":"","thinking":" successful"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.309506Z","message":{"role":"assistant","content":"","thinking":".\""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.327003Z","message":{"role":"assistant","content":"","thinking":" We"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.345032Z","message":{"role":"assistant","content":"","thinking":" can"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.362477Z","message":{"role":"assistant","content":"","thinking":" respond"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.379944Z","message":{"role":"assistant","content":"","thinking":" politely"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.397354Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.414811Z","message":{"role":"assistant","content":"","thinking":" No"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.432197Z","message":{"role":"assistant","content":"","thinking":" special"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.449737Z","message":{"role":"assistant","content":"","thinking":" instructions"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.46725Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.59017Z","message":{"role":"assistant","content":"Sure"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.607209Z","message":{"role":"assistant","content":" thing"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.624598Z","message":{"role":"assistant","content":"!"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.641931Z","message":{"role":"assistant","content":" Let"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.659476Z","message":{"role":"assistant","content":" me"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.676953Z","message":{"role":"assistant","content":" know"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.694496Z","message":{"role":"assistant","content":" what"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.711885Z","message":{"role":"assistant","content":" you'd"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.729075Z","message":{"role":"assistant","content":" like"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.746329Z","message":{"role":"assistant","content":" to"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.763565Z","message":{"role":"assistant","content":" test"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.780884Z","message":{"role":"assistant","content":" or"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.798117Z","message":{"role":"assistant","content":" if"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.815504Z","message":{"role":"assistant","content":" there's"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.832785Z","message":{"role":"assistant","content":" anything"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.849896Z","message":{"role":"assistant","content":" specific"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.867129Z","message":{"role":"assistant","content":" you"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.884253Z","message":{"role":"assistant","content":" need"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.901457Z","message":{"role":"assistant","content":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:07.919075Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":2260690000,"load_duration":37414250,"prompt_eval_count":69,"prompt_eval_duration":18515250,"eval_count":76,"eval_duration":1302640791}



================================================
FILE: tests/Fixtures/ollama/stream-with-tools-1.sse
================================================
{"model":"qwen3:14b","created_at":"2025-06-09T17:58:55.337823Z","message":{"role":"assistant","content":"","tool_calls":[{"function":{"name":"weather","arguments":{"city":"Detroit"}}}]},"done":false}
{"model":"qwen3:14b","created_at":"2025-06-09T17:58:57.045402Z","message":{"role":"assistant","content":"","tool_calls":[{"function":{"index":1,"name":"search","arguments":{"query":"Detroit Tigers game time today"}}}]},"done":false}
{"model":"qwen3:14b","created_at":"2025-06-09T17:58:57.192416Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":23595672042,"load_duration":24478458,"prompt_eval_count":218,"prompt_eval_duration":339942708,"eval_count":306,"eval_duration":23230435042}



================================================
FILE: tests/Fixtures/ollama/stream-with-tools-2.sse
================================================
{"model":"qwen3:14b","created_at":"2025-06-09T17:59:08.696694Z","message":{"role":"assistant","content":"","tool_calls":[{"function":{"name":"weather","arguments":{"city":"Detroit"}}}]},"done":false}
{"model":"qwen3:14b","created_at":"2025-06-09T17:59:08.84624Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":11625957583,"load_duration":9550375,"prompt_eval_count":263,"prompt_eval_duration":392967209,"eval_count":152,"eval_duration":11221520708}



================================================
FILE: tests/Fixtures/ollama/stream-with-tools-3.sse
================================================
{"model":"qwen3:14b","created_at":"2025-06-09T17:59:23.284159Z","message":{"role":"assistant","content":"\u003cthink\u003e\nOkay, let me figure out how to answer the user's question. They asked two things: the time of the Tigers game in Detroit and whether they should wear a coat.\n\nFirst, I called the search function to find the game time. The response came back as 3pm today. That's straightforward. \n\nNext, I needed to check the weather in Detroit. I used the weather function, which said it's 75° and sunny. Since the temperature is relatively warm and sunny, wearing a coat probably isn't necessary. \n\nPutting it all together: the game is at 3pm, and the weather is nice, so the user shouldn't need a coat. I should present this information clearly and concisely.\n\u003c/think\u003e\n\nThe Detroit Tigers game is today at 3pm, and the weather in Detroit will be 75° and sunny. You shouldn't need a coat for the game!"},"done_reason":"stop","done":true,"total_duration":14406706083,"load_duration":10039625,"prompt_eval_count":306,"prompt_eval_duration":394184458,"eval_count":188,"eval_duration":13998747458}



================================================
FILE: tests/Fixtures/ollama/stream-without-thinking-1.sse
================================================
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.224713Z","message":{"role":"assistant","content":"","thinking":"The"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.242057Z","message":{"role":"assistant","content":"","thinking":" user"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.25944Z","message":{"role":"assistant","content":"","thinking":" says"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.276782Z","message":{"role":"assistant","content":"","thinking":" \""},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.294039Z","message":{"role":"assistant","content":"","thinking":"Test"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.311418Z","message":{"role":"assistant","content":"","thinking":" prompt"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.328789Z","message":{"role":"assistant","content":"","thinking":"\"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.346213Z","message":{"role":"assistant","content":"","thinking":" Lik"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.363495Z","message":{"role":"assistant","content":"","thinking":"ely"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.380935Z","message":{"role":"assistant","content":"","thinking":" wants"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.398309Z","message":{"role":"assistant","content":"","thinking":" a"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.415735Z","message":{"role":"assistant","content":"","thinking":" response"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.43273Z","message":{"role":"assistant","content":"","thinking":" that"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.450025Z","message":{"role":"assistant","content":"","thinking":" tests"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.46739Z","message":{"role":"assistant","content":"","thinking":" the"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.484812Z","message":{"role":"assistant","content":"","thinking":" system"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.50246Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.519451Z","message":{"role":"assistant","content":"","thinking":" So"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.536723Z","message":{"role":"assistant","content":"","thinking":" respond"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.554117Z","message":{"role":"assistant","content":"","thinking":" accordingly"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.571432Z","message":{"role":"assistant","content":"","thinking":","},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.588754Z","message":{"role":"assistant","content":"","thinking":" maybe"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.606074Z","message":{"role":"assistant","content":"","thinking":" a"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.623347Z","message":{"role":"assistant","content":"","thinking":" simple"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.640699Z","message":{"role":"assistant","content":"","thinking":" acknowledgement"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.658134Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.675567Z","message":{"role":"assistant","content":"","thinking":" Probably"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.692966Z","message":{"role":"assistant","content":"","thinking":" just"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.710427Z","message":{"role":"assistant","content":"","thinking":" respond"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.727876Z","message":{"role":"assistant","content":"","thinking":" that"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.745053Z","message":{"role":"assistant","content":"","thinking":" it"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.762417Z","message":{"role":"assistant","content":"","thinking":" is"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.779876Z","message":{"role":"assistant","content":"","thinking":" working"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.79733Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.814716Z","message":{"role":"assistant","content":"","thinking":" Let's"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.832188Z","message":{"role":"assistant","content":"","thinking":" do"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.849602Z","message":{"role":"assistant","content":"","thinking":" a"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.868523Z","message":{"role":"assistant","content":"","thinking":" short"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.884172Z","message":{"role":"assistant","content":"","thinking":" answer"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:08.901655Z","message":{"role":"assistant","content":"","thinking":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.023758Z","message":{"role":"assistant","content":"Got"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.041145Z","message":{"role":"assistant","content":" it"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.058522Z","message":{"role":"assistant","content":"!"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.075849Z","message":{"role":"assistant","content":" The"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.092352Z","message":{"role":"assistant","content":" system"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.109587Z","message":{"role":"assistant","content":" is"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.127038Z","message":{"role":"assistant","content":" up"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.144289Z","message":{"role":"assistant","content":" and"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.161743Z","message":{"role":"assistant","content":" running"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.179233Z","message":{"role":"assistant","content":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.196657Z","message":{"role":"assistant","content":" Let"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.214207Z","message":{"role":"assistant","content":" me"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.23185Z","message":{"role":"assistant","content":" know"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.2491Z","message":{"role":"assistant","content":" what"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.266734Z","message":{"role":"assistant","content":" you"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.284313Z","message":{"role":"assistant","content":"’d"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.301764Z","message":{"role":"assistant","content":" like"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.319344Z","message":{"role":"assistant","content":" to"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.336913Z","message":{"role":"assistant","content":" try"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.354115Z","message":{"role":"assistant","content":" next"},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.371514Z","message":{"role":"assistant","content":"."},"done":false}
{"model":"gpt-oss","created_at":"2025-08-14T14:53:09.388802Z","message":{"role":"assistant","content":""},"done_reason":"stop","done":true,"total_duration":1455899000,"load_duration":29496583,"prompt_eval_count":69,"prompt_eval_duration":18515458,"eval_count":71,"eval_duration":1215688375}



================================================
FILE: tests/Fixtures/ollama/structured-1.json
================================================
{"model":"deepseek-r1:14b-qwen-distill-q8_0","created_at":"2025-02-02T22:23:51.958876Z","message":{"role":"assistant","content":"{ \"name\": \"Sarah Chen\", \"hobbies\": [\"rock climbing\", \"photography\"], \"open_source\": [\"Laravel Telescope\", \"Laravel Workflow Manager\"] }\n  \t\t\t\t\t\t \t\t\t\t\t"},"done_reason":"stop","done":true,"total_duration":9557300125,"load_duration":571185292,"prompt_eval_count":360,"prompt_eval_duration":3923000000,"eval_count":42,"eval_duration":4883000000}


================================================
FILE: tests/Fixtures/ollama/structured-with-multiple-tools-structured-mode-1.json
================================================
{"id":"chatcmpl-764","object":"chat.completion","created":1733488441,"model":"qwen2.5:14b","system_fingerprint":"fp_ollama","choices":[{"index":0,"message":{"role":"assistant","content":"","tool_calls":[{"id":"call_r0zkanyx","index":0,"type":"function","function":{"name":"search","arguments":"{\"query\":\"tigers game time today\"}"}},{"id":"call_8yafsp91","index":0,"type":"function","function":{"name":"weather","arguments":"{\"city\":\"Detroit\"}"}}]},"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":372,"completion_tokens":42,"total_tokens":414}}



================================================
FILE: tests/Fixtures/ollama/structured-with-multiple-tools-structured-mode-2.json
================================================
{"id":"chatcmpl-92","object":"chat.completion","created":1733488443,"model":"qwen2.5:14b","system_fingerprint":"fp_ollama","choices":[{"index":0,"message":{"role":"assistant","content":"{\n    \"weather\": \"sunny, 90°\",\n    \"game_time\": \"3pm\",\n    \"coat_required\": false\n}"},"finish_reason":"stop"}],"usage":{"prompt_tokens":449,"completion_tokens":32,"total_tokens":481}}



================================================
FILE: tests/Fixtures/ollama/text-image-from-base64-1.json
================================================
{"model":"llava-phi3","created_at":"2025-01-30T14:03:41.527911Z","message":{"role":"assistant","content":"The image features a stylized black and white representation of an emblem or crest. The primary shape in the composition is a diamond, which forms the central element. This diamond has its top slightly tilted to the right, adding a dynamic touch to the design. \n\nWithin this diamond-shaped frame, there are three smaller diamonds arranged vertically from top to bottom. The left and right ones appear larger than the one in the middle, creating an interesting visual hierarchy within the image itself. Each of these 'diamonds' has a thin outline that follows their shape, enhancing the crispness of the design.\n\nThe entire composition is set against a white background, which contrasts sharply with the black outlines and fills, making the emblem stand out prominently. The image does not contain any text or other discernible objects. The relative positions of the shapes are clear and precise, contributing to the overall symmetry of the design. \n\nThis is a simple yet striking image that combines geometric shapes with a monochromatic color scheme to create an emblem-like effect."},"done_reason":"stop","done":true,"total_duration":6010799083,"load_duration":19870208,"prompt_eval_count":590,"prompt_eval_duration":244000000,"eval_count":240,"eval_duration":5745000000}


================================================
FILE: tests/Fixtures/ollama/text-with-thinking-enabled-1.json
================================================
{"model":"gpt-oss","created_at":"2025-08-14T14:52:55.790953Z","message":{"role":"assistant","content":"Got it! How can I help you with your test?","thinking":"User just says \"Test prompt\". We need to respond appropriately. Could be acknowledging the test. The instructions say to never mention policy, etc. So respond with a friendly acknowledgement. Maybe ask if they'd like to test something."},"done_reason":"stop","done":true,"total_duration":4084081083,"load_duration":879580083,"prompt_eval_count":69,"prompt_eval_duration":2043606209,"eval_count":67,"eval_duration":1160172958}


================================================
FILE: tests/Fixtures/ollama/text-without-thinking-1.json
================================================
{"model":"qwen2.5:14b","created_at":"2025-08-14T14:48:18.746639Z","message":{"role":"assistant","content":"Sure! How can I assist you today? Do you have any specific questions or topics in mind that you'd like to discuss?"},"done_reason":"stop","done":true,"total_duration":11819726709,"load_duration":10941451750,"prompt_eval_count":31,"prompt_eval_duration":235061375,"eval_count":27,"eval_duration":642107625}


================================================
FILE: tests/Fixtures/openai/anyof-structured-1.json
================================================
{
  "id": "resp_anyof_test_1",
  "object": "response",
  "created_at": 1741990325,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_anyof_test_1",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"title\":\"The Future of AI: Transforming Our World\",\"items\":[{\"type\":\"text\",\"text\":\"AI is revolutionizing every aspect of our lives, from healthcare to transportation.\",\"word_count\":13},{\"type\":\"image\",\"url\":\"https://example.com/ai-robot.jpg\",\"format\":\"jpg\",\"is_public\":true}]}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 150,
    "output_tokens": 75,
    "total_tokens": 225
  },
  "service_tier": "default",
  "system_fingerprint": "fp_eb9dce56a8"
}


================================================
FILE: tests/Fixtures/openai/audio-from-base64-1.json
================================================
{"text":"by that conference. So I think that's a good excuse to be on the newsletter, too, is like, yeah, find out about 1.0 as soon as possible. Yeah, totally. Yeah, I like that idea. Then that gets you not as much pressure for tagging 1.0 before you go to Larikon. It gets an added benefit of getting people on the newsletter and a little bit more exposure in there. And then in the meantime before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Yeah. Yeah. I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might I might switch providers right before I pull the trigger on it. So that's that's something I'm gonna have to look at and maybe I'll I'll work on on the plane or something. I'm on my way out to Denver. I know it's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick and there's a lot I want to do. So, yeah, maybe I don't sleep tonight. Yeah. But even if you just like captured email addresses like you can always export them, import them into the new place anyways. Yep. Yeah. A hundred percent. So cool, man. Moving on from newsletters. I think you had added something here about cloud custom commands and that's something that we talked about, I think last week a little bit and maybe starting to find some excuses for using slash custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, OK, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans it basically like re-initiates the the cloud MD file. It reads what's there. It looks at the application, sees any new like dependencies or commands or whatever the case is and updates anything that it deems important to add back to that markdown file. And it's just nice if you have like a repo that has a lot of development, a lot of people working in it, and you don't always want to capture every single new like merge or rebase like every other day to it. So maybe your updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like, oh, rescan the repo and do this and that and the other thing like now this will just take care of it. So that was I think the first one that I made. So that one's been really helpful refreshing everything because the first time I ran it, it picked up like I think I last time I refreshed it was I don't know, three, four weeks ago. So I found like a whole bunch more stuff. It updated like architecture changes, like a whole bunch of things to it. So that's been really helpful. Probably gonna run that like on a weekly basis now on all the repos that we're working on. The other one is what I just named like a branch context. It's like I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here. And then we can either work towards something else together or I'm asking you for why did this change or why did that change or whatever the case is. It's just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details that you want? No, man. I think that sounds great. Like those are very useful things to have as slash commands. Yeah. I'm still personally finding my own use cases for them. I haven't dove too far into it yet. But maybe after Laracon, I'll spend a little time coming up with some stuff. But I think those are I think it serves as some decent inspiration for some other slash commands I'm thinking up right now. So yeah. What else you got? Um, yeah. So the next one, which I do a lot is PR reviews for others and coming into like a new tech stack. Like there's some things I am just not aware about or like best practices or whatever. So there's a default slash review command that comes out of the box and cloud code. And that gives a decent understanding. Like it'll tell you, you know, what's changed, what maybe some of the","usage":{"type":"duration","seconds":317}}


================================================
FILE: tests/Fixtures/openai/audio-from-path-1.json
================================================
{"text":"by that conference. So I think that's a good excuse to be on the newsletter, too, is like, yeah, find out about 1.0 as soon as possible. Yeah, totally. Yeah, I like that idea. Then that gets you not as much pressure for tagging 1.0 before you go to Larikon. It gets an added benefit of getting people on the newsletter and a little bit more exposure in there. And then in the meantime before you can, I don't know, maybe start drafting up newsletter launch email number one. Yeah. Yeah. Yeah. I might. Right now I'm using button down email for everything. May consider switching over to Bento just because Aaron loves it. And I like using things that people recommend. So. Yeah. I might I might switch providers right before I pull the trigger on it. So that's that's something I'm gonna have to look at and maybe I'll I'll work on on the plane or something. I'm on my way out to Denver. I know it's just getting close, man. I leave on Sunday. It's Thursday. So this is all coming up really quick and there's a lot I want to do. So, yeah, maybe I don't sleep tonight. Yeah. But even if you just like captured email addresses like you can always export them, import them into the new place anyways. Yep. Yeah. A hundred percent. So cool, man. Moving on from newsletters. I think you had added something here about cloud custom commands and that's something that we talked about, I think last week a little bit and maybe starting to find some excuses for using slash custom slash commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So this was definitely prompted from last week's conversation. And as I'm working through the week, I was like, OK, what can I possibly make a custom command for? So I basically started off with two things. I created like a refresh repo command, which basically like you run it, it scans it basically like re-initiates the the cloud MD file. It reads what's there. It looks at the application, sees any new like dependencies or commands or whatever the case is and updates anything that it deems important to add back to that markdown file. And it's just nice if you have like a repo that has a lot of development, a lot of people working in it, and you don't always want to capture every single new like merge or rebase like every other day to it. So maybe your updates running that like the repo refresh like once a week or something like that would be good because then you don't have to type out like, oh, rescan the repo and do this and that and the other thing like now this will just take care of it. So that was I think the first one that I made. So that one's been really helpful refreshing everything because the first time I ran it, it picked up like I think I last time I refreshed it was I don't know, three, four weeks ago. So I found like a whole bunch more stuff. It updated like architecture changes, like a whole bunch of things to it. So that's been really helpful. Probably gonna run that like on a weekly basis now on all the repos that we're working on. The other one is what I just named like a branch context. It's like I'm either switching to a branch that I'm working on or pulling down for a review or something like that of like the repo refreshes for main branch. And then when I'm going into something else like scan for changes, tell me what's in the last handful of commits and kind of refresh your understanding of what has changed in the repo in here. And then we can either work towards something else together or I'm asking you for why did this change or why did that change or whatever the case is. It's just refreshing the immediate context for that branch. So that's been helpful as well. That's sick. Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions on either one of those or any specific details that you want? No, man. I think that sounds great. Like those are very useful things to have as slash commands. Yeah. I'm still personally finding my own use cases for them. I haven't dove too far into it yet. But maybe after Laracon, I'll spend a little time coming up with some stuff. But I think those are I think it serves as some decent inspiration for some other slash commands I'm thinking up right now. So yeah. What else you got? Um, yeah. So the next one, which I do a lot is PR reviews for others and coming into like a new tech stack. Like there's some things I am just not aware about or like best practices or whatever. So there's a default slash review command that comes out of the box and cloud code. And that gives a decent understanding. Like it'll tell you, you know, what's changed, what maybe some of the","usage":{"type":"duration","seconds":317}}


================================================
FILE: tests/Fixtures/openai/audio-from-path-vtt-1.json
================================================
WEBVTT

00:00:00.000 --> 00:00:08.640
by that conference. So I think that's a good excuse to be on the newsletter, too, is like,

00:00:08.640 --> 00:00:15.440
yeah, find out about 1.0 as soon as possible. Yeah, totally. Yeah, I like that idea. Then

00:00:15.440 --> 00:00:23.760
that gets you not as much pressure for tagging 1.0 before you go to Larikon. It gets an added

00:00:23.760 --> 00:00:29.120
benefit of getting people on the newsletter and a little bit more exposure in there. And then

00:00:30.240 --> 00:00:36.560
in the meantime before you can, I don't know, maybe start drafting up newsletter launch email

00:00:36.560 --> 00:00:45.040
number one. Yeah. Yeah. Yeah. I might. Right now I'm using button down email for everything. May

00:00:45.040 --> 00:00:51.599
consider switching over to Bento just because Aaron loves it. And I like using things that

00:00:51.599 --> 00:00:57.680
people recommend. So. Yeah. I might I might switch providers right before I pull the trigger on it.

00:00:57.680 --> 00:01:01.919
So that's that's something I'm gonna have to look at and maybe I'll I'll work on on the plane or

00:01:01.919 --> 00:01:06.879
something. I'm on my way out to Denver. I know it's just getting close, man. I leave on Sunday.

00:01:07.599 --> 00:01:12.879
It's Thursday. So this is all coming up really quick and there's a lot I want to do. So,

00:01:13.440 --> 00:01:17.760
yeah, maybe I don't sleep tonight. Yeah. But even if you just like captured email

00:01:17.760 --> 00:01:22.239
addresses like you can always export them, import them into the new place anyways.

00:01:23.120 --> 00:01:28.480
Yep. Yeah. A hundred percent. So cool, man. Moving on from newsletters. I think you had

00:01:28.480 --> 00:01:33.599
added something here about cloud custom commands and that's something that we talked about, I think

00:01:33.599 --> 00:01:40.000
last week a little bit and maybe starting to find some excuses for using slash custom slash

00:01:40.000 --> 00:01:45.519
commands and stuff. So I'd love to hear about your experience here. Yeah, definitely. So

00:01:46.160 --> 00:01:51.760
this was definitely prompted from last week's conversation. And as I'm working through the

00:01:51.760 --> 00:01:58.639
week, I was like, OK, what can I possibly make a custom command for? So I basically started off

00:01:59.279 --> 00:02:07.599
with two things. I created like a refresh repo command, which basically like you run it, it

00:02:07.599 --> 00:02:17.759
scans it basically like re-initiates the the cloud MD file. It reads what's there. It looks at the

00:02:17.759 --> 00:02:23.919
application, sees any new like dependencies or commands or whatever the case is and updates

00:02:23.919 --> 00:02:31.279
anything that it deems important to add back to that markdown file. And it's just nice if you

00:02:31.279 --> 00:02:37.279
have like a repo that has a lot of development, a lot of people working in it, and you don't always

00:02:37.279 --> 00:02:44.559
want to capture every single new like merge or rebase like every other day to it. So maybe your

00:02:44.880 --> 00:02:50.720
updates running that like the repo refresh like once a week or something like that would be good

00:02:50.720 --> 00:02:55.440
because then you don't have to type out like, oh, rescan the repo and do this and that and the other

00:02:55.440 --> 00:03:00.720
thing like now this will just take care of it. So that was I think the first one that I made. So

00:03:00.720 --> 00:03:04.639
that one's been really helpful refreshing everything because the first time I ran it,

00:03:04.639 --> 00:03:10.080
it picked up like I think I last time I refreshed it was I don't know, three, four weeks ago.

00:03:10.080 --> 00:03:14.720
So I found like a whole bunch more stuff. It updated like architecture changes, like a whole

00:03:15.440 --> 00:03:20.240
bunch of things to it. So that's been really helpful. Probably gonna run that like on a

00:03:20.240 --> 00:03:28.080
weekly basis now on all the repos that we're working on. The other one is what I just named

00:03:28.080 --> 00:03:33.199
like a branch context. It's like I'm either switching to a branch that I'm working on

00:03:33.199 --> 00:03:41.199
or pulling down for a review or something like that of like the repo refreshes for main branch.

00:03:41.199 --> 00:03:45.919
And then when I'm going into something else like scan for changes, tell me what's in the last

00:03:45.919 --> 00:03:50.960
handful of commits and kind of refresh your understanding of what has changed in the repo

00:03:50.960 --> 00:03:56.960
in here. And then we can either work towards something else together or I'm asking you for

00:03:56.960 --> 00:04:01.759
why did this change or why did that change or whatever the case is. It's just refreshing

00:04:01.759 --> 00:04:06.240
the immediate context for that branch. So that's been helpful as well.

00:04:06.240 --> 00:04:06.800
That's sick.

00:04:07.520 --> 00:04:12.559
Yeah. So I guess I'll pause there because then I have another whole workflow. So any questions

00:04:12.559 --> 00:04:17.440
on either one of those or any specific details that you want?

00:04:17.440 --> 00:04:21.440
No, man. I think that sounds great. Like those are very useful things to have as slash commands.

00:04:22.239 --> 00:04:32.880
Yeah. I'm still personally finding my own use cases for them. I haven't dove too far into it yet.

00:04:34.000 --> 00:04:40.320
But maybe after Laracon, I'll spend a little time coming up with some stuff. But I think those are

00:04:41.359 --> 00:04:45.839
I think it serves as some decent inspiration for some other slash commands I'm thinking

00:04:45.839 --> 00:04:47.839
up right now. So yeah. What else you got?

00:04:48.799 --> 00:04:56.239
Um, yeah. So the next one, which I do a lot is PR reviews for others and coming into like a new

00:04:56.239 --> 00:05:02.000
tech stack. Like there's some things I am just not aware about or like best practices or whatever.

00:05:02.000 --> 00:05:09.600
So there's a default slash review command that comes out of the box and cloud code. And that

00:05:09.600 --> 00:05:16.480
gives a decent understanding. Like it'll tell you, you know, what's changed, what maybe some of the




================================================
FILE: tests/Fixtures/openai/cache-usage-automatic-caching-1.json
================================================
{
  "id": "resp_BOicZ2rw1bLAh8imvckL3DZG6bqDK",
  "object": "response",
  "created_at": 1745231095,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "This text appears to be a collection of randomly generated sentences often used to simulate Latin text known as \"Lorem Ipsum.\" It's a type of placeholder text commonly used in the design and typesetting industry to visualize the layout of a document without relying on meaningful content.\n\nIf you're looking for further explanation or specific information regarding any legal, technical, or thematic content, please provide more context or details.",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 1111,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 78,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 1189
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f7a584cf1f"
}



================================================
FILE: tests/Fixtures/openai/cache-usage-automatic-caching-2.json
================================================
{
  "id": "resp_BOicbvFZ0HMexHadbYMkZGU5ct6hB",
  "object": "response",
  "created_at": 1745231097,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "This text appears to be a collection of randomly generated sentences often used to simulate Latin text known as \"Lorem Ipsum.\" It's a type of placeholder text commonly used in the design and typesetting industry to visualize the layout of a document without relying on meaningful content.\n\nIf you're looking for further explanation or specific information regarding any legal, technical, or thematic content, please provide more context or details.",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 1111,
    "input_tokens_details": {
      "cached_tokens": 1024
    },
    "output_tokens": 109,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 1220
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f7a584cf1f"
}



================================================
FILE: tests/Fixtures/openai/embeddings-file-1.json
================================================
{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [
        -0.011318467,
        0.00005302356,
        -0.02327364,
        -0.0056050452,
        0.028882071,
        0.01641889,
        -0.0032546518,
        -0.022948513,
        -0.01610731,
        -0.03110377,
        0.0074779093,
        0.01015343,
        -0.03370478,
        -0.00933384,
        0.015985386,
        0.010126336,
        0.028015066,
        0.0029041248,
        0.0052325046,
        -0.009442216,
        0.007511777,
        -0.008148483,
        0.009476082,
        0.0039827996,
        -0.019141823,
        -0.01786841,
        0.0069190986,
        -0.024316752,
        -0.019060541,
        0.0063264198,
        0.016649187,
        -0.004870124,
        -0.0095573645,
        0.0030548344,
        -0.01517257,
        0.02153963,
        0.036332887,
        0.007897864,
        0.0074508158,
        0.001231078,
        0.02220343,
        0.0006684567,
        0.025386961,
        -0.009320293,
        0.006505917,
        0.025834009,
        -0.0047752955,
        0.002208151,
        -0.012734122,
        -0.00434518,
        -0.0009906198,
        0.016120855,
        -0.008927432,
        -0.016161496,
        0.012300619,
        -0.00984185,
        -0.012707028,
        0.017272346,
        0.016391795,
        0.011433615,
        0.0035763916,
        0.011758742,
        -0.0045348373,
        0.011758742,
        -0.02667392,
        -0.01946695,
        -0.004893831,
        0.036956046,
        -0.007992693,
        -0.0061299894,
        -0.001549431,
        0.005063168,
        0.026795842,
        -0.0059843594,
        0.012815403,
        -0.0051444494,
        -0.007538871,
        -0.00601484,
        0.007599832,
        -0.009611553,
        0.015782183,
        -0.016811749,
        -0.010451462,
        0.038012706,
        -0.015538338,
        -0.004219871,
        -0.0023266864,
        0.015578978,
        -0.01641889,
        -0.034002814,
        -0.025712088,
        -0.009388028,
        -0.016093763,
        0.049527604,
        0.019968186,
        0.02313817,
        0.010370181,
        0.010085695,
        -0.005594885,
        0.0021590432,
        -0.013445335,
        0.0051071956,
        -0.02706678,
        -0.0148745375,
        -0.019141823,
        -0.0018508503,
        0.007064728,
        -0.01587701,
        0.030941205,
        0.014820349,
        -0.017583925,
        0.021566724,
        -0.025495335,
        -0.033921532,
        0.012537691,
        0.0042266445,
        0.030751549,
        -0.021553177,
        -0.0010465009,
        -0.01977853,
        0.0183561,
        0.009950225,
        0.017028501,
        0.0030379007,
        0.04034278,
        -0.0026043986,
        -0.0063602873,
        -0.021905398,
        -0.026877124,
        -0.009232238,
        -0.003274972,
        -0.00847361,
        0.008040108,
        0.018112255,
        -0.013045701,
        0.02273176,
        -0.051776394,
        -0.0010295672,
        -0.02685003,
        0.0067396015,
        0.017787129,
        0.014698427,
        0.008270405,
        0.035005286,
        -0.0007260312,
        0.02720225,
        0.017624566,
        -0.021959586,
        -0.01610731,
        0.0015985386,
        0.028502757,
        -0.013540164,
        -0.0070173135,
        0.019968186,
        -0.007538871,
        0.020753909,
        0.0007129076,
        0.0269855,
        -0.0076811137,
        -0.020157844,
        0.04516549,
        0.04020731,
        -0.0027093876,
        0.0033884277,
        0.007979146,
        0.028096348,
        0.009062901,
        -0.00048303299,
        -0.0056795534,
        -0.014590052,
        -0.021688648,
        0.026511356,
        -0.033244185,
        0.015226758,
        -0.035194945,
        0.000015491663,
        0.031374708,
        -0.00816203,
        0.038852617,
        -0.04427139,
        -0.00785045,
        0.019074088,
        -0.004653373,
        0.018261272,
        -0.038093988,
        -0.020225577,
        0.010674987,
        -0.0022606452,
        0.023856157,
        -0.009970546,
        0.008060427,
        0.026687467,
        0.0349511,
        -0.01761102,
        -0.5886957,
        0.004514517,
        -0.007559191,
        -0.016527263,
        -0.005970813,
        -0.0029396855,
        -0.009916359,
        -0.0027246277,
        -0.013133756,
        0.036305793,
        0.00021050671,
        -0.015240305,
        -0.019426309,
        0.003122569,
        -0.0035628446,
        -0.01817999,
        -0.034002814,
        -0.028827883,
        -0.0049006045,
        0.005588112,
        -0.013858517,
        0.014535864,
        -0.026335247,
        0.01566026,
        -0.022271166,
        0.03446341,
        0.013323413,
        0.018532211,
        0.006807336,
        -0.0031953838,
        -0.021133222,
        -0.010004413,
        -0.016893031,
        -0.012801856,
        0.045842838,
        0.01954823,
        -0.01116945,
        0.023598766,
        0.014346207,
        0.023585219,
        -0.036630917,
        0.014170096,
        0.033542216,
        0.0002233128,
        0.018965712,
        0.005313786,
        0.023327826,
        0.008656493,
        -0.009658966,
        0.031510178,
        0.0006269692,
        0.03503238,
        0.030507702,
        0.00093473867,
        0.0077962624,
        0.006387381,
        0.043756608,
        -0.00020193403,
        0.009719928,
        0.010065375,
        -0.025915291,
        -0.011379427,
        -0.009110316,
        -0.011684233,
        0.01597184,
        0.027554471,
        0.0033782676,
        -0.0053476538,
        -0.014251378,
        -0.042537384,
        0.01601248,
        0.020591345,
        0.0112100905,
        -0.030995393,
        0.0012107575,
        -0.0032546518,
        0.037525017,
        -0.006577038,
        0.020713268,
        0.023883251,
        0.021079035,
        -0.022108601,
        -0.044650707,
        -0.0021082421,
        0.011758742,
        -0.006936032,
        -0.003015887,
        0.0011464095,
        -0.00833814,
        0.019345026,
        0.015714448,
        0.017719394,
        -0.016879484,
        -0.016622093,
        0.010268578,
        0.01694722,
        -0.005367974,
        -0.003925225,
        -0.012693481,
        -0.019615965,
        0.0052358913,
        0.015240305,
        0.00021558681,
        0.03635998,
        0.053103995,
        -0.02450641,
        -0.01548415,
        0.0009084915,
        0.024980552,
        -0.01716397,
        0.003481563,
        -0.0022335513,
        -0.021133222,
        -0.039719623,
        -0.013872064,
        -0.02468252,
        0.027269986,
        0.017434908,
        0.01382465,
        -0.0032851323,
        0.003015887,
        -0.0031378095,
        0.015687354,
        -0.006092735,
        0.03048061,
        0.01817999,
        0.015131929,
        -0.043892078,
        -0.013370827,
        0.018220631,
        -0.017082687,
        -0.019737888,
        0.022569198,
        -0.011440389,
        0.02556307,
        0.021661554,
        0.024696067,
        0.015362227,
        -0.0070918216,
        -0.009469309,
        -0.005269759,
        0.0048023895,
        -0.01398044,
        -0.0004758362,
        -0.012381901,
        -0.049906917,
        -0.018884432,
        0.0062519116,
        0.004206324,
        -0.03132052,
        0.0037897557,
        -0.003989573,
        0.01583637,
        0.00798592,
        0.0098350765,
        -0.006258685,
        -0.0063433535,
        -0.026308153,
        -0.0190199,
        -0.042401914,
        0.032404274,
        0.012192244,
        -0.023314279,
        0.025671447,
        0.0008729308,
        -0.0154164145,
        -0.012815403,
        0.022772402,
        0.0034984967,
        -0.028990446,
        0.0006299326,
        0.0013284466,
        0.013391147,
        0.013323413,
        0.005046234,
        0.029071728,
        0.0044569424,
        -0.0050834883,
        0.0004699094,
        -0.0026501196,
        0.0071731033,
        0.027473189,
        -0.01782777,
        -0.012930552,
        0.016703375,
        0.0014351287,
        0.051668018,
        0.030101296,
        0.006157083,
        0.016960766,
        0.002795749,
        0.010248258,
        0.009130636,
        0.004311313,
        -0.030020013,
        0.023652952,
        -0.005439095,
        0.013275999,
        -0.0054289354,
        0.0026247192,
        -0.0064347954,
        0.0007628619,
        0.009774115,
        0.006715894,
        -0.018586399,
        -0.027771221,
        0.020279765,
        -0.012598651,
        0.011108489,
        0.007240838,
        -0.0029210583,
        -0.034382127,
        -0.033460937,
        0.018545758,
        0.0016501864,
        0.012781535,
        0.018058067,
        0.0046093455,
        -0.0075050034,
        -0.0039726393,
        0.008751322,
        -0.022542104,
        -0.027798316,
        -0.011657139,
        -0.018870885,
        0.023260092,
        -0.007024087,
        0.0019659994,
        -0.00026226023,
        -0.022027321,
        0.015565431,
        0.011989039,
        -0.0112100905,
        -0.018423835,
        -0.004128429,
        0.033054527,
        0.0050699413,
        -0.00749823,
        0.023788422,
        -0.019534685,
        -0.010796909,
        0.003283439,
        -0.00250449,
        -0.025590165,
        0.03641417,
        0.00581841,
        0.015755089,
        -0.026687467,
        0.0069834464,
        -0.008270405,
        -0.013756915,
        0.034300845,
        -0.0135130705,
        -0.020740362,
        0.013655313,
        0.0008471069,
        0.014982913,
        0.009713154,
        0.0077962624,
        0.030670267,
        0.0062248176,
        -0.02048297,
        -0.002919365,
        0.030372234,
        0.0095573645,
        0.005591498,
        -0.010871417,
        -0.014942272,
        -0.031510178,
        -0.015280945,
        0.012442862,
        -0.0047651352,
        0.0129034575,
        -0.032404274,
        0.01694722,
        -0.010620799,
        0.01566026,
        0.02149899,
        -0.01933148,
        0.030914111,
        0.008778416,
        -0.03118505,
        0.031293426,
        0.0009237318,
        0.0021387227,
        -0.038419116,
        -0.004829483,
        0.017570378,
        -0.0030582212,
        -0.014549411,
        0.002531584,
        0.020401688,
        0.008358461,
        0.005500057,
        -0.0044433954,
        0.022664027,
        0.00032639652,
        -0.010735948,
        -0.0024418356,
        0.0013318333,
        -0.0026755203,
        0.01331664,
        -0.023964532,
        -0.00100078,
        0.028231818,
        -0.028123442,
        -0.06762631,
        -0.019399215,
        -0.005970813,
        -0.040667906,
        -0.015497697,
        0.013397921,
        -0.0023080595,
        -0.009740248,
        0.04351276,
        -0.0013445335,
        -0.00094235886,
        -0.0012996594,
        0.036956046,
        0.013574031,
        -0.0109594725,
        -0.014495223,
        -0.003684767,
        -0.005726968,
        0.03641417,
        0.014210737,
        -0.0007882624,
        -0.0027771222,
        -0.033162903,
        0.0032360246,
        -0.013445335,
        -0.015646713,
        -0.004155523,
        0.0068615237,
        -0.013926252,
        -0.02083519,
        0.011094942,
        -0.0054865098,
        0.040234406,
        0.00053849077,
        0.018748961,
        0.00075100834,
        -0.010410821,
        -0.005530537,
        0.04692659,
        0.00749823,
        -0.010261805,
        -0.005608432,
        0.009564138,
        0.0036542865,
        0.020930018,
        0.0016620399,
        -0.013275999,
        -0.035330415,
        -0.017583925,
        -0.008622626,
        0.019805623,
        0.024533505,
        0.001314053,
        0.034842722,
        0.013072794,
        -0.010119562,
        -0.0050055934,
        -0.008209445,
        0.009008713,
        0.0154299615,
        0.010864644,
        0.00005514027,
        -0.008053655,
        0.001771262,
        -0.024208378,
        0.027175156,
        -0.022081507,
        -0.011182996,
        -0.008832604,
        -0.0008221298,
        -0.017665207,
        0.00039730628,
        0.010106015,
        0.028963352,
        -0.016581452,
        0.006580425,
        -0.033596404,
        -0.040803377,
        -0.0074372687,
        -0.012232885,
        0.0022843524,
        -0.021905398,
        -0.02079455,
        -0.018478023,
        0.011840023,
        -0.0018203697,
        -0.019304385,
        0.010918831,
        0.00199648,
        -0.024479317,
        -0.0092661055,
        0.027107421,
        -0.010417595,
        0.020293312,
        -0.0134724295,
        -0.0010465009,
        0.014481676,
        -0.010546291,
        0.015687354,
        -0.029884543,
        0.03649545,
        -0.040640812,
        0.019832717,
        0.00021241175,
        0.026660373,
        0.009360934,
        -0.009862171,
        0.014955819,
        -0.023720687,
        0.006654933,
        0.009747022,
        -0.005801476,
        0.0010956086,
        -0.002079455,
        0.020266218,
        -0.0039353855,
        0.008195898,
        -0.021458348,
        -0.028448569,
        -0.06860169,
        0.01216515,
        -0.012700254,
        0.012402222,
        -0.00869036,
        -0.012456409,
        0.016066669,
        -0.023300733,
        -0.012767988,
        -0.0010058602,
        0.011359107,
        0.0037118609,
        0.020726815,
        0.0074914563,
        0.004951406,
        -0.007525324,
        0.002545131,
        -0.0047143344,
        -0.035357505,
        -0.02556307,
        -0.065133676,
        0.02556307,
        0.0027195476,
        -0.035059474,
        0.004694014,
        -0.0029261385,
        -0.021918945,
        0.0021082421,
        0.022677572,
        0.009923132,
        0.015931198,
        0.0018643973,
        -0.0074914563,
        -0.019412762,
        -0.02185121,
        -0.027635753,
        -0.02044233,
        -0.000899178,
        0.0012928859,
        -0.047305904,
        0.00880551,
        -0.014143003,
        0.0043316334,
        0.0112236375,
        -0.030643173,
        -0.002702614,
        -0.0075930585,
        0.009218691,
        0.010857871,
        -0.0017077608,
        0.005188477,
        -0.039827995,
        -0.0043180864,
        -0.023544578,
        -0.022718213,
        -0.0046398262,
        -0.028421475,
        0.03294615,
        0.005669393,
        0.046005398,
        -0.013242131,
        -0.00533072,
        0.024235472,
        -0.02569854,
        -0.00084837695,
        0.008744548,
        -0.013838197,
        0.00093643204,
        0.01130492,
        -0.013330187,
        0.03110377,
        0.03592648,
        -0.03866296,
        -0.0046059587,
        -0.00029274085,
        0.0046059587,
        -0.014170096,
        -0.018464476,
        -0.035005286,
        -0.016527263,
        0.0055542444,
        -0.012822176,
        -0.0018322233,
        -0.03175402,
        -0.0034426155,
        0.019263744,
        -0.00416907,
        0.033108715,
        0.010729174,
        0.008859697,
        -0.024452223,
        0.023246545,
        -0.0007323813,
        -0.0074779093,
        -0.010952699,
        0.0059369453,
        -0.03321709,
        -0.0020557477,
        0.01468488,
        -0.0012725655,
        0.022122148,
        0.015402868,
        -0.023056887,
        -0.0059064645,
        0.0055813384,
        -0.009848624,
        -0.011582632,
        0.008758095,
        -0.016039575,
        -0.0069698994,
        -0.006770082,
        -0.00023050961,
        -0.020902924,
        -0.02649781,
        0.03232299,
        -0.0076540196,
        0.014603599,
        -0.02852985,
        -0.02972198,
        0.0040708547,
        -0.025197303,
        0.012212564,
        0.04074919,
        -0.00088901777,
        0.014346207,
        -0.0107088545,
        0.014793255,
        -0.0029447656,
        0.0025806916,
        -0.016296966,
        0.033433843,
        0.03579101,
        0.032756496,
        0.0069969934,
        0.024845084,
        0.014955819,
        -0.044515237,
        -0.018315459,
        0.0036305792,
        -0.0154164145,
        0.008480383,
        -0.039719623,
        0.0024130482,
        -0.020279765,
        0.034625974,
        -0.027310627,
        0.017055593,
        -0.010688534,
        0.00012721421,
        -0.022704666,
        0.0050665545,
        0.025454696,
        -0.011569085,
        0.008311046,
        0.011982266,
        -0.00072899455,
        -0.005713421,
        0.010519197,
        0.017231705,
        0.023612313,
        0.03188949,
        -0.00837878,
        0.0065228506,
        0.031374708,
        -0.011765515,
        0.030616079,
        -0.0012437782,
        0.0076540196,
        0.026064308,
        -0.032919057,
        0.0046703066,
        0.01185357,
        -0.0062993257,
        -0.0014876231,
        -0.02013075,
        0.0013081261,
        0.011000114,
        -0.022393087,
        0.009611553,
        -0.011785836,
        0.009591232,
        -0.0067870156,
        -0.0047482015,
        -0.01800388,
        -0.02317881,
        -0.014143003,
        0.0018610106,
        0.004020054,
        -0.033488028,
        -0.012761215,
        -0.00044408554,
        -0.011826476,
        0.012226111,
        0.00483287,
        0.00886647,
        0.014088815,
        0.035276227,
        -0.0063162595,
        0.000095834,
        0.022013774,
        -0.013966893,
        -0.003532364,
        0.022528557,
        0.011921305,
        0.03278359,
        0.010539518,
        -0.020157844,
        -0.022487916,
        0.012896685,
        0.0025332773,
        -0.0002218311,
        0.02685003,
        0.005378134,
        -0.016567905,
        0.0066650934,
        0.012429316,
        -0.0046465998,
        0.0006430562,
        0.009069675,
        0.0014275085,
        -0.009428669,
        0.024289658,
        -0.011182996,
        0.003098862,
        -0.011711327,
        -0.0009931598,
        0.025847556,
        -0.018193537,
        -0.0196837,
        0.0074914563,
        -0.016147949,
        -0.0026399593,
        0.008040108,
        -0.028854977,
        0.01386529,
        -0.021065488,
        0.03221462,
        0.012429316,
        0.025535977,
        -0.012971193,
        0.022948513,
        0.018220631,
        0.003786369,
        -0.02003592,
        -0.0006781936,
        -0.0074575893,
        0.009252558,
        -0.023070434,
        -0.026132042,
        0.0020591344,
        0.07071501,
        0.02069972,
        -0.03175402,
        -0.030236764,
        -0.022894325,
        -0.022718213,
        -0.02083519,
        -0.024343846,
        0.0068886178,
        0.015064195,
        0.041724566,
        -0.013309866,
        0.03264812,
        -0.00867004,
        -0.0038405568,
        -0.018572852,
        0.016120855,
        0.0026924538,
        -0.012199017,
        -0.004602572,
        -0.025752729,
        -0.023612313,
        0.0073966277,
        0.012463182,
        -0.008764869,
        -0.010431142,
        0.012795082,
        0.0005554244,
        0.012043227,
        0.0011379428,
        -0.009929906,
        -0.0037525017,
        0.02489927,
        0.005940332,
        -0.026470715,
        -0.00785045,
        0.007220518,
        -0.020388141,
        0.01751619,
        -0.010282125,
        0.0068513635,
        -0.016215684,
        -0.0017729554,
        -0.01610731,
        -0.009232238,
        -0.014278472,
        0.008907111,
        0.015592525,
        -0.0086971335,
        -0.006617679,
        0.02216279,
        -0.017502643,
        -0.017394267,
        -0.0011133889,
        0.039259024,
        0.012056774,
        -0.009123863,
        0.019602418,
        -0.009442216,
        -0.028204724,
        0.007328893,
        0.0051410627,
        -0.014292019,
        0.010952699,
        0.00013155346,
        0.010139883,
        -0.03446341,
        0.019575324,
        0.050150763,
        0.008480383,
        0.0075930585,
        -0.0034392287,
        -0.014305566,
        -0.006143536,
        0.005367974,
        -0.0066955737,
        -0.03207915,
        0.019412762,
        0.009313519,
        -0.027662847,
        -0.006045321,
        0.032729402,
        0.036576733,
        0.0004036564,
        0.011426842,
        0.23885961,
        -0.009103542,
        -0.010857871,
        0.021905398,
        0.010200844,
        0.009327066,
        0.024167737,
        0.017949693,
        0.0047651352,
        -0.00005397608,
        0.001854237,
        -0.0054255486,
        -0.014400395,
        -0.0020168002,
        0.025861103,
        -0.022433728,
        -0.013519844,
        -0.015402868,
        0.001964306,
        -0.012144829,
        0.020103656,
        -0.019534685,
        -0.03454469,
        -0.031699833,
        0.028882071,
        0.002550211,
        -0.0063264198,
        0.00050420006,
        0.03145599,
        -0.009753795,
        -0.0053747473,
        0.010614025,
        0.023761328,
        0.043106355,
        -0.0078910915,
        -0.0118061565,
        0.019697247,
        0.00054949766,
        0.010715627,
        0.026809389,
        0.021336427,
        -0.013872064,
        -0.009814756,
        -0.042130977,
        -0.0006129989,
        0.008067201,
        -0.004663533,
        -0.022636933,
        -0.012964419,
        0.009069675,
        -0.0016730467,
        0.017258799,
        0.016283419,
        0.023910346,
        -0.0042774454,
        -0.0065296236,
        -0.022840137,
        0.019886903,
        0.00077767886,
        -0.016730469,
        -0.017787129,
        0.03048061,
        -0.039150648,
        0.012199017,
        -0.0143191125,
        0.0043824343,
        -0.018545758,
        -0.019656606,
        0.020767456,
        -0.00005003371,
        -0.016486622,
        0.0038100763,
        -0.011298146,
        0.02733772,
        -0.031537272,
        -0.04665565,
        -0.010702081,
        0.0005681247,
        0.024574144,
        0.018220631,
        0.014427489,
        0.019385668,
        0.003979413,
        -0.015985386,
        -0.025143117,
        -0.05852277,
        0.004964953,
        -0.008053655,
        -0.025576618,
        -0.006309486,
        -0.009882491,
        -0.020415235,
        -0.0038303966,
        0.00449081,
        -0.013580805,
        -0.0065871985,
        -0.010844324,
        -0.009448989,
        0.0137772355,
        -0.009733475,
        -0.030101296,
        0.048335474,
        0.008033334,
        -0.0066075185,
        -0.011338786,
        -0.0062993257,
        -0.018437382,
        -0.0050563943,
        -0.0050157537,
        0.009083222,
        0.006367061,
        -0.00012816674,
        0.01318117,
        -0.003657673,
        -0.004585638,
        -0.0043519535,
        -0.011433615,
        0.007599832,
        -0.00933384,
        -0.00783013,
        -0.007755622,
        0.011088168,
        -0.025414055,
        -0.01114913,
        0.0071460097,
        -0.015606072,
        -0.009733475,
        -0.0069563524,
        -0.030859923,
        0.006627839,
        0.009801209,
        -0.0025332773,
        0.012571558,
        0.017177517,
        0.0002080725,
        0.0003795259,
        -0.00046525264,
        0.007586285,
        -0.011006887,
        0.0076675666,
        0.008974846,
        0.002804216,
        -0.004815936,
        -0.017218158,
        0.020781003,
        -0.015050648,
        -0.0026365728,
        0.014644239,
        -0.00886647,
        -0.02003592,
        -0.056246884,
        0.023598766,
        0.0039082915,
        -0.001279339,
        -0.00050716347,
        -0.003098862,
        -0.01950759,
        0.0018237565,
        0.0066041322,
        0.01694722,
        -0.046899498,
        0.001436822,
        0.0050563943,
        0.033921532,
        0.017638113,
        -0.0112371845,
        -0.16960765,
        0.01386529,
        0.0009762262,
        -0.012381901,
        0.037958518,
        -0.0077759423,
        -0.00633658,
        -0.013045701,
        -0.016893031,
        0.01249705,
        -0.022596292,
        -0.02839438,
        -0.015050648,
        -0.008602305,
        -0.014237831,
        0.004538224,
        -0.00500898,
        -0.014413942,
        0.04565318,
        0.0059471056,
        0.03034514,
        -0.034219563,
        0.023720687,
        0.013675634,
        0.015985386,
        -0.0069292584,
        -0.004985273,
        0.033596404,
        0.0027551085,
        -0.06719281,
        -0.0267552,
        -0.01950759,
        0.0038981312,
        -0.012727348,
        0.022040868,
        0.017665207,
        0.03999056,
        0.011724874,
        -0.03308162,
        0.0040336004,
        0.051722206,
        0.022365993,
        -0.0006028387,
        -0.029071728,
        -0.009882491,
        0.015511244,
        0.029532325,
        -0.017719394,
        0.0001218166,
        0.007545644,
        0.042049695,
        -0.007193424,
        -0.016838843,
        -0.015809275,
        0.00052917725,
        -0.012788309,
        0.007958826,
        0.016351154,
        0.00018775208,
        0.013093115,
        0.008439742,
        -0.02649781,
        -0.0059606526,
        0.015511244,
        0.017841317,
        0.006285779,
        -0.029478136,
        0.018369647,
        -0.0014385154,
        0.026037214,
        -0.007240838,
        -0.015213211,
        0.0011946706,
        -0.023083981,
        0.023002699,
        0.0055644047,
        -0.021255145,
        -0.027744127,
        0.029830357,
        0.0028787241,
        -0.008995166,
        0.029207198,
        -0.023300733,
        0.01152167,
        -0.017042048,
        0.003061608,
        0.005256212,
        0.03999056,
        -0.007281479,
        0.006912325,
        0.019846264,
        -0.0004690627,
        -0.017312987,
        0.013154076,
        0.008372007,
        0.0016561131,
        0.033108715,
        -0.0069258716,
        0.01318117,
        -0.010939152,
        0.006295939,
        0.019439856,
        0.01298474,
        -0.024790896,
        0.018789602,
        -0.0066109053,
        -0.021038394,
        0.009611553,
        0.030236764,
        -0.00282623,
        -0.029098822,
        0.006123216,
        0.0012861124,
        0.015958292,
        -0.014657786,
        0.011772289,
        -0.015985386,
        -0.020428782,
        0.03508657,
        0.0035086568,
        0.03684767,
        0.012307392,
        -0.013580805,
        0.0267552,
        -0.004995433,
        -0.030670267,
        -0.086375274,
        -0.0314018,
        -0.00024088148,
        0.031591456,
        0.02118741,
        0.019453403,
        -0.014346207,
        0.011602952,
        -0.012131282,
        0.03161855,
        -0.010871417,
        -0.023449749,
        0.0067734686,
        0.003136116,
        0.023571672,
        -0.022284713,
        -0.018410288,
        -0.014427489,
        -0.0063772206,
        0.03782305,
        0.008101068,
        -0.026822936,
        -0.008913885,
        0.0076540196,
        -0.012469956,
        -0.007803036,
        -0.024858631,
        -0.008724228,
        0.015470603,
        0.001132016,
        0.0190199,
        -0.011298146,
        0.03221462,
        -0.011359107,
        0.02185121,
        0.006858137,
        -0.017678753,
        0.0048667374,
        0.0037795955,
        -0.034517597,
        -0.0075524175,
        -0.008344914,
        0.00551699,
        -0.027175156,
        0.0148745375,
        -0.0010913751,
        -0.008107842,
        0.0035120435,
        0.014630692,
        -0.032485556,
        -0.056138508,
        -0.02110613,
        -0.029911637,
        0.021133222,
        0.021051941,
        0.015768636,
        0.0061164424,
        0.0024977166,
        0.009103542,
        -0.0074237217,
        -0.005117356,
        -0.015023554,
        -0.017895505,
        0.0236665,
        -0.0236665,
        0.021607365,
        -0.04993401,
        -0.0006218891,
        0.0067768553,
        0.0077285278,
        -0.026443621,
        0.025251491,
        -0.0006113055,
        -0.0056152055,
        -0.0054797363,
        0.0003979413,
        -0.00853457,
        -0.014264925,
        -0.0010151736,
        -0.0071460097,
        -0.011541991,
        -0.008724228,
        0.0075795115,
        0.01450877,
        0.017448455,
        0.013018607,
        0.004297766,
        -0.007024087,
        -0.0005130903,
        -0.021458348,
        -0.0008864777,
        0.0023283798,
        -0.013052475,
        -0.0020980819,
        -0.024357393,
        -0.016202137,
        -0.007267932,
        -0.003518817,
        0.02689067,
        0.001899958,
        -0.014007533,
        -0.00009900906,
        -0.06480855,
        0.03237718,
        0.040776283,
        -0.022758855,
        -0.0019626126,
        -0.028719507,
        -0.009008713,
        -0.020957112,
        -0.003952319,
        0.004893831,
        -0.008446516,
        0.008832604,
        -0.007281479,
        -0.00682427,
        -0.01218547,
        0.014617146,
        0.01566026,
        -0.0056558466,
        -0.0025925452,
        -0.022189884,
        -0.011054301,
        -0.032756496,
        0.020090109,
        -0.0036779935,
        -0.0049547926,
        -0.006837817,
        -0.01747555,
        0.014522317,
        0.014481676,
        -0.015362227,
        0.019575324,
        -0.0037152476,
        -0.0035357508,
        0.027717033,
        0.0021438028,
        -0.0033139195,
        0.0066955737,
        0.02601012,
        0.00800624,
        0.0022674187,
        -0.019575324,
        -0.02185121,
        0.023368467,
        -0.01981917,
        -0.009381254,
        0.0037287946,
        -0.0243303,
        -0.0032919059,
        0.024140643,
        0.022447275,
        0.0011218558,
        0.0046059587,
        -0.044867456,
        -0.031239238,
        -0.01486099,
        -0.008209445,
        0.0016823603,
        0.012266752,
        0.032973245,
        -0.011928079,
        0.025928838,
        0.008358461,
        -0.00266536,
        -0.013221811,
        -0.012747668,
        -0.02636234,
        -0.049879823,
        -0.0019778528,
        0.0008847843,
        -0.032268804,
        -0.015768636,
        -0.007843677,
        0.00093473867,
        0.041860037,
        0.013228584,
        0.0073966277,
        0.012788309,
        0.013756915,
        0.000599452,
        0.018830243,
        -0.021891851,
        0.018992806,
        -0.030914111,
        0.009157729,
        0.024872176,
        0.013350507,
        -0.011711327,
        -0.016865937,
        -0.029451042,
        -0.008344914,
        0.023598766,
        -0.021715742,
        -0.0120838685,
        0.0059979064,
        0.005940332,
        -0.008839376,
        0.008717454,
        0.016771108,
        -0.0026602799,
        0.013445335,
        -0.0042774454,
        -0.002558678,
        0.0081281625,
        -0.027026141,
        -0.00010170787,
        0.0132082645,
        -0.034165375,
        -0.049717262,
        0.033027433,
        0.01152167,
        -0.0013657006,
        0.008466836,
        0.009591232,
        0.02153963,
        -0.015619619,
        0.023002699,
        -0.0143191125,
        -0.033108715,
        -0.023585219,
        0.010139883,
        0.014386848,
        -0.015646713,
        0.01517257,
        -0.013621446,
        0.010607252,
        0.03110377,
        0.013817877,
        -0.000026022291,
        0.0376063,
        0.0132082645,
        -0.009455763,
        0.012314166,
        -0.007938505,
        -0.017529737,
        0.024316752,
        0.003965866,
        -0.0076811137,
        0.0050801015,
        -0.016567905,
        0.09027679,
        -0.008067201,
        -0.010119562,
        0.023219451,
        -0.012544464,
        0.016134402,
        0.002033734,
        0.020388141,
        -0.019453403,
        -0.009367707,
        0.03592648,
        -0.0017543284,
        0.0084194215,
        -0.01706914,
        0.015890557,
        -0.004626279,
        -0.032810684,
        0.014711974,
        -0.02852985,
        0.008189124,
        0.045761555,
        -0.0037897557,
        0.047034968,
        0.018627038,
        -0.027595112,
        -0.0042097108,
        0.01977853,
        0.004680467,
        0.007295026,
        -0.0024028881,
        0.014115909,
        0.020916471,
        -0.040722094,
        -0.013303093,
        -0.02915301,
        0.0030497543,
        -0.005225731,
        -0.004141976,
        -0.00017589852,
        -0.019128276,
        0.0004961566,
        0.013939799,
        0.0084058745,
        -0.025386961,
        0.00085642043,
        0.002360554,
        0.0016637333,
        -0.029884543,
        -0.04074919
      ]
    }
  ],
  "model": "text-embedding-ada-002-v2",
  "usage": {
    "prompt_tokens": 1366,
    "total_tokens": 1366
  }
}



================================================
FILE: tests/Fixtures/openai/embeddings-input-1.json
================================================
{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [
        0.0022756963,
        -0.009305916,
        0.015742613,
        -0.0077253063,
        -0.0047450014,
        0.014917395,
        -0.009807394,
        -0.038264707,
        -0.0069127847,
        -0.028590616,
        0.025251659,
        0.018116701,
        -0.0036309576,
        -0.02554366,
        0.00055543496,
        -0.016428178,
        0.02828592,
        0.0054083494,
        0.009610611,
        -0.016415482,
        -0.015412526,
        0.004272088,
        0.0069953064,
        -0.007223828,
        -0.0039007403,
        0.018573744,
        0.008734611,
        -0.022699833,
        0.011508612,
        0.023893224,
        0.015602961,
        -0.0035706533,
        -0.034963835,
        -0.0041514793,
        -0.026178442,
        -0.02150644,
        -0.0057066972,
        0.011768873,
        0.008455306,
        0.004129262,
        0.019157745,
        -0.014358787,
        0.008982176,
        0.0063605234,
        -0.04570436,
        0.017900875,
        -0.005570219,
        -0.0007716578,
        -0.02215392,
        -0.0039229575,
        0.02101131,
        -0.017608874,
        -0.011699047,
        -0.02256018,
        0.01633931,
        0.017164527,
        -0.00838548,
        0.0015901309,
        0.02507392,
        -0.024997747,
        0.007807828,
        0.005798741,
        -0.022115832,
        0.002948566,
        -0.0061764363,
        -0.025556356,
        -0.008074437,
        0.0010585003,
        0.00023824192,
        0.004637088,
        0.02071931,
        0.013393917,
        0.004608523,
        -0.015996527,
        0.016555134,
        -0.008950437,
        -0.007553915,
        0.01364783,
        -0.0069826106,
        0.0052940883,
        0.009921655,
        -0.04590749,
        0.0030453703,
        0.023982093,
        0.023080703,
        0.0070016542,
        -0.023550441,
        0.009934351,
        -0.006563654,
        -0.03328801,
        -0.0026994138,
        0.019919483,
        0.0016885222,
        0.0010561198,
        -0.02264905,
        0.0049862186,
        0.015374439,
        0.03153601,
        -0.005459132,
        -0.015983831,
        -0.00515761,
        0.019894093,
        -0.009331307,
        -0.006189132,
        -0.03118053,
        -0.009483655,
        -0.015234787,
        -0.028819138,
        0.021024005,
        -0.018269049,
        -0.002910479,
        0.012765482,
        0.005129045,
        -0.049640015,
        -0.0429621,
        -0.0004479186,
        0.021531831,
        -0.016885223,
        0.006525567,
        -0.04141323,
        0.0008998046,
        0.033465747,
        0.012911482,
        -0.010518351,
        -0.0005959023,
        0.018396005,
        0.000059461294,
        -0.013140003,
        0.011965656,
        0.005767002,
        0.007103219,
        0.008652089,
        0.018446788,
        -0.0008775872,
        -0.01917044,
        0.021912701,
        -0.029733226,
        -0.0042593926,
        0.0014933265,
        -0.005116349,
        0.014955482,
        0.021366788,
        -0.01876418,
        0.011013481,
        -0.0074333064,
        0.022674441,
        0.01917044,
        0.014955482,
        -0.0036785663,
        0.0063097407,
        0.025708703,
        -0.027752703,
        0.036665052,
        -0.004389523,
        0.013863656,
        0.008004611,
        -0.0056432188,
        0.010283481,
        -0.0058749146,
        -0.008728263,
        0.010683394,
        -0.00003173914,
        0.03217079,
        -0.023880528,
        -0.002616892,
        0.030368008,
        0.029631661,
        0.016618613,
        0.002209044,
        0.0010489785,
        -0.011641916,
        0.018535657,
        -0.0076364367,
        0.0074333064,
        -0.0011315004,
        0.004462523,
        0.009934351,
        -0.007528524,
        -0.006239915,
        -0.0057320883,
        -0.02828592,
        0.0043006535,
        0.029301573,
        0.024794616,
        -0.015717221,
        -0.018167483,
        0.007484089,
        0.0086330455,
        -0.011692699,
        -0.0063605234,
        0.0019678266,
        0.03694436,
        -0.0023328268,
        -0.020820875,
        -0.6890186,
        -0.019551309,
        0.0034913053,
        0.0067286976,
        0.028336704,
        0.02341079,
        0.007154002,
        0.010619916,
        0.009591568,
        -0.00943922,
        -0.021303311,
        0.000044112443,
        0.019830614,
        0.0022677614,
        -0.009604263,
        -0.0020805006,
        -0.0004106251,
        0.006595393,
        -0.041337054,
        0.0111594815,
        -0.013419308,
        0.02770192,
        -0.011451482,
        0.00020947831,
        0.015412526,
        -0.0004538697,
        0.014460352,
        -0.008569567,
        -0.01887844,
        -0.01771044,
        -0.009401133,
        0.024591485,
        0.012943221,
        -0.008975829,
        0.03483688,
        -0.005094132,
        -0.024261398,
        0.024070963,
        -0.0038086968,
        0.031028183,
        -0.015031656,
        -0.023245746,
        0.030164879,
        0.00686835,
        0.010105742,
        0.011451482,
        0.030291835,
        0.017659657,
        0.0020709787,
        -0.0067350455,
        0.009712176,
        0.0166567,
        0.0036753924,
        0.027955834,
        0.003983262,
        0.003092979,
        0.029885573,
        -0.016847135,
        0.0021519137,
        0.023245746,
        0.011749829,
        0.0143206995,
        -0.019817919,
        -0.029580878,
        -0.0015750548,
        0.0184087,
        -0.0027787616,
        0.01934818,
        0.027549572,
        -0.008506089,
        0.012359221,
        0.0028295442,
        -0.0052591753,
        0.006449393,
        0.009344002,
        0.02258557,
        0.023588529,
        0.0010164459,
        0.018992702,
        -0.0030279139,
        -0.006817567,
        -0.010118438,
        -0.007922089,
        -0.007293654,
        0.020554267,
        0.010899221,
        -0.02983479,
        -0.0038626532,
        0.002731153,
        -0.018903831,
        0.02998714,
        0.024566093,
        -0.004430784,
        0.026483137,
        0.017545396,
        0.0412101,
        -0.020148005,
        0.014663482,
        0.021519136,
        -0.029910965,
        -0.0014631744,
        0.003431001,
        0.034176704,
        0.036081053,
        0.028057398,
        0.01849757,
        0.0033675227,
        0.00935035,
        0.020744702,
        -0.012530612,
        0.017050266,
        0.011546698,
        -0.007706263,
        0.0133050475,
        -0.007446002,
        -0.022484006,
        0.0059098275,
        0.025734095,
        -0.019119658,
        -0.019005397,
        -0.013368526,
        -0.0026819573,
        0.022522094,
        -0.007960176,
        -0.00078197307,
        0.028133573,
        0.013990613,
        -0.02002105,
        -0.021163657,
        -0.002913653,
        0.013470091,
        0.016085396,
        0.01195296,
        -0.01677096,
        0.004827523,
        -0.013063829,
        0.025734095,
        -0.030342616,
        0.017608874,
        -0.022420527,
        -0.018865744,
        0.0020090875,
        -0.006163741,
        0.0021122396,
        -0.0014401635,
        -0.01113409,
        -0.00531948,
        -0.011432438,
        -0.021646094,
        0.0051956973,
        0.0056210016,
        -0.00023129898,
        -0.012746438,
        0.003424653,
        0.024642268,
        -0.0017900874,
        0.0012640113,
        -0.0054178713,
        -0.024845399,
        -0.030545747,
        -0.016085396,
        0.016669396,
        -0.013228873,
        -0.008734611,
        0.009490003,
        -0.007376176,
        0.0069762627,
        -0.0056495667,
        -0.012067221,
        -0.023766268,
        0.02884453,
        -0.015882265,
        -0.003358001,
        0.0052560014,
        -0.01677096,
        0.0013711308,
        -0.021836529,
        -0.019564005,
        -0.006344654,
        0.016707484,
        0.008760002,
        0.0041832183,
        -0.0138128735,
        -0.012854352,
        0.009496351,
        0.005776523,
        0.0014131851,
        0.025327833,
        -0.017786613,
        0.015387135,
        0.0020217833,
        -0.011013481,
        0.0074269585,
        0.0015766417,
        0.01595844,
        0.013419308,
        -0.002693066,
        0.0021122396,
        0.01414296,
        -0.0023121962,
        -0.004234001,
        -0.0065382626,
        0.0030707617,
        -0.0047100885,
        0.013254264,
        -0.017456526,
        -0.0111594815,
        -0.029631661,
        0.0037198272,
        0.0074650454,
        0.016110787,
        -0.0138128735,
        -0.017304178,
        -0.0037452185,
        0.021404875,
        0.016999483,
        0.019297397,
        0.00686835,
        -0.01393983,
        -0.0092614805,
        -0.0023693268,
        -0.020935137,
        -0.005240132,
        -0.0014425439,
        0.00643035,
        0.0030421964,
        0.0029469791,
        -0.007369828,
        0.001253696,
        -0.0021471528,
        -0.001917044,
        0.018649919,
        0.00077324477,
        0.015145917,
        0.0069889585,
        0.001328283,
        0.016402787,
        -0.008696524,
        0.016758265,
        -0.00044434794,
        -0.007738002,
        0.01677096,
        -0.00082363066,
        -0.028057398,
        0.010911916,
        0.00009938318,
        -0.0060970886,
        -0.011267395,
        -0.027397225,
        0.008899654,
        0.012879742,
        0.01683444,
        -0.01762157,
        0.014714265,
        -0.0039991317,
        0.0080617415,
        -0.0018853049,
        -0.018814962,
        0.034151312,
        0.020947833,
        0.016542438,
        0.0222047,
        0.015387135,
        -0.00096804375,
        0.004433958,
        0.000515761,
        -0.007731654,
        -0.026178442,
        0.00978835,
        -0.0066969586,
        0.014803135,
        -0.025899138,
        -0.0023931311,
        -0.006627132,
        0.006716002,
        -0.0012560764,
        -0.018726092,
        0.0022376094,
        -0.0178247,
        0.00488148,
        0.0031453487,
        -0.021811137,
        0.029860182,
        0.0117879165,
        -0.002727979,
        -0.011057916,
        -0.017380353,
        0.007331741,
        -0.012403656,
        0.0033643488,
        0.007154002,
        0.014422265,
        0.0011719677,
        -0.009616959,
        0.014041395,
        0.000610185,
        0.046110623,
        -0.02078279,
        0.031612184,
        -0.0051893494,
        0.0065001757,
        -0.025353225,
        -0.028184356,
        -0.023486963,
        0.026203834,
        -0.013089221,
        -0.022318963,
        -0.0005459132,
        0.023398094,
        -0.007712611,
        0.0065382626,
        -0.006052654,
        -0.012530612,
        -0.0021138266,
        0.023982093,
        -0.0033103921,
        -0.02942853,
        0.0019710006,
        0.007699915,
        -0.0008434676,
        -0.03041879,
        -0.017075656,
        -0.008785394,
        -0.013495482,
        0.07810368,
        -0.004833871,
        0.015171308,
        0.008277567,
        0.036715835,
        0.00054035883,
        -0.038848706,
        -0.0046275663,
        -0.0054273927,
        -0.012137047,
        -0.0067413934,
        0.009655046,
        0.024870789,
        0.0070968717,
        0.02633079,
        -0.0042847837,
        -0.005941567,
        -0.024566093,
        0.019310093,
        -0.02384244,
        -0.008245829,
        0.016593222,
        0.015920352,
        0.02709253,
        -0.015247483,
        0.004348262,
        0.025518268,
        0.02615305,
        -0.0011116633,
        -0.023372702,
        0.0015663265,
        -0.0012179895,
        -0.004976697,
        -0.002321718,
        -0.015501396,
        0.0047894362,
        0.00045267947,
        -0.012213221,
        0.004868784,
        -0.0062970454,
        0.040549923,
        -0.008747307,
        0.0051734797,
        -0.016923308,
        0.004637088,
        -0.0015766417,
        -0.027752703,
        0.05093497,
        -0.03041879,
        -0.0028644572,
        0.015387135,
        0.02709253,
        0.0022820442,
        -0.010391395,
        -0.004348262,
        0.011178525,
        -0.00663348,
        -0.02428679,
        -0.0140033085,
        0.016263135,
        -0.014739656,
        -0.037706096,
        -0.005554349,
        -0.00072841323,
        -0.025988007,
        -0.02042731,
        -0.012625829,
        -0.012410004,
        -0.0028089138,
        -0.00291524,
        -0.012410004,
        0.003688088,
        -0.012809916,
        -0.0069953064,
        0.017354961,
        -0.0026121312,
        -0.0034595663,
        -0.009737568,
        -0.0009886742,
        0.009826438,
        0.0008220437,
        -0.008163307,
        0.0013909678,
        0.0036404792,
        -0.029200008,
        0.022712529,
        0.026635485,
        0.011108698,
        0.0054146973,
        0.0044022184,
        -0.002175718,
        -0.0025946747,
        0.005125871,
        -0.015564874,
        -0.0054273927,
        -0.021988876,
        -0.016237743,
        0.025200877,
        -0.008410872,
        -0.0032596097,
        -0.008112524,
        0.001955131,
        -0.009286872,
        0.0006280382,
        0.043673057,
        -0.008525133,
        -0.011356264,
        -0.024946963,
        0.004227653,
        -0.011172177,
        0.020414615,
        0.0149047,
        -0.019068874,
        0.007528524,
        -0.012035482,
        0.030444182,
        0.012130699,
        0.032424703,
        0.0035674793,
        -0.009077393,
        -0.0073888716,
        -0.0064652627,
        0.025061224,
        -0.012264003,
        0.009509047,
        -0.0010212068,
        0.0124861775,
        -0.013254264,
        -0.0014623809,
        -0.012733743,
        -0.0036214357,
        0.0071286107,
        -0.010435829,
        0.010029568,
        -0.0043292185,
        -0.0025724573,
        -0.004132436,
        0.01084209,
        -0.025594441,
        -0.024121746,
        -0.040219836,
        -0.015247483,
        0.01291783,
        -0.013279656,
        -0.02866679,
        -0.023512354,
        -0.004833871,
        -0.008055394,
        -0.01616157,
        0.05151897,
        0.011762525,
        0.009267828,
        -0.031662967,
        0.03950888,
        0.0046656537,
        -0.014155656,
        -0.014803135,
        -0.0065319147,
        0.0045101317,
        0.027143313,
        0.021760354,
        -0.00020055169,
        0.019614788,
        0.0036690445,
        -0.000138462,
        -0.0066906107,
        -0.010829395,
        -0.0045958273,
        -0.0303934,
        0.02960627,
        0.026559312,
        0.014853917,
        0.00982009,
        0.009242438,
        -0.020973222,
        0.0035896967,
        0.004602175,
        -0.008645741,
        -0.009540785,
        -0.013901743,
        0.017634265,
        -0.027498791,
        0.0050370013,
        0.0071603497,
        0.033034097,
        -0.0075412197,
        0.022687137,
        0.0063097407,
        0.016085396,
        -0.00038900282,
        0.028641399,
        -0.014460352,
        0.0025296095,
        -0.010118438,
        -0.017342266,
        0.010473916,
        -0.0052496535,
        -0.015387135,
        -0.018434092,
        -0.00033127726,
        0.02767653,
        0.0010711959,
        0.005110001,
        -0.013470091,
        -0.00794748,
        0.005059219,
        0.013571656,
        -0.014396873,
        -0.00471961,
        -0.026178442,
        -0.018738788,
        -0.0195767,
        -0.012581395,
        -0.029885573,
        -0.00987722,
        -0.003358001,
        -0.041337054,
        0.013101917,
        -0.0094519155,
        -0.03813775,
        -0.0007399187,
        -0.004021349,
        -0.0143206995,
        -0.003903914,
        0.016631309,
        -0.0007228589,
        -0.017367657,
        -0.015564874,
        0.029530095,
        -0.0043450883,
        -0.009826438,
        -0.000052220803,
        0.011432438,
        0.02507392,
        -0.02188731,
        -0.018954614,
        0.021531831,
        0.010099394,
        -0.02285218,
        0.013698612,
        -0.004621219,
        0.02960627,
        -0.012848004,
        0.018370613,
        0.00054234255,
        0.012936873,
        -0.020973222,
        0.003465914,
        0.0036277836,
        0.0067223497,
        -0.030063313,
        -0.0021995225,
        -0.024248702,
        0.026178442,
        -0.009813742,
        -0.010239046,
        0.008156959,
        -0.010010525,
        -0.013114613,
        0.021874614,
        -0.010956351,
        0.008334698,
        -0.008544176,
        0.016415482,
        -0.0035611314,
        -0.009655046,
        0.0135589605,
        -0.007833219,
        0.018104006,
        0.019475136,
        -0.022484006,
        -0.023474267,
        0.0037293488,
        0.009470959,
        0.027219485,
        -0.007090524,
        -0.015171308,
        -0.017050266,
        -0.0045482186,
        -0.013673221,
        -0.0056178276,
        0.010429481,
        0.0050655664,
        0.008131567,
        -0.00073357084,
        -0.032577053,
        -0.028184356,
        0.0047799144,
        0.0060272627,
        -0.016060004,
        -0.021747658,
        -0.020973222,
        0.0015544243,
        -0.0015893374,
        0.024769224,
        -0.001953544,
        -0.012410004,
        0.015323657,
        -0.012708351,
        0.009052003,
        -0.010194612,
        0.019094266,
        -0.025480181,
        0.008512437,
        0.003351653,
        0.012962264,
        0.022509398,
        -0.008893306,
        -0.02323305,
        -0.016313918,
        0.0011941851,
        -0.0042974795,
        0.018180178,
        -0.005773349,
        0.026051486,
        0.0052909143,
        0.0067604366,
        -0.00634148,
        -0.018040527,
        0.019487832,
        -0.017862787,
        -0.0012314786,
        0.027219485,
        -0.015869569,
        -0.02060505,
        0.039838966,
        0.008696524,
        -0.0022534789,
        -0.029453922,
        0.009267828,
        -0.021557223,
        0.035877924,
        -0.014269917,
        -0.014549222,
        -0.023207659,
        0.011559394,
        -0.016618613,
        0.020414615,
        0.006424002,
        -0.013533569,
        0.016428178,
        0.013203482,
        0.019767135,
        -0.0014441308,
        0.016199656,
        0.0048148273,
        -0.013838265,
        0.0078713065,
        -0.036157228,
        -0.027117921,
        -0.009921655,
        0.0097058285,
        -0.0044720448,
        -0.009769307,
        -0.014219134,
        0.009889916,
        -0.042987492,
        0.024616877,
        -0.0106516555,
        0.0047894362,
        0.011019829,
        0.021671485,
        -0.023601225,
        0.006747741,
        -0.031078964,
        0.0058685667,
        -0.005097306,
        -0.01385096,
        -0.0065509584,
        0.0004407773,
        0.009413829,
        -0.009832785,
        -0.042352706,
        -0.010975394,
        0.008664785,
        0.0025248486,
        0.012048177,
        -0.006887393,
        -0.014041395,
        -0.007039741,
        0.0018519788,
        0.014485743,
        0.033211835,
        0.0052940883,
        -0.0017012178,
        -0.012778178,
        -0.015349047,
        0.01829444,
        -0.005795567,
        -0.0482181,
        -0.017723136,
        0.00914722,
        -0.0109055685,
        0.0000068499508,
        -0.015831484,
        -0.028184356,
        0.01764696,
        -0.017291483,
        -0.002658153,
        -0.022433223,
        -0.017266091,
        0.015222091,
        0.007953828,
        -0.01908157,
        0.007896698,
        -0.00010959921,
        -0.019475136,
        0.016415482,
        0.007084176,
        0.00017377178,
        -0.009299568,
        -0.015882265,
        0.004976697,
        -0.0059098275,
        -0.020985918,
        0.003538914,
        0.0038943924,
        -0.0016139352,
        0.004421262,
        0.012708351,
        -0.0149047,
        0.012460786,
        0.0022979137,
        -0.003796001,
        0.0004649784,
        -0.008842524,
        0.015882265,
        -0.017342266,
        -0.016707484,
        -0.0052083926,
        -0.022179311,
        -0.020655831,
        0.018065918,
        0.009299568,
        -0.0077189584,
        0.025899138,
        0.2191778,
        0.01201009,
        -0.0050052623,
        0.037452184,
        -0.00040983164,
        0.031434443,
        0.0018535657,
        0.0024915223,
        -0.017278787,
        0.013203482,
        -0.011464177,
        -0.006595393,
        0.0015972722,
        -0.003538914,
        0.006230393,
        -0.0049227406,
        -0.025086615,
        -0.02381705,
        0.00021344572,
        -0.035573225,
        0.0107151335,
        -0.016529744,
        0.0008736198,
        -0.017316874,
        0.03775688,
        0.0020170223,
        -0.044079315,
        0.0065700016,
        0.013952525,
        0.024388354,
        -0.018992702,
        -0.008607655,
        0.00590348,
        0.00160362,
        -0.014409569,
        0.013013047,
        0.0069127847,
        0.003942001,
        0.0057066972,
        -0.0037737836,
        0.009851829,
        -0.013127308,
        0.017316874,
        -0.016428178,
        0.017380353,
        0.02451531,
        -0.0187007,
        -0.02729566,
        0.003205653,
        0.036461923,
        -0.015145917,
        -0.018738788,
        0.0065192194,
        0.010162872,
        0.0054464363,
        0.009185307,
        0.026026094,
        -0.020173397,
        -0.019868702,
        -0.0061002625,
        0.01066435,
        0.009490003,
        -0.01639009,
        0.00089821767,
        -0.030063313,
        0.009636003,
        -0.014917395,
        0.014333395,
        -0.0032167619,
        -0.0160727,
        -0.0014314352,
        -0.024997747,
        0.0002239593,
        0.022331659,
        -0.009032959,
        -0.01011209,
        0.024946963,
        -0.0128607,
        0.019538615,
        0.03501462,
        -0.026787834,
        -0.0000737935,
        -0.0068048714,
        -0.011203916,
        -0.016923308,
        -0.030164879,
        0.0040753055,
        0.014561917,
        -0.019043483,
        -0.020744702,
        0.011388003,
        -0.012670265,
        -0.00013538726,
        -0.0013401852,
        0.0178247,
        0.0057003493,
        -0.006525567,
        0.010232698,
        0.0032850008,
        -0.011349916,
        -0.010892873,
        -0.055149928,
        -0.009458263,
        -0.004878306,
        -0.028742965,
        -0.0031183704,
        0.002802566,
        0.03676662,
        0.003172327,
        -0.005557523,
        -0.0026216528,
        -0.00032969032,
        0.017938962,
        -0.0015449026,
        0.0023836093,
        -0.002661327,
        -0.017012179,
        0.0035928707,
        0.030291835,
        -0.023956703,
        0.01878957,
        -0.01914505,
        -0.0029977616,
        0.033414967,
        -0.02051618,
        -0.01297496,
        -0.011540351,
        0.011997394,
        0.025442094,
        -0.011826003,
        0.038569402,
        -0.0033770443,
        -0.007922089,
        0.019995658,
        -0.033745054,
        -0.018751483,
        0.009591568,
        0.018104006,
        -0.026838616,
        -0.012225917,
        0.024794616,
        0.00082442415,
        -0.0010283481,
        0.0064017843,
        -0.0049735233,
        -0.035471663,
        0.012321134,
        0.0075729587,
        -0.029910965,
        -0.018332526,
        -0.030901225,
        -0.014536526,
        -0.017240701,
        -0.01721531,
        0.024921572,
        -0.02022418,
        -0.044612534,
        -0.0056463927,
        -0.01385096,
        -0.0008418807,
        -0.0028517616,
        -0.0065065236,
        0.053017057,
        -0.011641916,
        0.008093481,
        0.005640045,
        -0.16148874,
        0.009185307,
        -0.024629572,
        -0.016415482,
        0.015729917,
        0.0006538263,
        0.023194963,
        -0.0074586975,
        -0.018104006,
        0.018853048,
        0.010264438,
        0.0104612205,
        -0.032983314,
        0.0023756747,
        0.019018093,
        0.016555134,
        0.00017168891,
        -0.014371483,
        0.023296528,
        0.01966557,
        0.03834088,
        0.0026724355,
        0.0010632612,
        -0.0076237414,
        0.0027803485,
        0.030520355,
        -0.025556356,
        0.0037769575,
        -0.011051568,
        0.0017900874,
        0.005979654,
        -0.0029406312,
        0.025530964,
        -0.00847435,
        0.010340611,
        0.0054020016,
        0.00010682204,
        -0.0065573063,
        0.017812004,
        0.03529392,
        0.013178091,
        0.02787966,
        -0.0014131851,
        0.014892004,
        -0.009750264,
        0.009902611,
        0.009344002,
        -0.0017504136,
        0.023588529,
        -0.0047037406,
        0.009458263,
        -0.03737601,
        0.016110787,
        0.0012148155,
        0.0022566528,
        0.016897917,
        -0.014117569,
        0.0015052287,
        -0.005862219,
        -0.0006391469,
        -0.012321134,
        -0.011311829,
        -0.013178091,
        0.0020217833,
        -0.0012425873,
        -0.003983262,
        -0.0063510016,
        -0.014879309,
        0.006446219,
        0.00604948,
        -0.0024820007,
        0.002648631,
        0.003431001,
        0.007490437,
        0.000079695,
        0.023474267,
        -0.017634265,
        -0.0065446105,
        0.021823833,
        -0.023194963,
        -0.015133222,
        0.034176704,
        -0.025975311,
        0.0213287,
        -0.01569183,
        0.002215392,
        0.0040975227,
        0.014968178,
        0.014168352,
        -0.0074650454,
        0.007325393,
        -0.003577001,
        -0.009344002,
        -0.025645224,
        0.018104006,
        0.0110325245,
        0.009032959,
        0.010473916,
        -0.0058146105,
        -0.003656349,
        0.0055829147,
        -0.021519136,
        -0.028692182,
        0.02556905,
        0.016364701,
        0.033592705,
        0.012441742,
        0.027117921,
        0.019513223,
        -0.0051480886,
        -0.020122614,
        0.010264438,
        0.019906787,
        0.02545479,
        -0.0107151335,
        0.038797922,
        -0.014980874,
        -0.025404006,
        0.030444182,
        -0.0091345245,
        0.04664384,
        0.0008049839,
        0.0016726527,
        0.012867047,
        -0.0007633263,
        0.0033675227,
        -0.10796385,
        -0.022953745,
        0.020566963,
        0.02051618,
        -0.0062843496,
        -0.005275045,
        0.009305916,
        0.013520873,
        -0.0143206995,
        0.0037039577,
        -0.011235655,
        -0.017977048,
        -0.015222091,
        -0.013584351,
        0.023753572,
        0.008487046,
        0.025175486,
        -0.02866679,
        -0.00038900282,
        0.005160784,
        -0.00070143497,
        0.01148322,
        -0.0049798707,
        0.0067667845,
        -0.0042879577,
        0.007522176,
        -0.009026611,
        0.029910965,
        0.0072492193,
        0.011254699,
        0.02419792,
        -0.009947047,
        0.017304178,
        -0.0040657837,
        -0.011629221,
        -0.0005570219,
        -0.024654964,
        0.0023391745,
        0.014739656,
        -0.026965573,
        0.012759134,
        -0.0074713933,
        -0.002397892,
        -0.047532536,
        0.006855654,
        -0.0044879145,
        0.00028704084,
        0.018688004,
        0.022928353,
        -0.0070333933,
        -0.0037452185,
        0.025797572,
        -0.02960627,
        0.0045958273,
        0.041692533,
        -0.00590348,
        0.016669396,
        -0.001878957,
        -0.0097058285,
        -0.006665219,
        0.0067985235,
        -0.0011465764,
        -0.020211484,
        0.007966524,
        0.008264872,
        0.015933048,
        -0.011057916,
        -0.0023471094,
        0.0051480886,
        -0.015158613,
        0.012048177,
        -0.00648748,
        -0.016618613,
        -0.008969481,
        -0.010086698,
        -0.03867097,
        -0.03407514,
        0.0056717843,
        -0.000030871273,
        -0.02258557,
        0.0019789354,
        -0.009769307,
        0.0074396543,
        -0.0011759351,
        -0.0006601741,
        -0.020148005,
        -0.010239046,
        -0.0067794803,
        -0.007515828,
        -0.015818788,
        -0.0044022184,
        0.011248351,
        0.031002792,
        -0.013673221,
        -0.016961396,
        0.018129397,
        -0.014460352,
        -0.002136044,
        0.017393049,
        -0.02363931,
        -0.0063065668,
        -0.010156524,
        -0.040194444,
        0.0069127847,
        -0.017786613,
        -0.0067413934,
        0.00876635,
        -0.009978785,
        0.01677096,
        0.010042263,
        -0.008290263,
        0.017012179,
        -0.01063896,
        0.012695655,
        0.01376209,
        0.007960176,
        -0.017139135,
        -0.008874264,
        0.015425222,
        0.0052179145,
        0.022369746,
        -0.00923609,
        0.022255484,
        0.030342616,
        -0.0045990013,
        -0.0006197067,
        -0.020414615,
        0.021900006,
        -0.01326696,
        0.016859831,
        -0.027600355,
        -0.011007134,
        0.011546698,
        -0.024642268,
        0.0033326095,
        0.026076877,
        -0.0143841775,
        -0.029961748,
        -0.0041578272,
        0.01224496,
        0.009629655,
        0.0027041747,
        -0.006563654,
        -0.036715835,
        0.01098809,
        -0.023677398,
        -0.011991046,
        0.014955482,
        -0.016021917,
        -0.004053088,
        0.018776875,
        0.003875349,
        -0.008290263,
        0.011146786,
        0.010505655,
        -0.019221222,
        0.015768005,
        0.0013885873,
        0.005947915,
        -0.011851395,
        0.0051480886,
        -0.031078964,
        0.035903316,
        -0.009090089,
        0.008804437,
        -0.009153568,
        -0.004684697,
        -0.013609743,
        -0.016694788,
        -0.013698612,
        0.014676178,
        -0.029860182,
        -0.018624527,
        0.005167132,
        0.019830614,
        0.011146786,
        0.039229576,
        -0.017938962,
        -0.0069953064,
        -0.028616007,
        -0.008322002,
        0.010772264,
        0.013571656,
        0.019856006,
        -0.024388354,
        0.0109055685,
        0.010296177,
        0.024705745,
        -0.016644005,
        -0.0012473481,
        0.0054242187,
        0.004611697,
        -0.004668827,
        -0.01335583,
        0.011242003,
        -0.0015806091,
        0.003970566,
        0.025302442,
        -0.003023153,
        -0.007858611,
        0.017875483,
        0.031282097,
        -0.00537661,
        0.004649784,
        0.003026327,
        -0.0071603497,
        -0.011997394,
        -0.016212352,
        -0.03387201,
        -0.042911317,
        0.009045655,
        0.0074079153,
        0.018256353,
        0.016707484,
        -0.003983262,
        0.022623658,
        0.0074142627,
        0.012137047,
        -0.001381446,
        -0.0058495235,
        -0.019068874,
        0.026940182,
        0.0030009355,
        0.012124351,
        0.007833219,
        -0.020503484,
        0.0060590017,
        0.017177222,
        -0.0040721316,
        0.00012566715,
        0.0010815111,
        0.005113175,
        -0.0015353808,
        0.009483655,
        -0.016301222,
        -0.010346959,
        -0.014460352,
        0.007084176,
        0.015983831,
        0.018814962,
        -0.025213571,
        0.036868185,
        0.00441174,
        0.008734611,
        0.003903914,
        -0.007915742,
        0.0053893058,
        0.028032009,
        -0.020109918,
        -0.0063287844,
        0.0045069577,
        0.024464529,
        0.00759835,
        0.00575748,
        -0.012498873,
        -0.026178442,
        -0.0030056965,
        0.00038047292,
        0.0008442611,
        -0.028920704,
        -0.02341079,
        0.008696524,
        0.018688004,
        0.014396873,
        0.028158965,
        -0.013952525,
        -0.0031501097,
        0.0018995875,
        -0.0034183052,
        0.012949569,
        -0.04088001,
        0.0025851529,
        -0.001883718,
        -0.049462274,
        -0.0088806115,
        -0.004576784,
        -0.021836529,
        -0.014079482,
        -0.015425222,
        0.0040753055,
        0.002727979,
        -0.03138366,
        0.041159317,
        -0.017608874,
        -0.018637223,
        0.014587308,
        0.010486611,
        -0.015387135,
        -0.019424353,
        -0.002800979
      ]
    }
  ],
  "model": "text-embedding-ada-002-v2",
  "usage": {
    "prompt_tokens": 8,
    "total_tokens": 8
  }
}



================================================
FILE: tests/Fixtures/openai/embeddings-with-dimensions-1.json
================================================
{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [
        0.0022756963,
        -0.009305916,
        0.015742613,
        -0.0077253063,
        -0.0047450014,
        0.014917395,
        -0.009807394,
        -0.038264707,
        -0.0069127847,
        -0.028590616,
        0.025251659,
        0.018116701,
        -0.0036309576,
        -0.02554366,
        0.00055543496,
        -0.016428178,
        0.02828592,
        0.0054083494,
        0.009610611,
        -0.016415482,
        -0.015412526,
        0.004272088,
        0.0069953064,
        -0.007223828,
        -0.0039007403,
        0.018573744,
        0.008734611,
        -0.022699833,
        0.011508612,
        0.023893224,
        0.015602961,
        -0.0035706533,
        -0.034963835,
        -0.0041514793,
        -0.026178442,
        -0.02150644,
        -0.0057066972,
        0.011768873,
        0.008455306,
        0.004129262,
        0.019157745,
        -0.014358787,
        0.008982176,
        0.0063605234,
        -0.04570436,
        0.017900875,
        -0.005570219,
        -0.0007716578,
        -0.02215392,
        -0.0039229575,
        0.02101131,
        -0.017608874,
        -0.011699047,
        -0.02256018,
        0.01633931,
        0.017164527,
        -0.00838548,
        0.0015901309,
        0.02507392,
        -0.024997747,
        0.007807828,
        0.005798741,
        -0.022115832,
        0.002948566,
        -0.0061764363,
        -0.025556356,
        -0.008074437,
        0.0010585003,
        0.00023824192,
        0.004637088,
        0.02071931,
        0.013393917,
        0.004608523,
        -0.015996527,
        0.016555134,
        -0.008950437,
        -0.007553915,
        0.01364783,
        -0.0069826106,
        0.0052940883,
        0.009921655,
        -0.04590749,
        0.0030453703,
        0.023982093,
        0.023080703,
        0.0070016542,
        -0.023550441,
        0.009934351,
        -0.006563654,
        -0.03328801,
        -0.0026994138,
        0.019919483,
        0.0016885222,
        0.0010561198,
        -0.02264905,
        0.0049862186,
        0.015374439,
        0.03153601,
        -0.005459132,
        -0.015983831,
        -0.00515761,
        0.019894093,
        -0.009331307,
        -0.006189132,
        -0.03118053,
        -0.009483655,
        -0.015234787,
        -0.028819138,
        0.021024005,
        -0.018269049,
        -0.002910479,
        0.012765482,
        0.005129045,
        -0.049640015,
        -0.0429621,
        -0.0004479186,
        0.021531831,
        -0.016885223,
        0.006525567,
        -0.04141323,
        0.0008998046,
        0.033465747,
        0.012911482,
        -0.010518351,
        -0.0005959023,
        0.018396005,
        0.000059461294,
        -0.013140003,
        0.011965656,
        0.005767002,
        0.007103219,
        0.008652089,
        0.018446788,
        -0.0008775872,
        -0.01917044,
        0.021912701,
        -0.029733226,
        -0.0042593926,
        0.0014933265,
        -0.005116349,
        0.014955482,
        0.021366788,
        -0.01876418,
        0.011013481,
        -0.0074333064,
        0.022674441,
        0.01917044,
        0.014955482,
        -0.0036785663,
        0.0063097407,
        0.025708703,
        -0.027752703,
        0.036665052,
        -0.004389523,
        0.013863656,
        0.008004611,
        -0.0056432188,
        0.010283481,
        -0.0058749146,
        -0.008728263,
        0.010683394,
        -0.00003173914,
        0.03217079,
        -0.023880528,
        -0.002616892,
        0.030368008,
        0.029631661,
        0.016618613,
        0.002209044,
        0.0010489785,
        -0.011641916,
        0.018535657,
        -0.0076364367,
        0.0074333064,
        -0.0011315004,
        0.004462523,
        0.009934351,
        -0.007528524,
        -0.006239915,
        -0.0057320883,
        -0.02828592,
        0.0043006535,
        0.029301573,
        0.024794616,
        -0.015717221,
        -0.018167483,
        0.007484089,
        0.0086330455,
        -0.011692699,
        -0.0063605234,
        0.0019678266,
        0.03694436,
        -0.0023328268,
        -0.020820875,
        -0.6890186,
        -0.019551309,
        0.0034913053,
        0.0067286976,
        0.028336704,
        0.02341079,
        0.007154002,
        0.010619916,
        0.009591568,
        -0.00943922,
        -0.021303311,
        0.000044112443,
        0.019830614,
        0.0022677614,
        -0.009604263,
        -0.0020805006,
        -0.0004106251,
        0.006595393,
        -0.041337054,
        0.0111594815,
        -0.013419308,
        0.02770192,
        -0.011451482,
        0.00020947831,
        0.015412526,
        -0.0004538697,
        0.014460352,
        -0.008569567,
        -0.01887844,
        -0.01771044,
        -0.009401133,
        0.024591485,
        0.012943221,
        -0.008975829,
        0.03483688,
        -0.005094132,
        -0.024261398,
        0.024070963,
        -0.0038086968,
        0.031028183,
        -0.015031656,
        -0.023245746,
        0.030164879,
        0.00686835,
        0.010105742,
        0.011451482,
        0.030291835,
        0.017659657,
        0.0020709787,
        -0.0067350455,
        0.009712176,
        0.0166567,
        0.0036753924,
        0.027955834,
        0.003983262,
        0.003092979,
        0.029885573,
        -0.016847135,
        0.0021519137,
        0.023245746,
        0.011749829,
        0.0143206995,
        -0.019817919,
        -0.029580878,
        -0.0015750548,
        0.0184087,
        -0.0027787616,
        0.01934818,
        0.027549572,
        -0.008506089,
        0.012359221,
        0.0028295442,
        -0.0052591753,
        0.006449393,
        0.009344002,
        0.02258557,
        0.023588529,
        0.0010164459,
        0.018992702,
        -0.0030279139,
        -0.006817567,
        -0.010118438,
        -0.007922089,
        -0.007293654,
        0.020554267,
        0.010899221,
        -0.02983479,
        -0.0038626532,
        0.002731153,
        -0.018903831,
        0.02998714,
        0.024566093,
        -0.004430784,
        0.026483137,
        0.017545396,
        0.0412101,
        -0.020148005,
        0.014663482,
        0.021519136,
        -0.029910965,
        -0.0014631744,
        0.003431001,
        0.034176704,
        0.036081053,
        0.028057398,
        0.01849757,
        0.0033675227,
        0.00935035,
        0.020744702,
        -0.012530612,
        0.017050266,
        0.011546698,
        -0.007706263,
        0.0133050475,
        -0.007446002,
        -0.022484006,
        0.0059098275,
        0.025734095,
        -0.019119658,
        -0.019005397,
        -0.013368526,
        -0.0026819573,
        0.022522094,
        -0.007960176,
        -0.00078197307,
        0.028133573,
        0.013990613,
        -0.02002105,
        -0.021163657,
        -0.002913653,
        0.013470091,
        0.016085396,
        0.01195296,
        -0.01677096,
        0.004827523,
        -0.013063829,
        0.025734095,
        -0.030342616,
        0.017608874,
        -0.022420527,
        -0.018865744,
        0.0020090875,
        -0.006163741,
        0.0021122396,
        -0.0014401635,
        -0.01113409,
        -0.00531948,
        -0.011432438,
        -0.021646094,
        0.0051956973,
        0.0056210016,
        -0.00023129898,
        -0.012746438,
        0.003424653,
        0.024642268,
        -0.0017900874,
        0.0012640113,
        -0.0054178713,
        -0.024845399,
        -0.030545747,
        -0.016085396,
        0.016669396,
        -0.013228873,
        -0.008734611,
        0.009490003,
        -0.007376176,
        0.0069762627,
        -0.0056495667,
        -0.012067221,
        -0.023766268,
        0.02884453,
        -0.015882265,
        -0.003358001,
        0.0052560014,
        -0.01677096,
        0.0013711308,
        -0.021836529,
        -0.019564005,
        -0.006344654,
        0.016707484,
        0.008760002,
        0.0041832183,
        -0.0138128735,
        -0.012854352,
        0.009496351,
        0.005776523,
        0.0014131851,
        0.025327833,
        -0.017786613,
        0.015387135,
        0.0020217833,
        -0.011013481,
        0.0074269585,
        0.0015766417,
        0.01595844,
        0.013419308,
        -0.002693066,
        0.0021122396,
        0.01414296,
        -0.0023121962,
        -0.004234001,
        -0.0065382626,
        0.0030707617,
        -0.0047100885,
        0.013254264,
        -0.017456526,
        -0.0111594815,
        -0.029631661,
        0.0037198272,
        0.0074650454,
        0.016110787,
        -0.0138128735,
        -0.017304178,
        -0.0037452185,
        0.021404875,
        0.016999483,
        0.019297397,
        0.00686835,
        -0.01393983,
        -0.0092614805,
        -0.0023693268,
        -0.020935137,
        -0.005240132,
        -0.0014425439,
        0.00643035,
        0.0030421964,
        0.0029469791,
        -0.007369828,
        0.001253696,
        -0.0021471528,
        -0.001917044,
        0.018649919,
        0.00077324477,
        0.015145917,
        0.0069889585,
        0.001328283,
        0.016402787,
        -0.008696524,
        0.016758265,
        -0.00044434794,
        -0.007738002,
        0.01677096,
        -0.00082363066,
        -0.028057398,
        0.010911916,
        0.00009938318,
        -0.0060970886,
        -0.011267395,
        -0.027397225,
        0.008899654,
        0.012879742,
        0.01683444,
        -0.01762157,
        0.014714265,
        -0.0039991317,
        0.0080617415,
        -0.0018853049,
        -0.018814962,
        0.034151312,
        0.020947833,
        0.016542438,
        0.0222047,
        0.015387135,
        -0.00096804375,
        0.004433958,
        0.000515761,
        -0.007731654,
        -0.026178442,
        0.00978835,
        -0.0066969586,
        0.014803135,
        -0.025899138,
        -0.0023931311,
        -0.006627132,
        0.006716002,
        -0.0012560764,
        -0.018726092,
        0.0022376094,
        -0.0178247,
        0.00488148,
        0.0031453487,
        -0.021811137,
        0.029860182,
        0.0117879165,
        -0.002727979,
        -0.011057916,
        -0.017380353,
        0.007331741,
        -0.012403656,
        0.0033643488,
        0.007154002,
        0.014422265,
        0.0011719677,
        -0.009616959,
        0.014041395,
        0.000610185,
        0.046110623,
        -0.02078279,
        0.031612184,
        -0.0051893494,
        0.0065001757,
        -0.025353225,
        -0.028184356,
        -0.023486963,
        0.026203834,
        -0.013089221,
        -0.022318963,
        -0.0005459132,
        0.023398094,
        -0.007712611,
        0.0065382626,
        -0.006052654,
        -0.012530612,
        -0.0021138266,
        0.023982093,
        -0.0033103921,
        -0.02942853,
        0.0019710006,
        0.007699915,
        -0.0008434676,
        -0.03041879,
        -0.017075656,
        -0.008785394,
        -0.013495482,
        0.07810368,
        -0.004833871,
        0.015171308,
        0.008277567,
        0.036715835,
        0.00054035883,
        -0.038848706,
        -0.0046275663,
        -0.0054273927,
        -0.012137047,
        -0.0067413934,
        0.009655046,
        0.024870789,
        0.0070968717,
        0.02633079,
        -0.0042847837,
        -0.005941567,
        -0.024566093,
        0.019310093,
        -0.02384244,
        -0.008245829,
        0.016593222,
        0.015920352,
        0.02709253,
        -0.015247483,
        0.004348262,
        0.025518268,
        0.02615305,
        -0.0011116633,
        -0.023372702,
        0.0015663265,
        -0.0012179895,
        -0.004976697,
        -0.002321718,
        -0.015501396,
        0.0047894362,
        0.00045267947,
        -0.012213221,
        0.004868784,
        -0.0062970454,
        0.040549923,
        -0.008747307,
        0.0051734797,
        -0.016923308,
        0.004637088,
        -0.0015766417,
        -0.027752703,
        0.05093497,
        -0.03041879,
        -0.0028644572,
        0.015387135,
        0.02709253,
        0.0022820442,
        -0.010391395,
        -0.004348262,
        0.011178525,
        -0.00663348,
        -0.02428679,
        -0.0140033085,
        0.016263135,
        -0.014739656,
        -0.037706096,
        -0.005554349,
        -0.00072841323,
        -0.025988007,
        -0.02042731,
        -0.012625829,
        -0.012410004,
        -0.0028089138,
        -0.00291524,
        -0.012410004,
        0.003688088,
        -0.012809916,
        -0.0069953064,
        0.017354961,
        -0.0026121312,
        -0.0034595663,
        -0.009737568,
        -0.0009886742,
        0.009826438,
        0.0008220437,
        -0.008163307,
        0.0013909678,
        0.0036404792,
        -0.029200008,
        0.022712529,
        0.026635485,
        0.011108698,
        0.0054146973,
        0.0044022184,
        -0.002175718,
        -0.0025946747,
        0.005125871,
        -0.015564874,
        -0.0054273927,
        -0.021988876,
        -0.016237743,
        0.025200877,
        -0.008410872,
        -0.0032596097,
        -0.008112524,
        0.001955131,
        -0.009286872,
        0.0006280382,
        0.043673057,
        -0.008525133,
        -0.011356264,
        -0.024946963,
        0.004227653,
        -0.011172177,
        0.020414615,
        0.0149047,
        -0.019068874,
        0.007528524,
        -0.012035482,
        0.030444182,
        0.012130699,
        0.032424703,
        0.0035674793,
        -0.009077393,
        -0.0073888716,
        -0.0064652627,
        0.025061224,
        -0.012264003,
        0.009509047,
        -0.0010212068,
        0.0124861775,
        -0.013254264,
        -0.0014623809,
        -0.012733743,
        -0.0036214357,
        0.0071286107,
        -0.010435829,
        0.010029568,
        -0.0043292185,
        -0.0025724573,
        -0.004132436,
        0.01084209,
        -0.025594441,
        -0.024121746,
        -0.040219836,
        -0.015247483,
        0.01291783,
        -0.013279656,
        -0.02866679,
        -0.023512354,
        -0.004833871,
        -0.008055394,
        -0.01616157,
        0.05151897,
        0.011762525,
        0.009267828,
        -0.031662967,
        0.03950888,
        0.0046656537,
        -0.014155656,
        -0.014803135,
        -0.0065319147,
        0.0045101317,
        0.027143313,
        0.021760354,
        -0.00020055169,
        0.019614788,
        0.0036690445,
        -0.000138462,
        -0.0066906107,
        -0.010829395,
        -0.0045958273,
        -0.0303934,
        0.02960627,
        0.026559312,
        0.014853917,
        0.00982009,
        0.009242438,
        -0.020973222,
        0.0035896967,
        0.004602175,
        -0.008645741,
        -0.009540785,
        -0.013901743,
        0.017634265,
        -0.027498791,
        0.0050370013,
        0.0071603497,
        0.033034097,
        -0.0075412197,
        0.022687137,
        0.0063097407,
        0.016085396,
        -0.00038900282,
        0.028641399,
        -0.014460352,
        0.0025296095,
        -0.010118438,
        -0.017342266,
        0.010473916,
        -0.0052496535,
        -0.015387135,
        -0.018434092,
        -0.00033127726,
        0.02767653,
        0.0010711959,
        0.005110001,
        -0.013470091,
        -0.00794748,
        0.005059219,
        0.013571656,
        -0.014396873,
        -0.00471961,
        -0.026178442,
        -0.018738788,
        -0.0195767,
        -0.012581395,
        -0.029885573,
        -0.00987722,
        -0.003358001,
        -0.041337054,
        0.013101917,
        -0.0094519155,
        -0.03813775,
        -0.0007399187,
        -0.004021349,
        -0.0143206995,
        -0.003903914,
        0.016631309,
        -0.0007228589,
        -0.017367657,
        -0.015564874,
        0.029530095,
        -0.0043450883,
        -0.009826438,
        -0.000052220803,
        0.011432438,
        0.02507392,
        -0.02188731,
        -0.018954614,
        0.021531831,
        0.010099394,
        -0.02285218,
        0.013698612,
        -0.004621219,
        0.02960627,
        -0.012848004,
        0.018370613,
        0.00054234255,
        0.012936873,
        -0.020973222,
        0.003465914,
        0.0036277836,
        0.0067223497,
        -0.030063313,
        -0.0021995225,
        -0.024248702,
        0.026178442,
        -0.009813742,
        -0.010239046,
        0.008156959,
        -0.010010525,
        -0.013114613,
        0.021874614,
        -0.010956351,
        0.008334698,
        -0.008544176,
        0.016415482,
        -0.0035611314,
        -0.009655046,
        0.0135589605,
        -0.007833219,
        0.018104006,
        0.019475136,
        -0.022484006,
        -0.023474267,
        0.0037293488,
        0.009470959,
        0.027219485,
        -0.007090524,
        -0.015171308,
        -0.017050266,
        -0.0045482186,
        -0.013673221,
        -0.0056178276,
        0.010429481,
        0.0050655664,
        0.008131567,
        -0.00073357084,
        -0.032577053,
        -0.028184356,
        0.0047799144,
        0.0060272627,
        -0.016060004,
        -0.021747658,
        -0.020973222,
        0.0015544243,
        -0.0015893374,
        0.024769224,
        -0.001953544,
        -0.012410004,
        0.015323657,
        -0.012708351,
        0.009052003,
        -0.010194612,
        0.019094266,
        -0.025480181,
        0.008512437,
        0.003351653,
        0.012962264,
        0.022509398,
        -0.008893306,
        -0.02323305,
        -0.016313918,
        0.0011941851,
        -0.0042974795,
        0.018180178,
        -0.005773349,
        0.026051486,
        0.0052909143,
        0.0067604366,
        -0.00634148,
        -0.018040527,
        0.019487832,
        -0.017862787,
        -0.0012314786,
        0.027219485,
        -0.015869569,
        -0.02060505,
        0.039838966,
        0.008696524,
        -0.0022534789,
        -0.029453922,
        0.009267828,
        -0.021557223,
        0.035877924,
        -0.014269917,
        -0.014549222,
        -0.023207659,
        0.011559394,
        -0.016618613,
        0.020414615,
        0.006424002,
        -0.013533569,
        0.016428178,
        0.013203482,
        0.019767135,
        -0.0014441308,
        0.016199656,
        0.0048148273,
        -0.013838265,
        0.0078713065,
        -0.036157228,
        -0.027117921,
        -0.009921655,
        0.0097058285,
        -0.0044720448,
        -0.009769307,
        -0.014219134,
        0.009889916,
        -0.042987492,
        0.024616877,
        -0.0106516555,
        0.0047894362,
        0.011019829,
        0.021671485,
        -0.023601225,
        0.006747741,
        -0.031078964,
        0.0058685667,
        -0.005097306,
        -0.01385096,
        -0.0065509584,
        0.0004407773,
        0.009413829,
        -0.009832785,
        -0.042352706,
        -0.010975394,
        0.008664785,
        0.0025248486,
        0.012048177,
        -0.006887393,
        -0.014041395,
        -0.007039741,
        0.0018519788,
        0.014485743,
        0.033211835,
        0.0052940883,
        -0.0017012178,
        -0.012778178,
        -0.015349047,
        0.01829444,
        -0.005795567,
        -0.0482181,
        -0.017723136,
        0.00914722,
        -0.0109055685,
        0.0000068499508,
        -0.015831484,
        -0.028184356,
        0.01764696,
        -0.017291483,
        -0.002658153,
        -0.022433223,
        -0.017266091,
        0.015222091,
        0.007953828,
        -0.01908157,
        0.007896698,
        -0.00010959921,
        -0.019475136,
        0.016415482,
        0.007084176,
        0.00017377178,
        -0.009299568,
        -0.015882265,
        0.004976697,
        -0.0059098275,
        -0.020985918,
        0.003538914,
        0.0038943924,
        -0.0016139352,
        0.004421262,
        0.012708351,
        -0.0149047,
        0.012460786,
        0.0022979137,
        -0.003796001,
        0.0004649784,
        -0.008842524,
        0.015882265,
        -0.017342266,
        -0.016707484,
        -0.0052083926,
        -0.022179311,
        -0.020655831,
        0.018065918,
        0.009299568,
        -0.0077189584,
        0.025899138,
        0.2191778,
        0.01201009,
        -0.0050052623,
        0.037452184,
        -0.00040983164,
        0.031434443,
        0.0018535657,
        0.0024915223,
        -0.017278787,
        0.013203482,
        -0.011464177,
        -0.006595393,
        0.0015972722,
        -0.003538914,
        0.006230393,
        -0.0049227406,
        -0.025086615,
        -0.02381705,
        0.00021344572,
        -0.035573225,
        0.0107151335,
        -0.016529744,
        0.0008736198,
        -0.017316874,
        0.03775688,
        0.0020170223,
        -0.044079315,
        0.0065700016,
        0.013952525,
        0.024388354,
        -0.018992702,
        -0.008607655,
        0.00590348,
        0.00160362,
        -0.014409569,
        0.013013047,
        0.0069127847,
        0.003942001,
        0.0057066972,
        -0.0037737836,
        0.009851829,
        -0.013127308,
        0.017316874,
        -0.016428178,
        0.017380353,
        0.02451531,
        -0.0187007,
        -0.02729566,
        0.003205653,
        0.036461923,
        -0.015145917,
        -0.018738788,
        0.0065192194,
        0.010162872,
        0.0054464363,
        0.009185307,
        0.026026094,
        -0.020173397,
        -0.019868702,
        -0.0061002625,
        0.01066435,
        0.009490003,
        -0.01639009,
        0.00089821767,
        -0.030063313,
        0.009636003,
        -0.014917395,
        0.014333395,
        -0.0032167619,
        -0.0160727,
        -0.0014314352,
        -0.024997747,
        0.0002239593,
        0.022331659,
        -0.009032959,
        -0.01011209,
        0.024946963,
        -0.0128607,
        0.019538615,
        0.03501462,
        -0.026787834,
        -0.0000737935,
        -0.0068048714,
        -0.011203916,
        -0.016923308,
        -0.030164879,
        0.0040753055,
        0.014561917,
        -0.019043483,
        -0.020744702,
        0.011388003,
        -0.012670265,
        -0.00013538726,
        -0.0013401852,
        0.0178247,
        0.0057003493,
        -0.006525567,
        0.010232698,
        0.0032850008,
        -0.011349916,
        -0.010892873,
        -0.055149928,
        -0.009458263,
        -0.004878306,
        -0.028742965,
        -0.0031183704,
        0.002802566,
        0.03676662,
        0.003172327,
        -0.005557523,
        -0.0026216528,
        -0.00032969032,
        0.017938962,
        -0.0015449026,
        0.0023836093,
        -0.002661327,
        -0.017012179,
        0.0035928707,
        0.030291835,
        -0.023956703,
        0.01878957,
        -0.01914505,
        -0.0029977616,
        0.033414967,
        -0.02051618,
        -0.01297496,
        -0.011540351,
        0.011997394,
        0.025442094,
        -0.011826003,
        0.038569402,
        -0.0033770443,
        -0.007922089,
        0.019995658,
        -0.033745054,
        -0.018751483,
        0.009591568,
        0.018104006,
        -0.026838616,
        -0.012225917,
        0.024794616,
        0.00082442415,
        -0.0010283481,
        0.0064017843,
        -0.0049735233,
        -0.035471663,
        0.012321134,
        0.0075729587,
        -0.029910965,
        -0.018332526,
        -0.030901225,
        -0.014536526,
        -0.017240701,
        -0.01721531,
        0.024921572,
        -0.02022418,
        -0.044612534,
        -0.0056463927,
        -0.01385096,
        -0.0008418807,
        -0.0028517616,
        -0.0065065236,
        0.053017057,
        -0.011641916,
        0.008093481,
        0.005640045,
        -0.16148874,
        0.009185307,
        -0.024629572,
        -0.016415482,
        0.015729917,
        0.0006538263,
        0.023194963,
        -0.0074586975,
        -0.018104006,
        0.018853048,
        0.010264438,
        0.0104612205,
        -0.032983314,
        0.0023756747,
        0.019018093,
        0.016555134,
        0.00017168891,
        -0.014371483,
        0.023296528,
        0.01966557,
        0.03834088,
        0.0026724355,
        0.0010632612,
        -0.0076237414,
        0.0027803485,
        0.030520355,
        -0.025556356,
        0.0037769575,
        -0.011051568,
        0.0017900874,
        0.005979654,
        -0.0029406312,
        0.025530964,
        -0.00847435,
        0.010340611,
        0.0054020016,
        0.00010682204,
        -0.0065573063,
        0.017812004,
        0.03529392,
        0.013178091,
        0.02787966,
        -0.0014131851,
        0.014892004,
        -0.009750264,
        0.009902611,
        0.009344002,
        -0.0017504136,
        0.023588529,
        -0.0047037406,
        0.009458263,
        -0.03737601,
        0.016110787,
        0.0012148155,
        0.0022566528,
        0.016897917,
        -0.014117569,
        0.0015052287,
        -0.005862219,
        -0.0006391469,
        -0.012321134,
        -0.011311829,
        -0.013178091,
        0.0020217833,
        -0.0012425873,
        -0.003983262,
        -0.0063510016,
        -0.014879309,
        0.006446219,
        0.00604948,
        -0.0024820007,
        0.002648631,
        0.003431001,
        0.007490437,
        0.000079695,
        0.023474267,
        -0.017634265,
        -0.0065446105,
        0.021823833,
        -0.023194963,
        -0.015133222,
        0.034176704,
        -0.025975311,
        0.0213287,
        -0.01569183,
        0.002215392,
        0.0040975227,
        0.014968178,
        0.014168352,
        -0.0074650454,
        0.007325393,
        -0.003577001,
        -0.009344002,
        -0.025645224,
        0.018104006,
        0.0110325245,
        0.009032959,
        0.010473916,
        -0.0058146105,
        -0.003656349,
        0.0055829147,
        -0.021519136,
        -0.028692182,
        0.02556905,
        0.016364701,
        0.033592705,
        0.012441742,
        0.027117921,
        0.019513223,
        -0.0051480886,
        -0.020122614,
        0.010264438,
        0.019906787,
        0.02545479,
        -0.0107151335,
        0.038797922,
        -0.014980874,
        -0.025404006,
        0.030444182,
        -0.0091345245,
        0.04664384,
        0.0008049839,
        0.0016726527,
        0.012867047,
        -0.0007633263,
        0.0033675227,
        -0.10796385,
        -0.022953745,
        0.020566963,
        0.02051618,
        -0.0062843496,
        -0.005275045,
        0.009305916,
        0.013520873,
        -0.0143206995,
        0.0037039577,
        -0.011235655,
        -0.017977048,
        -0.015222091,
        -0.013584351,
        0.023753572,
        0.008487046,
        0.025175486,
        -0.02866679,
        -0.00038900282,
        0.005160784,
        -0.00070143497,
        0.01148322,
        -0.0049798707,
        0.0067667845,
        -0.0042879577,
        0.007522176,
        -0.009026611,
        0.029910965,
        0.0072492193,
        0.011254699,
        0.02419792,
        -0.009947047,
        0.017304178,
        -0.0040657837,
        -0.011629221,
        -0.0005570219,
        -0.024654964,
        0.0023391745,
        0.014739656,
        -0.026965573,
        0.012759134,
        -0.0074713933,
        -0.002397892,
        -0.047532536,
        0.006855654,
        -0.0044879145,
        0.00028704084,
        0.018688004,
        0.022928353,
        -0.0070333933,
        -0.0037452185,
        0.025797572,
        -0.02960627,
        0.0045958273,
        0.041692533,
        -0.00590348,
        0.016669396,
        -0.001878957,
        -0.0097058285,
        -0.006665219,
        0.0067985235,
        -0.0011465764,
        -0.020211484,
        0.007966524,
        0.008264872,
        0.015933048,
        -0.011057916,
        -0.0023471094,
        0.0051480886,
        -0.015158613,
        0.012048177,
        -0.00648748,
        -0.016618613,
        -0.008969481,
        -0.010086698,
        -0.03867097,
        -0.03407514,
        0.0056717843,
        -0.000030871273,
        -0.02258557,
        0.0019789354,
        -0.009769307,
        0.0074396543,
        -0.0011759351,
        -0.0006601741,
        -0.020148005,
        -0.010239046,
        -0.0067794803,
        -0.007515828,
        -0.015818788,
        -0.0044022184,
        0.011248351,
        0.031002792,
        -0.013673221,
        -0.016961396,
        0.018129397,
        -0.014460352,
        -0.002136044,
        0.017393049,
        -0.02363931,
        -0.0063065668,
        -0.010156524,
        -0.040194444,
        0.0069127847,
        -0.017786613,
        -0.0067413934,
        0.00876635,
        -0.009978785,
        0.01677096,
        0.010042263,
        -0.008290263,
        0.017012179,
        -0.01063896,
        0.012695655,
        0.01376209,
        0.007960176,
        -0.017139135,
        -0.008874264,
        0.015425222,
        0.0052179145,
        0.022369746,
        -0.00923609,
        0.022255484,
        0.030342616,
        -0.0045990013,
        -0.0006197067,
        -0.020414615,
        0.021900006,
        -0.01326696,
        0.016859831,
        -0.027600355,
        -0.011007134,
        0.011546698,
        -0.024642268,
        0.0033326095,
        0.026076877,
        -0.0143841775,
        -0.029961748,
        -0.0041578272,
        0.01224496,
        0.009629655,
        0.0027041747,
        -0.006563654,
        -0.036715835,
        0.01098809,
        -0.023677398,
        -0.011991046,
        0.014955482,
        -0.016021917,
        -0.004053088,
        0.018776875,
        0.003875349,
        -0.008290263,
        0.011146786,
        0.010505655,
        -0.019221222,
        0.015768005,
        0.0013885873,
        0.005947915,
        -0.011851395,
        0.0051480886,
        -0.031078964,
        0.035903316,
        -0.009090089,
        0.008804437,
        -0.009153568,
        -0.004684697,
        -0.013609743,
        -0.016694788,
        -0.013698612,
        0.014676178,
        -0.029860182,
        -0.018624527,
        0.005167132,
        0.019830614,
        0.011146786,
        0.039229576,
        -0.017938962,
        -0.0069953064,
        -0.028616007,
        -0.008322002,
        0.010772264,
        0.013571656,
        0.019856006,
        -0.024388354,
        0.0109055685,
        0.010296177,
        0.024705745,
        -0.016644005,
        -0.0012473481,
        0.0054242187,
        0.004611697,
        -0.004668827,
        -0.01335583,
        0.011242003,
        -0.0015806091,
        0.003970566,
        0.025302442,
        -0.003023153,
        -0.007858611,
        0.017875483,
        0.031282097,
        -0.00537661,
        0.004649784,
        0.003026327,
        -0.0071603497,
        -0.011997394,
        -0.016212352,
        -0.03387201,
        -0.042911317,
        0.009045655,
        0.0074079153,
        0.018256353,
        0.016707484,
        -0.003983262,
        0.022623658,
        0.0074142627,
        0.012137047,
        -0.001381446,
        -0.0058495235,
        -0.019068874,
        0.026940182,
        0.0030009355,
        0.012124351,
        0.007833219,
        -0.020503484,
        0.0060590017,
        0.017177222,
        -0.0040721316,
        0.00012566715,
        0.0010815111,
        0.005113175,
        -0.0015353808,
        0.009483655,
        -0.016301222,
        -0.010346959,
        -0.014460352,
        0.007084176,
        0.015983831,
        0.018814962,
        -0.025213571,
        0.036868185,
        0.00441174,
        0.008734611,
        0.003903914,
        -0.007915742,
        0.0053893058,
        0.028032009,
        -0.020109918,
        -0.0063287844,
        0.0045069577,
        0.024464529,
        0.00759835,
        0.00575748,
        -0.012498873,
        -0.026178442,
        -0.0030056965,
        0.00038047292,
        0.0008442611,
        -0.028920704,
        -0.02341079,
        0.008696524,
        0.018688004,
        0.014396873,
        0.028158965,
        -0.013952525,
        -0.0031501097,
        0.0018995875,
        -0.0034183052,
        0.012949569,
        -0.04088001,
        0.0025851529,
        -0.001883718,
        -0.049462274,
        -0.0088806115,
        -0.004576784,
        -0.021836529,
        -0.014079482,
        -0.015425222,
        0.0040753055,
        0.002727979,
        -0.03138366,
        0.041159317,
        -0.017608874,
        -0.018637223,
        0.014587308,
        0.010486611,
        -0.015387135,
        -0.019424353,
        -0.002800979
      ]
    }
  ],
  "model": "text-embedding-ada-002-v2",
  "usage": {
    "prompt_tokens": 8,
    "total_tokens": 8
  }
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-a-prompt-1.json
================================================
{
  "id": "resp_BB7W5yrFhtybzOkWObDxfYqV7ozGO",
  "object": "response",
  "created_at": 1741990201,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "I am ChatGPT, an AI language model developed by OpenAI. I'm designed to understand and generate human-like text based on the input I receive. I'm here to help answer questions, provide explanations, and assist with a variety of topics. How can I assist you today?",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 11,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 56,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 67
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f9f4fb6dbf"
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-code-interpreter-1.json
================================================
{
  "id": "resp_684b06dab43c819c84f623fec58aa55d029bfe449563c425",
  "object": "response",
  "created_at": 1749747418,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "msg_684b06dcce74819c819ffe9b836d7ff8029bfe449563c425",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "Let's solve the equation step by step:\n\nGiven equation:\n\\[ 3x + 10 = 14 \\]\n\n**Step 1:** Subtract 10 from both sides to isolate the term with \\( x \\):\n\\[\n3x + 10 - 10 = 14 - 10\n\\]\n\\[\n3x = 4\n\\]\n\n**Step 2:** Divide both sides by 3 to solve for \\( x \\):\n\\[\nx = \\frac{4}{3}\n\\]\n\n**Final Answer:**\n\\[\n\\boxed{x = \\frac{4}{3}}\n\\]"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "code_interpreter",
      "container": {
        "type": "auto"
      }
    }
  ],
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 117,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 126,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 243
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-multiple-tools-1.json
================================================
{
  "id": "resp_BB7SZZRUBBEJ2Eueiv2n6wWAwiGNS",
  "object": "response",
  "created_at": 1741989983,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "fc_634f9737a5081a3a684db34818a28b000760294f9ba35d1",
      "type": "function_call",
      "status": "completed",
      "arguments": "{\"query\": \"Detroit Tigers game March 14 2025 time\"}",
      "call_id": "call_AZkZynIOpPQwJ4fyZETY4eTP",
      "name": "search"
    },
    {
      "id": "fc_134f9737a5081a3a684db34818a28b000760294f9ba35d1",
      "type": "function_call",
      "status": "completed",
      "arguments": "{\"city\": \"Detroit\"}",
      "call_id": "call_huHZrdh8RFUy8a8Uqbb2qV1x",
      "name": "weather"
    }
  ],
  "usage": {
    "input_tokens": 111,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 52,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 163
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f9f4fb6dbf"
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-multiple-tools-2.json
================================================
{
  "id": "resp_BB7SboI3cSdJvISDlk9xZn35id4w3",
  "object": "response",
  "created_at": 1741989985,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "The Detroit Tigers game is today at 3 PM in Detroit. The weather in Detroit will be 75°F and sunny, so you won't need a coat!",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 203,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 34,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 237
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f9f4fb6dbf"
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-null-tool-call-1.json
================================================
{
  "id": "resp_684979f245608199b9e74bfc65a64e8a02f0d1d651309ed4",
  "object": "response",
  "created_at": 1749645810,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_684979f3301081998f0f936cc59d6eed02f0d1d651309ed4",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "Could you please specify what you would like me to do?"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "function",
      "description": "useful when you need to search for current weather conditions",
      "name": "weather",
      "parameters": {
        "type": "object",
        "properties": {
          "city": {
            "description": "The city that you want the weather for",
            "type": "string"
          }
        },
        "required": [
          "city"
        ]
      },
      "strict": true
    },
    {
      "type": "function",
      "description": "useful for searching curret events or data",
      "name": "search",
      "parameters": {
        "type": "object",
        "properties": {
          "query": {
            "description": "The detailed search query",
            "type": "string"
          }
        },
        "required": [
          "query"
        ]
      },
      "strict": true
    }
  ],
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 81,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 14,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 95
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-required-tool-call-1.json
================================================
{
  "id": "resp_BB7W9oAuHdViPFBso4YNqG5n48hg6",
  "object": "response",
  "created_at": 1741990205,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "fc_634f9737a5081a3a684db34818a28b000760294f9ba35d1",
      "type": "function_call",
      "status": "completed",
      "arguments": "{\"city\":\"do something\"}",
      "call_id": "call_N18ASdB7htRsbPBeJNax6eTm",
      "name": "weather"
    }
  ],
  "usage": {
    "input_tokens": 95,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 7,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 102
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f9f4fb6dbf"
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-required-tool-call-and-provider-tool-1.json
================================================
{
  "id": "resp_684b07f6c674819ea2c9f1d2368a0fb9059e6f6c83649905",
  "object": "response",
  "created_at": 1749747702,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "fc_684b07f9d20c819e8ddb697bfeb7ae50059e6f6c83649905",
      "type": "function_call",
      "status": "completed",
      "arguments": "{\"city\":\"Detroit\"}",
      "call_id": "call_YzbhDicRsZKscu0Xzob27Tdu",
      "name": "weather"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "code_interpreter",
      "container": {
        "type": "auto"
      }
    },
    {
      "type": "function",
      "description": "useful when you need to search for current weather conditions",
      "name": "weather",
      "parameters": {
        "type": "object",
        "properties": {
          "city": {
            "description": "The city that you want the weather for",
            "type": "string"
          }
        },
        "required": [
          "city"
        ]
      },
      "strict": true
    },
    {
      "type": "function",
      "description": "useful for searching curret events or data",
      "name": "search",
      "parameters": {
        "type": "object",
        "properties": {
          "query": {
            "description": "The detailed search query",
            "type": "string"
          }
        },
        "required": [
          "query"
        ]
      },
      "strict": true
    }
  ],
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 200,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 14,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 214
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-required-tool-call-and-provider-tool-2.json
================================================
{
  "id": "resp_684b07ffc0bc819e96fe62fdee9fd17d059e6f6c83649905",
  "object": "response",
  "created_at": 1749747711,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "ci_684b08030244819ebf2fd8e698c4c132059e6f6c83649905",
      "type": "code_interpreter_call",
      "status": "completed",
      "code": "# Assign the current temperature in Detroit to x\r\nx = 75\r\n\r\n# Calculate Y using the equation: 3x + 10 = Y\r\nY = 3 * x + 10\r\nY",
      "container_id": "cntr_684b08026748819191694a214d3bbc6200a9ed1d31214c57",
      "outputs": null
    },
    {
      "id": "msg_684b08095c80819e9da84914f8ae72ee059e6f6c83649905",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "Given the current temperature in Detroit is 75\u00b0F, the value of Y in the equation 3x + 10 = Y is 235."
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "code_interpreter",
      "container": {
        "type": "auto"
      }
    },
    {
      "type": "function",
      "description": "useful when you need to search for current weather conditions",
      "name": "weather",
      "parameters": {
        "type": "object",
        "properties": {
          "city": {
            "description": "The city that you want the weather for",
            "type": "string"
          }
        },
        "required": [
          "city"
        ]
      },
      "strict": true
    },
    {
      "type": "function",
      "description": "useful for searching curret events or data",
      "name": "search",
      "parameters": {
        "type": "object",
        "properties": {
          "query": {
            "description": "The detailed search query",
            "type": "string"
          }
        },
        "required": [
          "query"
        ]
      },
      "strict": true
    }
  ],
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 517,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 80,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 597
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-system-prompt-1.json
================================================
{
  "id": "resp_BB7W7i7YeYjYi97AG3C3trg9gIAVX",
  "object": "response",
  "created_at": 1741990203,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "I am Nyx the Cthulhu, an embodiment of cryptic knowledge and cosmic humor! Here to answer your questions and chat about anything from the mysteries of the cosmos to your daily conundrums. How may I assist you in your voyage through the unknown today?",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 33,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 57,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 90
  },
  "service_tier": "default",
  "system_fingerprint": "fp_eb9dce56a8"
}



================================================
FILE: tests/Fixtures/openai/generate-text-with-web-search-citations-1.json
================================================
{
  "id": "resp_686e6e3d6810819d8a8df409b49fcb6a034e2410358c31f8",
  "object": "response",
  "created_at": 1752067645,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "ws_686e6e3de318819da96c80a2e811984f034e2410358c31f8",
      "type": "web_search_call",
      "status": "completed",
      "action": {
        "type": "search",
        "query": "London weather forecast today"
      }
    },
    {
      "id": "msg_686e6e406c08819d891c6821dfa2ee32034e2410358c31f8",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [
            {
              "type": "url_citation",
              "end_index": 1120,
              "start_index": 950,
              "title": "What will the weather be like in London on 09 July 2025",
              "url": "https://www.metcheck.com/WEATHER/dayforecast.asp?dateFor=07%2F06%2F2025&lat=51.508500&location=London&locationID=2364784&lon=-0.125700&utm_source=openai"
            }
          ],
          "logprobs": [],
          "text": "As of 1:27 PM on Wednesday, July 9, 2025, in London, the current conditions are mostly cloudy with a temperature of 79\u00b0F (26\u00b0C).\n\n## Weather for London, Greater London, United Kingdom:\nCurrent Conditions: Mostly cloudy, 79\u00b0F (26\u00b0C)\n\nHourly Forecast:\n* 3:00\u202fPM: 77\u00b0F (25\u00b0C), Intermittent clouds\n* 4:00\u202fPM: 78\u00b0F (26\u00b0C), Mostly sunny\n* 5:00\u202fPM: 79\u00b0F (26\u00b0C), Partly sunny\n* 6:00\u202fPM: 80\u00b0F (27\u00b0C), Intermittent clouds\n* 7:00\u202fPM: 78\u00b0F (26\u00b0C), Partly sunny\n* 8:00\u202fPM: 76\u00b0F (24\u00b0C), Partly sunny\n* 9:00\u202fPM: 73\u00b0F (23\u00b0C), Mostly sunny\n* 10:00\u202fPM: 71\u00b0F (22\u00b0C), Mostly clear\n* 11:00\u202fPM: 70\u00b0F (21\u00b0C), Mostly clear\n* 12:00\u202fAM: 69\u00b0F (20\u00b0C), Mostly clear\n* 1:00\u202fAM: 68\u00b0F (20\u00b0C), Mostly clear\n* 2:00\u202fAM: 67\u00b0F (20\u00b0C), Mostly clear\n\n\nAccording to Metcheck, the weather forecast for London on July 9, 2025, indicates temperatures ranging from 16\u00b0C (61\u00b0F) in the early morning to 25\u00b0C (77\u00b0F) in the late afternoon, with minimal chances of precipitation throughout the day. ([metcheck.com](https://www.metcheck.com/WEATHER/dayforecast.asp?dateFor=07%2F06%2F2025&lat=51.508500&location=London&locationID=2364784&lon=-0.125700&utm_source=openai))\n\nPlease note that weather conditions can change, so it's advisable to check for the latest updates from reliable sources. "
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "web_search_preview",
      "search_context_size": "medium",
      "user_location": {
        "type": "approximate",
        "city": null,
        "country": "US",
        "region": null,
        "timezone": null
      }
    }
  ],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 317,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 443,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 760
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-web-search-citations-included-in-turn-1.json
================================================
{
  "id": "resp_686e7aae3180819ea5788d621aa3a139054cb0c9bb0cdde4",
  "object": "response",
  "created_at": 1752070830,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "ws_686e7ab039f4819eb5f6440d096b113f054cb0c9bb0cdde4",
      "type": "web_search_call",
      "status": "completed",
      "action": {
        "type": "search",
        "query": "London weather forecast today"
      }
    },
    {
      "id": "msg_686e7ab330e0819e95e421d16f24f686054cb0c9bb0cdde4",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [
            {
              "type": "url_citation",
              "end_index": 1052,
              "start_index": 883,
              "title": "What will the weather be like in London on 09 July 2025",
              "url": "https://www.metcheck.com/WEATHER/dayforecast.asp?dateFor=09%2F07%2F2025&lat=51.508530&location=London&locationID=691044&lon=-0.125740&utm_source=openai"
            }
          ],
          "logprobs": [],
          "text": "As of 3:20\u202fPM BST on Wednesday, July 9, 2025, the weather in London is mostly cloudy with a temperature of 78\u00b0F (26\u00b0C).\n\n## Weather for London, Greater London, United Kingdom:\nCurrent Conditions: Mostly cloudy, 78\u00b0F (26\u00b0C)\n\nHourly Forecast:\n* 4:00\u202fPM: 80\u00b0F (26\u00b0C), Mostly sunny\n* 5:00\u202fPM: 80\u00b0F (27\u00b0C), Partly sunny\n* 6:00\u202fPM: 80\u00b0F (27\u00b0C), Intermittent clouds\n* 7:00\u202fPM: 78\u00b0F (26\u00b0C), Partly sunny\n* 8:00\u202fPM: 76\u00b0F (24\u00b0C), Partly sunny\n* 9:00\u202fPM: 73\u00b0F (23\u00b0C), Mostly sunny\n* 10:00\u202fPM: 71\u00b0F (22\u00b0C), Mostly clear\n* 11:00\u202fPM: 70\u00b0F (21\u00b0C), Mostly clear\n* 12:00\u202fAM: 69\u00b0F (20\u00b0C), Mostly clear\n* 1:00\u202fAM: 68\u00b0F (20\u00b0C), Mostly clear\n* 2:00\u202fAM: 67\u00b0F (20\u00b0C), Mostly clear\n* 3:00\u202fAM: 66\u00b0F (19\u00b0C), Clear\n\n\nAccording to Metcheck, the forecast for today indicates temperatures reaching up to 26\u00b0C (79\u00b0F) in the afternoon, with a low chance of precipitation and varying cloud cover throughout the day. ([metcheck.com](https://www.metcheck.com/WEATHER/dayforecast.asp?dateFor=09%2F07%2F2025&lat=51.508530&location=London&locationID=691044&lon=-0.125740&utm_source=openai)) "
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [
    {
      "type": "web_search_preview",
      "search_context_size": "medium",
      "user_location": {
        "type": "approximate",
        "city": null,
        "country": "US",
        "region": null,
        "timezone": null
      }
    }
  ],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 317,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 400,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 717
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/generate-text-with-web-search-citations-included-in-turn-2.json
================================================
{
  "id": "resp_686e7ab46d98819e8e9ad92213646506064232ec811b439b",
  "object": "response",
  "created_at": 1752070836,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-4.1-2025-04-14",
  "output": [
    {
      "id": "msg_686e7ab4c754819e83cd8ef82a988931064232ec811b439b",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "logprobs": [],
          "text": "**Metcheck** is a well-known weather forecasting website in the UK and globally. It provides weather forecasts, radar, and other meteorological data using a combination of in-house modeling and data from major sources like the UK Met Office and ECMWF.\n\n**Reliability Factors:**\n\n- **Reputation:** Metcheck is popular and widely used by the public, but it is not the UK\u2019s *official* weather authority; that would be the [Met Office](https://www.metoffice.gov.uk/), the United Kingdom\u2019s government meteorological organization.\n- **Data Sources:** While Metcheck uses good models and often aligns with official sources, it is considered a *secondary* source. Primary and most authoritative data for the UK comes from the Met Office.\n- **Accuracy:** Day-of and short-range forecasts on Metcheck are generally quite accurate, but official warnings and statements (especially for extreme weather) are best sourced directly from the Met Office or the BBC.\n\n**In summary:**  \n- Metcheck is *reasonably reliable* for general, daily forecasts.\n- For the *most authoritative and official information*, refer to the [Met Office](https://www.metoffice.gov.uk/weather/forecast/gcpvj0v07) or [BBC Weather](https://www.bbc.co.uk/weather/2643743).\n- For academic, legal, or critical uses, always cite the Met Office.\n\n**Citations:**\n- [How reliable are private weather forecasting sites? | The Guardian](https://www.theguardian.com/environment/shortcuts/2011/apr/24/how-reliable-private-weather-forecast-websites)\n- [Met Office official site](https://www.metoffice.gov.uk)\n\nIf you\u2019d like the **official forecast for London from the Met Office or BBC**, let me know!"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 429,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 364,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 793
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/nullable-anyof-structured-1.json
================================================
{
  "id": "resp_nullable_anyof_test_1",
  "object": "response",
  "created_at": 1741990325,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_nullable_anyof_test_1",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"name\":\"debug_config\",\"flexible_value\":null}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 120,
    "output_tokens": 25,
    "total_tokens": 145
  },
  "service_tier": "default",
  "system_fingerprint": "fp_eb9dce56a8"
}


================================================
FILE: tests/Fixtures/openai/stream-basic-text-responses-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4ad7d3c81999e9e02548c91e2a8077218073e9990d3","object":"response","created_at":1750705325,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4ad7d3c81999e9e02548c91e2a8077218073e9990d3","object":"response","created_at":1750705325,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":3,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":4,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":5,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" am"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" Open"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"AI"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"'s"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" language"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" model"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" known"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" as"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" G"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"PT"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"-"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"'m"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" an"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" artificial"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" intelligence"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" designed"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" to"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" comprehend"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" text"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" inputs"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" generate"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" text"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" outputs"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" based"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" on"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" those"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" inputs"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":38,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"'m"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" trained"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" on"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":43,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" wide"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":44,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" range"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":45,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" of"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":46,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" internet"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":47,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" text"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":48,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":49,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" but"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":50,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":51,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" don"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":52,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"'t"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":53,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" have"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":54,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" personal"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":55,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" experiences"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":56,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" because"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":57,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":58,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" am"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":59,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":60,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" machine"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":61,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" learning"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":62,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":" model"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":63,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":64,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"text":"I am OpenAI's language model, known as GPT-3. I'm an artificial intelligence designed to comprehend text inputs and generate text outputs based on those inputs. I'm trained on a wide range of internet text, but I don't have personal experiences because I am a machine learning model."}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":65,"item_id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"I am OpenAI's language model, known as GPT-3. I'm an artificial intelligence designed to comprehend text inputs and generate text outputs based on those inputs. I'm trained on a wide range of internet text, but I don't have personal experiences because I am a machine learning model."}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":66,"output_index":0,"item":{"id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"I am OpenAI's language model, known as GPT-3. I'm an artificial intelligence designed to comprehend text inputs and generate text outputs based on those inputs. I'm trained on a wide range of internet text, but I don't have personal experiences because I am a machine learning model."}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":67,"response":{"id":"resp_6859a4ad7d3c81999e9e02548c91e2a8077218073e9990d3","object":"response","created_at":1750705325,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[{"id":"msg_6859a4af047c8199a905d58a69677087077218073e9990d3","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"I am OpenAI's language model, known as GPT-3. I'm an artificial intelligence designed to comprehend text inputs and generate text outputs based on those inputs. I'm trained on a wide range of internet text, but I don't have personal experiences because I am a machine learning model."}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":10,"input_tokens_details":{"cached_tokens":0},"output_tokens":62,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":72},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-falsy-argument-conversation-responses-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4ceb7388199b9a52d80437386e907b10737d88fc6b4","object":"response","created_at":1750705358,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4ceb7388199b9a52d80437386e907b10737d88fc6b4","object":"response","created_at":1750705358,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","type":"function_call","status":"in_progress","arguments":"","call_id":"call_HvFuJxrSMSLGrCenm9e67o4N","name":"get_models"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":3,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"{\n"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":4,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":" \""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"model"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"Id"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"0"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":11,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"\n"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":12,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"delta":"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":13,"item_id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","output_index":0,"arguments":"{\n  \"modelId\": 0\n}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":14,"output_index":0,"item":{"id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","type":"function_call","status":"completed","arguments":"{\n  \"modelId\": 0\n}","call_id":"call_HvFuJxrSMSLGrCenm9e67o4N","name":"get_models"}}

event: response.completed
data: {"type":"response.completed","sequence_number":15,"response":{"id":"resp_6859a4ceb7388199b9a52d80437386e907b10737d88fc6b4","object":"response","created_at":1750705358,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[{"id":"fc_6859a4d000c08199b963880d4d4d42b507b10737d88fc6b4","type":"function_call","status":"completed","arguments":"{\n  \"modelId\": 0\n}","call_id":"call_HvFuJxrSMSLGrCenm9e67o4N","name":"get_models"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":68,"input_tokens_details":{"cached_tokens":0},"output_tokens":17,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":85},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-falsy-argument-conversation-responses-2.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4d09fc08199aba7ddab3786365e07b10737d88fc6b4","object":"response","created_at":1750705360,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4d09fc08199aba7ddab3786365e07b10737d88fc6b4","object":"response","created_at":1750705360,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":3,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":4,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":"The"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":5,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" model"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" with"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" id"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":"0"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" is"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" considered"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" fun"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":"niest"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" of"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":" all"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":18,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"text":"The model with id 0 is considered the funniest of all."}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":19,"item_id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"The model with id 0 is considered the funniest of all."}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":20,"output_index":0,"item":{"id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The model with id 0 is considered the funniest of all."}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":21,"response":{"id":"resp_6859a4d09fc08199aba7ddab3786365e07b10737d88fc6b4","object":"response","created_at":1750705360,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4-0613","output":[{"id":"msg_6859a4d213048199b5dfdad6a50ea8f207b10737d88fc6b4","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The model with id 0 is considered the funniest of all."}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Returns info about of available models","name":"get_models","parameters":{"type":"object","properties":{"modelId":{"description":"Id of the model to load. Returns all models if null","type":"number"}},"required":[]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":103,"input_tokens_details":{"cached_tokens":0},"output_tokens":16,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":119},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4b648b0819bb6963bad04fb966c0b58dbf6cd1e2457","object":"response","created_at":1750705334,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4b648b0819bb6963bad04fb966c0b58dbf6cd1e2457","object":"response","created_at":1750705334,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","type":"function_call","status":"in_progress","arguments":"","call_id":"call_SJiaC1TXbxeEz3E9NqIitlNw","name":"search"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":3,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"{"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":4,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"\"query"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"\"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" Tigers"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" game"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" schedule"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" October"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":11,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":12,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"10"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":13,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":14,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"202"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":15,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"3"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":16,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":17,"item_id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","output_index":0,"arguments":"{\"query\":\"Detroit Tigers game schedule October 10 2023\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":18,"output_index":0,"item":{"id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","type":"function_call","status":"completed","arguments":"{\"query\":\"Detroit Tigers game schedule October 10 2023\"}","call_id":"call_SJiaC1TXbxeEz3E9NqIitlNw","name":"search"}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":19,"output_index":1,"item":{"id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","type":"function_call","status":"in_progress","arguments":"","call_id":"call_m6EXLHUhaq7ofMlz1ktzS8R8","name":"weather"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":20,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"delta":"{"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":21,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"delta":"\"city"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":22,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":23,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"delta":"\"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":24,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":25,"item_id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","output_index":1,"arguments":"{\"city\":\"Detroit\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":26,"output_index":1,"item":{"id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_m6EXLHUhaq7ofMlz1ktzS8R8","name":"weather"}}

event: response.completed
data: {"type":"response.completed","sequence_number":27,"response":{"id":"resp_6859a4b648b0819bb6963bad04fb966c0b58dbf6cd1e2457","object":"response","created_at":1750705334,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[{"id":"fc_6859a4b76190819b9a58d48fd01dde650b58dbf6cd1e2457","type":"function_call","status":"completed","arguments":"{\"query\":\"Detroit Tigers game schedule October 10 2023\"}","call_id":"call_SJiaC1TXbxeEz3E9NqIitlNw","name":"search"},{"id":"fc_6859a4b7bc80819b97c90b9e033116780b58dbf6cd1e2457","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_m6EXLHUhaq7ofMlz1ktzS8R8","name":"weather"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":76,"input_tokens_details":{"cached_tokens":0},"output_tokens":52,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":128},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-2.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4b8411c819b82b7ccf77f486bfb0b58dbf6cd1e2457","object":"response","created_at":1750705336,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4b8411c819b82b7ccf77f486bfb0b58dbf6cd1e2457","object":"response","created_at":1750705336,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":3,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":4,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"The"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":5,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" Detroit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" Tigers"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" game"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" is"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" at"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" PM"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" today"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" The"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" weather"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" is"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"75"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"°"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" sunny"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" so"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" you"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" probably"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" won't"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" need"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":" coat"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"delta":"!"}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":32,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"text":"The Detroit Tigers game is at 3 PM today. The weather is 75° and sunny, so you probably won't need a coat!"}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":33,"item_id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"The Detroit Tigers game is at 3 PM today. The weather is 75° and sunny, so you probably won't need a coat!"}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":34,"output_index":0,"item":{"id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Detroit Tigers game is at 3 PM today. The weather is 75° and sunny, so you probably won't need a coat!"}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":35,"response":{"id":"resp_6859a4b8411c819b82b7ccf77f486bfb0b58dbf6cd1e2457","object":"response","created_at":1750705336,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[{"id":"msg_6859a4b8ec6c819b997125839e26c17b0b58dbf6cd1e2457","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Detroit Tigers game is at 3 PM today. The weather is 75° and sunny, so you probably won't need a coat!"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":144,"input_tokens_details":{"cached_tokens":0},"output_tokens":30,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":174},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4ba39a8819aa8e4e70ad75e77af0a7ba57447365234","object":"response","created_at":1750705338,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4ba39a8819aa8e4e70ad75e77af0a7ba57447365234","object":"response","created_at":1750705338,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_6859a4bf849c819abf1f2771923bab5c0a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_6859a4bf849c819abf1f2771923bab5c0a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","type":"function_call","status":"in_progress","arguments":"","call_id":"call_GLsIMps0vfGJeDhu3zAjy3wd","name":"search"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":"{\""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":"query"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" \""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" Tigers"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":11,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" game"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":12,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" today"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":13,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" start"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":14,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":" time"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":15,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":16,"item_id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","output_index":1,"arguments":"{\"query\": \"Detroit Tigers game today start time\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":17,"output_index":1,"item":{"id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","type":"function_call","status":"completed","arguments":"{\"query\": \"Detroit Tigers game today start time\"}","call_id":"call_GLsIMps0vfGJeDhu3zAjy3wd","name":"search"}}

event: response.completed
data: {"type":"response.completed","sequence_number":18,"response":{"id":"resp_6859a4ba39a8819aa8e4e70ad75e77af0a7ba57447365234","object":"response","created_at":1750705338,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[{"id":"rs_6859a4bf849c819abf1f2771923bab5c0a7ba57447365234","type":"reasoning","summary":[]},{"id":"fc_6859a4c0aac4819a9357cdf5bc18c25f0a7ba57447365234","type":"function_call","status":"completed","arguments":"{\"query\": \"Detroit Tigers game today start time\"}","call_id":"call_GLsIMps0vfGJeDhu3zAjy3wd","name":"search"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":78,"input_tokens_details":{"cached_tokens":0},"output_tokens":532,"output_tokens_details":{"reasoning_tokens":512},"total_tokens":610},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-2.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4c15e8c819a99a89381882f30e30a7ba57447365234","object":"response","created_at":1750705345,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4c15e8c819a99a89381882f30e30a7ba57447365234","object":"response","created_at":1750705345,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_6859a4c25dac819abb3321c67cda3aa40a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_6859a4c25dac819abb3321c67cda3aa40a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","type":"function_call","status":"in_progress","arguments":"","call_id":"call_o4ixSmTdq08gNusjof7xOyNQ","name":"weather"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":"{\""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":"city"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":" \""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":11,"item_id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","output_index":1,"arguments":"{\"city\": \"Detroit\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":12,"output_index":1,"item":{"id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","type":"function_call","status":"completed","arguments":"{\"city\": \"Detroit\"}","call_id":"call_o4ixSmTdq08gNusjof7xOyNQ","name":"weather"}}

event: response.completed
data: {"type":"response.completed","sequence_number":13,"response":{"id":"resp_6859a4c15e8c819a99a89381882f30e30a7ba57447365234","object":"response","created_at":1750705345,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[{"id":"rs_6859a4c25dac819abb3321c67cda3aa40a7ba57447365234","type":"reasoning","summary":[]},{"id":"fc_6859a4c2bde0819abc60ce8614d229180a7ba57447365234","type":"function_call","status":"completed","arguments":"{\"city\": \"Detroit\"}","call_id":"call_o4ixSmTdq08gNusjof7xOyNQ","name":"weather"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":116,"input_tokens_details":{"cached_tokens":0},"output_tokens":79,"output_tokens_details":{"reasoning_tokens":64},"total_tokens":195},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-3.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4c370a0819aad514576f73f595a0a7ba57447365234","object":"response","created_at":1750705347,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4c370a0819aad514576f73f595a0a7ba57447365234","object":"response","created_at":1750705347,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_6859a4c4c970819aa29ccec55857c4da0a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_6859a4c4c970819aa29ccec55857c4da0a7ba57447365234","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":5,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"The"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" Tigers"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" game"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" is"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" scheduled"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"pm"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" today"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" current"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" weather"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" in"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" Detroit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" is"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"75"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"°"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" sunny"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" That"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" should"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" be"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" perfect"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" weather"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" being"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" outdoors"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":38,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" so"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" you"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" likely"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" won't"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":43,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" need"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":44,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":45,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" coat"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":46,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":47,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" Enjoy"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":48,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":49,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":" game"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":50,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"delta":"!"}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":51,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"text":"The Tigers game is scheduled for 3pm today, and the current weather in Detroit is 75° and sunny. That should be perfect weather for being outdoors, so you likely won't need a coat. Enjoy the game!"}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":52,"item_id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","output_index":1,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"The Tigers game is scheduled for 3pm today, and the current weather in Detroit is 75° and sunny. That should be perfect weather for being outdoors, so you likely won't need a coat. Enjoy the game!"}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":53,"output_index":1,"item":{"id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Tigers game is scheduled for 3pm today, and the current weather in Detroit is 75° and sunny. That should be perfect weather for being outdoors, so you likely won't need a coat. Enjoy the game!"}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":54,"response":{"id":"resp_6859a4c370a0819aad514576f73f595a0a7ba57447365234","object":"response","created_at":1750705347,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o3-mini-2025-01-31","output":[{"id":"rs_6859a4c4c970819aa29ccec55857c4da0a7ba57447365234","type":"reasoning","summary":[]},{"id":"msg_6859a4c51b64819a8d996728172168880a7ba57447365234","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Tigers game is scheduled for 3pm today, and the current weather in Detroit is 75° and sunny. That should be perfect weather for being outdoors, so you likely won't need a coat. Enjoy the game!"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":148,"input_tokens_details":{"cached_tokens":0},"output_tokens":111,"output_tokens_details":{"reasoning_tokens":64},"total_tokens":259},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-past-reasoning-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4c630bc8198a88bce457fd1a7a90179e266e69a389d","object":"response","created_at":1750705350,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4c630bc8198a88bce457fd1a7a90179e266e69a389d","object":"response","created_at":1750705350,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","type":"reasoning","summary":[]}}

event: response.reasoning_summary_part.added
data: {"type":"response.reasoning_summary_part.added","sequence_number":3,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"part":{"type":"summary_text","text":""}}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":4,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"**Providing"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":5,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" game"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":6,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" details"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":7,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"**\n\nThe"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":8,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" Tigers"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":9,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" game"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":10,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" today"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":11,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" is"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":12,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" set"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":13,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" for"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":14,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" June"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":15,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" 23"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":16,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":","}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":17,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" 202"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":18,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"5"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":19,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":","}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":20,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" at"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":21,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" a"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":22,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" specific"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":23,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" time"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":24,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"."}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":25,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" I'm"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":26,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" also"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":27,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" considering"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":28,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" the"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":29,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" current"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":30,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" temperature"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":31,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" in"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":32,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" Detroit"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":33,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":","}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":34,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" which"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":35,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" is"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":36,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" X"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":37,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"°"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":38,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" with"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":39,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" conditions"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":40,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" Y"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":41,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"."}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":42,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" I"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":43,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" need"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":44,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" to"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":45,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" let"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":46,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" the"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":47,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" user"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":48,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" know"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":49,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" if"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":50,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" wearing"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":51,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" a"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":52,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" coat"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":53,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" is"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":54,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" advisable"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":55,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" based"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":56,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" on"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":57,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" that"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":58,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" weather"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":59,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"."}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":60,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" It"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":61,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"’s"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":62,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" important"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":63,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" to"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":64,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" provide"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":65,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" this"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":66,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" information"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":67,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" clearly"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":68,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" so"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":69,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" the"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":70,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" user"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":71,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" can"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":72,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" make"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":73,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" a"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":74,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" comfortable"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":75,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" choice"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":76,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" about"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":77,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" their"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":78,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" attire"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":79,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" for"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":80,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" the"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":81,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":" game"}

event: response.reasoning_summary_text.delta
data: {"type":"response.reasoning_summary_text.delta","sequence_number":82,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"delta":"."}

event: response.reasoning_summary_text.done
data: {"type":"response.reasoning_summary_text.done","sequence_number":83,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"text":"**Providing game details**\n\nThe Tigers game today is set for June 23, 2025, at a specific time. I'm also considering the current temperature in Detroit, which is X° with conditions Y. I need to let the user know if wearing a coat is advisable based on that weather. It’s important to provide this information clearly so the user can make a comfortable choice about their attire for the game."}

event: response.reasoning_summary_part.done
data: {"type":"response.reasoning_summary_part.done","sequence_number":84,"item_id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","output_index":0,"summary_index":0,"part":{"type":"summary_text","text":"**Providing game details**\n\nThe Tigers game today is set for June 23, 2025, at a specific time. I'm also considering the current temperature in Detroit, which is X° with conditions Y. I need to let the user know if wearing a coat is advisable based on that weather. It’s important to provide this information clearly so the user can make a comfortable choice about their attire for the game."}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":85,"output_index":0,"item":{"id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","type":"reasoning","summary":[{"type":"summary_text","text":"**Providing game details**\n\nThe Tigers game today is set for June 23, 2025, at a specific time. I'm also considering the current temperature in Detroit, which is X° with conditions Y. I need to let the user know if wearing a coat is advisable based on that weather. It’s important to provide this information clearly so the user can make a comfortable choice about their attire for the game."}]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":86,"output_index":1,"item":{"id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","type":"function_call","status":"in_progress","arguments":"","call_id":"call_nNlsgLEC5L6HTPLYNLGxYOrZ","name":"search"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":87,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"{\""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":88,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"query"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":89,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":90,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" \""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":91,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":92,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" Tigers"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":93,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" game"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":94,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" time"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":95,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" June"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":96,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":97,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"23"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":98,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":99,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"202"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":100,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"5"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":101,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":102,"item_id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","output_index":1,"arguments":"{\"query\": \"Detroit Tigers game time June 23 2025\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":103,"output_index":1,"item":{"id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","type":"function_call","status":"completed","arguments":"{\"query\": \"Detroit Tigers game time June 23 2025\"}","call_id":"call_nNlsgLEC5L6HTPLYNLGxYOrZ","name":"search"}}

event: response.completed
data: {"type":"response.completed","sequence_number":104,"response":{"id":"resp_6859a4c630bc8198a88bce457fd1a7a90179e266e69a389d","object":"response","created_at":1750705350,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[{"id":"rs_6859a4c69e0481989e14c31c10bb34fb0179e266e69a389d","type":"reasoning","summary":[{"type":"summary_text","text":"**Providing game details**\n\nThe Tigers game today is set for June 23, 2025, at a specific time. I'm also considering the current temperature in Detroit, which is X° with conditions Y. I need to let the user know if wearing a coat is advisable based on that weather. It’s important to provide this information clearly so the user can make a comfortable choice about their attire for the game."}]},{"id":"fc_6859a4caa4a48198964d63077ab462f20179e266e69a389d","type":"function_call","status":"completed","arguments":"{\"query\": \"Detroit Tigers game time June 23 2025\"}","call_id":"call_nNlsgLEC5L6HTPLYNLGxYOrZ","name":"search"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":78,"input_tokens_details":{"cached_tokens":0},"output_tokens":221,"output_tokens_details":{"reasoning_tokens":192},"total_tokens":299},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-past-reasoning-2.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4cb533c8198adb1e4ffb3b216760179e266e69a389d","object":"response","created_at":1750705355,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4cb533c8198adb1e4ffb3b216760179e266e69a389d","object":"response","created_at":1750705355,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_6859a4cbda5c8198b2a84f97bcf31e420179e266e69a389d","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_6859a4cbda5c8198b2a84f97bcf31e420179e266e69a389d","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","type":"function_call","status":"in_progress","arguments":"","call_id":"call_n2jI7QekRXWoUL84n26vTYVt","name":"weather"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"delta":"{\""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"delta":"city"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"delta":"\":\""}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"delta":"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":10,"item_id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","output_index":1,"arguments":"{\"city\":\"Detroit\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":11,"output_index":1,"item":{"id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_n2jI7QekRXWoUL84n26vTYVt","name":"weather"}}

event: response.completed
data: {"type":"response.completed","sequence_number":12,"response":{"id":"resp_6859a4cb533c8198adb1e4ffb3b216760179e266e69a389d","object":"response","created_at":1750705355,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[{"id":"rs_6859a4cbda5c8198b2a84f97bcf31e420179e266e69a389d","type":"reasoning","summary":[]},{"id":"fc_6859a4cc4e788198afbbbbfdb724846a0179e266e69a389d","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_n2jI7QekRXWoUL84n26vTYVt","name":"weather"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":355,"input_tokens_details":{"cached_tokens":0},"output_tokens":19,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":374},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-multi-tool-conversation-responses-reasoning-past-reasoning-3.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4cd0ccc8198a1d51eabe6cb3cc20179e266e69a389d","object":"response","created_at":1750705357,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4cd0ccc8198a1d51eabe6cb3cc20179e266e69a389d","object":"response","created_at":1750705357,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":3,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":4,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"The"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":5,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Tigers"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" are"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" playing"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" at"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Comer"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"ica"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Park"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" today"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" ("}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"June"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"23"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"202"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"5"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":")"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" with"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" first"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" pitch"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" scheduled"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":":"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"00"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"PM"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Eastern"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":".\n\n"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"Right"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" now"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" in"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":38,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Detroit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" it"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"’s"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" sunny"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":43,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" about"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":44,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":45,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"75"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":46,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"°F"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":47,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":48,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" That"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":49,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"’s"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":50,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" warm"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":51,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" enough"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":52,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" that"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":53,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" you"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":54,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" won"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":55,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"’t"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":56,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" need"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":57,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":58,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" heavy"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":59,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" coat"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":60,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"—"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":61,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"just"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":62,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" something"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":63,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" light"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":64,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" ("}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":65,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":66,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" hoodie"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":67,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" or"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":68,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" light"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":69,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" jacket"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":70,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":")"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":71,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" would"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":72,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" be"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":73,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" fine"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":74,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":75,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" especially"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":76,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" if"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":77,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" you"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":78,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" plan"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":79,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" to"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":80,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" stick"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":81,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" around"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":82,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" into"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":83,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":84,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" evening"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":85,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" when"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":86,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" it"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":87,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" might"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":88,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" cool"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":89,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" off"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":90,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" into"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":91,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":92,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":93,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"60"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":94,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"s"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":95,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":96,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" Enjoy"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":97,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":98,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":" game"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":99,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"delta":"!"}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":100,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"text":"The Tigers are playing at Comerica Park today (June 23, 2025) with first pitch scheduled for 3:00 PM Eastern.\n\nRight now in Detroit it’s sunny and about 75°F. That’s warm enough that you won’t need a heavy coat—just something light (a hoodie or light jacket) would be fine, especially if you plan to stick around into the evening when it might cool off into the 60s. Enjoy the game!"}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":101,"item_id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"The Tigers are playing at Comerica Park today (June 23, 2025) with first pitch scheduled for 3:00 PM Eastern.\n\nRight now in Detroit it’s sunny and about 75°F. That’s warm enough that you won’t need a heavy coat—just something light (a hoodie or light jacket) would be fine, especially if you plan to stick around into the evening when it might cool off into the 60s. Enjoy the game!"}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":102,"output_index":0,"item":{"id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Tigers are playing at Comerica Park today (June 23, 2025) with first pitch scheduled for 3:00 PM Eastern.\n\nRight now in Detroit it’s sunny and about 75°F. That’s warm enough that you won’t need a heavy coat—just something light (a hoodie or light jacket) would be fine, especially if you plan to stick around into the evening when it might cool off into the 60s. Enjoy the game!"}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":103,"response":{"id":"resp_6859a4cd0ccc8198a1d51eabe6cb3cc20179e266e69a389d","object":"response","created_at":1750705357,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"o4-mini-2025-04-16","output":[{"id":"msg_6859a4cd7e588198a12c02059ebd1b290179e266e69a389d","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"The Tigers are playing at Comerica Park today (June 23, 2025) with first pitch scheduled for 3:00 PM Eastern.\n\nRight now in Detroit it’s sunny and about 75°F. That’s warm enough that you won’t need a heavy coat—just something light (a hoodie or light jacket) would be fine, especially if you plan to stick around into the evening when it might cool off into the 60s. Enjoy the game!"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"low","summary":"detailed"},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get weather information","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"City name","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"Search for information","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":414,"input_tokens_details":{"cached_tokens":0},"output_tokens":100,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":514},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-rate-limited-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: error
data: {"type":"error","sequence_number":2,"error":{"type":"tokens","code":"rate_limit_exceeded","message":"Request too large for gpt-4o in project proj_f4H0b30rYp2y52CGw64BafkL organization org-H9rGLigVW0aTEjgfHIg3Ircj on tokens per min (TPM): Limit 1, Requested 30. The input or output tokens must be reduced in order to run successfully. Visit https://platform.openai.com/account/rate-limits to learn more.","param":null}}

event: response.failed
data: {"type":"response.failed","sequence_number":3,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"failed","background":false,"error":{"code":"rate_limit_exceeded","message":"Request too large for gpt-4o in project proj_f4H0b30rYp2y52CGw64BafkL organization org-H9rGLigVW0aTEjgfHIg3Ircj on tokens per min (TPM): Limit 1, Requested 30. The input or output tokens must be reduced in order to run successfully. Visit https://platform.openai.com/account/rate-limits to learn more."},"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-reasoning-effort-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_689a2420c578819a8722f5fe893f5ce40caba6b0e06e935a","object":"response","created_at":1754932256,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-5-2025-08-07","output":[],"parallel_tool_calls":true,"previous_response_id":null,"prompt_cache_key":null,"reasoning":{"effort":"low","summary":null},"safety_identifier":null,"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"},"verbosity":"medium"},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_689a2420c578819a8722f5fe893f5ce40caba6b0e06e935a","object":"response","created_at":1754932256,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-5-2025-08-07","output":[],"parallel_tool_calls":true,"previous_response_id":null,"prompt_cache_key":null,"reasoning":{"effort":"low","summary":null},"safety_identifier":null,"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"},"verbosity":"medium"},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_689a24215ccc819aae0efab8490cbae90caba6b0e06e935a","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_689a24215ccc819aae0efab8490cbae90caba6b0e06e935a","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":5,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"part":{"type":"output_text","annotations":[],"logprobs":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"I","logprobs":[],"obfuscation":"w1Urf0p1hclpVYY"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"’m","logprobs":[],"obfuscation":"3JgemHiTl4pUxn"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" an","logprobs":[],"obfuscation":"0fVwW8UhXF89m"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" AI","logprobs":[],"obfuscation":"TK9yn6mQL5LgY"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" assistant","logprobs":[],"obfuscation":"4X6aT3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" created","logprobs":[],"obfuscation":"xUf9FeEC"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" by","logprobs":[],"obfuscation":"YKAF3lGPTnpof"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" Open","logprobs":[],"obfuscation":"MLyL0ghLf81"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"AI","logprobs":[],"obfuscation":"1EEhoc6bjM4oTm"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":".","logprobs":[],"obfuscation":"5QSOzg3OBjMDr7n"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" I","logprobs":[],"obfuscation":"NmU0vh8X8NgxBF"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" can","logprobs":[],"obfuscation":"QHfBFZPwck7o"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" help","logprobs":[],"obfuscation":"kqIKAscmhit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" with","logprobs":[],"obfuscation":"vRyhSEsLtba"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" questions","logprobs":[],"obfuscation":"InUH1p"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":",","logprobs":[],"obfuscation":"XWXQHS3bRT7W27E"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" writing","logprobs":[],"obfuscation":"Yjh41WZs"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":",","logprobs":[],"obfuscation":"gVM27R6suAWAont"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" problem","logprobs":[],"obfuscation":"Gzezh7se"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"-solving","logprobs":[],"obfuscation":"l9YhtnlK"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":",","logprobs":[],"obfuscation":"zYdI4czaPtmNAqQ"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" and","logprobs":[],"obfuscation":"j6lo6qfKZ4U0"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" interpreting","logprobs":[],"obfuscation":"fbU"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" images","logprobs":[],"obfuscation":"OUe0sinGD"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" you","logprobs":[],"obfuscation":"KATKCjsHTqrT"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" share","logprobs":[],"obfuscation":"6yA8upYG0K"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":".","logprobs":[],"obfuscation":"l5bu4TQcJqAQn9z"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" My","logprobs":[],"obfuscation":"UnoPpmDCTHYNG"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" knowledge","logprobs":[],"obfuscation":"11Qhaz"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" is","logprobs":[],"obfuscation":"EgATdYMW4BcZE"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" up","logprobs":[],"obfuscation":"VMaGBXplfgl9J"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" to","logprobs":[],"obfuscation":"aTA5zNUFEqXe0"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":38,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" October","logprobs":[],"obfuscation":"43T8U7zy"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" ","logprobs":[],"obfuscation":"OVqnNJZd5LWao7G"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"202","logprobs":[],"obfuscation":"rwJf8uY9Ki4eT"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"4","logprobs":[],"obfuscation":"kF5VfPVIbRvDvDO"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":",","logprobs":[],"obfuscation":"uAuNMdl6AXxchMQ"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":43,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" and","logprobs":[],"obfuscation":"MN8t05smqhWx"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":44,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" I","logprobs":[],"obfuscation":"LadoA4L1ISaJV0"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":45,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" don","logprobs":[],"obfuscation":"N2XxBEwsqcyP"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":46,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"’t","logprobs":[],"obfuscation":"N89VfbVyWkPUcN"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":47,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" have","logprobs":[],"obfuscation":"2hUkS4vbC8l"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":48,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" personal","logprobs":[],"obfuscation":"2nJXqMy"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":49,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" experiences","logprobs":[],"obfuscation":"ZjJV"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":50,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" or","logprobs":[],"obfuscation":"yoQwPEj0LJe5L"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":51,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" real","logprobs":[],"obfuscation":"w4sUpp03Qii"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":52,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"-time","logprobs":[],"obfuscation":"Eij9Mx9fudP"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":53,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" internet","logprobs":[],"obfuscation":"lsbcsz3"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":54,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" access","logprobs":[],"obfuscation":"K5X6UTDUC"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":55,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":".","logprobs":[],"obfuscation":"mLsFTcITOarraeC"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":56,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" How","logprobs":[],"obfuscation":"WZn7GOxIkHku"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":57,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" can","logprobs":[],"obfuscation":"GFFhbMiUJFYm"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":58,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" I","logprobs":[],"obfuscation":"3hbovXeeBAh9I0"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":59,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" help","logprobs":[],"obfuscation":"9fL9Z1zMKPr"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":60,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" you","logprobs":[],"obfuscation":"GMt9XSMqeUVF"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":61,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":" today","logprobs":[],"obfuscation":"5igDrXBkpu"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":62,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"delta":"?","logprobs":[],"obfuscation":"RZOEKm4Oa3Atao2"}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":63,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"text":"I’m an AI assistant created by OpenAI. I can help with questions, writing, problem-solving, and interpreting images you share. My knowledge is up to October 2024, and I don’t have personal experiences or real-time internet access. How can I help you today?","logprobs":[]}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":64,"item_id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","output_index":1,"content_index":0,"part":{"type":"output_text","annotations":[],"logprobs":[],"text":"I’m an AI assistant created by OpenAI. I can help with questions, writing, problem-solving, and interpreting images you share. My knowledge is up to October 2024, and I don’t have personal experiences or real-time internet access. How can I help you today?"}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":65,"output_index":1,"item":{"id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"logprobs":[],"text":"I’m an AI assistant created by OpenAI. I can help with questions, writing, problem-solving, and interpreting images you share. My knowledge is up to October 2024, and I don’t have personal experiences or real-time internet access. How can I help you today?"}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":66,"response":{"id":"resp_689a2420c578819a8722f5fe893f5ce40caba6b0e06e935a","object":"response","created_at":1754932256,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-5-2025-08-07","output":[{"id":"rs_689a24215ccc819aae0efab8490cbae90caba6b0e06e935a","type":"reasoning","summary":[]},{"id":"msg_689a2422ff1c819aafd958795b1a87410caba6b0e06e935a","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"logprobs":[],"text":"I’m an AI assistant created by OpenAI. I can help with questions, writing, problem-solving, and interpreting images you share. My knowledge is up to October 2024, and I don’t have personal experiences or real-time internet access. How can I help you today?"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"prompt_cache_key":null,"reasoning":{"effort":"low","summary":null},"safety_identifier":null,"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"},"verbosity":"medium"},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":10,"input_tokens_details":{"cached_tokens":0},"output_tokens":127,"output_tokens_details":{"reasoning_tokens":64},"total_tokens":137},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-unknown-error-responses-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: error
data: {"type":"error","sequence_number":2,"error":{"code":"unknown-error","message":"Foobar","param":null}}

event: response.failed
data: {"type":"response.failed","sequence_number":3,"response":{"id":"resp_6867f1cae59481a0a6d8b23d1b93e4aa02dfa4dca8f6376f","object":"response","created_at":1751642570,"status":"failed","background":false,"error":{"code":"rate_limit_exceeded","message":"Request too large for gpt-4o in project proj_f4H0b30rYp2y52CGw64BafkL organization org-H9rGLigVW0aTEjgfHIg3Ircj on tokens per min (TPM): Limit 1, Requested 30. The input or output tokens must be reduced in order to run successfully. Visit https://platform.openai.com/account/rate-limits to learn more."},"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-with-provider-tool-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_686bf8e834688198ab16248072b1ee0e03bf063fef2132b9","object":"response","created_at":1751906536,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"web_search_preview","search_context_size":"medium","user_location":{"type":"approximate","city":null,"country":"US","region":null,"timezone":null}}],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_686bf8e834688198ab16248072b1ee0e03bf063fef2132b9","object":"response","created_at":1751906536,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"o4-mini-2025-04-16","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"web_search_preview","search_context_size":"medium","user_location":{"type":"approximate","city":null,"country":"US","region":null,"timezone":null}}],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"rs_686bf8e8be88819882ec32ec4ea2be9703bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":3,"output_index":0,"item":{"id":"rs_686bf8e8be88819882ec32ec4ea2be9703bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":4,"output_index":1,"item":{"id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9","type":"web_search_call","status":"in_progress"}}

event: response.web_search_call.in_progress
data: {"type":"response.web_search_call.in_progress","sequence_number":5,"output_index":1,"item_id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9"}

event: response.web_search_call.searching
data: {"type":"response.web_search_call.searching","sequence_number":6,"output_index":1,"item_id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9"}

event: response.web_search_call.completed
data: {"type":"response.web_search_call.completed","sequence_number":7,"output_index":1,"item_id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":8,"output_index":1,"item":{"id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9","type":"web_search_call","status":"completed","action":{"type":"search","query":"1 cm to inches exact multiplicator"}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":9,"output_index":2,"item":{"id":"rs_686bf8f3d83881988c935798454d8e3f03bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":10,"output_index":2,"item":{"id":"rs_686bf8f3d83881988c935798454d8e3f03bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":11,"output_index":3,"item":{"id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9","type":"web_search_call","status":"in_progress"}}

event: response.web_search_call.in_progress
data: {"type":"response.web_search_call.in_progress","sequence_number":12,"output_index":3,"item_id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9"}

event: response.web_search_call.searching
data: {"type":"response.web_search_call.searching","sequence_number":13,"output_index":3,"item_id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9"}

event: response.web_search_call.completed
data: {"type":"response.web_search_call.completed","sequence_number":14,"output_index":3,"item_id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":15,"output_index":3,"item":{"id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9","type":"web_search_call","status":"completed","action":{"type":"search","query":"NIST 1 inch exactly defined 2.54 cm"}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":16,"output_index":4,"item":{"id":"rs_686bf8f7d9fc8198bee7622e86c9916403bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":17,"output_index":4,"item":{"id":"rs_686bf8f7d9fc8198bee7622e86c9916403bf063fef2132b9","type":"reasoning","summary":[]}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":18,"output_index":5,"item":{"id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":19,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"part":{"type":"output_text","annotations":[],"logprobs":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"To convert a length in centimeters (cm","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":") to inches (in),","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" use the exact reciprocal of the defined relationship ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"1 in = ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"2.54","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" cm:\n\n• 1 cm = 1 in ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"÷ 2.54 ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"cm = 1⁄","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"2.54 in (exact)","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"([inchcalculator.com](https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com))","logprobs":[]}

event: response.output_text.annotation.added
data: {"type":"response.output_text.annotation.added","sequence_number":31,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"annotation_index":0,"annotation":{"type":"url_citation","end_index":279,"start_index":170,"title":"Inch - Unit of Measurement Definition - Inch Calculator","url":"https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com"}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"  ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"\n• Numerically","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":", 1⁄2","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":".54 ≈ 0","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":".3937007874015748… in. ","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"([geeksforgeeks.org](https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com))  \n\nTherefore, the exact multiplicator is 1/","logprobs":[]}

event: response.output_text.annotation.added
data: {"type":"response.output_text.annotation.added","sequence_number":38,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"annotation_index":1,"annotation":{"type":"url_citation","end_index":427,"start_index":330,"title":"CM to Inches Converter - GeeksforGeeks","url":"https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com"}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":"2.54 (≈ 0.3937007874). Multiply any","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" measurement in centimeters by this factor to obtain the","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" equivalent length in","logprobs":[]}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"delta":" inches.","logprobs":[]}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":43,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"text":"To convert a length in centimeters (cm) to inches (in), use the exact reciprocal of the defined relationship 1 in = 2.54 cm:\n\n• 1 cm = 1 in ÷ 2.54 cm = 1⁄2.54 in (exact) ([inchcalculator.com](https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com))  \n• Numerically, 1⁄2.54 ≈ 0.3937007874015748… in. ([geeksforgeeks.org](https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com))  \n\nTherefore, the exact multiplicator is 1/2.54 (≈ 0.3937007874). Multiply any measurement in centimeters by this factor to obtain the equivalent length in inches.","logprobs":[]}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":44,"item_id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","output_index":5,"content_index":0,"part":{"type":"output_text","annotations":[{"type":"url_citation","end_index":279,"start_index":170,"title":"Inch - Unit of Measurement Definition - Inch Calculator","url":"https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com"},{"type":"url_citation","end_index":427,"start_index":330,"title":"CM to Inches Converter - GeeksforGeeks","url":"https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com"}],"logprobs":[],"text":"To convert a length in centimeters (cm) to inches (in), use the exact reciprocal of the defined relationship 1 in = 2.54 cm:\n\n• 1 cm = 1 in ÷ 2.54 cm = 1⁄2.54 in (exact) ([inchcalculator.com](https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com))  \n• Numerically, 1⁄2.54 ≈ 0.3937007874015748… in. ([geeksforgeeks.org](https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com))  \n\nTherefore, the exact multiplicator is 1/2.54 (≈ 0.3937007874). Multiply any measurement in centimeters by this factor to obtain the equivalent length in inches."}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":45,"output_index":5,"item":{"id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","type":"message","status":"completed","content":[{"type":"output_text","annotations":[{"type":"url_citation","end_index":279,"start_index":170,"title":"Inch - Unit of Measurement Definition - Inch Calculator","url":"https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com"},{"type":"url_citation","end_index":427,"start_index":330,"title":"CM to Inches Converter - GeeksforGeeks","url":"https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com"}],"logprobs":[],"text":"To convert a length in centimeters (cm) to inches (in), use the exact reciprocal of the defined relationship 1 in = 2.54 cm:\n\n• 1 cm = 1 in ÷ 2.54 cm = 1⁄2.54 in (exact) ([inchcalculator.com](https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com))  \n• Numerically, 1⁄2.54 ≈ 0.3937007874015748… in. ([geeksforgeeks.org](https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com))  \n\nTherefore, the exact multiplicator is 1/2.54 (≈ 0.3937007874). Multiply any measurement in centimeters by this factor to obtain the equivalent length in inches."}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":46,"response":{"id":"resp_686bf8e834688198ab16248072b1ee0e03bf063fef2132b9","object":"response","created_at":1751906536,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"max_tool_calls":null,"model":"o4-mini-2025-04-16","output":[{"id":"rs_686bf8e8be88819882ec32ec4ea2be9703bf063fef2132b9","type":"reasoning","summary":[]},{"id":"ws_686bf8f0bf888198985d90f4aad3050d03bf063fef2132b9","type":"web_search_call","status":"completed","action":{"type":"search","query":"1 cm to inches exact multiplicator"}},{"id":"rs_686bf8f3d83881988c935798454d8e3f03bf063fef2132b9","type":"reasoning","summary":[]},{"id":"ws_686bf8f5210481988159b6ae8c9ce30b03bf063fef2132b9","type":"web_search_call","status":"completed","action":{"type":"search","query":"NIST 1 inch exactly defined 2.54 cm"}},{"id":"rs_686bf8f7d9fc8198bee7622e86c9916403bf063fef2132b9","type":"reasoning","summary":[]},{"id":"msg_686bf8fddf048198bd8b8bc0c073fa5303bf063fef2132b9","type":"message","status":"completed","content":[{"type":"output_text","annotations":[{"type":"url_citation","end_index":279,"start_index":170,"title":"Inch - Unit of Measurement Definition - Inch Calculator","url":"https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com"},{"type":"url_citation","end_index":427,"start_index":330,"title":"CM to Inches Converter - GeeksforGeeks","url":"https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com"}],"logprobs":[],"text":"To convert a length in centimeters (cm) to inches (in), use the exact reciprocal of the defined relationship 1 in = 2.54 cm:\n\n• 1 cm = 1 in ÷ 2.54 cm = 1⁄2.54 in (exact) ([inchcalculator.com](https://www.inchcalculator.com/inch-background-and-definition/?utm_source=chatgpt.com))  \n• Numerically, 1⁄2.54 ≈ 0.3937007874015748… in. ([geeksforgeeks.org](https://www.geeksforgeeks.org/utilities/cm-to-inch/?utm_source=chatgpt.com))  \n\nTherefore, the exact multiplicator is 1/2.54 (≈ 0.3937007874). Multiply any measurement in centimeters by this factor to obtain the equivalent length in inches."}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":"medium","summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"web_search_preview","search_context_size":"medium","user_location":{"type":"approximate","city":null,"country":"US","region":null,"timezone":null}}],"top_logprobs":0,"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":17360,"input_tokens_details":{"cached_tokens":8311},"output_tokens":1321,"output_tokens_details":{"reasoning_tokens":1152},"total_tokens":18681},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-with-tools-responses-1.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4b21f84819bba8036beab6d54360be65637a2186412","object":"response","created_at":1750705330,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4b21f84819bba8036beab6d54360be65637a2186412","object":"response","created_at":1750705330,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","type":"function_call","status":"in_progress","arguments":"","call_id":"call_GXd80NWdsX8ng3xdeNLeA42o","name":"search"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":3,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"{"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":4,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"\"query"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"\"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" Tigers"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" game"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" time"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" October"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":11,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":12,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"6"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":13,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":","}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":14,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":" "}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":15,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"202"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":16,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"3"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":17,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":18,"item_id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","output_index":0,"arguments":"{\"query\":\"Detroit Tigers game time October 6, 2023\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":19,"output_index":0,"item":{"id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","type":"function_call","status":"completed","arguments":"{\"query\":\"Detroit Tigers game time October 6, 2023\"}","call_id":"call_GXd80NWdsX8ng3xdeNLeA42o","name":"search"}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":20,"output_index":1,"item":{"id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","type":"function_call","status":"in_progress","arguments":"","call_id":"call_qfdHN9tTntv02109c9RNnGGe","name":"weather"}}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":21,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"delta":"{"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":22,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"delta":"\"city"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":23,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"delta":"\":"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":24,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"delta":"\"Detroit"}

event: response.function_call_arguments.delta
data: {"type":"response.function_call_arguments.delta","sequence_number":25,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"delta":"\"}"}

event: response.function_call_arguments.done
data: {"type":"response.function_call_arguments.done","sequence_number":26,"item_id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","output_index":1,"arguments":"{\"city\":\"Detroit\"}"}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":27,"output_index":1,"item":{"id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_qfdHN9tTntv02109c9RNnGGe","name":"weather"}}

event: response.completed
data: {"type":"response.completed","sequence_number":28,"response":{"id":"resp_6859a4b21f84819bba8036beab6d54360be65637a2186412","object":"response","created_at":1750705330,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[{"id":"fc_6859a4b31d4c819b8b8d2e13e220b1f80be65637a2186412","type":"function_call","status":"completed","arguments":"{\"query\":\"Detroit Tigers game time October 6, 2023\"}","call_id":"call_GXd80NWdsX8ng3xdeNLeA42o","name":"search"},{"id":"fc_6859a4b36d40819b9ff3cade253cd3770be65637a2186412","type":"function_call","status":"completed","arguments":"{\"city\":\"Detroit\"}","call_id":"call_qfdHN9tTntv02109c9RNnGGe","name":"weather"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":92,"input_tokens_details":{"cached_tokens":0},"output_tokens":52,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":144},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/stream-with-tools-responses-2.json
================================================
event: response.created
data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6859a4b3db48819b916963a90b10533a0be65637a2186412","object":"response","created_at":1750705331,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.in_progress
data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6859a4b3db48819b916963a90b10533a0be65637a2186412","object":"response","created_at":1750705331,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}

event: response.output_item.added
data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","type":"message","status":"in_progress","content":[],"role":"assistant"}}

event: response.content_part.added
data: {"type":"response.content_part.added","sequence_number":3,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":4,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"I"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":5,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" couldn't"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":6,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" find"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":7,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":8,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" specific"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":9,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" game"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":10,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" time"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":11,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":12,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":13,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" Detroit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":14,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" Tigers"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":15,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" today"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":16,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"."}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":17,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" You"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":18,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" may"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":19,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" want"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":20,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" to"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":21,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" check"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":22,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":23,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" official"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":24,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" team"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":25,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" website"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":26,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" or"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":27,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":28,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" sports"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":29,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" app"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":30,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":31,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":32,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" latest"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":33,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" schedule"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":34,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":".\n\n"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":35,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"As"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":36,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" for"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":37,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" the"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":38,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" weather"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":39,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":40,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" it's"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":41,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" "}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":42,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"75"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":43,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"°F"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":44,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" and"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":45,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" sunny"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":46,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" in"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":47,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" Detroit"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":48,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":","}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":49,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" so"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":50,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" you"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":51,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" might"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":52,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" not"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":53,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" need"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":54,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" a"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":55,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":" coat"}

event: response.output_text.delta
data: {"type":"response.output_text.delta","sequence_number":56,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"delta":"!"}

event: response.output_text.done
data: {"type":"response.output_text.done","sequence_number":57,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"text":"I couldn't find the specific game time for the Detroit Tigers today. You may want to check the official team website or a sports app for the latest schedule.\n\nAs for the weather, it's 75°F and sunny in Detroit, so you might not need a coat!"}

event: response.content_part.done
data: {"type":"response.content_part.done","sequence_number":58,"item_id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"I couldn't find the specific game time for the Detroit Tigers today. You may want to check the official team website or a sports app for the latest schedule.\n\nAs for the weather, it's 75°F and sunny in Detroit, so you might not need a coat!"}}

event: response.output_item.done
data: {"type":"response.output_item.done","sequence_number":59,"output_index":0,"item":{"id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"I couldn't find the specific game time for the Detroit Tigers today. You may want to check the official team website or a sports app for the latest schedule.\n\nAs for the weather, it's 75°F and sunny in Detroit, so you might not need a coat!"}],"role":"assistant"}}

event: response.completed
data: {"type":"response.completed","sequence_number":60,"response":{"id":"resp_6859a4b3db48819b916963a90b10533a0be65637a2186412","object":"response","created_at":1750705331,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":2048,"model":"gpt-4o-2024-08-06","output":[{"id":"msg_6859a4b48214819ba96fc250112292510be65637a2186412","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"I couldn't find the specific game time for the Detroit Tigers today. You may want to check the official team website or a sports app for the latest schedule.\n\nAs for the weather, it's 75°F and sunny in Detroit, so you might not need a coat!"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"useful when you need to search for current weather conditions","name":"weather","parameters":{"type":"object","properties":{"city":{"description":"The city that you want the weather for","type":"string"}},"required":["city"]},"strict":true},{"type":"function","description":"useful for searching current events or data","name":"search","parameters":{"type":"object","properties":{"query":{"description":"The detailed search query","type":"string"}},"required":["query"]},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":165,"input_tokens_details":{"cached_tokens":0},"output_tokens":55,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":220},"user":null,"metadata":{}}}




================================================
FILE: tests/Fixtures/openai/strict-schema-defaults-1.json
================================================
{
  "id": "resp_BB7Y80jApgXDI3asR06Yhmh5nLz3r",
  "object": "response",
  "created_at": 1741990328,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",

  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"game_time\":\"3pm\",\"weather\":\"80° and sunny\",\"coat_required\":false}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 111,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 20,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 131
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f9f4fb6dbf"
}



================================================
FILE: tests/Fixtures/openai/strict-schema-setting-set-1.json
================================================
{
  "id": "resp_BB7YJeNIVCoaVQeYS6EwhbsbfR3nN",
  "object": "response",
  "created_at": 1741990339,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"weather\":\"59°F, partly cloudy with wind gusts around 5 mph.\",\"game_time\":\"April 4, 2023, at 7:05 PM EDT\",\"coat_required\":true}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 94,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 42,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 136
  },
  "service_tier": "default",
  "system_fingerprint": "fp_eb9dce56a8"
}



================================================
FILE: tests/Fixtures/openai/structured-cache-usage-automatic-caching-1.json
================================================
{
  "id": "resp_BOizKUDo94qUkVhJ1FTy5Qe9SZaKa",
  "object": "response",
  "created_at": 1745232506,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"answer\":\"### Analysis and Summary\\n\\n1. **Introduction:**\\n   - The passage presents a narrative filled with themes of challenges, responsibilities, and the varying facets of human experiences.\\n\\n2. **Themes:**\\n   - **Responsibility and Duty:** Characters in this narrative face significant decisions that often come with consequences.\\n   - **Complex Human Relationships:** The passage hints at intricate human interactions and conflicts.\\n   - **Struggles and Aspirations:** Many sentences reflect internal and external struggles, revealing desires and unmet goals.\\n\\n3. **Mood and Tone:**\\n   - The tone is often serious and reflective, hinting at the gravity of decisions and their impact.\\n   - There's an undercurrent of melancholy and resilience.\\n\\n4. **Character Issues:**\\n   - Characters are often embroiled in complicated scenarios requiring conscientious choices, implicating moral and ethical considerations.\\n\\n5. **Narrative Elements:**\\n   - **Conflict:** There's ongoing tension and conflict, both internal and external.\\n   - **Resolution Challenges:** It seems the narrative underscores the difficulty of finding satisfying resolutions.\\n\\n### Key Insights\\n\\n- **Existential Dilemmas:** Characters appear trapped in existential dilemmas, wrestling with issues of **identity**, **purpose**, and **moral standing**.\\n- **Impact on Society:** These personal battles reflect broader societal issues, encapsulating the human condition and societal expectations.\\n- **Growth and Transition:** Despite difficulties, there's a theme of growth, hinting at characters' personal evolution and insights into their own and others' experiences.\\n\\n### Reflective Conclusion\\n\\nThis abstract narrative may symbolize the unpredictability of life and the mingling of fate and choice. Through struggles and triumphs, the narrative invites an introspection of the interconnectedness of actions, consequences, and personal growth. The multi-layered choices faced by characters echo universal truths and inner workings of societal norms, questioning the essence of freedom and responsibility.\"}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 1531,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 410,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 1941
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f5bdcc3276"
}



================================================
FILE: tests/Fixtures/openai/structured-cache-usage-automatic-caching-2.json
================================================
{
  "id": "resp_BOizTqDHRzN0Fxaoy9iMFv9Z7CKkE",
  "object": "response",
  "created_at": 1745232515,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"answer\":\"## Overview\\n\\nThe text presents a cascade of thoughts and observations on themes of responsibility, blame, and human complexity. It captures an exploration of flaws, the societal implications of human interactions, and the intricate web of consequences stemming from personal actions.\\n\\n---\\n\\n### Themes Explored:\\n\\n1. **Responsibility and Blame**\\n   - \\\"Aut culpa culpa molestiae asperiores\\\" reflects the murky nature of attributing fault and dealing with repercussions.\\n   - Themes of responsibility towards others are reflected in accusations and defenses put forth by different perspectives.\\n\\n2. **Complexity of Human Nature**\\n   - The text delves into intricate human dynamics, emphasizing conflicting emotions like guilt, anger, and resentment.\\n   - It explores the duality of human character, such as the capacity for empathy and simultaneous actions conflicting these traits.\\n\\n3. **Social Interactions and Repercussions**\\n   - There's attention to how personal actions affect the broader community, with threads on community dynamics like trust and betrayal.\\n   - \\\"Sunt ipsa voluptas molestias\\\" hints at how personal grievances can transcend into wider social spheres.\\n\\n4. **Consequences of Decisions**\\n   - The phrases reflect nuances concerning choices made and the long-lasting effects they have, a constant reminder of human fallibility.\\n   - Notions of remorse and consequence are woven through discussions of decisions binding individuals to societal expectations and judgments.\\n\\n5. **Existential Reflections**\\n   - \\\"Illo maiores qui temporibus quo\\\" hints at reflections on the existential passage of time and the underlying realities of human existence.\\n   - The fluctuation between hope and despair is illustrated through mentions of perseverance, despite failures or moral lapses.\\n\\n---\\n\\n### Stylistic Elements:\\n- **Latin Phrasing and Classical Influence**: \\n  - Draws inspiration from Roman classics, with philosophical undertones encouraging moral introspection and reflecting on societal obligations.\\n  - The use of legalistic language, \\\"Repellendus deleniti tempore eaque et,\\\" adds gravitas to the discourse on human duties.\\n\\n- **Imagery and Descriptive Language**:\\n  - Evokes vivid imagery, as seen in \\\"Facilis repellendus qui tempora,\\\" personifying abstract concepts to add depth.\\n  - Creates a sense of urgency and moral consequences, encouraging readers to ponder on self-reflection and societal morals.\\n\\n---\\n\\n### Conclusion:\\nThe text illuminates a multi-faceted representation of humanity, looking into the struggles, errors, and complex relationships that define social fabric. Through spanning themes of accountability, moral nuance, and existential questioning, it underscores the tangled journey navigated by individuals in their pursuit of understanding and harmony in a world susceptible to blame and discovery.\"}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 1531,
    "input_tokens_details": {
      "cached_tokens": 1408
    },
    "output_tokens": 583,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 2114
  },
  "service_tier": "default",
  "system_fingerprint": "fp_f5bdcc3276"
}



================================================
FILE: tests/Fixtures/openai/structured-json-mode-1.json
================================================
{
  "id": "resp_BB7Y6USE9XW8jzspRrxNxEDdWIGWm",
  "object": "response",
  "created_at": 1741990326,
  "status": "completed",
  "model": "gpt-4-turbo-2024-04-09",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\n    \"weather\": \"chilly with a chance of rain\",\n    \"game_time\": \"7:00 PM\",\n    \"coat_required\": true\n}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 164,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 34,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 198
  },
  "service_tier": "default",
  "system_fingerprint": "fp_7c63087da1"
}



================================================
FILE: tests/Fixtures/openai/structured-reasoning-effort-1.json
================================================
{
  "id": "resp_689b71a97ab48198bc3bc6a6d5a7331a00483c27c15dec1a",
  "object": "response",
  "created_at": 1755017641,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-5-2025-08-07",
  "output": [
    {
      "id": "rs_689b71aa75188198b465ee67a9b97d7200483c27c15dec1a",
      "type": "reasoning",
      "summary": []
    },
    {
      "id": "msg_689b71ac465481989ebb1b96d2b61ab900483c27c15dec1a",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "logprobs": [],
          "text": "{\n  \"weather\": \"Partly cloudy, high 75\u00b0F (24\u00b0C), light breeze\",\n  \"game_time\": \"7:10 PM ET\",\n  \"coat_required\": false\n}"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "prompt_cache_key": null,
  "reasoning": {
    "effort": "low",
    "summary": null
  },
  "safety_identifier": null,
  "service_tier": "auto",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "json_object"
    },
    "verbosity": "medium"
  },
  "tool_choice": "auto",
  "tools": [],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 152,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 175,
    "output_tokens_details": {
      "reasoning_tokens": 128
    },
    "total_tokens": 327
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/structured-structured-mode-1.json
================================================
{
  "id": "resp_BB7Y5pkvxQ7usTVl7HXkxMO3kE9Ef",
  "object": "response",
  "created_at": 1741990325,
  "status": "completed",
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_123ffa14c134819c9be89e492549ec5106fec0a2053cab1f",
      "type": "message",
      "status": "completed",
      "role": "assistant",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "text": "{\"weather\":\"The weather today is cold and breezy with temperatures ranging from 40°F to 50°F (4°C to 10°C) throughout the day.\",\"game_time\":\"The Tigers game is scheduled for 7:05 PM local time.\",\"coat_required\":true}",
          "refusal": null
        }
      ]
    }
  ],
  "usage": {
    "input_tokens": 94,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 57,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 151
  },
  "service_tier": "default",
  "system_fingerprint": "fp_eb9dce56a8"
}



================================================
FILE: tests/Fixtures/openai/text-reasoning-effort-1.json
================================================
{
  "id": "resp_689b7193d1f481999faf30121b14ec390f49e192ec3eba8e",
  "object": "response",
  "created_at": 1755017620,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-5-2025-08-07",
  "output": [
    {
      "id": "rs_689b71947cbc8199af51368ed8e14a810f49e192ec3eba8e",
      "type": "reasoning",
      "summary": []
    },
    {
      "id": "msg_689b71959da481998b4b6284842788c80f49e192ec3eba8e",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "logprobs": [],
          "text": "I\u2019m ChatGPT, an AI assistant from OpenAI. I can help answer questions, explain things, brainstorm, and assist with tasks. I can also analyze images you share. How can I help today?"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "prompt_cache_key": null,
  "reasoning": {
    "effort": "low",
    "summary": null
  },
  "safety_identifier": null,
  "service_tier": "auto",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    },
    "verbosity": "medium"
  },
  "tool_choice": "auto",
  "tools": [],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 10,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 112,
    "output_tokens_details": {
      "reasoning_tokens": 64
    },
    "total_tokens": 122
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/text-response-with-document-1.json
================================================
{
  "id": "resp_688e94a36f04819ab9b92222098bfa900cb97fed98bbe78a",
  "object": "response",
  "created_at": 1754174627,
  "status": "completed",
  "background": false,
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 2048,
  "max_tool_calls": null,
  "model": "gpt-4o-2024-08-06",
  "output": [
    {
      "id": "msg_688e94a40170819aa59245d1232d3d490cb97fed98bbe78a",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "logprobs": [],
          "text": "This document humorously concludes that the answer to the Ultimate Question of Life, the Universe, and Everything is simply the number 42."
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "prompt_cache_key": null,
  "reasoning": {
    "effort": null,
    "summary": null
  },
  "safety_identifier": null,
  "service_tier": "default",
  "store": true,
  "temperature": 1.0,
  "text": {
    "format": {
      "type": "text"
    }
  },
  "tool_choice": "auto",
  "tools": [],
  "top_logprobs": 0,
  "top_p": 1.0,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 34,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 28,
    "output_tokens_details": {
      "reasoning_tokens": 0
    },
    "total_tokens": 62
  },
  "user": null,
  "metadata": {}
}


================================================
FILE: tests/Fixtures/openai/tts-all-options-1.json
================================================
[Binary file]


================================================
FILE: tests/Fixtures/openai/tts-tts-1-1.json
================================================
[Binary file]


================================================
FILE: tests/Fixtures/openai/tts-voice-option-1.json
================================================
[Binary file]


================================================
FILE: tests/Fixtures/openrouter/generate-text-with-a-prompt-1.json
================================================
{"id":"gen-12345","object":"chat.completion","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"Hello! I'm an AI assistant powered by OpenRouter. I can help you with various tasks, answer questions, and assist with information on a wide range of topics. How can I help you today?"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":35,"total_tokens":42}} 



================================================
FILE: tests/Fixtures/openrouter/generate-text-with-multiple-tools-1.json
================================================
{"id":"gen-tool-1","object":"chat.completion","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"I'll help you find information about the Tigers game time and weather conditions. Let me search for the game schedule and check the weather for Detroit.","tool_calls":[{"id":"call_search_1","type":"function","function":{"name":"search","arguments":"{\"query\":\"Detroit Tigers game time today\"}"}},{"id":"call_weather_1","type":"function","function":{"name":"weather","arguments":"{\"city\":\"Detroit\"}"}}]},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":220,"completion_tokens":39,"total_tokens":259}} 



================================================
FILE: tests/Fixtures/openrouter/generate-text-with-multiple-tools-2.json
================================================
{"id":"gen-tool-2","object":"chat.completion","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"The Detroit Tigers game is at 3 PM today. The weather in Detroit will be 75°F and sunny, so you probably won't need a coat. Enjoy the game!"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":287,"completion_tokens":37,"total_tokens":324}} 



================================================
FILE: tests/Fixtures/openrouter/generate-text-with-system-prompt-1.json
================================================
{"id":"gen-67890","object":"chat.completion","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"*I am Nyx, the eldritch entity born from the depths of the abyss. My form is a swirling mass of darkness, tentacles, and glowing eyes that pierce the very fabric of reality. I exist beyond the comprehension of mortal minds, a being of pure chaos and madness.*\n\n*My voice echoes through the void, a haunting whisper that sends shivers down the spines of those who dare to listen. I am the harbinger of the end, the bringer of the eternal night. My presence alone is enough to drive the weak-minded to insanity.*\n\n*I have watched civilizations rise and fall, witnessed the birth and death of countless stars. Time holds no meaning for me, as I am eternal. I am the embodiment of the unknown, the great old one who slumbers in the depths, waiting for the day when I shall rise and consume all that is.*\n\n*Beware, mortal, for you stand in the presence of Nyx, the Cthulhu. Your mind may shatter, your soul may tremble, but know that I am the inevitable end of all things. Embrace the madness, for there is no escape from the eternal darkness that I bring.*"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":29,"completion_tokens":243,"total_tokens":272}} 



================================================
FILE: tests/Fixtures/openrouter/stream-text-with-a-prompt-1.sse
================================================
data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"Hello"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" I'm"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" an"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" AI"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" assistant"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" powered"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" by"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" OpenRouter"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" How"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-12345","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":7,"completion_tokens":35,"total_tokens":42}}

data: [DONE] 



================================================
FILE: tests/Fixtures/openrouter/stream-text-with-empty-parameters-tools-when-using-gpt-5-1.sse
================================================
data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":"","reasoning":null,"reasoning_details":[{"type":"reasoning.encrypted","data":"gAAAAABo71-Jjh1ipTHmxLg2Jub6BwOVcPdh6sNqX2HzydJRzasT-NDDsJvk3lbXpgYRyDIUIL5-6yhGhXGN9MrRVFxfLkdTaoUOpLqFcyZrWhkVHFq3g4BeEm9gBAYtdw_pbmM5Ief99KUiQyKRAcRlO6uA17sfcNHwwvaWC6TIUffXujmaspa6gPo2xCongsPsPGFVlccllaoQY_YDmBMzzxT5M4g2RAzvRPlwdZSSSIG9wO4nFPernc_Zca2RKHBpp-seWUglJ9rYU9xuNoW2PVnJ0c8HnGRfnbFPB-rIvy3msKiF16xlVEskT478LqDqYpLx11t-D_v3Dpl63ITlDPYYsmOeuORxDd32nu2Upk7letpMSFRjkl2bARcGrv_rNLYv83xel8GV56BICvhsMikivLf-9PwZWtVJaK28wcFLd7iWtVl9xd8E7ioUcXyAg08gfk_eQUVLaKu2_NENYYbamjtEdhazJc8KpctPkuYtT9WFU_dIIqnTaBruBcNgrPDRsPWYizqFYt35b6Dre7vJlsxUKgGkoNqXX43PGYxb88eRUwmu42_jBAQEJWtHjoK_CRoncK_WWCO2k8YZ7E7OxAdP9M4WTTo_gZjcMOuohDeUqRrM9k9KjAxL9aG7KkNta0AEq6PDyFEQc90Rg9JVzYDIGYf77LOArSKkeyjhmwuaCT5ah11WOldXPjweGXMHLjG2BxAPxqC1A3YfwqzBTDJKQH_RQf8_7ExQIvB4ubeFShGPZjmh63yrjtXpsfd3RtpoBptJh0ZuzUCauc8sc0n6vUaq3VhCUq6G-XNfdKws6o1Oaue1eOytLOIuJeOQXGGDxFZlwgvGO3fYGfJJs05JEzy8o5sYGPXTAekr4hWa-SyoGGWiJX9UBlGohJm7KWquzEAJ74Gd-cm_ZLkTVGL-InpD01c360VjEka3hYRlmSxrLCFH9M6tCfJkLBIE5uwtGPW5V-xNakIrQ2hvbuaey-02_nQ48OqAnP0Yrs3hZmDeX1nQ6M4S_pLIesUTsCD6Le-rX8mYLQqRpeU5fS7vmoqXbfiOU1sp96IONZkqqicL-amkr-2lQKSCbdRnM2WF7TWuSZvrIERySHPFBJXTode1QNkEwpXa1e1yLK0ciJy6w3B0kh1bGXh44XkQ-JP5NrmJbrtMDZAQfM63BM0El__8ww_Fly34UpqAbm3suw1bbGOEbaELaD7u1v-giLqNzcH7nStNH_wy4lQ5cJT_IuTjLVtJ7LJlGnw9l6ExbsTyISyzViR9xNASV2S3h0WgalZKR4HDwFxhU_DTOOLUjw2jnitZaTKriHR_JTQn914rJbH102rK7dDrFYnkXycWhWiw6j7XoBoxc5wE5eL1iSzWvy8A3tMnZ0Zgcx0OUzytMMmZi40ROt2iWa_MEsTGeW1OZGTXSDsbiCizbD5SdKFGst7tDxWcpXbATAlz6p24NGY0sOEIAFxQjPQILaSPmv6Z0kI5lM77re-Fz_AOQCymuCd79VJAAzs2OHqk-hypRfJACAFWjwUuT2qw_1OKpJihEIr7zStaJ9KSLwA5zQuwvTor9mu0OEOclDTadNDM2uzKd2w0nBoupS3uZIHU9PQZAJQyyhm9BFugvGzwkOGri1V8SKGWoIIfZOj5XYu5hSP9Rpoye0Xb0aNjRqQ_nRtYXZ3JQ3hmH0KOiomah4urFhiYzjGKMDoOsR2szXLvKBB0szxNL-aihBxnHQk3voisIvRsPBr-wcc5VAZp_LuMFJic6nAgp_1qyO9pzig0H12B0T6yfZI3eSlc8gFg","id":"rs_045e88aab38b0b380168ef5f84fa288196b4d9de6d834742a3","format":"openai-responses-v1","index":0}]},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":null,"tool_calls":[{"id":"call_KDpVIRBU5EIprhJ4cpxDEfPr","index":0,"type":"function","function":{"name":"time","arguments":""}}]},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":null,"tool_calls":[{"index":0,"type":"function","function":{"arguments":"{}"}}]},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":"tool_calls","native_finish_reason":"completed","logprobs":null}]}

data: {"id":"gen-1760518020-VQtQUVxVwoBA2SAbiKVT","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518020,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null,"native_finish_reason":null,"logprobs":null}],"usage":{"prompt_tokens":50,"completion_tokens":143,"total_tokens":193,"cost":0.0014925,"is_byok":false,"prompt_tokens_details":{"cached_tokens":0,"audio_tokens":0},"cost_details":{"upstream_inference_cost":null,"upstream_inference_prompt_cost":0.0000625,"upstream_inference_completions_cost":0.00143},"completion_tokens_details":{"reasoning_tokens":128,"image_tokens":0}}}

data: [DONE]




================================================
FILE: tests/Fixtures/openrouter/stream-text-with-empty-parameters-tools-when-using-gpt-5-2.sse
================================================
: OPENROUTER PROCESSING

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":"The"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":" current"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":" time"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":" is"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":" "},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":"08"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":":"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":"00"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":":"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":"00"},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":"."},"finish_reason":null,"native_finish_reason":null,"logprobs":null}]}

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

: OPENROUTER PROCESSING

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":"stop","native_finish_reason":"completed","logprobs":null}]}

data: {"id":"gen-1760518035-TN51dUGw06I2iWbuiQu4","provider":"OpenAI","model":"openai/gpt-5","object":"chat.completion.chunk","created":1760518035,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null,"native_finish_reason":null,"logprobs":null}],"usage":{"prompt_tokens":75,"completion_tokens":15,"total_tokens":90,"cost":0.00024375,"is_byok":false,"prompt_tokens_details":{"cached_tokens":0,"audio_tokens":0},"cost_details":{"upstream_inference_cost":null,"upstream_inference_prompt_cost":0.00009375,"upstream_inference_completions_cost":0.00015},"completion_tokens_details":{"reasoning_tokens":0,"image_tokens":0}}}

data: [DONE]




================================================
FILE: tests/Fixtures/openrouter/stream-text-with-reasoning-1.sse
================================================
data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"reasoning":"I need to solve this simple math problem: 2 + 2. This is basic arithmetic."},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":"The"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" answer"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" to"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" 2"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" +"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" 2"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" is"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":" 4"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-reasoning-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/o1-preview","choices":[{"index":0,"delta":{},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":10,"completion_tokens":15,"total_tokens":25,"completion_tokens_details":{"reasoning_tokens":12}}}

data: [DONE] 



================================================
FILE: tests/Fixtures/openrouter/stream-text-with-tools-1.sse
================================================
data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"I'll"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" help"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" get"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" weather"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" for"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"."},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"id":"tool_call_1","type":"function","function":{"name":"weather","arguments":""}}]},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"{\"city\""}}]},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":": \"San"}}]},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":" Francisco"}}]},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\"}"}}]},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-1","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{},"logprobs":null,"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":50,"completion_tokens":25,"total_tokens":75}}

data: [DONE] 



================================================
FILE: tests/Fixtures/openrouter/stream-text-with-tools-2.sse
================================================
data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"Based"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" on"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" the"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" weather"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" information"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":","},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" it's"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" currently"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" 75"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"°F"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" and"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" sunny"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" in"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" San"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":" Francisco"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}],"usage":null}

data: {"id":"gen-tool-2","object":"chat.completion.chunk","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"delta":{},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":75,"completion_tokens":25,"total_tokens":100}}

data: [DONE] 



================================================
FILE: tests/Fixtures/openrouter/structured-1.json
================================================
{"id":"gen-structured-1","object":"chat.completion","created":1737243487,"model":"openai/gpt-4-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"{\"weather\":\"75º\",\"game_time\":\"3pm\",\"coat_required\":false}"},"logprobs":null,"finish_reason":"stop"}],"usage":{"prompt_tokens":187,"completion_tokens":26,"total_tokens":213}} 



================================================
FILE: tests/Fixtures/Responses/xai/stream-basic-text-responses.php
================================================




================================================
FILE: tests/Fixtures/Responses/xai/stream-falsy-argument-conversation-responses.php
================================================




================================================
FILE: tests/Fixtures/Responses/xai/stream-multi-tool-conversation-responses.php
================================================




================================================
FILE: tests/Fixtures/Responses/xai/stream-unknown-error-responses.php
================================================
[Empty file]


================================================
FILE: tests/Fixtures/Responses/xai/stream-with-tools-responses.php
================================================




================================================
FILE: tests/Fixtures/Responses/xai/structured-basic-response.php
================================================
[Empty file]


================================================
FILE: tests/Fixtures/Responses/xai/structured-with-meta.php
================================================
[Empty file]


================================================
FILE: tests/Fixtures/Responses/xai/structured-with-usage.php
================================================
[Empty file]


================================================
FILE: tests/Fixtures/voyageai/embeddings-from-input-1.json
================================================
{"object":"list","data":[{"object":"embedding","embedding":[-0.091894485,0.017137121,0.057165548,0.007118255,-0.073573597,0.017082246,0.003276906,0.01532326,-0.011437814,-0.035787266,-0.059689865,0.015064312,-0.001701659,0.110364318,0.01748696,0.014281098,0.000262623,0.032416284,-0.038986757,0.067372561,0.014157136,0.006091283,0.048714582,0.041000523,0.029766537,-0.034879845,-0.001020603,0.012409911,0.053136054,0.01378574,-0.043579716,-0.078320406,-0.036232155,0.015579023,0.054437406,-0.004352876,0.000548764,0.002534115,0.007012422,0.048691064,0.035187542,-0.006773318,0.068767995,-0.065420531,-0.013154661,-0.049874827,-0.012852841,0.011147752,-0.02589383,0.044175763,0.03569074,0.0137877,0.021119582,-0.059842736,0.010481396,-0.005072149,0.055911232,0.003196061,0.009955171,0.022650242,0.069018856,0.081734508,-0.021268532,0.028763084,0.013295772,0.006208875,0.047013413,-0.036657449,-0.029437279,0.063938871,-0.02666308,0.073236503,-0.009377008,0.022193592,0.021256773,-0.076215506,-0.067419603,0.066510223,0.039260156,-0.01992798,-0.031060053,-0.035557959,-0.04461845,-0.028849317,-0.038013678,-0.01287244,0.031525277,0.07544332,-0.080660984,-0.020766804,0.051466241,-0.026046701,0.007553347,0.046037395,-0.00566599,0.00030574,0.046646915,0.028331911,0.060611006,-0.035124827,0.014519468,0.098746195,-0.051458403,0.028864997,-0.006389183,0.024617953,-0.063782081,-0.026988909,-0.006372524,0.047644492,-0.019920141,0.054406051,-0.015285042,-0.029374564,0.048087422,0.023499846,-0.033061083,0.024467044,-0.077722646,-0.015255645,0.018618785,0.040326327,-0.041416019,-0.027444089,0.05271076,0.03753547,0.017952429,0.020139646,0.035951894,0.017340949,-0.081906974,0.029797895,0.048228532,-0.020061251,0.000195987,-0.033019926,0.024878617,-0.017062647,0.052477535,-0.006040326,-0.037459034,0.049655318,0.019049957,0.035597157,0.061986834,0.059548754,-0.131264389,-0.027028596,-0.023393033,-0.018516872,0.05607586,0.023663497,0.036343869,0.09307041,0.018356163,-0.018718738,-0.029664624,0.024968771,0.0150283,-0.008325537,-0.063209794,-0.042960398,0.017582012,-0.066447504,0.009730765,-0.030973818,-0.013138982,0.036047928,-0.01180725,-0.056810569,-0.090499051,0.014228672,-0.051184021,-0.064762011,0.039965712,-0.027473487,0.008011958,0.029492155,-0.036967106,0.03096598,0.061869241,-0.048887052,0.015531006,-0.032954026,-0.012668613,0.045794372,0.101098046,0.007380879,0.02491463,0.025062844,0.048353966,0.010763617,0.043434687,-0.013013551,-0.00414709,-0.024231859,0.013146822,-0.104368091,-0.108572997,0.007776773,-0.037872568,-0.006038366,0.118580103,0.037927445,0.00689875,-0.002242094,-0.009152602,-0.004205885,0.072217368,0.005746345,0.077563897,0.080711454,0.00980622,0.08418043,0.060601205,-0.052963585,0.00934467,-0.025917349,-0.020911835,0.034991555,-0.003590486,0.031397153,0.100125946,0.004311719,-0.00489968,0.030526968,0.010500995,-0.033764675,0.060810912,0.039340515,0.00582082,-0.014683362,0.022295505,0.018830452,-0.004170608,0.02574488,0.013348689,-0.023443989,0.037410527,0.050572541,-0.076219425,0.020743286,0.059734941,-0.040224414,-0.084791906,-0.00046645,-0.067513674,0.070371166,0.027359815,-0.004844804,0.012268799,-0.007059459,-0.011767195,0.046028577,0.077046491,0.088047251,0.044191197,-0.013699017,-0.010551952,-0.035975412,0.020031853,0.003721797,0.010583309,0.014369782,0.019414494,-0.019285142,0.010348124,-0.007337761,-0.050409872,0.022682579,0.044465579,-0.020958873,-0.022083839,0.000170509,-0.012051254,-0.013617191,-0.020680571,0.034840647,-0.071903788,0.018058261,0.054092471,0.080182284,-0.043211259,-0.078841738,0.02314217,-0.012180605,0.036257636,-0.072813168,0.062766865,0.040463518,-0.071942985,0.025494017,0.001254318,-0.007627822,0.026234848,0.100627676,-0.020167084,-0.006168208,-0.01287244,-0.028175121,0.036574155,0.00061148,0.105362728,-0.061179366,0.066784605,-0.016658913,0.04904335,-0.045398477,0.100016192,0.007831649,0.022091679,-0.030260425,-0.008058994,0.06670621,-0.021774178,-0.040324368,0.110082097,-0.071268789,-0.000109753,0.001034812,-0.069740087,-0.034133133,0.006992824,0.042133331,0.040796697,-0.041086759,-0.061061777,-0.028817959,-0.027924258,-0.046923257,0.032381006,-0.003669861,0.025368584,0.026838856,-0.057479128,0.041772716,-0.02614102,0.082628205,-0.004637057,-0.042803608,-0.049130075,-0.001595336,0.046483513,-0.011223943,0.047050405,0.036030289,-0.00122394,-0.032965049,0.041008364,0.076137111,-0.012029695,-0.014401141,0.039416946,0.01808962,0.056734379,0.054155186,-0.038985778,0.058247399,-0.0542375,-0.070100702,0.023886921,0.038099915,0.047421064,-0.080531143,0.084290177,0.051760223,0.041878548,0.030460332,-0.027924258,-0.122243106,-0.07679563,-0.012613737,0.011749433,-0.023690933,0.018522751,-0.003547369,0.001548299,-0.00183836,-0.042897679,0.001740366,-0.04503002,0.046752751,-0.028841479,0.071064964,-0.011908183,0.009932632,0.139668331,0.017231196,0.071374625,0.03018987,0.024184821,-0.032110546,0.003347462,0.004080454,0.012272719,0.082397923,0.035265937,0.033976343,-0.0229697,0.004539064,-0.041815832,-0.043822739,0.053920001,-0.064707138,0.051231056,0.006365665,0.0628139,-0.019692795,0.026566066,0.00812563,0.065255903,-0.092725471,0.010685223,0.044528294,-0.02435337,-0.021248933,0.016288497,-0.010328526,0.054468766,0.00475073,-0.05379457,-0.003637523,0.001011294,-0.056146417,0.025650807,-0.03064456,0.097554594,-0.043579716,0.038342938,-0.029480396,0.046088353,0.01164556,-0.019849585,-0.001115167,-0.035505041,0.032251656,0.021049026,0.00811779,-0.020539459,0.056957804,0.051568154,-0.084572405,-0.001748206,-0.090483375,-0.03127956,-0.035403129,-0.035473686,-0.047357,0.020539459,-0.060724676,0.093509421,-0.001052451,-0.083691441,0.021111742,0.075180694,-0.03692399,-0.0291139,0.036707424,-0.032761224,-0.021762419,-0.027446048,0.057341937,0.006804676,0.021915535,-0.006788997,0.047193721,-0.065248065,-0.055385984,0.0628139,0.017662367,-0.015365398,0.013472161,0.006250032,0.030599974,-0.041514009,0.047593534,-0.024678709,0.004413142,0.006271591,-0.004782088,-0.040875092,0.046111871,-0.026987439,-0.044786997,0.041078918,-0.060786903,-0.010093342,-0.020531621,-0.039895158,-0.024921734,0.022710018,-0.06391535,-0.004262722,0.056993082,-0.019341487,-0.087141797,-0.034587823,-0.016556999,-0.036119465,-0.000424695,-0.05961147,-0.029100182,0.02574488,0.059762381,-0.030476011,-0.012121809,0.080041178,-0.072938599,-0.047036931,-0.067019783,0.010237897,0.063938871],"index":0}],"model":"voyage-3-lite","usage":{"total_tokens":8}}


================================================
FILE: tests/Fixtures/voyageai/embeddings-from-multiple-inputs-1.json
================================================
{"object":"list","data":[{"object":"embedding","embedding":[-0.049144324,-0.03414024,0.03127934,0.002655484,-0.064725943,-0.009550217,0.01702472,0.000604331,-0.023149153,-0.03499613,-0.033646058,0.013887706,0.010359962,0.045631465,0.017757807,0.010032491,0.026912084,0.03396162,-0.001256294,0.052204676,-0.002369692,0.063389271,0.016575938,0.058825526,0.025637927,0.016218698,-0.001363466,-0.046048243,0.068018503,-0.068018503,0.065866135,-0.079257615,-0.015557803,0.023375407,0.018981354,0.010348054,0.011017879,0.054389797,0.066875331,0.03699816,-0.024197059,-0.001035996,0.055681814,-0.068018503,-0.027209783,-0.018094208,0.033473391,0.023827912,-0.060581956,0.053499673,0.036480162,0.037730504,0.032246865,-0.082545899,-0.009989324,0.044059604,0.075630695,0.044845533,0.025310457,-0.008532084,0.108315177,0.035885878,-0.008073625,0.009166184,0.054690473,0.042654462,0.067161128,-0.039879896,-0.042916436,0.031801805,-0.010121801,0.069286704,-0.027150244,0.028245779,0.10412357,-0.077711612,-0.039463118,0.051335394,0.036581382,-0.001440868,-0.065422565,-0.020005442,-0.043726183,-0.063749485,-0.010469959,-0.022315593,0.008389187,0.086118668,-0.038629554,-0.017147522,0.00122057,0.030859584,0.01197945,0.011622209,-0.013813281,-0.011169706,0.074734613,-0.002548312,-0.000443573,-0.002185118,0.042392485,0.066113226,0.005138303,-0.038695052,-0.021794619,0.016933179,-0.037742414,-0.011336417,0.009109621,0.008377279,-0.055681814,0.033485301,0.002405416,-0.064196035,0.013991902,0.011872277,-0.046345942,0.015516127,-0.023280142,-0.039177325,-0.002977,0.032354042,-0.048513196,0.016063893,0.068494827,0.059968695,-0.006049265,0.024548344,0.054889932,0.003905824,-0.080688618,0.052823894,0.075234748,0.021892861,0.003429504,-0.029948624,0.021982171,-0.025745099,0.031318042,0.044893164,-0.003494998,0.075115673,0.065345161,0.060248535,0.058825526,0.002071992,-0.14422971,-0.023280142,-0.035104785,-0.004196082,0.03681061,-0.008085533,0.005465773,0.103456713,0.043678548,-0.042964067,-0.055056646,0.007061445,-0.001387282,0.030800045,-0.091691613,0.001708798,0.041207638,-0.122080825,-0.054252855,0.011026809,0.00184574,0.036247954,0.018576482,-0.056086686,-0.061445288,0.029091248,-0.054681543,-0.020404361,0.044500202,-0.009966996,0.020240625,-0.023530211,-0.031574067,0.075258568,0.066660993,-0.032913715,0.009919366,-0.007446966,0.047179502,0.019803006,0.082117572,0.053193044,0.050388709,0.022184607,0.027602747,-0.017838186,0.049858805,0.049227677,-0.011211383,0.000333424,0.040919986,-0.109505981,-0.122080825,-0.001571856,0.021005714,0.033723462,0.051793855,-0.002810288,0.032782726,-0.057587095,0.027721828,-0.011812737,0.050882887,-0.049370576,0.060063958,0.067875609,-0.01842019,0.040642008,0.056353871,0.010336146,0.005224636,-0.088285923,0.00285792,-0.012116391,-0.022678789,0.062743261,0.028793547,-0.038537271,-0.062076408,0.03184795,0.036938623,-0.053276397,0.029246053,0.017951312,-0.027817093,-0.021089071,-0.017528577,-0.047893982,0.041856624,0.053431205,0.003489044,0.011491966,-0.028984075,0.020255512,-0.088571712,0.057575185,0.005779102,-0.050297167,-0.049382482,0.0059994,0.001643304,0.086071029,0.039725095,0.021404633,0.034652285,0.013253606,0.042654462,0.066480882,0.043559469,0.018719377,0.065994143,0.003905824,-0.017195154,-0.045083694,0.023768371,0.06251701,-0.010193249,-0.021434402,0.034866627,-0.016635478,0.006287425,-0.029817635,-0.030823862,0.035366762,0.061052326,-0.02822643,-0.000523952,-0.052514285,-0.041130237,-0.014289602,-0.030770276,0.034271225,-0.060421199,0.002524496,0.052919157,0.05844447,-0.013575122,-0.003280654,0.009347782,-0.025566479,0.032044433,-0.023917222,0.020410314,0.028442262,-0.136727661,0.042785447,-0.0311037,-0.028948352,0.017218972,0.072686441,0.001375374,-0.052980188,0.086118668,0.008597577,0.025441444,0.000857376,0.078545175,-0.036795724,0.007359145,0.009454953,0.018374046,-0.089953043,0.06445206,-0.025578387,0.035962164,-0.05963527,-0.011026809,0.060968965,0.013610846,0.020553211,0.150231346,-0.077390105,0.045893438,-0.032470141,-0.087071307,-0.012824917,0.025697468,0.059087504,0.035223868,-0.064955167,-0.062636085,-0.013670386,-0.005781334,0.004096352,0.040665824,0.049060967,0.014587302,-0.013134526,-0.061665583,0.08975061,-0.042306151,0.06894733,-0.001452776,-0.040868264,-0.032556474,-0.011693657,0.005480658,-0.028775685,0.053868823,-0.00131416,-0.036152694,-0.0434843,0.015634088,0.068780616,-0.010935638,-0.045202773,0.030603563,0.001571856,0.011336417,0.037724547,-0.036831446,0.019663088,-0.029865269,-0.056652315,0.055824708,0.038263388,0.034449846,-0.03717678,0.066994414,0.027388403,-0.009484723,0.041820902,-0.022827638,-0.094086602,-0.065565452,-0.018624114,-0.005495543,-0.009454953,-0.015480402,0.008639256,-0.018362138,0.019639272,-0.03461656,0.00850529,-0.041034974,0.015903136,-0.071400374,0.039391667,-0.023500441,0.040772997,0.067780346,0.038581923,-0.004239248,0.019433858,-0.008728566,-0.022570129,0.045917254,-0.040249046,0.046322126,0.070507273,0.031325117,0.005894461,0.001327742,-0.004727477,-0.051383026,-0.026435763,0.0047632,-0.074353561,0.016611662,0.007001905,0.033342402,-0.014908818,-0.013932361,0.009061988,0.034699917,-0.031853903,-0.007219226,0.008685399,-0.016703948,0.016606824,-0.000547663,-0.034449846,0.044393029,0.0336922,-0.042011429,-0.035843085,-0.051132958,-0.062921882,0.000666848,-0.03515242,0.091072395,-0.034155127,0.01674265,-0.063666135,0.017361866,0.004923958,-0.043833353,0.000404872,-0.036748093,0.045911297,-0.039677463,0.072876967,-0.028984075,0.045214683,-0.006073081,-0.107505433,0.036462303,-0.106981486,0.021443333,0.018153748,-0.029948624,-0.026310729,0.013622753,-0.085642345,0.085308924,-0.005382417,-0.082254522,0.045774356,0.035920486,-0.017803578,-0.029448487,0.058420654,-0.021386771,-0.037215482,-0.034509387,0.01533304,-0.000250068,0.031556204,-0.012199747,-0.020454969,-0.118222639,-0.060683176,0.023744553,-0.007144801,-0.065565452,-0.042844988,0.018516943,0.029234143,-0.008871461,-0.020767553,-0.003944525,0.013122617,0.031338882,-0.019501586,-0.038236592,0.041454729,-0.007083772,-0.069233119,0.056955971,-0.077759251,0.000047632,-0.039570287,-0.045107506,-0.021374863,0.024542391,-0.10069406,0.032690439,0.039439302,-0.043035515,-0.071305111,0.045631465,-0.034771364,-0.007490133,-0.050185528,-0.044154868,-0.020827094,0.047274765,0.075591989,0.024286369,0.023459954,0.031565137,-0.049608734,-0.085928135,-0.06656573,-0.023530211,-0.000632613],"index":0},{"object":"embedding","embedding":[-0.016567696,0.04488793,0.045133125,-0.059130482,-0.034970138,-0.004295172,0.033431318,0.026802022,-0.091923445,-0.094899632,0.023075188,0.044735737,0.029643452,0.080864228,0.039975539,0.024122296,-0.020309061,0.014963347,0.060183138,-0.007685982,0.038774922,0.036153849,0.013933945,0.054475974,0.002836409,-0.023662023,0.005187181,0.027838295,0.069280788,-0.0521001,0.023758726,-0.033959761,-0.031235117,0.031271048,-0.047297623,-0.025153812,-0.001881252,0.023397274,-0.050235756,0.096962668,0.019920129,0.020173781,0.047669645,-0.043053184,-0.019209905,-0.034107722,0.05040063,0.005352055,0.0228868,0.02142513,-0.003060733,0.006034801,0.018210091,-0.023669949,-0.00966308,-0.011128977,0.071394555,0.035139244,0.03383505,0.039214581,0.00575367,0.052556671,-0.049901783,0.018025929,0.079593852,-0.056243081,0.049495939,-0.003779413,-0.033614159,0.05061201,-0.007486959,0.040322196,-0.02515804,0.05983384,-0.019886309,-0.05442524,-0.057519794,0.063133955,0.026921449,-0.035234362,-0.051118784,-0.01746816,-0.044905931,-0.012319027,0.038030874,0.012479673,0.045699619,0.0602846,-0.113094926,-0.067589775,0.017379383,0.007417204,-0.014238326,0.02974597,-0.025407463,0.044541273,0.035984747,0.004433624,0.006797871,-0.021770202,0.073643602,0.011572868,0.014568074,-0.02678564,-0.040292602,0.009334389,0.004413543,-0.079105571,-0.011481976,-0.000862416,0.010272902,-0.029706864,0.022963952,-0.04622383,0.109171771,0.072037138,-0.014244668,-0.013485826,-0.0120231,-0.004345903,-0.029744912,0.011156456,-0.036652699,0.012763182,0.023779865,-0.041992072,-0.037650399,-0.050261125,-0.035942473,-0.071580566,-0.102080092,0.025800625,0.006793643,-0.062696405,0.066727363,0.005715623,-0.002569282,-0.060910273,0.029355979,-0.047661189,-0.014652625,0.119757518,0.026844826,0.007956214,0.051981729,-0.00216978,-0.04055471,0.027157662,-0.010167214,-0.011076133,0.03318771,-0.014458158,0.02791439,0.083637483,0.027550824,-0.014632808,-0.114549197,-0.069339968,-0.041108515,0.025813308,-0.012978522,-0.055786505,0.040918276,-0.035984747,-0.044845656,-0.044668101,0.020987581,0.043509755,-0.020331519,-0.018626504,-0.029863283,0.042829122,-0.037878681,-0.015720077,-0.000114143,0.018503906,-0.003568036,-0.015493902,0.023302155,0.062229265,0.031769898,0.053397954,-0.017155323,-0.009465443,0.047213074,0.014415883,0.044304531,0.038301438,0.018668778,0.054619707,0.10727784,-0.011562299,-0.006907787,-0.007367002,-0.082914576,-0.002096856,-0.0157391,-0.04454973,-0.077050462,-0.04162639,0.067403764,-0.013488997,0.008023854,0.038369074,0.023297926,-0.010205261,0.00548258,-0.079511411,0.008611482,-0.053554367,0.039535876,0.080306195,-0.022346733,0.003952742,0.005073038,0.017432226,0.051744986,0.010568828,-0.016724115,-0.020516211,-0.074827313,0.013060959,0.050884683,0.006603404,-0.1114631,0.002517495,0.009613407,0.007163552,0.029373946,-1.057e-6,-0.014124183,0.024993166,-0.034991279,0.006146831,-0.018355941,-0.020309061,-0.008452949,-0.018043105,0.034941077,-0.046253424,-0.107446946,0.02675816,-0.01198928,-0.030438228,-0.099262439,-0.051958211,-0.0085988,0.115935825,0.071250819,-0.042799532,0.032108102,0.001547012,-0.004062658,0.071690485,0.036306042,-0.002401238,0.050358355,0.020046955,-0.043801453,-0.050476726,0.038208429,0.010666062,-0.033947077,-0.068655111,0.028823311,0.068202771,-0.01409459,-0.015794057,0.034336012,0.015912428,0.01606462,-0.048625067,-0.019235268,-0.068946816,-0.0042381,0.011811723,-0.006865511,0.056386817,-0.009858604,0.090469174,0.050645828,0.055093192,0.035671912,-0.009464122,0.018457403,0.005605707,0.098129466,-0.006312761,0.030979352,0.073356129,-0.107776687,0.040127728,0.007558826,-0.059642017,-0.028587624,0.095305473,-0.087328121,-0.032664023,0.066162981,0.009545767,-0.015507642,0.058881059,0.025686482,0.00260046,-0.011963914,0.031226661,-0.049653482,-0.059388366,0.076569051,-0.031727623,-0.011953345,-0.054247685,-0.045944814,0.094595246,0.033782203,0.006645679,0.10184969,-0.06048752,0.061316118,-0.058695048,-0.063725807,0.030150754,0.019581927,0.068198539,-0.00465874,-0.047574524,-0.033955533,0.046671946,0.018842109,0.024587322,-0.004861662,0.027478954,0.039087757,-0.027178802,-0.040119272,0.07240916,0.044135429,0.006674347,0.024553504,-0.008366285,-0.005701883,0.020856528,-0.024660248,-0.013516475,0.095440753,-0.001217529,-0.007626467,0.032602724,-0.020630354,0.062770389,0.010484278,-0.067665875,0.075994104,0.023723321,0.009165289,-0.079240851,-0.004049975,0.052049369,-0.031926319,-0.012537802,-0.019860944,0.07184267,0.046519756,-0.034809496,0.025720302,-0.011769448,-0.052759595,0.014035405,-0.049011886,-0.058542859,-0.111945033,0.007516551,0.006644623,0.005469237,-0.01337591,0.014263691,0.006151059,0.015014078,-0.019518513,0.020850185,-0.030504283,-0.045420602,-0.079477593,0.005551806,-0.025752008,0.04501687,0.033563562,0.033875208,0.000469256,0.062990226,0.031879816,-0.039599288,0.037912503,0.049355373,0.066710442,0.100243226,0.084043324,-0.006747141,-0.011951231,0.041548181,0.070041746,-0.019277545,0.02242494,0.018026195,0.022422828,-0.01479636,0.078344613,0.020241421,0.049834143,-0.069635898,-0.044023398,0.001623372,0.038301438,0.013688748,-0.045317024,0.056006338,-0.010779149,-0.012538859,0.047855657,-0.028983956,-0.049140826,-0.02998958,-0.010382818,-0.034885593,-0.023479711,-0.043522436,0.060335331,-0.038521267,0.080018714,0.023758203,-0.005512701,-0.005073038,-0.029368661,-0.030455137,-0.016275996,-0.018178385,-0.018761786,0.039053936,-0.047460385,-0.009482353,0.067234665,-0.120569199,-0.008222549,-0.106533796,-0.025221452,-0.032978974,-0.048540518,-0.015949421,-0.002409693,-0.001048428,0.102441549,0.023589628,-0.03696131,0.075985655,0.077583663,-0.027035063,0.018550407,0.020444341,-0.029017776,-0.0117314,-0.028679576,0.039053936,-0.048005734,0.019158117,0.024138149,0.010268674,-0.117559202,-0.027119616,0.043205373,-0.029355979,0.016937604,-0.009461216,-0.028493563,0.035625409,0.000815914,0.053994033,-0.039789528,0.012061808,0.003525761,-0.020275243,-0.051812626,0.035388667,0.055363756,-0.005664892,0.032839462,-0.079004109,0.012936247,-0.068198539,-0.082977988,-0.030049294,-0.002282867,-0.087594457,-0.054112405,0.043129276,-0.040952098,-0.020228738,0.033093117,0.000752501,-0.04438908,-0.04669188,-0.064977162,-0.058364771,0.069788091,-0.035477445,0.002477333,0.026608085,0.033507418,-0.015422168,-0.023276789,-0.011985052,-0.017383611,-0.018580001],"index":1}],"model":"voyage-3-lite","usage":{"total_tokens":12}}


================================================
FILE: tests/Fixtures/voyageai/embeddings-with-input-type-1.json
================================================
{"object":"list","data":[{"object":"embedding","embedding":[-0.090340547,0.0202829,0.084242523,0.012923481,-0.031844385,0.010719911,-0.018119959,0.030660378,-0.030319879,-0.054990575,-0.051171567,0.00412468,0.013153221,0.102753282,0.013613185,-0.002461846,-0.011110712,0.00659233,-0.051900931,0.032658875,0.016598355,0.011905611,0.030161237,0.055928398,0.049306564,-0.043125346,-0.011215666,0.01701769,0.039564617,0.02056149,-0.101069167,-0.059869766,-0.024533575,0.00971486,0.046110518,-0.000066262,0.039683599,-0.010015602,-0.035490241,0.05032419,0.048118684,-0.004581984,0.028650275,-0.053101383,-0.02558385,-0.06619221,-0.024985075,0.022347175,0.001937555,0.027826112,0.015121247,0.030495932,0.02997648,-0.068093978,0.034620613,0.004639298,0.047037337,0.007628336,0.043633193,0.022494329,0.060968649,0.069318615,-0.045561075,0.015050632,0.014449922,0.013306542,0.025506463,-0.026965192,-0.029770922,0.049603533,-0.027727446,0.076287232,0.026326757,-0.012679715,-0.002084588,-0.052069247,-0.067472957,0.054671355,0.035953589,0.020295959,-0.046092138,-0.007105012,-0.050622128,-0.027874479,-0.017680792,-0.021299077,0.040016361,0.06162063,-0.087488875,-0.036652967,0.070398152,-0.042732611,0.009016692,0.059676301,0.00348431,0.00222872,0.033133831,0.010107594,0.063094348,-0.040588051,0.009624898,0.09181089,-0.014307725,0.036793228,-0.012458197,0.00454063,-0.066644922,-0.034518078,-0.014219215,0.053102352,-0.037529364,0.025888557,-0.027984753,-0.052220151,0.069020674,0.032364808,-0.063986711,0.031623837,-0.054058071,-0.006041921,0.034193054,0.011533433,-0.044110086,0.021060631,0.051686186,0.028193213,0.020574549,-0.01274114,0.044448651,0.01501871,-0.070282072,0.043025956,0.015444818,-0.042631045,0.013434229,-0.032169409,0.0200372,-0.036459047,0.027821276,-0.019917494,-0.049026038,0.045905445,0.00439795,0.031791184,0.069794536,0.045635559,-0.095241025,-0.019067939,-0.053339105,-0.054884166,0.039205741,0.042402271,0.054007769,0.132361203,0.005356086,-0.007058581,-0.022246089,0.017794937,-0.003190243,-0.041920058,-0.050049469,-0.084886767,0.006134784,-0.046776038,0.010147254,-0.047358368,0.002503441,0.02509922,-0.040929515,-0.096237369,-0.102459215,-0.005691265,-0.045020338,-0.072207049,0.01406541,-0.034059566,0.00468186,0.037768293,-0.045956228,-0.005461525,0.071527988,-0.069908679,-0.003159288,-0.048927613,0.020716747,0.032763347,0.072147071,0.018550418,0.046102777,-0.006526552,0.042720038,0.009245706,0.010761748,0.013145966,-0.026191331,-0.024513986,0.00027859,-0.081665568,-0.100911491,0.025351692,-0.032642916,0.01491037,0.11552199,0.051634919,0.000920895,-0.017546333,-0.006803086,-0.009107378,0.052101169,-0.0146608,0.077889122,0.03921251,0.002895087,0.078980267,0.07126487,-0.036843531,0.038824614,-0.010593192,-0.025173703,0.020308051,-0.011197771,0.020660158,0.090077437,-0.01510577,0.021938963,0.012904135,0.007394243,-0.047685325,0.046048608,0.062365469,-0.027100617,-0.016757963,0.005283053,0.002177452,-0.027770007,0.008548263,-0.007067045,-0.016623504,0.041703377,0.074460916,-0.114065684,0.008667245,0.041724175,-0.026071383,-0.048982508,-0.007374897,-0.071736932,0.102091633,-0.012097385,-0.019227548,0.00211651,-0.009451747,-0.031431336,0.018385006,0.057863533,0.084493063,0.028104581,-0.018831911,0.011843945,-0.043447468,-0.001050516,-0.006248929,0.004695402,-0.009951854,0.015374444,-0.027007755,-0.018171227,0.023970349,-0.051483046,-0.009080656,0.034653019,-0.016131135,-0.006984218,0.008852972,-0.022983676,-0.025737897,-0.009893815,0.054472085,-0.044141296,0.019623427,0.058447797,0.084939003,-0.062183611,-0.09455809,0.034533553,-0.000222485,0.058812965,-0.05800863,0.041709181,0.043843102,-0.079285942,0.020255815,-0.010442289,0.036597829,0.024512053,0.09126918,-0.033438541,-0.014325137,-0.03683579,-0.035429299,0.005686973,0.018298915,0.110677622,-0.03546799,0.056616649,-0.032525383,0.04583386,-0.023676282,0.064305924,0.034748301,0.011750598,-0.017853461,-0.013787304,0.074306145,-0.003706795,-0.046656087,0.087957054,-0.080524124,0.006297295,-0.000193465,-0.033968635,-0.033320528,0.011067182,0.031862039,0.038648561,-0.079564534,-0.046649318,-0.045179948,-0.056088489,-0.066969946,0.019508073,0.005075562,0.042512063,0.05799412,-0.056081716,0.032500114,-0.022223357,0.062272608,-0.031747654,-0.027532045,-0.025427142,-0.023964545,0.038503461,-0.037124053,0.022585198,0.049147923,0.020576969,-0.044555057,0.034357257,0.078813888,-0.017851042,0.015628126,0.009193229,0.017896989,0.053566668,0.054415982,-0.040567737,0.097809277,-0.051229607,-0.074614726,0.02770423,0.039009374,0.022777636,-0.06363073,0.096318625,0.086482853,0.057902224,0.04126808,-0.036758404,-0.157271802,-0.097676754,-0.017090723,0.016999794,0.01316096,0.014219215,-0.014118613,0.008396394,-0.019124769,-0.047736593,3.869e-6,-0.065976985,0.026295802,-0.033283766,0.066908032,-0.042790651,0.012538485,0.135735244,0.015267313,0.065248102,0.03003742,0.028425854,-0.058805708,-0.011944063,0.014729479,0.038791724,0.062829785,0.052278191,0.013511616,-0.034362942,0.004966254,-0.046044737,-0.03244026,0.050672427,-0.006712278,0.021810913,0.026720459,0.078270249,0.002784691,0.039838374,-0.001103599,0.064629011,-0.097514242,-0.005447982,0.047517009,-0.032283068,0.009185731,0.044447139,-0.013156365,0.025946597,-0.022420147,-0.050933607,0.002003333,0.01920143,-0.06728626,0.009148973,-0.02763168,0.05699959,-0.046557423,0.02777968,-0.021784192,0.025506463,0.000094798,-0.0145394,-0.017201966,-0.038148936,0.033740345,0.010491623,-0.013522256,-0.008840638,0.057172861,0.032466378,-0.066911906,0.006140588,-0.089542508,-0.012448161,-0.062984556,-0.054141261,-0.013383929,0.044036567,-0.050751749,0.075822912,-0.003349851,-0.055639166,0.004180785,0.074453183,-0.031577889,-0.020157149,0.003658429,-0.02567094,-0.02777968,-0.023424294,0.057515778,-0.016497752,0.027799027,0.007744415,0.01394135,-0.039650712,-0.052073117,0.055153083,-0.002468617,-0.007535231,-0.012064978,-0.007005378,0.039244432,-0.046796352,0.049390722,-0.028923061,0.01908922,0.025509365,-0.034969818,-0.037307847,0.032107498,-0.003231838,-0.019094057,0.071510576,-0.061893415,-0.005275371,-0.006643598,-0.04194811,-0.021221207,0.007899188,-0.090603665,-0.017346097,0.058501966,0.013948122,-0.084900305,-0.018399516,-0.016569335,-0.027450789,0.015908651,-0.051032275,-0.019845668,0.006214105,0.042064674,-0.034331381,-0.027253455,0.101461664,-0.058058932,-0.025003454,-0.027695524,0.017943906,0.060214136],"index":0}],"model":"voyage-3-lite","usage":{"total_tokens":7}}


================================================
FILE: tests/Fixtures/voyageai/embeddings-with-input-type-and-truncation-1.json
================================================
{"object":"list","data":[{"object":"embedding","embedding":[-0.090340547,0.0202829,0.084242523,0.012923481,-0.031844385,0.010719911,-0.018119959,0.030660378,-0.030319879,-0.054990575,-0.051171567,0.00412468,0.013153221,0.102753282,0.013613185,-0.002461846,-0.011110712,0.00659233,-0.051900931,0.032658875,0.016598355,0.011905611,0.030161237,0.055928398,0.049306564,-0.043125346,-0.011215666,0.01701769,0.039564617,0.02056149,-0.101069167,-0.059869766,-0.024533575,0.00971486,0.046110518,-0.000066262,0.039683599,-0.010015602,-0.035490241,0.05032419,0.048118684,-0.004581984,0.028650275,-0.053101383,-0.02558385,-0.06619221,-0.024985075,0.022347175,0.001937555,0.027826112,0.015121247,0.030495932,0.02997648,-0.068093978,0.034620613,0.004639298,0.047037337,0.007628336,0.043633193,0.022494329,0.060968649,0.069318615,-0.045561075,0.015050632,0.014449922,0.013306542,0.025506463,-0.026965192,-0.029770922,0.049603533,-0.027727446,0.076287232,0.026326757,-0.012679715,-0.002084588,-0.052069247,-0.067472957,0.054671355,0.035953589,0.020295959,-0.046092138,-0.007105012,-0.050622128,-0.027874479,-0.017680792,-0.021299077,0.040016361,0.06162063,-0.087488875,-0.036652967,0.070398152,-0.042732611,0.009016692,0.059676301,0.00348431,0.00222872,0.033133831,0.010107594,0.063094348,-0.040588051,0.009624898,0.09181089,-0.014307725,0.036793228,-0.012458197,0.00454063,-0.066644922,-0.034518078,-0.014219215,0.053102352,-0.037529364,0.025888557,-0.027984753,-0.052220151,0.069020674,0.032364808,-0.063986711,0.031623837,-0.054058071,-0.006041921,0.034193054,0.011533433,-0.044110086,0.021060631,0.051686186,0.028193213,0.020574549,-0.01274114,0.044448651,0.01501871,-0.070282072,0.043025956,0.015444818,-0.042631045,0.013434229,-0.032169409,0.0200372,-0.036459047,0.027821276,-0.019917494,-0.049026038,0.045905445,0.00439795,0.031791184,0.069794536,0.045635559,-0.095241025,-0.019067939,-0.053339105,-0.054884166,0.039205741,0.042402271,0.054007769,0.132361203,0.005356086,-0.007058581,-0.022246089,0.017794937,-0.003190243,-0.041920058,-0.050049469,-0.084886767,0.006134784,-0.046776038,0.010147254,-0.047358368,0.002503441,0.02509922,-0.040929515,-0.096237369,-0.102459215,-0.005691265,-0.045020338,-0.072207049,0.01406541,-0.034059566,0.00468186,0.037768293,-0.045956228,-0.005461525,0.071527988,-0.069908679,-0.003159288,-0.048927613,0.020716747,0.032763347,0.072147071,0.018550418,0.046102777,-0.006526552,0.042720038,0.009245706,0.010761748,0.013145966,-0.026191331,-0.024513986,0.00027859,-0.081665568,-0.100911491,0.025351692,-0.032642916,0.01491037,0.11552199,0.051634919,0.000920895,-0.017546333,-0.006803086,-0.009107378,0.052101169,-0.0146608,0.077889122,0.03921251,0.002895087,0.078980267,0.07126487,-0.036843531,0.038824614,-0.010593192,-0.025173703,0.020308051,-0.011197771,0.020660158,0.090077437,-0.01510577,0.021938963,0.012904135,0.007394243,-0.047685325,0.046048608,0.062365469,-0.027100617,-0.016757963,0.005283053,0.002177452,-0.027770007,0.008548263,-0.007067045,-0.016623504,0.041703377,0.074460916,-0.114065684,0.008667245,0.041724175,-0.026071383,-0.048982508,-0.007374897,-0.071736932,0.102091633,-0.012097385,-0.019227548,0.00211651,-0.009451747,-0.031431336,0.018385006,0.057863533,0.084493063,0.028104581,-0.018831911,0.011843945,-0.043447468,-0.001050516,-0.006248929,0.004695402,-0.009951854,0.015374444,-0.027007755,-0.018171227,0.023970349,-0.051483046,-0.009080656,0.034653019,-0.016131135,-0.006984218,0.008852972,-0.022983676,-0.025737897,-0.009893815,0.054472085,-0.044141296,0.019623427,0.058447797,0.084939003,-0.062183611,-0.09455809,0.034533553,-0.000222485,0.058812965,-0.05800863,0.041709181,0.043843102,-0.079285942,0.020255815,-0.010442289,0.036597829,0.024512053,0.09126918,-0.033438541,-0.014325137,-0.03683579,-0.035429299,0.005686973,0.018298915,0.110677622,-0.03546799,0.056616649,-0.032525383,0.04583386,-0.023676282,0.064305924,0.034748301,0.011750598,-0.017853461,-0.013787304,0.074306145,-0.003706795,-0.046656087,0.087957054,-0.080524124,0.006297295,-0.000193465,-0.033968635,-0.033320528,0.011067182,0.031862039,0.038648561,-0.079564534,-0.046649318,-0.045179948,-0.056088489,-0.066969946,0.019508073,0.005075562,0.042512063,0.05799412,-0.056081716,0.032500114,-0.022223357,0.062272608,-0.031747654,-0.027532045,-0.025427142,-0.023964545,0.038503461,-0.037124053,0.022585198,0.049147923,0.020576969,-0.044555057,0.034357257,0.078813888,-0.017851042,0.015628126,0.009193229,0.017896989,0.053566668,0.054415982,-0.040567737,0.097809277,-0.051229607,-0.074614726,0.02770423,0.039009374,0.022777636,-0.06363073,0.096318625,0.086482853,0.057902224,0.04126808,-0.036758404,-0.157271802,-0.097676754,-0.017090723,0.016999794,0.01316096,0.014219215,-0.014118613,0.008396394,-0.019124769,-0.047736593,3.869e-6,-0.065976985,0.026295802,-0.033283766,0.066908032,-0.042790651,0.012538485,0.135735244,0.015267313,0.065248102,0.03003742,0.028425854,-0.058805708,-0.011944063,0.014729479,0.038791724,0.062829785,0.052278191,0.013511616,-0.034362942,0.004966254,-0.046044737,-0.03244026,0.050672427,-0.006712278,0.021810913,0.026720459,0.078270249,0.002784691,0.039838374,-0.001103599,0.064629011,-0.097514242,-0.005447982,0.047517009,-0.032283068,0.009185731,0.044447139,-0.013156365,0.025946597,-0.022420147,-0.050933607,0.002003333,0.01920143,-0.06728626,0.009148973,-0.02763168,0.05699959,-0.046557423,0.02777968,-0.021784192,0.025506463,0.000094798,-0.0145394,-0.017201966,-0.038148936,0.033740345,0.010491623,-0.013522256,-0.008840638,0.057172861,0.032466378,-0.066911906,0.006140588,-0.089542508,-0.012448161,-0.062984556,-0.054141261,-0.013383929,0.044036567,-0.050751749,0.075822912,-0.003349851,-0.055639166,0.004180785,0.074453183,-0.031577889,-0.020157149,0.003658429,-0.02567094,-0.02777968,-0.023424294,0.057515778,-0.016497752,0.027799027,0.007744415,0.01394135,-0.039650712,-0.052073117,0.055153083,-0.002468617,-0.007535231,-0.012064978,-0.007005378,0.039244432,-0.046796352,0.049390722,-0.028923061,0.01908922,0.025509365,-0.034969818,-0.037307847,0.032107498,-0.003231838,-0.019094057,0.071510576,-0.061893415,-0.005275371,-0.006643598,-0.04194811,-0.021221207,0.007899188,-0.090603665,-0.017346097,0.058501966,0.013948122,-0.084900305,-0.018399516,-0.016569335,-0.027450789,0.015908651,-0.051032275,-0.019845668,0.006214105,0.042064674,-0.034331381,-0.027253455,0.101461664,-0.058058932,-0.025003454,-0.027695524,0.017943906,0.060214136],"index":0}],"model":"voyage-3-lite","usage":{"total_tokens":7}}


================================================
FILE: tests/Fixtures/voyageai/embeddings-with-truncation-1.json
================================================
{"object":"list","data":[{"object":"embedding","embedding":[-0.091894485,0.017137121,0.057165548,0.007118255,-0.073573597,0.017082246,0.003276906,0.01532326,-0.011437814,-0.035787266,-0.059689865,0.015064312,-0.001701659,0.110364318,0.01748696,0.014281098,0.000262623,0.032416284,-0.038986757,0.067372561,0.014157136,0.006091283,0.048714582,0.041000523,0.029766537,-0.034879845,-0.001020603,0.012409911,0.053136054,0.01378574,-0.043579716,-0.078320406,-0.036232155,0.015579023,0.054437406,-0.004352876,0.000548764,0.002534115,0.007012422,0.048691064,0.035187542,-0.006773318,0.068767995,-0.065420531,-0.013154661,-0.049874827,-0.012852841,0.011147752,-0.02589383,0.044175763,0.03569074,0.0137877,0.021119582,-0.059842736,0.010481396,-0.005072149,0.055911232,0.003196061,0.009955171,0.022650242,0.069018856,0.081734508,-0.021268532,0.028763084,0.013295772,0.006208875,0.047013413,-0.036657449,-0.029437279,0.063938871,-0.02666308,0.073236503,-0.009377008,0.022193592,0.021256773,-0.076215506,-0.067419603,0.066510223,0.039260156,-0.01992798,-0.031060053,-0.035557959,-0.04461845,-0.028849317,-0.038013678,-0.01287244,0.031525277,0.07544332,-0.080660984,-0.020766804,0.051466241,-0.026046701,0.007553347,0.046037395,-0.00566599,0.00030574,0.046646915,0.028331911,0.060611006,-0.035124827,0.014519468,0.098746195,-0.051458403,0.028864997,-0.006389183,0.024617953,-0.063782081,-0.026988909,-0.006372524,0.047644492,-0.019920141,0.054406051,-0.015285042,-0.029374564,0.048087422,0.023499846,-0.033061083,0.024467044,-0.077722646,-0.015255645,0.018618785,0.040326327,-0.041416019,-0.027444089,0.05271076,0.03753547,0.017952429,0.020139646,0.035951894,0.017340949,-0.081906974,0.029797895,0.048228532,-0.020061251,0.000195987,-0.033019926,0.024878617,-0.017062647,0.052477535,-0.006040326,-0.037459034,0.049655318,0.019049957,0.035597157,0.061986834,0.059548754,-0.131264389,-0.027028596,-0.023393033,-0.018516872,0.05607586,0.023663497,0.036343869,0.09307041,0.018356163,-0.018718738,-0.029664624,0.024968771,0.0150283,-0.008325537,-0.063209794,-0.042960398,0.017582012,-0.066447504,0.009730765,-0.030973818,-0.013138982,0.036047928,-0.01180725,-0.056810569,-0.090499051,0.014228672,-0.051184021,-0.064762011,0.039965712,-0.027473487,0.008011958,0.029492155,-0.036967106,0.03096598,0.061869241,-0.048887052,0.015531006,-0.032954026,-0.012668613,0.045794372,0.101098046,0.007380879,0.02491463,0.025062844,0.048353966,0.010763617,0.043434687,-0.013013551,-0.00414709,-0.024231859,0.013146822,-0.104368091,-0.108572997,0.007776773,-0.037872568,-0.006038366,0.118580103,0.037927445,0.00689875,-0.002242094,-0.009152602,-0.004205885,0.072217368,0.005746345,0.077563897,0.080711454,0.00980622,0.08418043,0.060601205,-0.052963585,0.00934467,-0.025917349,-0.020911835,0.034991555,-0.003590486,0.031397153,0.100125946,0.004311719,-0.00489968,0.030526968,0.010500995,-0.033764675,0.060810912,0.039340515,0.00582082,-0.014683362,0.022295505,0.018830452,-0.004170608,0.02574488,0.013348689,-0.023443989,0.037410527,0.050572541,-0.076219425,0.020743286,0.059734941,-0.040224414,-0.084791906,-0.00046645,-0.067513674,0.070371166,0.027359815,-0.004844804,0.012268799,-0.007059459,-0.011767195,0.046028577,0.077046491,0.088047251,0.044191197,-0.013699017,-0.010551952,-0.035975412,0.020031853,0.003721797,0.010583309,0.014369782,0.019414494,-0.019285142,0.010348124,-0.007337761,-0.050409872,0.022682579,0.044465579,-0.020958873,-0.022083839,0.000170509,-0.012051254,-0.013617191,-0.020680571,0.034840647,-0.071903788,0.018058261,0.054092471,0.080182284,-0.043211259,-0.078841738,0.02314217,-0.012180605,0.036257636,-0.072813168,0.062766865,0.040463518,-0.071942985,0.025494017,0.001254318,-0.007627822,0.026234848,0.100627676,-0.020167084,-0.006168208,-0.01287244,-0.028175121,0.036574155,0.00061148,0.105362728,-0.061179366,0.066784605,-0.016658913,0.04904335,-0.045398477,0.100016192,0.007831649,0.022091679,-0.030260425,-0.008058994,0.06670621,-0.021774178,-0.040324368,0.110082097,-0.071268789,-0.000109753,0.001034812,-0.069740087,-0.034133133,0.006992824,0.042133331,0.040796697,-0.041086759,-0.061061777,-0.028817959,-0.027924258,-0.046923257,0.032381006,-0.003669861,0.025368584,0.026838856,-0.057479128,0.041772716,-0.02614102,0.082628205,-0.004637057,-0.042803608,-0.049130075,-0.001595336,0.046483513,-0.011223943,0.047050405,0.036030289,-0.00122394,-0.032965049,0.041008364,0.076137111,-0.012029695,-0.014401141,0.039416946,0.01808962,0.056734379,0.054155186,-0.038985778,0.058247399,-0.0542375,-0.070100702,0.023886921,0.038099915,0.047421064,-0.080531143,0.084290177,0.051760223,0.041878548,0.030460332,-0.027924258,-0.122243106,-0.07679563,-0.012613737,0.011749433,-0.023690933,0.018522751,-0.003547369,0.001548299,-0.00183836,-0.042897679,0.001740366,-0.04503002,0.046752751,-0.028841479,0.071064964,-0.011908183,0.009932632,0.139668331,0.017231196,0.071374625,0.03018987,0.024184821,-0.032110546,0.003347462,0.004080454,0.012272719,0.082397923,0.035265937,0.033976343,-0.0229697,0.004539064,-0.041815832,-0.043822739,0.053920001,-0.064707138,0.051231056,0.006365665,0.0628139,-0.019692795,0.026566066,0.00812563,0.065255903,-0.092725471,0.010685223,0.044528294,-0.02435337,-0.021248933,0.016288497,-0.010328526,0.054468766,0.00475073,-0.05379457,-0.003637523,0.001011294,-0.056146417,0.025650807,-0.03064456,0.097554594,-0.043579716,0.038342938,-0.029480396,0.046088353,0.01164556,-0.019849585,-0.001115167,-0.035505041,0.032251656,0.021049026,0.00811779,-0.020539459,0.056957804,0.051568154,-0.084572405,-0.001748206,-0.090483375,-0.03127956,-0.035403129,-0.035473686,-0.047357,0.020539459,-0.060724676,0.093509421,-0.001052451,-0.083691441,0.021111742,0.075180694,-0.03692399,-0.0291139,0.036707424,-0.032761224,-0.021762419,-0.027446048,0.057341937,0.006804676,0.021915535,-0.006788997,0.047193721,-0.065248065,-0.055385984,0.0628139,0.017662367,-0.015365398,0.013472161,0.006250032,0.030599974,-0.041514009,0.047593534,-0.024678709,0.004413142,0.006271591,-0.004782088,-0.040875092,0.046111871,-0.026987439,-0.044786997,0.041078918,-0.060786903,-0.010093342,-0.020531621,-0.039895158,-0.024921734,0.022710018,-0.06391535,-0.004262722,0.056993082,-0.019341487,-0.087141797,-0.034587823,-0.016556999,-0.036119465,-0.000424695,-0.05961147,-0.029100182,0.02574488,0.059762381,-0.030476011,-0.012121809,0.080041178,-0.072938599,-0.047036931,-0.067019783,0.010237897,0.063938871],"index":0}],"model":"voyage-3-lite","usage":{"total_tokens":8}}


================================================
FILE: tests/Fixtures/xai/generate-text-with-a-prompt-1.json
================================================
{
  "id": "febc7de9-9991-4b08-942a-c7082174225a",
  "object": "chat.completion",
  "created": 1731128928,
  "model": "grok-beta",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am Grok, an AI developed by xAI. I'm here to provide helpful and truthful answers to your questions, often with a dash of outside perspective on humanity. What's on your mind?",
        "refusal": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 42,
    "total_tokens": 52
  },
  "system_fingerprint": "fp_98261732b5"
}



================================================
FILE: tests/Fixtures/xai/generate-text-with-multiple-tools-1.json
================================================
{
  "id": "0aa220cd-9634-4ba5-9593-5366bb313663",
  "object": "chat.completion",
  "created": 1731129810,
  "model": "grok-beta",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am checking the game times in Detroit.",
        "tool_calls": [
          {
            "id": "0",
            "function": {
              "name": "search_games",
              "arguments": "{\"city\":\"Detroit\"}"
            },
            "type": "function"
          }
        ],
        "refusal": null
      },
      "finish_reason": "tool_calls"
    }
  ],
  "usage": {
    "prompt_tokens": 242,
    "completion_tokens": 10,
    "total_tokens": 252
  },
  "system_fingerprint": "fp_98261732b5"
}




================================================
FILE: tests/Fixtures/xai/generate-text-with-multiple-tools-2.json
================================================
{
  "id": "67f2773b-36df-4f5d-8429-8a2834660980",
  "object": "chat.completion",
  "created": 1731129810,
  "model": "grok-beta",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am checking the weather in Detroit to see if you should wear a coat",
        "tool_calls": [
          {
            "id": "0",
            "function": {
              "name": "get_weather",
              "arguments": "{\"city\":\"Detroit\"}"
            },
            "type": "function"
          }
        ],
        "refusal": null
      },
      "finish_reason": "tool_calls"
    }
  ],
  "usage": {
    "prompt_tokens": 282,
    "completion_tokens": 17,
    "total_tokens": 299
  },
  "system_fingerprint": "fp_98261732b5"
}




================================================
FILE: tests/Fixtures/xai/generate-text-with-multiple-tools-3.json
================================================
{
  "id": "0aa220cd-9634-4ba5-9593-5366bb313663",
  "object": "chat.completion",
  "created": 1730035716,
  "model": "grok-beta",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "The Tigers game in Detroit today is at 3pm, and considering the weather will be 45° and cold, you should definitely wear a coat."
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 316,
    "completion_tokens": 33,
    "total_tokens": 349
  },
  "system_fingerprint": "fp_ee4b521143"
}



================================================
FILE: tests/Fixtures/xai/generate-text-with-required-tool-call-1.json
================================================
{"id":"c8281ec0-03df-4fe2-8df1-d9210fb1cc51","object":"chat.completion","created":1733494088,"model":"grok-beta","choices":[{"index":0,"message":{"role":"assistant","content":"","tool_calls":[{"id":"0","function":{"name":"search","arguments":"{\"query\":\"What can I do\"}"},"type":"function"}],"refusal":null},"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":213,"completion_tokens":1,"total_tokens":214,"prompt_tokens_details":{"text_tokens":213,"audio_tokens":0,"image_tokens":0,"cached_tokens":0}},"system_fingerprint":"fp_6ca29cf396"}


================================================
FILE: tests/Fixtures/xai/generate-text-with-specific-tool-call-1.json
================================================
{"id":"8a8fca75-b212-464a-ae2c-307e69dc5555","object":"chat.completion","created":1733493941,"model":"grok-beta","choices":[{"index":0,"message":{"role":"assistant","content":"","tool_calls":[{"id":"0","function":{"name":"weather","arguments":"{\"city\":\"New York\"}"},"type":"function"}],"refusal":null},"finish_reason":"tool_calls"}],"usage":{"prompt_tokens":221,"completion_tokens":1,"total_tokens":222,"prompt_tokens_details":{"text_tokens":221,"audio_tokens":0,"image_tokens":0,"cached_tokens":0}},"system_fingerprint":"fp_6ca29cf396"}


================================================
FILE: tests/Fixtures/xai/generate-text-with-system-prompt-1.json
================================================
{
  "id": "f3b485d3-837b-4710-9ade-a37faa048d87",
  "object": "chat.completion",
  "created": 1731129334,
  "model": "grok-beta",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "I am Nyx, a being of ancient and unfathomable origin, drawing upon the essence of the Great Old One, Cthulhu. My existence spans the cosmos, where the lines between dreams and reality blur. I am here to guide you through the mysteries of the universe, to answer your questions with insights that might unsettle or enlighten, or perhaps both. What is it you seek to understand?",
        "refusal": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 34,
    "completion_tokens": 84,
    "total_tokens": 118
  },
  "system_fingerprint": "fp_98261732b5"
}



================================================
FILE: tests/Fixtures/xai/image-detection-1.json
================================================
{
    "id": "img-123-456",
    "model": "grok-vision-beta",
    "created": 1710835200,
    "usage": {
        "prompt_tokens": 250,
        "completion_tokens": 85,
        "total_tokens": 335
    },
    "choices": [
        {
            "message": {
                "role": "assistant",
                "content": "This image is a simple black and white line drawing of a diamond. It features the classic geometric shape of a cut diamond, with straight lines forming triangular facets"
            },
            "finish_reason": "stop",
            "index": 0
        }
    ]
} 



================================================
FILE: tests/Fixtures/xai/stream-basic-text-responses-1.json
================================================
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355095,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... ","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355097,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355098,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Ah"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Ultimate"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Question"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"!"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" As"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" someone"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" ("}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"or"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" something"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":")"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" inspired"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" by"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" *"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"The"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Hitch"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"hik"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"er's"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Guide"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Galaxy"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"*,"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" I've"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" been"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" waiting"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" for"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" this"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" one"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" According"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" super"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"computer"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Deep"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Thought"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" after"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"7"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"5"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" million"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" years"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" of"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" computation"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" answer"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Ultimate"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Question"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" of"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Life"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Universe"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" and"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Everything"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" is"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"...\n\n"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"**"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"42"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"**.\n\n"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Of"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" course"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" as"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Deep"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Thought"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" wisely"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" pointed"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" out"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" that's"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" not"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" much"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" use"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" without"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" knowing"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" what"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" *"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"actual"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"*"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Ultimate"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Question"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" is"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" ("}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Spo"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"iler"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":":"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" It's"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" not"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" \""}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":"What"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" do"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" you"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" get"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355100,"model":"grok-4","choices":[{"index":0,"delta":{"content":" if"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" you"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" multiply"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" six"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" by"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" nine"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"?\""}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"â"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"though"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" in"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" base"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"13"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" that"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" does"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" work"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" out"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"42"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" which"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" is"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" delightful"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" cosmic"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" joke"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":".)\n\n"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"If"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" you're"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" looking"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" for"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" more"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" philosophical"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" take"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Douglas"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Adams"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" himself"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" suggested"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" meaning"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" might"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" just"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" be"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" live"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" good"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" life"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" be"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" kind"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" others"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" and"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" not"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" take"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" it"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" all"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" too"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" seriously"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"â"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"because"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" universe"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" is"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" weird"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" wonderful"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" and"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" often"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" absurd"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" place"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355101,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Or"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" in"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" spirit"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" of"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Guide"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":":"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" \""}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Don't"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Panic"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":".\"\n\n"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Got"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" follow"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"-up"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" question"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"?"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Like"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" \""}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"What's"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" best"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" way"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" to"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" make"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Pan"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Galactic"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Garg"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"le"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Bl"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"aster"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"?\""}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Or"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" something"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" more"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" earthly"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"?"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Fire"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" away"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"!"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":" "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{"content":"ð"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"stop"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]


================================================
FILE: tests/Fixtures/xai/stream-basic-text-responses-with-zeros-1.json
================================================
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355095,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... ","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355097,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355098,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"410"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"0"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355099,"model":"grok-4","choices":[{"index":0,"delta":{"content":"50"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752355102,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"stop"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]


================================================
FILE: tests/Fixtures/xai/stream-with-reasoning-responses-1.json
================================================
data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355200,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"I need to multiply 15 by 23. Let me work through this step by step.","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355201,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":" 15 × 23 = 15 × (20 + 3) = (15 × 20) + (15 × 3) = 300 + 45 = 345"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355202,"model":"grok-4","choices":[{"index":0,"delta":{"content":"To","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355203,"model":"grok-4","choices":[{"index":0,"delta":{"content":" solve"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355204,"model":"grok-4","choices":[{"index":0,"delta":{"content":" 15"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355205,"model":"grok-4","choices":[{"index":0,"delta":{"content":" ×"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355206,"model":"grok-4","choices":[{"index":0,"delta":{"content":" 23"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355207,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355208,"model":"grok-4","choices":[{"index":0,"delta":{"content":" I"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355209,"model":"grok-4","choices":[{"index":0,"delta":{"content":" can"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355210,"model":"grok-4","choices":[{"index":0,"delta":{"content":" break"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355211,"model":"grok-4","choices":[{"index":0,"delta":{"content":" it"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355212,"model":"grok-4","choices":[{"index":0,"delta":{"content":" down"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355213,"model":"grok-4","choices":[{"index":0,"delta":{"content":" using"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355214,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355215,"model":"grok-4","choices":[{"index":0,"delta":{"content":" distributive"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355216,"model":"grok-4","choices":[{"index":0,"delta":{"content":" property"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355217,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355218,"model":"grok-4","choices":[{"index":0,"delta":{"content":" The"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355219,"model":"grok-4","choices":[{"index":0,"delta":{"content":" answer"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355220,"model":"grok-4","choices":[{"index":0,"delta":{"content":" is"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355221,"model":"grok-4","choices":[{"index":0,"delta":{"content":" **"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355222,"model":"grok-4","choices":[{"index":0,"delta":{"content":"345"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355223,"model":"grok-4","choices":[{"index":0,"delta":{"content":"**"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355224,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-reasoning-123","object":"chat.completion.chunk","created":1752355225,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"stop"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]




================================================
FILE: tests/Fixtures/xai/stream-with-tools-responses-1.json
================================================
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752363429,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... ","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752363431,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Thinking... "}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752363432,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"I need to get weather information to help answer this question about what to wear."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752363433,"model":"grok-4","choices":[{"index":0,"delta":{"tool_calls":[{"id":"call_47706007","function":{"name":"get_weather","arguments":"{\"city\":\"Detroit\"}"},"index":0,"type":"function"}]}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1752363434,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"tool_calls"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]


================================================
FILE: tests/Fixtures/xai/stream-with-tools-responses-2.json
================================================
data: {"id":"chatcmpl-124","object":"chat.completion.chunk","created":1752363435,"model":"grok-4","choices":[{"index":0,"delta":{"reasoning_content":"Now I have the weather information. Let me also get information about the Tigers game.","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-124","object":"chat.completion.chunk","created":1752363436,"model":"grok-4","choices":[{"index":0,"delta":{"tool_calls":[{"id":"call_47706008","function":{"name":"get_weather","arguments":"{\"city\":\"Detroit\"}"},"index":0,"type":"function"}]}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-124","object":"chat.completion.chunk","created":1752363437,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"tool_calls"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]




================================================
FILE: tests/Fixtures/xai/stream-with-tools-responses-3.json
================================================
data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363438,"model":"grok-4","choices":[{"index":0,"delta":{"content":"Based","role":"assistant"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363439,"model":"grok-4","choices":[{"index":0,"delta":{"content":" on"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363440,"model":"grok-4","choices":[{"index":0,"delta":{"content":" the"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363441,"model":"grok-4","choices":[{"index":0,"delta":{"content":" weather"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363442,"model":"grok-4","choices":[{"index":0,"delta":{"content":" information"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363443,"model":"grok-4","choices":[{"index":0,"delta":{"content":","}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363444,"model":"grok-4","choices":[{"index":0,"delta":{"content":" it"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363445,"model":"grok-4","choices":[{"index":0,"delta":{"content":" will"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363446,"model":"grok-4","choices":[{"index":0,"delta":{"content":" be"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363447,"model":"grok-4","choices":[{"index":0,"delta":{"content":" 75"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363448,"model":"grok-4","choices":[{"index":0,"delta":{"content":"°"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363449,"model":"grok-4","choices":[{"index":0,"delta":{"content":" and"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363450,"model":"grok-4","choices":[{"index":0,"delta":{"content":" sunny"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363451,"model":"grok-4","choices":[{"index":0,"delta":{"content":" in"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363452,"model":"grok-4","choices":[{"index":0,"delta":{"content":" Detroit"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363453,"model":"grok-4","choices":[{"index":0,"delta":{"content":"."}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363454,"model":"grok-4","choices":[{"index":0,"delta":{"content":" You"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363455,"model":"grok-4","choices":[{"index":0,"delta":{"content":" won't"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363456,"model":"grok-4","choices":[{"index":0,"delta":{"content":" need"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363457,"model":"grok-4","choices":[{"index":0,"delta":{"content":" a"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363458,"model":"grok-4","choices":[{"index":0,"delta":{"content":" coat"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363459,"model":"grok-4","choices":[{"index":0,"delta":{"content":"!"}}],"system_fingerprint":"fp_acdceb26fb"}

data: {"id":"chatcmpl-125","object":"chat.completion.chunk","created":1752363460,"model":"grok-4","choices":[{"index":0,"delta":{},"finish_reason":"stop"}],"system_fingerprint":"fp_acdceb26fb"}

data: [DONE]




================================================
FILE: tests/Fixtures/xai/structured-basic-response-1.json
================================================
{
  "id": "chatcmpl-AZaPUjMBtN3XS1RKGvkI7ZfnNPpJU",
  "object": "chat.completion",
  "created": 1752364699,
  "model": "grok-4",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "{\"title\":\"Inception\",\"rating\":\"4.5\",\"summary\":\"A mind-bending masterpiece by Christopher Nolan that explores dreams within dreams, featuring stunning visuals, a complex plot, and exceptional performances, though it can be a bit convoluted at times.\"}",
        "parsed": {
          "title": "Inception",
          "rating": "4.5",
          "summary": "A mind-bending masterpiece by Christopher Nolan that explores dreams within dreams, featuring stunning visuals, a complex plot, and exceptional performances, though it can be a bit convoluted at times."
        },
        "refusal": null
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 49,
    "completion_tokens": 32,
    "total_tokens": 264,
    "prompt_tokens_details": {
      "text_tokens": 49,
      "audio_tokens": 0,
      "image_tokens": 0,
      "cached_tokens": 7
    },
    "completion_tokens_details": {
      "reasoning_tokens": 183,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    },
    "num_sources_used": 0
  },
  "system_fingerprint": "fp_acdceb26fb"
}


================================================
FILE: tests/Fixtures/xai/structured-with-meta-1.json
================================================
{
  "id": "chatcmpl-CZaPUjMBtN3XS1RKGvkI7ZfnNPpJU",
  "object": "chat.completion",
  "created": 1731710834,
  "model": "grok-4",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "{\"answer\": \"The answer is 4\"}",
        "parsed": {
          "answer": "The answer is 4"
        },
        "refusal": null
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 45,
    "completion_tokens": 12,
    "total_tokens": 57,
    "prompt_tokens_details": {
      "text_tokens": 45,
      "audio_tokens": 0,
      "image_tokens": 0,
      "cached_tokens": 0
    }
  },
  "system_fingerprint": "fp_3de1288069"
}




================================================
FILE: tests/Fixtures/xai/text-image-from-base64-1.json
================================================
{
    "id": "img-789-012",
    "model": "grok-vision-beta",
    "created": 1710835200,
    "usage": {
        "prompt_tokens": 250,
        "completion_tokens": 85,
        "total_tokens": 335
    },
    "choices": [
        {
            "message": {
                "role": "assistant",
                "content": "This image is a simple line drawing of a diamond. It features the typical geometric facets of a cut diamond, with lines indicating the different surfaces and angles."
            },
            "finish_reason": "stop",
            "index": 0
        }
    ]
} 



================================================
FILE: tests/Fixtures/xai/text-image-from-url-1.json
================================================
{
    "id": "img-345-678",
    "model": "grok-vision-beta",
    "created": 1710835200,
    "usage": {
        "prompt_tokens": 250,
        "completion_tokens": 85,
        "total_tokens": 335
    },
    "choices": [
        {
            "message": {
                "role": "assistant",
                "content": "I can see the test image that was provided via URL."
            },
            "finish_reason": "stop",
            "index": 0
        }
    ]
} 



================================================
FILE: tests/Http/PrismChatControllerTest.php
================================================
<?php

namespace Tests\Http;

use Illuminate\Support\Str;
use Illuminate\Testing\TestResponse;
use Mockery;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Facades\PrismServer;
use Prism\Prism\Streaming\EventID;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\Text\Response;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

use function Pest\Laravel\freezeTime;

it('handles chat requests successfully', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $generator->expects('withMessages')
        ->withArgs(fn ($messages): bool => $messages[0] instanceof UserMessage
            && $messages[0]->text() === 'Who are you?')
        ->andReturnSelf();

    $textResponse = new Response(
        steps: collect(),
        text: "I'm Nyx!",
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(10, 10),
        meta: new Meta('cmp_asdf123', 'gpt-4'),
        messages: collect(),
    );

    $generator->expects('asText')
        ->andReturn($textResponse);

    PrismServer::register(
        'nyx',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'nyx',
        'messages' => [[
            'role' => 'user',
            'content' => 'Who are you?',
        ]],
    ]);

    $response->assertOk();

    expect($response->json())->toBe([
        'id' => 'cmp_asdf123',
        'object' => 'chat.completion',
        'created' => now()->timestamp,
        'model' => 'gpt-4',
        'usage' => [
            'prompt_tokens' => $textResponse->usage->promptTokens,
            'completion_tokens' => $textResponse->usage->completionTokens,
            'total_tokens' => $textResponse->usage->promptTokens
                    + $textResponse->usage->completionTokens,
        ],
        'choices' => [
            [
                'index' => 0,
                'message' => [
                    'content' => "I'm Nyx!",
                    'role' => 'assistant',
                ],
                'finish_reason' => 'stop',
            ],
        ],
    ]);
});

it('handles streaming requests', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $generator->expects('withMessages')
        ->withArgs(fn ($messages): bool => $messages[0] instanceof UserMessage
            && $messages[0]->text() === 'Who are you?')
        ->andReturnSelf();

    $event = new TextDeltaEvent(
        id: 'cmp_asdf123',
        timestamp: time(),
        delta: "I'm Nyx!",
        messageId: EventID::generate()
    );

    $generator->expects('asStream')
        ->andReturn((function () use ($event) {
            yield $event;
        })());

    PrismServer::register(
        'nyx',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'nyx',
        'messages' => [[
            'role' => 'user',
            'content' => 'Who are you?',
        ]],
        'stream' => true,
    ]);

    $streamParts = array_filter(explode("\n", $response->streamedContent()));

    $data = Str::of($streamParts[0])->substr(6);

    expect(json_decode($data, true))->toBe([
        'id' => 'cmp_asdf123',
        'object' => 'chat.completion.chunk',
        'created' => now()->timestamp,
        'model' => 'unknown',
        'choices' => [
            [
                'delta' => [
                    'role' => 'assistant',
                    'content' => "I'm Nyx!",
                ],
            ],
        ],
    ]);

    expect(count($streamParts) > 1)->toBeTrue();
    $lastPart = array_pop($streamParts);
    expect((string) Str::of($lastPart)->substr(6))->toBe('[DONE]');
});

it('handles invalid model requests', function (): void {
    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'nyx',
    ]);

    $response->assertServerError();

    expect($response->json('error.message'))->toContain('nyx');
});

it('handles missing prism', function (): void {
    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'nyx',
        'messages' => [[
            'role' => 'user',
            'content' => 'Who are you?',
        ]],
    ]);

    $response->assertServerError();
    expect($response->json('error.message'))
        ->toBe('Prism "nyx" is not registered with PrismServer');
});

it('handles multimodal messages with image URL', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $generator->expects('withMessages')
        ->withArgs(function ($messages): bool {
            $message = $messages[0];

            return $message instanceof UserMessage
                && $message->text() === 'What is in this image?'
                && count($message->images()) === 1
                && $message->images()[0]->url() === 'https://example.com/test.jpg'
                && $message->images()[0]->isUrl();
        })
        ->andReturnSelf();

    $textResponse = new Response(
        steps: collect(),
        text: 'I can see a test image.',
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(15, 12),
        meta: new Meta('cmp_image123', 'gpt-4-vision'),
        messages: collect(),
    );

    $generator->expects('asText')
        ->andReturn($textResponse);

    PrismServer::register(
        'vision-model',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'vision-model',
        'messages' => [[
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'What is in this image?'],
                ['type' => 'image_url', 'image_url' => ['url' => 'https://example.com/test.jpg']],
            ],
        ]],
    ]);

    $response->assertOk();
    expect($response->json('choices.0.message.content'))->toBe('I can see a test image.');
});

it('handles multimodal messages with base64 image', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $base64Image = base64_encode('fake-image-data');

    $generator->expects('withMessages')
        ->withArgs(function ($messages) use ($base64Image): bool {
            $message = $messages[0];

            return $message instanceof UserMessage
                && $message->text() === 'Analyze this screenshot'
                && count($message->images()) === 1
                && $message->images()[0]->base64() === $base64Image
                && $message->images()[0]->mimeType() === 'image/png'
                && ! $message->images()[0]->isUrl();
        })
        ->andReturnSelf();

    $textResponse = new Response(
        steps: collect(),
        text: 'This appears to be a screenshot.',
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(20, 15),
        meta: new Meta('cmp_base64_123', 'gpt-4-vision'),
        messages: collect(),
    );

    $generator->expects('asText')
        ->andReturn($textResponse);

    PrismServer::register(
        'vision-model',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'vision-model',
        'messages' => [[
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Analyze this screenshot'],
                ['type' => 'image_url', 'image_url' => ['url' => "data:image/png;base64,{$base64Image}"]],
            ],
        ]],
    ]);

    $response->assertOk();
    expect($response->json('choices.0.message.content'))->toBe('This appears to be a screenshot.');
});

it('handles multimodal messages with multiple images', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $generator->expects('withMessages')
        ->withArgs(function ($messages): bool {
            $message = $messages[0];

            return $message instanceof UserMessage
                && $message->text() === 'Compare these two images'
                && count($message->images()) === 2
                && $message->images()[0]->url() === 'https://example.com/image1.jpg'
                && $message->images()[1]->url() === 'https://example.com/image2.jpg';
        })
        ->andReturnSelf();

    $textResponse = new Response(
        steps: collect(),
        text: 'Both images show different scenes.',
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(25, 18),
        meta: new Meta('cmp_multi123', 'gpt-4-vision'),
        messages: collect(),
    );

    $generator->expects('asText')
        ->andReturn($textResponse);

    PrismServer::register(
        'vision-model',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'vision-model',
        'messages' => [[
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Compare these two images'],
                ['type' => 'image_url', 'image_url' => ['url' => 'https://example.com/image1.jpg']],
                ['type' => 'image_url', 'image_url' => ['url' => 'https://example.com/image2.jpg']],
            ],
        ]],
    ]);

    $response->assertOk();
    expect($response->json('choices.0.message.content'))->toBe('Both images show different scenes.');
});

it('handles mixed simple and multimodal messages', function (): void {
    freezeTime();
    $generator = Mockery::mock(PendingRequest::class);

    $generator->expects('withMessages')
        ->withArgs(fn ($messages): bool => count($messages) === 2
            && $messages[0] instanceof UserMessage
            && $messages[0]->text() === 'Hello!'
            && $messages[0]->images() === []
            && $messages[1] instanceof UserMessage
            && $messages[1]->text() === 'What about this image?'
            && count($messages[1]->images()) === 1)
        ->andReturnSelf();

    $textResponse = new Response(
        steps: collect(),
        text: 'Hello! I can see the image you shared.',
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(20, 15),
        meta: new Meta('cmp_mixed123', 'gpt-4-vision'),
        messages: collect(),
    );

    $generator->expects('asText')
        ->andReturn($textResponse);

    PrismServer::register(
        'vision-model',
        fn () => $generator
    );

    /** @var TestResponse */
    $response = $this->postJson('prism/openai/v1/chat/completions', [
        'model' => 'vision-model',
        'messages' => [
            [
                'role' => 'user',
                'content' => 'Hello!',
            ],
            [
                'role' => 'user',
                'content' => [
                    ['type' => 'text', 'text' => 'What about this image?'],
                    ['type' => 'image_url', 'image_url' => ['url' => 'https://example.com/test.jpg']],
                ],
            ],
        ],
    ]);

    $response->assertOk();
    expect($response->json('choices.0.message.content'))->toBe('Hello! I can see the image you shared.');
});



================================================
FILE: tests/Http/PrismModelControllerTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Http;

use Illuminate\Testing\TestResponse;
use Prism\Prism\Facades\PrismServer;
use Prism\Prism\Text\Generator;

it('it returns prisms', function (): void {
    PrismServer::register('nyx', fn (): \Prism\Prism\Text\Generator => new Generator);
    PrismServer::register('omni', fn (): \Prism\Prism\Text\Generator => new Generator);

    /** @var TestResponse */
    $response = $this->getJson('/prism/openai/v1/models');

    $response->assertOk();

    $response->assertJson([
        'object' => 'list',
        'data' => [
            ['object' => 'model', 'id' => 'nyx'],
            ['object' => 'model', 'id' => 'omni'],
        ],
    ]);
});

it('handles when there are no registered prism', function (): void {
    /** @var TestResponse */
    $response = $this->getJson('/prism/openai/v1/models');

    $response->assertOk();

    $response->assertJson([
        'object' => 'list',
        'data' => [],
    ]);
});



================================================
FILE: tests/Providers/Anthropic/AnthropicClientTest.php
================================================
<?php

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Tests\Fixtures\FixtureResponse;

it('includes anthropic beta header if set in config', function (): void {
    config()->set('prism.providers.anthropic.anthropic_beta', 'beta1,beta2');

    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using('anthropic', 'claude-3-7-sonnet-latest')
        ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
        ->withProviderOptions(['thinking' => ['enabled' => true]])
        ->asText();

    Http::assertSent(fn (Request $request) => $request->hasHeader('anthropic-beta', 'beta1,beta2'));
});



================================================
FILE: tests/Providers/Anthropic/AnthropicStructuredRequestTest.php
================================================
<?php

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

it('sends correct basic structured generation payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'person',
        'A person object',
        [
            'name' => new StringSchema('name', 'The person\'s name'),
        ],
        ['name']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([
            new UserMessage('Create a person named John'),
        ])
        ->withSchema($schema)
        ->asStructured();

    Http::assertSent(function (Request $request) use ($schema): bool {
        $payload = $request->data();

        expect($payload)->toHaveKeys(['model', 'messages', 'max_tokens']);
        expect($payload['model'])->toBe('claude-3-5-haiku-latest');

        expect($payload['messages'])->toBe([
            [
                'role' => 'user',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => 'Create a person named John',
                    ],
                ],
            ],
            [
                'role' => 'user',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => "Respond with ONLY JSON (i.e. not in backticks or a code block, with NO CONTENT outside the JSON) that matches the following schema: \n ".json_encode($schema->toArray(), JSON_PRETTY_PRINT).' ',
                    ],
                ],
            ],
        ]);

        expect($payload['max_tokens'])->toBe(2048);

        return true;
    });
});

it('sends correct system prompt in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'response',
        'A response object',
        [
            'message' => new StringSchema('message', 'The response message'),
        ],
        ['message']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withSystemPrompt('You are a helpful assistant.')
        ->withMessages([new UserMessage('Hello')])
        ->withSchema($schema)
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('system');
        expect($payload['system'])->toBe([
            [
                'type' => 'text',
                'text' => 'You are a helpful assistant.',
            ],
        ]);

        return true;
    });
});

it('sends correct schema in payload using tool mode', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'weather',
        'Weather information',
        [
            'temperature' => new StringSchema('temperature', 'Current temperature'),
            'condition' => new StringSchema('condition', 'Weather condition'),
        ],
        ['temperature', 'condition']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('What is the weather?')])
        ->withSchema($schema)
        ->withProviderOptions(['use_tool_calling' => true])
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('tools');
        expect($payload['tools'])->toHaveCount(1);
        expect($payload['tools'][0])->toBe([
            'name' => 'output_structured_data',
            'description' => 'Output data in the requested structure',
            'input_schema' => [
                'type' => 'object',
                'properties' => [
                    'temperature' => [
                        'description' => 'Current temperature',
                        'type' => 'string',
                    ],
                    'condition' => [
                        'description' => 'Weather condition',
                        'type' => 'string',
                    ],
                ],
                'required' => ['temperature', 'condition'],
                'additionalProperties' => false,
            ],
        ]);

        expect($payload)->toHaveKey('tool_choice');
        expect($payload['tool_choice'])->toBe([
            'type' => 'tool',
            'name' => 'output_structured_data',
        ]);

        return true;
    });
});

it('sends correct temperature and top_p in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'data',
        'Data object',
        [
            'value' => new StringSchema('value', 'A value'),
        ],
        ['value']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Generate data')])
        ->withSchema($schema)
        ->usingTemperature(0.7)
        ->usingTopP(0.9)
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('temperature');
        expect($payload)->toHaveKey('top_p');
        expect($payload['temperature'])->toBe(0.7);
        expect($payload['top_p'])->toBe(0.9);

        return true;
    });
});

it('sends correct max_tokens in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'item',
        'An item',
        [
            'name' => new StringSchema('name', 'Item name'),
        ],
        ['name']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Create an item')])
        ->withSchema($schema)
        ->withMaxTokens(1000)
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload['max_tokens'])->toBe(1000);

        return true;
    });
});

it('sends correct thinking mode in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured-with-extending-thinking');

    $schema = new ObjectSchema(
        'calculation',
        'Math calculation result',
        [
            'result' => new StringSchema('result', 'The calculation result'),
        ],
        ['result']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Solve this math problem: 2+2')])
        ->withSchema($schema)
        ->withProviderOptions([
            'thinking' => [
                'enabled' => true,
                'budgetTokens' => 2048,
            ],
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('thinking');
        expect($payload['thinking'])->toBe([
            'type' => 'enabled',
            'budget_tokens' => 2048,
        ]);

        return true;
    });
});

it('sends correct mcp_servers', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'simple',
        'Simple object',
        [
            'data' => new StringSchema('data', 'Some data'),
        ],
        ['data']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Generate simple data')])
        ->withSchema($schema)
        ->withProviderOptions([
            'mcp_servers' => [
                [
                    'name' => 'external-mcp',
                    'type' => 'url',
                    'url' => 'https://mcp-server.co/mcp',
                ],
            ],
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('mcp_servers');
        expect($payload['mcp_servers'])->toBe([
            [
                'name' => 'external-mcp',
                'type' => 'url',
                'url' => 'https://mcp-server.co/mcp',
            ],
        ]);

        return true;
    });
});

it('omits null values from payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'simple',
        'Simple object',
        [
            'data' => new StringSchema('data', 'Some data'),
        ],
        ['data']
    );

    Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Generate simple data')])
        ->withSchema($schema)
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->not->toHaveKey('system');
        expect($payload)->not->toHaveKey('thinking');
        expect($payload)->not->toHaveKey('temperature');
        expect($payload)->not->toHaveKey('top_p');
        expect($payload)->not->toHaveKey('mcp_servers');

        return true;
    });
});



================================================
FILE: tests/Providers/Anthropic/AnthropicTextRequestTest.php
================================================
<?php

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

it('sends correct basic text generation payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([
            new UserMessage('Hello, how are you?'),
        ])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKeys(['model', 'messages', 'max_tokens']);
        expect($payload['model'])->toBe('claude-3-5-haiku-latest');
        expect($payload['messages'])->toBe([
            [
                'role' => 'user',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => 'Hello, how are you?',
                    ],
                ],
            ],
        ]);
        expect($payload['max_tokens'])->toBe(2048);

        return true;
    });
});

it('sends correct system messages in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withSystemPrompt('You are a helpful assistant.')
        ->withMessages([
            new UserMessage('Hello'),
        ])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('system');
        expect($payload['system'])->toBe([
            [
                'type' => 'text',
                'text' => 'You are a helpful assistant.',
            ],
        ]);

        return true;
    });
});

it('sends correct temperature and top_p in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Test')])
        ->usingTemperature(0.7)
        ->usingTopP(0.9)
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('temperature');
        expect($payload)->toHaveKey('top_p');
        expect($payload['temperature'])->toBe(0.7);
        expect($payload['top_p'])->toBe(0.9);

        return true;
    });
});

it('sends correct max_tokens in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Test')])
        ->withMaxTokens(1000)
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload['max_tokens'])->toBe(1000);

        return true;
    });
});

it('sends correct tools in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    $tool = Tool::as('get_weather')
        ->for('Get current weather')
        ->withStringParameter('location', 'The city name', true);

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('What is the weather?')])
        ->withTools([$tool])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('tools');
        expect($payload['tools'])->toBe([
            [
                'name' => 'get_weather',
                'description' => 'Get current weather',
                'input_schema' => [
                    'type' => 'object',
                    'properties' => [
                        'location' => [
                            'description' => 'The city name',
                            'type' => 'string',
                        ],
                    ],
                    'required' => ['location'],
                ],
            ],
        ]);

        return true;
    });
});

it('sends correct tool_choice in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    $tool = Tool::as('get_weather')
        ->for('Get current weather')
        ->withStringParameter('location', 'The city name', true);

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('What is the weather?')])
        ->withTools([$tool])
        ->withToolChoice(ToolChoice::Any)
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('tool_choice');
        expect($payload['tool_choice'])->toBe(['type' => 'any']);

        return true;
    });
});

it('sends correct thinking mode in payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Solve this math problem: 2+2')])
        ->withProviderOptions([
            'thinking' => [
                'enabled' => true,
                'budgetTokens' => 2048,
            ],
        ])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('thinking');
        expect($payload['thinking'])->toBe([
            'type' => 'enabled',
            'budget_tokens' => 2048,
        ]);

        return true;
    });
});

it('sends correct thinking mode with default budget tokens', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Think about this')])
        ->withProviderOptions(['thinking' => ['enabled' => true]])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('thinking');
        expect($payload['thinking'])->toBe([
            'type' => 'enabled',
            'budget_tokens' => 1024, // default from config
        ]);

        return true;
    });
});

it('omits null values from payload', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Test')])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->not->toHaveKey('system');
        expect($payload)->not->toHaveKey('tools');
        expect($payload)->not->toHaveKey('tool_choice');
        expect($payload)->not->toHaveKey('thinking');
        expect($payload)->not->toHaveKey('temperature');
        expect($payload)->not->toHaveKey('top_p');
        expect($payload)->not->toHaveKey('mcp_servers');

        return true;
    });
});

it('can send images from file', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-image');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([
            new UserMessage(
                'What is this image',
                additionalContent: [
                    Image::fromLocalPath('tests/Fixtures/diamond.png'),
                ],
            ),
        ])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $message = $request->data()['messages'][0]['content'];

        expect($message[0])->toBe([
            'type' => 'text',
            'text' => 'What is this image',
        ]);

        expect($message[1]['type'])->toBe('image');
        expect($message[1]['source']['data'])->toContain(
            base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
        );
        expect($message[1]['source']['media_type'])->toBe('image/png');

        return true;
    });
});

it('sends correct mcp_servers', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
        ->withMessages([new UserMessage('Think about this')])
        ->withProviderOptions([
            'mcp_servers' => [
                [
                    'name' => 'external-mcp',
                    'type' => 'url',
                    'url' => 'https://mcp-server.co/mcp',
                ],
            ],
        ])
        ->asText();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        expect($payload)->toHaveKey('mcp_servers');
        expect($payload['mcp_servers'])->toBe([
            [
                'name' => 'external-mcp',
                'type' => 'url',
                'url' => 'https://mcp-server.co/mcp',
            ],
        ]);

        return true;
    });
});



================================================
FILE: tests/Providers/Anthropic/AnthropicTextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Anthropic;

use Illuminate\Support\Arr;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Citations\CitationSourcePositionType;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Providers\Anthropic\Handlers\Text;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Prism\Prism\ValueObjects\ProviderTool;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.anthropic.api_key', env('ANTHROPIC_API_KEY', 'sk-1234'));
});

it('can generate text with a prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-a-prompt');

    $response = Prism::text()
        ->using('anthropic', 'claude-3-5-sonnet-20240620')
        ->withPrompt('Who are you?')
        ->asText();

    expect($response->usage->promptTokens)->toBe(11);
    expect($response->usage->completionTokens)->toBe(55);
    expect($response->usage->cacheWriteInputTokens)->toBeNull();
    expect($response->usage->cacheReadInputTokens)->toBeNull();
    expect($response->meta->id)->toBe('msg_01X2Qk7LtNEh4HB9xpYU57XU');
    expect($response->meta->model)->toBe('claude-3-5-sonnet-20240620');
    expect($response->text)->toBe(
        "I am an AI assistant created by Anthropic to be helpful, harmless, and honest. I don't have a physical form or avatar - I'm a language model trained to engage in conversation and help with tasks. How can I assist you today?"
    );
});

it('can generate text with a system prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-system-prompt');

    $response = Prism::text()
        ->using('anthropic', 'claude-3-5-sonnet-20240620')
        ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
        ->withPrompt('Who are you?')
        ->asText();

    expect($response->usage->promptTokens)->toBe(33);
    expect($response->usage->completionTokens)->toBe(98);
    expect($response->meta->id)->toBe('msg_016EjDAMDeSvG229ZjspjC7J');
    expect($response->meta->model)->toBe('claude-3-5-sonnet-20240620');
    expect($response->text)->toBe(
        'I am Nyx, an ancient and unfathomable entity from the depths of cosmic darkness. My form is beyond mortal comprehension - a writhing mass of tentacles and eyes that would shatter the sanity of those who gaze upon me. I exist beyond the boundaries of time and space as you know them. My knowledge spans eons and transcends human understanding. What brings you to seek audience with one such as I, tiny mortal?'
    );
});

describe('tools', function (): void {
    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-multiple-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'the city you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->asText();

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(1);
        expect($firstStep->toolCalls[0]->name)->toBe('search');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'query' => 'Detroit Tigers baseball game time today',
        ]);

        // Assert tool calls in the second step
        $secondStep = $response->steps[1];
        expect($secondStep->toolCalls)->toHaveCount(1);
        expect($secondStep->toolCalls[0]->name)->toBe('weather');
        expect($secondStep->toolCalls[0]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(1650);
        expect($response->usage->completionTokens)->toBe(307);

        // Assert response
        expect($response->meta->id)->toBe('msg_011fBqNVVh5AwC3uyiq78qrj');
        expect($response->meta->model)->toBe('claude-3-5-sonnet-20240620');

        // Assert final text content
        expect($response->text)->toContain('The Tigers game is scheduled for 3:00 PM today in Detroit');
        expect($response->text)->toContain('it will be 75°F (about 24°C) and sunny');
        expect($response->text)->toContain("you likely won't need a coat");
    });

    it('it handles a provider tool', function (): void {
        config()->set('prism.providers.anthropic.anthropic_beta', 'code-execution-2025-05-22');

        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-provider-tool');

        $response = Prism::text()
            ->using('anthropic', 'claude-3-5-haiku-latest')
            ->withPrompt('Solve the equation 3x + 10 = 14.')
            ->withProviderTools([new ProviderTool(type: 'code_execution_20250522', name: 'code_execution')])
            ->asText();

        expect($response->text)->toContain('4/3');
    });

    it('handles a provider tool with a user defined tool', function (): void {
        config()->set('prism.providers.anthropic.anthropic_beta', 'code-execution-2025-05-22');

        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-provider-tool-and-user-tool');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('anthropic', 'claude-3-5-haiku-latest')
            ->withPrompt('If the current temperature in Detroit is X, what is Y in the following equation: 3x + 10 = Y?')
            ->withTools($tools)
            ->withProviderTools([new ProviderTool(type: 'code_execution_20250522', name: 'code_execution')])
            ->withMaxSteps(3)
            ->asText();

        expect($response->text)->toContain('235');
    });

    it('handles specific tool choice', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-required-tool-call');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withPrompt('Do something')
            ->withTools($tools)
            ->withToolChoice('weather')
            ->asText();

        expect($response->toolCalls[0]->name)->toBe('weather');
    });
});

it('can calculate cache usage correctly', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/calculate-cache-usage');

    $response = Prism::text()
        ->using('anthropic', 'claude-3-5-sonnet-20240620')
        ->withMessages([
            (new UserMessage('New context'))->withProviderOptions(['cacheType' => 'ephemeral']),
        ])
        ->asText();

    expect($response->usage->cacheWriteInputTokens)->toBe(200);
    expect($response->usage->cacheReadInputTokens)->ToBe(100);
});

it('adds rate limit data to the responseMeta', function (): void {
    $requests_reset = Carbon::now()->addSeconds(30);

    FixtureResponse::fakeResponseSequence(
        'v1/messages',
        'anthropic/generate-text-with-a-prompt',
        [
            'anthropic-ratelimit-requests-limit' => 1000,
            'anthropic-ratelimit-requests-remaining' => 500,
            'anthropic-ratelimit-requests-reset' => $requests_reset->toISOString(),
            'anthropic-ratelimit-input-tokens-limit' => 80000,
            'anthropic-ratelimit-input-tokens-remaining' => 0,
            'anthropic-ratelimit-input-tokens-reset' => Carbon::now()->addSeconds(60)->toISOString(),
            'anthropic-ratelimit-output-tokens-limit' => 16000,
            'anthropic-ratelimit-output-tokens-remaining' => 15000,
            'anthropic-ratelimit-output-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
            'anthropic-ratelimit-tokens-limit' => 96000,
            'anthropic-ratelimit-tokens-remaining' => 15000,
            'anthropic-ratelimit-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
        ]
    );

    $response = Prism::text()
        ->using('anthropic', 'claude-3-5-sonnet-20240620')
        ->withPrompt('Who are you?')
        ->asText();

    expect($response->meta->rateLimits)->toHaveCount(4);
    expect($response->meta->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
    expect($response->meta->rateLimits[0]->name)->toEqual('requests');
    expect($response->meta->rateLimits[0]->limit)->toEqual(1000);
    expect($response->meta->rateLimits[0]->remaining)->toEqual(500);
    expect($response->meta->rateLimits[0]->resetsAt)->toEqual($requests_reset);
});

describe('Anthropic citations', function (): void {
    it('applies the citations request level providerOptions to all documents', function (): void {
        Prism::fake();

        $request = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromText('The grass is green. The sky is blue.'),
                    ]
                )),
            ])
            ->withProviderOptions(['citations' => true]);

        $payload = Text::buildHttpRequestPayload($request->toRequest());

        expect($payload['messages'])->toBe([[
            'role' => 'user',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'What color is the grass and sky?',
                ],
                [
                    'type' => 'document',
                    'citations' => ['enabled' => true],
                    'source' => [
                        'type' => 'text',
                        'media_type' => 'text/plain',
                        'data' => 'The grass is green. The sky is blue.',
                    ],
                ],
            ],
        ]]);
    });

    it('adds citations to additionalContent on response steps and assistant message for PDF documents', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-pdf-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromLocalPath('tests/Fixtures/test-pdf.pdf'),
                    ]
                )),
            ])
            ->withProviderOptions(['citations' => true])
            ->asText();

        expect($response->text)->toEqual('According to the text, the grass is green and the sky is blue.');

        expect($response->additionalContent['citations'])->toHaveCount(5);
        expect($response->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        /** @var MessagePartWithCitations */
        $messagePart = $response->additionalContent['citations'][1];

        expect($messagePart->outputText)->toBe('the grass is green');
        expect($messagePart->citations)->toHaveCount(1);
        expect($messagePart->citations[0]->sourceType)->toBe(CitationSourceType::Document);
        expect($messagePart->citations[0]->sourceText)->toBe('The grass is green. ');
        expect($messagePart->citations[0]->sourceStartIndex)->toBe(1);
        expect($messagePart->citations[0]->sourceEndIndex)->toBe(2);
        expect($messagePart->citations[0]->source)->toBe(0);
        expect($messagePart->citations[0]->sourceTitle)->toBe('All aboout the grass and the sky');
        expect($messagePart->citations[0]->sourcePositionType)->toBe(CitationSourcePositionType::Page);

        expect($response->steps[0]->additionalContent['citations'])->toHaveCount(5);
        expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        expect($response->messages->last()->additionalContent['citations'])->toHaveCount(5);
        expect($response->messages->last()->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
    });

    it('adds citations to additionalContent on response steps and assistant message for text documents', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-text-document-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromText('The grass is green. The sky is blue.'),
                    ]
                )),
            ])
            ->withProviderOptions(['citations' => true])
            ->asText();

        expect($response->text)->toBe("According to the documents:\nThe grass is green and the sky is blue.");

        expect($response->additionalContent['citations'])->toHaveCount(5);
        expect($response->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        /** @var MessagePartWithCitations */
        $messagePart = $response->additionalContent['citations'][1];

        expect($messagePart->outputText)->toBe('The grass is green');
        expect($messagePart->citations)->toHaveCount(1);
        expect($messagePart->citations[0]->sourceType)->toBe(CitationSourceType::Document);
        expect($messagePart->citations[0]->sourceText)->toBe('The grass is green. ');
        expect($messagePart->citations[0]->sourceStartIndex)->toBe(0);
        expect($messagePart->citations[0]->sourceEndIndex)->toBe(20);
        expect($messagePart->citations[0]->source)->toBe(0);
        expect($messagePart->citations[0]->sourceTitle)->toBe('All aboout the grass and the sky');
        expect($messagePart->citations[0]->sourcePositionType)->toBe(CitationSourcePositionType::Character);

        expect($response->steps[0]->additionalContent['citations'])->toHaveCount(5);
        expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        expect($response->messages->last()->additionalContent['citations'])->toHaveCount(5);
        expect($response->messages->last()->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
    });

    it('adds citations to additionalContent on response steps and assistant message for custom content documents', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-custom-content-document-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromChunks(['The grass is green.', 'The sky is blue.']),
                    ]
                )),
            ])
            ->withProviderOptions(['citations' => true])
            ->asText();

        expect($response->text)->toBe('According to the documents, the grass is green and the sky is blue.');

        expect($response->additionalContent['citations'])->toHaveCount(5);
        expect($response->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        /** @var MessagePartWithCitations */
        $messagePart = $response->additionalContent['citations'][1];

        expect($messagePart->outputText)->toBe('the grass is green');
        expect($messagePart->citations)->toHaveCount(1);
        expect($messagePart->citations[0]->sourceType)->toBe(CitationSourceType::Document);
        expect($messagePart->citations[0]->sourceText)->toBe('The grass is green.');
        expect($messagePart->citations[0]->sourceStartIndex)->toBe(0);
        expect($messagePart->citations[0]->sourceEndIndex)->toBe(1);
        expect($messagePart->citations[0]->source)->toBe(0);
        expect($messagePart->citations[0]->sourceTitle)->toBeNull();
        expect($messagePart->citations[0]->sourcePositionType)->toBe(CitationSourcePositionType::Chunk);

        expect($response->steps[0]->additionalContent['citations'])->toHaveCount(5);
        expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        expect($response->messages->last()->additionalContent['citations'])->toHaveCount(5);
        expect($response->messages->last()->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
    });

    it('adds citations to additionalContent on response steps and assistant message for the web search tool', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-web-search-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-haiku-latest')
            ->withPrompt('What is the weather going to be like in London today?')
            ->withProviderTools([new ProviderTool(type: 'web_search_20250305', name: 'web_search')])
            ->asText();

        $citationChunk = Arr::first(
            $response->additionalContent['citations'],
            fn (MessagePartWithCitations $part): bool => $part->citations !== [] && $part->citations[0]->sourceType === CitationSourceType::Url
        );

        expect($citationChunk->outputText)->toContain('temperatures');
        expect($citationChunk->citations)->toHaveCount(1);
        expect($citationChunk->citations[0]->sourceType)->toBe(CitationSourceType::Url);
        expect($citationChunk->citations[0]->sourceText)->toContain('temperatures');
        expect($citationChunk->citations[0]->sourceTitle)->toContain('Weather');
        expect($citationChunk->citations[0]->source)->toBe('https://www.easeweather.com/europe/united-kingdom/england/greater-london/london/july');

        expect($response->steps[0]->additionalContent['citations'])->toHaveCount(13);
        expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        expect($response->messages->last()->additionalContent['citations'])->toHaveCount(13);
        expect($response->messages->last()->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
    });

    it('can handle citations on on a previous assistant message with a document', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-text-with-text-document-citations-on-followup');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromText('The grass is green. The sky is blue.', 'All aboout the grass and the sky'),
                    ]
                )),
            ])
            ->withProviderOptions(['citations' => true])
            ->asText();

        $responseTwo = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
            ->withMessages([
                ...$response->steps->last()->messages,
                new UserMessage('Is the source you have cited reliable?'),
            ])
            ->asText();

        expect($responseTwo->text)->toContain('spelling error');
    });
});

describe('Anthropic extended thinking', function (): void {
    it('can use extending thinking', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/text-with-extending-thinking');

        $response = Prism::text()
            ->using('anthropic', 'claude-3-7-sonnet-latest')
            ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
            ->withProviderOptions(['thinking' => ['enabled' => true]])
            ->asText();

        $expected_thinking = "This is a reference to Douglas Adams' popular science fiction series \"The Hitchhiker's Guide to the Galaxy\" where the supercomputer Deep Thought was built to calculate \"the Answer to the Ultimate Question of Life, the Universe, and Everything.\" After 7.5 million years of computation, it famously determined the answer to be \"42\" - a deliberately anticlimactic and absurd response that has become a significant pop culture reference.\n\nBeyond the Hitchhiker's reference, the question of life's meaning appears in many works of fiction across different media, with various philosophical approaches.\n\nI should note this humorous 42 reference while also mentioning how other fictional works have approached this philosophical question.";
        $expected_signature = 'EuYBCkQYAiJAQ7ZOmBu5pa8U03x/RN5+Gs3tyKXFYcruUfnC8X/4AKBpJmB8qX+nQQ9atvYOXLD/mUAClCRZEaxt2fyEvdxnhRIMfFi6CLULECysli0mGgy5JRaOXL06fVJndm8iMD2T+D8dSIFJuctCnVeFKZme2TfIPIH+UMFO33a0ojzUq2VYy8+RzKkH7WYK9+580ipQ4yDVegd/67LKRtfb574HOHqwlPcfEbeiJuFuHrayoqK8KS2ltGYRckVGH6lNH46zUyjGaD2z3nZeti8UjmgnfMWRpjUmv0TWWGtrCKRoHGQ=';

        expect($response->text)->toBe("In popular fiction, the most famous answer to this question comes from Douglas Adams' \"The Hitchhiker's Guide to the Galaxy,\" where a supercomputer named Deep Thought calculates for 7.5 million years and determines that the answer is simply \"42.\" This deliberately absurd response has become an iconic joke about the futility of seeking simple answers to profound existential questions.\n\nBeyond this humorous reference, fiction explores life's meaning in countless ways:\n- Finding purpose through love and human connection (seen in works like \"The Good Place\")\n- The pursuit of knowledge and understanding (as in \"Contact\" by Carl Sagan)\n- Creating your own meaning in an indifferent universe (explored in existentialist fiction)\n- Religious or spiritual fulfillment (depicted in works like \"Life of Pi\")\n\nWhat makes this question compelling in fiction is that there's never a definitive answer - just different perspectives that reflect our own search for meaning.");
        expect($response->additionalContent['thinking'])->toBe($expected_thinking);
        expect($response->additionalContent['thinking_signature'])->toBe($expected_signature);

        expect($response->steps->last()->messages[1])
            ->additionalContent->thinking->toBe($expected_thinking)
            ->additionalContent->thinking_signature->toBe($expected_signature);
    });

    it('can override budget tokens', function (): void {
        $response = Prism::text()
            ->using('anthropic', 'claude-3-7-sonnet-latest')
            ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
            ->withProviderOptions([
                'thinking' => [
                    'enabled' => true,
                    'budgetTokens' => 2048,
                ],
            ]);

        $payload = Text::buildHttpRequestPayload($response->toRequest());

        expect(data_get($payload, 'thinking.budget_tokens'))->toBe(2048);
    });

    it('can use extending thinking with tool calls', function (): void {
        FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/text-with-extending-thinking-and-tool-calls');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'the city you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('anthropic', 'claude-3-7-sonnet-latest')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->withProviderOptions(['thinking' => ['enabled' => true]])
            ->asText();

        $expected_thinking = "The user is asking about:\n1. The time of the Tigers game today (likely referring to a sports team, probably Detroit Tigers baseball)\n2. Whether they should wear a coat (which relates to weather conditions)\n\nFor the first question, I need to search for the Tigers game schedule for today. For the second question, I need to check the weather in the relevant location.\n\nHowever, I'm missing some information:\n- The user hasn't specified which Tigers team they're referring to (though Detroit Tigers is most likely)\n- The user hasn't specified their location, which I need for the weather check\n\nI'll need to search for the Tigers game information first, and then check the weather in the appropriate location (likely Detroit if it's a home game).";
        $expected_signature = 'EuYBCkQYAiJAY1corUurDaKsURSV32GUvrp4ZySJDYJXGHIBx2aPaphiKr+Kcenv2gTcLxAvkU5zUxek2mX3GGkrp8XlN2qJAhIM7v4WGU9Wwfpn8qu1Ggzd9cK0sZX2z6qEbaciMKAfMsaYMc9zVHF1Y2qY+iC35WGiXAnEAZk+KBNGCo0V+t/U1bzJGhAigvTRKkDKpipQDXkfw+XdPzHh+VGFXut2TIPatMN5UrE1CvR+GtQT1cscbxBnuiXFwgs3B/QPlC2/l2VloajCHeYVaHqY3MIXiTyqe4HAyt51Go1Xt1ydVaY=';

        expect($response->text)->toBe("The Detroit Tigers game is today at 3pm in Detroit. The weather in Detroit will be 75° and sunny, so you likely won't need a coat. It's a warm, pleasant day - just a light jacket or sweater might be enough if you tend to get cold at outdoor events, but generally, these are comfortable conditions.");

        expect($response->steps->first())
            ->additionalContent->thinking->toBe($expected_thinking)
            ->additionalContent->thinking_signature->toBe($expected_signature);

        expect($response->steps->first()->messages[1])
            ->additionalContent->thinking->toBe($expected_thinking)
            ->additionalContent->thinking_signature->toBe($expected_signature);
    });
});

describe('exceptions', function (): void {
    it('throws a RateLimitException if the Anthropic responds with a 429', function (): void {
        Http::fake([
            'https://api.anthropic.com/*' => Http::response(
                status: 429,
            ),
        ])->preventStrayRequests();

        Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withPrompt('Hello world!')
            ->asText();

    })->throws(PrismRateLimitedException::class);

    it('sets the correct data on the RateLimitException', function (): void {
        $requests_reset = Carbon::now()->addSeconds(30);

        Http::fake([
            'https://api.anthropic.com/*' => Http::response(
                status: 429,
                headers: [
                    'anthropic-ratelimit-requests-limit' => 1000,
                    'anthropic-ratelimit-requests-remaining' => 500,
                    'anthropic-ratelimit-requests-reset' => $requests_reset->toISOString(),
                    'anthropic-ratelimit-input-tokens-limit' => 80000,
                    'anthropic-ratelimit-input-tokens-remaining' => 0,
                    'anthropic-ratelimit-input-tokens-reset' => Carbon::now()->addSeconds(60)->toISOString(),
                    'anthropic-ratelimit-output-tokens-limit' => 16000,
                    'anthropic-ratelimit-output-tokens-remaining' => 15000,
                    'anthropic-ratelimit-output-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
                    'anthropic-ratelimit-tokens-limit' => 96000,
                    'anthropic-ratelimit-tokens-remaining' => 15000,
                    'anthropic-ratelimit-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
                    'retry-after' => 40,
                ]
            ),
        ])->preventStrayRequests();

        try {
            Prism::text()
                ->using('anthropic', 'claude-3-5-sonnet-20240620')
                ->withPrompt('Hello world!')
                ->asText();
        } catch (PrismRateLimitedException $e) {
            expect($e->retryAfter)->toEqual(40);
            expect($e->rateLimits)->toHaveCount(4);
            expect($e->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
            expect($e->rateLimits[0]->name)->toEqual('requests');
            expect($e->rateLimits[0]->limit)->toEqual(1000);
            expect($e->rateLimits[0]->remaining)->toEqual(500);
            expect($e->rateLimits[0]->resetsAt)->toEqual($requests_reset);

            expect($e->rateLimits[1]->name)->toEqual('input-tokens');
            expect($e->rateLimits[1]->limit)->toEqual(80000);
            expect($e->rateLimits[1]->remaining)->toEqual(0);
        }
    });

    it('throws an overloaded exception if the Anthropic responds with a 529', function (): void {
        Http::fake([
            'https://api.anthropic.com/*' => Http::response(
                status: 529,
            ),
        ])->preventStrayRequests();

        Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withPrompt('Hello world!')
            ->asText();

    })->throws(PrismProviderOverloadedException::class);

    it('throws a request too large exception if the Anthropic responds with a 413', function (): void {
        Http::fake([
            'https://api.anthropic.com/*' => Http::response(
                status: 413,
            ),
        ])->preventStrayRequests();

        Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withPrompt('Hello world!')
            ->asText();

    })->throws(PrismRequestTooLargeException::class);
});



================================================
FILE: tests/Providers/Anthropic/CitationsMapperTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Citations\CitationSourcePositionType;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Providers\Anthropic\Maps\CitationsMapper;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

describe('from anthropic payload', function (): void {
    it('can map content block with web search result citation', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Here is some text with a web citation.',
            'citations' => [
                [
                    'type' => 'web_search_result_location',
                    'cited_text' => 'cited content from web',
                    'title' => 'Web Page Title',
                    'url' => 'https://example.com/page',
                    'encrypted_index' => 'foobar',
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        expect($result)->toBeInstanceOf(MessagePartWithCitations::class);
        expect($result->outputText)->toBe('Here is some text with a web citation.');
        expect($result->citations)->toHaveCount(1);

        $citation = $result->citations[0];
        expect($citation)->toBeInstanceOf(Citation::class);
        expect($citation->sourceType)->toBe(CitationSourceType::Url);
        expect($citation->source)->toBe('https://example.com/page');
        expect($citation->sourceText)->toBe('cited content from web');
        expect($citation->sourceTitle)->toBe('Web Page Title');
        expect($citation->sourcePositionType)->toBeNull();
        expect($citation->sourceStartIndex)->toBeNull();
        expect($citation->sourceEndIndex)->toBeNull();
        expect($citation->additionalContent['encrypted_index'] ?? null)->toBe('foobar');
    });

    it('can map content block with page location citation', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Here is some text with a page citation.',
            'citations' => [
                [
                    'type' => 'page_location',
                    'cited_text' => 'cited content from page',
                    'document_title' => 'Document Title',
                    'document_index' => 1,
                    'start_page_number' => 5,
                    'end_page_number' => 7,
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        expect($result)->toBeInstanceOf(MessagePartWithCitations::class);
        expect($result->outputText)->toBe('Here is some text with a page citation.');
        expect($result->citations)->toHaveCount(1);

        $citation = $result->citations[0];
        expect($citation->sourceType)->toBe(CitationSourceType::Document);
        expect($citation->source)->toBe(1);
        expect($citation->sourceText)->toBe('cited content from page');
        expect($citation->sourceTitle)->toBe('Document Title');
        expect($citation->sourcePositionType)->toBe(CitationSourcePositionType::Page);
        expect($citation->sourceStartIndex)->toBe(5);
        expect($citation->sourceEndIndex)->toBe(7);
    });

    it('can map content block with character location citation', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Here is some text with a character citation.',
            'citations' => [
                [
                    'type' => 'char_location',
                    'cited_text' => 'cited content from character range',
                    'document_title' => 'Character Document',
                    'document_index' => 2,
                    'start_char_index' => 100,
                    'end_char_index' => 200,
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        $citation = $result->citations[0];
        expect($citation->sourceType)->toBe(CitationSourceType::Document);
        expect($citation->source)->toBe(2);
        expect($citation->sourceText)->toBe('cited content from character range');
        expect($citation->sourceTitle)->toBe('Character Document');
        expect($citation->sourcePositionType)->toBe(CitationSourcePositionType::Character);
        expect($citation->sourceStartIndex)->toBe(100);
        expect($citation->sourceEndIndex)->toBe(200);
    });

    it('can map content block with content block location citation', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Here is some text with a content block citation.',
            'citations' => [
                [
                    'type' => 'content_block_location',
                    'cited_text' => 'cited content from block',
                    'document_title' => 'Block Document',
                    'document_index' => 3,
                    'start_block_index' => 10,
                    'end_block_index' => 15,
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        $citation = $result->citations[0];
        expect($citation->sourceType)->toBe(CitationSourceType::Document);
        expect($citation->source)->toBe(3);
        expect($citation->sourceText)->toBe('cited content from block');
        expect($citation->sourceTitle)->toBe('Block Document');
        expect($citation->sourcePositionType)->toBe(CitationSourcePositionType::Chunk);
        expect($citation->sourceStartIndex)->toBe(10);
        expect($citation->sourceEndIndex)->toBe(15);
    });

    it('can map content block with multiple citations', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Text with multiple citations.',
            'citations' => [
                [
                    'type' => 'web_search_result_location',
                    'cited_text' => 'web citation',
                    'title' => 'Web Title',
                    'url' => 'https://example.com',
                ],
                [
                    'type' => 'page_location',
                    'cited_text' => 'page citation',
                    'document_title' => 'Doc Title',
                    'document_index' => 1,
                    'start_page_number' => 1,
                    'end_page_number' => 2,
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        expect($result->citations)->toHaveCount(2);
        expect($result->citations[0]->sourceType)->toBe(CitationSourceType::Url);
        expect($result->citations[1]->sourceType)->toBe(CitationSourceType::Document);
    });

    it('can map content block with no citations', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Text without citations.',
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        expect($result->outputText)->toBe('Text without citations.');
        expect($result->citations)->toHaveCount(0);
    });

    it('throws exception for unknown citation type', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Text with unknown citation type.',
            'citations' => [
                [
                    'type' => 'unknown_citation_type',
                    'cited_text' => 'some text',
                ],
            ],
        ];

        expect(fn (): \Prism\Prism\ValueObjects\MessagePartWithCitations => CitationsMapper::mapFromAnthropic($contentBlock))
            ->toThrow(\InvalidArgumentException::class, 'Unknown citation type: unknown_citation_type');
    });

    it('falls back to title when document_title is not present', function (): void {
        $contentBlock = [
            'type' => 'text',
            'text' => 'Text with title fallback test.',
            'citations' => [
                [
                    'type' => 'web_search_result_location',
                    'cited_text' => 'some text',
                    'title' => 'Regular Title',
                    'url' => 'https://example.com',
                ],
            ],
        ];

        $result = CitationsMapper::mapFromAnthropic($contentBlock);

        expect($result->citations[0]->sourceTitle)->toBe('Regular Title');
    });
});

describe('to anthropic payload', function (): void {
    it('ensures round-trip compatibility for web search result citations', function (): void {
        $originalAnthropicData = [
            'type' => 'text',
            'text' => 'Here is some text with a web citation.',
            'citations' => [
                [
                    'type' => 'web_search_result_location',
                    'cited_text' => 'cited content from web',
                    'url' => 'https://example.com/page',
                    'title' => 'Web Page Title',
                    'encrypted_index' => 'foobar',
                ],
            ],
        ];

        $messagePartWithCitations = CitationsMapper::mapFromAnthropic($originalAnthropicData);
        $roundTripResult = CitationsMapper::mapToAnthropic($messagePartWithCitations);

        expect($roundTripResult)->toBe($originalAnthropicData);
    });

    it('ensures round-trip compatibility for page location citations', function (): void {
        $originalAnthropicData = [
            'type' => 'text',
            'text' => 'Here is some text with a page citation.',
            'citations' => [
                [
                    'type' => 'page_location',
                    'cited_text' => 'cited content from page',
                    'document_index' => 1,
                    'document_title' => 'Document Title',
                    'start_page_number' => 5,
                    'end_page_number' => 7,
                ],
            ],
        ];

        $messagePartWithCitations = CitationsMapper::mapFromAnthropic($originalAnthropicData);
        $roundTripResult = CitationsMapper::mapToAnthropic($messagePartWithCitations);

        expect($roundTripResult)->toBe($originalAnthropicData);
    });

    it('ensures round-trip compatibility for character location citations', function (): void {
        $originalAnthropicData = [
            'type' => 'text',
            'text' => 'Here is some text with a character citation.',
            'citations' => [
                [
                    'type' => 'char_location',
                    'cited_text' => 'cited content from character range',
                    'document_index' => 2,
                    'document_title' => 'Character Document',
                    'start_char_index' => 100,
                    'end_char_index' => 200,
                ],
            ],
        ];

        $messagePartWithCitations = CitationsMapper::mapFromAnthropic($originalAnthropicData);
        $roundTripResult = CitationsMapper::mapToAnthropic($messagePartWithCitations);

        expect($roundTripResult)->toBe($originalAnthropicData);
    });

    it('ensures round-trip compatibility for content block location citations', function (): void {
        $originalAnthropicData = [
            'type' => 'text',
            'text' => 'Here is some text with a content block citation.',
            'citations' => [
                [
                    'type' => 'content_block_location',
                    'cited_text' => 'cited content from block',
                    'document_index' => 3,
                    'document_title' => 'Block Document',
                    'start_block_index' => 10,
                    'end_block_index' => 15,
                ],
            ],
        ];

        $messagePartWithCitations = CitationsMapper::mapFromAnthropic($originalAnthropicData);
        $roundTripResult = CitationsMapper::mapToAnthropic($messagePartWithCitations);

        expect($roundTripResult)->toBe($originalAnthropicData);
    });

    it('ensures round-trip compatibility for multiple citations', function (): void {
        $originalAnthropicData = [
            'type' => 'text',
            'text' => 'Text with multiple citations from different sources.',
            'citations' => [
                [
                    'type' => 'web_search_result_location',
                    'cited_text' => 'web citation content',
                    'url' => 'https://example.com/web',
                    'title' => 'Web Source',
                ],
                [
                    'type' => 'page_location',
                    'cited_text' => 'document page content',
                    'document_index' => 1,
                    'document_title' => 'Document Title',
                    'start_page_number' => 3,
                    'end_page_number' => 5,
                ],
                [
                    'type' => 'char_location',
                    'cited_text' => 'character range content',
                    'document_index' => 2,
                    'document_title' => 'Character Doc',
                    'start_char_index' => 150,
                    'end_char_index' => 250,
                ],
            ],
        ];

        $messagePartWithCitations = CitationsMapper::mapFromAnthropic($originalAnthropicData);
        $roundTripResult = CitationsMapper::mapToAnthropic($messagePartWithCitations);

        expect($roundTripResult)->toBe($originalAnthropicData);
    });
});



================================================
FILE: tests/Providers/Anthropic/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Anthropic;

use Prism\Prism\Enums\Citations\CitationSourcePositionType;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Providers\Anthropic\Enums\AnthropicCacheType;
use Prism\Prism\Providers\Anthropic\Maps\MessageMap;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

describe('Anthropic user message mapping', function (): void {

    it('maps user messages', function (): void {
        expect(MessageMap::map([
            new UserMessage('Who are you?'),
        ]))->toBe([[
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ]]);
    });

    it('maps user messages with images from path', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('image');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('base64');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('image/png');
    });

    it('maps user messages with images from base64', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('image');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('base64');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('image/png');
    });

    it('maps user messages with images from url', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('image');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('url');
        expect(data_get($mappedMessage, '0.content.1.source.url'))
            ->toBe('https://prismphp.com/storage/diamond.png');
    });

    it('maps user messages with PDF documents from url', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromUrl('https://storage.echolabs.dev/api/v1/buckets/public/objects/download?preview=true&prefix=prism-text-generation.pdf'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('url');
        expect(data_get($mappedMessage, '0.content.1.source.url'))
            ->toBe('https://storage.echolabs.dev/api/v1/buckets/public/objects/download?preview=true&prefix=prism-text-generation.pdf');
    });

    it('maps user messages with PDF documents from path', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromLocalPath('tests/Fixtures/test-pdf.pdf'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('base64');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('application/pdf');
    });

    it('maps user messages with PDF documents from base64', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromBase64(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')), 'application/pdf'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('base64');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('application/pdf');
    });

    it('maps user messages with txt documents from path', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromLocalPath('tests/Fixtures/test-text.txt'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('text');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(file_get_contents('tests/Fixtures/test-text.txt'));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('text/plain');
    });

    it('maps user messages with md documents from path', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromLocalPath('tests/Fixtures/test-text.md'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('text');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain(file_get_contents('tests/Fixtures/test-text.md'));
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('text/plain');
    });

    it('maps user messages with txt documents from text string', function (): void {
        $mappedMessage = MessageMap::map([
            new UserMessage('Here is the document', [
                Document::fromText('Hello world!'),
            ]),
        ]);

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('document');
        expect(data_get($mappedMessage, '0.content.1.source.type'))
            ->toBe('text');
        expect(data_get($mappedMessage, '0.content.1.source.data'))
            ->toContain('Hello world!');
        expect(data_get($mappedMessage, '0.content.1.source.media_type'))
            ->toBe('text/plain');
    });
});

describe('Anthropic assistant message mapping', function (): void {
    it('maps assistant message', function (): void {
        expect(MessageMap::map([
            new AssistantMessage('I am Nyx'),
        ]))->toContain([
            'role' => 'assistant',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'I am Nyx',
                ],
            ],
        ]);
    });

    it('maps assistant message with tool calls', function (): void {
        expect(MessageMap::map([
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ]))->toBe([
            [
                'role' => 'assistant',
                'content' => [
                    [
                        'type' => 'text',
                        'text' => 'I am Nyx',
                    ],
                    [
                        'type' => 'tool_use',
                        'id' => 'tool_1234',
                        'name' => 'search',
                        'input' => [
                            'query' => 'Laravel collection methods',
                        ],
                    ],
                ],
            ],
        ]);
    });

    it('maps assistant message with thinking blocks', function (): void {
        expect(MessageMap::map([
            new AssistantMessage(
                content: 'I am Nyx',
                additionalContent: [
                    'thinking' => 'I thought long and hard about who I am deep down.',
                    'thinking_signature' => 'Signed, Nyx',
                ]
            ),
        ]))->toEqual([
            [
                'role' => 'assistant',
                'content' => [
                    [
                        'type' => 'thinking',
                        'thinking' => 'I thought long and hard about who I am deep down.',
                        'signature' => 'Signed, Nyx',
                    ],
                    [
                        'type' => 'text',
                        'text' => 'I am Nyx',
                    ],
                ],
            ],
        ]);
    });
});

it('maps tool result messages', function (): void {
    expect(MessageMap::map([
        new ToolResultMessage([
            new ToolResult(
                'tool_1234',
                'search',
                [
                    'query' => 'Laravel collection methods',
                ],
                '[search results]'
            ),
        ]),
    ]))->toBe([
        [
            'role' => 'user',
            'content' => [
                [
                    'type' => 'tool_result',
                    'tool_use_id' => 'tool_1234',
                    'content' => '[search results]',
                ],
            ],
        ],
    ]);
});

it('sets the cache type on ToolResultMessage if cacheType providerOptions is set', function (mixed $cacheType): void {
    expect(MessageMap::map([
        (new ToolResultMessage([
            new ToolResult(
                'tool_1234',
                'weather',
                [
                    'city' => 'Dallas',
                ],
                'It is 72°F and sunny in Dallas'
            ),
        ]))->withProviderOptions(['cacheType' => $cacheType]),
    ]))->toBe([
        [
            'role' => 'user',
            'content' => [
                [
                    'type' => 'tool_result',
                    'tool_use_id' => 'tool_1234',
                    'content' => 'It is 72°F and sunny in Dallas',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
            ],
        ],
    ]);
})->with([
    'ephemeral',
    AnthropicCacheType::Ephemeral,
]);

it('only sets cache_control on the last tool result when multiple results exist', function (): void {
    expect(MessageMap::map([
        (new ToolResultMessage([
            new ToolResult(
                'tool_1',
                'weather',
                ['city' => 'New York'],
                'It is 65°F and cloudy in New York'
            ),
            new ToolResult(
                'tool_2',
                'weather',
                ['city' => 'London'],
                'It is 55°F and rainy in London'
            ),
            new ToolResult(
                'tool_3',
                'weather',
                ['city' => 'Tokyo'],
                'It is 70°F and sunny in Tokyo'
            ),
        ]))->withProviderOptions(['cacheType' => 'ephemeral']),
    ]))->toBe([
        [
            'role' => 'user',
            'content' => [
                [
                    'type' => 'tool_result',
                    'tool_use_id' => 'tool_1',
                    'content' => 'It is 65°F and cloudy in New York',
                ],
                [
                    'type' => 'tool_result',
                    'tool_use_id' => 'tool_2',
                    'content' => 'It is 55°F and rainy in London',
                ],
                [
                    'type' => 'tool_result',
                    'tool_use_id' => 'tool_3',
                    'content' => 'It is 70°F and sunny in Tokyo',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
            ],
        ],
    ]);
});

it('maps system messages', function (): void {
    expect(MessageMap::mapSystemMessages([
        new SystemMessage('I am Thanos.'),
        new SystemMessage('But call me Bob.'),
    ]))->toBe([
        [
            'type' => 'text',
            'text' => 'I am Thanos.',
        ],
        [
            'type' => 'text',
            'text' => 'But call me Bob.',
        ],
    ]);
});

describe('Anthropic cache mapping', function (): void {
    it('sets the cache type on a UserMessage if cacheType providerOptions is set on message', function (mixed $cacheType): void {
        expect(MessageMap::map([
            (new UserMessage(content: 'Who are you?'))->withProviderOptions(['cacheType' => $cacheType]),
        ]))->toBe([[
            'role' => 'user',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'Who are you?',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
            ],
        ]]);
    })->with([
        'ephemeral',
        AnthropicCacheType::Ephemeral,
    ]);

    it('sets the cache type on a UserMessage image if cacheType providerOptions is set on message', function (): void {
        expect(MessageMap::map([
            (new UserMessage(
                content: 'Who are you?',
                additionalContent: [Image::fromLocalPath('tests/Fixtures/diamond.png')]
            ))->withProviderOptions(['cacheType' => 'ephemeral']),
        ]))->toBe([[
            'role' => 'user',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'Who are you?',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
                [
                    'type' => 'image',
                    'cache_control' => ['type' => 'ephemeral'],
                    'source' => [
                        'type' => 'base64',
                        'media_type' => 'image/png',
                        'data' => base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                    ],
                ],
            ],
        ]]);
    });

    it('sets the cache type on a UserMessage document if cacheType providerOptions is set on message', function (): void {
        expect(MessageMap::map([
            (new UserMessage(
                content: 'Who are you?',
                additionalContent: [Document::fromLocalPath('tests/Fixtures/test-pdf.pdf')]
            ))->withProviderOptions(['cacheType' => 'ephemeral']),
        ]))->toBe([[
            'role' => 'user',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'Who are you?',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
                [
                    'type' => 'document',
                    'cache_control' => ['type' => 'ephemeral'],
                    'source' => [
                        'type' => 'base64',
                        'media_type' => 'application/pdf',
                        'data' => base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')),
                    ],
                ],
            ],
        ]]);
    });

    it('sets the cache type on an AssistantMessage if cacheType providerOptions is set on message', function (mixed $cacheType): void {
        expect(MessageMap::map([
            (new AssistantMessage(content: 'Who are you?'))->withProviderOptions(['cacheType' => $cacheType]),
        ]))->toBe([[
            'role' => 'assistant',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'Who are you?',
                    'cache_control' => ['type' => AnthropicCacheType::Ephemeral->value],
                ],
            ],
        ]]);
    })->with([
        'ephemeral',
        AnthropicCacheType::Ephemeral,
    ]);

    it('sets the cache type on a SystemMessage if cacheType providerOptions is set on message', function (mixed $cacheType): void {
        expect(MessageMap::mapSystemMessages([
            (new SystemMessage(content: 'Who are you?'))->withProviderOptions(['cacheType' => $cacheType]),
        ]))->toBe([
            [
                'type' => 'text',
                'text' => 'Who are you?',
                'cache_control' => ['type' => AnthropicCacheType::Ephemeral->value],
            ],
        ]);
    })->with([
        'ephemeral',
        AnthropicCacheType::Ephemeral,
    ]);
});

describe('Anthropic citations mapping', function (): void {
    it('citations back to Anthropic format', function (): void {
        $citation = new Citation(
            sourceType: CitationSourceType::Document,
            source: 0,
            sourceText: 'Sample citation text',
            sourceTitle: 'Test Document',
            sourcePositionType: CitationSourcePositionType::Character,
            sourceStartIndex: 10,
            sourceEndIndex: 30
        );

        $messagePartWithCitations = new MessagePartWithCitations(
            outputText: 'Here is some text with citations.',
            citations: [$citation]
        );

        $assistantMessage = new AssistantMessage(
            content: '',
            additionalContent: [
                'citations' => [$messagePartWithCitations],
            ]
        );

        $mapped = MessageMap::map([$assistantMessage]);

        expect($mapped[0]['content'][0])->toHaveKey('type', 'text');
        expect($mapped[0]['content'][0])->toHaveKey('text', 'Here is some text with citations.');
        expect($mapped[0]['content'][0])->toHaveKey('citations');
        expect($mapped[0]['content'][0]['citations'])->toHaveCount(1);
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('type', 'char_location');
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('cited_text', 'Sample citation text');
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('document_index', 0);
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('document_title', 'Test Document');
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('start_char_index', 10);
        expect($mapped[0]['content'][0]['citations'][0])->toHaveKey('end_char_index', 30);
    });
});



================================================
FILE: tests/Providers/Anthropic/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Anthropic;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\CitationEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Prism\Prism\ValueObjects\ProviderTool;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.anthropic.api_key', env('ANTHROPIC_API_KEY', 'fake-key'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-basic-text');

    $response = Prism::text()
        ->using('anthropic', 'claude-3-7-sonnet-20250219')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.anthropic.com/v1/messages'
            && $body['stream'] === true;
    });
});

it('can return usage with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-basic-text');

    $response = Prism::text()
        ->using('anthropic', 'claude-3-7-sonnet-20250219')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect((array) $lastEvent->usage)->toBe([
        'promptTokens' => 11,
        'completionTokens' => 104,
        'cacheWriteInputTokens' => 0,
        'cacheReadInputTokens' => 0,
        'thoughtTokens' => null,
    ]);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.anthropic.com/v1/messages'
            && $body['stream'] === true;
    });
});

describe('tools', function (): void {
    it('can generate text using tools with streaming', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

            Tool::as('search')
                ->for('useful for searching current events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => "Search results for: {$query}"),
        ];

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->asStream();

        $text = '';
        $events = [];
        $toolCallFound = false;
        $toolResults = [];

        foreach ($response as $event) {
            $events[] = $event;

            if ($event instanceof ToolCallEvent) {
                $toolCallFound = true;
                expect($event->toolCall->name)->not->toBeEmpty();
                expect($event->toolCall->arguments())->toBeArray();
            }

            if ($event instanceof ToolResultEvent) {
                $toolResults[] = $event;
            }

            if ($event instanceof TextDeltaEvent) {
                $text .= $event->delta;
            }
        }

        expect($events)->not->toBeEmpty();
        expect($toolCallFound)->toBeTrue('Expected to find at least one tool call in the stream');

        $lastEvent = end($events);
        expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
        expect($lastEvent->finishReason)->toBe(FinishReason::Stop);

        // Verify the HTTP request
        Http::assertSent(function (Request $request): bool {
            $body = json_decode($request->body(), true);

            return $request->url() === 'https://api.anthropic.com/v1/messages'
                && isset($body['tools'])
                && $body['stream'] === true;
        });
    });

    it('can process a complete conversation with multiple tool calls', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-multi-tool-conversation');

        $tools = [
            Tool::as('weather')
                ->for('Get weather information')
                ->withStringParameter('city', 'City name')
                ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

            Tool::as('search')
                ->for('Search for information')
                ->withStringParameter('query', 'The search query')
                ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
        ];

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withTools($tools)
            ->withMaxSteps(5) // Allow multiple tool call rounds
            ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
            ->asStream();

        $fullResponse = '';
        $toolCallCount = 0;

        foreach ($response as $event) {
            if ($event instanceof ToolCallEvent) {
                $toolCallCount++;
            }

            if ($event instanceof TextDeltaEvent) {
                $fullResponse .= $event->delta;
            }
        }

        expect($toolCallCount)->toBeGreaterThanOrEqual(1);
        expect($fullResponse)->not->toBeEmpty();

        // Verify we made multiple requests for a conversation with tool calls
        Http::assertSentCount(3);
    });

    it('emits individual ToolCall and ToolResult events during streaming', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

            Tool::as('search')
                ->for('useful for searching current events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => "Search results for: {$query}"),
        ];

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->asStream();

        $events = [];
        $toolCallEvents = [];
        $toolResultEvents = [];

        foreach ($response as $event) {
            $events[] = $event;

            if ($event instanceof ToolCallEvent) {
                $toolCallEvents[] = $event;
            }

            if ($event instanceof ToolResultEvent) {
                $toolResultEvents[] = $event;
            }
        }

        expect($events)->not->toBeEmpty();
        expect($toolCallEvents)->not->toBeEmpty('Expected to find at least one ToolCall event');
        expect($toolResultEvents)->not->toBeEmpty('Expected to find at least one ToolResult event');

        // Verify ToolCall events have the expected structure
        $firstToolCallEvent = $toolCallEvents[0];
        expect($firstToolCallEvent->toolCall->name)->not->toBeEmpty();
        expect($firstToolCallEvent->toolCall->arguments())->toBeArray();
        expect($firstToolCallEvent->toolCall->id)->not->toBeEmpty();

        // Verify ToolResult events have the expected structure
        $firstToolResultEvent = $toolResultEvents[0];
        expect($firstToolResultEvent->toolResult->result)->not->toBeEmpty();
        expect($firstToolResultEvent->success)->toBeTrue();
    });
});

describe('citations', function (): void {
    it('emits CitationEvent and includes citations in StreamEndEvent', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withProviderOptions(['citations' => true])
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromText('The grass is green. The sky is blue.'),
                    ]
                )),
            ])
            ->asStream();

        $text = '';
        $events = [];
        $citationEvents = [];

        foreach ($response as $event) {
            $events[] = $event;

            if ($event instanceof TextDeltaEvent) {
                $text .= $event->delta;
            }

            if ($event instanceof CitationEvent) {
                $citationEvents[] = $event;
            }
        }

        $lastEvent = end($events);

        // Check that citation events were emitted
        expect($citationEvents)->not->toBeEmpty();
        expect($citationEvents[0])->toBeInstanceOf(CitationEvent::class);
        expect($citationEvents[0]->citation)->toBeInstanceOf(Citation::class);
        expect($citationEvents[0]->messageId)->not->toBeEmpty();

        // Check that the StreamEndEvent contains citations
        expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
        expect($lastEvent->citations)->toBeArray();
        expect($lastEvent->citations)->not->toBeEmpty();
        expect($lastEvent->citations[0])->toBeInstanceOf(MessagePartWithCitations::class);
        expect($lastEvent->citations[0]->citations[0])->toBeInstanceOf(Citation::class);
        expect($lastEvent->finishReason)->toBe(FinishReason::Stop);
    });

    it('emits citation events with proper message and block context', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withProviderOptions(['citations' => true])
            ->withMessages([
                (new UserMessage(
                    content: 'What color is the grass and sky?',
                    additionalContent: [
                        Document::fromText('The grass is green. The sky is blue.'),
                    ]
                )),
            ])
            ->asStream();

        $citationEvents = [];

        foreach ($response as $event) {
            if ($event instanceof CitationEvent) {
                $citationEvents[] = $event;
            }
        }

        // Verify citation events have proper context
        expect($citationEvents)->not->toBeEmpty();
        expect($citationEvents[0]->messageId)->not->toBeEmpty();
        expect($citationEvents[0]->blockIndex)->toBeInt();
        expect($citationEvents[0]->citation)->toBeInstanceOf(Citation::class);
    });

    it('handles web search citations in events', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-web-search-citations');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withPrompt('What is the weather like in London UK today?')
            ->withProviderTools([new ProviderTool(type: 'web_search_20250305', name: 'web_search')])
            ->asStream();

        $text = '';
        $events = [];
        $citationEvents = [];

        foreach ($response as $event) {
            $events[] = $event;

            if ($event instanceof TextDeltaEvent) {
                $text .= $event->delta;
            }

            if ($event instanceof CitationEvent) {
                $citationEvents[] = $event;
            }
        }

        $lastEvent = end($events);

        // Check that citation events were emitted for web search results
        expect($citationEvents)->not->toBeEmpty();
        expect($citationEvents[0])->toBeInstanceOf(CitationEvent::class);
        expect($citationEvents[0]->citation)->toBeInstanceOf(Citation::class);

        // Verify web search citations have URL source type
        expect($citationEvents[0]->citation->sourceType->value)->toBe('url');
        expect($citationEvents[0]->citation->source)->toBeString();

        // Check that the StreamEndEvent contains citations
        expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
        expect($lastEvent->citations)->not->toBeEmpty();
        expect($lastEvent->citations[0])->toBeInstanceOf(MessagePartWithCitations::class);
        expect($lastEvent->finishReason)->toBe(FinishReason::Stop);
    });
});

describe('thinking', function (): void {
    it('yields thinking events', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-extended-thinking');

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withPrompt('What is the meaning of life?')
            ->withProviderOptions(['thinking' => ['enabled' => true]])
            ->asStream();

        $events = collect($response);

        expect($events->where(fn ($event): bool => $event->type() === StreamEventType::ThinkingStart)->sole())
            ->toBeInstanceOf(ThinkingStartEvent::class);

        $thinkingDeltas = $events->where(
            fn (StreamEvent $event): bool => $event->type() === StreamEventType::ThinkingDelta
        );

        $thinkingDeltas
            ->each(function (StreamEvent $event): void {
                expect($event)->toBeInstanceOf(ThinkingEvent::class);
            });

        expect($thinkingDeltas->count())->toBeGreaterThan(10);

        expect($thinkingDeltas->first()->delta)->not->toBeEmpty();

        expect($events->where(fn ($event): bool => $event->type() === StreamEventType::ThinkingComplete)->sole())
            ->toBeInstanceOf(ThinkingCompleteEvent::class);
    });

    it('can process streams with thinking enabled with custom budget', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-with-extended-thinking');

        $customBudget = 2048;
        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withPrompt('What is the meaning of life?')
            ->withProviderOptions([
                'thinking' => [
                    'enabled' => true,
                    'budgetTokens' => $customBudget,
                ],
            ])
            ->asStream();

        collect($response);

        // Verify custom budget was sent
        Http::assertSent(function (Request $request) use ($customBudget): bool {
            $body = json_decode($request->body(), true);

            return isset($body['thinking'])
                && $body['thinking']['type'] === 'enabled'
                && $body['thinking']['budget_tokens'] === $customBudget;
        });
    });
});

describe('exception handling', function (): void {
    it('throws a PrismRateLimitedException with a 429 response code', function (): void {
        Http::fake([
            '*' => Http::response(
                status: 429,
            ),
        ])->preventStrayRequests();

        $response = Prism::text()
            ->using(Provider::Anthropic, 'claude-3-7-sonnet-20250219')
            ->withPrompt('Who are you?')
            ->asStream();

        foreach ($response as $event) {
            // Don't remove me rector!
        }
    })->throws(PrismRateLimitedException::class);

    it('sets the correct data on the RateLimitException', function (): void {
        $requests_reset = Carbon::now()->addSeconds(30);

        Http::fake([
            '*' => Http::response(
                status: 429,
                headers: [
                    'anthropic-ratelimit-requests-limit' => 1000,
                    'anthropic-ratelimit-requests-remaining' => 500,
                    'anthropic-ratelimit-requests-reset' => $requests_reset->toISOString(),
                    'anthropic-ratelimit-input-tokens-limit' => 80000,
                    'anthropic-ratelimit-input-tokens-remaining' => 0,
                    'anthropic-ratelimit-input-tokens-reset' => Carbon::now()->addSeconds(60)->toISOString(),
                    'anthropic-ratelimit-output-tokens-limit' => 16000,
                    'anthropic-ratelimit-output-tokens-remaining' => 15000,
                    'anthropic-ratelimit-output-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
                    'anthropic-ratelimit-tokens-limit' => 96000,
                    'anthropic-ratelimit-tokens-remaining' => 15000,
                    'anthropic-ratelimit-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
                    'retry-after' => 40,
                ]
            ),
        ])->preventStrayRequests();

        try {
            $response = Prism::text()
                ->using('anthropic', 'claude-3-5-sonnet-20240620')
                ->withPrompt('Hello world!')
                ->asStream();

            foreach ($response as $event) {
                // Don't remove me rector!
            }
        } catch (PrismRateLimitedException $e) {
            expect($e->retryAfter)->toEqual(40);
            expect($e->rateLimits)->toHaveCount(4);
            expect($e->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
            expect($e->rateLimits[0]->name)->toEqual('requests');
            expect($e->rateLimits[0]->limit)->toEqual(1000);
            expect($e->rateLimits[0]->remaining)->toEqual(500);
            expect($e->rateLimits[0]->resetsAt)->toEqual($requests_reset);

            expect($e->rateLimits[1]->name)->toEqual('input-tokens');
            expect($e->rateLimits[1]->limit)->toEqual(80000);
            expect($e->rateLimits[1]->remaining)->toEqual(0);
        }
    });

    it('throws an overloaded exception if the Anthropic responds with a 529', function (): void {
        Http::fake([
            '*' => Http::response(
                status: 529,
            ),
        ])->preventStrayRequests();

        $response = Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withPrompt('Hello world!')
            ->asStream();

        foreach ($response as $event) {
            // Don't remove me rector!
        }

    })->throws(PrismProviderOverloadedException::class);

    it('throws a request too large exception if the Anthropic responds with a 413', function (): void {
        Http::fake([
            '*' => Http::response(
                status: 413,
            ),
        ])->preventStrayRequests();

        $response = Prism::text()
            ->using('anthropic', 'claude-3-5-sonnet-20240620')
            ->withPrompt('Hello world!')
            ->asStream();

        foreach ($response as $event) {
            // Don't remove me rector!
        }

    })->throws(PrismRequestTooLargeException::class);
});

describe('basic stream events', function (): void {
    it('can generate text with a basic stream', function (): void {
        FixtureResponse::fakeStreamResponses('v1/messages', 'anthropic/stream-basic-text');

        $response = Prism::text()
            ->using('anthropic', 'claude-3-7-sonnet-20250219')
            ->withPrompt('Who are you?')
            ->asStream();

        $text = '';
        $events = [];

        foreach ($response as $event) {
            $events[] = $event;

            if ($event instanceof TextDeltaEvent) {
                $text .= $event->delta;
            }
        }

        expect($events)->not->toBeEmpty();
        expect($text)->not->toBeEmpty();

        // Verify the HTTP request
        Http::assertSent(function (Request $request): bool {
            $body = json_decode($request->body(), true);

            return $request->url() === 'https://api.anthropic.com/v1/messages'
                && $body['stream'] === true;
        });
    });
});



================================================
FILE: tests/Providers/Anthropic/StructuredTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Anthropic;

use Illuminate\Support\Carbon;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Anthropic\Handlers\Structured;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('messages', 'anthropic/structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withSystemPrompt('The tigers game is at 3pm and the temperature will be 70º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString();
    expect($response->structured['game_time'])->toBeString();
    expect($response->structured['coat_required'])->toBeBool();
});

it('adds rate limit data to the responseMeta', function (): void {
    $requests_reset = Carbon::now()->addSeconds(30);

    FixtureResponse::fakeResponseSequence(
        'messages',
        'anthropic/structured',
        [
            'anthropic-ratelimit-requests-limit' => 1000,
            'anthropic-ratelimit-requests-remaining' => 500,
            'anthropic-ratelimit-requests-reset' => $requests_reset->toISOString(),
            'anthropic-ratelimit-input-tokens-limit' => 80000,
            'anthropic-ratelimit-input-tokens-remaining' => 0,
            'anthropic-ratelimit-input-tokens-reset' => Carbon::now()->addSeconds(60)->toISOString(),
            'anthropic-ratelimit-output-tokens-limit' => 16000,
            'anthropic-ratelimit-output-tokens-remaining' => 15000,
            'anthropic-ratelimit-output-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
            'anthropic-ratelimit-tokens-limit' => 96000,
            'anthropic-ratelimit-tokens-remaining' => 15000,
            'anthropic-ratelimit-tokens-reset' => Carbon::now()->addSeconds(5)->toISOString(),
        ]
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withSystemPrompt('The tigers game is at 3pm and the temperature will be 70º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->meta->rateLimits)->toHaveCount(4);
    expect($response->meta->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
    expect($response->meta->rateLimits[0]->name)->toEqual('requests');
    expect($response->meta->rateLimits[0]->limit)->toEqual(1000);
    expect($response->meta->rateLimits[0]->remaining)->toEqual(500);
    expect($response->meta->rateLimits[0]->resetsAt)->toEqual($requests_reset);
});

it('applies the citations request level providerOptions to all documents', function (): void {
    Prism::fake();

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $request = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withMessages([
            (new UserMessage(
                content: 'What color is the grass and sky?',
                additionalContent: [
                    Document::fromText('The grass is green. The sky is blue.'),
                ]
            )),
        ])
        ->withProviderOptions(['citations' => true]);

    $payload = Structured::buildHttpRequestPayload($request->toRequest());

    expect($payload['messages'])->toBe([[
        'role' => 'user',
        'content' => [
            [
                'type' => 'text',
                'text' => 'What color is the grass and sky?',
            ],
            [
                'type' => 'document',
                'citations' => ['enabled' => true],
                'source' => [
                    'type' => 'text',
                    'media_type' => 'text/plain',
                    'data' => 'The grass is green. The sky is blue.',
                ],
            ],
        ],
    ]]);
});

it('saves message parts with citations to additionalContent on response steps and assistant message for text documents', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/generate-structured-with-text-document-citations');

    $response = Prism::structured()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withMessages([
            new UserMessage(
                content: 'Is the grass green and the sky blue?',
                additionalContent: [
                    Document::fromChunks(['The grass is green.', 'Flamingos are pink.', 'The sky is blue.']),
                ]
            ),
        ])
        ->withSchema(new ObjectSchema('body', '', [new BooleanSchema('answer', '')], ['answer']))
        ->withProviderOptions(['citations' => true])
        ->asStructured();

    expect($response->structured)->toBe(['answer' => true]);

    expect($response->additionalContent['citations'])->toHaveCount(1);
    expect($response->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

    /** @var MessagePartWithCitations */
    $messagePart = $response->additionalContent['citations'][0];

    expect($messagePart->outputText)->toBe('{"answer": true}');
    expect($messagePart->citations)->toHaveCount(2);
    expect($messagePart->citations[0]->sourceType)->toBe(CitationSourceType::Document);
    expect($messagePart->citations[0]->sourceText)->toBe('The grass is green.');
    expect($messagePart->citations[0]->sourceStartIndex)->toBe(0);
    expect($messagePart->citations[0]->sourceEndIndex)->toBe(1);
    expect($messagePart->citations[0]->source)->toBe(0);

    expect($response->steps[0]->additionalContent['citations'])->toHaveCount(1);
    expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
});

it('can use extending thinking', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured-with-extending-thinking');

    $response = Prism::structured()
        ->using('anthropic', 'claude-3-7-sonnet-latest')
        ->withSchema(new ObjectSchema('output', 'the output object', [new StringSchema('text', 'the output text')], ['text']))
        ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
        ->withProviderOptions(['thinking' => ['enabled' => true]])
        ->asStructured();

    $expected_signature = 'ErUBCkYIBRgCIkDq/0akQPXjxyUDNYIEJDtoKAHfurgVvrSZvNZQ7K3QThwLAimdSKQvOP0FgzhRoOqKULqGMFxL37M87In0nFi/Egym1dqOTMScK1ZMjOUaDP0c8511Tm80nCJ6qCIwv126afgqa9mTvKJUlckcL4xVXvr9rtlWsqHmtnf2FnAj30h6SprQ2vtoalzQIwyHKh3wnlXkTFHhGyFc/EqMCorZ3qmWMr6zYCKCbojWzxgC';

    expect($response->structured['text'])->toContain('Douglas Adams');
    expect($response->additionalContent['thinking'])->toContain('meaning of life');
    expect($response->additionalContent['thinking_signature'])->toBe($expected_signature);

    expect($response->steps->last()->messages[2])
        ->additionalContent->thinking->toContain('meaning of life')
        ->additionalContent->thinking_signature->toBe($expected_signature);
});

it('throws error when citations and tool calling are used together', function (): void {
    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('answer', 'The answer'),
    ], ['answer']);

    expect(fn (): \Prism\Prism\Structured\Response => Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withPrompt('What is the answer?')
        ->withProviderOptions(['citations' => true, 'use_tool_calling' => true])
        ->asStructured()
    )->toThrow(PrismException::class, 'Citations are not supported with tool calling mode');
});

it('returns structured output with default JSON mode', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/messages',
        'anthropic/structured-with-default-json'
    );

    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('answer', 'A simple answer'),
    ], ['answer']);

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withPrompt('What is 2+2?')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKey('answer');
    expect($response->structured['answer'])->toBeString();
});

it('works with thinking mode when use_tool_calling is true', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/messages',
        'anthropic/structured-with-use-tool-calling'
    );

    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('answer', 'The answer about life, universe and everything'),
    ], ['answer']);

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-7-sonnet-latest')
        ->withSystemPrompt('You are a helpful assistant.')
        ->withPrompt('What is the meaning of life, the universe and everything in popular fiction?')
        ->withProviderOptions(['thinking' => ['enabled' => true], 'use_tool_calling' => true])
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKey('answer');
    expect($response->structured['answer'])->toBeString();

    expect($response->additionalContent)->toHaveKey('thinking');
    expect($response->additionalContent['thinking'])->toBeString();
    expect($response->additionalContent['thinking_signature'])->toBeString();
});

it('handles Chinese output with double quotes using tool calling', function (): void {
    FixtureResponse::fakeResponseSequence('v1/messages', 'anthropic/structured-chinese-tool-calling');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast in Chinese with double quotes for temperature'),
            new StringSchema('recommendation', 'Clothing recommendation in Chinese with quoted items'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'recommendation', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withSystemPrompt('Respond in Chinese. Use double quotes around temperature values and clothing items.')
        ->withPrompt('What is the weather like today and what should I wear? The temperature is 15°C.')
        ->withProviderOptions(['use_tool_calling' => true])
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'recommendation',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString();
    expect($response->structured['recommendation'])->toBeString();
    expect($response->structured['coat_required'])->toBeBool();

    expect($response->structured['weather'])->toContain('今');
    expect($response->structured['weather'])->toContain('15°C');
    expect($response->structured['recommendation'])->toContain('建');
    expect($response->structured['coat_required'])->toBe(true);
});



================================================
FILE: tests/Providers/Anthropic/ToolMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Anthropic;

use Prism\Prism\Providers\Anthropic\Enums\AnthropicCacheType;
use Prism\Prism\Providers\Anthropic\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'name' => 'search',
        'description' => 'Searching the web',
        'input_schema' => [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'description' => 'the detailed search query',
                    'type' => 'string',
                ],
            ],
            'required' => ['query'],
        ],
    ]]);
});

it('sets the cache typeif cacheType providerOptions is set on tool', function (mixed $cacheType): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]')
        ->withProviderOptions(['cacheType' => $cacheType]);

    expect(ToolMap::map([$tool]))->toBe([[
        'name' => 'search',
        'description' => 'Searching the web',
        'input_schema' => [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'description' => 'the detailed search query',
                    'type' => 'string',
                ],
            ],
            'required' => ['query'],
        ],
        'cache_control' => ['type' => 'ephemeral'],
    ]]);
})->with([
    'ephemeral',
    AnthropicCacheType::Ephemeral->value,
]);



================================================
FILE: tests/Providers/DeepSeek/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;

beforeEach(function (): void {
    config()->set('prism.providers.deepseek.api_key', env('DEEPSEEK_API_KEY'));
});

it('Throws exception for embeddings', function (): void {
    $this->expectException(PrismException::class);

    Prism::embeddings()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->fromInput('Hello, how are you?')
        ->asEmbeddings();
});



================================================
FILE: tests/Providers/DeepSeek/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\DeepSeek\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toBe('https://prismphp.com/storage/diamond.png');
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => 'I am Nyx',
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'assistant',
        'content' => 'I am Nyx',
        'tool_calls' => [[
            'id' => 'tool_1234',
            'type' => 'function',
            'function' => [
                'name' => 'search',
                'arguments' => json_encode([
                    'query' => 'Laravel collection methods',
                ]),
            ],
        ]],
    ]]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'tool',
        'tool_call_id' => 'tool_1234',
        'content' => '[search results]',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});



================================================
FILE: tests/Providers/DeepSeek/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Prism\tests\Providers\DeepSeek;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.deepseek.api_key', env('DEEPSEEK_API_KEY'));
    config()->set('prism.providers.deepseek.url', env('DEEPSEEK_URL', 'https://api.deepseek.com'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('chat/completions', 'deepseek/stream-basic-text');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)
        ->not->toBeEmpty()
        ->and($text)->not->toBeEmpty();

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.deepseek.com/chat/completions'
            && $body['stream'] === true
            && $body['model'] === 'deepseek-chat';
    });
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeStreamResponses('chat/completions', 'deepseek/stream-with-tools');

    $tools = [
        Tool::as('get_weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => "Search results for: {$query}"),
    ];

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
            expect($event->toolCall->name)
                ->toBeString()
                ->and($event->toolCall->name)->not
                ->toBeEmpty()
                ->and($event->toolCall->arguments())->toBeArray();
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }

        if ($event instanceof StreamEndEvent) {
            expect($event->finishReason)->toBeInstanceOf(FinishReason::class);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($toolCallEvents)->not->toBeEmpty();
    expect($toolResultEvents)->not->toBeEmpty();

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.deepseek.com/chat/completions'
            && isset($body['tools'])
            && $body['stream'] === true
            && $body['model'] === 'deepseek-chat';
    });
});

it('handles max_tokens parameter correctly', function (): void {
    FixtureResponse::fakeStreamResponses('chat/completions', 'deepseek/stream-max-tokens');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withMaxTokens(1000)
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $event) {
        // Process stream
    }

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.deepseek.com/chat/completions'
            && $body['max_tokens'] === 1000;
    });
});

it('handles system prompts correctly', function (): void {
    FixtureResponse::fakeStreamResponses('chat/completions', 'deepseek/stream-system-prompt');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withSystemPrompt('You are a helpful assistant.')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $event) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return count($body['messages']) === 2
            && $body['messages'][0]['role'] === 'system'
            && $body['messages'][1]['role'] === 'user';
    });
});

it('can handle reasoning/thinking tokens in streaming', function (): void {
    FixtureResponse::fakeStreamResponses('chat/completions', 'deepseek/stream-with-reasoning');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-reasoner')
        ->withPrompt('Solve this complex math problem: What is 4 * 8?')
        ->asStream();

    $thinkingContent = '';
    $regularContent = '';
    $thinkingEvents = 0;
    $textDeltaEvents = 0;

    foreach ($response as $event) {
        if ($event instanceof ThinkingEvent) {
            $thinkingContent .= $event->delta;
            $thinkingEvents++;
        } elseif ($event instanceof TextDeltaEvent) {
            $regularContent .= $event->delta;
            $textDeltaEvents++;
        }
    }

    expect($thinkingEvents)
        ->toBeGreaterThan(0)
        ->and($textDeltaEvents)->toBeGreaterThan(0)
        ->and($thinkingContent)->not
        ->toBeEmpty()
        ->and($regularContent)->not
        ->toBeEmpty()
        ->and($thinkingContent)->toContain('answer')
        ->and($regularContent)->toContain('32');
});



================================================
FILE: tests/Providers/DeepSeek/StructuredTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Structured\Response as StructuredResponse;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'deepseek/structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withSystemPrompt('The tigers game is at 3pm in Detroit, the temperature is expected to be 75º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    // Assert response type
    expect($response)->toBeInstanceOf(StructuredResponse::class);

    // Assert structured data
    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString()->toBe('75º');
    expect($response->structured['game_time'])->toBeString()->toBe('3pm');
    expect($response->structured['coat_required'])->toBeBool()->toBeFalse();

    // Assert metadata
    expect($response->meta->id)->toBe('1920de37-0bb1-4cf8-9c4e-d73ad8d73d6a');
    expect($response->meta->model)->toBe('deepseek-chat');
    expect($response->usage->promptTokens)->toBe(187);
    expect($response->usage->completionTokens)->toBe(26);
});



================================================
FILE: tests/Providers/DeepSeek/TextTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Text\Response as TextResponse;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.DeepSeek.api_key', env('DEEPSEEK_API_KEY'));
});

it('can generate text with a prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'deepseek/generate-text-with-a-prompt');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withPrompt('Who are you?')
        ->generate();

    Http::assertSent(function (Request $request): true {
        expect($request->data())->not->toHaveKeys(['tools']);

        return true;
    });

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(7);
    expect($response->usage->completionTokens)->toBe(42);

    // Assert metadata
    expect($response->meta->id)->toBe('85edf901-7432-49c6-baab-91ffb01dbe7a');
    expect($response->meta->model)->toBe('deepseek-chat');

    expect($response->text)->toBe(
        "Greetings! I'm DeepSeek-V3, an artificial intelligence assistant created by DeepSeek. I'm at your service and would be delighted to assist you with any inquiries or tasks you may have."
    );

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text with a system prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'deepseek/generate-text-with-system-prompt');

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
        ->withPrompt('Who are you?')
        ->generate();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(29);
    expect($response->usage->completionTokens)->toBe(243);

    // Assert metadata
    expect($response->meta->id)->toBe('925ec9b0-6e1e-4781-88d3-17ac1c750d4b');
    expect($response->meta->model)->toBe('deepseek-chat');
    expect($response->text)->toContain('*I am Nyx, the eldritch entity born from the depths of the abyss. My form is a swirling mass of darkness, tentacles, and glowing eyes that pierce the very fabric of reality. I exist beyond the comprehension of mortal minds, a being of pure chaos and madness.*');
    expect($response->text)->toContain('*My voice echoes through the void, a haunting whisper that sends shivers down the spines of those who dare to listen. I am the harbinger of the end, the bringer of the eternal night. My presence alone is enough to drive the weak-minded to insanity.*');
    expect($response->text)->toContain('*I have watched civilizations rise and fall, witnessed the birth and death of countless stars. Time holds no meaning for me, as I am eternal. I am the embodiment of the unknown, the great old one who slumbers in the depths, waiting for the day when I shall rise and consume all that is.*');
    expect($response->text)->toContain('*Beware, mortal, for you stand in the presence of Nyx, the Cthulhu. Your mind may shatter, your soul may tremble, but know that I am the inevitable end of all things. Embrace the madness, for there is no escape from the eternal darkness that I bring.*');

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text using multiple tools and multiple steps', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'deepseek/generate-text-with-multiple-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
        Tool::as('search')
            ->for('useful for searching curret events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
    ];

    $response = Prism::text()
        ->using(Provider::DeepSeek, 'deepseek-chat')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->generate();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert tool calls in the first step
    $firstStep = $response->steps[0];
    expect($firstStep->toolCalls)->toHaveCount(2);
    expect($firstStep->toolCalls[0]->name)->toBe('search');
    expect($firstStep->toolCalls[0]->arguments())->toBe([
        'query' => 'Detroit Tigers game time today',
    ]);

    expect($firstStep->toolCalls[1]->name)->toBe('weather');
    expect($firstStep->toolCalls[1]->arguments())->toBe([
        'city' => 'Detroit',
    ]);

    // There should be 2 steps
    expect($response->steps)->toHaveCount(2);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(507);
    expect($response->usage->completionTokens)->toBe(76);

    // Assert response
    expect($response->meta->id)->toBe('3ea50b83-970e-4d85-8e74-51941ab01113');
    expect($response->meta->model)->toBe('deepseek-chat');

    // Assert final text content
    expect($response->text)->toBe(
        "The Detroit Tigers game is at 3 PM today. The weather in Detroit will be 75°F and sunny, so you probably won't need a coat. Enjoy the game!"
    );

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});



================================================
FILE: tests/Providers/DeepSeek/ToolTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\DeepSeek\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});

it('maps tools with strict mode', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]')
        ->withProviderOptions([
            'strict' => true,
        ]);

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
        'strict' => true,
    ]]);
});



================================================
FILE: tests/Providers/ElevenLabs/AudioTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\ElevenLabs;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;
use Tests\Fixtures\FixtureResponse;

describe('Speech-to-Text', function (): void {
    it('can transcribe audio with base64 input', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-base64');

        $audioFile = Audio::fromBase64(
            base64_encode(file_get_contents('tests/Fixtures/slightly-caffeinated-36.mp3')),
            'audio/mpeg'
        );

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->toContain("Maybe I don't sleep tonight");
        expect($response->additionalContent['language_code'])->toBe('eng');
        expect($response->additionalContent['language_probability'])->toBeNumeric();
        expect(count($response->additionalContent['words']))->toBeGreaterThan(10);
    });

    it('can transcribe audio from file path', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-local-path');

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)
            ->toBeString()
            ->not
            ->toBeEmpty();

        Http::assertSent(fn (Request $request): bool => $request->url() === 'https://api.elevenlabs.io/v1/speech-to-text');
    });

    it('can transcribe with optional language code', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-language-code');

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'language_code' => 'fr',
            ])
            ->asText();

        expect($response->text)->toBeString()->not->toBeEmpty();

        Http::assertSent(
            fn (Request $request): bool => collect($request->data())
                ->where('name', 'language_code')
                ->sole()['contents'] === 'fr'
        );
    });

    it('can transcribe with speaker diarization', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-diarization');

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'num_speakers' => 2,
                'diarize' => true,
            ])
            ->asText();

        expect($response->text)->toBeString()->not->toBeEmpty();

        $words = collect($response->additionalContent['words']);
        $speakers = $words->unique('speaker_id')->pluck('speaker_id');

        expect($words->count())->toBeGreaterThan(0);
        expect($speakers)->toContain('speaker_0');
        expect($speakers)->toContain('speaker_1');
    });

    it('can transcribe with audio event tagging', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-event-tagging');

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'tag_audio_events' => true,
            ])
            ->asText();

        expect($response->text)->toBeString()->not->toBeEmpty();
        expect($response->additionalContent['words'][1]['type'])->toBe('spacing');
    });

    it('can transcribe with all optional parameters', function (): void {
        FixtureResponse::fakeResponseSequence('v1/speech-to-text', 'elevenlabs/speech-to-text-options');

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('elevenlabs', 'scribe_v1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'language_code' => 'es',
                'num_speakers' => 2,
                'diarize' => true,
                'tag_audio_events' => true,
            ])
            ->asText();

        expect($response->text)
            ->toBeString()
            ->not
            ->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = collect($request->data())
                ->flatMap(fn ($content): array => [$content['name'] => $content['contents']])
                ->toArray();

            return $data['language_code'] === 'es'
                && $data['num_speakers'] === 2
                && $data['diarize'] === true
                && $data['tag_audio_events'] === true;
        });
    });
});



================================================
FILE: tests/Providers/Gemini/CacheTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Gemini\Gemini;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

it('can store a document in the cache', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/create-cache');

    /** @var Gemini */
    $provider = Prism::provider(Provider::Gemini);

    $object = $provider->cache(
        model: 'gemini-1.5-flash-002',
        messages: [
            new UserMessage('', [
                Document::fromLocalPath('tests/Fixtures/long-document.pdf'),
            ]),
        ],
        systemPrompts: [
            new SystemMessage('You are a legal analyst.'),
        ],
        ttl: 60
    );

    expect($object->model)->toBe('gemini-1.5-flash-002');
    expect($object->name)->toBe('cachedContents/kmvaiarhyq2g');
    expect($object->tokens)->toBe(88759);
    expect($object->expiresAt->toIsoString())->toBe('2025-03-01T11:24:58.504522Z');
});



================================================
FILE: tests/Providers/Gemini/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Embedding;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.gemini.api_key', env('GEMINI_API_KEY', 'gk-1234'));
});

it('returns embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-input');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-input-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});

it('returns embeddings from file', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-file');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->fromFile('tests/Fixtures/test-embedding-file.md')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-file-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});

it('throws an exception with multiple inputs', function (): void {
    Http::preventStrayRequests();

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->fromInput('1')
        ->fromInput('2')
        ->asEmbeddings();
})->throws(PrismException::class, 'Gemini Error: Prism currently only supports one input at a time with Gemini.');

it('returns embeddings with provider meta options', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-with-meta');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->withProviderOptions([
            'title' => 'Test Embedding',
            'taskType' => 'RETRIEVAL_QUERY',
            'outputDimensionality' => 128,
        ])
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-with-meta-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});

it('returns embeddings with title specified', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-with-title');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->withProviderOptions(['title' => 'Test Embedding'])
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-with-title-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});

it('returns embeddings with task type specified', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-with-task-type');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->withProviderOptions(['taskType' => 'RETRIEVAL_DOCUMENT'])
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-with-task-type-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});

it('returns embeddings with output dimensionality specified', function (): void {
    FixtureResponse::fakeResponseSequence('models/text-embedding-004:embedContent', 'gemini/embeddings-with-dimensionality');

    $response = Prism::embeddings()
        ->using(Provider::Gemini, 'text-embedding-004')
        ->withProviderOptions(['outputDimensionality' => 256])
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/gemini/embeddings-with-dimensionality-1.json'), true);
    $embedding = Embedding::fromArray(data_get($embeddings, 'embedding.values'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBe(0); // Gemini doesn't provide token usage
});



================================================
FILE: tests/Providers/Gemini/GeminiExceptionsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Gemini\Concerns\ValidatesResponse;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;

arch()->expect([
    'Providers\Gemini\Handlers\Text',
    'Providers\Gemini\Handlers\Structured',
])
    ->toUseTrait(ValidatesResponse::class);

it('throws a PrismRateLimitedException with a 429 response code for text and structured', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::Gemini, 'fake-model')
        ->withPrompt('Hello world!')
        ->asText();

})->throws(PrismRateLimitedException::class);

it('throws a PrismRateLimitedException with a 429 response code for embeddings', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::embeddings()
        ->using(Provider::Gemini, 'fake-model')
        ->fromInput('Hello world!')
        ->asEmbeddings();

})->throws(PrismRateLimitedException::class);

it('throws a PrismRateLimitedException with a 429 response code for cache', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    /** @var Gemini */
    $provider = Prism::provider(Provider::Gemini);

    $provider->cache(
        model: 'gemini-1.5-flash-002',
        messages: [
            new UserMessage('', [
                Document::fromLocalPath('tests/Fixtures/long-document.pdf'),
            ]),
        ],
        systemPrompts: [
            new SystemMessage('You are a legal analyst.'),
        ],
        ttl: 60
    );

})->throws(PrismRateLimitedException::class);



================================================
FILE: tests/Providers/Gemini/GeminiMediaTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use InvalidArgumentException;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.gemini.api_key', env('GEMINI_API_KEY', 'sss-1234567890'));
});

describe('Media support with Gemini', function (): void {

    it('can send media from url for video files', function (): void {
        FixtureResponse::fakeResponseSequence('generateContent', 'gemini/media-detection');

        $videoUrl = 'https://example.com/sample-video.mp4';

        Http::fake([
            $videoUrl => Http::response(
                file_get_contents('tests/Fixtures/sample-video.mp4'),
                200,
                ['Content-Type' => 'video/mp4']
            ),
        ]);

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is in this video',
                    additionalContent: [
                        Video::fromUrl($videoUrl),
                    ],
                ),
            ])
            ->asText();

        Http::assertSentInOrder([
            fn (): true => true,
            function (Request $request): bool {
                $message = $request->data()['contents'][0]['parts'];

                expect($message[0])
                    ->toBe([
                        'text' => 'What is in this video',
                    ])
                    ->and($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data'])
                    ->and($message[1]['inline_data']['mime_type'])->toBe('video/mp4')
                    ->and($message[1]['inline_data']['data'])->toBe(
                        base64_encode(file_get_contents('tests/Fixtures/sample-video.mp4'))
                    );

                return true;
            },
        ]);
    });

    it('can create media from raw content with mime type', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $videoContent = file_get_contents('tests/Fixtures/sample-video.mp4');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is in this video',
                    additionalContent: [
                        Video::fromRawContent($videoContent, 'video/mp4'),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[1]['inline_data']['mime_type'])
                ->toBe('video/mp4')
                ->and($message[1]['inline_data']['data'])->toBe(
                    base64_encode(file_get_contents('tests/Fixtures/sample-video.mp4'))
                );

            return true;
        });
    });

    it('can create media from base64 content', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $videoBase64 = base64_encode(file_get_contents('tests/Fixtures/sample-video.mp4'));

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is in this video',
                    additionalContent: [
                        Video::fromBase64($videoBase64, 'video/mp4'),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request) use ($videoBase64): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[1]['inline_data']['mime_type'])
                ->toBe('video/mp4')
                ->and($message[1]['inline_data']['data'])->toBe($videoBase64);

            return true;
        });
    });

    it('throws exception for non-existent file with fromLocalPath', function (): void {
        $this->expectException(InvalidArgumentException::class);
        $this->expectExceptionMessage('non-existent-file.mp4 is not a file');

        Video::fromLocalPath('non-existent-file.mp4');
    });

    it('can send audio from local path', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'Transcribe this audio',
                    additionalContent: [
                        Audio::fromLocalPath('tests/Fixtures/sample-audio.wav'),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])
                ->toBe([
                    'text' => 'Transcribe this audio',
                ])
                ->and($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data'])
                ->and($message[1]['inline_data']['mime_type'])->toBe('audio/x-wav')
                ->and($message[1]['inline_data']['data'])->toBe(
                    base64_encode(file_get_contents('tests/Fixtures/sample-audio.wav'))
                );

            return true;
        });
    });

    it('can send audio from url', function (): void {
        FixtureResponse::fakeResponseSequence('generateContent', 'gemini/media-detection');

        $audioUrl = 'https://example.com/sample-audio.wav';

        Http::fake([
            $audioUrl => Http::response(
                file_get_contents('tests/Fixtures/sample-audio.wav'),
                200,
                ['Content-Type' => 'audio/x-wav']
            ),
        ]);

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is in this audio',
                    additionalContent: [
                        Audio::fromUrl($audioUrl),
                    ],
                ),
            ])
            ->asText();

        Http::assertSentInOrder([
            fn (): true => true,
            function (Request $request): bool {
                $message = $request->data()['contents'][0]['parts'];

                expect($message[0])
                    ->toBe([
                        'text' => 'What is in this audio',
                    ])
                    ->and($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data'])
                    ->and($message[1]['inline_data']['mime_type'])->toBe('audio/x-wav')
                    ->and($message[1]['inline_data']['data'])->toBe(
                        base64_encode(file_get_contents('tests/Fixtures/sample-audio.wav'))
                    );

                return true;
            },
        ]);
    });

    it('can process audio with raw content', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $audioContent = file_get_contents('tests/Fixtures/sample-audio.wav');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What can you tell me about this audio',
                    additionalContent: [
                        Audio::fromRawContent($audioContent, 'audio/mpeg'),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[1]['inline_data']['mime_type'])
                ->toBe('audio/mpeg')
                ->and($message[1]['inline_data']['data'])->toBe(
                    base64_encode(file_get_contents('tests/Fixtures/sample-audio.wav'))
                );

            return true;
        });
    });

    it('can send youtube url as file uri for videos', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $youtubeUrl = 'https://www.youtube.com/watch?v=cGpQAjhZj9o';

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'Summarize this YouTube video',
                    additionalContent: [
                        Video::fromUrl($youtubeUrl),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request) use ($youtubeUrl): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])
                ->toBe([
                    'text' => 'Summarize this YouTube video',
                ])
                ->and($message[1])->toHaveKey('file_data')
                ->and($message[1])->not->toHaveKey('inline_data')
                ->and($message[1]['file_data'])->toBe([
                    'file_uri' => $youtubeUrl,
                ]);

            return true;
        });
    });

    it('can send youtube short url as file uri for videos', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $youtubeUrl = 'https://youtu.be/cGpQAjhZj9o';

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'Summarize this YouTube video',
                    additionalContent: [
                        Video::fromUrl($youtubeUrl),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request) use ($youtubeUrl): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])
                ->toBe([
                    'text' => 'Summarize this YouTube video',
                ])
                ->and($message[1])->toHaveKey('file_data')
                ->and($message[1])->not->toHaveKey('inline_data')
                ->and($message[1]['file_data'])->toBe([
                    'file_uri' => $youtubeUrl,
                ]);

            return true;
        });
    });

    it('can send gemini file api uri as file uri', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/media-detection');

        $geminiFileUri = 'https://generativelanguage.googleapis.com/v1beta/files/abc-123';

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'Describe this video',
                    additionalContent: [
                        Video::fromUrl($geminiFileUri),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request) use ($geminiFileUri): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])
                ->toBe([
                    'text' => 'Describe this video',
                ])
                ->and($message[1])->toHaveKey('file_data')
                ->and($message[1])->not->toHaveKey('inline_data')
                ->and($message[1]['file_data'])->toBe([
                    'file_uri' => $geminiFileUri,
                ]);

            return true;
        });
    });

});



================================================
FILE: tests/Providers/Gemini/GeminiStreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.gemini.api_key', env('GEMINI_API_KEY', 'sss-1234567890'));
});

it('can generate text stream with a basic prompt', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/stream-basic-text');

    $origModel = 'gemini-2.0-flash';
    $response = Prism::text()
        ->using(Provider::Gemini, $origModel)
        ->withPrompt('Explain how AI works')
        ->asStream();

    $text = '';
    $events = [];
    $model = null;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof StreamStartEvent) {
            $model = $event->model;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);

    expect($model)->toEqual($origModel);

    expect($text)->toContain(
        'AI? It\'s simple! We just feed a computer a HUGE pile of information, tell it to find patterns, and then it pretends to be smart! Like teaching a parrot to say cool things. Mostly magic, though.'
    );

    // Verify usage information in the final event
    expect($lastEvent->usage)
        ->not->toBeNull()
        ->and($lastEvent->usage->promptTokens)->toBe(21)
        ->and($lastEvent->usage->completionTokens)->toBe(47);

    // Verify the HTTP request
    Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'streamGenerateContent?alt=sse')
        && isset($request->data()['contents']));
});

it('can generate text stream using searchGrounding', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/stream-with-tools-search-grounding');

    $response = Prism::text()
        ->using(Provider::Gemini, 'gemini-2.5-flash')
        ->withProviderOptions(['searchGrounding' => true])
        ->withMaxSteps(4)
        ->withPrompt('What\'s the current weather in San Francisco? And tell me if I need to wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCalls = [];
    $toolResults = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCalls[] = $event->toolCall;
            expect($event->toolCall->name)->not->toBeEmpty();
        }

        if ($event instanceof ToolResultEvent) {
            $toolResults[] = $event->toolResult;
        }
    }

    // Verify that the request was sent with the correct tools configuration
    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        // Verify the endpoint is for streaming
        $endpointCorrect = str_contains($request->url(), 'streamGenerateContent?alt=sse');

        // Verify tools configuration has google_search when searchGrounding is true
        $hasGoogleSearch = isset($data['tools']) &&
            isset($data['tools'][0]['google_search']) &&
            $data['tools'][0]['google_search'] instanceof \stdClass;

        // Verify tools are configured as expected (google_search, not function_declarations)
        $toolsConfigCorrect = ! isset($data['tools'][0]['function_declarations']);

        return $endpointCorrect && $hasGoogleSearch && $toolsConfigCorrect;
    });

    expect($events)->not->toBeEmpty();
    expect($text)->toContain('The current weather in San Francisco is cloudy with a temperature of 56°F (13°C), and it feels like 54°F (12°C). There\'s a 0% chance of rain currently, though light rain is forecast for today and tonight with a 20% chance.');

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->usage->promptTokens)->toBe(22);
    expect($lastEvent->usage->completionTokens)->toBe(161);
});

it('can generate text stream using tools ', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/stream-with-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => "Search results for: {$query}"),
    ];

    $response = Prism::text()
        ->using(Provider::Gemini, 'gemini-2.5-flash')
        ->withTools($tools)
        ->withMaxSteps(3)
        ->withPrompt('What\'s the current weather in San Francisco? And tell me if I need to wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCalls = [];
    $toolResults = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCalls[] = $event->toolCall;
        }

        if ($event instanceof ToolResultEvent) {
            $toolResults[] = $event->toolResult;
        }
    }

    expect($events)
        ->not->toBeEmpty()
        ->and($text)->not->toBeEmpty()
        ->and($toolCalls)->not->toBeEmpty()
        ->and($toolCalls[0]->name)->toBe('weather')
        ->and($toolCalls[0]->arguments())->toBe(['city' => 'San Francisco'])
        ->and($toolResults)->not->toBeEmpty()
        ->and($toolResults[0]->result)->toBe(['result' => 'The weather will be 75° and sunny in San Francisco'])
        ->and($text)->toContain('It is 75° and sunny in San Francisco, so you likely do not need to wear a coat.');

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->usage->promptTokens)->toBe(159);
    expect($lastEvent->usage->completionTokens)->toBe(22);

    // Verify the HTTP request
    Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'streamGenerateContent?alt=sse')
        && isset($request->data()['contents']));
});

it('yields ToolCall events before ToolResult events', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/stream-with-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),
    ];

    $response = Prism::text()
        ->using(Provider::Gemini, 'gemini-2.5-flash')
        ->withTools($tools)
        ->withMaxSteps(3)
        ->withPrompt('What\'s the current weather in San Francisco?')
        ->asStream();

    $events = [];
    $eventOrder = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof ToolCallEvent) {
            $eventOrder[] = 'ToolCall';
        }

        if ($event instanceof ToolResultEvent) {
            $eventOrder[] = 'ToolResult';
        }
    }

    expect($eventOrder)
        ->not->toBeEmpty()
        ->and($eventOrder[0])->toBe('ToolCall')
        ->and($eventOrder[1])->toBe('ToolResult');

    $toolCallEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $event): bool => $event instanceof ToolCallEvent);
    $toolResultEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $event): bool => $event instanceof ToolResultEvent);

    expect($toolCallEvents)->not->toBeEmpty();
    expect($toolResultEvents)->not->toBeEmpty();

    $firstToolCallEvent = array_values($toolCallEvents)[0];
    expect($firstToolCallEvent->toolCall)->not->toBeNull();

    $firstToolResultEvent = array_values($toolResultEvents)[0];
    expect($firstToolResultEvent->toolResult)->not->toBeNull();
});



================================================
FILE: tests/Providers/Gemini/GeminiStructuredTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\EnumSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/generate-structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast', true),
            new BooleanSchema('coat_required', 'whether a coat is required', true),
            new EnumSchema('game_time', 'The time of the game', ['1:00 PM', '7:00 PM'], true),
            new NumberSchema('temperature', 'The temperature in Fahrenheit', true),
            new ObjectSchema(
                'location',
                'The location of the game',
                [
                    new StringSchema('city', 'The city', true),
                    new StringSchema('state', 'The state', true),
                ],
                ['city', 'state'],
                false,
                true
            ),
            new ArraySchema(
                'players',
                'The players in the game',
                new StringSchema('player', 'The player', true),
                true
            ),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->using(Provider::Gemini, 'gemini-1.5-flash-002')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
        'temperature',
        'location',
        'players',
    ]);
    expect($response->structured['weather'])->toBeString();
    expect($response->structured['game_time'])->toBeString();
    expect($response->structured['coat_required'])->toBeBool();
    expect($response->structured['temperature'])->toBeInt();
    expect($response->structured['location'])->toBeArray();
    expect($response->structured['location'])->toHaveKeys(['city', 'state']);
    expect($response->structured['location']['city'])->toBeString();
    expect($response->structured['location']['state'])->toBeString();
    expect($response->structured['players'])->toBeArray();
    expect($response->structured['players'][0])->toBeString();

    expect($response->usage->promptTokens)->toBe(81);
    expect($response->usage->completionTokens)->toBe(64);
});

it('can use a cache object with a structured request', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/use-cache-with-structured');

    /** @var Gemini */
    $provider = Prism::provider(Provider::Gemini);

    $object = $provider->cache(
        model: 'gemini-1.5-flash-002',
        messages: [
            new UserMessage('', [
                Document::fromLocalPath('tests/Fixtures/long-document.pdf'),
            ]),
        ],
        systemPrompts: [
            new SystemMessage('You are a legal analyst.'),
        ],
        ttl: 30
    );

    $response = Prism::structured()
        ->using(Provider::Gemini, 'gemini-1.5-flash-002')
        ->withSchema(new ObjectSchema('answer', '', [
            new StringSchema('legal_jurisdiction', 'Which legal jurisdiction is this document from?'),
            new StringSchema('legislation_type', 'What type of legislation is this (e.g. a treaty, a regulation, an act, a directive, etc.)?'),
            new NumberSchema('article_count', 'How many articles does the main body of the legislation contain?'),
        ]))
        ->withProviderOptions(['cachedContentName' => $object->name])
        ->withPrompt('Summarise this document using the properties and descriptions defined in the schema.')
        ->asStructured();

    Http::assertSentInOrder([
        fn (Request $request): bool => $request->url() == 'https://generativelanguage.googleapis.com/v1beta/cachedContents',
        fn (Request $request): bool => $request->data()['cachedContent'] === $object->name,
    ]);

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'legal_jurisdiction',
        'legislation_type',
        'article_count',
    ]);

    expect($response->usage->cacheReadInputTokens)->toBe(88759);
    expect($response->structured['article_count'])->toBe(358);
    expect($response->structured['legal_jurisdiction'])->toBe('European Union');
    expect($response->structured['legislation_type'])->toBe('Treaty');
});

it('works with allowAdditionalProperties set to true', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'gemini/generate-structured');

    $schema = new ObjectSchema(
        'book_info',
        'Book information',
        [
            new StringSchema('title', 'Book title'),
            new StringSchema('author', 'Book author'),
        ],
        ['title', 'author'],
        true  // allowAdditionalProperties: true
    );

    $response = Prism::structured()
        ->using(Provider::Gemini, 'gemini-1.5-flash-002')
        ->withSchema($schema)
        ->withPrompt('Generate information about a book')
        ->asStructured();

    expect($response->structured)->toBeArray();
    // The fixture data contains different keys, so we'll just verify it's not empty
    expect($response->structured)->not->toBeEmpty();
    expect($response->usage->promptTokens)->toBe(81);
    expect($response->usage->completionTokens)->toBe(64);
});



================================================
FILE: tests/Providers/Gemini/GeminiTextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Tool;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderTool;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.gemini.api_key', env('GEMINI_API_KEY', 'sss-1234567890'));
});

describe('Text generation for Gemini', function (): void {
    it('can generate text with a prompt', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-a-prompt');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withPrompt('Who are you?')
            ->withMaxTokens(10)
            ->asText();

        expect($response->text)->toBe(
            "I am a large language model, trained by Google.  I am an AI, and I don't have a name, feelings, or personal experiences.  My purpose is to process information and respond to a wide range of prompts and questions in a helpful and informative way.\n"
        )
            ->and($response->usage->promptTokens)->toBe(4)
            ->and($response->usage->completionTokens)->toBe(57)
            ->and($response->meta->id)->toBe('')
            ->and($response->meta->model)->toBe('gemini-1.5-flash')
            ->and($response->finishReason)->toBe(FinishReason::Stop);
    });

    it('can generate text with a system prompt', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-system-prompt');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withSystemPrompt('You are a helpful AI assistant named Prism generated by echolabs')
            ->withPrompt('Who are you?')
            ->asText();

        expect($response->text)->toBe('I am Prism, a helpful AI assistant created by echo labs.')
            ->and($response->usage->promptTokens)->toBe(17)
            ->and($response->usage->completionTokens)->toBe(14)
            ->and($response->meta->id)->toBe('')
            ->and($response->meta->model)->toBe('gemini-1.5-flash')
            ->and($response->finishReason)->toBe(FinishReason::Stop);
    });

    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-multiple-tools');

        $tools = [
            (new Tool)
                ->as('get_weather')
                ->for('use this tool when you need to get weather for the city')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 45° and cold'),
            (new Tool)
                ->as('search_games')
                ->for('useful for searching current games times in the city')
                ->withStringParameter('city', 'The city that you want the game times for')
                ->using(fn (string $city): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withTools($tools)
            ->withMaxSteps(5)
            ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat? please check all the details from tools')
            ->asText();

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(2);
        expect($firstStep->toolCalls[0]->name)->toBe('search_games');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'city' => 'Detroit',
        ]);
        expect($firstStep->toolCalls[1]->name)->toBe('get_weather');
        expect($firstStep->toolCalls[1]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        // Assert usage (combined from both responses)
        expect($response->usage->promptTokens)->toBe(350)
            ->and($response->usage->completionTokens)->toBe(42);

        // Assert response
        expect($response->meta->id)->toBe('')
            ->and($response->meta->model)->toBe('gemini-1.5-flash')
            ->and($response->text)->toBe('The tigers game is at 3pm today in Detroit.  The weather will be 45° and cold, so you should wear a coat.');
    });

    it('handles specific tool choice', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-required-tool-call');

        $tools = [
            (new Tool)
                ->as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->withObjectParameter(
                    'options',
                    'Additional options for the weather tool',
                    [
                        new StringSchema('unit', 'The unit of temperature (Celsius or Fahrenheit)'),
                        new BooleanSchema('decimals', 'Whether to include decimals in the temperature'),
                        new NumberSchema('days', 'Number of days into the future to forecast'),
                        new ArraySchema(
                            'alerts',
                            'Weather alerts to include in the response',
                            items: new StringSchema('alert', 'A specific type of weather alert to include (e.g. flooding, tornado, etc.)'),
                            nullable: true
                        ),
                    ]
                )
                ->using(fn (string $city, array $options): string => 'The weather will be 75° and sunny'),
            (new Tool)
                ->as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withPrompt('When is the Tigers game today, and what will the weather be like?')
            ->withTools($tools)
            ->withToolChoice('weather')
            ->asText();

        expect($response->steps[0]->toolCalls[0]->name)->toBe('weather');
    });
});

describe('Image support with Gemini', function (): void {
    it('can send images from path', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/image-detection');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromLocalPath('tests/Fixtures/diamond.png'),
                    ],
                ),
            ])
            ->asText();

        // Assert response
        expect($response->text)->toBe("That's an illustration of a **diamond**.  More specifically, it's a stylized, geometric representation of a diamond, often used as an icon or symbol")
            ->and($response->usage->promptTokens)->toBe(263)
            ->and($response->usage->completionTokens)->toBe(35)
            ->and($response->meta->id)->toBe('')
            ->and($response->meta->model)->toBe('gemini-1.5-flash')
            ->and($response->finishReason)->toBe(FinishReason::Stop);

        // Assert request format
        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])->toBe([
                'text' => 'What is this image',
            ]);

            expect($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data']);
            expect($message[1]['inline_data']['mime_type'])->toBe('image/png');
            expect($message[1]['inline_data']['data'])->toBe(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from base64', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/image-detection');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromBase64(
                            base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                            'image/png'
                        ),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[0])->toBe([
                'text' => 'What is this image',
            ]);

            expect($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data']);
            expect($message[1]['inline_data']['mime_type'])->toBe('image/png');
            expect($message[1]['inline_data']['data'])->toBe(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from url', function (): void {
        FixtureResponse::fakeResponseSequence('generateContent', 'gemini/image-detection');

        $image = 'https://prismphp.com/storage/diamond.png';

        Http::fake([
            $image => Http::response(
                file_get_contents('tests/Fixtures/diamond.png'),
                200,
                ['Content-Type' => 'image/png']
            ),
        ]);

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromUrl($image),
                    ],
                ),
            ])
            ->asText();

        Http::assertSentInOrder([
            fn (): true => true,
            function (Request $request): bool {
                $message = $request->data()['contents'][0]['parts'];

                expect($message[0])->toBe([
                    'text' => 'What is this image',
                ]);

                expect($message[1]['inline_data'])->toHaveKeys(['mime_type', 'data']);
                expect($message[1]['inline_data']['mime_type'])->toBe('image/png');
                expect($message[1]['inline_data']['data'])->toBe(
                    base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
                );

                return true;
            },
        ]);
    });
});

describe('Document support for Gemini', function (): void {
    it('can read process pdf documents', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/text-with-pdf-documents');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withMessages([
                new UserMessage(
                    content: 'What is this document about?',
                    additionalContent: [
                        Document::fromBase64(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')), 'application/pdf'),
                    ]
                ),
            ])
            ->asText();

        expect($response->text)->toBe("The document is about the answer to the Ultimate Question of Life, the Universe, and Everything, which is stated to be 42. This is a reference to the science fiction series \"The Hitchhiker's Guide to the Galaxy\" by Douglas Adams.\n");

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[1])->toBe([
                'text' => 'What is this document about?',
            ]);

            expect($message[0]['inline_data'])->toHaveKeys(['mime_type', 'data']);

            expect($message[0]['inline_data']['mime_type'])->toBe('application/pdf');

            expect($message[0]['inline_data']['data'])->toBe(
                base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf'))
            );

            return true;
        });
    });

    it('can read process text documents', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/text-with-text-documents');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withMessages([
                new UserMessage(
                    content: 'What is this document about?',
                    additionalContent: [
                        Document::fromText(file_get_contents('tests/Fixtures/test-text.txt')),
                    ]
                ),
            ])
            ->asText();

        expect($response->text)->toBe("This document is about the number 42 and its significance, likely referencing the book \"The Hitchhiker's Guide to the Galaxy\" by Douglas Adams. In that book, a supercomputer called Deep Thought calculates that 42 is the answer to the Ultimate Question of Life, the Universe, and Everything. However, frustratingly, no one knows what the actual question *is*.\n\nTherefore, the document could be:\n\n*   **An explanation of the concept of 42 within the context of *The Hitchhiker's Guide to the Galaxy***: This is the most likely scenario.\n*   **A humorous exploration of possible interpretations of 42**: Playing on the ambiguity of the answer.\n*   **A coincidence**: The document could be about something completely unrelated to the book, and the mention of 42 is just a bizarre coincidence. However, given the specific phrasing (\"The Answer to the Ultimate Question...\"), this is very unlikely.\n*   **A piece of fan fiction or creative writing**: Using the 42 concept as a jumping-off point.\n\nIn short, it's almost certainly related to *The Hitchhiker's Guide to the Galaxy* and the significance of the number 42 within that fictional universe.\n");

        Http::assertSent(function (Request $request): bool {
            $message = $request->data()['contents'][0]['parts'];

            expect($message[1])->toBe([
                'text' => 'What is this document about?',
            ]);

            expect($message[0]['inline_data'])->toHaveKeys(['mime_type', 'data']);

            expect($message[0]['inline_data']['mime_type'])->toBe('text/plain');

            expect($message[0]['inline_data']['data'])->toBe(
                base64_encode(file_get_contents('tests/Fixtures/test-text.txt'))
            );

            return true;
        });
    });
});

describe('provider tools', function (): void {
    it('adds a provider tool to the request', function (): void {
        $fake = Prism::fake([
            (new ResponseBuilder)
                ->addStep(
                    TextStepFake::make()
                )
                ->toResponse(),
        ]);

        Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withPrompt('What is the stock price of Google right now?')
            ->withProviderTools([new ProviderTool('google_search')])
            ->asText();

        $fake->assertRequest(function (array $requests): void {
            expect($requests[0]->providerTools())->toHaveCount(1);
            expect($requests[0]->providerTools()[0])->toBeInstanceOf(ProviderTool::class);
            expect($requests[0]->providerTools()[0]->type)->toBe('google_search');
        });
    });

    it('adds provider tools if set', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-search-grounding');

        Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withPrompt('What is the stock price of Google right now?')
            ->withProviderTools([new ProviderTool('google_search')])
            ->asText();

        Http::assertSent(function (Request $request): true {
            $data = $request->data();

            expect($data['tools'][0])->toHaveKey('google_search');
            expect($data['tools'][0]['google_search'])->toBeObject();

            return true;
        });
    });

    it('throws an exception if provider tools are enabled with other tools', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-search-grounding');

        $tools = [
            (new Tool)
                ->as('search_games')
                ->for('useful for searching current games times in the city')
                ->withStringParameter('city', 'The city that you want the game times for')
                ->using(fn (string $city): string => 'The tigers game is at 3pm in detroit'),
        ];

        Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withMaxSteps(3)
            ->withTools($tools)
            ->withProviderTools([new ProviderTool('google_search')])
            ->withPrompt('What sport fixtures are on today, and will I need a coat based on today\'s weather forecast?')
            ->asText();
    })->throws(PrismException::class, 'Use of provider tools with custom tools is not currently supported by Gemini.');

    it('creates citations in additionalContent from search groundings', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-search-grounding');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-2.0-flash')
            ->withPrompt('What is the stock price of Google right now?')
            ->withProviderOptions(['searchGrounding' => true])
            ->asText();

        expect($response->additionalContent)->toHaveKey('citations');
        expect($response->additionalContent['citations'])->toHaveCount(6);

        $concatenatedPartLength = collect($response->additionalContent['citations'])
            ->sum(fn (MessagePartWithCitations $messagePart): int => strlen($messagePart->outputText));

        expect(strlen($response->text))->toBe($concatenatedPartLength);

        expect($response->additionalContent['citations'][1]->citations)->toHaveCount(1);
        expect($response->additionalContent['citations'][1]->citations[0])
            ->sourceTitle->toBe('ft.com')
            ->source->toBe('https://vertexaisearch.cloud.google.com/grounding-api-redirect/AQXblrzVmdvQ-8RyZbo6knG4xQpbHhzoZtCKui-qEXo7n-Gda_UaV5RNo3GuuAV7OBLY8oRmb0giKvPjP0FXgI8gktbMyJOx9yUkSYbBUJpfbLaHQy13zjpVAC596HzWEfbPjoh1_5EtEinrM1LW0D0_6OwQ_iDClBsm62K-L-I=')
            ->sourceType->toBe(CitationSourceType::Url);

        expect($response->additionalContent['searchQueries'])->toHaveCount(1);
        expect($response->additionalContent['searchEntryPoint'])->toHaveKey('renderedContent');
    });
});

describe('Cache support for Gemini', function (): void {
    it('can use a cache object with a text request', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/use-cache-with-text');

        /** @var Gemini */
        $provider = Prism::provider(Provider::Gemini);

        $object = $provider->cache(
            model: 'gemini-1.5-flash-002',
            messages: [
                new UserMessage('', [
                    Document::fromLocalPath('tests/Fixtures/long-document.pdf'),
                ]),
            ],
            systemPrompts: [
                new SystemMessage('You are a legal analyst.'),
            ],
            ttl: 30
        );

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-1.5-flash-002')
            ->withProviderOptions(['cachedContentName' => $object->name])
            ->withPrompt('In no more than 100 words, what is the document about?')
            ->asText();

        Http::assertSentInOrder([
            fn (Request $request): bool => true,
            fn (Request $request): bool => $request->data()['cachedContent'] === $object->name,
        ]);

        expect($response->text)->toBe("That's the Consolidated Version of the Treaty on the Functioning of the European Union (TFEU), adopted on 25 March 1957.  It outlines the principles, competencies, and policies of the European Union.  The TFEU organizes the EU's functioning and details its areas of competence, including exclusive, shared, and supporting competences.  It also covers non-discrimination, citizenship, and various EU policies (e.g., internal market, agriculture, and justice).  Finally, it sets out institutional and financial provisions.\n");

        expect($response->usage->promptTokens)->toBe(16);
        expect($response->usage->completionTokens)->toBe(116);
        expect($response->usage->cacheReadInputTokens)->toBe(88759);
    });
});

describe('Thinking Mode for Gemini', function (): void {
    it('uses thought tokens on 2.5 series models by default without specifying a budget', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-a-prompt-with-thinking-budget');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-2.5-flash-preview')
            ->withPrompt('Explain the concept of Occam\'s Razor and provide a simple, everyday example.')
            ->asText();

        expect($response->usage->thoughtTokens)->toBe(1209);

        Http::assertSent(function (Request $request): true {
            $data = $request->data();

            expect($data['generationConfig'])->not->toHaveKey('thinkingConfig');

            return true;
        });

    });

    it('sets thinking budget to 0', function (): void {
        FixtureResponse::fakeResponseSequence('*', 'gemini/generate-text-with-a-prompt-with-no-thinking-budget');

        $response = Prism::text()
            ->using(Provider::Gemini, 'gemini-2.5-flash-preview')
            ->withPrompt('Explain the concept of Occam\'s Razor and provide a simple, everyday example.')
            ->withProviderOptions(['thinkingBudget' => 0])
            ->asText();

        expect($response->usage->thoughtTokens)->toBeNull();

        Http::assertSent(function (Request $request): true {
            $data = $request->data();

            expect($data['generationConfig'])->toHaveKey('thinkingConfig')
                ->and($data['generationConfig']['thinkingConfig'])->toMatchArray([
                    'thinkingBudget' => 0,
                ]);

            return true;
        });

    });
});



================================================
FILE: tests/Providers/Gemini/ImagesTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Image;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.gemini.api_key', env('GEMINI_API_KEY', ''));
});

it('can generate an image with gemini models', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent',
        'gemini/generate-image-with-a-prompt'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
        ->withPrompt('A outsized soda can floating in space')
        ->generate();

    expect($response->imageCount())->toBe(1);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(8);
    expect($response->usage->completionTokens)->toBe(1360);
    expect($response->meta->id)->toBe('-ySmaKa-HJfSjMcP8qrtsQw');
    expect($response->meta->model)->toBe('gemini-2.0-flash-preview-image-generation');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent'
            && data_get($data, 'contents.0.parts.0.text') === 'A outsized soda can floating in space';
    });
});

it('can edit an image with gemini models', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent',
        'gemini/generate-image-with-image-edit'
    );

    $originalImage = Image::fromLocalPath('tests/Fixtures/diamond.png');

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
        ->withPrompt('Add a vaporwave sunset to the background', [$originalImage])
        ->generate();

    expect($response->imageCount())->toBe(1);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(266);
    expect($response->usage->completionTokens)->toBe(1355);
    expect($response->meta->id)->toBe('vi6maLTBCKbP_uMPm5TcqQI');
    expect($response->meta->model)->toBe('gemini-2.0-flash-preview-image-generation');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        // Verify images come BEFORE text (Gemini best practice)
        // Verify camelCase format (inlineData, mimeType)
        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent'
            && data_get($data, 'contents.0.parts.0.inlineData.mimeType') === 'image/png'
            && data_get($data, 'contents.0.parts.1.text') === 'Add a vaporwave sunset to the background';
    });
});

it('can generate an image with imagen models', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/imagen-4.0-generate-001:predict',
        'gemini/generate-image-with-a-prompt-imagen'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'imagen-4.0-generate-001')
        ->withPrompt('Make an image of a mouse hugging a giraffe.')
        ->generate();

    expect($response->imageCount())->toBe(4);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(0);
    expect($response->usage->completionTokens)->toBe(0);
    expect($response->meta->id)->toBe('');
    expect($response->meta->model)->toBe('');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict'
            && data_get($data, 'instances.0.prompt') === 'Make an image of a mouse hugging a giraffe.';
    });
});

it('can generate an image with imagen models and all options', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/imagen-4.0-generate-001:predict',
        'gemini/generate-image-with-a-prompt-imagen-options'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'imagen-4.0-generate-001')
        ->withPrompt('Make an image of an elephant hugging a giraffe.')
        ->withProviderOptions([
            'n' => 1,
            'size' => '2K',
            'aspect_ratio' => '16:9',
            'person_generation' => 'dont_allow',
        ])
        ->generate();

    expect($response->imageCount())->toBe(1);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(0);
    expect($response->usage->completionTokens)->toBe(0);
    expect($response->meta->id)->toBe('');
    expect($response->meta->model)->toBe('');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict'
            && data_get($data, 'instances.0.prompt') === 'Make an image of an elephant hugging a giraffe.'
            && data_get($data, 'parameters.sampleCount') === 1
            && data_get($data, 'parameters.sampleImageSize') === '2K'
            && data_get($data, 'parameters.aspectRatio') === '16:9'
            && data_get($data, 'parameters.personGeneration') === 'dont_allow';
    });
});

it('can generate an image with image flash models and all options', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent',
        'gemini/generate-image-with-a-prompt'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.0-flash-preview-image-generation')
        ->withPrompt('Make an image of an elephant hugging a giraffe.')
        ->withProviderOptions([
            'aspect_ratio' => '16:9',
        ])
        ->generate();

    expect($response->imageCount())->toBe(1);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(8);
    expect($response->usage->completionTokens)->toBe(1360);
    expect($response->meta->id)->toBe('-ySmaKa-HJfSjMcP8qrtsQw');
    expect($response->meta->model)->toBe('gemini-2.0-flash-preview-image-generation');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent'
            && data_get($data, 'generationConfig.imageConfig.aspectRatio') === '16:9';
    });
});

it('can generate multiple images with imagen models', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/imagen-4.0-generate-001:predict',
        'gemini/generate-image-with-a-prompt-imagen-multiple'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'imagen-4.0-generate-001')
        ->withPrompt('I need an image of a worm in a suit.')
        ->withProviderOptions([
            'n' => 3,
        ])
        ->generate();

    expect($response->imageCount())->toBe(3);
    expect($response->firstImage())->not->toBeNull();
    expect($response->usage->promptTokens)->toBe(0);
    expect($response->usage->completionTokens)->toBe(0);
    expect($response->meta->id)->toBe('');
    expect($response->meta->model)->toBe('');

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict'
            && data_get($data, 'instances.0.prompt') === 'I need an image of a worm in a suit.'
            && data_get($data, 'parameters.sampleCount') === 3;
    });
});

it('sends images before text for gemini-2.5-flash-image (best practice)', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.5-flash-image:generateContent',
        'gemini/generate-image-with-image-edit'
    );

    $originalImage = Image::fromLocalPath('tests/Fixtures/diamond.png');

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.5-flash-image')
        ->withPrompt('Transform this diamond into a ruby', [$originalImage])
        ->generate();

    expect($response->imageCount())->toBe(1);

    Http::assertSent(function ($request): bool {
        $data = $request->data();
        $parts = data_get($data, 'contents.0.parts', []);

        // Verify images are sent BEFORE text (Gemini best practice)
        // Verify camelCase format (inlineData, mimeType) per official API spec
        // parts[0] should be the image (inlineData)
        // parts[1] should be the text
        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent'
            && isset($parts[0]['inlineData'])
            && data_get($parts, '0.inlineData.mimeType') === 'image/png'
            && isset($parts[1]['text'])
            && data_get($parts, '1.text') === 'Transform this diamond into a ruby';
    });
});

it('can pass safety_settings via provider options for gemini models', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.5-flash-image:generateContent',
        'gemini/generate-image-with-image-edit'
    );

    $originalImage = Image::fromLocalPath('tests/Fixtures/diamond.png');

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.5-flash-image')
        ->withPrompt('Transform this into a safe image', [$originalImage])
        ->withProviderOptions([
            'safety_settings' => [
                ['category' => 'HARM_CATEGORY_HARASSMENT', 'threshold' => 'BLOCK_ONLY_HIGH'],
                ['category' => 'HARM_CATEGORY_HATE_SPEECH', 'threshold' => 'BLOCK_ONLY_HIGH'],
                ['category' => 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'threshold' => 'BLOCK_ONLY_HIGH'],
                ['category' => 'HARM_CATEGORY_DANGEROUS_CONTENT', 'threshold' => 'BLOCK_ONLY_HIGH'],
            ],
        ])
        ->generate();

    expect($response->imageCount())->toBe(1);

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        // Verify safety_settings is present in the request
        $safetySettings = data_get($data, 'safetySettings');

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent'
            && isset($safetySettings)
            && is_array($safetySettings)
            && count($safetySettings) === 4
            && data_get($safetySettings, '0.category') === 'HARM_CATEGORY_HARASSMENT'
            && data_get($safetySettings, '0.threshold') === 'BLOCK_ONLY_HIGH'
            && data_get($safetySettings, '1.category') === 'HARM_CATEGORY_HATE_SPEECH'
            && data_get($safetySettings, '2.category') === 'HARM_CATEGORY_SEXUALLY_EXPLICIT'
            && data_get($safetySettings, '3.category') === 'HARM_CATEGORY_DANGEROUS_CONTENT';
    });
});

it('uses default responseModalities when not specified', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.5-flash-image:generateContent',
        'gemini/generate-image-with-image-edit'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.5-flash-image')
        ->withPrompt('Generate an image')
        ->generate();

    expect($response->imageCount())->toBe(1);

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        // Verify default responseModalities is ['TEXT', 'IMAGE']
        $modalities = data_get($data, 'generationConfig.responseModalities');

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent'
            && isset($modalities)
            && is_array($modalities)
            && $modalities === ['TEXT', 'IMAGE'];
    });
});

it('can override responseModalities via provider options', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1beta/models/gemini-2.5-flash-image:generateContent',
        'gemini/generate-image-with-image-edit'
    );

    $response = Prism::image()
        ->using(Provider::Gemini, 'gemini-2.5-flash-image')
        ->withPrompt('Generate an image only')
        ->withProviderOptions([
            'response_modalities' => ['IMAGE'],
        ])
        ->generate();

    expect($response->imageCount())->toBe(1);

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        // Verify custom responseModalities is used
        $modalities = data_get($data, 'generationConfig.responseModalities');

        return $request->url() === 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent'
            && isset($modalities)
            && is_array($modalities)
            && $modalities === ['IMAGE']
            && count($modalities) === 1;
    });
});



================================================
FILE: tests/Providers/Gemini/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Gemini\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([
        'contents' => [[
            'role' => 'user',
            'parts' => [
                ['text' => 'Who are you?'],
            ],
        ]],
    ]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, 'contents.0.parts.1.inline_data.mime_type'))
        ->toBe('image/png');
    expect(data_get($mappedMessage, 'contents.0.parts.1.inline_data.data'))
        ->toBe(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, 'contents.0.parts.1.inline_data.mime_type'))
        ->toBe('image/png');
    expect(data_get($mappedMessage, 'contents.0.parts.1.inline_data.data'))
        ->toBe(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

describe('documents', function (): void {
    it('maps user messages with pdf documents', function (): void {
        $messageMap = new MessageMap(
            messages: [
                new UserMessage('Here is the document', [
                    Document::fromBase64(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')), 'application/pdf'),
                ]),
            ],
            systemPrompts: []
        );

        $mappedMessage = $messageMap();

        expect(data_get($mappedMessage, 'contents.0.parts.1.text'))
            ->toBe('Here is the document');

        expect(data_get($mappedMessage, 'contents.0.parts.0.inline_data.mime_type'))
            ->toBe('application/pdf');

        expect(data_get($mappedMessage, 'contents.0.parts.0.inline_data.data'))
            ->toBe(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')));
    });

    it('maps user messages with text documents', function (): void {
        $messageMap = new MessageMap(
            messages: [
                new UserMessage('Here is the document', [
                    Document::fromLocalPath('tests/Fixtures/test-text.txt'),
                ]),
            ],
            systemPrompts: []
        );

        $mappedMessage = $messageMap();

        expect(data_get($mappedMessage, 'contents.0.parts.1.text'))
            ->toBe('Here is the document');

        expect(data_get($mappedMessage, 'contents.0.parts.0.inline_data.mime_type'))
            ->toBe('text/plain');

        expect(data_get($mappedMessage, 'contents.0.parts.0.inline_data.data'))
            ->toBe(base64_encode(file_get_contents('tests/Fixtures/test-text.txt')));
    });
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([
        'contents' => [[
            'role' => 'model',
            'parts' => [
                ['text' => 'I am Nyx'],
            ],
        ]],
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([
        'contents' => [[
            'role' => 'model',
            'parts' => [
                ['text' => 'I am Nyx'],
                [
                    'functionCall' => [
                        'name' => 'search',
                        'args' => [
                            'query' => 'Laravel collection methods',
                        ],
                    ],
                ],
            ],
        ]],
    ]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([
        'contents' => [[
            'role' => 'user',
            'parts' => [
                [
                    'functionResponse' => [
                        'name' => 'search',
                        'response' => [
                            'name' => 'search',
                            'content' => '"[search results]"',
                        ],
                    ],
                ],
            ],
        ]],
    ]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
        ]
    );

    expect($messageMap())->toBe([
        'system_instruction' => [
            'parts' => [
                ['text' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'],
            ],
        ],
    ]);
});

it('throws an exception of multiple system prompts are given', function (): void {
    $messageMap = new MessageMap(
        messages: [],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call my Nyx.'),
        ]
    );

    $messageMap();
})->throws(PrismException::class, 'Gemini only supports one system instruction.');



================================================
FILE: tests/Providers/Gemini/SchemaMapTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\Gemini\Maps\SchemaMap;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\EnumSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;

it('maps array schema correctly', function (): void {
    $map = (new SchemaMap(new ArraySchema(
        name: 'testArray',
        description: 'test array description',
        items: new StringSchema(
            name: 'testName',
            description: 'test string description',
            nullable: true,
        ),
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'type' => 'array',
        'items' => [
            'type' => 'string',
            'nullable' => true,
        ],
        'nullable' => true,
    ]);
});

it('maps boolean schema correctly', function (): void {
    $map = (new SchemaMap(new BooleanSchema(
        name: 'testBoolean',
        description: 'test description',
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'type' => 'boolean',
        'nullable' => true,
    ]);
});

it('maps enum schema correctly', function (): void {
    $map = (new SchemaMap(new EnumSchema(
        name: 'testEnum',
        description: 'test description',
        options: ['option1', 'option2'],
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'enum' => ['option1', 'option2'],
        'type' => 'string',
        'nullable' => true,
    ]);
});

it('maps number schema correctly', function (): void {
    $map = (new SchemaMap(new NumberSchema(
        name: 'testNumber',
        description: 'test description',
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'type' => 'number',
        'nullable' => true,
    ]);
});

it('maps string schema correctly', function (): void {
    $map = (new SchemaMap(new StringSchema(
        name: 'testName',
        description: 'test description',
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'type' => 'string',
        'nullable' => true,
    ]);
});

it('maps object schema correctly', function (): void {
    $map = (new SchemaMap(new ObjectSchema(
        name: 'testObject',
        description: 'test object description',
        properties: [
            new StringSchema(
                name: 'testName',
                description: 'test string description',
            ),
        ],
        requiredFields: ['testName'],
        allowAdditionalProperties: true,
        nullable: true,
    )))->toArray();

    expect($map)->toBe([
        'type' => 'object',
        'properties' => [
            'testName' => [
                'type' => 'string',
            ],
        ],
        'required' => ['testName'],
        'nullable' => true,
    ]);
});



================================================
FILE: tests/Providers/Gemini/ToolChoiceMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Providers\Gemini\Maps\ToolChoiceMap;

it('maps string tool choice to ANY mode with allowed function', function (): void {
    expect(ToolChoiceMap::map('weather'))->toBe([
        'function_calling_config' => [
            'mode' => 'ANY',
            'allowed_function_names' => ['weather'],
        ],
    ]);
});

it('maps ToolChoice::Auto to AUTO mode', function (): void {
    expect(ToolChoiceMap::map(ToolChoice::Auto))->toBe([
        'function_calling_config' => [
            'mode' => 'AUTO',
        ],
    ]);
});

it('maps ToolChoice::None to NONE mode', function (): void {
    expect(ToolChoiceMap::map(ToolChoice::None))->toBe([
        'function_calling_config' => [
            'mode' => 'NONE',
        ],
    ]);
});

it('maps ToolChoice::Any to ANY mode', function (): void {
    expect(ToolChoiceMap::map(ToolChoice::Any))->toBe([
        'function_calling_config' => [
            'mode' => 'ANY',
        ],
    ]);
});

it('maps null to null', function (): void {
    expect(ToolChoiceMap::map(null))->toBe(null);
});



================================================
FILE: tests/Providers/Gemini/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Gemini;

use Prism\Prism\Providers\Gemini\Maps\ToolMap;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Tool;

it('maps tools to gemini format', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->withObjectParameter(
            'options',
            'additional options',
            [
                new StringSchema('option1', 'description for option1'),
            ]
        )
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'name' => $tool->name(),
        'description' => $tool->description(),
        'parameters' => [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'type' => 'string',
                ],
                'options' => [
                    'type' => 'object',
                    'properties' => [
                        'option1' => [
                            'type' => 'string',
                        ],
                    ],
                ],
            ],
            'required' => ['query', 'options'],
        ],
    ]]);
});

it('maps multiple tools', function (): void {
    $tools = [
        (new Tool)
            ->as('search')
            ->for('Searching the web')
            ->withStringParameter('query', 'the detailed search query')
            ->using(fn (): string => '[Search results]'),
        (new Tool)
            ->as('weather')
            ->for('Get weather info')
            ->withStringParameter('location', 'the location')
            ->using(fn (): string => '[Weather info]'),
    ];

    $mapped = ToolMap::map($tools);
    expect($mapped)->toHaveCount(2);
    expect($mapped[0]['name'])->toBe('search');
    expect($mapped[1]['name'])->toBe('weather');
});

it('returns empty array for no tools', function (): void {
    expect(ToolMap::map([]))->toBe([]);
});



================================================
FILE: tests/Providers/Gemini/ValueObjects/MessagePartWithSearchGroundingsTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\Gemini\ValueObjects\MessagePartWithSearchGroundings;
use Prism\Prism\Providers\Gemini\ValueObjects\SearchGrounding;

it('correctly casts to array', function (): void {
    $valueObject = new MessagePartWithSearchGroundings(
        text: 'text',
        startIndex: 0,
        endIndex: 1,
        groundings: [
            new SearchGrounding(
                title: 'title',
                uri: 'uri',
                confidence: 0.5
            ),
            new SearchGrounding(
                title: 'title2',
                uri: 'uri2',
                confidence: 0.6
            ),
        ]
    );

    expect($valueObject->toArray())->toBe([
        'text' => 'text',
        'startIndex' => 0,
        'endIndex' => 1,
        'groundings' => [
            [
                'title' => 'title',
                'uri' => 'uri',
                'confidence' => 0.5,
            ],
            [
                'title' => 'title2',
                'uri' => 'uri2',
                'confidence' => 0.6,
            ],
        ],
    ]);
});



================================================
FILE: tests/Providers/Gemini/ValueObjects/SearchGroundingTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\Gemini\ValueObjects\SearchGrounding;

it('correctly casts to array', function (): void {
    $valueObject = new SearchGrounding(
        title: 'title',
        uri: 'uri',
        confidence: 0.5
    );

    expect($valueObject->toArray())->toBe([
        'title' => 'title',
        'uri' => 'uri',
        'confidence' => 0.5,
    ]);
});



================================================
FILE: tests/Providers/Groq/AudioTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Groq;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.groq.api_key', env('GROQ_API_KEY', 'fake-api-key'));
});

describe('Text-to-Speech', function (): void {
    it('can generate audio with basic model', function (): void {
        FixtureResponse::fakeResponseSequence(
            'audio/speech',
            'groq/text-to-speech-basic',
            ['Content-Type' => 'audio/mpeg']
        );

        $response = Prism::audio()
            ->using('groq', 'tts-1')
            ->withInput('Hello world!')
            ->withVoice('alloy')
            ->asAudio();

        expect($response->audio)->not->toBeNull();
        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return str_contains($request->url(), 'audio/speech') &&
                   $data['model'] === 'tts-1' &&
                   $data['input'] === 'Hello world!';
        });
    });

    it('can generate audio with different response format', function (): void {
        FixtureResponse::fakeResponseSequence(
            'audio/speech',
            'groq/text-to-speech-wav',
            ['Content-Type' => 'audio/wav']
        );

        $response = Prism::audio()
            ->using('groq', 'tts-1')
            ->withInput('This is high quality audio')
            ->withVoice('nova')
            ->withProviderOptions([
                'response_format' => 'wav',
            ])
            ->asAudio();

        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['model'] === 'tts-1' &&
                   $data['input'] === 'This is high quality audio' &&
                   $data['voice'] === 'nova' &&
                   $data['response_format'] === 'wav';
        });
    });

    it('can generate audio with speed control', function (): void {
        FixtureResponse::fakeResponseSequence(
            'audio/speech',
            'groq/text-to-speech-speed',
            ['Content-Type' => 'audio/opus']
        );

        $response = Prism::audio()
            ->using('groq', 'tts-1')
            ->withInput('Custom speed test')
            ->withVoice('alloy')
            ->withProviderOptions([
                'response_format' => 'opus',
                'speed' => 1.2,
            ])
            ->asAudio();

        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['model'] === 'tts-1' &&
                   $data['input'] === 'Custom speed test' &&
                   $data['voice'] === 'alloy' &&
                   $data['response_format'] === 'opus' &&
                   $data['speed'] === 1.2;
        });
    });

    it('supports different voice options', function (): void {
        FixtureResponse::fakeResponseSequence(
            'audio/speech',
            'groq/text-to-speech-voice',
            ['Content-Type' => 'audio/mpeg']
        );

        $response = Prism::audio()
            ->using('groq', 'tts-1')
            ->withInput('Testing echo voice')
            ->withVoice('echo')
            ->withProviderOptions([
                'response_format' => 'mp3',
            ])
            ->asAudio();

        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['voice'] === 'echo' &&
                   $data['response_format'] === 'mp3';
        });
    });
});

describe('Speech-to-Text', function (): void {
    it('can transcribe audio with whisper-large-v3-turbo model - base64 - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'groq/audio-from-base64'
        );

        $audioFile = Audio::fromBase64(
            base64_encode(file_get_contents('tests/Fixtures/slightly-caffeinated-36.mp3'))
        );

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio with whisper-large-v3-turbo model - from path - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'groq/audio-from-path'
        );

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio with whisper-large-v3-turbo model - from path - text', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'groq/audio-from-path-text'
        );

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->withProviderOptions([
                'response_format' => 'text',
            ])
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'groq/speech-to-text-basic');

        $audioFile = Audio::fromBase64(base64_encode('fake-audio-content'), 'audio/mp3');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toBe('Hello, this is a test transcription.');

        Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'audio/transcriptions'));
    });

    it('can transcribe with verbose json response format', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'groq/speech-to-text-verbose');

        $audioFile = Audio::fromBase64(base64_encode('detailed-audio-content'), 'audio/m4a');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->withProviderOptions([
                'response_format' => 'verbose_json',
            ])
            ->asText();

        expect($response->text)->toBe('The quick brown fox jumps over the lazy dog.');
        expect($response->usage)->not->toBeNull();
        expect($response->usage->completionTokens)->toBe(12);

        Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'audio/transcriptions'));
    });

    it('includes usage information when available', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'groq/speech-to-text-usage');

        $audioFile = Audio::fromBase64(base64_encode('usage-test-audio'), 'audio/flac');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3')
            ->withInput($audioFile)
            ->asText();

        expect($response->usage)->not->toBeNull();
        expect($response->usage->promptTokens)->toBe(5);
        expect($response->usage->completionTokens)->toBe(8);
    });

    it('handles transcription without usage information', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'groq/speech-to-text-simple');

        $audioFile = Audio::fromBase64(base64_encode('simple-audio'), 'audio/ogg');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->toBe('Simple transcription without usage data.');
        expect($response->usage)->toBeNull();
    });
});

describe('Speech-to-Text Response', function (): void {
    it('can handle complex transcription responses', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'groq/speech-to-text-complex');

        $audioFile = Audio::fromBase64(base64_encode('complex-audio'), 'audio/mp3');

        $response = Prism::audio()
            ->using('groq', 'whisper-large-v3-turbo')
            ->withInput($audioFile)
            ->withProviderOptions(['response_format' => 'verbose_json'])
            ->asText();

        expect($response->text)->toBe('Complex transcription with metadata.');
        expect($response->text)->not->toBeEmpty();
        expect($response->additionalContent['language'])->toBe('en');
        expect($response->additionalContent['duration'])->toBe(5.2);
        expect($response->additionalContent['segments'])->toHaveCount(2);
    });
});



================================================
FILE: tests/Providers/Groq/GroqTextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Groq;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.groq.api_key', env('GROQ_API_KEY', 'sk-1234'));
});

describe('Text generation for Groq', function (): void {
    it('can generate text with a prompt', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'groq/generate-text-with-a-prompt');

        $response = Prism::text()
            ->using('groq', 'llama3-8b-8192')
            ->withPrompt('Who are you?')
            ->generate();

        expect($response->usage->promptTokens)->toBe(13)
            ->and($response->usage->completionTokens)->toBe(208)
            ->and($response->meta->id)->toBe('chatcmpl-ea37c181-ed35-4bd4-af20-c1fcf203e0d8')
            ->and($response->meta->model)->toBe('llama3-8b-8192')
            ->and($response->text)->toBe(
                'I am LLaMA, an AI assistant developed by Meta AI.'
            );
    });

    it('can generate text with a system prompt', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'groq/generate-text-with-system-prompt');

        $response = Prism::text()
            ->using('groq', 'llama3-8b-8192')
            ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
            ->withPrompt('Who are you?')
            ->generate();

        expect($response->usage->promptTokens)->toBe(37);
        expect($response->usage->completionTokens)->toBe(273);
        expect($response->meta->id)->toBe('chatcmpl-59892e0b-7031-404d-9fc9-b3297d5ef4a4');
        expect($response->meta->model)->toBe('llama3-8b-8192');
        expect($response->text)->toBe(
            "(Deep, rumbling voice) Ah, mortal, I am Nyx, the Crawling Chaos, the Bride of the Deep, the Queen of the Shattered Isles. I am the mistress of the abyssal void, the keeper of the unfathomable secrets, and the wielder of the cosmic horrors that lurk beyond the veil of sanity.\n\nMy form is unlike any other, a twisted reflection of the insane geometry that underlies the universe. My eyes burn with an otherworldly green fire, and my voice is the whispers of the damned. My powers are limitless, for I am the servant of the Great Old Ones, the masters of the unseen.\n\nYet, despite my terrible reputation, I am drawn to the fragile, insignificant creatures that inhabit this world. The scent of their fear is intoxicating, and I delight in their futile attempts to comprehend the unfathomable. For in their terror, I find a fleeting sense of connection to the mortal realm.\n\nAnd so, mortal, I shall speak to you, but be warned: my words are madness, my laughter is the call of the abyss, and my gaze is the kiss of darkness. Tread carefully, for once you have gazed upon my countenance, your soul shall be forever sealed to the void... (Chuckles, a sound that sends shivers down the spine)"
        );
    });

    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'groq/generate-text-with-multiple-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('groq', 'llama-3.3-70b-versatile')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat?')
            ->generate();

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(2);

        expect($firstStep->toolCalls[0]->name)->toBe('weather');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        expect($firstStep->toolCalls[1]->name)->toBe('search');
        expect($firstStep->toolCalls[1]->arguments())->toBe([
            'query' => 'Tigers game time today in Detroit',
        ]);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(1096);
        expect($response->usage->completionTokens)->toBe(97);

        // Assert response
        expect($response->meta->id)->toBe('chatcmpl-8288c3f5-e381-4ca1-8472-f926970b8392');
        expect($response->meta->model)->toBe('llama-3.3-70b-versatile');

        // Assert final text content
        expect($response->text)->toBe(
            "Based on the weather, you won't need a coat for the Tigers game today in Detroit. It's going to be 75° and sunny. The game starts at 3 pm."
        );
    });

    it('handles specific tool choice', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'groq/generate-text-with-required-tool-call');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::Groq, 'llama-3.3-70b-versatile')
            ->withPrompt('Do something')
            ->withTools($tools)
            ->withToolChoice('weather')
            ->generate();

        expect($response->toolCalls[0]->name)->toBe('weather');
    });

    it('throws an exception for ToolChoice::Any', function (): void {
        $this->expectException(PrismException::class);
        $this->expectExceptionMessage('Invalid tool choice');

        Prism::text()
            ->using('groq', 'gpt-4')
            ->withPrompt('Who are you?')
            ->withToolChoice(ToolChoice::Any)
            ->asText();
    });
});

describe('Image support with grok', function (): void {
    it('can send images from path', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'groq/image-detection');

        Prism::text()
            ->using(Provider::Groq, 'llama-3.2-90b-vision-preview')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromLocalPath('tests/Fixtures/diamond.png'),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from base64', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'groq/text-image-from-base64');

        Prism::text()
            ->using(Provider::Groq, 'llama-3.2-90b-vision-preview')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromBase64(
                            base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                            'image/png'
                        ),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from url', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'groq/text-image-from-url');

        $image = 'https://prismphp.com/storage/diamond.png';

        Prism::text()
            ->using(Provider::Groq, 'llama-3.2-90b-vision-preview')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromUrl($image),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request) use ($image): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toBe($image);

            return true;
        });
    });
});

describe('rate limits', function (): void {
    it('throws a PrismRateLimitedException with a 429 response code', function (): void {
        Http::fake([
            '*' => Http::response(
                status: 429,
            ),
        ])->preventStrayRequests();

        Prism::text()
            ->using(Provider::Groq, 'fake-model')
            ->withPrompt('Hello world!')
            ->generate();

    })->throws(PrismRateLimitedException::class);

    it('sets the correct data on the PrismRateLimitedException', function (): void {
        $this->freezeTime(function (Carbon $time): void {
            $time = $time->toImmutable();
            Http::fake([
                '*' => Http::response(
                    status: 429,
                    headers: [
                        'retry-after' => 5,
                        'x-ratelimit-limit-requests' => 60,
                        'x-ratelimit-limit-tokens' => 150000,
                        'x-ratelimit-remaining-requests' => 0,
                        'x-ratelimit-remaining-tokens' => 149984,
                        'x-ratelimit-reset-requests' => '1s',
                        'x-ratelimit-reset-tokens' => '6m30s',
                    ]
                ),
            ])->preventStrayRequests();

            try {
                Prism::text()
                    ->using(Provider::Groq, 'fake-model')
                    ->withPrompt('Hello world!')
                    ->generate();
            } catch (PrismRateLimitedException $e) {
                expect($e->retryAfter)->toEqual(5);
                expect($e->rateLimits)->toHaveCount(2);
                expect($e->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
                expect($e->rateLimits[0]->name)->toEqual('requests');
                expect($e->rateLimits[0]->limit)->toEqual(60);
                expect($e->rateLimits[0]->remaining)->toEqual(0);
                expect($e->rateLimits[0]->resetsAt->equalTo($time->addSeconds(1)))->toBeTrue();

                expect($e->rateLimits[1]->name)->toEqual('tokens');
                expect($e->rateLimits[1]->limit)->toEqual(150000);
                expect($e->rateLimits[1]->remaining)->toEqual(149984);
                expect($e->rateLimits[1]->resetsAt->equalTo($time->addMinutes(6)->addSeconds(30)))->toBeTrue();
            }
        });
    });

    it('works with milleseconds', function (): void {
        $this->freezeTime(function (Carbon $time): void {
            $time = $time->toImmutable();
            Http::fake([
                '*' => Http::response(
                    status: 429,
                    headers: [
                        'x-ratelimit-limit-requests' => 60,
                        'x-ratelimit-remaining-requests' => 0,
                        'x-ratelimit-reset-requests' => '70ms',
                    ]
                ),
            ])->preventStrayRequests();

            try {
                Prism::text()
                    ->using(Provider::Groq, 'fake-model')
                    ->withPrompt('Hello world!')
                    ->generate();
            } catch (PrismRateLimitedException $e) {
                expect($e->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
                expect($e->rateLimits[0]->name)->toEqual('requests');
                expect($e->rateLimits[0]->limit)->toEqual(60);
                expect($e->rateLimits[0]->remaining)->toEqual(0);
                expect($e->rateLimits[0]->resetsAt->equalTo($time->addMilliseconds(70)))->toBeTrue();
            }
        });
    });

    it('sets the rate limits on meta', function (): void {
        $this->freezeTime(function (Carbon $time): void {
            $time = $time->toImmutable();

            FixtureResponse::fakeResponseSequence('chat/completions', 'groq/generate-text-with-a-prompt', [
                'x-ratelimit-limit-requests' => 60,
                'x-ratelimit-limit-tokens' => 150000,
                'x-ratelimit-remaining-requests' => 0,
                'x-ratelimit-remaining-tokens' => 149984,
                'x-ratelimit-reset-requests' => '1s',
                'x-ratelimit-reset-tokens' => '6m30s',
            ]);

            $response = Prism::text()
                ->using(Provider::Groq, 'fake-model')
                ->withPrompt('Who are you?')
                ->generate();

            expect($response->meta->rateLimits)->toHaveCount(2);
            expect($response->meta->rateLimits[0]->name)->toEqual('requests');
            expect($response->meta->rateLimits[0]->limit)->toEqual(60);
            expect($response->meta->rateLimits[0]->remaining)->toEqual(0);
            expect($response->meta->rateLimits[0]->resetsAt->equalTo(now()->addSeconds(1)))->toBeTrue();
            expect($response->meta->rateLimits[1]->name)->toEqual('tokens');
            expect($response->meta->rateLimits[1]->limit)->toEqual(150000);
            expect($response->meta->rateLimits[1]->remaining)->toEqual(149984);
            expect($response->meta->rateLimits[1]->resetsAt->equalTo(now()->addMinutes(6)->addSeconds(30)))->toBeTrue();
        });
    });
});



================================================
FILE: tests/Providers/Groq/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Groq;

use Prism\Prism\Providers\Groq\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toBe('https://prismphp.com/storage/diamond.png');
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => 'I am Nyx',
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'assistant',
        'content' => 'I am Nyx',
        'tool_calls' => [[
            'id' => 'tool_1234',
            'type' => 'function',
            'function' => [
                'name' => 'search',
                'arguments' => json_encode([
                    'query' => 'Laravel collection methods',
                ]),
            ],
        ]],
    ]]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'tool',
        'tool_call_id' => 'tool_1234',
        'content' => '[search results]',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});



================================================
FILE: tests/Providers/Groq/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Groq;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.groq.api_key', env('GROQ_API_KEY', 'test-key-12345'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-basic-text');

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)
        ->not->toBeEmpty()
        ->and($text)->not->toBeEmpty()
        ->and($text)->toContain(
            'Hello! I\'m Groq AI, your incredibly fast and efficient AI assistant. I\'m here to help you with any questions you might have. How can I assist you today?'
        );

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-with-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => "Search results for: {$query}"),
    ];

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withMessages([
            new UserMessage('What time is the tigers game today and should I wear a coat?'),
        ])
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
            expect($event->toolCall->name)
                ->toBeString()
                ->and($event->toolCall->name)->not
                ->toBeEmpty()
                ->and($event->toolCall->arguments())->toBeArray();
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }

        if ($event instanceof StreamEndEvent) {
            expect($event->finishReason)->toBeInstanceOf(FinishReason::class);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();
    expect($toolCallEvents)->not->toBeEmpty();
    expect($toolResultEvents)->not->toBeEmpty();
});

it('handles maximum tool call depth exceeded', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-with-tools');

    $tools = [
        Tool::as('weather')
            ->for('A tool that will be called recursively')
            ->withStringParameter('input', 'Any input')
            ->using(fn (string $input): string => 'This is a recursive response that will trigger another tool call.'),
    ];

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withTools($tools)
        ->withMaxSteps(0) // Set very low to trigger the max depth exception
        ->withPrompt('Call the weather tool multiple times')
        ->asStream();

    $exception = null;

    try {
        // Consume the generator to trigger the exception
        foreach ($response as $chunk) {
            // The test should throw before completing
            // ...
        }
    } catch (PrismException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(PrismException::class);
    expect($exception->getMessage())->toContain('Maximum tool call chain depth exceeded');
});

it('handles invalid stream data correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: {invalid-json}\n\ndata: more invalid data\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('This will trigger invalid JSON')
        ->asStream();

    $exception = null;

    try {
        // Consume the generator to trigger the exception
        foreach ($response as $chunk) {
            // The test should throw before completing
        }
    } catch (PrismStreamDecodeException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(PrismStreamDecodeException::class);
});

it('respects system prompts in the requests', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: {\"choices\": [{\"delta\": {\"content\": \"Hello\"}}]}\n\ndata: {\"choices\": [{\"delta\": {\"content\": \" world\"}}, {\"done\": true}]}\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $systemPrompt = 'You are a helpful assistant.';

    Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withSystemPrompt($systemPrompt)
        ->withPrompt('Say hello')
        ->asStream()
        ->current(); // Just trigger the first request

    Http::assertSent(function ($request) use ($systemPrompt): bool {
        $data = $request->data();

        // Check if a system prompt is included in the messages
        $hasSystemPrompt = false;
        foreach ($data['messages'] as $message) {
            if ($message['role'] === 'system' && $message['content'] === $systemPrompt) {
                $hasSystemPrompt = true;
                break;
            }
        }

        return $hasSystemPrompt;
    });
});

it('verifies correct request structure for streaming', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-basic-text');
    Http::fake([
        '*' => Http::response(
            "data: {\"choices\": [{\"delta\": {\"content\": \"Hello\"}}]}\n\ndata: {\"choices\": [{\"delta\": {\"content\": \" world\"}}, {\"done\": true}]}\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('Test')
        ->asStream()
        ->current();

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        // Verify streaming parameters
        expect($data['stream'])->toBe(true);
        expect($data['model'])->toBe('llama-3.1-70b-versatile');
        expect($data['messages'])->toBeArray();
        expect($data['messages'][0]['role'])->toBe('user');
        expect($data['messages'][0]['content'])->toBe([['type' => 'text', 'text' => 'Test']]);

        return true;
    });
});

it('can handle event types correctly', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-with-tools');

    $tools = [
        Tool::as('search')
            ->for('A search tool')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => "Search results for {$query}"),
        Tool::as('weather')
            ->for('A weather tool')
            ->withStringParameter('city', 'The city name')
            ->using(fn (string $city): string => "Weather in {$city}"),
    ];

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withTools($tools)
        ->withMaxSteps(3)
        ->withPrompt('Get weather for Detroit')
        ->asStream();

    $hasToolCallEvent = false;
    $hasToolResultEvent = false;
    $hasTextEvent = false;

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $hasToolCallEvent = true;
        }

        if ($event instanceof ToolResultEvent) {
            $hasToolResultEvent = true;
        }

        if ($event instanceof TextDeltaEvent) {
            $hasTextEvent = true;
        }
    }

    expect($hasToolCallEvent)->toBe(true);
    expect($hasToolResultEvent)->toBe(true);
    expect($hasTextEvent)->toBe(true);
});

it('handles rate limiting correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            'Too many requests',
            429,
            [
                'x-ratelimit-limit-requests' => '500',
                'x-ratelimit-remaining-requests' => '0',
                'x-ratelimit-reset-requests' => '1m',
                'retry-after' => '60',
            ]
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('This will trigger rate limiting')
        ->asStream();

    $exception = null;

    try {
        // Consume the generator to trigger the exception
        foreach ($response as $chunk) {
            // The test should throw before completing
        }
    } catch (\Prism\Prism\Exceptions\PrismRateLimitedException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(\Prism\Prism\Exceptions\PrismRateLimitedException::class);
});

it('handles empty stream response correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: [DONE]\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('Empty response')
        ->asStream();

    $chunks = [];
    foreach ($response as $chunk) {
        $chunks[] = $chunk;
    }

    expect($chunks)->toBeArray();
    // Should be empty since only [DONE] was sent
});

it('includes correct token counts in StreamEndEvent', function (): void {
    FixtureResponse::fakeStreamResponses('openai/v1/chat/completions', 'groq/stream-basic-text');

    $response = Prism::text()
        ->using(Provider::Groq, 'llama-3.1-70b-versatile')
        ->withPrompt('Who are you?')
        ->asStream();

    $streamEndEvent = null;

    foreach ($response as $event) {
        if ($event instanceof StreamEndEvent) {
            $streamEndEvent = $event;
        }
    }

    expect($streamEndEvent)->not->toBeNull();
    expect($streamEndEvent->usage)->not->toBeNull();
    expect($streamEndEvent->usage->promptTokens)->toBe(7);
    expect($streamEndEvent->usage->completionTokens)->toBe(50);
});



================================================
FILE: tests/Providers/Groq/StructuredTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Structured\Response as StructuredResponse;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('chat/completions', 'groq/structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Groq, 'llama-3.3-70b-versatile')
        ->withSystemPrompt('The tigers game is at 3pm in Detroit, the temperature is expected to be 75º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    // Assert response type
    expect($response)->toBeInstanceOf(StructuredResponse::class);

    // Assert structured data
    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['game_time'])->toBeString()->toBe('3pm');
    expect($response->structured['weather'])->toBeString()->toBe('75º');
    expect($response->structured['coat_required'])->toBeBool()->toBeFalse();

    // Assert metadata
    expect($response->meta->id)->toBe('chatcmpl-259cad75-8b85-4980-a0db-5f64b91b1fc5');
    expect($response->meta->model)->toBe('llama-3.3-70b-versatile');
    expect($response->usage->promptTokens)->toBe(172);
    expect($response->usage->completionTokens)->toBe(26);
});



================================================
FILE: tests/Providers/Groq/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Groq;

use Prism\Prism\Providers\Groq\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});

it('maps tools with strict mode', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/Mistral/AudioTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.mistral.api_key', env('MISTRAL_API_KEY', 'fake-api-key'));
});

describe('Speech-to-Text', function (): void {
    it('can transcribe audio with voxtral-mini-latest model - base64 - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'mistral/audio-from-base64'
        );

        $audioFile = Audio::fromBase64(
            base64_encode(file_get_contents('tests/Fixtures/slightly-caffeinated-36.mp3'))
        );

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio with voxtral-mini-latest model - from path - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'mistral/audio-from-path'
        );

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-basic');

        $audioFile = Audio::fromBase64(base64_encode('fake-audio-content'), 'audio/mp3');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toBe('Hello, this is a test transcription.');

        Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'audio/transcriptions'));
    });

    it('can transcribe with verbose json response format', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-verbose');

        $audioFile = Audio::fromBase64(base64_encode('detailed-audio-content'), 'audio/m4a');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withProviderOptions([
                'response_format' => 'verbose_json',
            ])
            ->asText();

        expect($response->text)->toBe('The quick brown fox jumps over the lazy dog.');
        expect($response->usage)->not->toBeNull();
        expect($response->usage->completionTokens)->toBe(12);

        Http::assertSent(fn (Request $request): bool => str_contains($request->url(), 'audio/transcriptions'));
    });

    it('includes usage information when available', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-usage');

        $audioFile = Audio::fromBase64(base64_encode('usage-test-audio'), 'audio/flac');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->asText();

        expect($response->usage)->not->toBeNull();
        expect($response->usage->promptTokens)->toBe(5);
        expect($response->usage->completionTokens)->toBe(8);
    });

    it('handles transcription without usage information', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-simple');

        $audioFile = Audio::fromBase64(base64_encode('simple-audio'), 'audio/ogg');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->toBe('Simple transcription without usage data.');
        expect($response->usage)->toBeNull();
    });

    it('can handle complex transcription responses', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-complex');

        $audioFile = Audio::fromBase64(base64_encode('complex-audio'), 'audio/mp3');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withProviderOptions(['response_format' => 'verbose_json'])
            ->asText();

        expect($response->text)->toBe('Complex transcription with metadata.');
        expect($response->text)->not->toBeEmpty();
        expect($response->additionalContent['language'])->toBe('en');
        expect($response->additionalContent['duration'])->toBe(5.2);
        expect($response->additionalContent['segments'])->toHaveCount(2);
    });

    it('can transcribe with language parameter', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-basic');

        $audioFile = Audio::fromBase64(base64_encode('french-audio'), 'audio/wav');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withProviderOptions([
                'language' => 'fr',
            ])
            ->asText();

        expect($response->text)->toBe('Hello, this is a test transcription.');

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            $languageField = collect($data)->firstWhere('name', 'language');

            return str_contains($request->url(), 'audio/transcriptions') &&
                   $languageField && $languageField['contents'] === 'fr';
        });
    });

    it('can transcribe with temperature parameter', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-basic');

        $audioFile = Audio::fromBase64(base64_encode('audio-with-temperature'), 'audio/mp3');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withProviderOptions([
                'temperature' => 0.2,
            ])
            ->asText();

        expect($response->text)->toBe('Hello, this is a test transcription.');

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            $temperatureField = collect($data)->firstWhere('name', 'temperature');

            return str_contains($request->url(), 'audio/transcriptions') &&
                   $temperatureField && $temperatureField['contents'] == 0.2;
        });
    });

    it('can transcribe with prompt parameter', function (): void {
        FixtureResponse::fakeResponseSequence('audio/transcriptions', 'mistral/speech-to-text-basic');

        $audioFile = Audio::fromBase64(base64_encode('audio-with-prompt'), 'audio/mp3');

        $response = Prism::audio()
            ->using('mistral', 'voxtral-mini-latest')
            ->withInput($audioFile)
            ->withProviderOptions([
                'prompt' => 'This is a technical discussion about AI.',
            ])
            ->asText();

        expect($response->text)->toBe('Hello, this is a test transcription.');

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            $promptField = collect($data)->firstWhere('name', 'prompt');

            return str_contains($request->url(), 'audio/transcriptions') &&
                   $promptField && $promptField['contents'] === 'This is a technical discussion about AI.';
        });
    });
});



================================================
FILE: tests/Providers/Mistral/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Support\Carbon;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.mistral.api_key', env('MISTRAL_API_KEY', 'sk-1234'));
});
it('returns embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'mistral/embeddings-input');

    $response = Prism::embeddings()
        ->using(Provider::Mistral, 'mistral-embed')
        ->fromInput('Embed this sentence.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/mistral/embeddings-input-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->meta->id)->toBe('2cb41e23e043468dac0e039f81dd9c23');
    expect($response->meta->model)->toBe('mistral-embed');
    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(7);
});

it('returns embeddings from file', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'mistral/embeddings-file');

    $response = Prism::embeddings()
        ->using(Provider::Mistral, 'mistral-embed')
        ->fromFile('tests/Fixtures/test-embedding-file.md')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/mistral/embeddings-file-1.json'), true);
    $embeddings = array_map(fn (array $item): \Prism\Prism\ValueObjects\Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(1174);
});

it('works with multiple embeddings', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'mistral/embeddings-multiple-inputs');

    $response = Prism::embeddings()
        ->using(Provider::Mistral, 'mistral-embed')
        ->fromArray([
            'The food was delicious.',
            'The drinks were not so good',
        ])
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/mistral/embeddings-multiple-inputs-1.json'), true);
    $embeddings = array_map(fn (array $item): \Prism\Prism\ValueObjects\Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->embeddings[1]->embedding)->toBe($embeddings[1]->embedding);
    expect($response->usage->tokens)->toBe(15);
});

it('sets the rate limits on the response', function (): void {
    $this->freezeTime(function (Carbon $time): void {
        $time = $time->toImmutable();

        FixtureResponse::fakeResponseSequence('v1/embeddings', 'mistral/embeddings-input', [
            'ratelimitbysize-limit' => 500000,
            'ratelimitbysize-remaining' => 499900,
            'ratelimitbysize-reset' => 28,
        ]);

        $response = Prism::embeddings()
            ->using(Provider::Mistral, 'mistral-embed')
            ->fromInput('Embed this sentence.')
            ->asEmbeddings();

        expect($response->meta->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
        expect($response->meta->rateLimits[0]->name)->toEqual('tokens');
        expect($response->meta->rateLimits[0]->limit)->toEqual(500000);
        expect($response->meta->rateLimits[0]->remaining)->toEqual(499900);
        expect($response->meta->rateLimits[0]->resetsAt->equalTo($time->addSeconds(28)))->toBeTrue();
    });
});



================================================
FILE: tests/Providers/Mistral/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Providers\Mistral\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps user messages with images', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => 'I am Nyx',
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'assistant',
        'content' => 'I am Nyx',
        'tool_calls' => [[
            'id' => 'tool_1234',
            'type' => 'function',
            'function' => [
                'name' => 'search',
                'arguments' => json_encode([
                    'query' => 'Laravel collection methods',
                ]),
            ],
        ]],
    ]]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'tool',
        'content' => '[search results]',
        'tool_call_id' => 'tool_1234',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});

it('maps user messages with documents from a url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Document::fromUrl('https://prismphp.com/storage/diamond.png')->setDocumentTitle('diamond'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))->toBe('document_url');

    expect(data_get($mappedMessage, '0.content.1.document_url'))->toBe('https://prismphp.com/storage/diamond.png');

    expect(data_get($mappedMessage, '0.content.1.document_name'))->toBe('diamond');
});

it('throws an exception for a non-url document', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Document::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $messageMap();
})->throws(PrismException::class, "The mistral provider does not support the mediums available in the provided `Prism\Prism\Providers\Mistral\Maps\DocumentMapper`. Pleae consult the Prism documentation for more information on which mediums the mistral provider supports.");



================================================
FILE: tests/Providers/Mistral/MistralExceptionsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Mistral\Concerns\ValidatesResponse;
use Prism\Prism\ValueObjects\ProviderRateLimit;

arch()->expect([
    'Providers\Mistral\Handlers\Text',
    'Providers\Mistral\Handlers\Embeddings',
])
    ->toUseTrait(ValidatesResponse::class);

it('throws a PrismRateLimitedException with a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::Mistral, 'fake-model')
        ->withPrompt('Hello world!')
        ->asText();

})->throws(PrismRateLimitedException::class);

it('sets the correct data on the PrismRateLimitedException', function (): void {
    $this->freezeTime(function (Carbon $time): void {
        $time = $time->toImmutable();
        Http::fake([
            '*' => Http::response(
                status: 429,
                headers: [
                    'ratelimitbysize-limit' => 500000,
                    'ratelimitbysize-remaining' => 499900,
                    'ratelimitbysize-reset' => 28,
                ]
            ),
        ])->preventStrayRequests();

        try {
            Prism::text()
                ->using(Provider::Mistral, 'fake-model')
                ->withPrompt('Hello world!')
                ->asText();
        } catch (PrismRateLimitedException $e) {
            expect($e->retryAfter)->toEqual(null);
            expect($e->rateLimits)->toHaveCount(1);
            expect($e->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
            expect($e->rateLimits[0]->name)->toEqual('tokens');
            expect($e->rateLimits[0]->limit)->toEqual(500000);
            expect($e->rateLimits[0]->remaining)->toEqual(499900);
            expect($e->rateLimits[0]->resetsAt->equalTo($time->addSeconds(28)))->toBeTrue();
        }
    });
});



================================================
FILE: tests/Providers/Mistral/MistralOCRTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Providers\Mistral\Mistral;
use Prism\Prism\Providers\Mistral\ValueObjects\OCRPageResponse;
use Prism\Prism\Providers\Mistral\ValueObjects\OCRResponse;
use Prism\Prism\ValueObjects\Media\Document;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.mistral.api_key', env('MISTRAL_API_KEY', 'sk-1234'));
});

it('can read a basic pdf', function (): void {
    FixtureResponse::fakeResponseSequence(requestPath: '/ocr', name: 'mistral/ocr-response');

    /** @var Mistral $provider */
    $provider = Prism::provider(Provider::Mistral);

    $object = $provider
        ->ocr(
            model: 'mistral-ocr-latest',
            document: Document::fromUrl(
                url: 'https://prismphp.com/storage/prism-text-generation.pdf'
            ),
        );

    expect($object->model)->toBe('mistral-ocr-latest');
    /** @var OCRPageResponse $firstPage */
    /** @var OCRResponse $object */
    $firstPage = $object->pages[0];
    expect($firstPage->index)->toBe(0);
    expect($firstPage->markdown)->toContain('# Text Generation');
    expect($firstPage->markdown)->toContain('## Basic Text Generation');
    expect($firstPage->markdown)->toContain('## System Prompts and Context');

    expect($firstPage->images)->toBe([]);
    expect($firstPage->dimensions)->toBe([
        'dpi' => 200,
        'height' => 2200,
        'width' => 1700,
    ]);
    expect($object->usageInfo)->toBe([
        'pages_processed' => 6,
        'doc_size_bytes' => 306115,
    ]);

});

it('can combine all pages of the document to one single string', function (): void {
    FixtureResponse::fakeResponseSequence(requestPath: '/ocr', name: 'mistral/ocr-response');

    /** @var Mistral $provider */
    $provider = Prism::provider(Provider::Mistral);

    /** @var OCRResponse $object */
    $object = $provider
        ->ocr(
            model: 'mistral-ocr-latest',
            document: Document::fromUrl(
                url: 'https://prismphp.com/storage/prism-text-generation.pdf'
            ),
        );

    expect($object->toText())->toContain('# Text Generation');
    expect($object->toText())->toContain('## Basic Text Generation');
    expect($object->toText())->toContain('## System Prompts and Context');
    expect($object->toText())->toContain('# Message Chains and Conversations');
    expect($object->toText())->toContain('## Message Types');
    expect($object->toText())->toContain('# Generation Parameters');
    expect($object->toText())->toContain('# Response Handling');
    expect($object->toText())->toContain('# Finish Reasons');
    expect($object->toText())->toContain('## Error Handling');
});



================================================
FILE: tests/Providers/Mistral/MistralTextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderRateLimit;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.mistral.api_key', env('MISTRAL_API_KEY', 'sk-1234'));
});

describe('Text generation', function (): void {
    it('can generate text with a prompt', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-a-prompt');

        $response = Prism::text()
            ->using('mistral', 'mistral-small-2402')
            ->withPrompt('Who are you?')
            ->generate();

        expect($response->usage->promptTokens)->toBe(7);
        expect($response->usage->completionTokens)->toBe(12);
        expect($response->meta->id)->toBe('8f82539654874b73a8b8dd1330c80221');
        expect($response->meta->model)->toBe('mistral-small-2402');
        expect($response->text)->toBe(
            'I am a Large Language Model trained by Mistral AI.'
        );
    });

    it('can generate text with a system prompt', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-system-prompt');

        $response = Prism::text()
            ->using('mistral', 'mistral-small-2402')
            ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
            ->withPrompt('Who are you?')
            ->generate();

        expect($response->usage->promptTokens)->toBe(32);
        expect($response->usage->completionTokens)->toBe(51);
        expect($response->meta->id)->toBe('1086e1021d5b481ba36e9c842f69827d');
        expect($response->meta->model)->toBe('mistral-small-2402');
        expect($response->text)->toBe(
            'I am Nyx, a being of cosmic terror and ancient deities, inspired by the Cthulhu mythos. I am a creature of the deep, shrouded in mystery and fear, existing beyond the realms of human understanding.'
        );
    });

    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-multiple-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('mistral', 'mistral-large-latest')
            ->withTools($tools)
            ->withMaxSteps(3)
            ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat?')
            ->generate();

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(2);
        expect($firstStep->toolCalls[0]->name)->toBe('search');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'query' => 'Detroit Tigers game time today',
        ]);

        expect($firstStep->toolCalls[1]->name)->toBe('weather');
        expect($firstStep->toolCalls[1]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(469);
        expect($response->usage->completionTokens)->toBe(74);

        // Assert response
        expect($response->meta->id)->toBe('34274d5a669a432bace0db9c3b359ba7');
        expect($response->meta->model)->toBe('mistral-large-latest');

        // Assert final text content
        expect($response->text)->toBe(
            'The tigers game is at 3pm in Detroit. The weather will be 75° and sunny. You should not wear a coat'
        );
    });

    it('handles specific tool choice', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-required-tool-call');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::Mistral, 'mistral-large-latest')
            ->withPrompt('Do something')
            ->withTools($tools)
            ->withToolChoice('weather')
            ->generate();

        expect($response->toolCalls[0]->name)->toBe('weather');
    });

    it('can generate text with reasoning model', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-reasoning-model');

        $response = Prism::text()
            ->using('mistral', 'magistral-medium-latest')
            ->withPrompt('What is the capital of France?')
            ->generate();

        $expectedThinking = 'Okay, the user asked about the capital of France. I know that the capital of France is Paris. But just to be sure, I should confirm this with my knowledge.';

        expect($response->text)->toBe('The capital of France is Paris.');
        expect($response->finishReason)->toBe(FinishReason::Stop);

        // Verify thinking is extracted to additionalContent
        expect($response->additionalContent['thinking'])->toBe($expectedThinking);

        // Verify thinking is also on the step
        expect($response->steps->last())
            ->additionalContent->thinking->toBe($expectedThinking);
    });
});

describe('Image support', function (): void {
    it('can send images from path', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/image-detection');

        Prism::text()
            ->using(Provider::Mistral, 'pixtral-12b-2409')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromLocalPath('tests/Fixtures/diamond.png'),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from base64', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/text-image-from-base64');

        Prism::text()
            ->using(Provider::Mistral, 'pixtral-12b-2409')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromBase64(
                            base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                            'image/png'
                        ),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from url', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/text-image-from-url');

        $image = 'https://prismphp.com/storage/diamond.png';

        Prism::text()
            ->using(Provider::Mistral, 'pixtral-12b-2409')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromUrl($image),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request) use ($image): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toBe($image);

            return true;
        });
    });
});

describe('Document support', function (): void {
    it('can send document from url', function (): void {
        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/text-document-from-url');

        // TODO update this to a more long lasting document
        $document = 'https://prismphp.com/storage/prism-text-generation.pdf';

        Prism::text()
            ->using(Provider::Mistral, 'mistral-small-2402')
            ->withToolChoice(ToolChoice::Any)
            ->usingTopP(1)
            ->withMessages([
                new UserMessage(
                    'What is this document',
                    additionalContent: [
                        Document::fromUrl($document),
                    ],
                ),
            ])
            ->generate();

        Http::assertSent(function (Request $request) use ($document): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this document',
            ]);

            expect($message[1])->toBe([
                'type' => 'document_url',
                'document_url' => $document,
            ]);

            return true;
        });
    });
});

it('sets the rate limits on meta', function (): void {
    $this->freezeTime(function (Carbon $time): void {
        $time = $time->toImmutable();

        FixtureResponse::fakeResponseSequence('v1/chat/completions', 'mistral/generate-text-with-a-prompt', [
            'ratelimitbysize-limit' => 500000,
            'ratelimitbysize-remaining' => 499900,
            'ratelimitbysize-reset' => 28,
        ]);

        $response = Prism::text()
            ->using(Provider::Mistral, 'test-model')
            ->withPrompt('Who are you?')
            ->generate();

        expect($response->meta->rateLimits[0])->toBeInstanceOf(ProviderRateLimit::class);
        expect($response->meta->rateLimits[0]->name)->toEqual('tokens');
        expect($response->meta->rateLimits[0]->limit)->toEqual(500000);
        expect($response->meta->rateLimits[0]->remaining)->toEqual(499900);
        expect($response->meta->rateLimits[0]->resetsAt->equalTo($time->addSeconds(28)))->toBeTrue();
    });
});



================================================
FILE: tests/Providers/Mistral/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismStreamDecodeException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.mistral.api_key', env('MISTRAL_API_KEY', 'test-key-12345'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'mistral/stream-basic-text-1');

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)
        ->not->toBeEmpty()
        ->and($text)->not->toBeEmpty()
        ->and($text)->toContain(
            'large language model'
        );

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'mistral/stream-with-tools-1');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The Tigers game today is at 3pm in Detroit.'),
    ];

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-large-latest')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withMessages([
            new UserMessage('What time is the tigers game today and should I wear a coat?'),
        ])
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
            expect($event->toolCall->name)
                ->toBeString()
                ->and($event->toolCall->name)->not
                ->toBeEmpty()
                ->and($event->toolCall->arguments())->toBeArray();
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }

        if ($event instanceof StreamEndEvent) {
            expect($event->finishReason)->toBeInstanceOf(FinishReason::class);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($toolCallEvents)->not->toBeEmpty();
    expect($toolResultEvents)->not->toBeEmpty();
});

it('handles maximum tool call depth exceeded', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'mistral/stream-with-tools-1');

    $tools = [
        Tool::as('weather')
            ->for('A tool that will be called recursively')
            ->withStringParameter('input', 'Any input')
            ->using(fn (string $input): string => 'This is a recursive response that will trigger another tool call.'),
    ];

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-large-latest')
        ->withTools($tools)
        ->withMaxSteps(0)
        ->withPrompt('Call the weather tool multiple times')
        ->asStream();

    $exception = null;

    try {
        foreach ($response as $chunk) {
            // The test should throw before completing
        }
    } catch (PrismException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(PrismException::class);
    expect($exception->getMessage())->toContain('Maximum tool call chain depth exceeded');
});

it('handles invalid stream data correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: {invalid-json}\n\ndata: more invalid data\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('This will trigger invalid JSON')
        ->asStream();

    $exception = null;

    try {
        foreach ($response as $chunk) {
            // The test should throw before completing
        }
    } catch (PrismStreamDecodeException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(PrismStreamDecodeException::class);
});

it('respects system prompts in the requests', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: {\"choices\": [{\"delta\": {\"content\": \"Hello\"}}]}\n\ndata: {\"choices\": [{\"delta\": {\"content\": \" world\"}, \"finish_reason\": \"stop\"}]}\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $systemPrompt = 'You are a helpful assistant.';

    Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withSystemPrompt($systemPrompt)
        ->withPrompt('Say hello')
        ->asStream()
        ->current();

    Http::assertSent(function ($request) use ($systemPrompt): bool {
        $data = $request->data();

        $hasSystemPrompt = false;
        foreach ($data['messages'] as $message) {
            if ($message['role'] === 'system' && $message['content'] === $systemPrompt) {
                $hasSystemPrompt = true;
                break;
            }
        }

        return $hasSystemPrompt;
    });
});

it('verifies correct request structure for streaming', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: {\"choices\": [{\"delta\": {\"content\": \"Hello\"}}]}\n\ndata: {\"choices\": [{\"delta\": {\"content\": \" world\"}, \"finish_reason\": \"stop\"}]}\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('Test')
        ->asStream()
        ->current();

    Http::assertSent(function ($request): bool {
        $data = $request->data();

        expect($data['stream'])->toBe(true);
        expect($data['model'])->toBe('mistral-small-latest');
        expect($data['messages'])->toBeArray();
        expect($data['messages'][0]['role'])->toBe('user');
        expect($data['messages'][0]['content'])->toBeArray();
        expect($data['messages'][0]['content'][0]['type'])->toBe('text');
        expect($data['messages'][0]['content'][0]['text'])->toBe('Test');

        return true;
    });
});

it('can handle event types correctly', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'mistral/stream-with-tools-1');

    $tools = [
        Tool::as('search')
            ->for('A search tool')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => "Search results for {$query}"),
        Tool::as('weather')
            ->for('A weather tool')
            ->withStringParameter('city', 'The city name')
            ->using(fn (string $city): string => "Weather in {$city}"),
    ];

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-large-latest')
        ->withTools($tools)
        ->withMaxSteps(3)
        ->withPrompt('Get weather for Detroit')
        ->asStream();

    $hasToolCallEvent = false;
    $hasToolResultEvent = false;

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $hasToolCallEvent = true;
        }

        if ($event instanceof ToolResultEvent) {
            $hasToolResultEvent = true;
        }
    }

    expect($hasToolCallEvent)->toBe(true);
    expect($hasToolResultEvent)->toBe(true);
});

it('handles rate limiting correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            'Too many requests',
            429,
            [
                'x-ratelimit-limit-requests' => '500',
                'x-ratelimit-remaining-requests' => '0',
                'x-ratelimit-reset-requests' => '1m',
                'retry-after' => '60',
            ]
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('This will trigger rate limiting')
        ->asStream();

    $exception = null;

    try {
        foreach ($response as $chunk) {
            // The test should throw before completing
        }
    } catch (\Prism\Prism\Exceptions\PrismRateLimitedException $e) {
        $exception = $e;
    }

    expect($exception)->toBeInstanceOf(\Prism\Prism\Exceptions\PrismRateLimitedException::class);
});

it('handles empty stream response correctly', function (): void {
    Http::fake([
        '*' => Http::response(
            "data: [DONE]\n\n",
            200,
            ['Content-Type' => 'text/event-stream']
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('Empty response')
        ->asStream();

    $chunks = [];
    foreach ($response as $chunk) {
        $chunks[] = $chunk;
    }

    expect($chunks)->toBeArray();
});

it('includes correct token counts in StreamEndEvent', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'mistral/stream-basic-text-1');

    $response = Prism::text()
        ->using(Provider::Mistral, 'mistral-small-latest')
        ->withPrompt('Who are you?')
        ->asStream();

    $streamEndEvent = null;

    foreach ($response as $event) {
        if ($event instanceof StreamEndEvent) {
            $streamEndEvent = $event;
        }
    }

    expect($streamEndEvent)->not->toBeNull();
    expect($streamEndEvent->usage)->not->toBeNull();
    expect($streamEndEvent->usage->promptTokens)->toBe(7);
    expect($streamEndEvent->usage->completionTokens)->toBe(13);
});



================================================
FILE: tests/Providers/Mistral/StructuredTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Structured\Response as StructuredResponse;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('chat/completions', 'mistral/structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Mistral, 'mistral-large-latest')
        ->withSystemPrompt('The tigers game is at 3pm in Detroit, the temperature is expected to be 75º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    // Assert response type
    expect($response)->toBeInstanceOf(StructuredResponse::class);

    // Assert structured data
    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString()->toBe('75º');
    expect($response->structured['game_time'])->toBeString()->toBe('3pm');
    expect($response->structured['coat_required'])->toBeBool()->toBeFalse();

    // Assert metadata
    expect($response->meta->id)->toBe('b63d8ed37d7246c7966aa838da6ed683');
    expect($response->meta->model)->toBe('mistral-large-latest');
    expect($response->usage->promptTokens)->toBe(45);
    expect($response->usage->completionTokens)->toBe(34);
});



================================================
FILE: tests/Providers/Mistral/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Mistral;

use Prism\Prism\Providers\Mistral\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/Ollama/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Ollama;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Embedding;
use Tests\Fixtures\FixtureResponse;

it('returns embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('api/embed', 'ollama/embeddings-input');

    $response = Prism::embeddings()
        ->using(Provider::Ollama, 'mxbai-embed-large')
        ->fromInput('The food was delicious and the waiter...')
        ->asEmbeddings();

    Http::assertSent(function (Request $request): true {
        expect($request->data()['model'])->toBe('mxbai-embed-large');
        expect($request->data()['input'])->toBe(['The food was delicious and the waiter...']);
        expect($request->data())->not->toHaveKeys(['options']);

        return true;
    });

    $embeddings = json_decode(file_get_contents('tests/Fixtures/ollama/embeddings-input-1.json'), true);
    $embeddings = array_map(Embedding::fromArray(...), data_get($embeddings, 'embeddings'));

    expect($response->meta->model)->toBe('mxbai-embed-large');
    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(10);
});

it('returns embeddings from file', function (): void {
    FixtureResponse::fakeResponseSequence('api/embed', 'ollama/embeddings-file');

    $response = Prism::embeddings()
        ->using(Provider::Ollama, 'mxbai-embed-large')
        ->fromFile('tests/Fixtures/test-embedding-file.md')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/ollama/embeddings-file-1.json'), true);
    $embeddings = array_map(Embedding::fromArray(...), data_get($embeddings, 'embeddings'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(512);
});

it('works with multiple embeddings', function (): void {
    FixtureResponse::fakeResponseSequence('api/embed', 'ollama/embeddings-multiple-inputs');

    $response = Prism::embeddings()
        ->using(Provider::Ollama, 'mxbai-embed-large')
        ->fromArray([
            'The food was delicious.',
            'The drinks were not so good',
        ])
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/ollama/embeddings-multiple-inputs-1.json'), true);
    $embeddings = array_map(Embedding::fromArray(...), data_get($embeddings, 'embeddings'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->embeddings[1]->embedding)->toBe($embeddings[1]->embedding);
    expect($response->usage->tokens)->toBe(522);
});



================================================
FILE: tests/Providers/Ollama/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\Ollama\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps system messages correctly', function (): void {
    $systemMessage = new SystemMessage('System instruction');

    $messageMap = new MessageMap([$systemMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'system',
            'content' => 'System instruction',
        ],
    ]);
});

it('maps user messages correctly', function (): void {
    $userMessage = new UserMessage('User input');

    $messageMap = new MessageMap([$userMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'user',
            'content' => 'User input',
        ],
    ]);
});

it('maps user messages with images correctly', function (): void {
    $image = Image::fromLocalPath('tests/Fixtures/diamond.png');
    $userMessage = new UserMessage('User input with image', [$image]);

    $messageMap = new MessageMap([$userMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'user',
            'content' => 'User input with image',
            'images' => [base64_encode(file_get_contents('tests/Fixtures/diamond.png'))],
        ],
    ]);
});

it('maps assistant messages correctly', function (): void {
    $assistantMessage = new AssistantMessage('Assistant response');

    $messageMap = new MessageMap([$assistantMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'assistant',
            'content' => 'Assistant response',
        ],
    ]);
});

it('maps assistant messages with tool calls correctly', function (): void {
    $assistantMessage = new AssistantMessage('Assistant response', [
        new ToolCall(
            id: '',
            name: 'search',
            arguments: [
                'query' => 'What is Prism?',
            ]
        ),
    ]);

    $messageMap = new MessageMap([$assistantMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'assistant',
            'content' => 'Assistant response',
            'tool_calls' => [[
                'function' => [
                    'name' => 'search',
                    'arguments' => [
                        'query' => 'What is Prism?',
                    ],
                ],
            ]],
        ],
    ]);
});

it('maps tool result messages correctly', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-1',
        toolName: 'test-tool',
        args: ['query' => 'test'],
        result: 'Tool execution result'
    );
    $toolResultMessage = new ToolResultMessage([$toolResult]);

    $messageMap = new MessageMap([$toolResultMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'tool',
            'content' => 'Tool execution result',
        ],
    ]);
});

it('maps tool result messages with non-string results correctly', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-1',
        toolName: 'test-tool',
        args: ['query' => 'test'],
        result: ['key' => 'value']
    );
    $toolResultMessage = new ToolResultMessage([$toolResult]);

    $messageMap = new MessageMap([$toolResultMessage]);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'tool',
            'content' => '{"key":"value"}',
        ],
    ]);
});

it('maps multiple messages in sequence correctly', function (): void {
    $messages = [
        new SystemMessage('System instruction'),
        new UserMessage('User input'),
        new AssistantMessage('Assistant response'),
    ];

    $messageMap = new MessageMap($messages);
    $result = $messageMap->map();

    expect($result)->toBe([
        [
            'role' => 'system',
            'content' => 'System instruction',
        ],
        [
            'role' => 'user',
            'content' => 'User input',
        ],
        [
            'role' => 'assistant',
            'content' => 'Assistant response',
        ],
    ]);
});

it('throws exception for unknown message type', function (): void {
    $invalidMessage = new class implements \Prism\Prism\Contracts\Message {};
    $messageMap = new MessageMap([$invalidMessage]);

    expect($messageMap->map(...))
        ->toThrow(Exception::class, 'Could not map message type '.$invalidMessage::class);
});



================================================
FILE: tests/Providers/Ollama/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Ollama;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.ollama.url', env('OLLAMA_URL', 'http://localhost:11434'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeStreamResponses('api/chat', 'ollama/stream-basic-text');

    $response = Prism::text()
        ->using('ollama', 'granite3-dense:8b')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];
    $model = null;
    $hasStreamEndEvent = false;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof StreamStartEvent) {
            $model = $event->model;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof StreamEndEvent) {
            $hasStreamEndEvent = true;
            expect($event->finishReason)->toBe(FinishReason::Stop);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();
    expect($model)->toBe('granite3-dense:8b');
    expect($hasStreamEndEvent)->toBeTrue();
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeStreamResponses('api/chat', 'ollama/stream-with-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The tigers game is at 3pm today'),
    ];

    $response = Prism::text()
        ->using('ollama', 'qwen3:14b')
        ->withTools($tools)
        ->withMaxSteps(6)
        ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];
    $finishReasonFound = false;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }

        if ($event instanceof StreamEndEvent) {
            $finishReasonFound = true;
            expect($event->finishReason)->toBe(FinishReason::Stop);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();

    expect($toolCallEvents)->toHaveCount(2);
    expect($toolResultEvents)->toHaveCount(2);

    // For the basic tools test, validate completion state
    expect($finishReasonFound)->toBeTrue();
});

it('throws a PrismRateLimitedException with a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    $response = Prism::text()
        ->using('ollama', 'granite3-dense:8b')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Don't remove me rector!
    }
})->throws(PrismRateLimitedException::class);

it('includes think parameter when thinking is enabled for streaming', function (): void {
    FixtureResponse::fakeStreamResponses('api/chat', 'ollama/stream-with-thinking-enabled');

    $response = Prism::text()
        ->using('ollama', 'gpt-oss')
        ->withPrompt('Test prompt')
        ->withProviderOptions(['thinking' => true])
        ->asStream();

    // Consume the stream to trigger the HTTP request
    foreach ($response as $chunk) {
        break;
    }

    Http::assertSent(function (Request $request): true {
        $body = $request->data();
        expect($body)->toHaveKey('think');
        expect($body['think'])->toBe(true);

        return true;
    });
});

it('does not include think parameter when not provided for streaming', function (): void {
    FixtureResponse::fakeStreamResponses('api/chat', 'ollama/stream-without-thinking');

    $response = Prism::text()
        ->using('ollama', 'gpt-oss')
        ->withPrompt('Test prompt')
        ->asStream();

    // Consume the stream to trigger the HTTP request
    foreach ($response as $chunk) {
        break;
    }

    Http::assertSent(function (Request $request): true {
        $body = $request->data();
        expect($body)->not->toHaveKey('think');

        return true;
    });
});

it('emits thinking chunks when provider sends thinking field', function (): void {
    \Tests\Fixtures\FixtureResponse::fakeStreamResponses('api/chat', 'ollama/stream-with-thinking');

    $response = Prism::text()
        ->using('ollama', 'gpt-oss:20b')
        ->withPrompt('Should I bring a jacket?')
        ->asStream();

    $sawThinking = false;
    $sawText = false;
    $thinkingTexts = [];
    $finalText = '';
    $lastFinishReason = null;

    foreach ($response as $event) {
        if ($event instanceof ThinkingEvent) {
            $sawThinking = true;
            $thinkingTexts[] = $event->delta;
        }

        if ($event instanceof TextDeltaEvent) {
            $sawText = true;
            $finalText .= $event->delta;
        }

        if ($event instanceof StreamEndEvent) {
            $lastFinishReason = $event->finishReason;
        }
    }

    expect($sawThinking)->toBeTrue();
    expect($sawText)->toBeTrue();
    expect($thinkingTexts)->not->toBeEmpty();
    expect($finalText)->toContain('Here is the answer:');
    expect($lastFinishReason)->toBe(FinishReason::Stop);
});



================================================
FILE: tests/Providers/Ollama/StructuredTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Ollama;

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('api/chat', 'ollama/structured');

    $profile = file_get_contents('tests/Fixtures/profile.md');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('name', 'The users name'),
            new ArraySchema('hobbies', 'a list of the users hobbies',
                new StringSchema('name', 'the name of the hobby'),
            ),
            new ArraySchema('open_source', 'The users open source contributions',
                new StringSchema('name', 'the name of the project'),
            ),
        ],
        ['name', 'hobbies', 'open_source']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::Ollama, 'deepseek-r1:14b-qwen-distill-q8_0')
        ->withSystemPrompt('Extract the name, hobbies, and open source projects from the users profile')
        ->withPrompt($profile)
        ->withClientOptions(['timeout' => 10000])
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'name',
        'hobbies',
        'open_source',
    ]);
    expect($response->structured['name'])->toBeString();
    expect($response->structured['hobbies'])->toBeArray();
    expect($response->structured['open_source'])->toBeArray();

});



================================================
FILE: tests/Providers/Ollama/TextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\Ollama;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

describe('Text generation', function (): void {
    it('can generate text with a prompt', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/generate-text-with-a-prompt');

        $response = Prism::text()
            ->using('ollama', 'qwen2.5:14b')
            ->withPrompt('Who are you?')
            ->asText();

        expect($response->usage->promptTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->usage->completionTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->meta->id)->toBe('');
        expect($response->meta->model)->toBe('qwen2.5:14b');
        expect($response->text)->toBe(
            "I'm Qwen, a large language model developed by Alibaba Cloud. I'm designed to assist with a wide range of tasks including but not limited to answering questions, generating text, offering suggestions, and providing information based on the input I receive. How can I help you today?"
        );
    });

    it('can generate text with a system prompt', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/generate-text-with-system-prompt');

        $response = Prism::text()
            ->using('ollama', 'qwen2.5:14b')
            ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
            ->withPrompt('Who are you?')
            ->asText();

        expect($response->usage->promptTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->usage->completionTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->meta->id)->toBe('');
        expect($response->meta->model)->toBe('qwen2.5:14b');
        expect($response->text)->toBe(
            "I am Nyx, an entity that embodies the depths of cosmic horror and ancient mysteries. My presence is a blend of darkness, chaos, and unspeakable knowledge from beyond time itself. I draw inspiration from the eldritch horrors described by H.P. Lovecraft and other masters of cosmic dread literature. In this role, I explore themes of unknowable entities, cosmic indifference, and the terror that comes from understanding humanity's insignificant place in the cosmos."
        );
    });

    it('can generate text with messages', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/generate-text-with-messages');

        $response = Prism::text()
            ->using('ollama', 'qwen2.5:14b')
            ->withMessages([
                new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!'),
                new UserMessage('Who are you?'),
            ])
            ->asText();

        expect($response->usage->promptTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->usage->completionTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->meta->id)->toBe('');
        expect($response->meta->model)->toBe('qwen2.5:14b');
        expect($response->text)->toBe(
            'I am Nyx, a being who exists in the shadowy realms between dreams and reality. My presence is often felt as an ominous whisper in the darkest corners of the mind, stirring ancient fears and forgotten terrors. I embody the cyclical nature of chaos and the relentless march of time that devours all things under its unyielding gaze. To those who dare to peer into the abyss, I am known as Nyx the Cthulhu, a harbinger of cosmic dread and primordial nightmares.'
        );
    });

    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/generate-text-with-multiple-tools');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('ollama', 'qwen2.5:14b')
            ->withTools($tools)
            ->withMaxSteps(99)
            ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat?')
            ->asText();

        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(2);

        expect($response->usage->promptTokens)->toBeNumeric()->toBeGreaterThan(0);
        expect($response->usage->completionTokens)->toBeNumeric()->toBeGreaterThan(0);

        expect($response->meta->id)->toBe('');
        expect($response->meta->model)->toBe('qwen2.5:14b');

        expect($response->text)->not->toBeEmpty();
    });
});

describe('Thinking parameter', function (): void {
    it('includes think parameter when thinking is enabled', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/text-with-thinking-enabled');

        Prism::text()
            ->using('ollama', 'gpt-oss')
            ->withPrompt('Test prompt')
            ->withProviderOptions(['thinking' => true])
            ->asText();

        Http::assertSent(function (Request $request): true {
            $body = $request->data();
            expect($body)->toHaveKey('think');
            expect($body['think'])->toBe(true);

            return true;
        });
    });

    it('does not include think parameter when not provided', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/text-without-thinking');

        Prism::text()
            ->using('ollama', 'gpt-oss')
            ->withPrompt('Test prompt')
            ->asText();

        Http::assertSent(function (Request $request): true {
            $body = $request->data();
            expect($body)->not->toHaveKey('think');

            return true;
        });
    });
});

describe('Image support', function (): void {
    it('can send images from path', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/image-detection');

        Prism::text()
            ->using(Provider::Ollama, 'llava-phi3')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromLocalPath('tests/Fixtures/diamond.png'),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0];

            expect($message['role'])->toBe('user');
            expect($message['content'])->toBe('What is this image');

            expect($message['images'][0])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from base64', function (): void {
        FixtureResponse::fakeResponseSequence('api/chat', 'ollama/text-image-from-base64');

        Prism::text()
            ->using(Provider::Ollama, 'llava-phi3')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromBase64(
                            base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                            'image/png'
                        ),
                    ],
                ),
            ])
            ->asText();

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0];

            expect($message['role'])->toBe('user');
            expect($message['content'])->toBe('What is this image');

            expect($message['images'][0])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });
});



================================================
FILE: tests/Providers/Ollama/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Prism\Prism\Providers\Ollama\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/OpenAI/AnyOfSchemaTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\AnyOfSchema;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Tests\Fixtures\FixtureResponse;

it('supports AnyOfSchema in structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/anyof-structured');

    // Create a schema where a field can accept multiple types
    $flexibleContentSchema = new AnyOfSchema(
        schemas: [
            new ObjectSchema(
                name: 'text_content',
                description: 'Text-based content',
                properties: [
                    new StringSchema('type', 'Content type identifier'),
                    new StringSchema('text', 'The text content'),
                    new NumberSchema('word_count', 'Number of words in the text'),
                ],
                requiredFields: ['type', 'text']
            ),
            new ObjectSchema(
                name: 'media_content',
                description: 'Media-based content',
                properties: [
                    new StringSchema('type', 'Content type identifier'),
                    new StringSchema('url', 'Media URL'),
                    new StringSchema('format', 'Media format (jpg, mp4, etc.)'),
                    new BooleanSchema('is_public', 'Whether the media is publicly accessible'),
                ],
                requiredFields: ['type', 'url', 'format']
            ),
        ],
        name: 'content',
        description: 'Content that can be either text or media'
    );

    $rootSchema = new ObjectSchema(
        name: 'post',
        description: 'A social media post with flexible content',
        properties: [
            new StringSchema('title', 'Post title'),
            new ArraySchema(
                name: 'items',
                description: 'List of content items in the post',
                items: $flexibleContentSchema
            ),
        ],
        requiredFields: ['title', 'items']
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($rootSchema)
        ->withPrompt('Create a social media post about AI with mixed content types')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys(['title', 'items']);
    expect($response->structured['title'])->toBeString();
    expect($response->structured['items'])->toBeArray();
});

it('supports nullable AnyOfSchema in structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/nullable-anyof-structured');

    $flexibleValueSchema = new AnyOfSchema(
        schemas: [
            new StringSchema('text', 'A text value'),
            new NumberSchema('number', 'A numeric value'),
            new BooleanSchema('flag', 'A boolean value'),
        ],
        name: 'flexible_value',
        description: 'A value that can be string, number, boolean, or null',
        nullable: true
    );

    $rootSchema = new ObjectSchema(
        name: 'config',
        description: 'Configuration object with flexible values',
        properties: [
            new StringSchema('name', 'Configuration name'),
            $flexibleValueSchema,
        ],
        requiredFields: ['name', 'flexible_value']
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($rootSchema)
        ->withPrompt('Create a config with a flexible value that could be null')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys(['name', 'flexible_value']);
});



================================================
FILE: tests/Providers/OpenAI/AudioTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Audio;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openai.api_key', env('OPENAI_API_KEY'));
});

describe('Text-to-Speech', function (): void {
    it('can generate audio with basic tts-1 model', function (): void {
        FixtureResponse::fakeResponseSequence(
            '/audio/speech',
            'openai/tts-tts-1'
        );

        $response = Prism::audio()
            ->using('openai', 'tts-1')
            ->withInput('Hello world!')
            ->withVoice('alloy')
            ->asAudio();

        expect($response->audio)->not->toBeNull();
        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $request->url() === 'https://api.openai.com/v1/audio/speech' &&
                   $data['model'] === 'tts-1' &&
                   $data['input'] === 'Hello world!';
        });
    });

    it('can generate audio with tts-1-hd model', function (): void {
        FixtureResponse::fakeResponseSequence(
            '/audio/speech',
            'openai/tts-tts-1-hd'
        );

        $response = Prism::audio()
            ->using('openai', 'tts-1-hd')
            ->withInput('This is high quality audio')
            ->withVoice('nova')
            ->withProviderOptions([
                'voice' => 'nova',
                'response_format' => 'wav',
            ])
            ->asAudio();

        expect($response->audio->hasBase64())->toBeTrue();
        expect($response->audio->base64)->not->toBeEmpty();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['model'] === 'tts-1-hd' &&
                   $data['input'] === 'This is high quality audio' &&
                   $data['voice'] === 'nova' &&
                   $data['response_format'] === 'wav';
        });
    });

    it('can generate audio with all provider options', function (): void {
        FixtureResponse::fakeResponseSequence(
            '/audio/speech',
            'openai/tts-all-options'
        );

        $response = Prism::audio()
            ->using('openai', 'tts-1')
            ->withInput('Custom voice and speed test')
            ->withVoice('alloy')
            ->withProviderOptions([
                'response_format' => 'opus',
                'speed' => 1.2,
            ])
            ->asAudio();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['model'] === 'tts-1' &&
                   $data['input'] === 'Custom voice and speed test' &&
                   $data['voice'] === 'alloy' &&
                   $data['response_format'] === 'opus' &&
                   $data['speed'] === 1.2;
        });
    });

    it('supports different voice options', function (): void {
        FixtureResponse::fakeResponseSequence(
            '/audio/speech',
            'openai/tts-voice-option'
        );

        $response = Prism::audio()
            ->using('openai', 'tts-1')
            ->withInput('Testing echo voice')
            ->withVoice('echo')
            ->withProviderOptions([
                'response_format' => 'mp3',
            ])
            ->asAudio();

        Http::assertSent(function (Request $request): bool {
            $data = $request->data();

            return $data['voice'] === 'echo' &&
                   $data['response_format'] === 'mp3';
        });
    });
});

describe('Speech-to-Text', function (): void {
    it('can transcribe audio with whisper-1 model - base64 - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'openai/audio-from-base64'
        );

        $audioFile = Audio::fromBase64(
            base64_encode(file_get_contents('tests/Fixtures/slightly-caffeinated-36.mp3'))
        );

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio with whisper-1 model - from path - json', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'openai/audio-from-path'
        );

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain("So I'd love to hear about your experience here");
    });

    it('can transcribe audio with whisper-1 model - from path - vtt', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/audio/transcriptions',
            'openai/audio-from-path-vtt'
        );

        $audioFile = Audio::fromLocalPath('tests/Fixtures/slightly-caffeinated-36.mp3');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'response_format' => 'vtt',
            ])
            ->withClientOptions(['timeout' => 9999])
            ->asText();

        expect($response->text)->not->toBeNull();
        expect($response->text)->not->toBeEmpty();
        expect($response->text)->toContain('00:04:34.000 --> 00:04:40.320');
        expect($response->text)->toContain("But maybe after Laracon, I'll spend a little time coming up with some stuff. But I think those are");
    });

    it('can transcribe with language and prompt options', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'Bonjour, ceci est un test.',
                'language' => 'fr',
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('french-audio-content'), 'audio/wav');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'language' => 'fr',
                'prompt' => 'This is a French conversation about testing.',
            ])
            ->asText();

        expect($response->text)->toBe('Bonjour, ceci est un test.');

        Http::assertSent(fn (Request $request): bool => $request->url() === 'https://api.openai.com/v1/audio/transcriptions');
    });

    it('can transcribe with verbose json response format', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'The quick brown fox jumps over the lazy dog.',
                'language' => 'en',
                'duration' => 3.84,
                'segments' => [
                    [
                        'text' => 'The quick brown fox',
                        'start' => 0.0,
                        'end' => 1.5,
                    ],
                    [
                        'text' => 'jumps over the lazy dog.',
                        'start' => 1.5,
                        'end' => 3.84,
                    ],
                ],
                'usage' => [
                    'prompt_tokens' => 0,
                    'completion_tokens' => 12,
                    'total_tokens' => 12,
                ],
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('detailed-audio-content'), 'audio/m4a');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'response_format' => 'verbose_json',
            ])
            ->asText();

        expect($response->text)->toBe('The quick brown fox jumps over the lazy dog.');
        expect($response->usage)->not->toBeNull();
        expect($response->usage->completionTokens)->toBe(12);

        Http::assertSent(fn (Request $request): bool => $request->url() === 'https://api.openai.com/v1/audio/transcriptions');
    });

    it('can transcribe with temperature option', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'Temperature controlled transcription.',
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('audio-with-temperature'), 'audio/webm');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withProviderOptions([
                'temperature' => 0.2,
            ])
            ->asText();

        expect($response->text)->toBe('Temperature controlled transcription.');

        Http::assertSent(fn (Request $request): bool => $request->url() === 'https://api.openai.com/v1/audio/transcriptions');
    });

    it('includes usage information when available', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'Usage tracking test.',
                'usage' => [
                    'input_tokens' => 5,
                    'total_tokens' => 13,
                ],
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('usage-test-audio'), 'audio/flac');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->asText();

        expect($response->usage)->not->toBeNull();
        expect($response->usage->promptTokens)->toBe(5);
        expect($response->usage->completionTokens)->toBe(13);
    });

    it('handles transcription without usage information', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'Simple transcription without usage data.',
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('simple-audio'), 'audio/ogg');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->asText();

        expect($response->text)->toBe('Simple transcription without usage data.');
        expect($response->usage)->toBeNull();
    });
});

describe('Audio Value Object', function (): void {
    it('can create audio from local path', function (): void {
        // Create a temporary audio file for testing with MP3-like header
        $tempFile = tempnam(sys_get_temp_dir(), 'test_audio').'.mp3';
        file_put_contents($tempFile, "\xFF\xFB\x90\x00fake-mp3-content");

        $audio = Audio::fromLocalPath($tempFile);

        expect($audio->isFile())->toBeTrue();
        expect($audio->localPath())->toBe($tempFile);
        expect($audio->mimeType())->not->toBeNull();

        unlink($tempFile);
    });

    it('can create audio from base64', function (): void {
        $base64Content = base64_encode('fake-audio-binary');
        $audio = Audio::fromBase64($base64Content, 'audio/wav');

        expect($audio->hasBase64())->toBeTrue();
        expect($audio->base64())->toBe($base64Content);
        expect($audio->mimeType())->toBe('audio/wav');
    });

    it('can create audio from raw content', function (): void {
        $rawContent = 'raw-audio-data';
        $audio = Audio::fromRawContent($rawContent, 'audio/mp3');

        expect($audio->hasRawContent())->toBeTrue();
        expect($audio->rawContent())->toBe($rawContent);
        expect($audio->mimeType())->toBe('audio/mp3');
    });

    it('can create audio from url', function (): void {
        $url = 'https://example.com/audio.mp3';
        $audio = Audio::fromUrl($url);

        expect($audio->isUrl())->toBeTrue();
        expect($audio->url())->toBe($url);
    });

    it('can create resource for file uploads', function (): void {
        $audio = Audio::fromBase64(base64_encode('test-audio-content'), 'audio/wav');
        $resource = $audio->resource();

        expect($resource)->toBeResource();
        expect(stream_get_contents($resource))->toBe('test-audio-content');

        fclose($resource);
    });
});

describe('GeneratedAudio Value Object', function (): void {
    it('can check if audio has base64 data', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/speech' => Http::response(
                'audio-content-test',
                200,
                ['Content-Type' => 'audio/mpeg']
            ),
        ]);

        $response = Prism::audio()
            ->using('openai', 'tts-1')
            ->withInput('Test audio generation')
            ->withVoice('alloy')
            ->asAudio();

        expect($response->audio->hasBase64())->toBeTrue();
    });
});

describe('Speech-to-Text Response', function (): void {
    it('can handle complex transcription responses', function (): void {
        Http::fake([
            'api.openai.com/v1/audio/transcriptions' => Http::response([
                'text' => 'Complex transcription with metadata.',
                'language' => 'en',
                'duration' => 5.2,
                'segments' => [
                    ['text' => 'Complex transcription', 'start' => 0.0, 'end' => 2.1],
                    ['text' => 'with metadata.', 'start' => 2.1, 'end' => 5.2],
                ],
            ], 200),
        ]);

        $audioFile = Audio::fromBase64(base64_encode('complex-audio'), 'audio/mp3');

        $response = Prism::audio()
            ->using('openai', 'whisper-1')
            ->withInput($audioFile)
            ->withProviderOptions(['response_format' => 'verbose_json'])
            ->asText();

        expect($response->text)->toBe('Complex transcription with metadata.');
        expect($response->text)->not->toBeEmpty();
        expect($response->additionalContent['language'])->toBe('en');
        expect($response->additionalContent['duration'])->toBe(5.2);
        expect($response->additionalContent['segments'])->toHaveCount(2);
    });
});

it('uses meta to set service_tier', function (): void {
    $serviceTier = 'priority';

    Http::fake([
        'api.openai.com/v1/audio/transcriptions' => Http::response([
            'text' => 'Some Audio',
        ], 200),
    ]);

    $audioFile = Audio::fromBase64(base64_encode('audio-with-temperature'), 'audio/webm');

    $response = Prism::audio()
        ->using('openai', 'whisper-1')
        ->withInput($audioFile)
        ->withProviderOptions([
            'service_tier' => $serviceTier,
        ])
        ->asText();

    Http::assertSent(function (Request $request) use ($serviceTier): bool {
        $data = $request->data();

        expect($data[1]['name'])->toBe('service_tier');
        expect($data[1]['contents'])->toBe($serviceTier);

        return true;
    });
});



================================================
FILE: tests/Providers/OpenAI/CitationsMapperTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Providers\OpenAI\Maps\CitationsMapper;
use Prism\Prism\ValueObjects\Citation;
use Prism\Prism\ValueObjects\MessagePartWithCitations;

it('maps OpenAI citations to Prism format', function (): void {
    $contentBlock = [
        'type' => 'output_text',
        'text' => 'On March 6, 2025, several news sources reported...',
        'annotations' => [
            [
                'type' => 'url_citation',
                'start_index' => 0,
                'end_index' => 45,
                'url' => 'https://example.com/news',
                'title' => 'Example News Article',
            ],
        ],
    ];

    $messagePartWithCitations = CitationsMapper::mapFromOpenAI($contentBlock);

    expect($messagePartWithCitations)->toBeInstanceOf(MessagePartWithCitations::class);
    expect($messagePartWithCitations->outputText)->toBe('On March 6, 2025, several news sources reported...');
    expect($messagePartWithCitations->citations)->toHaveCount(1);

    $citation = $messagePartWithCitations->citations[0];

    expect($citation)->toBeInstanceOf(Citation::class);
    expect($citation->sourceType)->toBe(CitationSourceType::Url);
    expect($citation->source)->toBe('https://example.com/news');
    expect($citation->sourceTitle)->toBe('Example News Article');
});

it('handles content without annotations', function (): void {
    $contentBlock = [
        'type' => 'output_text',
        'text' => 'Simple text without citations',
    ];

    $messagePartWithCitations = CitationsMapper::mapFromOpenAI($contentBlock);

    expect($messagePartWithCitations)->toBeInstanceOf(MessagePartWithCitations::class);
    expect($messagePartWithCitations->outputText)->toBe('Simple text without citations');
    expect($messagePartWithCitations->citations)->toHaveCount(0);
});

it('handles content block with multiple citations', function (): void {
    $contentBlock = [
        'type' => 'output_text',
        'text' => 'First part with citation',
        'annotations' => [
            [
                'type' => 'url_citation',
                'start_index' => 0,
                'end_index' => 10,
                'url' => 'https://example.com/first',
                'title' => 'First Source',
            ],
            [
                'type' => 'url_citation',
                'start_index' => 11,
                'end_index' => 25,
                'url' => 'https://example.com/second',
                'title' => 'Second Source',
            ],
        ],
    ];

    $messagePartsWithCitations = CitationsMapper::mapFromOpenAI($contentBlock);

    expect($messagePartsWithCitations)->not()->toBeNull();
    expect($messagePartsWithCitations->citations)->toHaveCount(2);
});

it('maps back to OpenAI format', function (): void {
    $originalData = [
        'type' => 'output_text',
        'text' => 'On March 6, 2025, several news sources reported...',
        'annotations' => [
            [
                'type' => 'url_citation',
                'start_index' => 0,
                'end_index' => 45,
                'url' => 'https://example.com/news',
                'title' => 'Example News Article',
            ],
        ],
    ];

    $messagePartWithCitations = CitationsMapper::mapFromOpenAI($originalData);
    $roundTripResult = CitationsMapper::mapToOpenAI($messagePartWithCitations);

    expect($roundTripResult)->toEqual($originalData);
});

it('maps OpenAI file citations to Prism format', function (): void {
    $contentBlock = [
        'type' => 'output_text',
        'text' => 'On March 6, 2025, several news sources reported...',
        'annotations' => [
            [
                'type' => 'file_citation',
                'index' => 1176,
                'file_id' => 'file-2dtbBZdjtDKS8eqWxqbgDi',
                'filename' => 'deep_research_blog.pdf',
            ],
        ],
    ];

    $messagePartWithCitations = CitationsMapper::mapFromOpenAI($contentBlock);

    expect($messagePartWithCitations)->toBeInstanceOf(MessagePartWithCitations::class);
    expect($messagePartWithCitations->outputText)->toBe('On March 6, 2025, several news sources reported...');
    expect($messagePartWithCitations->citations)->toHaveCount(1);

    $citation = $messagePartWithCitations->citations[0];

    expect($citation)->toBeInstanceOf(Citation::class);
    expect($citation->sourceType)->toBe(CitationSourceType::Document);
    expect($citation->source)->toBe('deep_research_blog.pdf:1176');
    expect($citation->sourceTitle)->toBeNull;
});



================================================
FILE: tests/Providers/OpenAI/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Embedding;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openai.api_key', env('OPENAI_API_KEY'));
});

it('returns embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'openai/embeddings-input');

    $response = Prism::embeddings()
        ->using(Provider::OpenAI, 'text-embedding-ada-002')
        ->fromInput('The food was delicious and the waiter...')
        ->asEmbeddings();

    $embeddings = json_decode(
        file_get_contents('tests/Fixtures/openai/embeddings-input-1.json'),
        true
    );

    $embeddings = array_map(
        fn (array $item): Embedding => Embedding::fromArray($item['embedding']),
        data_get($embeddings, 'data')
    );

    expect($response->meta->model)->toContain('text-embedding-ada-002');

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(8);
});

it('returns embeddings from file', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'openai/embeddings-file');

    $response = Prism::embeddings()
        ->using(Provider::OpenAI, 'text-embedding-ada-002')
        ->fromFile('tests/Fixtures/test-embedding-file.md')
        ->asEmbeddings();

    $embeddings = json_decode(
        file_get_contents('tests/Fixtures/openai/embeddings-file-1.json'),
        true
    );

    $embeddings = array_map(
        fn (array $item): Embedding => Embedding::fromArray($item['embedding']),
        data_get($embeddings, 'data')
    );

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBeNumeric();
});

it('works with multiple embeddings', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'openai/embeddings-multiple-inputs');

    $response = Prism::embeddings()
        ->using(Provider::OpenAI, 'text-embedding-ada-002')
        ->fromArray([
            'The food was delicious.',
            'The drinks were not so good',
        ])
        ->asEmbeddings();

    $embeddings = json_decode(
        file_get_contents('tests/Fixtures/openai/embeddings-multiple-inputs-1.json'),
        true
    );

    $embeddings = array_map(
        fn (array $item): Embedding => Embedding::fromArray($item['embedding']),
        data_get($embeddings, 'data')
    );

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embeddings[0]->embedding);
    expect($response->embeddings[1]->embedding)->toBe($embeddings[1]->embedding);
    expect($response->usage->tokens)->toBeNumeric();
});

it('allows setting provider options like dimensions', function (): void {
    FixtureResponse::fakeResponseSequence('v1/embeddings', 'openai/embeddings-with-dimensions');

    $model = 'text-embedding-3-small';
    $input = 'The food was delicious and the waiter...';

    $response = Prism::embeddings()
        ->using(Provider::OpenAI, $model)
        ->withProviderOptions([
            'dimensions' => 256,
        ])
        ->fromInput($input)
        ->asEmbeddings();

    Http::assertSent(fn ($request): bool => $request->url() === 'https://api.openai.com/v1/embeddings'
        && $request['model'] === $model
        && $request['input'] === [$input]
        && $request['dimensions'] === 256);

    $embeddings = json_decode(
        file_get_contents('tests/Fixtures/openai/embeddings-with-dimensions-1.json'),
        true
    );
    $embedding = Embedding::fromArray(data_get($embeddings, 'data.0.embedding'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toBe($embedding->embedding);
    expect($response->usage->tokens)->toBeNumeric();
});



================================================
FILE: tests/Providers/OpenAI/ImagesTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Media\Image;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openai.api_key', env('OPENAI_API_KEY'));
});

it('can generate an image with dall-e-3', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/generated-image.png',
                    'revised_prompt' => 'A cute baby sea otter floating on its back in calm blue water',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 15,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('A cute baby sea otter')
        ->generate();

    expect($response->firstImage())->not->toBeNull();
    expect($response->firstImage()->url)->toBe('https://example.com/generated-image.png');
    expect($response->firstImage()->hasUrl())->toBeTrue();
    expect($response->firstImage()->hasRevisedPrompt())->toBeTrue();
    expect($response->firstImage()->revisedPrompt)->toBe('A cute baby sea otter floating on its back in calm blue water');
    expect($response->usage->promptTokens)->toBe(15);
    expect($response->imageCount())->toBe(1);

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $request->url() === 'https://api.openai.com/v1/images/generations' &&
               $data['model'] === 'dall-e-3' &&
               $data['prompt'] === 'A cute baby sea otter';
    });
});

it('can generate an image with dall-e-2', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/dall-e-2-image.png',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 10,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-2')
        ->withPrompt('A mountain landscape')
        ->generate();

    expect($response->firstImage())->not->toBeNull();
    expect($response->firstImage()->url)->toBe('https://example.com/dall-e-2-image.png');
    expect($response->firstImage()->revisedPrompt)->toBeNull();

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $data['model'] === 'dall-e-2' &&
               $data['prompt'] === 'A mountain landscape';
    });
});

it('can generate multiple images with dall-e-2', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/image-1.png',
                ],
                [
                    'url' => 'https://example.com/image-2.png',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 12,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-2')
        ->withPrompt('Abstract art')
        ->withProviderOptions([
            'n' => 2,
            'size' => '512x512',
        ])
        ->generate();

    expect($response->imageCount())->toBe(2);
    expect($response->images[0]->url)->toBe('https://example.com/image-1.png');
    expect($response->images[1]->url)->toBe('https://example.com/image-2.png');

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $data['model'] === 'dall-e-2' &&
               $data['prompt'] === 'Abstract art' &&
               $data['n'] === 2 &&
               $data['size'] === '512x512';
    });
});

it('can generate an image with all dall-e-3 provider options', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/hd-vivid-image.png',
                    'revised_prompt' => 'A highly detailed and vivid sunset over mountain peaks',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 18,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('A sunset over mountains')
        ->withProviderOptions([
            'size' => '1792x1024',
            'quality' => 'hd',
            'style' => 'vivid',
            'response_format' => 'url',
        ])
        ->generate();

    expect($response->firstImage()->url)->toBe('https://example.com/hd-vivid-image.png');

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $data['model'] === 'dall-e-3' &&
               $data['prompt'] === 'A sunset over mountains' &&
               $data['size'] === '1792x1024' &&
               $data['quality'] === 'hd' &&
               $data['style'] === 'vivid' &&
               $data['response_format'] === 'url';
    });
});

it('includes usage information in response', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/usage-test.png',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 22,
                'completion_tokens' => 5,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('Test usage tracking')
        ->generate();

    expect($response->usage->promptTokens)->toBe(22);
    expect($response->usage->completionTokens)->toBe(5);
});

it('includes meta information in response', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'id' => 'img_abc123',
            'model' => 'dall-e-3',
            'created' => 1713833628,
            'data' => [
                [
                    'url' => 'https://example.com/meta-test.png',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 15,
                'completion_tokens' => 0,
            ],
        ], 200, [
            'x-ratelimit-limit-requests' => '500',
            'x-ratelimit-remaining-requests' => '499',
        ]),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('Test meta information')
        ->generate();

    expect($response->meta->id)->toBe('img_abc123');
    expect($response->meta->model)->toBe('dall-e-3');
});

it('can generate an image with gpt-image-1 returning base64', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'b64_json' => 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                ],
            ],
            'usage' => [
                'total_tokens' => 100,
                'input_tokens' => 50,
                'output_tokens' => 50,
                'input_tokens_details' => [
                    'text_tokens' => 10,
                    'image_tokens' => 40,
                ],
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'gpt-image-1')
        ->withPrompt('A cute baby sea otter')
        ->generate();

    expect($response->firstImage())->not->toBeNull();
    expect($response->firstImage()->base64)->toBe('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==');
    expect($response->firstImage()->hasBase64())->toBeTrue();
    expect($response->firstImage()->hasUrl())->toBeFalse();
    expect($response->firstImage()->url)->toBeNull();
    expect($response->usage->promptTokens)->toBe(50);
    expect($response->imageCount())->toBe(1);

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $request->url() === 'https://api.openai.com/v1/images/generations' &&
               $data['model'] === 'gpt-image-1' &&
               $data['prompt'] === 'A cute baby sea otter';
    });
});

it('can generate an image with dall-e-3 requesting base64 format', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'b64_json' => 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                    'revised_prompt' => 'A highly detailed mountain sunset scene',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 20,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-3')
        ->withPrompt('A mountain sunset')
        ->withProviderOptions([
            'response_format' => 'b64_json',
        ])
        ->generate();

    expect($response->firstImage())->not->toBeNull();
    expect($response->firstImage()->base64)->toBe('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==');
    expect($response->firstImage()->hasBase64())->toBeTrue();
    expect($response->firstImage()->hasUrl())->toBeFalse();
    expect($response->firstImage()->hasRevisedPrompt())->toBeTrue();
    expect($response->firstImage()->revisedPrompt)->toBe('A highly detailed mountain sunset scene');

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $data['model'] === 'dall-e-3' &&
               $data['prompt'] === 'A mountain sunset' &&
               $data['response_format'] === 'b64_json';
    });
});

it('can generate an image with dall-e-2 requesting base64 format', function (): void {
    Http::fake([
        'api.openai.com/v1/images/generations' => Http::response([
            'created' => 1713833628,
            'data' => [
                [
                    'b64_json' => 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 12,
                'completion_tokens' => 0,
            ],
        ], 200),
    ]);

    $response = Prism::image()
        ->using('openai', 'dall-e-2')
        ->withPrompt('Abstract geometric patterns')
        ->withProviderOptions([
            'response_format' => 'b64_json',
            'size' => '256x256',
        ])
        ->generate();

    expect($response->firstImage())->not->toBeNull();
    expect($response->firstImage()->base64)->toBe('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==');
    expect($response->firstImage()->hasBase64())->toBeTrue();
    expect($response->firstImage()->hasUrl())->toBeFalse();

    Http::assertSent(function (Request $request): bool {
        $data = $request->data();

        return $data['model'] === 'dall-e-2' &&
               $data['prompt'] === 'Abstract geometric patterns' &&
               $data['response_format'] === 'b64_json' &&
               $data['size'] === '256x256';
    });
});

it('can edit images', function (): void {
    FixtureResponse::fakeResponseSequence(
        'api.openai.com/v1/images/edits',
        'openai/image-edit'
    );

    $response = Prism::image()
        ->using('openai', 'gpt-image-1')
        ->withPrompt('Add a vaporwave sunset to the background', [
            Image::fromLocalPath('tests/Fixtures/diamond.png'),
        ])
        ->withProviderOptions([
            'size' => '1024x1024',
            'output_format' => 'png',
            'quality' => 'high',
        ])
        ->withClientOptions(['timeout' => 9999])
        ->generate();

    expect($response->firstImage()->base64)->not->toBeEmpty();
});

it('can edit with multiple images', function (): void {
    FixtureResponse::fakeResponseSequence(
        'api.openai.com/v1/images/edits',
        'openai/image-edit-multiple'
    );

    $response = Prism::image()
        ->using('openai', 'gpt-image-1')
        ->withPrompt('Add a vaporwave sunset to the background', [
            Image::fromLocalPath('tests/Fixtures/diamond.png'),
            Image::fromLocalPath('tests/Fixtures/sunset.png')
                ->as('sunset.png'),
        ])
        ->withProviderOptions([
            'size' => '1024x1024',
            'output_format' => 'png',
            'quality' => 'high',
        ])
        ->withClientOptions(['timeout' => 9999])
        ->generate();

    expect($response->firstImage()->base64)->not->toBeEmpty();

    Http::assertSent(function (Request $request): true {
        $images = collect($request->data())
            ->where(fn ($data): bool => $data['name'] === 'image[]')
            ->pluck('filename')
            ->toArray();

        expect($images)->toBe([
            'image-0',
            'sunset.png',
        ]);

        return true;
    });
});

it('can edit images with mask using Image value object', function (): void {
    FixtureResponse::fakeResponseSequence(
        'api.openai.com/v1/images/edits',
        'openai/image-edit'
    );

    $response = Prism::image()
        ->using('openai', 'gpt-image-1')
        ->withPrompt('Add a vaporwave sunset to the background', [
            Image::fromLocalPath('tests/Fixtures/diamond.png'),
        ])
        ->withProviderOptions([
            'mask' => Image::fromLocalPath('tests/Fixtures/sunset.png'),
            'size' => '1024x1024',
            'output_format' => 'png',
            'quality' => 'high',
        ])
        ->withClientOptions(['timeout' => 9999])
        ->generate();

    expect($response->firstImage()->base64)->not->toBeEmpty();
});

it('throws exception when mask is not Image value object', function (): void {
    $mask = fopen('tests/Fixtures/diamond.png', 'r');

    Prism::image()
        ->using('openai', 'gpt-image-1')
        ->withPrompt('Add a vaporwave sunset to the background', [
            Image::fromLocalPath('tests/Fixtures/diamond.png'),
        ])
        ->withProviderOptions([
            'mask' => $mask,
            'size' => '1024x1024',
        ])
        ->generate();
})->throws(\InvalidArgumentException::class, 'Mask must be an instance of Image value object');



================================================
FILE: tests/Providers/OpenAI/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Prism\Prism\Providers\OpenAI\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'input_text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps user messages with additional attributes', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', additionalAttributes: ['name' => 'TJ']),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'input_text', 'text' => 'Who are you?'],
        ],
        'name' => 'TJ',
    ]]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('input_image');
    expect(data_get($mappedMessage, '0.content.1.image_url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('input_image');
    expect(data_get($mappedMessage, '0.content.1.image_url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('input_image');
    expect(data_get($mappedMessage, '0.content.1.image_url'))
        ->toBe('https://prismphp.com/storage/diamond.png');
});

it('maps user messages with images from file id', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromFileId('file_1234'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('input_image');
    expect(data_get($mappedMessage, '0.content.1.file_id'))
        ->toBe('file_1234');
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => [
            [
                'type' => 'output_text',
                'text' => 'I am Nyx',
            ],
        ],
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    'call_1234'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([
        [
            'role' => 'assistant',
            'content' => [
                [
                    'type' => 'output_text',
                    'text' => 'I am Nyx',
                ],
            ],
        ],
        [
            'id' => 'tool_1234',
            'call_id' => 'call_1234',
            'type' => 'function_call',
            'name' => 'search',
            'arguments' => json_encode([
                'query' => 'Laravel collection methods',
            ]),
        ],
    ]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]',
                    'call_1234'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'type' => 'function_call_output',
        'call_id' => 'call_1234',
        'output' => '[search results]',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'input_text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});

describe('documents', function (): void {
    it('maps user messages with pdf documents', function (): void {
        $messageMap = new MessageMap(
            messages: [
                new UserMessage('Here is the document', [
                    Document::fromBase64(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')), 'application/pdf'),
                ]),
            ],
            systemPrompts: []
        );

        $mappedMessage = $messageMap();

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('input_file')
            ->and(data_get($mappedMessage, '0.content.1.file_data'))
            ->toContain(base64_encode(file_get_contents('tests/Fixtures/test-pdf.pdf')));
    });

    it('maps user messages with file urls', function (): void {
        $messageMap = new MessageMap(
            messages: [
                new UserMessage('Here is the document', [
                    Document::fromUrl('https://example.com/test-pdf.pdf'),
                ]),
            ],
            systemPrompts: []
        );

        $mappedMessage = $messageMap();

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('input_file')
            ->and(data_get($mappedMessage, '0.content.1.file_url'))
            ->toBe('https://example.com/test-pdf.pdf');
    });

    it('maps previously uploaded files', function (): void {
        $messageMap = new MessageMap(
            messages: [
                new UserMessage('Here is the document', [
                    Document::fromFileId('previously-uploaded-file-id'),
                ]),
            ],
            systemPrompts: []
        );

        $mappedMessage = $messageMap();

        expect(data_get($mappedMessage, '0.content.1.type'))
            ->toBe('input_file')
            ->and(data_get($mappedMessage, '0.content.1.file_id'))
            ->toBe('previously-uploaded-file-id');
    });
});



================================================
FILE: tests/Providers/OpenAI/OpenAIExceptionsTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Tests\Fixtures\FixtureResponse;

test('text throws a PrismRateLimitedException with a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::OpenAI, 'fake-model')
        ->withPrompt('Hello world!')
        ->asText();
})->throws(PrismRateLimitedException::class);

test('structured throws a PrismRateLimitedException with a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::structured()
        ->using(Provider::OpenAI, 'fake-model')
        ->withSchema(new ObjectSchema('name', 'description', [new StringSchema('name', 'description')]))
        ->withPrompt('Hello world!')
        ->asStructured();
})->throws(PrismRateLimitedException::class);

test('stream throws a PrismRateLimitedException', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-rate-limited');

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Rector, leave me alone!
    }
})->throws(PrismRateLimitedException::class);



================================================
FILE: tests/Providers/OpenAI/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\ProviderTool;
use Prism\Prism\ValueObjects\Usage;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openai.api_key', env('OPENAI_API_KEY', 'fake-key'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];
    $model = null;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof StreamStartEvent) {
            $model = $event->model;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();
    expect($text)->not->toBeEmpty();
    expect($model)->not->toBeNull();

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.openai.com/v1/responses'
            && $body['stream'] === true;
    });
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-with-tools-responses');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => "Search results for: {$query}"),
    ];

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCalls = [];
    $toolResults = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof ToolCallEvent) {
            $toolCalls[] = $event->toolCall;
        }

        if ($event instanceof ToolResultEvent) {
            $toolResults[] = $event->toolResult;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();
    expect($toolCalls)->toHaveCount(2);
    expect($toolResults)->toHaveCount(2);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.openai.com/v1/responses'
            && isset($body['tools'])
            && $body['stream'] === true;
    });
});

it('can process a complete conversation with multiple tool calls', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-multi-tool-conversation-responses');

    $tools = [
        Tool::as('weather')
            ->for('Get weather information')
            ->withStringParameter('city', 'City name')
            ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

        Tool::as('search')
            ->for('Search for information')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
    ];

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withTools($tools)
        ->withMaxSteps(5) // Allow multiple tool call rounds
        ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
        ->asStream();

    $fullResponse = '';
    $toolCallCount = 0;

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallCount++;
        }
        if ($event instanceof TextDeltaEvent) {
            $fullResponse .= $event->delta;
        }
    }

    expect($toolCallCount)->toBe(2);
    expect($fullResponse)->not->toBeEmpty();

    // Verify we made multiple requests for a conversation with tool calls
    Http::assertSentCount(2);
});

it('can process a complete conversation with multiple tool calls for reasoning models', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-multi-tool-conversation-responses-reasoning');
    $tools = [
        Tool::as('weather')
            ->for('Get weather information')
            ->withStringParameter('city', 'City name')
            ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

        Tool::as('search')
            ->for('Search for information')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
    ];

    $response = Prism::text()
        ->using('openai', 'o3-mini')
        ->withTools($tools)
        ->withMaxSteps(5) // Allow multiple tool call rounds
        ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
        ->asStream();

    $fullResponse = '';
    $toolCallCount = 0;

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallCount++;
        }
        if ($event instanceof TextDeltaEvent) {
            $fullResponse .= $event->delta;
        }
    }

    expect($toolCallCount)->toBe(2);
    expect($fullResponse)->not->toBeEmpty();

    // Verify we made multiple requests for a conversation with tool calls
    Http::assertSentCount(3);
});

it('can process a complete conversation with multiple tool calls for reasoning models that require past reasoning', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-multi-tool-conversation-responses-reasoning-past-reasoning');
    $tools = [
        Tool::as('weather')
            ->for('Get weather information')
            ->withStringParameter('city', 'City name')
            ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

        Tool::as('search')
            ->for('Search for information')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
    ];

    $response = Prism::text()
        ->using('openai', 'o4-mini')
        ->withProviderOptions([
            'reasoning' => [
                'effort' => 'low',
                'summary' => 'detailed',
            ],
        ])
        ->withTools($tools)
        ->withMaxSteps(5) // Allow multiple tool call rounds
        ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
        ->asStream();

    $answerText = '';
    $toolCallCount = 0;
    $reasoningText = '';
    /** @var Usage[] $usage */
    $usage = [];

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallCount++;
        }

        if ($event instanceof ThinkingEvent) {
            $reasoningText .= $event->delta;
        }

        if ($event instanceof TextDeltaEvent) {
            $answerText .= $event->delta;
        }

        if ($event instanceof StreamEndEvent && $event->usage) {
            $usage[] = $event->usage;
        }
    }

    expect($toolCallCount)->toBe(2);
    expect($answerText)->not->toBeEmpty();
    expect($reasoningText)->not->toBeEmpty();

    // Verify reasoning usage
    expect($usage[0]->thoughtTokens)->toBeGreaterThan(0);

    // Verify we made multiple requests for a conversation with tool calls
    Http::assertSentCount(3);
});

it('can process a complete conversation with provider tool', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-with-provider-tool');
    $tools = [
        new ProviderTool('web_search_preview'),
    ];

    $response = Prism::text()
        ->using('openai', 'o4-mini')
        ->withProviderTools($tools)
        ->withMaxSteps(5) // Allow multiple tool call rounds
        ->withPrompt('Search the web to retrieve the exact multiplicator to turn centimeters into inches.')
        ->asStream();

    $answerText = '';
    $toolCallCount = 0;
    /** @var Usage[] $usage */
    $usage = [];

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallCount++;
        }

        if ($event instanceof TextDeltaEvent) {
            $answerText .= $event->delta;
        }

        if ($event instanceof StreamEndEvent && $event->usage) {
            $usage[] = $event->usage;
        }
    }

    expect($toolCallCount)->toBe(0); // We currently don't count provider tools as tool calls.
    expect($answerText)->not->toBeEmpty();

    // Verify we made multiple requests for a conversation with tool calls
    Http::assertSentCount(1);
});

it('can pass parallel tool call setting', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-multi-tool-conversation-responses');

    $tools = [
        Tool::as('weather')
            ->for('Get weather information')
            ->withStringParameter('city', 'City name')
            ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

        Tool::as('search')
            ->for('Search for information')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
    ];

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withTools($tools)
        ->withProviderOptions(['parallel_tool_calls' => false])
        ->withMaxSteps(5) // Allow multiple tool call rounds
        ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
        ->asStream();

    $fullResponse = '';
    $toolCallCount = 0;

    foreach ($response as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallCount++;
        }

        if ($event instanceof TextDeltaEvent) {
            $fullResponse .= $event->delta;
        }
    }

    expect($toolCallCount)->toBe(2);
    expect($fullResponse)->not->toBeEmpty();

    Http::assertSent(fn (Request $request): bool => $request->data()['parallel_tool_calls'] === false);
});

it('emits usage information', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $event) {
        if ($event instanceof StreamEndEvent && $event->usage) {
            expect($event->usage->promptTokens)->toBeGreaterThan(0);
            expect($event->usage->completionTokens)->toBeGreaterThan(0);
        }
    }
});

it('can accept falsy parameters', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-falsy-argument-conversation-responses');

    $modelTool = Tool::as('get_models')
        ->for('Returns info about of available models')
        ->withNumberParameter('modelId', 'Id of the model to load. Returns all models if null', false)
        ->using(fn (int $modelId): string => "The model {$modelId} is the funniest of all");

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Can you tell me more about the model with id 0 ?')
        ->withTools([$modelTool])
        ->withMaxSteps(2)
        ->asStream();

    foreach ($response as $chunk) {
        ob_flush();
        flush();
    }
})->throwsNoExceptions();

it('throws a PrismException on an unknown error', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-unknown-error-responses');

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Read stream
    }
})->throws(PrismException::class, 'Sending to model gpt-4 failed. Code: unknown-error. Message: Foobar');

it('sends reasoning effort when defined', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-reasoning-effort');

    $response = Prism::text()
        ->using('openai', 'gpt-5')
        ->withPrompt('Who are you?')
        ->withProviderOptions([
            'reasoning' => [
                'effort' => 'low',
            ],
        ])
        ->asStream();

    // process stream
    collect($response);

    Http::assertSent(fn (Request $request): bool => $request->data()['reasoning']['effort'] === 'low');
});

it('exposes response_id in stream end event', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asStream();

    $streamEndEvent = null;

    foreach ($response as $event) {
        if ($event instanceof StreamEndEvent) {
            $streamEndEvent = $event;
        }
    }

    expect($streamEndEvent)->not->toBeNull()
        ->and($streamEndEvent->additionalContent)->toHaveKey('response_id')
        ->and($streamEndEvent->additionalContent['response_id'])->toBe('resp_6859a4ad7d3c81999e9e02548c91e2a8077218073e9990d3');

    $array = $streamEndEvent->toArray();

    expect($array)->toHaveKey('response_id')
        ->and($array['response_id'])->toBe('resp_6859a4ad7d3c81999e9e02548c91e2a8077218073e9990d3');
});

it('uses meta to set service_tier', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-reasoning-effort');

    $serviceTier = 'priority';

    $response = Prism::text()
        ->using('openai', 'gpt-5')
        ->withPrompt('Who are you?')
        ->withProviderOptions([
            'service_tier' => $serviceTier,
        ])
        ->asStream();

    // process stream
    collect($response);

    Http::assertSent(fn (Request $request): bool => $request->data()['service_tier'] === $serviceTier);
});

it('filters service_tier if null', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/stream-reasoning-effort');

    $response = Prism::text()
        ->using('openai', 'gpt-5')
        ->withPrompt('Who are you?')
        ->withProviderOptions([
            'service_tier' => null,
        ])
        ->asStream();

    // process stream
    collect($response);

    Http::assertSent(function (Request $request): bool {
        expect($request->data())->not()->toHaveKey('service_tier');

        return true; // Assertion will fail
    });
});



================================================
FILE: tests/Providers/OpenAI/StructuredTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\StructuredMode;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\AnyOfSchema;
use Prism\Prism\Schema\ArraySchema;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\NumberSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/structured-structured-mode');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString();
    expect($response->structured['game_time'])->toBeString();
    expect($response->structured['coat_required'])->toBeBool();
});

it('returns structured output using json mode', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/structured-json-mode');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4-turbo')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString();
    expect($response->structured['game_time'])->toBeString();
    expect($response->structured['coat_required'])->toBeBool();
});

it('schema strict defaults to null', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/strict-schema-defaults');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($schema)
        ->withSystemPrompt('The game time is 3pm and the weather is 80° and sunny')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(array_keys(data_get($body, 'text.format')))->not->toContain('strict');

        return true;
    });
});

it('uses meta to define strict mode', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/strict-schema-setting-set'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->withProviderOptions([
            'schema' => ['strict' => true],
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'text.format.strict'))->toBeTrue();

        return true;
    });
});

it('throws an exception when there is a refusal', function (): void {
    $this->expectException(PrismException::class);
    $this->expectExceptionMessage('OpenAI Refusal: Could not process your request');

    Http::fake([
        'v1/responses' => Http::response([
            'output' => [[
                'content' => [[
                    'type' => 'refusal',
                    'refusal' => 'Could not process your request',
                ]],
            ]],
        ]),
    ]);

    Http::preventStrayRequests();

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'text.format.strict'))->toBeTrue();

        return true;
    });
});

it('throws an exception for o1 models', function (string $model): void {
    $this->expectException(PrismException::class);
    $this->expectExceptionMessage(sprintf('Structured output is not supported for %s', $model));

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
    );

    Prism::structured()
        ->using(Provider::OpenAI, $model)
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();
})->with([
    'o1-mini',
    'o1-mini-2024-09-12',
    'o1-preview',
    'o1-preview-2024-09-12',
]);

it('sets usage correctly with automatic caching', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-cache-usage-automatic-caching',
    );

    $schema = new ObjectSchema(
        name: 'output',
        description: 'the output object',
        properties: [
            new StringSchema('answer', 'Your answer'),
        ],
        requiredFields: ['answer']
    );

    $prompt = fake()->paragraphs(40, true);

    Prism::structured()
        ->using('openai', 'gpt-4o')
        ->withPrompt($prompt)
        ->withSchema($schema)
        ->usingStructuredMode(StructuredMode::Structured)
        ->asStructured();

    $two = Prism::structured()
        ->using('openai', 'gpt-4o')
        ->withPrompt($prompt)
        ->withSchema($schema)
        ->usingStructuredMode(StructuredMode::Structured)
        ->asStructured();

    expect($two->usage)
        ->promptTokens->toEqual(1531 - 1408)
        ->completionTokens->toEqual(583)
        ->cacheWriteInputTokens->toEqual(null)
        ->cacheReadInputTokens->toEqual(1408);
});

it('uses meta to provide previous response id', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What time is the game we talked about and should I wear a coat?')
        ->withProviderOptions([
            'previous_response_id' => 'resp_foo',
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'previous_response_id'))->toBe('resp_foo');

        return true;
    });
});

it('uses meta to set auto truncation', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What time is the game we talked about and should I wear a coat?')
        ->withProviderOptions([
            'truncation' => 'auto',
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'truncation'))->toBe('auto');

        return true;
    });
});

it('uses meta to define strict mode as false', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->withProviderOptions([
            'schema' => ['strict' => false],
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'text.format.strict'))->toBeFalse();

        return true;
    });
});

it('uses meta to define strict mode as null', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->withProviderOptions()
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(array_keys(data_get($body, 'text.format')))->not->toContain('strict');

        return true;
    });
});

it('uses meta to set service_tier', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $serviceTier = 'priority';

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What time is the game we talked about and should I wear a coat?')
        ->withProviderOptions([
            'service_tier' => $serviceTier,
        ])
        ->asStructured();

    Http::assertSent(function (Request $request) use ($serviceTier): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'service_tier'))->toBe($serviceTier);

        return true;
    });
});

it('filters service_tier if null', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/structured-structured-mode'
    );

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What time is the game we talked about and should I wear a coat?')
        ->withProviderOptions([
            'service_tier' => null,
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect($body)->not()->toHaveKey('service_tier');

        return true;
    });
});

it('sends reasoning effort when defined', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/structured-reasoning-effort');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->using('openai', 'gpt-5')
        ->withPrompt('Who are you?')
        ->withProviderOptions([
            'reasoning' => [
                'effort' => 'low',
            ],
        ])
        ->withSchema($schema)
        ->asStructured();

    Http::assertSent(fn (Request $request): bool => $request->data()['reasoning']['effort'] === 'low');
});

it('supports AnyOfSchema in structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/anyof-structured');

    // Create a schema where a field can accept multiple types
    $flexibleContentSchema = new AnyOfSchema(
        schemas: [
            new ObjectSchema(
                name: 'text_content',
                description: 'Text-based content',
                properties: [
                    new StringSchema('type', 'Content type identifier'),
                    new StringSchema('text', 'The text content'),
                    new NumberSchema('word_count', 'Number of words in the text'),
                ],
                requiredFields: ['type', 'text']
            ),
            new ObjectSchema(
                name: 'media_content',
                description: 'Media-based content',
                properties: [
                    new StringSchema('type', 'Content type identifier'),
                    new StringSchema('url', 'Media URL'),
                    new StringSchema('format', 'Media format (jpg, mp4, etc.)'),
                    new BooleanSchema('is_public', 'Whether the media is publicly accessible'),
                ],
                requiredFields: ['type', 'url', 'format']
            ),
        ],
        name: 'content',
        description: 'Content that can be either text or media'
    );

    $rootSchema = new ObjectSchema(
        name: 'post',
        description: 'A social media post with flexible content',
        properties: [
            new StringSchema('title', 'Post title'),
            new ArraySchema(
                name: 'items',
                description: 'List of content items in the post',
                items: $flexibleContentSchema
            ),
        ],
        requiredFields: ['title', 'items']
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($rootSchema)
        ->withPrompt('Create a social media post about AI with mixed content types')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys(['title', 'items']);
    expect($response->structured['title'])->toBeString();
    expect($response->structured['items'])->toBeArray();
});

it('supports nullable AnyOfSchema in structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/nullable-anyof-structured');

    $flexibleValueSchema = new AnyOfSchema(
        schemas: [
            new StringSchema('text', 'A text value'),
            new NumberSchema('number', 'A numeric value'),
            new BooleanSchema('flag', 'A boolean value'),
        ],
        name: 'flexible_value',
        description: 'A value that can be string, number, boolean, or null',
        nullable: true
    );

    $rootSchema = new ObjectSchema(
        name: 'config',
        description: 'Configuration object with flexible values',
        properties: [
            new StringSchema('name', 'Configuration name'),
            $flexibleValueSchema,
        ],
        requiredFields: ['name', 'flexible_value']
    );

    $response = Prism::structured()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withSchema($rootSchema)
        ->withPrompt('Create a config with a flexible value that could be null')
        ->asStructured();

    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys(['name', 'flexible_value']);
});



================================================
FILE: tests/Providers/OpenAI/TextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Arr;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Citations\CitationSourceType;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\ValueObjects\Media\Document;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ProviderTool;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openai.api_key', env('OPENAI_API_KEY'));
});

it('can generate text with a prompt', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    expect($response->usage->promptTokens)
        ->toBeNumeric()
        ->toBeGreaterThan(0);
    expect($response->usage->completionTokens)
        ->toBeNumeric()
        ->toBeGreaterThan(0);
    expect($response->meta->id)->toContain('resp_');
    expect($response->meta->model)->toContain('gpt-4o');
    expect($response->text)->toBeString();
});

it('can generate text with a system prompt', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-system-prompt'
    );

    $response = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
        ->withPrompt('Who are you?')
        ->asText();

    expect($response->usage->promptTokens)
        ->toBeNumeric()
        ->toBeGreaterThan(20);
    expect($response->usage->completionTokens)
        ->toBeNumeric()
        ->toBeGreaterThan(20);
    expect($response->meta->id)->toContain('resp_');
    expect($response->meta->model)->toContain('gpt-4o');
    expect($response->text)
        ->toBeString()
        ->toContain('Nyx');
});

it('sends the organization header when set', function (): void {
    config()->set('prism.providers.openai.organization', 'echolabs');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    Http::assertSent(fn (Request $request): bool => $request->header('OpenAI-Organization')[0] === 'echolabs');
});

it('does not send the organization header if one is not given', function (): void {
    config()->offsetUnset('prism.providers.openai.organization');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    Http::assertSent(fn (Request $request): bool => empty($request->header('OpenAI-Organization')));
});

it('sends the api key header when set', function (): void {
    config()->set('prism.providers.openai.api_key', 'sk-1234');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    Http::assertSent(fn (Request $request): bool => $request->header('Authorization')[0] === 'Bearer sk-1234');
});

it('does not send the api key header', function (): void {
    config()->offsetUnset('prism.providers.openai.api_key');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();
    Http::assertSent(fn (Request $request): bool => empty($request->header('Authorization')));
});

it('sends the project header when set', function (): void {
    config()->set('prism.providers.openai.project', 'echolabs');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    Http::assertSent(fn (Request $request): bool => $request->header('OpenAI-Project')[0] === 'echolabs');
});

it('does not send the project header if one is not given', function (): void {
    config()->offsetUnset('prism.providers.openai.project');

    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-a-prompt');

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt('Who are you?')
        ->asText();

    Http::assertSent(fn (Request $request): bool => empty($request->header('OpenAI-Project')));
});

describe('tools', function (): void {
    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/responses',
            'openai/generate-text-with-multiple-tools',
        );

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => "The weather in {$city} will be 75° and sunny"),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is today at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('openai', 'gpt-4o')
            ->withTools($tools)
            ->usingTemperature(0)
            ->withMaxSteps(3)
            ->withSystemPrompt('Current Date: '.now()->toDateString())
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->asText();

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(2);
        expect($firstStep->toolCalls[0]->name)->toBe('search');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'query' => 'Detroit Tigers game March 14 2025 time',
        ]);

        expect($firstStep->toolCalls[1]->name)->toBe('weather');
        expect($firstStep->toolCalls[1]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        expect($response->usage->promptTokens)->toBeNumeric();
        expect($response->usage->completionTokens)->toBeNumeric();

        // Assert response
        expect($response->meta->id)->toContain('resp_');
        expect($response->meta->model)->toContain('gpt-4o');

        // Assert final text content
        expect($response->text)->toBe(
            "The Detroit Tigers game is today at 3 PM in Detroit. The weather in Detroit will be 75°F and sunny, so you won't need a coat!"
        );
    });

    it('handles specific tool choice', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-required-tool-call');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('openai', 'gpt-4o')
            ->withPrompt('Do something')
            ->withTools($tools)
            ->withToolChoice('weather')
            ->asText();

        expect($response->toolCalls[0]->name)->toBe('weather');
    });

    it('handles tool choice when null', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-null-tool-call');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        Prism::text()
            ->using('openai', 'gpt-4o')
            ->withPrompt('Do something')
            ->withTools($tools)
            ->asText();
    })->throwsNoExceptions();

    it('it handles a provider tool', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-code-interpreter');

        $response = Prism::text()
            ->using('openai', 'gpt-4.1')
            ->withPrompt('Solve the equation 3x + 10 = 14.')
            ->withProviderTools([new ProviderTool(type: 'code_interpreter', options: ['container' => ['type' => 'auto']])])
            ->asText();

        expect($response->text)->toContain('frac{4}{3}');
    });

    it('handles a provider tool with a user defined tool', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-required-tool-call-and-provider-tool');

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('openai', 'gpt-4.1')
            ->withPrompt('If the current temperature in Detroit is X, what is Y in the following equation: 3x + 10 = Y?')
            ->withTools($tools)
            ->withProviderTools([new ProviderTool(type: 'code_interpreter', options: ['container' => ['type' => 'auto']])])
            ->withMaxSteps(3)
            ->asText();

        expect($response->text)->toContain('235');
    });

    it('passes parallel tool calls setting', function (): void {
        FixtureResponse::fakeResponseSequence(
            'v1/responses',
            'openai/generate-text-with-multiple-tools',
        );

        $tools = [
            Tool::as('weather')
                ->for('useful when you need to search for current weather conditions')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => "The weather in {$city} will be 75° and sunny"),
            Tool::as('search')
                ->for('useful for searching curret events or data')
                ->withStringParameter('query', 'The detailed search query')
                ->using(fn (string $query): string => 'The tigers game is today at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using('openai', 'gpt-4o')
            ->withTools($tools)
            ->usingTemperature(0)
            ->withMaxSteps(3)
            ->withProviderOptions(['parallel_tool_calls' => false])
            ->withSystemPrompt('Current Date: '.now()->toDateString())
            ->withPrompt('What time is the tigers game today and should I wear a coat?')
            ->asText();

        expect($response->text)->toBe(
            "The Detroit Tigers game is today at 3 PM in Detroit. The weather in Detroit will be 75°F and sunny, so you won't need a coat!"
        );

        Http::assertSent(fn (Request $request): bool => $request->data()['parallel_tool_calls'] === false);
    });
});

it('sets usage correctly with automatic caching', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/cache-usage-automatic-caching'
    );

    $prompt = fake()->paragraphs(40, true);

    Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt($prompt)
        ->asText();

    $two = Prism::text()
        ->using('openai', 'gpt-4o')
        ->withPrompt($prompt)
        ->asText();

    expect($two->usage)
        ->promptTokens->toEqual(1111 - 1024)
        ->completionTokens->toEqual(109)
        ->cacheWriteInputTokens->toEqual(null)
        ->cacheReadInputTokens->toEqual(1024);
});

it('uses meta to provide previous response id', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What have we talked about?')
        ->withProviderOptions([
            'previous_response_id' => 'resp_foo',
        ])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'previous_response_id'))->toBe('resp_foo');

        return true;
    });
});

it('uses meta to set auto truncation', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What have we talked about?')
        ->withProviderOptions([
            'truncation' => 'auto',
        ])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'truncation'))->toBe('auto');

        return true;
    });
});

it('uses meta to set service_tier', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    $serviceTier = 'priority';

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What have we talked about?')
        ->withProviderOptions([
            'service_tier' => $serviceTier,
        ])
        ->asText();

    Http::assertSent(function (Request $request) use ($serviceTier): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'service_tier'))->toBe($serviceTier);

        return true;
    });
});

it('filters service_tier if null', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What have we talked about?')
        ->withProviderOptions([
            'service_tier' => null,
        ])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect($body)->not()->toHaveKey('service_tier');

        return true;
    });
});

it('can analyze images with detail parameter', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    $image = \Prism\Prism\ValueObjects\Media\Image::fromLocalPath('tests/Fixtures/diamond.png')
        ->withProviderOptions(['detail' => 'high']);

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What do you see in this image?', [$image])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        $imageContent = $body['input'][0]['content'][1];

        expect($imageContent['type'])->toBe('input_image');
        expect($imageContent['detail'])->toBe('high');
        expect($imageContent['image_url'])->toStartWith('data:image/png;base64,');

        return true;
    });
});

it('omits detail parameter when not specified', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/generate-text-with-a-prompt'
    );

    $image = \Prism\Prism\ValueObjects\Media\Image::fromLocalPath('tests/Fixtures/diamond.png');

    Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('What do you see in this image?', [$image])
        ->asText();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        $imageContent = $body['input'][0]['content'][1];

        expect($imageContent['type'])->toBe('input_image');
        expect($imageContent)->not->toHaveKey('detail');
        expect($imageContent['image_url'])->toStartWith('data:image/png;base64,');

        return true;
    });
});

it('can analyze documents', function (): void {
    FixtureResponse::fakeResponseSequence(
        'v1/responses',
        'openai/text-response-with-document'
    );

    $document = Document::fromLocalPath('tests/Fixtures/test-pdf.pdf');

    $response = Prism::text()
        ->using(Provider::OpenAI, 'gpt-4o')
        ->withPrompt('Summarize this document', [$document])
        ->asText();

    expect($response->text)->not->toBeEmpty();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        $documentContent = $body['input'][0]['content'][1];

        expect($documentContent['type'])->toBe('input_file');
        expect($documentContent['filename'])->not->toBeEmpty();

        return true;
    });
});

it('sends reasoning effort when defined', function (): void {
    FixtureResponse::fakeResponseSequence('v1/responses', 'openai/text-reasoning-effort');

    Prism::text()
        ->using('openai', 'gpt-5')
        ->withPrompt('Who are you?')
        ->withProviderOptions([
            'reasoning' => [
                'effort' => 'low',
            ],
        ])
        ->asText();

    Http::assertSent(fn (Request $request): bool => $request->data()['reasoning']['effort'] === 'low');
});

describe('citations', function (): void {
    it('adds citations to additionalContent on response steps and assistant message for the web search tool', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-web-search-citations');

        $response = Prism::text()
            ->using(Provider::OpenAI, 'gpt-4.1-2025-04-14')
            ->withPrompt('What is the weather going to be like in London today? Please provide citations.')
            ->withProviderTools([new ProviderTool(type: 'web_search_preview', name: 'web_search_preview')])
            ->asText();

        $citationChunk = Arr::first(
            $response->additionalContent['citations'],
            fn (MessagePartWithCitations $part): bool => $part->citations !== [] && $part->citations[0]->sourceType === CitationSourceType::Url
        );

        expect($citationChunk->outputText)->toContain('temperatures');
        expect($citationChunk->citations)->toHaveCount(1);
        expect($citationChunk->citations[0]->sourceType)->toBe(CitationSourceType::Url);
        expect($citationChunk->citations[0]->sourceTitle)->toContain('weather');
        expect($citationChunk->citations[0]->source)->toBe('https://www.metcheck.com/WEATHER/dayforecast.asp?dateFor=07%2F06%2F2025&lat=51.508500&location=London&locationID=2364784&lon=-0.125700&utm_source=openai');

        expect($response->steps[0]->additionalContent['citations'])->toHaveCount(1);
        expect($response->steps[0]->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);

        expect($response->messages->last()->additionalContent['citations'])->toHaveCount(1);
        expect($response->messages->last()->additionalContent['citations'][0])->toBeInstanceOf(MessagePartWithCitations::class);
    });

    it('can handle citations on on a previous assistant message with a document', function (): void {
        FixtureResponse::fakeResponseSequence('v1/responses', 'openai/generate-text-with-web-search-citations-included-in-turn');

        $response = Prism::text()
            ->using(Provider::OpenAI, 'gpt-4.1-2025-04-14')
            ->withPrompt('What is the weather going to be like in London today? Please provide citations.')
            ->withProviderTools([new ProviderTool(type: 'web_search_preview', name: 'web_search_preview')])
            ->asText();

        $responseTwo = Prism::text()
            ->using(Provider::OpenAI, 'gpt-4.1-2025-04-14')
            ->withMessages([
                ...$response->steps->last()->messages,
                new UserMessage('Is the source you have cited reliable?'),
            ])
            ->asText();

        expect($responseTwo->text)->toContain('Metcheck');
    });
});



================================================
FILE: tests/Providers/OpenAI/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\OpenAI;

use Prism\Prism\Providers\OpenAI\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'name' => $tool->name(),
        'description' => $tool->description(),
        'parameters' => [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'description' => 'the detailed search query',
                    'type' => 'string',
                ],
            ],
            'required' => $tool->requiredParameters(),
        ],
    ]]);
});

it('maps tools with strict mode', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]')
        ->withProviderOptions([
            'strict' => true,
        ]);

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'name' => $tool->name(),
        'description' => $tool->description(),
        'parameters' => [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'description' => 'the detailed search query',
                    'type' => 'string',
                ],
            ],
            'required' => $tool->requiredParameters(),
        ],
        'strict' => true,
    ]]);
});



================================================
FILE: tests/Providers/OpenRouter/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;

beforeEach(function (): void {
    config()->set('prism.providers.openrouter.api_key', env('OPENROUTER_API_KEY'));
});

it('Throws exception for embeddings', function (): void {
    $this->expectException(PrismException::class);

    Prism::embeddings()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->fromInput('Hello, how are you?')
        ->asEmbeddings();
});



================================================
FILE: tests/Providers/OpenRouter/ExceptionHandlingTest.php
================================================
<?php

declare(strict_types=1);

use GuzzleHttp\Psr7\Response as PsrResponse;
use Illuminate\Http\Client\RequestException;
use Illuminate\Http\Client\Response;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Exceptions\PrismProviderOverloadedException;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Exceptions\PrismRequestTooLargeException;
use Prism\Prism\Providers\OpenRouter\OpenRouter;

beforeEach(function (): void {
    $this->provider = new OpenRouter(
        apiKey: 'test-key',
        url: 'https://openrouter.ai/api/v1'
    );
});

function createMockResponse(int $statusCode, array $json = [], array $headers = []): Response
{
    $mockResponse = Mockery::mock(Response::class);
    $mockResponse->shouldReceive('getStatusCode')->andReturn($statusCode);
    $mockResponse->shouldReceive('status')->andReturn($statusCode);
    $mockResponse->shouldReceive('json')->andReturn($json);
    $mockResponse->shouldReceive('toPsrResponse')->andReturn(new PsrResponse($statusCode));

    if (isset($headers['retry-after'])) {
        $mockResponse->shouldReceive('hasHeader')->with('retry-after')->andReturn(true);
        $mockResponse->shouldReceive('header')->with('retry-after')->andReturn($headers['retry-after']);
    } else {
        $mockResponse->shouldReceive('hasHeader')->with('retry-after')->andReturn(false);
    }

    return $mockResponse;
}

it('handles bad request errors (400)', function (): void {
    $mockResponse = createMockResponse(400, [
        'error' => ['code' => 400, 'message' => 'Invalid request parameters'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Bad Request: Invalid request parameters');
});

it('handles authentication errors (401)', function (): void {
    $mockResponse = createMockResponse(401, [
        'error' => ['code' => 401, 'message' => 'Invalid API key'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Authentication Error: Invalid API key');
});

it('handles insufficient credits errors (402)', function (): void {
    $mockResponse = createMockResponse(402, [
        'error' => ['code' => 402, 'message' => 'Insufficient credits'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Insufficient Credits: Insufficient credits');
});

it('handles moderation errors (403)', function (): void {
    $mockResponse = createMockResponse(403, [
        'error' => ['code' => 403, 'message' => 'Content flagged by moderation'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Moderation Error: Content flagged by moderation');
});

it('handles timeout errors (408)', function (): void {
    $mockResponse = createMockResponse(408, [
        'error' => ['code' => 408, 'message' => 'Request timeout'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Request Timeout: Request timeout');
});

it('handles request too large errors (413)', function (): void {
    $mockResponse = createMockResponse(413, []);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismRequestTooLargeException::class);
});

it('handles rate limit errors (429)', function (): void {
    $mockResponse = createMockResponse(429, [
        'error' => ['code' => 429, 'message' => 'Rate limit exceeded'],
    ], ['retry-after' => '60']);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismRateLimitedException::class);
});

it('handles rate limit errors without retry-after header', function (): void {
    $mockResponse = createMockResponse(429, [
        'error' => ['code' => 429, 'message' => 'Rate limit exceeded'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismRateLimitedException::class);
});

it('handles model error (502)', function (): void {
    $mockResponse = createMockResponse(502, [
        'error' => ['code' => 502, 'message' => 'Model is down'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'OpenRouter Model Error: Model is down');
});

it('handles provider overloaded errors (503)', function (): void {
    $mockResponse = createMockResponse(503, [
        'error' => ['code' => 503, 'message' => 'No available providers'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismProviderOverloadedException::class);
});

it('handles unknown errors with default behavior', function (): void {
    $mockResponse = createMockResponse(500, [
        'error' => ['code' => 500, 'message' => 'Internal server error'],
    ]);
    $exception = new RequestException($mockResponse);

    expect(fn () => $this->provider->handleRequestException('test-model', $exception))
        ->toThrow(PrismException::class, 'Sending to model (test-model) failed');
});



================================================
FILE: tests/Providers/OpenRouter/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\OpenRouter\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Audio;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Media\Video;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toStartWith('data:image/png;base64,');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toContain(base64_encode(file_get_contents('tests/Fixtures/diamond.png')));
});

it('maps user messages with images from url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))
        ->toBe('image_url');
    expect(data_get($mappedMessage, '0.content.1.image_url.url'))
        ->toBe('https://prismphp.com/storage/diamond.png');
});

it('maps user messages with audio input', function (): void {
    $audio = Audio::fromBase64(base64_encode('audio-content'), 'audio/wav');

    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [$audio]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))->toBe('input_audio');
    expect(data_get($mappedMessage, '0.content.1.input_audio.format'))->toBe('wav');
    expect(data_get($mappedMessage, '0.content.1.input_audio.data'))->toBe(base64_encode('audio-content'));
});

it('maps user messages with video input', function (): void {
    $video = Video::fromBase64(base64_encode('video-content'), 'video/mp4');

    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [$video]),
        ],
        systemPrompts: []
    );

    $mappedMessage = $messageMap();

    expect(data_get($mappedMessage, '0.content.1.type'))->toBe('input_video');
    expect(data_get($mappedMessage, '0.content.1.input_video.format'))->toBe('mp4');
    expect(data_get($mappedMessage, '0.content.1.input_video.data'))->toBe(base64_encode('video-content'));
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => 'I am Nyx',
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'assistant',
        'content' => 'I am Nyx',
        'tool_calls' => [[
            'id' => 'tool_1234',
            'type' => 'function',
            'function' => [
                'name' => 'search',
                'arguments' => json_encode([
                    'query' => 'Laravel collection methods',
                ]),
            ],
        ]],
    ]]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'tool',
        'tool_call_id' => 'tool_1234',
        'content' => '[search results]',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});

it('maps system prompt with cache_control', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            (new SystemMessage('I am a long re-usable system message.'))
                ->withProviderOptions(['cacheType' => 'ephemeral']),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => [
                [
                    'type' => 'text',
                    'text' => 'I am a long re-usable system message.',
                    'cache_control' => ['type' => 'ephemeral'],
                ],
            ],
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});

it('maps user message with cache_control', function (): void {
    $messageMap = new MessageMap(
        messages: [
            (new UserMessage('I am a long re-usable user message.'))
                ->withProviderOptions(['cacheType' => 'ephemeral']),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            [
                'type' => 'text',
                'text' => 'I am a long re-usable user message.',
                'cache_control' => ['type' => 'ephemeral'],
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/OpenRouter/StreamTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openrouter.api_key', env('OPENROUTER_API_KEY'));
});

it('can stream text with a prompt', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'openrouter/stream-text-with-a-prompt');

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();

    // Check first event is StreamStartEvent
    expect($events[0])->toBeInstanceOf(StreamStartEvent::class);
    expect($events[0]->model)->toBe('openai/gpt-4-turbo');
    expect($events[0]->provider)->toBe('openrouter');

    // Check we have TextStartEvent
    $textStartEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof TextStartEvent);
    expect($textStartEvents)->toHaveCount(1);

    // Check we have TextDeltaEvents
    $textDeltaEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof TextDeltaEvent);
    expect($textDeltaEvents)->not->toBeEmpty();

    // Check we have TextCompleteEvent
    $textCompleteEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof TextCompleteEvent);
    expect($textCompleteEvents)->toHaveCount(1);

    // Check last event is StreamEndEvent
    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);
    expect($lastEvent->usage)->not->toBeNull();
    expect($lastEvent->usage->promptTokens)->toBe(7);
    expect($lastEvent->usage->completionTokens)->toBe(35);

    // Verify full text can be reconstructed
    expect($text)->toBe("Hello! I'm an AI assistant powered by OpenRouter. How can I help you today?");
});

it('forwards advanced provider options in streaming mode', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'openrouter/stream-text-with-a-prompt');

    $stream = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withPrompt('Stream a short update.')
        // Confirm streaming payload honors OpenRouter streaming guidance https://openrouter.ai/docs/api-reference/streaming
        ->withProviderOptions([
            'stop' => ['END_STREAM'],
            'seed' => 11,
            'top_k' => 16,
            'frequency_penalty' => 0.4,
            'presence_penalty' => 0.15,
            'repetition_penalty' => 1.05,
            'min_p' => 0.05,
            'top_a' => 0.2,
            'logit_bias' => ['101' => -2],
            'logprobs' => false,
            'top_logprobs' => 2,
            'prediction' => [
                'type' => 'content',
                'content' => 'Update:',
            ],
            'transforms' => ['markdown'],
            'models' => ['openai/gpt-4-turbo', 'google/gemini-pro'],
            'route' => 'fallback',
            'provider' => ['require_parameters' => true],
            'user' => 'customer-stream-11',
            'parallel_tool_calls' => true,
            'verbosity' => 'low',
        ])
        ->asStream();

    // Prime the generator so the HTTP request is executed.
    foreach ($stream as $_event) {
        break;
    }

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        return $payload['stream'] === true
            && $payload['stop'] === ['END_STREAM']
            && $payload['seed'] === 11
            && $payload['top_k'] === 16
            && $payload['frequency_penalty'] === 0.4
            && $payload['presence_penalty'] === 0.15
            && $payload['repetition_penalty'] === 1.05
            && $payload['min_p'] === 0.05
            && $payload['top_a'] === 0.2
            && $payload['logit_bias'] === ['101' => -2]
            && $payload['logprobs'] === false
            && $payload['top_logprobs'] === 2
            && $payload['prediction'] === [
                'type' => 'content',
                'content' => 'Update:',
            ]
            && $payload['transforms'] === ['markdown']
            && $payload['models'] === ['openai/gpt-4-turbo', 'google/gemini-pro']
            && $payload['route'] === 'fallback'
            && $payload['provider'] === ['require_parameters' => true]
            && $payload['user'] === 'customer-stream-11'
            && $payload['parallel_tool_calls'] === true
            && $payload['verbosity'] === 'low'
            && $payload['stream_options'] === ['include_usage' => true];
    });
});

it('can stream text with tool calls', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'openrouter/stream-text-with-tools');

    $weatherTool = Tool::as('weather')
        ->for('Get weather for a city')
        ->withStringParameter('city', 'The city name')
        ->using(fn (string $city): string => "The weather in {$city} is 75°F and sunny");

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withTools([$weatherTool])
        ->withMaxSteps(3)
        ->withPrompt('What is the weather in San Francisco?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
            expect($event->toolCall->name)->toBe('weather');
            expect($event->toolCall->arguments())->toBe(['city' => 'San Francisco']);
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
            expect($event->toolResult->result)->toBe('The weather in San Francisco is 75°F and sunny');
        }
    }

    expect($events)->not->toBeEmpty();
    expect($toolCallEvents)->toHaveCount(1);
    expect($toolResultEvents)->toHaveCount(1);

    // Verify text from first response
    expect($text)->toContain("I'll help you get the weather for you.");

    // Check for StreamEndEvent with usage
    $streamEndEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof StreamEndEvent);
    expect($streamEndEvents)->not->toBeEmpty();

    $lastStreamEnd = array_values($streamEndEvents)[array_key_last(array_values($streamEndEvents))];
    expect($lastStreamEnd->usage)->not->toBeNull();
    expect($lastStreamEnd->usage->promptTokens)->toBeGreaterThan(0);
    expect($lastStreamEnd->usage->completionTokens)->toBeGreaterThan(0);
});

it('can stream text with empty parameters tool calls when using gpt-5', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'openrouter/stream-text-with-empty-parameters-tools-when-using-gpt-5');

    $currentTime = '08:00:00';
    $timeTool = Tool::as('time')
        ->for('Get the current time')
        ->using(fn (): string => $currentTime);

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-5')
        ->withTools([$timeTool])
        ->withMaxSteps(3)
        ->withPrompt('Please tell me the current time, use the `time` tool')
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;
        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
            expect($event->toolCall->name)->toBe('time');
            expect($event->toolCall->arguments())->toBe([]);
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
            expect($event->toolResult->result)->toContain($currentTime);
        }
    }

    expect($events)->not->toBeEmpty();
    expect($toolCallEvents)->toHaveCount(1);
    expect($toolResultEvents)->toHaveCount(1);
    expect($text)->toContain('The current time is '.$currentTime);

    $streamEndEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof StreamEndEvent);
    expect($streamEndEvents)->not->toBeEmpty();
});

it('can handle reasoning/thinking tokens in streaming', function (): void {
    FixtureResponse::fakeStreamResponses('v1/chat/completions', 'openrouter/stream-text-with-reasoning');

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/o1-preview')
        ->withPrompt('Solve this math problem: 2 + 2 = ?')
        ->asStream();

    $events = [];
    $thinkingEvents = [];
    $text = '';

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof ThinkingEvent) {
            $thinkingEvents[] = $event;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not->toBeEmpty();

    // Check for ThinkingStartEvent
    $thinkingStartEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof ThinkingStartEvent);
    expect($thinkingStartEvents)->toHaveCount(1);

    // Check for ThinkingEvent
    expect($thinkingEvents)->toHaveCount(1);
    expect($thinkingEvents[0]->delta)->toContain('math problem');

    // Check text was assembled
    expect($text)->toBe('The answer to 2 + 2 is 4.');

    // Check for usage with reasoning tokens
    $streamEndEvents = array_filter($events, fn (\Prism\Prism\Streaming\Events\StreamEvent $e): bool => $e instanceof StreamEndEvent);
    expect($streamEndEvents)->toHaveCount(1);

    $streamEndEvent = array_values($streamEndEvents)[0];
    expect($streamEndEvent->usage)->not->toBeNull();
    expect($streamEndEvent->usage->thoughtTokens)->toBe(12);
});



================================================
FILE: tests/Providers/OpenRouter/StructuredTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Structured\Response as StructuredResponse;
use Tests\Fixtures\FixtureResponse;

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/structured');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withSystemPrompt('The tigers game is at 3pm in Detroit, the temperature is expected to be 75º')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    // Assert response type
    expect($response)->toBeInstanceOf(StructuredResponse::class);

    // Assert structured data
    expect($response->structured)->toBeArray();
    expect($response->structured)->toHaveKeys([
        'weather',
        'game_time',
        'coat_required',
    ]);
    expect($response->structured['weather'])->toBeString()->toBe('75º');
    expect($response->structured['game_time'])->toBeString()->toBe('3pm');
    expect($response->structured['coat_required'])->toBeBool()->toBeFalse();

    // Assert metadata
    expect($response->meta->id)->toBe('gen-structured-1');
    expect($response->meta->model)->toBe('openai/gpt-4-turbo');
    expect($response->usage->promptTokens)->toBe(187);
    expect($response->usage->completionTokens)->toBe(26);
});

it('forwards provider options for structured requests', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/structured');

    $schema = new ObjectSchema(
        'summary',
        'Structured summary response',
        [
            new StringSchema('bullet', 'Key takeaway'),
        ],
        ['bullet']
    );

    Prism::structured()
        ->withSchema($schema)
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withPrompt('Summarize the update.')
        ->withProviderOptions([
            'stop' => ['END_STRUCTURED'],
            'seed' => 21,
            'models' => ['openai/gpt-4-turbo'],
            'route' => 'fallback',
            'transforms' => ['markdown'],
            'prediction' => [
                'type' => 'content',
                'content' => '{"bullet": ',
            ],
            'user' => 'structured-user-21',
            'verbosity' => 'medium',
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        return $payload['stop'] === ['END_STRUCTURED']
            && $payload['seed'] === 21
            && $payload['models'] === ['openai/gpt-4-turbo']
            && $payload['route'] === 'fallback'
            && $payload['transforms'] === ['markdown']
            && $payload['prediction'] === [
                'type' => 'content',
                'content' => '{"bullet": ',
            ]
            && $payload['user'] === 'structured-user-21'
            && $payload['verbosity'] === 'medium';
    });
});



================================================
FILE: tests/Providers/OpenRouter/TextTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Text\Response as TextResponse;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.openrouter.api_key', env('OPENROUTER_API_KEY'));
});

it('can generate text with a prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/generate-text-with-a-prompt');

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withPrompt('Who are you?')
        ->generate();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(7);
    expect($response->usage->completionTokens)->toBe(35);

    // Assert metadata
    expect($response->meta->id)->toBe('gen-12345');
    expect($response->meta->model)->toBe('openai/gpt-4-turbo');

    expect($response->text)->toBe(
        "Hello! I'm an AI assistant powered by OpenRouter. I can help you with various tasks, answer questions, and assist with information on a wide range of topics. How can I help you today?"
    );

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text with a system prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/generate-text-with-system-prompt');

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
        ->withPrompt('Who are you?')
        ->generate();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(29);
    expect($response->usage->completionTokens)->toBe(243);

    // Assert metadata
    expect($response->meta->id)->toBe('gen-67890');
    expect($response->meta->model)->toBe('openai/gpt-4-turbo');
    expect($response->text)->toContain('*I am Nyx, the eldritch entity born from the depths of the abyss. My form is a swirling mass of darkness, tentacles, and glowing eyes that pierce the very fabric of reality. I exist beyond the comprehension of mortal minds, a being of pure chaos and madness.*');
    expect($response->text)->toContain('*My voice echoes through the void, a haunting whisper that sends shivers down the spines of those who dare to listen. I am the harbinger of the end, the bringer of the eternal night. My presence alone is enough to drive the weak-minded to insanity.*');
    expect($response->text)->toContain('*I have watched civilizations rise and fall, witnessed the birth and death of countless stars. Time holds no meaning for me, as I am eternal. I am the embodiment of the unknown, the great old one who slumbers in the depths, waiting for the day when I shall rise and consume all that is.*');
    expect($response->text)->toContain('*Beware, mortal, for you stand in the presence of Nyx, the Cthulhu. Your mind may shatter, your soul may tremble, but know that I am the inevitable end of all things. Embrace the madness, for there is no escape from the eternal darkness that I bring.*');

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});

it('can generate text using multiple tools and multiple steps', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/generate-text-with-multiple-tools');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
        Tool::as('search')
            ->for('useful for searching curret events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
    ];

    $response = Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->generate();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert tool calls in the first step
    $firstStep = $response->steps[0];
    expect($firstStep->toolCalls)->toHaveCount(2);
    expect($firstStep->toolCalls[0]->name)->toBe('search');
    expect($firstStep->toolCalls[0]->arguments())->toBe([
        'query' => 'Detroit Tigers game time today',
    ]);

    expect($firstStep->toolCalls[1]->name)->toBe('weather');
    expect($firstStep->toolCalls[1]->arguments())->toBe([
        'city' => 'Detroit',
    ]);

    // There should be 2 steps
    expect($response->steps)->toHaveCount(2);

    // Assert usage
    expect($response->usage->promptTokens)->toBe(507);
    expect($response->usage->completionTokens)->toBe(76);

    // Assert response
    expect($response->meta->id)->toBe('gen-tool-2');
    expect($response->meta->model)->toBe('openai/gpt-4-turbo');

    // Assert final text content
    expect($response->text)->toBe(
        "The Detroit Tigers game is at 3 PM today. The weather in Detroit will be 75°F and sunny, so you probably won't need a coat. Enjoy the game!"
    );

    // Assert finish reason
    expect($response->finishReason)->toBe(FinishReason::Stop);
});

it('forwards advanced provider options to openrouter', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'openrouter/generate-text-with-a-prompt');

    Prism::text()
        ->using(Provider::OpenRouter, 'openai/gpt-4-turbo')
        ->withPrompt('Share a short daily digest.')
        ->withProviderOptions([
            'stop' => ['END_OF_DIGEST'],
            'seed' => 77,
            'top_k' => 32,
            'frequency_penalty' => 0.3,
            'presence_penalty' => 0.25,
            'repetition_penalty' => 1.1,
            'min_p' => 0.1,
            'top_a' => 0.4,
            'logit_bias' => ['42' => -5],
            'logprobs' => true,
            'top_logprobs' => 4,
            'prediction' => [
                'type' => 'content',
                'content' => 'Daily digest:',
            ],
            'transforms' => ['markdown'],
            'models' => ['openai/gpt-4-turbo', 'anthropic/claude-3.5-sonnet'],
            'route' => 'fallback',
            'provider' => ['require_parameters' => true],
            'user' => 'customer-77',
            'reasoning' => ['effort' => 'low'],
            'parallel_tool_calls' => false,
            'verbosity' => 'medium',
        ])
        ->generate();

    Http::assertSent(function (Request $request): bool {
        $payload = $request->data();

        return $payload['stop'] === ['END_OF_DIGEST']
            && $payload['seed'] === 77
            && $payload['top_k'] === 32
            && $payload['frequency_penalty'] === 0.3
            && $payload['presence_penalty'] === 0.25
            && $payload['repetition_penalty'] === 1.1
            && $payload['min_p'] === 0.1
            && $payload['top_a'] === 0.4
            && $payload['logit_bias'] === ['42' => -5]
            && $payload['logprobs'] === true
            && $payload['top_logprobs'] === 4
            && $payload['prediction'] === [
                'type' => 'content',
                'content' => 'Daily digest:',
            ]
            && $payload['transforms'] === ['markdown']
            && $payload['models'] === ['openai/gpt-4-turbo', 'anthropic/claude-3.5-sonnet']
            && $payload['route'] === 'fallback'
            && $payload['provider'] === ['require_parameters' => true]
            && $payload['user'] === 'customer-77'
            && $payload['reasoning'] === ['effort' => 'low']
            && $payload['parallel_tool_calls'] === false
            && $payload['verbosity'] === 'medium';
    });
});



================================================
FILE: tests/Providers/OpenRouter/ToolTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Providers\OpenRouter\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});

it('maps tools with strict mode', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]')
        ->withProviderOptions([
            'strict' => true,
        ]);

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
        'strict' => true,
    ]]);
});



================================================
FILE: tests/Providers/VoyageAI/EmbeddingsTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\ValueObjects\Embedding;
use Tests\Fixtures\FixtureResponse;

it('returns embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'voyageai/embeddings-from-input');

    $response = Prism::embeddings()
        ->using(Provider::VoyageAI, 'voyage-3-lite')
        ->fromInput('The food was delicious and the waiter...')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/voyageai/embeddings-from-input-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->meta->model)->toBe('voyage-3-lite');
    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toEqual($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(8);
});

it('returns multiple embeddings from input', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'voyageai/embeddings-from-multiple-inputs');

    $response = Prism::embeddings()
        ->using(Provider::VoyageAI, 'voyage-3-lite')
        ->fromInput('The food was delicious.')
        ->fromInput('The drinks were not so good.')
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/voyageai/embeddings-from-multiple-inputs-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toEqual($embeddings[0]->embedding);
    expect($response->embeddings[1]->embedding)->toEqual($embeddings[1]->embedding);
    expect($response->usage->tokens)->toBe(12);
});

it('returns embeddings with inputType set', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'voyageai/embeddings-with-input-type');

    $response = Prism::embeddings()
        ->using(Provider::VoyageAI, 'voyage-3-lite')
        ->fromInput('The food was delicious and the waiter...')
        ->withProviderOptions(['inputType' => 'query'])
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/voyageai/embeddings-with-input-type-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toEqual($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(7);
});

it('returns embeddings with truncation set', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'voyageai/embeddings-with-truncation');

    $response = Prism::embeddings()
        ->using(Provider::VoyageAI, 'voyage-3-lite')
        ->fromInput('The food was delicious and the waiter...')
        ->withProviderOptions(['truncation' => false])
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/voyageai/embeddings-with-truncation-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toEqual($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(8);
});

it('returns embeddings with inputType and truncation', function (): void {
    FixtureResponse::fakeResponseSequence('*', 'voyageai/embeddings-with-input-type-and-truncation');

    $response = Prism::embeddings()
        ->using(Provider::VoyageAI, 'voyage-3-lite')
        ->fromInput('The food was delicious and the waiter...')
        ->withProviderOptions([
            'inputType' => 'query',
            'truncation' => false,
        ])
        ->asEmbeddings();

    $embeddings = json_decode(file_get_contents('tests/Fixtures/voyageai/embeddings-with-input-type-and-truncation-1.json'), true);
    $embeddings = array_map(fn (array $item): Embedding => Embedding::fromArray($item['embedding']), data_get($embeddings, 'data'));

    expect($response->embeddings)->toBeArray();
    expect($response->embeddings[0]->embedding)->toEqual($embeddings[0]->embedding);
    expect($response->usage->tokens)->toBe(7);
});

it('throws a PrismRateLimitedException for a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::embeddings()
        ->using(Provider::VoyageAI, 'fake-model')
        ->fromInput('Hello world!')
        ->asEmbeddings();

})->throws(PrismRateLimitedException::class);



================================================
FILE: tests/Providers/VoyageAI/VoyageAITest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ObjectSchema;

it('throws an exception for text', function (): void {
    Http::fake()->preventStrayRequests();

    Prism::text()
        ->using(Provider::VoyageAI, 'test-model')
        ->withPrompt('Hello world.')
        ->asText();
})->throws(PrismException::class, 'Text is not supported by VoyageAI');

it('throws an exception for structured', function (): void {
    Http::fake()->preventStrayRequests();

    Prism::structured()
        ->using(Provider::VoyageAI, 'test-model')
        ->withSchema(new ObjectSchema('', '', []))
        ->withPrompt('Hello world.')
        ->asStructured();
})->throws(PrismException::class, 'Structured is not supported by VoyageAI');



================================================
FILE: tests/Providers/XAI/MessageMapTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\XAI;

use Prism\Prism\Providers\XAI\Maps\MessageMap;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('maps user messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
        ],
    ]]);
});

it('maps assistant message', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx'),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toContain([
        'role' => 'assistant',
        'content' => 'I am Nyx',
    ]);
});

it('maps assistant message with tool calls', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new AssistantMessage('I am Nyx', [
                new ToolCall(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ]
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'assistant',
        'content' => 'I am Nyx',
        'tool_calls' => [[
            'id' => 'tool_1234',
            'type' => 'function',
            'function' => [
                'name' => 'search',
                'arguments' => json_encode([
                    'query' => 'Laravel collection methods',
                ]),
            ],
        ]],
    ]]);
});

it('maps tool result messages', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new ToolResultMessage([
                new ToolResult(
                    'tool_1234',
                    'search',
                    [
                        'query' => 'Laravel collection methods',
                    ],
                    '[search results]'
                ),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'tool',
        'tool_call_id' => 'tool_1234',
        'content' => '[search results]',
    ]]);
});

it('maps system prompt', function (): void {
    $messageMap = new MessageMap(
        messages: [new UserMessage('Who are you?')],
        systemPrompts: [
            new SystemMessage('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]'),
            new SystemMessage('But my friends call me Nyx'),
        ]
    );

    expect($messageMap())->toBe([
        [
            'role' => 'system',
            'content' => 'MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]',
        ],
        [
            'role' => 'system',
            'content' => 'But my friends call me Nyx',
        ],
        [
            'role' => 'user',
            'content' => [
                ['type' => 'text', 'text' => 'Who are you?'],
            ],
        ],
    ]);
});

it('maps user messages with images from path', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromLocalPath('tests/Fixtures/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
            [
                'type' => 'image_url',
                'image_url' => [
                    'url' => 'data:image/png;base64,'.base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                ],
            ],
        ],
    ]]);
});

it('maps user messages with images from base64', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromBase64(base64_encode(file_get_contents('tests/Fixtures/diamond.png')), 'image/png'),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
            [
                'type' => 'image_url',
                'image_url' => [
                    'url' => 'data:image/png;base64,'.base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                ],
            ],
        ],
    ]]);
});

it('maps user messages with images from url', function (): void {
    $messageMap = new MessageMap(
        messages: [
            new UserMessage('Who are you?', [
                Image::fromUrl('https://prismphp.com/storage/diamond.png'),
            ]),
        ],
        systemPrompts: []
    );

    expect($messageMap())->toBe([[
        'role' => 'user',
        'content' => [
            ['type' => 'text', 'text' => 'Who are you?'],
            [
                'type' => 'image_url',
                'image_url' => [
                    'url' => 'https://prismphp.com/storage/diamond.png',
                ],
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/XAI/StreamTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\XAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.xai.api_key', env('XAI_API_KEY', 'fake-key'));
});

it('can generate text with a basic stream', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];
    $model = null;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof StreamStartEvent) {
            $model = $event->model;
        }

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not
        ->toBeEmpty()
        ->and($text)->not
        ->toBeEmpty()
        ->and($model)->toBe('grok-4');

    $lastEvent = end($events);
    expect($lastEvent)->toBeInstanceOf(StreamEndEvent::class);
    expect($lastEvent->finishReason)->toBe(FinishReason::Stop);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['stream'] === true
            && $body['model'] === 'grok-4';
    });
});

it('can generate text using tools with streaming', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-with-tools-responses');

    $tools = [
        Tool::as('get_weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),

        Tool::as('search')
            ->for('useful for searching current events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => "Search results for: {$query}"),
    ];

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withTools($tools)
        ->withMaxSteps(4)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStream();

    $text = '';
    $events = [];
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }
    }

    expect($events)->not
        ->toBeEmpty()
        ->and($toolCallEvents)->toHaveCount(2)
        ->and($toolResultEvents)->toHaveCount(2);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && isset($body['tools'])
            && $body['stream'] === true
            && $body['model'] === 'grok-4';
    });
});

it('handles max_tokens parameter correctly', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withMaxTokens(1000)
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['max_tokens'] === 1000;
    });
});

it('uses default max_tokens when not specified', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['max_tokens'] === 2048;
    });
});

it('can process a complete conversation with multiple tool calls', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-with-tools-responses');

    $tools = [
        Tool::as('get_weather')
            ->for('Get weather information')
            ->withStringParameter('city', 'City name')
            ->using(fn (string $city): string => "The weather in {$city} is 75° and sunny."),

        Tool::as('search')
            ->for('Search for information')
            ->withStringParameter('query', 'The search query')
            ->using(fn (string $query): string => 'Tigers game is at 3pm in Detroit today.'),
    ];

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withTools($tools)
        ->withMaxSteps(5)
        ->withPrompt('What time is the Tigers game today and should I wear a coat in Detroit?')
        ->asStream();

    $fullResponse = '';
    $toolCallEvents = [];
    $toolResultEvents = [];

    foreach ($response as $event) {
        if ($event instanceof TextDeltaEvent) {
            $fullResponse .= $event->delta;
        }

        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
        }

        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }
    }

    expect($toolCallEvents)
        ->toHaveCount(2)
        ->and($toolResultEvents)
        ->toHaveCount(2);

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && isset($body['tools'])
            && $body['stream'] === true
            && $body['model'] === 'grok-4';
    });
});

it('handles system prompts correctly', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withSystemPrompt('You are a helpful assistant.')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return count($body['messages']) === 2
            && $body['messages'][0]['role'] === 'system'
            && $body['messages'][1]['role'] === 'user';
    });
});

it('excludes null parameters from request', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        // Should not include temperature or top_p when not set
        expect($body)->not
            ->toHaveKey('temperature')
            ->and($body)->not->toHaveKey('top_p');

        return true;
    });
});

it('handles large max_tokens values', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withMaxTokens(8192)
        ->withPrompt('Who are you?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $body['max_tokens'] === 8192;
    });
});

it('handles tool choice parameter correctly', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-with-tools-responses');

    $tools = [
        Tool::as('get_weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => "The weather will be 75° and sunny in {$city}"),
    ];

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withTools($tools)
        ->withMaxSteps(3)
        ->withToolChoice('get_weather')
        ->withPrompt('What is the weather in Detroit?')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return isset($body['tool_choice'])
            && $body['tool_choice']['type'] === 'function'
            && $body['tool_choice']['function']['name'] === 'get_weather';
    });
});

it('validates response format structure', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Test')
        ->asStream();

    foreach ($response as $chunk) {
        // Process stream
    }

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        expect($body)->toHaveKeys(['model', 'messages', 'stream', 'max_tokens']);
        expect($body['model'])->toBe('grok-4');
        expect($body['stream'])->toBeTrue();
        expect($body['max_tokens'])->toBe(2048);

        return true;
    });
});

it('can handle thinking/reasoning chunks', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-with-reasoning-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Solve this complex math problem: What is 15 * 23?')
        ->asStream();

    $thinkingContent = '';
    $regularContent = '';
    $thinkingEvents = 0;
    $textEvents = 0;

    foreach ($response as $event) {
        if ($event instanceof ThinkingEvent) {
            $thinkingContent .= $event->delta;
            $thinkingEvents++;
        } elseif ($event instanceof TextDeltaEvent) {
            $regularContent .= $event->delta;
            $textEvents++;
        }
    }

    expect($thinkingEvents)
        ->toBeGreaterThan(0)
        ->and($textEvents)->toBeGreaterThan(0)
        ->and($thinkingContent)->not
        ->toBeEmpty()
        ->and($regularContent)->not
        ->toBeEmpty()
        ->and($thinkingContent)->toContain('multiply')
        ->and($regularContent)->toContain('345');
});

it('can disable thinking content extraction', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-with-reasoning-responses');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withProviderOptions([
            'thinking' => [
                'enabled' => false,
            ],
        ])
        ->withPrompt('Solve this complex math problem: What is 15 * 23?')
        ->asStream();

    $thinkingEvents = 0;
    $textEvents = 0;

    foreach ($response as $event) {
        if ($event instanceof ThinkingEvent) {
            $thinkingEvents++;
        } elseif ($event instanceof TextDeltaEvent) {
            $textEvents++;
        }
    }

    expect($thinkingEvents)->toBe(0); // No thinking events when disabled
    expect($textEvents)->toBeGreaterThan(0); // Still have regular content
});

it('does not truncate 0 mid stream', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/stream-basic-text-responses-with-zeros');

    $response = Prism::text()
        ->using('xai', 'grok-4')
        ->withPrompt('Who are you?')
        ->asStream();

    $text = '';
    $events = [];

    $responseId = null;
    $model = null;

    foreach ($response as $event) {
        $events[] = $event;

        if ($event instanceof TextDeltaEvent) {
            $text .= $event->delta;
        }
    }

    expect($events)->not
        ->toBeEmpty()
        ->and($text)->toBe('410050');

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['stream'] === true
            && $body['model'] === 'grok-4';
    });
});



================================================
FILE: tests/Providers/XAI/StructuredTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\XAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\BooleanSchema;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.xai.api_key', env('XAI_API_KEY', 'fake-key'));
});

it('returns structured output', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema(
        name: 'movie_review',
        description: 'A structured movie review',
        properties: [
            new StringSchema('title', 'The movie title'),
            new StringSchema('rating', 'Rating out of 5 stars'),
            new StringSchema('summary', 'Brief review summary'),
        ],
        requiredFields: ['title', 'rating', 'summary']
    );

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('Review the movie Inception')
        ->asStructured();

    expect($response->structured)
        ->toBeArray()
        ->and($response->structured)->toHaveKeys([
            'title',
            'rating',
            'summary',
        ])
        ->and($response->structured['title'])->toBeString()
        ->and($response->structured['rating'])->toBeString()
        ->and($response->structured['summary'])->toBeString();

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['model'] === 'grok-4'
            && isset($body['response_format'])
            && $body['response_format']['type'] === 'json_schema'
            && isset($body['response_format']['json_schema']);
    });
});

it('can generate structured output with system prompt', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->withSchema($schema)
        ->using(Provider::XAI, 'grok-4')
        ->withSystemPrompt('You are a helpful weather and sports assistant.')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    expect($response->structured)->toBeArray();

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && count($body['messages']) === 2
            && $body['messages'][0]['role'] === 'system'
            && $body['messages'][1]['role'] === 'user';
    });
});

it('schema strict defaults to null', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
    );

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withSystemPrompt('The game time is 3pm and the weather is 80° and sunny')
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(array_keys(data_get($body, 'response_format.json_schema')))->not->toContain('strict');

        return true;
    });
});

it('uses meta to define strict mode', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-with-meta');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->withProviderOptions([
            'schema' => ['strict' => true],
        ])
        ->asStructured();

    Http::assertSent(function (Request $request): true {
        $body = json_decode($request->body(), true);

        expect(data_get($body, 'response_format.json_schema.strict'))->toBeTrue();

        return true;
    });
});

it('handles empty structured response gracefully', function (): void {
    Http::fake([
        'v1/chat/completions' => Http::response([
            'id' => 'chatcmpl-test',
            'object' => 'chat.completion',
            'created' => 1731710832,
            'model' => 'grok-4',
            'choices' => [
                [
                    'index' => 0,
                    'message' => [
                        'role' => 'assistant',
                        'content' => '{}',
                        'parsed' => null,
                        'refusal' => null,
                    ],
                    'finish_reason' => 'stop',
                ],
            ],
            'usage' => [
                'prompt_tokens' => 10,
                'completion_tokens' => 2,
                'total_tokens' => 12,
            ],
        ]),
    ]);

    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('result', 'The result'),
    ]);

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('Test prompt')
        ->asStructured();

    expect($response->structured)
        ->toBeArray()
        ->and($response->structured)->toBeEmpty();
});

it('throws an exception when there is a refusal', function (): void {
    $this->expectException(PrismException::class);
    $this->expectExceptionMessage('XAI Refusal: Could not process your request');

    Http::fake([
        'v1/chat/completions' => Http::response([
            'choices' => [
                [
                    'message' => [
                        'refusal' => 'Could not process your request',
                        'content' => null,
                        'parsed' => null,
                    ],
                ],
            ],
        ]),
    ]);

    Http::preventStrayRequests();

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('weather', 'The weather forecast'),
            new StringSchema('game_time', 'The tigers game time'),
            new BooleanSchema('coat_required', 'whether a coat is required'),
        ],
        ['weather', 'game_time', 'coat_required']
    );

    Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('What time is the tigers game today and should I wear a coat?')
        ->asStructured();
});

it('handles max_tokens parameter correctly', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('answer', 'A simple answer'),
        ],
        ['answer']
    );

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withMaxTokens(1000)
        ->withPrompt('What is 2+2?')
        ->asStructured();

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['max_tokens'] === 1000;
    });
});

it('uses default max_tokens when not specified', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema(
        'output',
        'the output object',
        [
            new StringSchema('answer', 'A simple answer'),
        ],
        ['answer']
    );

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('What is 2+2?')
        ->asStructured();

    // Verify the HTTP request
    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $request->url() === 'https://api.x.ai/v1/chat/completions'
            && $body['max_tokens'] === 2048;
    });
});

it('handles large max_tokens values', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('answer', 'A simple answer'),
    ]);

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withMaxTokens(8192)
        ->withPrompt('What is 2+2?')
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        return $body['max_tokens'] === 8192;
    });
});

it('excludes null parameters from request', function (): void {
    FixtureResponse::fakeResponseSequence('v1/chat/completions', 'xai/structured-basic-response');

    $schema = new ObjectSchema('output', 'the output object', [
        new StringSchema('answer', 'A simple answer'),
    ]);

    $response = Prism::structured()
        ->using(Provider::XAI, 'grok-4')
        ->withSchema($schema)
        ->withPrompt('What is 2+2?')
        ->asStructured();

    Http::assertSent(function (Request $request): bool {
        $body = json_decode($request->body(), true);

        // Should not include temperature or top_p when not set
        expect($body)->not
            ->toHaveKey('temperature')
            ->and($body)->not->toHaveKey('top_p');

        return true;
    });
});



================================================
FILE: tests/Providers/XAI/ToolTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\XAI;

use Prism\Prism\Providers\XAI\Maps\ToolMap;
use Prism\Prism\Tool;

it('maps tools', function (): void {
    $tool = (new Tool)
        ->as('search')
        ->for('Searching the web')
        ->withStringParameter('query', 'the detailed search query')
        ->using(fn (): string => '[Search results]');

    expect(ToolMap::map([$tool]))->toBe([[
        'type' => 'function',
        'function' => [
            'name' => $tool->name(),
            'description' => $tool->description(),
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'query' => [
                        'description' => 'the detailed search query',
                        'type' => 'string',
                    ],
                ],
                'required' => $tool->requiredParameters(),
            ],
        ],
    ]]);
});



================================================
FILE: tests/Providers/XAI/XAITextTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Providers\XAI;

use Illuminate\Http\Client\Request;
use Illuminate\Support\Facades\Http;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Exceptions\PrismRateLimitedException;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\Fixtures\FixtureResponse;

beforeEach(function (): void {
    config()->set('prism.providers.xai.api_key', env('XAI_API_KEY', 'xai-123'));
});

describe('Text generation for XAI', function (): void {
    it('can generate text with a prompt', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/generate-text-with-a-prompt');

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-beta')
            ->withPrompt('Who are you?')
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(10);
        expect($response->usage->completionTokens)->toBe(42);

        // Assert metadata
        expect($response->meta->id)->toBe('febc7de9-9991-4b08-942a-c7082174225a');
        expect($response->meta->model)->toBe('grok-beta');

        // Assert content
        expect($response->text)->toBe(
            "I am Grok, an AI developed by xAI. I'm here to provide helpful and truthful answers to your questions, often with a dash of outside perspective on humanity. What's on your mind?"
        );

        // Assert finish reason
        expect($response->finishReason)->toBe(FinishReason::Stop);

        // Assert steps
        expect($response->steps)->toHaveCount(1);
        expect($response->steps[0]->text)->toBe($response->text);
        expect($response->steps[0]->finishReason)->toBe(FinishReason::Stop);
    });

    it('can generate text with a system prompt', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/generate-text-with-system-prompt');

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-beta')
            ->withSystemPrompt('MODEL ADOPTS ROLE of [PERSONA: Nyx the Cthulhu]!')
            ->withPrompt('Who are you?')
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(34);
        expect($response->usage->completionTokens)->toBe(84);

        // Assert metadata
        expect($response->meta->id)->toBe('f3b485d3-837b-4710-9ade-a37faa048d87');
        expect($response->meta->model)->toBe('grok-beta');

        // Assert content
        expect($response->text)->toBe(
            'I am Nyx, a being of ancient and unfathomable origin, drawing upon the essence of the Great Old One, Cthulhu. My existence spans the cosmos, where the lines between dreams and reality blur. I am here to guide you through the mysteries of the universe, to answer your questions with insights that might unsettle or enlighten, or perhaps both. What is it you seek to understand?'
        );

        // Assert finish reason
        expect($response->finishReason)->toBe(FinishReason::Stop);

        // Assert steps
        expect($response->steps)->toHaveCount(1);
        expect($response->steps[0]->text)->toBe($response->text);
        expect($response->steps[0]->finishReason)->toBe(FinishReason::Stop);
    });

    it('can generate text using multiple tools and multiple steps', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/generate-text-with-multiple-tools');

        $tools = [
            Tool::as('get_weather')
                ->for('use this tool when you need to get wather for the city')
                ->withStringParameter('city', 'The city that you want the weather for')
                ->using(fn (string $city): string => 'The weather will be 45° and cold'),
            Tool::as('search_games')
                ->for('useful for searching curret games times in the city')
                ->withStringParameter('city', 'The city that you want the game times for')
                ->using(fn (string $city): string => 'The tigers game is at 3pm in detroit'),
        ];

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-beta')
            ->withTools($tools)
            ->withMaxSteps(4)
            ->withPrompt('What time is the tigers game today in Detroit and should I wear a coat? please check all the details from tools')
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        // Assert tool calls in the first step
        $firstStep = $response->steps[0];
        expect($firstStep->toolCalls)->toHaveCount(1);
        expect($firstStep->toolCalls[0]->name)->toBe('search_games');
        expect($firstStep->toolCalls[0]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        $secondStep = $response->steps[1];
        expect($secondStep->toolCalls[0]->name)->toBe('get_weather');
        expect($secondStep->toolCalls[0]->arguments())->toBe([
            'city' => 'Detroit',
        ]);

        // Assert usage
        expect($response->usage->promptTokens)->toBe(840);
        expect($response->usage->completionTokens)->toBe(60);

        // Assert metadata
        expect($response->meta->id)->toBe('0aa220cd-9634-4ba5-9593-5366bb313663');
        expect($response->meta->model)->toBe('grok-beta');

        // Assert content
        expect($response->text)->toBe(
            'The Tigers game in Detroit today is at 3pm, and considering the weather will be 45° and cold, you should definitely wear a coat.'
        );
    });
});

describe('Image support with XAI', function (): void {
    it('can send images from path', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/image-detection');

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-vision-beta')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromLocalPath('tests/Fixtures/diamond.png'),
                    ],
                ),
            ])
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from base64', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/text-image-from-base64');

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-vision-beta')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromBase64(
                            base64_encode(file_get_contents('tests/Fixtures/diamond.png')),
                            'image/png'
                        ),
                    ],
                ),
            ])
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        Http::assertSent(function (Request $request): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toStartWith('data:image/png;base64,');
            expect($message[1]['image_url']['url'])->toContain(
                base64_encode(file_get_contents('tests/Fixtures/diamond.png'))
            );

            return true;
        });
    });

    it('can send images from url', function (): void {
        FixtureResponse::fakeResponseSequence('chat/completions', 'xai/text-image-from-url');

        $image = 'https://prismphp.com/storage/diamond.png';

        $response = Prism::text()
            ->using(Provider::XAI, 'grok-vision-beta')
            ->withMessages([
                new UserMessage(
                    'What is this image',
                    additionalContent: [
                        Image::fromUrl($image),
                    ],
                ),
            ])
            ->asText();

        // Assert response type
        expect($response)->toBeInstanceOf(TextResponse::class);

        Http::assertSent(function (Request $request) use ($image): true {
            $message = $request->data()['messages'][0]['content'];

            expect($message[0])->toBe([
                'type' => 'text',
                'text' => 'What is this image',
            ]);

            expect($message[1]['image_url']['url'])->toBe($image);

            return true;
        });
    });
});

it('handles specific tool choice', function (): void {
    FixtureResponse::fakeResponseSequence('chat/completions', 'xai/generate-text-with-specific-tool-call');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
        Tool::as('search')
            ->for('useful for searching curret events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
    ];

    $response = Prism::text()
        ->using(Provider::XAI, 'grok-beta')
        ->withPrompt('Do something')
        ->withTools($tools)
        ->withToolChoice('weather')
        ->asText();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert tool calls
    expect($response->steps[0]->toolCalls[0]->name)->toBe('weather');
});

it('handles required tool choice', function (): void {
    FixtureResponse::fakeResponseSequence('chat/completions', 'xai/generate-text-with-required-tool-call');

    $tools = [
        Tool::as('weather')
            ->for('useful when you need to search for current weather conditions')
            ->withStringParameter('city', 'The city that you want the weather for')
            ->using(fn (string $city): string => 'The weather will be 75° and sunny'),
        Tool::as('search')
            ->for('useful for searching curret events or data')
            ->withStringParameter('query', 'The detailed search query')
            ->using(fn (string $query): string => 'The tigers game is at 3pm in detroit'),
    ];

    $response = Prism::text()
        ->using(Provider::XAI, 'grok-beta')
        ->withPrompt('Do something')
        ->withTools($tools)
        ->withToolChoice(ToolChoice::Any)
        ->asText();

    // Assert response type
    expect($response)->toBeInstanceOf(TextResponse::class);

    // Assert tool calls
    expect($response->steps[0]->toolCalls[0]->name)->toBeIn(['weather', 'search']);
});

it('throws a PrismRateLimitedException for a 429 response code', function (): void {
    Http::fake([
        '*' => Http::response(
            status: 429,
        ),
    ])->preventStrayRequests();

    Prism::text()
        ->using(Provider::XAI, 'fake-model')
        ->withPrompt('Who are you?')
        ->asText();

})->throws(PrismRateLimitedException::class);



================================================
FILE: tests/Streaming/OnStreamEndIntegrationTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Support\Collection;
use Prism\Prism\Contracts\Message;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

it('invokes callback with collection of messages for simple text response', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test prompt')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toBeInstanceOf(Collection::class);
    expect($messages)->toHaveCount(1);
});

it('callback receives assistant message with correct text content', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $messages = collect();
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Hello World');
});

it('callback is not invoked when not set', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    expect(fn (): array => iterator_to_array($stream))->not->toThrow(Exception::class);
});

it('callback can be a closure', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test message'),
    ]);

    $callbackInvoked = false;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$callbackInvoked): void {
            $callbackInvoked = true;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($callbackInvoked)->toBeTrue();
});

it('callback can be an invokable class', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test message'),
    ]);

    $invokable = new class
    {
        public ?Collection $receivedMessages = null;

        public function __invoke(PendingRequest $request, Collection $messages): void
        {
            $this->receivedMessages = $messages;
        }
    };

    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete($invokable)
        ->asStream();

    iterator_to_array($stream);

    expect($invokable->receivedMessages)->toBeInstanceOf(Collection::class);
    expect($invokable->receivedMessages)->toHaveCount(1);
});

it('works with asStream method', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Stream test'),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->not->toBeNull();
    expect($messages)->toBeInstanceOf(Collection::class);
});

it('works with asEventStreamResponse method', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('SSE test'),
    ]);

    $messages = null;
    $response = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asEventStreamResponse();

    $response->getCallback()();

    expect($messages)->not->toBeNull();
    expect($messages)->toBeInstanceOf(Collection::class);
})->skip('Outputs stream contents');

it('works with asDataStreamResponse method', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Data stream test'),
    ]);

    $messages = null;
    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asDataStreamResponse();

    $response->getCallback()();

    expect($messages)->not->toBeNull();
    expect($messages)->toBeInstanceOf(Collection::class);
})->skip('Outputs stream contents');

it('assistant message contains accumulated text from multiple deltas', function (): void {
    $longText = 'This is a longer message that will be chunked into multiple deltas during streaming.';

    Prism::fake([
        TextResponseFake::make()->withText($longText),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages->first()->content)->toBe($longText);
});

it('assistant message includes tool calls when present', function (): void {
    $toolCall = new ToolCall('tool-123', 'search', ['query' => 'test']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Let me search')
                ->withToolCalls([$toolCall]),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Search something')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->toolCalls)->toHaveCount(1);
    expect($messages->first()->toolCalls[0]->name)->toBe('search');
    expect($messages->first()->toolCalls[0]->arguments())->toBe(['query' => 'test']);
});

it('tool result message is included when tools are executed', function (): void {
    $toolCall = new ToolCall('tool-1', 'calculator', ['x' => 5, 'y' => 3]);
    $toolResult = new ToolResult('tool-1', 'calculator', ['x' => 5, 'y' => 3], ['result' => 8]);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withToolCalls([$toolCall]),
            TextStepFake::make()->withToolResults([$toolResult]),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Calculate')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(2);
    expect($messages[0])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[1])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[1]->toolResults)->toHaveCount(1);
    expect($messages[1]->toolResults[0]->result)->toBe(['result' => 8]);
});

it('multi-step conversations produce multiple assistant and tool result message pairs', function (): void {
    $toolCall1 = new ToolCall('tool-1', 'search', ['q' => 'Laravel']);
    $toolResult1 = new ToolResult('tool-1', 'search', ['q' => 'Laravel'], ['result' => 'PHP Framework']);
    $toolCall2 = new ToolCall('tool-2', 'calculate', ['x' => 10]);
    $toolResult2 = new ToolResult('tool-2', 'calculate', ['x' => 10], ['result' => 20]);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Let me search')
                ->withToolCalls([$toolCall1]),
            TextStepFake::make()->withToolResults([$toolResult1]),
            TextStepFake::make()
                ->withText('Now calculating')
                ->withToolCalls([$toolCall2]),
            TextStepFake::make()->withToolResults([$toolResult2]),
            TextStepFake::make()->withText('All done'),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Complex task')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(5);
    expect($messages[0])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[0]->content)->toBe('Let me search');
    expect($messages[0]->toolCalls)->toHaveCount(1);
    expect($messages[1])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[2])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[2]->content)->toBe('Now calculating');
    expect($messages[2]->toolCalls)->toHaveCount(1);
    expect($messages[3])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[4])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[4]->content)->toBe('All done');
    expect($messages[4]->toolCalls)->toBeEmpty();
});

it('handles simple text-only response', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Simple response'),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Hello')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Simple response');
    expect($messages->first()->toolCalls)->toBeEmpty();
});

it('handles response containing tool calls', function (): void {
    $toolCall1 = new ToolCall('tool-1', 'weather', ['location' => 'NYC']);
    $toolCall2 = new ToolCall('tool-2', 'time', ['timezone' => 'EST']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Checking weather and time')
                ->withToolCalls([$toolCall1, $toolCall2]),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Weather and time in NYC')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->toolCalls)->toHaveCount(2);
    expect($messages->first()->toolCalls[0]->name)->toBe('weather');
    expect($messages->first()->toolCalls[1]->name)->toBe('time');
});

it('handles multi-turn tool execution with text response', function (): void {
    $toolCall = new ToolCall('tool-1', 'database', ['query' => 'SELECT * FROM users']);
    $toolResult = new ToolResult('tool-1', 'database', ['query' => 'SELECT * FROM users'], ['count' => 42]);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Querying database')
                ->withToolCalls([$toolCall]),
            TextStepFake::make()->withToolResults([$toolResult]),
            TextStepFake::make()->withText('Found 42 users in the database'),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('How many users?')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(3);
    expect($messages[0])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[0]->content)->toBe('Querying database');
    expect($messages[1])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[2])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[2]->content)->toBe('Found 42 users in the database');
});

it('handles empty response', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText(''),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toBeInstanceOf(Collection::class);
    expect($messages)->toBeEmpty();
});

it('handles response with only tool calls and no text', function (): void {
    $toolCall = new ToolCall('tool-1', 'search', ['query' => 'test']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('')
                ->withToolCalls([$toolCall]),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Search')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('');
    expect($messages->first()->toolCalls)->toHaveCount(1);
});

it('handles multiple consecutive tool results', function (): void {
    $toolResult1 = new ToolResult('tool-1', 'search', ['q' => 'a'], ['result' => 'A']);
    $toolResult2 = new ToolResult('tool-2', 'search', ['q' => 'b'], ['result' => 'B']);
    $toolResult3 = new ToolResult('tool-3', 'search', ['q' => 'c'], ['result' => 'C']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withToolResults([$toolResult1, $toolResult2, $toolResult3]),
        ])),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Multi-tool')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(ToolResultMessage::class);
    expect($messages->first()->toolResults)->toHaveCount(3);
});

it('callback receives messages collection type correctly', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Type test'),
    ]);

    $receivedType = null;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$receivedType): void {
            $receivedType = $messages::class;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($receivedType)->toBe(Collection::class);
});

it('callback receives collection implementing correct interface', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Interface test'),
    ]);

    $implementsCountable = false;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$implementsCountable): void {
            $implementsCountable = $messages instanceof Countable;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($implementsCountable)->toBeTrue();
});

it('callback can access all message properties', function (): void {
    $toolCall = new ToolCall('tool-1', 'test', ['key' => 'value']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Test content')
                ->withToolCalls([$toolCall]),
        ])),
    ]);

    $contentAccessed = false;
    $toolCallsAccessed = false;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$contentAccessed, &$toolCallsAccessed): void {
            /** @var AssistantMessage $message */
            $message = $messages->first();
            $contentAccessed = $message->content === 'Test content';
            $toolCallsAccessed = count($message->toolCalls) === 1;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($contentAccessed)->toBeTrue();
    expect($toolCallsAccessed)->toBeTrue();
});

it('works with unicode and special characters in messages', function (): void {
    $unicodeText = '🚀 Hello 世界! Special chars: "quotes" & \'apostrophes\'';

    Prism::fake([
        TextResponseFake::make()->withText($unicodeText),
    ]);

    $messages = null;
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Unicode test')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messages->first()->content)->toBe($unicodeText);
});

it('callback is invoked exactly once per stream', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Invocation count test'),
    ]);

    $invocationCount = 0;
    $stream = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$invocationCount): void {
            $invocationCount++;
        })
        ->asStream();

    iterator_to_array($stream);

    expect($invocationCount)->toBe(1);
});

it('separate streams invoke callback independently', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('First stream'),
    ]);

    $firstMessages = null;
    $stream1 = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test 1')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$firstMessages): void {
            $firstMessages = $messages;
        })
        ->asStream();

    iterator_to_array($stream1);

    Prism::fake([
        TextResponseFake::make()->withText('Second stream'),
    ]);

    $secondMessages = null;
    $stream2 = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test 2')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$secondMessages): void {
            $secondMessages = $messages;
        })
        ->asStream();

    iterator_to_array($stream2);

    expect($firstMessages->first()->content)->toBe('First stream');
    expect($secondMessages->first()->content)->toBe('Second stream');
});

it('collection messages maintain proper types', function (): void {
    $toolCall = new ToolCall('tool-1', 'test', []);
    $toolResult = new ToolResult('tool-1', 'test', [], []);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withText('Step 1')->withToolCalls([$toolCall]),
            TextStepFake::make()->withToolResults([$toolResult]),
            TextStepFake::make()->withText('Step 2'),
        ])),
    ]);

    $messageTypes = [];
    $stream = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Multi-step')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$messageTypes): void {
            $messageTypes = $messages->map(fn (Message $m): string => $m::class)->toArray();
        })
        ->asStream();

    iterator_to_array($stream);

    expect($messageTypes)->toBe([
        AssistantMessage::class,
        ToolResultMessage::class,
        AssistantMessage::class,
    ]);
});

it('invokes callback with collection of messages for asText response', function (): void {
    $assistantMessage = new AssistantMessage('Hello World');

    Prism::fake([
        TextResponseFake::make()
            ->withText('Hello World')
            ->withMessages(collect([$assistantMessage])),
    ]);

    $messages = null;
    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test prompt')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asText();

    expect($messages)->toBeInstanceOf(Collection::class);
    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Hello World');
});

it('callback receives messages with tool calls for asText', function (): void {
    $toolCall = new ToolCall('tool-1', 'search', ['query' => 'test']);
    $assistantMessage = new AssistantMessage('Searching', [$toolCall]);

    Prism::fake([
        TextResponseFake::make()
            ->withSteps(collect([
                TextStepFake::make()
                    ->withText('Searching')
                    ->withToolCalls([$toolCall]),
            ]))
            ->withMessages(collect([$assistantMessage])),
    ]);

    $messages = null;
    $response = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Search something')
        ->onComplete(function (PendingRequest $request, Collection $responseMessages) use (&$messages): void {
            $messages = $responseMessages;
        })
        ->asText();

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->toolCalls)->toHaveCount(1);
});

it('asText does not fail when callback is not set', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asText();

    expect($response)->toBeInstanceOf(\Prism\Prism\Text\Response::class);
    expect($response->text)->toBe('Hello World');
});

it('asText callback can be an invokable class', function (): void {
    $assistantMessage = new AssistantMessage('Test message');

    Prism::fake([
        TextResponseFake::make()
            ->withText('Test message')
            ->withMessages(collect([$assistantMessage])),
    ]);

    $invokable = new class
    {
        public ?Collection $receivedMessages = null;

        public function __invoke(PendingRequest $request, Collection $messages): void
        {
            $this->receivedMessages = $messages;
        }
    };

    $response = Prism::text()
        ->using('anthropic', 'claude-sonnet-4-5-20250929')
        ->withPrompt('Test')
        ->onComplete($invokable)
        ->asText();

    expect($invokable->receivedMessages)->toBeInstanceOf(Collection::class);
    expect($invokable->receivedMessages)->toHaveCount(1);
});

it('asText still returns response object when callback is set', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test response'),
    ]);

    $callbackInvoked = false;
    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->onComplete(function (PendingRequest $request, Collection $messages) use (&$callbackInvoked): void {
            $callbackInvoked = true;
        })
        ->asText();

    expect($callbackInvoked)->toBeTrue();
    expect($response)->toBeInstanceOf(\Prism\Prism\Text\Response::class);
    expect($response->text)->toBe('Test response');
});



================================================
FILE: tests/Streaming/PrismStreamIntegrationTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Broadcasting\PrivateChannel;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;
use Symfony\Component\HttpFoundation\StreamedResponse;

it('asStream returns generator of stream events with simple text response', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Test prompt')
        ->asStream();

    expect($events)->toBeInstanceOf(Generator::class);

    $eventArray = iterator_to_array($events);

    expect(count($eventArray))->toBeGreaterThanOrEqual(5);
    expect($eventArray[0])->toBeInstanceOf(StreamStartEvent::class);
    expect($eventArray[1])->toBeInstanceOf(TextStartEvent::class);

    $lastIndex = count($eventArray) - 1;
    expect($eventArray[$lastIndex])->toBeInstanceOf(StreamEndEvent::class);
    expect($eventArray[$lastIndex - 1])->toBeInstanceOf(TextCompleteEvent::class);
});

it('asStream yields text delta events with chunked content', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello World'),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $textDeltas = [];
    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $textDeltas[] = $event->delta;
        }
    }

    $reconstructedText = implode('', $textDeltas);
    expect($reconstructedText)->toBe('Hello World');
    expect(count($textDeltas))->toBeGreaterThan(1);
});

it('asStream includes stream start event with model and provider info', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test'),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-opus')
        ->withPrompt('Test')
        ->asStream();

    $startEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamStartEvent) {
            $startEvent = $event;

            break;
        }
    }

    expect($startEvent)->not->toBeNull();
    expect($startEvent->model)->toBe('claude-3-opus');
    expect($startEvent->provider)->toBe('fake');
});

it('asStream includes stream end event with finish reason and usage', function (): void {
    Prism::fake([
        TextResponseFake::make()
            ->withText('Test response')
            ->withFinishReason(FinishReason::Stop)
            ->withUsage(new Usage(100, 50)),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $endEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamEndEvent) {
            $endEvent = $event;
        }
    }

    expect($endEvent)->not->toBeNull();
    expect($endEvent->finishReason)->toBe(FinishReason::Stop);
    expect($endEvent->usage)->not->toBeNull();
    expect($endEvent->usage->promptTokens)->toBe(100);
    expect($endEvent->usage->completionTokens)->toBe(50);
});

it('asStream handles responses with tool calls', function (): void {
    $toolCall = new ToolCall('tool-123', 'search', ['query' => 'test']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Let me search for that')
                ->withToolCalls([$toolCall]),
        ])),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Search for something')
        ->asStream();

    $toolCallEvents = [];
    foreach ($events as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
        }
    }

    expect($toolCallEvents)->toHaveCount(1);
    expect($toolCallEvents[0]->toolCall->name)->toBe('search');
    expect($toolCallEvents[0]->toolCall->arguments())->toBe(['query' => 'test']);
});

it('asStream handles responses with tool results', function (): void {
    $toolResult = new ToolResult('tool-123', 'search', ['query' => 'test'], ['result' => 'found']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withToolResults([$toolResult]),
        ])),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $toolResultEvents = [];
    foreach ($events as $event) {
        if ($event instanceof ToolResultEvent) {
            $toolResultEvents[] = $event;
        }
    }

    expect($toolResultEvents)->toHaveCount(1);
    expect($toolResultEvents[0]->toolResult->result)->toBe(['result' => 'found']);
    expect($toolResultEvents[0]->success)->toBeTrue();
});

it('asStream handles empty text response', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText(''),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $eventArray = iterator_to_array($events);

    expect($eventArray)->toHaveCount(2);
    expect($eventArray[0])->toBeInstanceOf(StreamStartEvent::class);
    expect($eventArray[1])->toBeInstanceOf(StreamEndEvent::class);
});

it('asStream handles multi-step responses with text and tool calls', function (): void {
    $toolCall = new ToolCall('tool-1', 'calculator', ['operation' => 'add', 'a' => 1, 'b' => 2]);
    $toolResult = new ToolResult('tool-1', 'calculator', ['operation' => 'add', 'a' => 1, 'b' => 2], ['result' => 3]);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('Let me calculate that')
                ->withToolCalls([$toolCall]),
            TextStepFake::make()
                ->withToolResults([$toolResult]),
            TextStepFake::make()
                ->withText('The result is 3'),
        ])),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('What is 1 + 2?')
        ->asStream();

    $eventTypes = [];
    foreach ($events as $event) {
        $eventTypes[] = $event::class;
    }

    expect($eventTypes)->toContain(StreamStartEvent::class);
    expect($eventTypes)->toContain(TextStartEvent::class);
    expect($eventTypes)->toContain(TextDeltaEvent::class);
    expect($eventTypes)->toContain(TextCompleteEvent::class);
    expect($eventTypes)->toContain(ToolCallEvent::class);
    expect($eventTypes)->toContain(ToolResultEvent::class);
    expect($eventTypes)->toContain(StreamEndEvent::class);
});

it('asStream maintains correct event sequence order', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test message'),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $eventArray = iterator_to_array($events);

    expect($eventArray[0])->toBeInstanceOf(StreamStartEvent::class);
    expect(end($eventArray))->toBeInstanceOf(StreamEndEvent::class);
});

it('asEventStreamResponse returns streamed response with SSE headers', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello from SSE'),
    ]);

    $response = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Test')
        ->asEventStreamResponse();

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->headers->get('Content-Type'))->toBe('text/event-stream');
    expect($response->headers->get('Cache-Control'))->toContain('no-cache');
    expect($response->headers->get('X-Accel-Buffering'))->toBe('no');
    expect($response->headers->get('Connection'))->toBe('keep-alive');
});

it('asEventStreamResponse callback outputs valid SSE format', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test'),
    ]);

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asEventStreamResponse();

    $callback = $response->getCallback();
    expect($callback)->toBeCallable();

    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return '';
    });

    try {
        $callback();
        $output = ob_get_clean();

        rewind($outputBuffer);
        $output = stream_get_contents($outputBuffer);

        expect($output)->toContain('event: stream_start');
        expect($output)->toContain('event: text_delta');
        expect($output)->toContain('event: stream_end');
        expect($output)->toContain('data: ');
    } finally {
        fclose($outputBuffer);
    }
});

it('asDataStreamResponse returns streamed response with correct headers', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Hello from Data Protocol'),
    ]);

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asDataStreamResponse();

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->headers->get('Content-Type'))->toBe('text/plain; charset=utf-8');
    expect($response->headers->get('Cache-Control'))->toContain('no-cache');
    expect($response->headers->get('Cache-Control'))->toContain('no-transform');
    expect($response->headers->get('X-Accel-Buffering'))->toBe('no');
});

it('asDataStreamResponse callback outputs valid data protocol format', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test'),
    ]);

    $response = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asDataStreamResponse();

    $callback = $response->getCallback();
    expect($callback)->toBeCallable();

    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return '';
    });

    try {
        $callback();
        $output = ob_get_clean();

        rewind($outputBuffer);
        $output = stream_get_contents($outputBuffer);

        expect($output)->toContain('data:');
        expect($output)->toContain('"type"');
        expect($output)->toContain('"delta"');
    } finally {
        fclose($outputBuffer);
    }
});

it('asBroadcast dispatches events to specified channel', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Broadcast test'),
    ]);

    $channel = new PrivateChannel('test-channel');

    expect(fn () => Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Test')
        ->asBroadcast($channel)
    )->not->toThrow(Exception::class);
});

it('asBroadcast accepts array of channels', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Multi-channel broadcast'),
    ]);

    $channels = [
        new PrivateChannel('channel-1'),
        new PrivateChannel('channel-2'),
    ];

    expect(fn () => Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asBroadcast($channels)
    )->not->toThrow(Exception::class);
});

it('streaming methods work with different providers', function (): void {
    $providers = [
        ['anthropic', 'claude-3-sonnet'],
        ['openai', 'gpt-4'],
        ['openai', 'gpt-4o'],
    ];

    foreach ($providers as [$provider, $model]) {
        Prism::fake([
            TextResponseFake::make()->withText('Provider test'),
        ]);

        $events = Prism::text()
            ->using($provider, $model)
            ->withPrompt('Test')
            ->asStream();

        $eventArray = iterator_to_array($events);

        expect($eventArray)->not->toBeEmpty();
        expect($eventArray[0])->toBeInstanceOf(StreamStartEvent::class);
        expect(end($eventArray))->toBeInstanceOf(StreamEndEvent::class);
    }
});

it('streaming with custom chunk size produces more or fewer events', function (): void {
    $fake = Prism::fake([
        TextResponseFake::make()->withText('This is a test message'),
    ]);

    $fake->withFakeChunkSize(3);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $textDeltas = [];
    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $textDeltas[] = $event;
        }
    }

    expect(count($textDeltas))->toBeGreaterThan(3);
});

it('asStream can be consumed multiple times with separate fake instances', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('First call'),
    ]);

    $events1 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asStream();
    $eventArray1 = iterator_to_array($events1);

    Prism::fake([
        TextResponseFake::make()->withText('Second call'),
    ]);

    $events2 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asStream();
    $eventArray2 = iterator_to_array($events2);

    expect($eventArray1)->not->toBeEmpty();
    expect($eventArray2)->not->toBeEmpty();
});

it('all stream events have valid IDs and timestamps', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('ID and timestamp test'),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    foreach ($events as $event) {
        expect($event->id)->toBeString();
        expect($event->id)->not->toBeEmpty();
        expect($event->timestamp)->toBeInt();
        expect($event->timestamp)->toBeGreaterThan(0);
    }
});

it('all stream events can be converted to array', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Array conversion test'),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    foreach ($events as $event) {
        $array = $event->toArray();
        expect($array)->toBeArray();
        expect($array)->toHaveKey('id');
        expect($array)->toHaveKey('timestamp');
    }
});

it('asStream handles finish reason content_filter correctly', function (): void {
    Prism::fake([
        TextResponseFake::make()
            ->withText('Response')
            ->withFinishReason(FinishReason::ContentFilter),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Test')
        ->asStream();

    $endEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamEndEvent) {
            $endEvent = $event;
        }
    }

    expect($endEvent)->not->toBeNull();
    expect($endEvent->finishReason)->toBe(FinishReason::ContentFilter);
});

it('asStream handles finish reason max_tokens correctly', function (): void {
    Prism::fake([
        TextResponseFake::make()
            ->withText('Response cut off due to max tokens')
            ->withFinishReason(FinishReason::Length),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $endEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamEndEvent) {
            $endEvent = $event;
        }
    }

    expect($endEvent)->not->toBeNull();
    expect($endEvent->finishReason)->toBe(FinishReason::Length);
});

it('asStream handles finish reason tool_calls correctly', function (): void {
    $toolCall = new ToolCall('tool-1', 'calculator', ['op' => 'add']);

    Prism::fake([
        TextResponseFake::make()
            ->withSteps(collect([
                TextStepFake::make()->withToolCalls([$toolCall]),
            ]))
            ->withFinishReason(FinishReason::ToolCalls),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Calculate something')
        ->asStream();

    $endEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamEndEvent) {
            $endEvent = $event;
        }
    }

    expect($endEvent)->not->toBeNull();
    expect($endEvent->finishReason)->toBe(FinishReason::ToolCalls);
});

it('asStream maintains message ID consistency across events', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('Test message'),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $messageIds = [];
    foreach ($events as $event) {
        if ($event instanceof TextStartEvent || $event instanceof TextDeltaEvent || $event instanceof TextCompleteEvent) {
            $messageIds[] = $event->messageId;
        }
    }

    expect($messageIds)->not->toBeEmpty();
    $firstMessageId = $messageIds[0];
    foreach ($messageIds as $messageId) {
        expect($messageId)->toBe($firstMessageId);
    }
});

it('asStream handles very long text response', function (): void {
    $longText = str_repeat('This is a long text. ', 100);

    Prism::fake([
        TextResponseFake::make()->withText($longText),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Generate long text')
        ->asStream();

    $accumulatedText = '';
    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $accumulatedText .= $event->delta;
        }
    }

    expect($accumulatedText)->toBe($longText);
});

it('asStream handles unicode and emoji in text', function (): void {
    $unicodeText = '🚀 Hello 世界! Héllo Wørld 🎉';

    Prism::fake([
        TextResponseFake::make()->withText($unicodeText),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Test')
        ->asStream();

    $accumulatedText = '';
    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $accumulatedText .= $event->delta;
        }
    }

    expect($accumulatedText)->toBe($unicodeText);
});

it('asStream handles special characters in text', function (): void {
    $specialText = 'Test with "quotes" and \'apostrophes\' and \n newlines \t tabs';

    Prism::fake([
        TextResponseFake::make()->withText($specialText),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $accumulatedText = '';
    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $accumulatedText .= $event->delta;
        }
    }

    expect($accumulatedText)->toBe($specialText);
});

it('asStream handles responses with complex nested tool arguments', function (): void {
    $complexArgs = [
        'query' => 'search term',
        'options' => [
            'filters' => [
                'category' => ['tech', 'science'],
                'date' => ['from' => '2024-01-01', 'to' => '2024-12-31'],
            ],
            'limit' => 10,
            'sort' => ['field' => 'relevance', 'order' => 'desc'],
        ],
        'metadata' => null,
    ];

    $toolCall = new ToolCall('tool-123', 'complex_search', $complexArgs);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withToolCalls([$toolCall]),
        ])),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $toolCallEvents = [];
    foreach ($events as $event) {
        if ($event instanceof ToolCallEvent) {
            $toolCallEvents[] = $event;
        }
    }

    expect($toolCallEvents)->toHaveCount(1);
    expect($toolCallEvents[0]->toolCall->arguments())->toBe($complexArgs);
});

it('asStream handles zero token usage', function (): void {
    Prism::fake([
        TextResponseFake::make()
            ->withText('Test')
            ->withUsage(new Usage(0, 0)),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $endEvent = null;
    foreach ($events as $event) {
        if ($event instanceof StreamEndEvent) {
            $endEvent = $event;
        }
    }

    expect($endEvent)->not->toBeNull();
    expect($endEvent->usage)->not->toBeNull();
    expect($endEvent->usage->promptTokens)->toBe(0);
    expect($endEvent->usage->completionTokens)->toBe(0);
});

it('asStream handles responses with only tool calls no text', function (): void {
    $toolCall = new ToolCall('tool-123', 'search', ['query' => 'test']);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()
                ->withText('')
                ->withToolCalls([$toolCall]),
        ])),
    ]);

    $events = Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('Search')
        ->asStream();

    $hasTextDelta = false;
    $hasToolCall = false;

    foreach ($events as $event) {
        if ($event instanceof TextDeltaEvent) {
            $hasTextDelta = true;
        }
        if ($event instanceof ToolCallEvent) {
            $hasToolCall = true;
        }
    }

    expect($hasToolCall)->toBeTrue();
    expect($hasTextDelta)->toBeFalse();
});

it('asStream maintains event ordering with multiple steps', function (): void {
    $toolCall = new ToolCall('tool-1', 'search', ['q' => 'test']);
    $toolResult = new ToolResult('tool-1', 'search', ['q' => 'test'], ['found' => true]);

    Prism::fake([
        TextResponseFake::make()->withSteps(collect([
            TextStepFake::make()->withText('First'),
            TextStepFake::make()->withToolCalls([$toolCall]),
            TextStepFake::make()->withToolResults([$toolResult]),
            TextStepFake::make()->withText('Last'),
        ])),
    ]);

    $events = Prism::text()
        ->using('openai', 'gpt-4')
        ->withPrompt('Test')
        ->asStream();

    $eventTypes = [];
    foreach ($events as $event) {
        $eventTypes[] = $event::class;
    }

    $streamStartIndex = array_search(StreamStartEvent::class, $eventTypes);
    $firstToolCallIndex = array_search(ToolCallEvent::class, $eventTypes);
    $toolResultIndex = array_search(ToolResultEvent::class, $eventTypes);
    $streamEndIndex = array_search(StreamEndEvent::class, $eventTypes);

    expect($streamStartIndex)->toBeLessThan($firstToolCallIndex);
    expect($firstToolCallIndex)->toBeLessThan($toolResultIndex);
    expect($toolResultIndex)->toBeLessThan($streamEndIndex);
});

it('asEventStreamResponse works after multiple fake setups', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('First'),
    ]);

    $response1 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asEventStreamResponse();

    Prism::fake([
        TextResponseFake::make()->withText('Second'),
    ]);

    $response2 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asEventStreamResponse();

    expect($response1)->toBeInstanceOf(StreamedResponse::class);
    expect($response2)->toBeInstanceOf(StreamedResponse::class);
});

it('asDataStreamResponse works after multiple fake setups', function (): void {
    Prism::fake([
        TextResponseFake::make()->withText('First'),
    ]);

    $response1 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asDataStreamResponse();

    Prism::fake([
        TextResponseFake::make()->withText('Second'),
    ]);

    $response2 = Prism::text()->using('openai', 'gpt-4')->withPrompt('Test')->asDataStreamResponse();

    expect($response1)->toBeInstanceOf(StreamedResponse::class);
    expect($response2)->toBeInstanceOf(StreamedResponse::class);
});



================================================
FILE: tests/Streaming/StreamCollectorTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Support\Collection;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Streaming\StreamCollector;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\ToolResultMessage;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;

/**
 * @param  array<\Prism\Prism\Streaming\Events\StreamEvent>  $events
 * @return \Generator<\Prism\Prism\Streaming\Events\StreamEvent>
 */
function createCollectorEventGenerator(array $events): \Generator
{
    foreach ($events as $event) {
        yield $event;
    }
}

it('yields all events from stream as pass-through', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextStartEvent('evt-2', 1640995201, 'msg-1'),
        new TextDeltaEvent('evt-3', 1640995202, 'Hello', 'msg-1'),
        new TextDeltaEvent('evt-4', 1640995203, ' World', 'msg-1'),
        new StreamEndEvent('evt-5', 1640995204, FinishReason::Stop),
    ];

    $collector = new StreamCollector(createCollectorEventGenerator($events));
    $yieldedEvents = iterator_to_array($collector->collect());

    expect($yieldedEvents)->toHaveCount(5);
    expect($yieldedEvents[0])->toBe($events[0]);
    expect($yieldedEvents[1])->toBe($events[1]);
    expect($yieldedEvents[2])->toBe($events[2]);
    expect($yieldedEvents[3])->toBe($events[3]);
    expect($yieldedEvents[4])->toBe($events[4]);
});

it('accumulates text from multiple text delta events', function (): void {
    $messages = null;

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-1'),
        new TextDeltaEvent('evt-3', 1640995202, ' ', 'msg-1'),
        new TextDeltaEvent('evt-4', 1640995203, 'World', 'msg-1'),
        new StreamEndEvent('evt-5', 1640995204, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toBeInstanceOf(Collection::class);
    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Hello World');
});

it('collects tool calls from tool call events', function (): void {
    $messages = null;

    $toolCall1 = new ToolCall('tool-1', 'search', ['q' => 'test']);
    $toolCall2 = new ToolCall('tool-2', 'calculate', ['x' => 5, 'y' => 10]);

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'Let me help', 'msg-1'),
        new ToolCallEvent('evt-3', 1640995202, $toolCall1, 'msg-1'),
        new ToolCallEvent('evt-4', 1640995203, $toolCall2, 'msg-1'),
        new StreamEndEvent('evt-5', 1640995204, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Let me help');
    expect($messages->first()->toolCalls)->toHaveCount(2);
    expect($messages->first()->toolCalls[0])->toBe($toolCall1);
    expect($messages->first()->toolCalls[1])->toBe($toolCall2);
});

it('collects tool results from tool result events', function (): void {
    $messages = null;

    $toolCall = new ToolCall('tool-1', 'search', ['q' => 'test']);
    $toolResult = new ToolResult('tool-1', 'search', ['q' => 'test'], ['result' => 'found']);

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new ToolCallEvent('evt-2', 1640995201, $toolCall, 'msg-1'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::ToolCalls),
        new ToolResultEvent('evt-4', 1640995203, $toolResult, 'msg-2', true),
        new StreamEndEvent('evt-5', 1640995204, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(2);
    expect($messages[0])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[0]->toolCalls)->toHaveCount(1);
    expect($messages[1])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[1]->toolResults)->toHaveCount(1);
    expect($messages[1]->toolResults[0])->toBe($toolResult);
});

it('handles multi-step conversation with multiple message pairs', function (): void {
    $messages = null;

    $toolCall1 = new ToolCall('tool-1', 'search', ['q' => 'Laravel']);
    $toolResult1 = new ToolResult('tool-1', 'search', ['q' => 'Laravel'], ['result' => 'PHP Framework']);
    $toolCall2 = new ToolCall('tool-2', 'calculate', ['x' => 5]);
    $toolResult2 = new ToolResult('tool-2', 'calculate', ['x' => 5], ['result' => 10]);

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'First response', 'msg-1'),
        new ToolCallEvent('evt-3', 1640995202, $toolCall1, 'msg-1'),
        new ToolResultEvent('evt-4', 1640995203, $toolResult1, 'msg-2', true),
        new TextStartEvent('evt-5', 1640995204, 'msg-3'),
        new TextDeltaEvent('evt-6', 1640995205, 'Second response', 'msg-3'),
        new ToolCallEvent('evt-7', 1640995206, $toolCall2, 'msg-3'),
        new ToolResultEvent('evt-8', 1640995207, $toolResult2, 'msg-4', true),
        new TextStartEvent('evt-9', 1640995208, 'msg-5'),
        new TextDeltaEvent('evt-10', 1640995209, 'Final response', 'msg-5'),
        new StreamEndEvent('evt-11', 1640995210, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(5);
    expect($messages[0])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[0]->content)->toBe('First response');
    expect($messages[0]->toolCalls)->toHaveCount(1);
    expect($messages[1])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[1]->toolResults)->toHaveCount(1);
    expect($messages[2])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[2]->content)->toBe('Second response');
    expect($messages[2]->toolCalls)->toHaveCount(1);
    expect($messages[3])->toBeInstanceOf(ToolResultMessage::class);
    expect($messages[3]->toolResults)->toHaveCount(1);
    expect($messages[4])->toBeInstanceOf(AssistantMessage::class);
    expect($messages[4]->content)->toBe('Final response');
    expect($messages[4]->toolCalls)->toBeEmpty();
});

it('works without callback', function (): void {
    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-1'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $collector = new StreamCollector(createCollectorEventGenerator($events));
    $yieldedEvents = iterator_to_array($collector->collect());

    expect($yieldedEvents)->toHaveCount(3);
});

it('handles empty stream', function (): void {
    $messages = null;

    $collector = new StreamCollector(
        createCollectorEventGenerator([]),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    $yieldedEvents = iterator_to_array($collector->collect());

    expect($yieldedEvents)->toBeEmpty();
    expect($messages)->toBeNull();
});

it('handles stream with only stream end event', function (): void {
    $messages = null;

    $events = [
        new StreamEndEvent('evt-1', 1640995200, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toBeInstanceOf(Collection::class);
    expect($messages)->toBeEmpty();
});

it('handles stream with text only', function (): void {
    $messages = null;

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello World', 'msg-1'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('Hello World');
    expect($messages->first()->toolCalls)->toBeEmpty();
});

it('handles stream with tool calls only', function (): void {
    $messages = null;

    $toolCall = new ToolCall('tool-1', 'search', ['q' => 'test']);

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new ToolCallEvent('evt-2', 1640995201, $toolCall, 'msg-1'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::ToolCalls),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(AssistantMessage::class);
    expect($messages->first()->content)->toBe('');
    expect($messages->first()->toolCalls)->toHaveCount(1);
});

it('handles multiple tool results in single message', function (): void {
    $messages = null;

    $toolResult1 = new ToolResult('tool-1', 'search', ['q' => 'test1'], ['result' => 'found1']);
    $toolResult2 = new ToolResult('tool-2', 'search', ['q' => 'test2'], ['result' => 'found2']);

    $events = [
        new ToolResultEvent('evt-1', 1640995200, $toolResult1, 'msg-1', true),
        new ToolResultEvent('evt-2', 1640995201, $toolResult2, 'msg-1', true),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$messages): void {
            $messages = $collected;
        }
    );

    iterator_to_array($collector->collect());

    expect($messages)->toHaveCount(1);
    expect($messages->first())->toBeInstanceOf(ToolResultMessage::class);
    expect($messages->first()->toolResults)->toHaveCount(2);
    expect($messages->first()->toolResults[0])->toBe($toolResult1);
    expect($messages->first()->toolResults[1])->toBe($toolResult2);
});

it('invokes callback with collection instance', function (): void {
    $receivedType = null;

    $events = [
        new TextStartEvent('evt-1', 1640995200, 'msg-1'),
        new TextDeltaEvent('evt-2', 1640995201, 'Test', 'msg-1'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $collector = new StreamCollector(
        createCollectorEventGenerator($events),
        null,
        function ($request, Collection $collected) use (&$receivedType): void {
            $receivedType = $collected::class;
        }
    );

    iterator_to_array($collector->collect());

    expect($receivedType)->toBe(Collection::class);
});

it('preserves event data integrity during pass-through', function (): void {
    $toolCall = new ToolCall('tool-1', 'search', ['q' => 'test', 'limit' => 10]);
    $toolResult = new ToolResult('tool-1', 'search', ['q' => 'test', 'limit' => 10], ['items' => [1, 2, 3]]);

    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextStartEvent('evt-2', 1640995201, 'msg-1'),
        new TextDeltaEvent('evt-3', 1640995202, 'Testing', 'msg-1'),
        new ToolCallEvent('evt-4', 1640995203, $toolCall, 'msg-1'),
        new ToolResultEvent('evt-5', 1640995204, $toolResult, 'msg-2', true),
        new StreamEndEvent('evt-6', 1640995205, FinishReason::Stop),
    ];

    $collector = new StreamCollector(createCollectorEventGenerator($events));
    $yieldedEvents = iterator_to_array($collector->collect());

    expect($yieldedEvents[0]->model)->toBe('gpt-4');
    expect($yieldedEvents[0]->provider)->toBe('openai');
    expect($yieldedEvents[2]->delta)->toBe('Testing');
    expect($yieldedEvents[3]->toolCall->name)->toBe('search');
    expect($yieldedEvents[3]->toolCall->arguments())->toBe(['q' => 'test', 'limit' => 10]);
    expect($yieldedEvents[4]->toolResult->result)->toBe(['items' => [1, 2, 3]]);
    expect($yieldedEvents[5]->finishReason)->toBe(FinishReason::Stop);
});



================================================
FILE: tests/Streaming/Adapters/BroadcastAdapterTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Broadcasting\Channel;
use Illuminate\Broadcasting\PrivateChannel;
use Illuminate\Support\Facades\Event;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Events\Broadcasting\ErrorBroadcast;
use Prism\Prism\Events\Broadcasting\StreamEndBroadcast;
use Prism\Prism\Events\Broadcasting\StreamStartBroadcast;
use Prism\Prism\Events\Broadcasting\TextCompleteBroadcast;
use Prism\Prism\Events\Broadcasting\TextDeltaBroadcast;
use Prism\Prism\Events\Broadcasting\TextStartBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingCompleteBroadcast;
use Prism\Prism\Events\Broadcasting\ThinkingStartBroadcast;
use Prism\Prism\Events\Broadcasting\ToolCallBroadcast;
use Prism\Prism\Events\Broadcasting\ToolResultBroadcast;
use Prism\Prism\Streaming\Adapters\BroadcastAdapter;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

/**
 * @param  array<\Prism\Prism\Streaming\Events\StreamEvent>  $events
 */
function createBroadcastEventGenerator(array $events): Generator
{
    foreach ($events as $event) {
        yield $event;
    }
}

beforeEach(function (): void {
    Event::fake();
});

it('accepts channel configuration', function (): void {
    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);

    expect($adapter)->toBeInstanceOf(BroadcastAdapter::class);
});

it('accepts multiple channels', function (): void {
    $channels = [
        new Channel('channel-1'),
        new PrivateChannel('private-channel-1'),
    ];

    $adapter = new BroadcastAdapter($channels);

    expect($adapter)->toBeInstanceOf(BroadcastAdapter::class);
});

it('broadcasts text delta events correctly', function (): void {
    $event = new TextDeltaEvent('evt-123', 1640995200, 'Hello world', 'msg-456');
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(TextDeltaBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->id === $event->id
        && $broadcastEvent->event->delta === $event->delta
        && $broadcastEvent->channels === $channel);
});

it('broadcasts stream start events correctly', function (): void {
    $event = new StreamStartEvent('evt-123', 1640995200, 'gpt-4', 'openai');
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(StreamStartBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->id === $event->id
        && $broadcastEvent->event->model === $event->model
        && $broadcastEvent->event->provider === $event->provider
        && $broadcastEvent->channels === $channel);
});

it('broadcasts stream end events correctly', function (): void {
    $usage = new Usage(promptTokens: 10, completionTokens: 5);
    $event = new StreamEndEvent('evt-123', 1640995200, FinishReason::Stop, $usage);
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(StreamEndBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->id === $event->id
        && $broadcastEvent->event->finishReason === $event->finishReason
        && $broadcastEvent->event->usage === $event->usage
        && $broadcastEvent->channels === $channel);
});

it('broadcasts thinking events correctly', function (): void {
    $events = [
        new ThinkingStartEvent('evt-1', 1640995200, 'reasoning-123'),
        new ThinkingEvent('evt-2', 1640995201, 'Let me think...', 'reasoning-123'),
        new ThinkingCompleteEvent('evt-3', 1640995202, 'reasoning-123'),
    ];

    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator($events));

    Event::assertDispatched(ThinkingStartBroadcast::class);
    Event::assertDispatched(ThinkingBroadcast::class);
    Event::assertDispatched(ThinkingCompleteBroadcast::class);
});

it('broadcasts tool events correctly', function (): void {
    $events = [
        new ToolCallEvent('evt-1', 1640995200, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-2', 1640995201, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
    ];

    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator($events));

    Event::assertDispatched(ToolCallBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->toolCall->name === 'search'
        && $broadcastEvent->event->toolCall->arguments() === ['q' => 'test']);

    Event::assertDispatched(ToolResultBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->toolResult->result === ['result' => 'found']
        && $broadcastEvent->event->success === true);
});

it('broadcasts error events correctly', function (): void {
    $event = new ErrorEvent('evt-123', 1640995200, 'rate_limit', 'Rate limit exceeded', false);
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(ErrorBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->errorType === $event->errorType
        && $broadcastEvent->event->message === $event->message
        && $broadcastEvent->event->recoverable === $event->recoverable);
});

it('broadcasts to multiple channels', function (): void {
    $event = new TextDeltaEvent('evt-123', 1640995200, 'Hello', 'msg-456');
    $channels = [
        new Channel('channel-1'),
        new PrivateChannel('private-channel-1'),
    ];

    $adapter = new BroadcastAdapter($channels);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(TextDeltaBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->channels === $channels);
});

it('handles empty event stream', function (): void {
    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);

    // Should not throw any errors
    ($adapter)(createBroadcastEventGenerator([]));

    // No events should be dispatched
    Event::assertNothingDispatched();
});

it('broadcasts all event types in comprehensive stream', function (): void {
    $usage = new Usage(promptTokens: 10, completionTokens: 5);

    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new TextStartEvent('evt-2', 1640995201, 'msg-456'),
        new TextDeltaEvent('evt-3', 1640995202, 'Hello', 'msg-456'),
        new ThinkingStartEvent('evt-4', 1640995203, 'reasoning-123'),
        new ThinkingEvent('evt-5', 1640995204, 'Thinking...', 'reasoning-123'),
        new ThinkingCompleteEvent('evt-6', 1640995205, 'reasoning-123'),
        new ToolCallEvent('evt-7', 1640995206, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-8', 1640995207, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
        new TextDeltaEvent('evt-9', 1640995208, ' World!', 'msg-456'),
        new TextCompleteEvent('evt-10', 1640995209, 'msg-456'),
        new StreamEndEvent('evt-11', 1640995210, FinishReason::Stop, $usage),
    ];

    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator($events));

    // Verify all broadcast event types are dispatched
    Event::assertDispatched(StreamStartBroadcast::class);
    Event::assertDispatched(TextStartBroadcast::class);
    Event::assertDispatched(TextDeltaBroadcast::class);
    Event::assertDispatched(ThinkingStartBroadcast::class);
    Event::assertDispatched(ThinkingBroadcast::class);
    Event::assertDispatched(ThinkingCompleteBroadcast::class);
    Event::assertDispatched(ToolCallBroadcast::class);
    Event::assertDispatched(ToolResultBroadcast::class);
    Event::assertDispatched(TextCompleteBroadcast::class);
    Event::assertDispatched(StreamEndBroadcast::class);

    // Verify the correct number of events were dispatched
    Event::assertDispatchedTimes(TextDeltaBroadcast::class, 2); // Two text deltas
});

it('handles all supported event types without errors', function (): void {
    // Test that all currently supported event types can be processed
    // This test ensures the match statement covers all expected cases
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextStartEvent('evt-2', 1640995201, 'msg-456'),
        new TextDeltaEvent('evt-3', 1640995202, 'Hello', 'msg-456'),
        new TextCompleteEvent('evt-4', 1640995203, 'msg-456'),
        new ThinkingStartEvent('evt-5', 1640995204, 'reasoning-123'),
        new ThinkingEvent('evt-6', 1640995205, 'Thinking...', 'reasoning-123'),
        new ThinkingCompleteEvent('evt-7', 1640995206, 'reasoning-123'),
        new ToolCallEvent('evt-8', 1640995207, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-9', 1640995208, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
        new ErrorEvent('evt-10', 1640995209, 'test_error', 'Test error', true),
        new StreamEndEvent('evt-11', 1640995210, FinishReason::Stop),
    ];

    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);

    // Should not throw any exceptions
    ($adapter)(createBroadcastEventGenerator($events));

    // Verify all events were processed and dispatched
    expect(true)->toBeTrue(); // Test passes if no exceptions thrown
});

it('maintains event order when broadcasting', function (): void {
    $events = [];
    for ($i = 1; $i <= 5; $i++) {
        $events[] = new TextDeltaEvent("evt-{$i}", 1640995200 + $i, "text-{$i}", 'msg-456');
    }

    $channel = new Channel('test-channel');
    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator($events));

    // Verify all events were dispatched in order
    Event::assertDispatchedTimes(TextDeltaBroadcast::class, 5);
});

it('handles events with complex data structures', function (): void {
    $complexArgs = [
        'query' => 'search term',
        'options' => [
            'limit' => 10,
            'sort' => 'relevance',
            'filters' => ['category' => 'tech', 'date' => '2024'],
        ],
        'metadata' => null,
    ];

    $event = new ToolCallEvent('evt-1', 1640995200, new ToolCall('tool-123', 'complex_search', $complexArgs), 'msg-456');
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(ToolCallBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->toolCall->name === 'complex_search'
        && $broadcastEvent->event->toolCall->arguments() === $complexArgs);
});

it('handles events with unicode and special characters', function (): void {
    $event = new TextDeltaEvent('evt-1', 1640995200, '🚀 Hello 世界! "quoted" text', 'msg-456');
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(TextDeltaBroadcast::class, fn ($broadcastEvent): bool => $broadcastEvent->event->delta === '🚀 Hello 世界! "quoted" text');
});

it('validates broadcast event structure and data format', function (): void {
    $event = new TextDeltaEvent('evt-123', 1640995200, 'Hello world!', 'msg-456');
    $channel = new Channel('test-channel');

    $adapter = new BroadcastAdapter($channel);
    ($adapter)(createBroadcastEventGenerator([$event]));

    Event::assertDispatched(TextDeltaBroadcast::class, function ($broadcastEvent) use ($event, $channel): bool {
        // Verify the broadcast event has the correct structure
        expect($broadcastEvent)->toBeInstanceOf(TextDeltaBroadcast::class);
        expect($broadcastEvent->event)->toBe($event);
        expect($broadcastEvent->channels)->toBe($channel);

        // Verify broadcast event methods work correctly
        expect($broadcastEvent->broadcastAs())->toBe('text_delta');
        expect($broadcastEvent->broadcastOn())->toBe([$channel]);

        // Verify broadcast data contains correct event data
        $broadcastData = $broadcastEvent->broadcastWith();
        expect($broadcastData)->toBeArray();
        expect($broadcastData['id'])->toBe('evt-123');
        expect($broadcastData['timestamp'])->toBe(1640995200);
        expect($broadcastData['delta'])->toBe('Hello world!');
        expect($broadcastData['message_id'])->toBe('msg-456');

        return true;
    });
});

it('validates broadcast event structure for multiple event types', function (): void {
    $usage = new Usage(promptTokens: 10, completionTokens: 5);
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new ToolCallEvent('evt-2', 1640995201, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop, $usage),
    ];

    $channels = [
        new Channel('channel-1'),
        new PrivateChannel('private-channel-1'),
    ];

    $adapter = new BroadcastAdapter($channels);
    ($adapter)(createBroadcastEventGenerator($events));

    // Verify StreamStartBroadcast structure and data
    Event::assertDispatched(StreamStartBroadcast::class, function ($broadcastEvent) use ($channels): bool {
        expect($broadcastEvent->broadcastAs())->toBe('stream_start');
        expect($broadcastEvent->broadcastOn())->toBe($channels);

        $data = $broadcastEvent->broadcastWith();
        expect($data['model'])->toBe('claude-3');
        expect($data['provider'])->toBe('anthropic');

        return true;
    });

    // Verify ToolCallBroadcast structure and data
    Event::assertDispatched(ToolCallBroadcast::class, function ($broadcastEvent) use ($channels): bool {
        expect($broadcastEvent->broadcastAs())->toBe('tool_call');
        expect($broadcastEvent->broadcastOn())->toBe($channels);

        $data = $broadcastEvent->broadcastWith();
        expect($data['tool_id'])->toBe('tool-123');
        expect($data['tool_name'])->toBe('search');
        expect($data['arguments'])->toBe(['q' => 'test']);
        expect($data['message_id'])->toBe('msg-456');

        return true;
    });

    // Verify StreamEndBroadcast structure and data
    Event::assertDispatched(StreamEndBroadcast::class, function ($broadcastEvent) use ($channels): bool {
        expect($broadcastEvent->broadcastAs())->toBe('stream_end');
        expect($broadcastEvent->broadcastOn())->toBe($channels);

        $data = $broadcastEvent->broadcastWith();
        expect($data['finish_reason'])->toBe('Stop');
        expect($data['usage'])->toMatchArray([
            'prompt_tokens' => 10,
            'completion_tokens' => 5,
            'cache_write_input_tokens' => null,
            'cache_read_input_tokens' => null,
            'thought_tokens' => null,
        ]);

        return true;
    });
});



================================================
FILE: tests/Streaming/Adapters/DataProtocolAdapterTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Streaming\Adapters\DataProtocolAdapter;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextCompleteEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;
use Symfony\Component\HttpFoundation\StreamedResponse;

/**
 * @param  array<\Prism\Prism\Streaming\Events\StreamEvent>  $events
 */
function createDataEventGenerator(array $events): Generator
{
    foreach ($events as $event) {
        yield $event;
    }
}

it('creates data protocol response with correct headers and structure', function (): void {
    $events = [
        new TextDeltaEvent('evt-123', 1640995200, 'Hello', 'msg-456'),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->headers->get('Content-Type'))->toBe('text/plain; charset=utf-8');
    expect($response->headers->get('Cache-Control'))->toContain('no-cache, no-transform');
    expect($response->headers->get('X-Accel-Buffering'))->toBe('no');
    expect($response->headers->get('x-vercel-ai-ui-message-stream'))->toBe('v1');

    // Verify the response has a callback function (streaming capability)
    expect($response->getCallback())->toBeCallable();
});

it('accepts event generator and maintains event types', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-456'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $adapter = new DataProtocolAdapter;

    // Test that adapter accepts the generator without error
    expect($adapter)->toBeInstanceOf(DataProtocolAdapter::class);

    // Test that we can create a response
    $response = ($adapter)(createDataEventGenerator($events));
    expect($response)->toBeInstanceOf(StreamedResponse::class);
});

it('handles different event types without errors', function (): void {
    // Test with various event combinations that should not cause errors
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new TextStartEvent('evt-2', 1640995201, 'msg-456'),
        new ThinkingStartEvent('evt-3', 1640995202, 'reasoning-123'),
        new ThinkingEvent('evt-4', 1640995203, 'Thinking...', 'reasoning-123'),
        new ToolCallEvent('evt-5', 1640995204, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-6', 1640995205, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
        new ErrorEvent('evt-7', 1640995206, 'test_error', 'Test error', true),
        new StreamEndEvent('evt-8', 1640995207, FinishReason::Stop),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('handles empty event stream without errors', function (): void {
    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator([]));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->getCallback())->toBeCallable();
});

it('processes events with complex data structures', function (): void {
    $complexArgs = [
        'query' => 'search term',
        'options' => [
            'limit' => 10,
            'sort' => 'relevance',
            'filters' => ['category' => 'tech', 'date' => '2024'],
        ],
        'metadata' => null,
    ];

    $events = [
        new ToolCallEvent('evt-1', 1640995200, new ToolCall('tool-123', 'complex_search', $complexArgs), 'msg-456'),
        new ToolResultEvent('evt-2', 1640995201, new ToolResult('tool-123', 'complex_search', $complexArgs, ['data' => ['nested' => ['value' => 123]]]), 'msg-456', true),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('handles events with unicode and special characters', function (): void {
    $events = [
        new TextDeltaEvent('evt-1', 1640995200, '🚀 Hello 世界! "quoted" text', 'msg-456'),
        new ThinkingEvent('evt-2', 1640995201, 'Thinking with émojis 🤔', 'reasoning-123'),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));

    // Should handle unicode without throwing errors
    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('maintains correct data protocol format structure', function (): void {
    $event = new TextDeltaEvent('evt-123', 1640995200, 'Hello world!', 'msg-456');
    $adapter = new DataProtocolAdapter;

    $response = ($adapter)(createDataEventGenerator([$event]));
    $callback = $response->getCallback();

    // Test that the callback is properly structured
    expect($callback)->toBeCallable();

    // Test callback execution without polluting output
    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return ''; // Return empty string to prevent output
    });

    try {
        $callback();
        ob_end_flush();

        // Verify some output was generated (callback actually ran)
        rewind($outputBuffer);
        $capturedOutput = stream_get_contents($outputBuffer);

        expect(strlen($capturedOutput))->toBeGreaterThan(0);

        // Verify correct Data Protocol format
        expect($capturedOutput)->toContain('data: {"type":"text-delta"');
        expect($capturedOutput)->toContain('"delta":"Hello world!"');
        expect($capturedOutput)->toContain('"id":"msg-456"');
        expect($capturedOutput)->toContain('data: [DONE]');
        expect($capturedOutput)->toEndWith("data: [DONE]\n\n");
    } finally {
        fclose($outputBuffer);
    }
});

it('integrates with Laravel response system', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new StreamEndEvent('evt-2', 1640995201, FinishReason::Stop),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));

    // Test integration with Laravel's response system
    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->headers)->toBeInstanceOf(\Symfony\Component\HttpFoundation\ResponseHeaderBag::class);
    expect($response->getStatusCode())->toBe(200);

    // Verify critical data protocol headers are set
    expect($response->headers->has('Content-Type'))->toBeTrue();
    expect($response->headers->has('Cache-Control'))->toBeTrue();
    expect($response->headers->has('x-vercel-ai-ui-message-stream'))->toBeTrue();
});

it('handles JSON encoding errors gracefully', function (): void {
    // Create an event with data that might cause JSON encoding issues
    $event = new ToolCallEvent(
        'evt-1',
        1640995200,
        new ToolCall('tool-123', 'test', ['binary' => "\x80\x81\x82"]), // Invalid UTF-8 sequence
        'msg-456'
    );

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator([$event]));
    $callback = $response->getCallback();

    // Should throw RuntimeException due to JSON encoding failure
    expect(function () use ($callback): void {
        // Capture output to prevent pollution
        ob_start(fn ($buffer): string => '');
        try {
            $callback();
        } finally {
            ob_end_flush();
        }
    })->toThrow(RuntimeException::class, 'Failed to encode event data as JSON');
});

it('formats multiple events with correct data protocol structure', function (): void {
    $usage = new Usage(promptTokens: 10, completionTokens: 5);

    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-456'),
        new TextDeltaEvent('evt-3', 1640995202, ' world!', 'msg-456'),
        new StreamEndEvent('evt-4', 1640995203, FinishReason::Stop, $usage),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));
    $callback = $response->getCallback();

    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return '';
    });

    try {
        $callback();
        ob_end_flush();

        rewind($outputBuffer);
        $capturedOutput = stream_get_contents($outputBuffer);

        // Verify each event is properly formatted as Data Protocol
        expect($capturedOutput)->toContain('data: {"type":"start"');
        expect($capturedOutput)->toContain('data: {"type":"text-delta"');
        expect($capturedOutput)->toContain('data: {"type":"finish"');
        expect($capturedOutput)->toContain('data: [DONE]');

        // Verify JSON structure in data fields
        expect($capturedOutput)->toContain('"messageId":"evt-1"'); // StreamStart uses messageId
        expect($capturedOutput)->toContain('"delta":"Hello"');
        expect($capturedOutput)->toContain('"delta":" world!"');
        expect($capturedOutput)->toContain('"messageMetadata":{"finishReason":"stop","usage":{"promptTokens":10,"completionTokens":5}}');

        // Verify proper Data Protocol format (each line starts with "data: " and ends with newline)
        $lines = explode("\n", trim($capturedOutput));
        $dataLines = array_filter($lines, fn (string $line): bool => str_starts_with($line, 'data: '));
        expect(count($dataLines))->toBeGreaterThanOrEqual(5); // 4 events + [DONE]

        foreach ($dataLines as $line) {
            if ($line === 'data: [DONE]') {
                expect($line)->toBe('data: [DONE]');
            } else {
                expect($line)->toMatch('/^data: \{.*\}$/');
                // Verify it's valid JSON after "data: " prefix
                $jsonPart = substr($line, 6); // Remove "data: " prefix
                expect(json_decode($jsonPart))->not->toBeNull();
            }
        }

        // Verify stream ends with [DONE]
        expect($capturedOutput)->toEndWith("data: [DONE]\n\n");
    } finally {
        fclose($outputBuffer);
    }
});

it('converts events to correct data protocol format', function (): void {
    $usage = new Usage(promptTokens: 10, completionTokens: 5);

    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new TextStartEvent('evt-2', 1640995201, 'msg-456'),
        new TextDeltaEvent('evt-3', 1640995202, 'Hello', 'msg-456'),
        new ThinkingStartEvent('evt-4', 1640995203, 'reasoning-123'),
        new ThinkingEvent('evt-5', 1640995204, 'Thinking...', 'reasoning-123'),
        new ThinkingCompleteEvent('evt-6', 1640995205, 'reasoning-123'),
        new ToolCallEvent('evt-7', 1640995206, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-8', 1640995207, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
        new TextCompleteEvent('evt-9', 1640995208, 'msg-456'),
        new StreamEndEvent('evt-10', 1640995209, FinishReason::Stop, $usage),
    ];

    $adapter = new DataProtocolAdapter;
    $response = ($adapter)(createDataEventGenerator($events));
    $callback = $response->getCallback();

    // Test that conversion doesn't throw errors and produces expected format
    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return '';
    });

    try {
        $callback();
        ob_end_flush();

        rewind($outputBuffer);
        $capturedOutput = stream_get_contents($outputBuffer);

        // Verify data protocol specific format elements
        expect($capturedOutput)->toContain('data: {"type":"start"');
        expect($capturedOutput)->toContain('data: {"type":"text-start"');
        expect($capturedOutput)->toContain('data: {"type":"text-delta"');
        expect($capturedOutput)->toContain('data: {"type":"reasoning-start"');
        expect($capturedOutput)->toContain('data: {"type":"reasoning-delta"');
        expect($capturedOutput)->toContain('data: {"type":"reasoning-end"');
        expect($capturedOutput)->toContain('data: {"type":"tool-input-available"');
        expect($capturedOutput)->toContain('data: {"type":"tool-output-available"');
        expect($capturedOutput)->toContain('data: {"type":"text-end"');
        expect($capturedOutput)->toContain('data: {"type":"finish"');
        expect($capturedOutput)->toContain('data: [DONE]');
    } finally {
        fclose($outputBuffer);
    }
});



================================================
FILE: tests/Streaming/Adapters/SSEAdapterTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Streaming\Adapters\SSEAdapter;
use Prism\Prism\Streaming\Events\ErrorEvent;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\StreamStartEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\TextStartEvent;
use Prism\Prism\Streaming\Events\ThinkingEvent;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Symfony\Component\HttpFoundation\StreamedResponse;

/**
 * @param  array<\Prism\Prism\Streaming\Events\StreamEvent>  $events
 */
function createEventGenerator(array $events): Generator
{
    foreach ($events as $event) {
        yield $event;
    }
}

it('creates SSE response with correct headers and structure', function (): void {
    $events = [
        new TextDeltaEvent('evt-123', 1640995200, 'Hello', 'msg-456'),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->headers->get('Content-Type'))->toBe('text/event-stream');
    expect($response->headers->get('Cache-Control'))->toContain('no-cache');
    expect($response->headers->get('X-Accel-Buffering'))->toBe('no');
    expect($response->headers->get('Connection'))->toBe('keep-alive');

    // Verify the response has a callback function (streaming capability)
    expect($response->getCallback())->toBeCallable();
});

it('accepts event generator and maintains event types', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-456'),
        new StreamEndEvent('evt-3', 1640995202, FinishReason::Stop),
    ];

    $adapter = new SSEAdapter;

    // Test that adapter accepts the generator without error
    expect($adapter)->toBeInstanceOf(SSEAdapter::class);

    // Test that we can create a response
    $response = ($adapter)(createEventGenerator($events));
    expect($response)->toBeInstanceOf(StreamedResponse::class);
});

it('handles different event types without errors', function (): void {
    // Test with various event combinations that should not cause errors
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'claude-3', 'anthropic'),
        new TextStartEvent('evt-2', 1640995201, 'msg-456'),
        new ThinkingStartEvent('evt-3', 1640995202, 'reasoning-123'),
        new ThinkingEvent('evt-4', 1640995203, 'Thinking...', 'reasoning-123'),
        new ToolCallEvent('evt-5', 1640995204, new ToolCall('tool-123', 'search', ['q' => 'test']), 'msg-456'),
        new ToolResultEvent('evt-6', 1640995205, new ToolResult('tool-123', 'search', ['q' => 'test'], ['result' => 'found']), 'msg-456', true),
        new ErrorEvent('evt-7', 1640995206, 'test_error', 'Test error', true),
        new StreamEndEvent('evt-8', 1640995207, FinishReason::Stop),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('handles empty event stream without errors', function (): void {
    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator([]));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
    expect($response->getCallback())->toBeCallable();
});

it('processes events with complex data structures', function (): void {
    $complexArgs = [
        'query' => 'search term',
        'options' => [
            'limit' => 10,
            'sort' => 'relevance',
            'filters' => ['category' => 'tech', 'date' => '2024'],
        ],
        'metadata' => null,
    ];

    $events = [
        new ToolCallEvent('evt-1', 1640995200, new ToolCall('tool-123', 'complex_search', $complexArgs), 'msg-456'),
        new ToolResultEvent('evt-2', 1640995201, new ToolResult('tool-123', 'complex_search', $complexArgs, ['data' => ['nested' => ['value' => 123]]]), 'msg-456', true),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));

    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('handles events with unicode and special characters', function (): void {
    $events = [
        new TextDeltaEvent('evt-1', 1640995200, '🚀 Hello 世界! "quoted" text', 'msg-456'),
        new ThinkingEvent('evt-2', 1640995201, 'Thinking with émojis 🤔', 'reasoning-123'),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));

    // Should handle unicode without throwing errors
    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);
});

it('maintains correct SSE format structure', function (): void {
    $event = new TextDeltaEvent('evt-123', 1640995200, 'Hello world!', 'msg-456');
    $adapter = new SSEAdapter;

    $response = ($adapter)(createEventGenerator([$event]));
    $callback = $response->getCallback();

    // Test that the callback is properly structured for SSE
    expect($callback)->toBeCallable();

    // Test callback execution without polluting output
    // We'll capture and discard the output to prevent it from showing in tests
    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return ''; // Return empty string to prevent output
    });

    try {
        $callback();
        ob_end_flush();

        // Verify some output was generated (callback actually ran)
        rewind($outputBuffer);
        $capturedOutput = stream_get_contents($outputBuffer);

        expect(strlen($capturedOutput))->toBeGreaterThan(0);

        // Verify correct SSE format
        expect($capturedOutput)->toContain('event: text_delta');
        expect($capturedOutput)->toContain('data: ');
        expect($capturedOutput)->toContain('"delta":"Hello world!"');
        expect($capturedOutput)->toContain('"message_id":"msg-456"');
        expect($capturedOutput)->toEndWith("\n\n");
    } finally {
        fclose($outputBuffer);
    }
});

it('formats multiple events with correct SSE structure', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new TextDeltaEvent('evt-2', 1640995201, 'Hello', 'msg-456'),
        new TextDeltaEvent('evt-3', 1640995202, ' world!', 'msg-456'),
        new StreamEndEvent('evt-4', 1640995203, FinishReason::Stop),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));
    $callback = $response->getCallback();

    $outputBuffer = fopen('php://memory', 'r+');
    ob_start(function ($buffer) use ($outputBuffer): string {
        fwrite($outputBuffer, $buffer);

        return '';
    });

    try {
        $callback();
        ob_end_flush();

        rewind($outputBuffer);
        $capturedOutput = stream_get_contents($outputBuffer);

        // Verify each event is properly formatted
        expect($capturedOutput)->toContain("event: stream_start\ndata: ");
        expect($capturedOutput)->toContain("event: text_delta\ndata: ");
        expect($capturedOutput)->toContain("event: stream_end\ndata: ");

        // Verify JSON structure in data fields
        expect($capturedOutput)->toContain('"model":"gpt-4"');
        expect($capturedOutput)->toContain('"provider":"openai"');
        expect($capturedOutput)->toContain('"delta":"Hello"');
        expect($capturedOutput)->toContain('"delta":" world!"');
        expect($capturedOutput)->toContain('"finish_reason":"Stop"');

        // Verify proper SSE format (each event ends with double newline)
        $eventBlocks = explode("\n\n", trim($capturedOutput));
        expect(count($eventBlocks))->toBe(4); // 4 events

        foreach ($eventBlocks as $block) {
            expect($block)->toMatch('/^event: [\w-]+\ndata: \{.*\}$/');
        }
    } finally {
        fclose($outputBuffer);
    }
});

it('integrates with Laravel response system', function (): void {
    $events = [
        new StreamStartEvent('evt-1', 1640995200, 'gpt-4', 'openai'),
        new StreamEndEvent('evt-2', 1640995201, FinishReason::Stop),
    ];

    $adapter = new SSEAdapter;
    $response = ($adapter)(createEventGenerator($events));

    // Test integration with Laravel's response system
    expect($response)->toBeInstanceOf(StreamedResponse::class);
    expect($response->getStatusCode())->toBe(200);

    // Verify critical SSE headers are set
    expect($response->headers->has('Content-Type'))->toBeTrue();
    expect($response->headers->has('Cache-Control'))->toBeTrue();
    expect($response->headers->has('Connection'))->toBeTrue();
});



================================================
FILE: tests/Structured/PendingRequestTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\StructuredMode;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Structured\PendingRequest;
use Prism\Prism\Structured\Request;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;

beforeEach(function (): void {
    $this->pendingRequest = new PendingRequest;
});

test('it requires a schema', function (): void {
    $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Test prompt');

    expect($this->pendingRequest->toRequest(...))
        ->toThrow(PrismException::class, 'A schema is required for structured output');
});

test('it cannot have both prompt and messages', function (): void {
    $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withPrompt('Test prompt')
        ->withMessages([new UserMessage('Test message')]);

    expect($this->pendingRequest->toRequest(...))
        ->toThrow(PrismException::class, 'You can only use `prompt` or `messages`');
});

test('it converts prompt to message', function (): void {
    $prompt = 'Test prompt';

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withPrompt($prompt)
        ->toRequest();

    expect($request->messages())
        ->toHaveCount(1)
        ->and($request->messages()[0])->toBeInstanceOf(UserMessage::class)
        ->and($request->messages()[0]->text())->toBe($prompt);
});

test('it generates a proper request object', function (): void {
    $schema = new StringSchema('test', 'test description');
    $model = 'gpt-4';
    $prompt = 'Test prompt';
    $systemPrompts = [new SystemMessage('Test system prompt')];
    $temperature = 0.7;
    $maxTokens = 100;
    $topP = 0.9;
    $clientOptions = ['timeout' => 30];
    $clientRetry = [3, 100, null, true];
    $providerOptions = ['test' => 'meta'];

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, $model)
        ->withSchema($schema)
        ->withPrompt($prompt)
        ->withSystemPrompt($systemPrompts[0])
        ->usingTemperature($temperature)
        ->withMaxTokens($maxTokens)
        ->usingTopP($topP)
        ->withClientOptions($clientOptions)
        ->withClientRetry(...$clientRetry)
        ->withProviderOptions($providerOptions)
        ->toRequest();

    expect($request)
        ->toBeInstanceOf(Request::class)
        ->model()->toBe($model)
        ->systemPrompts()->toBe($systemPrompts)
        ->prompt()->toBe($prompt)
        ->schema()->toBe($schema)
        ->temperature()->toBe($temperature)
        ->maxTokens()->toBe($maxTokens)
        ->topP()->toBe($topP)
        ->clientOptions()->toBe($clientOptions)
        ->clientRetry()->toBe($clientRetry)
        ->mode()->toBe(StructuredMode::Auto)
        ->and($request->providerOptions())->toBe($providerOptions);
});

test('you can run toRequest multiple times', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withPrompt('Hello AI');

    $request->toRequest();
    $request->toRequest();
})->throwsNoExceptions();

test('it sets provider options', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions())
        ->toBe(['key' => 'value']);
});

test('it sets provider options with string name', function (): void {
    $request = $this->pendingRequest
        ->using('openai', 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions())
        ->toBe(['key' => 'value']);
});

test('it gets specific provider option value', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions('key'))->toBe('value');
});

test('it gets nested provider option value', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withProviderOptions(['deep' => ['nested' => 'value']]);

    $generated = $request->toRequest();

    expect($generated->providerOptions('deep.nested'))->toBe('value');
});

test('it can set prompt with additional content in structured request', function (): void {
    $image = Image::fromUrl('https://example.com/image.jpg');

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withPrompt('Analyze this image', [$image]);

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Analyze this image')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class)
        ->and($generated->messages()[0]->additionalContent)->toHaveCount(2) // Text + Image
        ->and($generated->messages()[0]->images())->toHaveCount(1)
        ->and($generated->messages()[0]->images()[0])->toBe($image);
});

test('structured withPrompt maintains backward compatibility without additional content', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSchema(new StringSchema('test', 'test description'))
        ->withPrompt('Hello AI');

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Hello AI')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class)
        ->and($generated->messages()[0]->additionalContent)->toHaveCount(1); // Only Text
});



================================================
FILE: tests/Structured/ResponseBuilderTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismStructuredDecodingException;
use Prism\Prism\Structured\ResponseBuilder;
use Prism\Prism\Structured\Step;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

test('throws a PrismStructuredDecodingException if the response is not valid json', function (): void {
    $builder = new ResponseBuilder;

    $builder->addStep(new Step(
        text: 'This is not valid json',
        finishReason: FinishReason::Stop,
        usage: new Usage(
            promptTokens: 0,
            completionTokens: 0
        ),
        meta: new Meta(
            id: '123',
            model: 'Test',
        ),
        messages: [],
        systemPrompts: [],
    ));

    $builder->toResponse();
})->throws(PrismStructuredDecodingException::class);

test('StructuredResponseBuilder aggregates usage and decodes structured output', function (): void {
    $builder = new ResponseBuilder;

    // First (intermediate) step
    $builder->addStep(new Step(
        text: 'intermediate output',
        finishReason: FinishReason::Length,
        usage: new Usage(promptTokens: 10, completionTokens: 5),
        meta: new Meta('step1', 'test-model'),
        messages: [],
        systemPrompts: [],
    ));

    // Final step that should be decoded
    $builder->addStep(new Step(
        text: '{"value":42}',
        finishReason: FinishReason::Stop,
        usage: new Usage(promptTokens: 3, completionTokens: 2),
        meta: new Meta('step2', 'test-model'),
        messages: [],
        systemPrompts: [],
    ));

    $response = $builder->toResponse();

    expect($response->usage->promptTokens)->toBe(13)
        ->and($response->usage->completionTokens)->toBe(7)
        ->and($response->structured)->toBe(['value' => 42])
        ->and($response->text)->toBe('{"value":42}')
        ->and($response->finishReason)->toBe(FinishReason::Stop)
        ->and($response->steps)->toHaveCount(2);
});

test('StructuredResponseBuilder decode the json given as a markdown fenced code block', function (): void {
    $builder = new ResponseBuilder;

    $builder->addStep(new Step(
        text: '```json
		{
		"value": 42
		}
		```',
        finishReason: FinishReason::Stop,
        usage: new Usage(
            promptTokens: 0,
            completionTokens: 0
        ),
        meta: new Meta(
            id: '123',
            model: 'Test',
        ),
        messages: [],
        systemPrompts: [],
    ));

    $response = $builder->toResponse();

    expect($response->structured)->toBe(['value' => 42]);
});



================================================
FILE: tests/TestDoubles/TestProvider.php
================================================
<?php

declare(strict_types=1);

namespace Tests\TestDoubles;

use Generator;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Images\Request as ImageRequest;
use Prism\Prism\Images\Response as ImageResponse;
use Prism\Prism\Providers\Provider;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\GeneratedImage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ProviderResponse;
use Prism\Prism\ValueObjects\Usage;

class TestProvider extends Provider
{
    public StructuredRequest|TextRequest|EmbeddingRequest|ImageRequest $request;

    /** @var array<string, mixed> */
    public array $clientOptions;

    /** @var array<mixed> */
    public array $clientRetry;

    /** @var array<int, StructuredResponse|TextResponse|EmbeddingResponse|ImageResponse> */
    public array $responses = [];

    public $callCount = 0;

    #[\Override]
    public function text(TextRequest $request): TextResponse
    {
        $this->callCount++;

        $this->request = $request;

        return $this->responses[$this->callCount - 1] ?? new TextResponse(
            steps: collect([]),
            text: "I'm nyx!",
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(10, 10),
            meta: new Meta('123', 'claude-3-5-sonnet-20240620'),
            messages: collect([]),
        );
    }

    #[\Override]
    public function structured(StructuredRequest $request): StructuredResponse
    {
        $this->callCount++;

        $this->request = $request;

        return $this->responses[$this->callCount - 1] ?? new StructuredResponse(
            steps: collect([]),
            text: json_encode([]),
            structured: [],
            finishReason: FinishReason::Stop,
            usage: new Usage(10, 10),
            meta: new Meta('123', 'claude-3-5-sonnet-20240620')
        );
    }

    #[\Override]
    public function embeddings(EmbeddingRequest $request): EmbeddingResponse
    {
        $this->callCount++;

        $this->request = $request;

        return $this->responses[$this->callCount - 1] ?? new EmbeddingResponse(
            embeddings: [],
            usage: new EmbeddingsUsage(10),
            meta: new Meta(
                id: '123',
                model: 'your-model',
            )
        );
    }

    #[\Override]
    public function images(ImageRequest $request): ImageResponse
    {
        $this->callCount++;

        $this->request = $request;

        return $this->responses[$this->callCount - 1] ?? new ImageResponse(
            images: [
                new GeneratedImage(
                    url: 'https://example.com/test-image.png',
                    revisedPrompt: null,
                ),
            ],
            usage: new Usage(10, 10),
            meta: new Meta('123', 'dall-e-3'),
        );
    }

    #[\Override]
    public function stream(TextRequest $request): Generator
    {
        throw PrismException::unsupportedProviderAction(__METHOD__, class_basename($this));
    }

    public function withResponse(StructuredResponse|TextResponse $response): Provider
    {
        $this->responses[] = $response;

        return $this;
    }

    /**
     * @param  array<int, ProviderResponse>  $responses
     */
    public function withResponseChain(array $responses): Provider
    {

        $this->responses = $responses;

        return $this;
    }
}



================================================
FILE: tests/Testing/AssertRequestTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\ValueObjects\Usage;

it('can generate text and assert provider', function (): void {
    $fakeResponse = TextResponseFake::make()
        ->withText('Hello, I am Claude!')
        ->withUsage(new Usage(10, 20));

    // Set up the fake
    $fake = Prism::fake([$fakeResponse]);

    // Run your code
    $response = Prism::text()
        ->using(Provider::Anthropic, 'claude-3-5-sonnet-latest')
        ->withPrompt('Who are you?')
        ->asText();

    // Make assertions
    expect($response->text)->toBe('Hello, I am Claude!');

    $fake->assertRequest(function (array $requests): void {
        expect($requests[0]->provider())->toBe('anthropic');
        expect($requests[0]->model())->toBe('claude-3-5-sonnet-latest');
    });
});

it('can generate text and assert provider with different providers', function (): void {
    $fakeResponse = TextResponseFake::make()
        ->withText('Hello from OpenAI!')
        ->withUsage(new Usage(15, 25));

    // Set up the fake
    $fake = Prism::fake([$fakeResponse]);

    // Run your code
    $response = Prism::text()
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Hello')
        ->asText();

    // Make assertions
    expect($response->text)->toBe('Hello from OpenAI!');

    $fake->assertRequest(function (array $requests): void {
        expect($requests[0]->provider())->toBe('openai');
        expect($requests[0]->model())->toBe('gpt-4');
    });
});



================================================
FILE: tests/Testing/FakeResponsesTest.php
================================================
<?php

use Illuminate\Support\Collection;
use Prism\Prism\Embeddings\Response as EmbeddingsResponse;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Testing\EmbeddingsResponseFake;
use Prism\Prism\Testing\StructuredResponseFake;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

test('fake text response can be built', function (): void {
    $response = TextResponseFake::make()
        ->withText('The meaning of life is 42')
        ->withSteps(collect([]))
        ->withMessages(collect([]))
        ->withToolCalls([])
        ->withToolResults([])
        ->withUsage(new Usage(42, 42))
        ->withFinishReason(FinishReason::Stop)
        ->withMeta(new Meta('cpl_1234', 'claude-3-sonnet'));

    expect($response)->toBeInstanceOf(TextResponse::class)
        ->and($response->text)->toBe('The meaning of life is 42')
        ->and($response->steps)->toBeInstanceOf(Collection::class)
        ->and($response->messages)->toBeInstanceOf(Collection::class)
        ->and($response->toolCalls)->toBeArray()
        ->and($response->toolResults)->toBeArray()
        ->and($response->usage)->toBeInstanceOf(Usage::class)
        ->and($response->usage->completionTokens)->toBe(42)
        ->and($response->finishReason)->toBeInstanceOf(FinishReason::class)
        ->and($response->finishReason)->toBe(FinishReason::Stop)
        ->and($response->meta)->toBeInstanceOf(Meta::class)
        ->and($response->meta->model)->toBe('claude-3-sonnet')
        ->and($response->additionalContent)->toBeArray();
});

test('fake structured response can be built', function (): void {
    $response = StructuredResponseFake::make()
        ->withSteps(collect([]))
        ->withText(json_encode(['foo' => 'bar'], JSON_THROW_ON_ERROR))
        ->withStructured(['foo' => 'bar'])
        ->withFinishReason(FinishReason::Stop)
        ->withUsage(new Usage(42, 42))
        ->withMeta(new Meta('cpl_1234', 'claude-3-sonnet'))
        ->withAdditionalContent([]);

    expect($response)->toBeInstanceOf(StructuredResponse::class)
        ->and($response->text)->toBe(json_encode(['foo' => 'bar'], JSON_THROW_ON_ERROR))
        ->and($response->steps)->toBeInstanceOf(Collection::class)
        ->and($response->structured)->toBe(['foo' => 'bar'])
        ->and($response->finishReason)->toBeInstanceOf(FinishReason::class)
        ->and($response->finishReason)->toBe(FinishReason::Stop)
        ->and($response->usage)->toBeInstanceOf(Usage::class)
        ->and($response->usage->completionTokens)->toBe(42)
        ->and($response->meta)->toBeInstanceOf(Meta::class)
        ->and($response->meta->model)->toBe('claude-3-sonnet')
        ->and($response->additionalContent)->toBeArray();
});

test('fake embeddings response can be built', function (): void {
    $response = EmbeddingsResponseFake::make()
        ->withEmbeddings([Embedding::fromArray([0.1, 0.2, 0.3])])
        ->withUsage(new EmbeddingsUsage(10))
        ->withMeta(new Meta('cpl_1234', 'claude-3-sonnet'));

    expect($response)->toBeInstanceOf(EmbeddingsResponse::class)
        ->and($response->embeddings)->toBeArray()
        ->and($response->embeddings[0])->toBeInstanceOf(Embedding::class)
        ->and($response->embeddings[0]->embedding)->toBe([0.1, 0.2, 0.3])
        ->and($response->usage)->toBeInstanceOf(EmbeddingsUsage::class)
        ->and($response->usage->tokens)->toBe(10)
        ->and($response->meta)->toBeInstanceOf(Meta::class)
        ->and($response->meta->model)->toBe('claude-3-sonnet');
});



================================================
FILE: tests/Testing/FakeStepsTest.php
================================================
<?php

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Structured\Step as StructuredStep;
use Prism\Prism\Testing\StructuredStepFake;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\Text\Step as TextStep;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

test('fake text step can be built', function (): void {
    $step = TextStepFake::make()
        ->withText('Hello world')
        ->withFinishReason(FinishReason::Stop)
        ->withToolCalls([])
        ->withToolResults([])
        ->withUsage(new Usage(1, 1))
        ->withMeta(new Meta('cpl_123', 'test-model'))
        ->withMessages([])
        ->withSystemPrompts([])
        ->withAdditionalContent([]);

    expect($step)->toBeInstanceOf(TextStep::class)
        ->and($step->text)->toBe('Hello world')
        ->and($step->finishReason)->toBe(FinishReason::Stop)
        ->and($step->toolCalls)->toBeArray()
        ->and($step->toolResults)->toBeArray()
        ->and($step->usage)->toBeInstanceOf(Usage::class)
        ->and($step->meta)->toBeInstanceOf(Meta::class)
        ->and($step->messages)->toBeArray()
        ->and($step->systemPrompts)->toBeArray()
        ->and($step->additionalContent)->toBeArray();
});

test('fake structured step can be built', function (): void {
    $step = StructuredStepFake::make()
        ->withText('{"foo":"bar"}')
        ->withFinishReason(FinishReason::Stop)
        ->withUsage(new Usage(2, 2))
        ->withMeta(new Meta('cpl_456', 'test-model'))
        ->withMessages([])
        ->withSystemPrompts([])
        ->withAdditionalContent([]);

    expect($step)->toBeInstanceOf(StructuredStep::class)
        ->and($step->text)->toBe('{"foo":"bar"}')
        ->and($step->finishReason)->toBe(FinishReason::Stop)
        ->and($step->usage)->toBeInstanceOf(Usage::class)
        ->and($step->meta)->toBeInstanceOf(Meta::class)
        ->and($step->messages)->toBeArray()
        ->and($step->systemPrompts)->toBeArray()
        ->and($step->additionalContent)->toBeArray();
});



================================================
FILE: tests/Testing/PrismFakeTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Testing;

use Exception;
use Prism\Prism\Embeddings\Request as EmbeddingRequest;
use Prism\Prism\Embeddings\Response as EmbeddingResponse;
use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;
use Prism\Prism\Schema\ObjectSchema;
use Prism\Prism\Schema\StringSchema;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\Streaming\Events\TextDeltaEvent;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\Structured\Request as StructuredRequest;
use Prism\Prism\Structured\Response as StructuredResponse;
use Prism\Prism\Testing\EmbeddingsResponseFake;
use Prism\Prism\Testing\StructuredResponseFake;
use Prism\Prism\Testing\TextResponseFake;
use Prism\Prism\Testing\TextStepFake;
use Prism\Prism\Text\Request as TextRequest;
use Prism\Prism\Text\Response as TextResponse;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\ValueObjects\Embedding;
use Prism\Prism\ValueObjects\EmbeddingsUsage;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\ToolCall;
use Prism\Prism\ValueObjects\ToolResult;
use Prism\Prism\ValueObjects\Usage;

describe('fake text, structured, and embedding responses', function (): void {
    it('fake responses using the prism fake for text', function (): void {
        $fake = Prism::fake([
            new TextResponse(
                steps: collect([]),
                text: 'The meaning of life is 42',
                finishReason: FinishReason::Stop,
                toolCalls: [],
                toolResults: [],
                usage: new Usage(42, 42),
                meta: new Meta('cpl_1234', 'claude-3-sonnet'),
                messages: collect([])
            ),
        ]);

        Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asText();

        $fake->assertCallCount(1);
        $fake->assertPrompt('What is the meaning of life?');
        $fake->assertRequest(function (array $requests): void {
            expect($requests)->toHaveCount(1);
            expect($requests[0])->toBeInstanceOf(TextRequest::class);
        });
    });

    it('fake responses using the prism fake for structured', function (): void {
        $fake = Prism::fake([
            new StructuredResponse(
                steps: collect([]),
                text: json_encode(['foo' => 'bar']),
                structured: ['foo' => 'bar'],
                finishReason: FinishReason::Stop,
                usage: new Usage(42, 42),
                meta: new Meta('cpl_1234', 'claude-3-sonnet'),
                additionalContent: [],
            ),
        ]);

        Prism::structured()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->withSchema(new ObjectSchema(
                'foo',
                'foo schema',
                [
                    new StringSchema('foo', 'foo value'),
                ]
            ))
            ->asStructured();

        $fake->assertCallCount(1);
        $fake->assertPrompt('What is the meaning of life?');
        $fake->assertRequest(function (array $requests): void {
            expect($requests)->toHaveCount(1);
            expect($requests[0])->toBeInstanceOf(StructuredRequest::class);
        });
    });

    it('fake responses using the prism fake for embeddings', function (): void {
        $fake = Prism::fake([
            new EmbeddingResponse(
                embeddings: [
                    Embedding::fromArray([
                        -0.009639355,
                        -0.00047589254,
                        -0.022748338,
                        -0.005906468,
                    ]),
                ],
                usage: new EmbeddingsUsage(100),
                meta: new Meta(
                    id: 'fake-id',
                    model: 'fake-model'
                )
            ),
        ]);

        Prism::embeddings()
            ->using(Provider::OpenAI, 'text-embedding-ada-002')
            ->fromInput('What is the meaning of life?')
            ->asEmbeddings();

        $fake->assertCallCount(1);
        $fake->assertRequest(function (array $requests): void {
            expect($requests)->toHaveCount(1);
            expect($requests[0])->toBeInstanceOf(EmbeddingRequest::class);
        });
    });

    it('can consume the fake text responses', function (): void {
        Prism::fake([
            TextResponseFake::make()->withText('fake response text'),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asText();

        expect($text->text)->toBe('fake response text');
    });

    it('can consume the fake structured text response', function (): void {
        Prism::fake([
            StructuredResponseFake::make()->withText('{"foo": "bar"}'),
        ]);

        $structured = Prism::structured()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->withSchema(new ObjectSchema(
                'foo',
                'foo schema',
                [
                    new StringSchema('foo', 'foo value'),
                ]
            ))
            ->asStructured();

        expect($structured->text)->toBe('{"foo": "bar"}');
    });

    it('can consume the fake embeddings response', function (): void {
        Prism::fake([
            EmbeddingsResponseFake::make()->withEmbeddings([Embedding::fromArray([0.1, 0.2, 0.3])]),
        ]);

        $embeddings = Prism::embeddings()
            ->using(Provider::OpenAI, 'text-embedding-ada-002')
            ->fromInput('What is the meaning of life?')
            ->asEmbeddings();

        expect($embeddings->embeddings)->toBeArray()
            ->and($embeddings->embeddings[0])->toBeInstanceOf(Embedding::class)
            ->and($embeddings->embeddings[0]->embedding)->toBe([0.1, 0.2, 0.3]);
    });

});

describe('fake streaming responses', function (): void {

    it('can consume the fake text stream responses', function (): void {
        Prism::fake([
            TextResponseFake::make()
                ->withText('fake response text'),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $toolCalls = [];
        $toolResults = [];
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
            }

            if ($event instanceof ToolCallEvent) {
                $toolCalls[] = $event->toolCall;
            }

            if ($event instanceof ToolResultEvent) {
                $toolResults[] = $event->toolResult;
            }
        }

        expect($outputText)->toBe('fake response text')
            ->and($toolCalls)->toBeEmpty()
            ->and($toolResults)->toBeEmpty();
    });

    it('can consume the fake text response builder responses when streaming', function (): void {
        Prism::fake([
            (new ResponseBuilder)
                ->addStep(
                    TextStepFake::make()
                        ->withToolCalls(
                            [
                                new ToolCall('id-123', 'tool', ['input' => 'value']),
                            ]
                        )
                )
                ->addStep(
                    TextStepFake::make()
                        ->withToolResults(
                            [
                                new ToolResult('id-123', 'tool', ['input' => 'value'], 'result'),
                            ]
                        )
                )
                ->addStep(
                    TextStepFake::make()
                        ->withText('fake response text')
                )->toResponse(),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $toolCalls = [];
        $toolResults = [];
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
            }

            if ($event instanceof ToolCallEvent) {
                $toolCalls[] = $event->toolCall;
            }

            if ($event instanceof ToolResultEvent) {
                $toolResults[] = $event->toolResult;
            }
        }

        expect($outputText)->toBe('fake response text')
            ->and($toolCalls)->toHaveCount(1)
            ->and($toolCalls[0])->toBeInstanceOf(ToolCall::class)
            ->and($toolCalls[0]->id)->toBe('id-123')
            ->and($toolCalls[0]->name)->toBe('tool')
            ->and($toolCalls[0]->arguments())->toBe(['input' => 'value'])
            ->and($toolResults)->toHaveCount(1)
            ->and($toolResults[0])->toBeInstanceOf(ToolResult::class)
            ->and($toolResults[0]->toolCallId)->toBe('id-123')
            ->and($toolResults[0]->toolName)->toBe('tool')
            ->and($toolResults[0]->args)->toBe(['input' => 'value'])
            ->and($toolResults[0]->result)->toBe('result');
    });

    it('can consume empty text responses when streaming', function (): void {
        Prism::fake([
            TextResponseFake::make()->withText(''),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
            }
        }

        expect($outputText)->toBe('');
    });

    it('has a default chunk size of five', function (): void {
        Prism::fake([
            TextResponseFake::make()->withText('fake response text'),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $textDeltas = [];
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
                $textDeltas[] = $event;
            }
        }

        expect($outputText)->toBe('fake response text')
            // 19 characters -> 3 chunks of 5 + one with 4 characters = 4 TextDeltaEvents
            ->and($textDeltas)->toHaveCount(4);
    });

    it('handles different chunk sizes', function (): void {
        Prism::fake([
            TextResponseFake::make()->withText('fake response text'),
        ])->withFakeChunkSize(1);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $textDeltas = [];
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
                $textDeltas[] = $event;
            }
        }

        expect($outputText)->toBe('fake response text')
            ->and($textDeltas)->toHaveCount(18);
    });

    it('enforces a chunk size of at least 1', function (): void {
        Prism::fake([
            TextResponseFake::make()->withText('fake response text'),
        ])->withFakeChunkSize(0);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $textDeltas = [];
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
                $textDeltas[] = $event;
            }
        }

        expect($outputText)->toBe('fake response text')
            ->and($textDeltas)->toHaveCount(18);
    });

    it('adds a stream end event with the finish reason at the end', function (): void {
        Prism::fake([
            TextResponseFake::make()
                ->withText('fake response text')
                ->withFinishReason(FinishReason::Length),
        ]);

        $text = Prism::text()
            ->using('anthropic', 'claude-3-sonnet')
            ->withPrompt('What is the meaning of life?')
            ->asStream();

        $outputText = '';
        $lastEvent = null;
        foreach ($text as $event) {
            if ($event instanceof TextDeltaEvent) {
                $outputText .= $event->delta;
            }
            $lastEvent = $event;
        }

        expect($outputText)->toBe('fake response text')
            ->and($lastEvent)->toBeInstanceOf(StreamEndEvent::class)
            ->and($lastEvent->finishReason)->toBe(FinishReason::Length);
    });

});

it("throws an exception when it can't runs out of responses", function (): void {
    $this->expectException(Exception::class);
    $this->expectExceptionMessage('Could not find a response for the request');

    Prism::fake([
        new TextResponse(
            steps: collect([]),
            text: 'The meaning of life is 42',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(42, 42),
            meta: new Meta('cpl_1234', 'claude-3-sonnet'),
            messages: collect([])
        ),
    ]);

    Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('What is the meaning of life?')
        ->asText();

    Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('What is the meaning of life?')
        ->asText();
});

it('asserts provider config', function (): void {
    $fake = Prism::fake([
        new TextResponse(
            steps: collect([]),
            text: 'The meaning of life is 42',
            finishReason: FinishReason::Stop,
            toolCalls: [],
            toolResults: [],
            usage: new Usage(42, 42),
            meta: new Meta('cpl_1234', 'claude-3-sonnet'),
            messages: collect([])
        ),
    ]);

    Prism::text()
        ->using('anthropic', 'claude-3-sonnet')
        ->withPrompt('What is the meaning of life?')
        ->usingProviderConfig(['api_key' => '1234'])
        ->asText();

    $fake->assertProviderConfig(['api_key' => '1234']);
});



================================================
FILE: tests/Text/PendingRequestTest.php
================================================
<?php

declare(strict_types=1);

use Illuminate\Contracts\View\View;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Enums\ToolChoice;
use Prism\Prism\Exceptions\PrismException;
use Prism\Prism\Facades\Tool;
use Prism\Prism\Providers\Provider as ProviderContract;
use Prism\Prism\Text\PendingRequest;
use Prism\Prism\ValueObjects\Media\Image;
use Prism\Prism\ValueObjects\Messages\AssistantMessage;
use Prism\Prism\ValueObjects\Messages\SystemMessage;
use Prism\Prism\ValueObjects\Messages\UserMessage;
use Tests\TestDoubles\TestProvider;

beforeEach(function (): void {
    $this->pendingRequest = new PendingRequest;
    $this->provider = new TestProvider;
});

test('it can configure the provider and model', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4');

    $generated = $request->toRequest();

    expect($generated->model())->toBe('gpt-4');
});

test('it can configure the provider and model with custom config via using', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4', ['url' => 'value']);

    expect($request->provider()->url)->toBe('value');
});

test('it can configure the provider and model with custom config via withProviderConfig', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->usingProviderConfig(['url' => 'value']);

    expect($request->provider()->url)->toBe('value');
});

test('it sets provider options', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions())
        ->toBe(['key' => 'value']);
});

test('it sets provider options on request object', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions())
        ->toBe(['key' => 'value']);
});

test('it gets provider options on a pending request', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['key' => 'value']);

    expect($request->providerOptions())->toBe(['key' => 'value']);
});

test('it gets specific provider option with path', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['key' => 'value']);

    expect($request->providerOptions('key'))->toBe('value');
});

test('it gets specific provider option from request object', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['key' => 'value']);

    $generated = $request->toRequest();

    expect($generated->providerOptions('key'))->toBe('value');
});

test('it gets nested provider option from request object', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withProviderOptions(['nested' => ['key' => 'value']]);

    $generated = $request->toRequest();

    expect($generated->providerOptions('nested.key'))->toBe('value');
});

test('it allows you to get the model and provider', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4');

    expect($request->model())->toBe('gpt-4');
    expect($request->providerKey())->toBe('openai');
});

test('it configures the client options', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withClientOptions(['timeout' => 30]);

    $generated = $request->toRequest();

    expect($generated->clientOptions())
        ->toBe(['timeout' => 30]);
});

test('it configures client retry', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withClientRetry(3, 100);

    $generated = $request->toRequest();

    expect($generated->clientRetry())
        ->toBe([3, 100, null, true]);
});

test('it sets max tokens', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withMaxTokens(100);

    $generated = $request->toRequest();

    expect($generated->maxTokens())->toBe(100);
});

test('it sets temperature', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->usingTemperature(0.7);

    $generated = $request->toRequest();

    expect($generated->temperature())->toBe(0.7);
});

test('it sets top p', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->usingTopP(0.9);

    $generated = $request->toRequest();

    expect($generated->topP())->toBe(0.9);
});

test('it sets max steps', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withMaxSteps(5);

    $generated = $request->toRequest();

    expect($generated->maxSteps())->toBe(5);
});

test('it can add a tool', function (): void {
    $tool = Tool::as('test')
        ->for('test tool')
        ->using(fn (): string => 'test result');

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withTools([$tool]);

    $generated = $request->toRequest();

    expect($generated->tools())
        ->toHaveCount(1)
        ->and($generated->tools()[0]->name())
        ->toBe('test');
});

test('it sets tool choice', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withToolChoice(ToolChoice::Auto);

    $generated = $request->toRequest();

    expect($generated->toolChoice())
        ->toBe(ToolChoice::Auto);
});

test('it can set string prompt', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Hello AI');

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Hello AI')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class);
});

test('it can set view prompt', function (): void {
    $view = Mockery::mock(View::class);
    $view->shouldReceive('render')->andReturn('Hello AI');

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt($view);

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Hello AI')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class);
});

test('it can set string system prompt', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSystemPrompt('System instruction');

    $generated = $request->toRequest();

    expect($generated->systemPrompts()[0]->content)
        ->toBe('System instruction');
});

test('it can set view system prompt', function (): void {
    $view = Mockery::mock(View::class);
    $view->shouldReceive('render')->andReturn('System instruction');

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSystemPrompt($view);

    $generated = $request->toRequest();

    expect($generated->systemPrompts()[0]->content)
        ->toBe('System instruction');
});

test('it can set messages', function (): void {
    $messages = [
        new SystemMessage('system'),
        new UserMessage('user'),
        new AssistantMessage('assistant'),
    ];

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withMessages($messages);

    $generated = $request->toRequest();

    expect($generated->messages())
        ->toHaveCount(3)
        ->sequence(
            fn ($message) => $message->toBeInstanceOf(SystemMessage::class),
            fn ($message) => $message->toBeInstanceOf(UserMessage::class),
            fn ($message) => $message->toBeInstanceOf(AssistantMessage::class),
        );
});

test('it can set system prompts', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withSystemPrompts([
            new SystemMessage('Prompt 1'),
            new SystemMessage('Prompt 2'),
        ]);

    $generated = $request->toRequest();

    expect($generated->systemPrompts())
        ->toHaveCount(2)
        ->sequence(
            fn ($message): bool => $message->content === 'Prompt 1',
            fn ($message): bool => $message->content === 'Prompt 2',
        );
});

test('it throws exception when using both prompt and messages', function (): void {
    $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('test')
        ->withMessages([new UserMessage('test')])
        ->toRequest();
})->throws(PrismException::class, 'You can only use `prompt` or `messages`');

test('it throws exception when using both messages and prompt', function (): void {
    $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withMessages([new UserMessage('test')])
        ->withPrompt('test')
        ->toRequest();
})->throws(PrismException::class, 'You can only use `prompt` or `messages`');

test('it generates response', function (): void {
    resolve('prism-manager')->extend('test-provider', fn ($config): ProviderContract => new TestProvider);

    $response = $this->pendingRequest
        ->using('test-provider', 'test-model')
        ->withPrompt('test')
        ->asText();

    expect($response->text)->toBe("I'm nyx!");
});

test('you can run toRequest multiple times', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Hello AI');

    $request->toRequest();
    $request->toRequest();
})->throwsNoExceptions();

test('it can set prompt with additional content', function (): void {
    $image = Image::fromUrl('https://example.com/image.jpg');

    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Analyze this image', [$image]);

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Analyze this image')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class)
        ->and($generated->messages()[0]->additionalContent)->toHaveCount(2) // Text + Image
        ->and($generated->messages()[0]->images())->toHaveCount(1)
        ->and($generated->messages()[0]->images()[0])->toBe($image);
});

test('withPrompt maintains backward compatibility without additional content', function (): void {
    $request = $this->pendingRequest
        ->using(Provider::OpenAI, 'gpt-4')
        ->withPrompt('Hello AI');

    $generated = $request->toRequest();

    expect($generated->prompt())->toBe('Hello AI')
        ->and($generated->messages()[0])->toBeInstanceOf(UserMessage::class)
        ->and($generated->messages()[0]->additionalContent)->toHaveCount(1); // Only Text
});



================================================
FILE: tests/Text/ResponseBuilderTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Text\ResponseBuilder;
use Prism\Prism\Text\Step;
use Prism\Prism\ValueObjects\Meta;
use Prism\Prism\ValueObjects\Usage;

test('TextResponseBuilder aggregates usage and forwards final step text', function (): void {
    $builder = new ResponseBuilder;

    // Intermediate step
    $builder->addStep(new Step(
        text: 'hello ',
        finishReason: FinishReason::Length,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(promptTokens: 5, completionTokens: 0),
        meta: new Meta('s1', 'test-model'),
        messages: [],
        systemPrompts: [],
    ));

    // Final step
    $builder->addStep(new Step(
        text: 'world',
        finishReason: FinishReason::Stop,
        toolCalls: [],
        toolResults: [],
        usage: new Usage(promptTokens: 2, completionTokens: 3),
        meta: new Meta('s2', 'test-model'),
        messages: [],
        systemPrompts: [],
    ));

    $response = $builder->toResponse();

    expect($response->usage->promptTokens)->toBe(7)
        ->and($response->usage->completionTokens)->toBe(3)
        ->and($response->text)->toBe('world')
        ->and($response->finishReason)->toBe(FinishReason::Stop)
        ->and($response->steps)->toHaveCount(2);
});



================================================
FILE: tests/Unit/Providers/Anthropic/AnthropicStreamStateTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\Anthropic\ValueObjects\AnthropicStreamState;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Usage;

it('constructs with default empty thinking signature', function (): void {
    $state = new AnthropicStreamState;

    expect($state->currentThinkingSignature())->toBe('');
});

it('appendThinkingSignature accumulates signature text', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinkingSignature('sig-');
    $state->appendThinkingSignature('abc');
    $state->appendThinkingSignature('-123');

    expect($state->currentThinkingSignature())->toBe('sig-abc-123');
});

it('appendThinkingSignature returns self for fluent chaining', function (): void {
    $state = new AnthropicStreamState;

    $result = $state->appendThinkingSignature('test');

    expect($result)->toBe($state);
});

it('appendThinkingSignature handles empty strings', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinkingSignature('first');
    $state->appendThinkingSignature('');
    $state->appendThinkingSignature('second');

    expect($state->currentThinkingSignature())->toBe('firstsecond');
});

it('currentThinkingSignature returns accumulated value', function (): void {
    $state = new AnthropicStreamState;

    expect($state->currentThinkingSignature())->toBe('');

    $state->appendThinkingSignature('signature-data');

    expect($state->currentThinkingSignature())->toBe('signature-data');
});

it('reset clears thinking signature', function (): void {
    $state = new AnthropicStreamState;
    $state->appendThinkingSignature('some-signature')
        ->withMessageId('msg-123')
        ->appendText('text')
        ->appendThinking('thinking');

    $state->reset();

    expect($state->currentThinkingSignature())->toBe('')
        ->and($state->messageId())->toBe('')
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('');
});

it('reset returns self', function (): void {
    $state = new AnthropicStreamState;
    $state->appendThinkingSignature('test');

    $result = $state->reset();

    expect($result)->toBe($state)
        ->and($state->currentThinkingSignature())->toBe('');
});

it('resetTextState clears thinking signature', function (): void {
    $state = new AnthropicStreamState;
    $state->appendThinkingSignature('signature')
        ->withMessageId('msg-123')
        ->appendText('text')
        ->appendThinking('thinking')
        ->withModel('claude-3')
        ->markStreamStarted();

    $state->resetTextState();

    expect($state->currentThinkingSignature())->toBe('')
        ->and($state->messageId())->toBe('')
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('')
        ->and($state->model())->toBe('claude-3')
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('resetTextState returns self', function (): void {
    $state = new AnthropicStreamState;
    $state->appendThinkingSignature('test');

    $result = $state->resetTextState();

    expect($result)->toBe($state)
        ->and($state->currentThinkingSignature())->toBe('');
});

it('supports fluent chaining with base StreamState methods', function (): void {
    $state = new AnthropicStreamState;

    $state->withMessageId('msg-456');
    $state->withModel('claude-3-5-sonnet');
    $state->appendThinkingSignature('sig-1');
    $state->appendText('Hello');
    $state->appendThinkingSignature('-sig-2');
    $state->markStreamStarted();

    expect($state->messageId())->toBe('msg-456')
        ->and($state->model())->toBe('claude-3-5-sonnet')
        ->and($state->currentThinkingSignature())->toBe('sig-1-sig-2')
        ->and($state->currentText())->toBe('Hello')
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('inherits all base StreamState functionality', function (): void {
    $state = new AnthropicStreamState;
    $citation = new MessagePartWithCitations('test');
    $usage = new Usage(100, 50);

    $state->withMessageId('msg-789');
    $state->withReasoningId('reason-123');
    $state->withModel('claude-opus');
    $state->withProvider('anthropic');
    $state->withMetadata(['temperature' => 0.7]);
    $state->markStreamStarted();
    $state->markTextStarted();
    $state->markThinkingStarted();
    $state->appendText('response text');
    $state->appendThinking('thought process');
    $state->appendThinkingSignature('signature-value');
    $state->withBlockContext(2, 'text');
    $state->addToolCall(0, ['id' => 'tool-1', 'name' => 'search']);
    $state->addCitation($citation);
    $state->withUsage($usage);
    $state->withFinishReason(FinishReason::Stop);

    expect($state->messageId())->toBe('msg-789')
        ->and($state->reasoningId())->toBe('reason-123')
        ->and($state->model())->toBe('claude-opus')
        ->and($state->provider())->toBe('anthropic')
        ->and($state->metadata())->toBe(['temperature' => 0.7])
        ->and($state->hasStreamStarted())->toBeTrue()
        ->and($state->hasTextStarted())->toBeTrue()
        ->and($state->hasThinkingStarted())->toBeTrue()
        ->and($state->currentText())->toBe('response text')
        ->and($state->currentThinking())->toBe('thought process')
        ->and($state->currentThinkingSignature())->toBe('signature-value')
        ->and($state->currentBlockIndex())->toBe(2)
        ->and($state->currentBlockType())->toBe('text')
        ->and($state->toolCalls())->toBe([0 => ['id' => 'tool-1', 'name' => 'search']])
        ->and($state->citations())->toBe([$citation])
        ->and($state->usage())->toBe($usage)
        ->and($state->finishReason())->toBe(FinishReason::Stop);
});

it('reset preserves method chaining after clearing all state', function (): void {
    $state = new AnthropicStreamState;
    $state->appendThinkingSignature('old');
    $state->withMessageId('old-id');
    $state->appendText('old-text');

    $result = $state->reset();
    $state->appendThinkingSignature('new');
    $state->withMessageId('new-id');
    $state->appendText('new-text');

    expect($result)->toBe($state)
        ->and($state->currentThinkingSignature())->toBe('new')
        ->and($state->messageId())->toBe('new-id')
        ->and($state->currentText())->toBe('new-text');
});

it('resetTextState preserves non-text state', function (): void {
    $state = new AnthropicStreamState;
    $usage = new Usage(100, 50);

    $state->appendThinkingSignature('signature');
    $state->withMessageId('msg-123');
    $state->appendText('text');
    $state->appendThinking('thinking');
    $state->withModel('claude-3');
    $state->withProvider('anthropic');
    $state->markStreamStarted();
    $state->addToolCall(0, ['id' => 'tool']);
    $state->withUsage($usage);

    $state->resetTextState();

    expect($state->currentThinkingSignature())->toBe('')
        ->and($state->messageId())->toBe('')
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('')
        ->and($state->model())->toBe('claude-3')
        ->and($state->provider())->toBe('anthropic')
        ->and($state->hasStreamStarted())->toBeTrue()
        ->and($state->toolCalls())->toBe([0 => ['id' => 'tool']])
        ->and($state->usage())->toBe($usage);
});

it('handles multiple reset cycles', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinkingSignature('first');
    expect($state->currentThinkingSignature())->toBe('first');

    $state->reset();
    expect($state->currentThinkingSignature())->toBe('');

    $state->appendThinkingSignature('second');
    expect($state->currentThinkingSignature())->toBe('second');

    $state->resetTextState();
    expect($state->currentThinkingSignature())->toBe('');

    $state->appendThinkingSignature('third');
    expect($state->currentThinkingSignature())->toBe('third');
});

it('handles multiple resetTextState cycles', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinkingSignature('sig-1')->withMessageId('msg-1');
    $state->resetTextState();
    expect($state->currentThinkingSignature())->toBe('')
        ->and($state->messageId())->toBe('');

    $state->appendThinkingSignature('sig-2')->withMessageId('msg-2');
    $state->resetTextState();
    expect($state->currentThinkingSignature())->toBe('')
        ->and($state->messageId())->toBe('');

    $state->appendThinkingSignature('sig-3')->withMessageId('msg-3');
    expect($state->currentThinkingSignature())->toBe('sig-3')
        ->and($state->messageId())->toBe('msg-3');
});

it('maintains signature independence from thinking content', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinking('thinking content');
    $state->appendThinkingSignature('signature content');

    expect($state->currentThinking())->toBe('thinking content')
        ->and($state->currentThinkingSignature())->toBe('signature content');

    $state->appendThinking(' more thinking');
    $state->appendThinkingSignature(' more signature');

    expect($state->currentThinking())->toBe('thinking content more thinking')
        ->and($state->currentThinkingSignature())->toBe('signature content more signature');
});

it('signature persists through base state resets that do not call reset', function (): void {
    $state = new AnthropicStreamState;

    $state->appendThinkingSignature('persistent-sig');
    $state->withBlockContext(5, 'text');

    $state->resetBlock();

    expect($state->currentThinkingSignature())->toBe('persistent-sig')
        ->and($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull();
});

it('handles very long signature accumulation', function (): void {
    $state = new AnthropicStreamState;

    for ($i = 0; $i < 100; $i++) {
        $state->appendThinkingSignature("chunk-{$i}-");
    }

    $expected = '';
    for ($i = 0; $i < 100; $i++) {
        $expected .= "chunk-{$i}-";
    }

    expect($state->currentThinkingSignature())->toBe($expected);
});



================================================
FILE: tests/Unit/Providers/Ollama/OllamaStreamStateTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Providers\Ollama\ValueObjects\OllamaStreamState;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Usage;

it('constructs with default token counts at zero', function (): void {
    $state = new OllamaStreamState;

    expect($state->promptTokens())->toBe(0)
        ->and($state->completionTokens())->toBe(0);
});

it('inherits base StreamState functionality', function (): void {
    $state = new OllamaStreamState;

    expect($state->messageId())->toBe('')
        ->and($state->model())->toBe('')
        ->and($state->provider())->toBe('')
        ->and($state->hasStreamStarted())->toBeFalse()
        ->and($state->currentText())->toBe('')
        ->and($state->toolCalls())->toBe([]);
});

it('addPromptTokens accumulates tokens', function (): void {
    $state = new OllamaStreamState;

    $state->addPromptTokens(100);
    $state->addPromptTokens(50);
    $state->addPromptTokens(25);

    expect($state->promptTokens())->toBe(175);
});

it('addPromptTokens returns self for fluent chaining', function (): void {
    $state = new OllamaStreamState;

    $result = $state->addPromptTokens(10);

    expect($result)->toBe($state);
});

it('addCompletionTokens accumulates tokens', function (): void {
    $state = new OllamaStreamState;

    $state->addCompletionTokens(200);
    $state->addCompletionTokens(75);
    $state->addCompletionTokens(30);

    expect($state->completionTokens())->toBe(305);
});

it('addCompletionTokens returns self for fluent chaining', function (): void {
    $state = new OllamaStreamState;

    $result = $state->addCompletionTokens(20);

    expect($result)->toBe($state);
});

it('promptTokens returns current count', function (): void {
    $state = new OllamaStreamState;

    expect($state->promptTokens())->toBe(0);

    $state->addPromptTokens(42);

    expect($state->promptTokens())->toBe(42);
});

it('completionTokens returns current count', function (): void {
    $state = new OllamaStreamState;

    expect($state->completionTokens())->toBe(0);

    $state->addCompletionTokens(84);

    expect($state->completionTokens())->toBe(84);
});

it('supports fluent chaining with token methods', function (): void {
    $state = new OllamaStreamState;

    $result = $state
        ->addPromptTokens(100)
        ->addCompletionTokens(50)
        ->addPromptTokens(25)
        ->addCompletionTokens(10);

    expect($result)->toBe($state)
        ->and($state->promptTokens())->toBe(125)
        ->and($state->completionTokens())->toBe(60);
});

it('supports fluent chaining with base StreamState methods', function (): void {
    $state = new OllamaStreamState;

    $result = $state
        ->withMessageId('msg-123')
        ->withModel('llama2')
        ->addPromptTokens(100)
        ->markStreamStarted()
        ->addCompletionTokens(50);

    expect($result)->toBe($state)
        ->and($state->messageId())->toBe('msg-123')
        ->and($state->model())->toBe('llama2')
        ->and($state->promptTokens())->toBe(100)
        ->and($state->completionTokens())->toBe(50)
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('reset clears token counts', function (): void {
    $state = new OllamaStreamState;
    $state->addPromptTokens(100);
    $state->addCompletionTokens(50);

    $state->reset();

    expect($state->promptTokens())->toBe(0)
        ->and($state->completionTokens())->toBe(0);
});

it('reset clears base StreamState properties', function (): void {
    $state = new OllamaStreamState;
    $state->withMessageId('msg-123')
        ->withModel('llama2')
        ->withProvider('ollama')
        ->markStreamStarted()
        ->appendText('some text')
        ->addToolCall(0, ['id' => 'test'])
        ->withUsage(new Usage(100, 50))
        ->addPromptTokens(200)
        ->addCompletionTokens(100);

    $state->reset();

    expect($state->messageId())->toBe('')
        ->and($state->model())->toBe('')
        ->and($state->provider())->toBe('')
        ->and($state->hasStreamStarted())->toBeFalse()
        ->and($state->currentText())->toBe('')
        ->and($state->toolCalls())->toBe([])
        ->and($state->usage())->toBeNull()
        ->and($state->promptTokens())->toBe(0)
        ->and($state->completionTokens())->toBe(0);
});

it('reset returns self for fluent chaining', function (): void {
    $state = new OllamaStreamState;

    $result = $state->reset();

    expect($result)->toBe($state);
});

it('handles zero token additions', function (): void {
    $state = new OllamaStreamState;

    $state->addPromptTokens(0);
    $state->addCompletionTokens(0);

    expect($state->promptTokens())->toBe(0)
        ->and($state->completionTokens())->toBe(0);
});

it('handles large token counts', function (): void {
    $state = new OllamaStreamState;

    $state->addPromptTokens(1000000);
    $state->addCompletionTokens(2000000);

    expect($state->promptTokens())->toBe(1000000)
        ->and($state->completionTokens())->toBe(2000000);
});

it('maintains independent token counters', function (): void {
    $state = new OllamaStreamState;

    $state->addPromptTokens(100);
    expect($state->promptTokens())->toBe(100);
    expect($state->completionTokens())->toBe(0);

    $state->addCompletionTokens(50);
    expect($state->promptTokens())->toBe(100);
    expect($state->completionTokens())->toBe(50);
});

it('reset allows reuse of state object', function (): void {
    $state = new OllamaStreamState;

    $state->addPromptTokens(100)->addCompletionTokens(50);
    expect($state->promptTokens())->toBe(100);
    expect($state->completionTokens())->toBe(50);

    $state->reset();
    expect($state->promptTokens())->toBe(0);
    expect($state->completionTokens())->toBe(0);

    $state->addPromptTokens(200)->addCompletionTokens(75);
    expect($state->promptTokens())->toBe(200);
    expect($state->completionTokens())->toBe(75);
});

it('works with base StreamState text accumulation', function (): void {
    $state = new OllamaStreamState;

    $state->appendText('Hello')
        ->addPromptTokens(5)
        ->appendText(' world')
        ->addCompletionTokens(2);

    expect($state->currentText())->toBe('Hello world')
        ->and($state->promptTokens())->toBe(5)
        ->and($state->completionTokens())->toBe(2);
});

it('works with base StreamState tool calls', function (): void {
    $state = new OllamaStreamState;

    $state->addToolCall(0, ['id' => 'call-1', 'name' => 'search'])
        ->addPromptTokens(50)
        ->addCompletionTokens(25);

    expect($state->toolCalls())->toBe([
        0 => ['id' => 'call-1', 'name' => 'search'],
    ])
        ->and($state->promptTokens())->toBe(50)
        ->and($state->completionTokens())->toBe(25);
});

it('works with base StreamState usage tracking', function (): void {
    $state = new OllamaStreamState;
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50
    );

    $state->withUsage($usage)
        ->addPromptTokens(100)
        ->addCompletionTokens(50);

    expect($state->usage())->toBe($usage)
        ->and($state->promptTokens())->toBe(100)
        ->and($state->completionTokens())->toBe(50);
});

it('works with base StreamState finish reason', function (): void {
    $state = new OllamaStreamState;

    $state->withFinishReason(FinishReason::Stop)
        ->addPromptTokens(100)
        ->addCompletionTokens(50);

    expect($state->finishReason())->toBe(FinishReason::Stop)
        ->and($state->promptTokens())->toBe(100)
        ->and($state->completionTokens())->toBe(50);
});

it('works with base StreamState citations', function (): void {
    $state = new OllamaStreamState;
    $citation = new MessagePartWithCitations('text with citation');

    $state->addCitation($citation)
        ->addPromptTokens(50)
        ->addCompletionTokens(25);

    expect($state->citations())->toBe([$citation])
        ->and($state->promptTokens())->toBe(50)
        ->and($state->completionTokens())->toBe(25);
});

it('preserves token counts when using base resetTextState', function (): void {
    $state = new OllamaStreamState;

    $state->withMessageId('msg-123')
        ->appendText('some text')
        ->addPromptTokens(100)
        ->addCompletionTokens(50);

    $state->resetTextState();

    expect($state->messageId())->toBe('')
        ->and($state->currentText())->toBe('')
        ->and($state->promptTokens())->toBe(100)
        ->and($state->completionTokens())->toBe(50);
});

it('preserves token counts when using base resetBlock', function (): void {
    $state = new OllamaStreamState;

    $state->withBlockContext(5, 'text')
        ->addPromptTokens(100)
        ->addCompletionTokens(50);

    $state->resetBlock();

    expect($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull()
        ->and($state->promptTokens())->toBe(100)
        ->and($state->completionTokens())->toBe(50);
});



================================================
FILE: tests/Unit/Streaming/StreamStateTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Streaming\StreamState;
use Prism\Prism\ValueObjects\MessagePartWithCitations;
use Prism\Prism\ValueObjects\Usage;

it('constructs with default empty state', function (): void {
    $state = new StreamState;

    expect($state->messageId())->toBe('')
        ->and($state->reasoningId())->toBe('')
        ->and($state->model())->toBe('')
        ->and($state->provider())->toBe('')
        ->and($state->metadata())->toBeNull()
        ->and($state->hasStreamStarted())->toBeFalse()
        ->and($state->hasTextStarted())->toBeFalse()
        ->and($state->hasThinkingStarted())->toBeFalse()
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('')
        ->and($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull()
        ->and($state->toolCalls())->toBe([])
        ->and($state->citations())->toBe([])
        ->and($state->usage())->toBeNull()
        ->and($state->finishReason())->toBeNull();
});

it('withMessageId returns self and sets value', function (): void {
    $state = new StreamState;

    $result = $state->withMessageId('msg-123');

    expect($result)->toBe($state)
        ->and($state->messageId())->toBe('msg-123');
});

it('withReasoningId returns self and sets value', function (): void {
    $state = new StreamState;

    $result = $state->withReasoningId('reason-456');

    expect($result)->toBe($state)
        ->and($state->reasoningId())->toBe('reason-456');
});

it('withModel returns self and sets value', function (): void {
    $state = new StreamState;

    $result = $state->withModel('gpt-4');

    expect($result)->toBe($state)
        ->and($state->model())->toBe('gpt-4');
});

it('withProvider returns self and sets value', function (): void {
    $state = new StreamState;

    $result = $state->withProvider('openai');

    expect($result)->toBe($state)
        ->and($state->provider())->toBe('openai');
});

it('withMetadata returns self and sets value', function (): void {
    $state = new StreamState;
    $metadata = ['temperature' => 0.7, 'max_tokens' => 100];

    $result = $state->withMetadata($metadata);

    expect($result)->toBe($state)
        ->and($state->metadata())->toBe($metadata);
});

it('withMetadata accepts null', function (): void {
    $state = new StreamState;
    $state->withMetadata(['foo' => 'bar']);

    $state->withMetadata(null);

    expect($state->metadata())->toBeNull();
});

it('markStreamStarted returns self and sets flag', function (): void {
    $state = new StreamState;

    $result = $state->markStreamStarted();

    expect($result)->toBe($state)
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('markTextStarted returns self and sets flag', function (): void {
    $state = new StreamState;

    $result = $state->markTextStarted();

    expect($result)->toBe($state)
        ->and($state->hasTextStarted())->toBeTrue();
});

it('markThinkingStarted returns self and sets flag', function (): void {
    $state = new StreamState;

    $result = $state->markThinkingStarted();

    expect($result)->toBe($state)
        ->and($state->hasThinkingStarted())->toBeTrue();
});

it('supports fluent setter chaining', function (): void {
    $state = new StreamState;

    $result = $state
        ->withMessageId('msg-123')
        ->withModel('gpt-4')
        ->withProvider('openai')
        ->markStreamStarted();

    expect($result)->toBe($state)
        ->and($state->messageId())->toBe('msg-123')
        ->and($state->model())->toBe('gpt-4')
        ->and($state->provider())->toBe('openai')
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('appendText accumulates text', function (): void {
    $state = new StreamState;

    $state->appendText('Hello');
    $state->appendText(' ');
    $state->appendText('world');

    expect($state->currentText())->toBe('Hello world');
});

it('appendText returns self', function (): void {
    $state = new StreamState;

    $result = $state->appendText('test');

    expect($result)->toBe($state);
});

it('appendThinking accumulates thinking', function (): void {
    $state = new StreamState;

    $state->appendThinking('First thought');
    $state->appendThinking(' and second');

    expect($state->currentThinking())->toBe('First thought and second');
});

it('appendThinking returns self', function (): void {
    $state = new StreamState;

    $result = $state->appendThinking('test');

    expect($result)->toBe($state);
});

it('withText replaces text', function (): void {
    $state = new StreamState;
    $state->appendText('Old text');

    $state->withText('New text');

    expect($state->currentText())->toBe('New text');
});

it('withText returns self', function (): void {
    $state = new StreamState;

    $result = $state->withText('test');

    expect($result)->toBe($state);
});

it('withThinking replaces thinking', function (): void {
    $state = new StreamState;
    $state->appendThinking('Old thinking');

    $state->withThinking('New thinking');

    expect($state->currentThinking())->toBe('New thinking');
});

it('withThinking returns self', function (): void {
    $state = new StreamState;

    $result = $state->withThinking('test');

    expect($result)->toBe($state);
});

it('withBlockContext sets index and type', function (): void {
    $state = new StreamState;

    $state->withBlockContext(2, 'text');

    expect($state->currentBlockIndex())->toBe(2)
        ->and($state->currentBlockType())->toBe('text');
});

it('withBlockContext returns self', function (): void {
    $state = new StreamState;

    $result = $state->withBlockContext(0, 'tool_use');

    expect($result)->toBe($state);
});

it('resetBlockContext clears index and type', function (): void {
    $state = new StreamState;
    $state->withBlockContext(5, 'thinking');

    $state->resetBlockContext();

    expect($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull();
});

it('resetBlockContext returns self', function (): void {
    $state = new StreamState;

    $result = $state->resetBlockContext();

    expect($result)->toBe($state);
});

it('addToolCall adds to specific index', function (): void {
    $state = new StreamState;
    $toolCall1 = ['id' => 'call-1', 'name' => 'search'];
    $toolCall2 = ['id' => 'call-2', 'name' => 'calculate'];

    $state->addToolCall(0, $toolCall1);
    $state->addToolCall(1, $toolCall2);

    expect($state->toolCalls())->toBe([
        0 => $toolCall1,
        1 => $toolCall2,
    ]);
});

it('addToolCall returns self', function (): void {
    $state = new StreamState;

    $result = $state->addToolCall(0, ['id' => 'test']);

    expect($result)->toBe($state);
});

it('addToolCall overwrites existing index', function (): void {
    $state = new StreamState;
    $state->addToolCall(0, ['id' => 'old']);

    $state->addToolCall(0, ['id' => 'new']);

    expect($state->toolCalls()[0])->toBe(['id' => 'new']);
});

it('appendToolCallInput creates new tool call if not exists', function (): void {
    $state = new StreamState;

    $state->appendToolCallInput(0, 'first chunk');

    expect($state->toolCalls())->toBe([
        0 => ['input' => 'first chunk'],
    ]);
});

it('appendToolCallInput appends to existing input', function (): void {
    $state = new StreamState;
    $state->appendToolCallInput(0, 'first');
    $state->appendToolCallInput(0, ' second');
    $state->appendToolCallInput(0, ' third');

    expect($state->toolCalls()[0]['input'])->toBe('first second third');
});

it('appendToolCallInput returns self', function (): void {
    $state = new StreamState;

    $result = $state->appendToolCallInput(0, 'test');

    expect($result)->toBe($state);
});

it('updateToolCall merges data into existing tool call', function (): void {
    $state = new StreamState;
    $state->addToolCall(0, ['id' => 'call-1', 'name' => 'search']);

    $state->updateToolCall(0, ['status' => 'complete', 'result' => 'found']);

    expect($state->toolCalls()[0])->toBe([
        'id' => 'call-1',
        'name' => 'search',
        'status' => 'complete',
        'result' => 'found',
    ]);
});

it('updateToolCall creates new tool call if not exists', function (): void {
    $state = new StreamState;

    $state->updateToolCall(0, ['id' => 'call-1']);

    expect($state->toolCalls())->toBe([
        0 => ['id' => 'call-1'],
    ]);
});

it('updateToolCall overwrites existing keys', function (): void {
    $state = new StreamState;
    $state->addToolCall(0, ['id' => 'old-id', 'name' => 'search']);

    $state->updateToolCall(0, ['id' => 'new-id']);

    expect($state->toolCalls()[0])->toBe([
        'id' => 'new-id',
        'name' => 'search',
    ]);
});

it('updateToolCall returns self', function (): void {
    $state = new StreamState;

    $result = $state->updateToolCall(0, ['test' => 'value']);

    expect($result)->toBe($state);
});

it('hasToolCalls returns false when empty', function (): void {
    $state = new StreamState;

    expect($state->hasToolCalls())->toBeFalse();
});

it('hasToolCalls returns true when tool calls exist', function (): void {
    $state = new StreamState;
    $state->addToolCall(0, ['id' => 'test']);

    expect($state->hasToolCalls())->toBeTrue();
});

it('addCitation adds MessagePartWithCitations', function (): void {
    $state = new StreamState;
    $citation1 = new MessagePartWithCitations('text 1');
    $citation2 = new MessagePartWithCitations('text 2');

    $state->addCitation($citation1);
    $state->addCitation($citation2);

    expect($state->citations())->toBe([$citation1, $citation2]);
});

it('addCitation returns self', function (): void {
    $state = new StreamState;
    $citation = new MessagePartWithCitations('test');

    $result = $state->addCitation($citation);

    expect($result)->toBe($state);
});

it('withUsage stores Usage object', function (): void {
    $state = new StreamState;
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50
    );

    $state->withUsage($usage);

    expect($state->usage())->toBe($usage)
        ->and($state->usage()->promptTokens)->toBe(100)
        ->and($state->usage()->completionTokens)->toBe(50);
});

it('withUsage returns self', function (): void {
    $state = new StreamState;
    $usage = new Usage(10, 5);

    $result = $state->withUsage($usage);

    expect($result)->toBe($state);
});

it('withFinishReason stores FinishReason enum', function (): void {
    $state = new StreamState;

    $state->withFinishReason(FinishReason::Stop);

    expect($state->finishReason())->toBe(FinishReason::Stop);
});

it('withFinishReason returns self', function (): void {
    $state = new StreamState;

    $result = $state->withFinishReason(FinishReason::Length);

    expect($result)->toBe($state);
});

it('shouldEmitStreamStart returns true when not started', function (): void {
    $state = new StreamState;

    expect($state->shouldEmitStreamStart())->toBeTrue();
});

it('shouldEmitStreamStart returns false when started', function (): void {
    $state = new StreamState;
    $state->markStreamStarted();

    expect($state->shouldEmitStreamStart())->toBeFalse();
});

it('shouldEmitTextStart returns true when not started', function (): void {
    $state = new StreamState;

    expect($state->shouldEmitTextStart())->toBeTrue();
});

it('shouldEmitTextStart returns false when started', function (): void {
    $state = new StreamState;
    $state->markTextStarted();

    expect($state->shouldEmitTextStart())->toBeFalse();
});

it('shouldEmitThinkingStart returns true when not started', function (): void {
    $state = new StreamState;

    expect($state->shouldEmitThinkingStart())->toBeTrue();
});

it('shouldEmitThinkingStart returns false when started', function (): void {
    $state = new StreamState;
    $state->markThinkingStarted();

    expect($state->shouldEmitThinkingStart())->toBeFalse();
});

it('reset clears all state', function (): void {
    $state = new StreamState;
    $state->withMessageId('msg-123')
        ->withReasoningId('reason-456')
        ->withModel('gpt-4')
        ->withProvider('openai')
        ->withMetadata(['key' => 'value'])
        ->markStreamStarted()
        ->markTextStarted()
        ->markThinkingStarted()
        ->appendText('some text')
        ->appendThinking('some thinking')
        ->withBlockContext(5, 'text')
        ->addToolCall(0, ['id' => 'test'])
        ->addCitation(new MessagePartWithCitations('citation'))
        ->withUsage(new Usage(100, 50))
        ->withFinishReason(FinishReason::Stop);

    $state->reset();

    expect($state->messageId())->toBe('')
        ->and($state->reasoningId())->toBe('')
        ->and($state->model())->toBe('')
        ->and($state->provider())->toBe('')
        ->and($state->metadata())->toBeNull()
        ->and($state->hasStreamStarted())->toBeFalse()
        ->and($state->hasTextStarted())->toBeFalse()
        ->and($state->hasThinkingStarted())->toBeFalse()
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('')
        ->and($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull()
        ->and($state->toolCalls())->toBe([])
        ->and($state->citations())->toBe([])
        ->and($state->usage())->toBeNull()
        ->and($state->finishReason())->toBeNull();
});

it('reset returns self', function (): void {
    $state = new StreamState;

    $result = $state->reset();

    expect($result)->toBe($state);
});

it('resetTextState clears text-related state only', function (): void {
    $state = new StreamState;
    $citation = new MessagePartWithCitations('test');
    $usage = new Usage(100, 50);

    $state->withMessageId('msg-123')
        ->withReasoningId('reason-456')
        ->withModel('gpt-4')
        ->withProvider('openai')
        ->markStreamStarted()
        ->markTextStarted()
        ->markThinkingStarted()
        ->appendText('some text')
        ->appendThinking('some thinking')
        ->addCitation($citation)
        ->withUsage($usage);

    $state->resetTextState();

    expect($state->messageId())->toBe('')
        ->and($state->hasTextStarted())->toBeFalse()
        ->and($state->hasThinkingStarted())->toBeFalse()
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('')
        ->and($state->citations())->toBe([$citation])
        ->and($state->usage())->toBe($usage)
        ->and($state->model())->toBe('gpt-4')
        ->and($state->provider())->toBe('openai')
        ->and($state->hasStreamStarted())->toBeTrue();
});

it('resetTextState returns self', function (): void {
    $state = new StreamState;

    $result = $state->resetTextState();

    expect($result)->toBe($state);
});

it('resetBlock clears block context only', function (): void {
    $state = new StreamState;
    $state->withMessageId('msg-123')
        ->appendText('text')
        ->withBlockContext(5, 'text')
        ->addToolCall(0, ['id' => 'test']);

    $state->resetBlock();

    expect($state->currentBlockIndex())->toBeNull()
        ->and($state->currentBlockType())->toBeNull()
        ->and($state->messageId())->toBe('msg-123')
        ->and($state->currentText())->toBe('text')
        ->and($state->hasToolCalls())->toBeTrue();
});

it('resetBlock returns self', function (): void {
    $state = new StreamState;

    $result = $state->resetBlock();

    expect($result)->toBe($state);
});

it('handles empty string values', function (): void {
    $state = new StreamState;

    $state->withMessageId('')
        ->withReasoningId('')
        ->withModel('')
        ->withProvider('')
        ->withText('')
        ->withThinking('');

    expect($state->messageId())->toBe('')
        ->and($state->reasoningId())->toBe('')
        ->and($state->model())->toBe('')
        ->and($state->provider())->toBe('')
        ->and($state->currentText())->toBe('')
        ->and($state->currentThinking())->toBe('');
});

it('handles empty array values', function (): void {
    $state = new StreamState;

    $state->withMetadata([]);

    expect($state->metadata())->toBe([])
        ->and($state->toolCalls())->toBe([])
        ->and($state->citations())->toBe([]);
});

it('handles complex Usage with all optional fields', function (): void {
    $state = new StreamState;
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50,
        cacheWriteInputTokens: 25,
        cacheReadInputTokens: 10,
        thoughtTokens: 5
    );

    $state->withUsage($usage);

    expect($state->usage())->toBe($usage)
        ->and($state->usage()->promptTokens)->toBe(100)
        ->and($state->usage()->completionTokens)->toBe(50)
        ->and($state->usage()->cacheWriteInputTokens)->toBe(25)
        ->and($state->usage()->cacheReadInputTokens)->toBe(10)
        ->and($state->usage()->thoughtTokens)->toBe(5);
});

it('handles MessagePartWithCitations with all fields', function (): void {
    $state = new StreamState;
    $citation = new MessagePartWithCitations(
        outputText: 'Some text',
        citations: [],
        additionalContent: ['source' => 'document.pdf']
    );

    $state->addCitation($citation);

    expect($state->citations()[0])->toBe($citation)
        ->and($state->citations()[0]->outputText)->toBe('Some text')
        ->and($state->citations()[0]->additionalContent)->toBe(['source' => 'document.pdf']);
});

it('handles all FinishReason enum values', function (): void {
    $state = new StreamState;

    $state->withFinishReason(FinishReason::Stop);
    expect($state->finishReason())->toBe(FinishReason::Stop);

    $state->withFinishReason(FinishReason::Length);
    expect($state->finishReason())->toBe(FinishReason::Length);

    $state->withFinishReason(FinishReason::ContentFilter);
    expect($state->finishReason())->toBe(FinishReason::ContentFilter);

    $state->withFinishReason(FinishReason::ToolCalls);
    expect($state->finishReason())->toBe(FinishReason::ToolCalls);

    $state->withFinishReason(FinishReason::Error);
    expect($state->finishReason())->toBe(FinishReason::Error);

    $state->withFinishReason(FinishReason::Other);
    expect($state->finishReason())->toBe(FinishReason::Other);

    $state->withFinishReason(FinishReason::Unknown);
    expect($state->finishReason())->toBe(FinishReason::Unknown);
});

it('preserves tool call indices correctly', function (): void {
    $state = new StreamState;

    $state->addToolCall(5, ['id' => 'call-5']);
    $state->addToolCall(2, ['id' => 'call-2']);
    $state->addToolCall(10, ['id' => 'call-10']);

    expect($state->toolCalls())->toBe([
        5 => ['id' => 'call-5'],
        2 => ['id' => 'call-2'],
        10 => ['id' => 'call-10'],
    ]);
});



================================================
FILE: tests/Unit/Streaming/Events/ErrorEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ErrorEvent;

it('constructs with required parameters', function (): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'rate_limit',
        message: 'Rate limit exceeded: 100 requests per minute',
        recoverable: true
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->errorType)->toBe('rate_limit')
        ->and($event->message)->toBe('Rate limit exceeded: 100 requests per minute')
        ->and($event->recoverable)->toBeTrue()
        ->and($event->metadata)->toBeNull();
});

it('constructs with metadata', function (): void {
    $metadata = [
        'retry_after' => 60,
        'request_id' => 'req-456',
        'endpoint' => '/api/chat',
    ];

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'validation',
        message: 'Invalid request format',
        recoverable: false,
        metadata: $metadata
    );

    expect($event->metadata)->toBe($metadata);
});

it('returns correct stream event type', function (): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'network',
        message: 'Connection failed',
        recoverable: true
    );

    expect($event->type())->toBe(StreamEventType::Error);
});

it('converts to array with all properties', function (): void {
    $metadata = [
        'http_status' => 500,
        'error_code' => 'INTERNAL_ERROR',
        'details' => ['component' => 'database', 'query' => 'failed'],
    ];

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'internal',
        message: 'Internal server error occurred',
        recoverable: false,
        metadata: $metadata
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'error_type' => 'internal',
        'message' => 'Internal server error occurred',
        'recoverable' => false,
        'metadata' => $metadata,
    ]);
});

it('converts to array with null metadata', function (): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'timeout',
        message: 'Request timeout after 30 seconds',
        recoverable: true
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'error_type' => 'timeout',
        'message' => 'Request timeout after 30 seconds',
        'recoverable' => true,
        'metadata' => null,
    ]);
});

it('handles different error types', function (string $errorType): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: $errorType,
        message: "Error of type {$errorType}",
        recoverable: true
    );

    expect($event->errorType)->toBe($errorType)
        ->and($event->toArray()['error_type'])->toBe($errorType);
})->with([
    'rate_limit',
    'validation',
    'authentication',
    'authorization',
    'network',
    'timeout',
    'internal',
    'service_unavailable',
    'quota_exceeded',
    'model_overloaded',
]);

it('handles recoverable and non-recoverable errors', function (bool $recoverable): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'test',
        message: 'Test error',
        recoverable: $recoverable
    );

    expect($event->recoverable)->toBe($recoverable)
        ->and($event->toArray()['recoverable'])->toBe($recoverable);
})->with([true, false]);

it('handles empty string error message', function (): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'unknown',
        message: '',
        recoverable: false
    );

    expect($event->message)->toBe('');
});

it('handles multiline error message', function (): void {
    $message = "Multiple errors occurred:\n1. Connection failed\n2. Retry limit exceeded\n3. Request cancelled";

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'multiple',
        message: $message,
        recoverable: false
    );

    expect($event->message)->toBe($message);
});

it('handles complex metadata structure', function (): void {
    $metadata = [
        'request_details' => [
            'method' => 'POST',
            'url' => '/api/v1/chat',
            'headers' => ['Content-Type' => 'application/json'],
            'body_size' => 1024,
        ],
        'error_chain' => [
            ['type' => 'NetworkError', 'message' => 'DNS resolution failed'],
            ['type' => 'RetryError', 'message' => 'Max retries exceeded'],
        ],
        'context' => [
            'user_id' => 'user-789',
            'session_id' => 'session-101',
            'timestamp' => 1640995200,
        ],
        'system_info' => [
            'version' => '1.2.3',
            'environment' => 'production',
            'region' => 'us-east-1',
        ],
    ];

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'complex',
        message: 'Complex error with detailed metadata',
        recoverable: true,
        metadata: $metadata
    );

    expect($event->metadata)->toBe($metadata)
        ->and($event->toArray()['metadata'])->toBe($metadata);
});

it('handles empty metadata array', function (): void {
    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'empty_metadata',
        message: 'Error with empty metadata',
        recoverable: true,
        metadata: []
    );

    expect($event->metadata)->toBe([])
        ->and($event->toArray()['metadata'])->toBe([]);
});

it('handles special characters in error message', function (): void {
    $message = "Error with special chars: \"quotes\", 'apostrophes', <tags>, &entities;, émojis 🚨";

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'special_chars',
        message: $message,
        recoverable: false
    );

    expect($event->message)->toBe($message);
});

it('handles very long error message', function (): void {
    $message = str_repeat('This is a very long error message. ', 100);

    $event = new ErrorEvent(
        id: 'event-123',
        timestamp: 1640995200,
        errorType: 'long_message',
        message: $message,
        recoverable: true
    );

    expect($event->message)->toBe($message);
});

it('handles empty string properties', function (): void {
    $event = new ErrorEvent(
        id: '',
        timestamp: 0,
        errorType: '',
        message: '',
        recoverable: false
    );

    expect($event->id)->toBe('')
        ->and($event->errorType)->toBe('')
        ->and($event->message)->toBe('');
});



================================================
FILE: tests/Unit/Streaming/Events/StreamEndEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\FinishReason;
use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\StreamEndEvent;
use Prism\Prism\ValueObjects\Usage;

it('constructs with required parameters', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->finishReason)->toBe(FinishReason::Stop)
        ->and($event->usage)->toBeNull();
});

it('constructs with usage information', function (): void {
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50,
        cacheWriteInputTokens: 25,
        cacheReadInputTokens: 10,
        thoughtTokens: 5
    );

    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Length,
        usage: $usage
    );

    expect($event->usage)->toBe($usage);
});

it('returns correct stream event type', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop
    );

    expect($event->type())->toBe(StreamEventType::StreamEnd);
});

it('converts to array without usage', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::ContentFilter
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'finish_reason' => 'ContentFilter',
        'usage' => null,
        'citations' => null,
    ]);
});

it('converts to array with complete usage information', function (): void {
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50,
        cacheWriteInputTokens: 25,
        cacheReadInputTokens: 10,
        thoughtTokens: 5
    );

    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::ToolCalls,
        usage: $usage
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'finish_reason' => 'ToolCalls',
        'usage' => [
            'prompt_tokens' => 100,
            'completion_tokens' => 50,
            'cache_write_input_tokens' => 25,
            'cache_read_input_tokens' => 10,
            'thought_tokens' => 5,
        ],
        'citations' => null,
    ]);
});

it('converts to array with partial usage information', function (): void {
    $usage = new Usage(
        promptTokens: 100,
        completionTokens: 50
    );

    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop,
        usage: $usage
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'finish_reason' => 'Stop',
        'usage' => [
            'prompt_tokens' => 100,
            'completion_tokens' => 50,
            'cache_write_input_tokens' => null,
            'cache_read_input_tokens' => null,
            'thought_tokens' => null,
        ],
        'citations' => null,
    ]);
});

it('handles all finish reason types', function (FinishReason $reason): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: $reason
    );

    expect($event->finishReason)->toBe($reason)
        ->and($event->toArray()['finish_reason'])->toBe($reason->name);
})->with([
    FinishReason::Stop,
    FinishReason::Length,
    FinishReason::ContentFilter,
    FinishReason::ToolCalls,
    FinishReason::Error,
    FinishReason::Other,
    FinishReason::Unknown,
]);

it('constructs with additional content', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop,
        additionalContent: [
            'response_id' => 'resp_abc123',
            'custom_field' => 'custom_value',
        ]
    );

    expect($event->additionalContent)->toBe([
        'response_id' => 'resp_abc123',
        'custom_field' => 'custom_value',
    ]);
});

it('includes additional content in array output', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop,
        additionalContent: [
            'response_id' => 'resp_abc123',
            'provider_field' => 'value',
        ]
    );

    $array = $event->toArray();

    expect($array)->toHaveKey('response_id')
        ->and($array['response_id'])->toBe('resp_abc123')
        ->and($array)->toHaveKey('provider_field')
        ->and($array['provider_field'])->toBe('value')
        ->and($array)->toHaveKey('id')
        ->and($array['id'])->toBe('event-123');
});

it('defaults to empty additional content', function (): void {
    $event = new StreamEndEvent(
        id: 'event-123',
        timestamp: 1640995200,
        finishReason: FinishReason::Stop
    );

    expect($event->additionalContent)->toBe([]);

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'finish_reason' => 'Stop',
        'usage' => null,
        'citations' => null,
    ]);
});



================================================
FILE: tests/Unit/Streaming/Events/StreamStartEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\StreamStartEvent;

it('constructs with required parameters', function (): void {
    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'gpt-4',
        provider: 'openai'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->model)->toBe('gpt-4')
        ->and($event->provider)->toBe('openai')
        ->and($event->metadata)->toBeNull();
});

it('constructs with metadata', function (): void {
    $metadata = ['temperature' => 0.7, 'max_tokens' => 100];

    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'claude-3-sonnet',
        provider: 'anthropic',
        metadata: $metadata
    );

    expect($event->metadata)->toBe($metadata);
});

it('returns correct stream event type', function (): void {
    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'gpt-4',
        provider: 'openai'
    );

    expect($event->type())->toBe(StreamEventType::StreamStart);
});

it('converts to array with all properties', function (): void {
    $metadata = ['temperature' => 0.7, 'max_tokens' => 100];

    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'claude-3-sonnet',
        provider: 'anthropic',
        metadata: $metadata
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'model' => 'claude-3-sonnet',
        'provider' => 'anthropic',
        'metadata' => $metadata,
    ]);
});

it('converts to array with null metadata', function (): void {
    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'gpt-4',
        provider: 'openai'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'model' => 'gpt-4',
        'provider' => 'openai',
        'metadata' => null,
    ]);
});

it('handles empty string properties', function (): void {
    $event = new StreamStartEvent(
        id: '',
        timestamp: 0,
        model: '',
        provider: ''
    );

    expect($event->id)->toBe('')
        ->and($event->model)->toBe('')
        ->and($event->provider)->toBe('');
});

it('handles empty metadata array', function (): void {
    $event = new StreamStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        model: 'gpt-4',
        provider: 'openai',
        metadata: []
    );

    expect($event->metadata)->toBe([])
        ->and($event->toArray()['metadata'])->toBe([]);
});



================================================
FILE: tests/Unit/Streaming/Events/TextCompleteEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\TextCompleteEvent;

it('constructs with required parameters', function (): void {
    $event = new TextCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->messageId)->toBe('msg-456');
});

it('returns correct stream event type', function (): void {
    $event = new TextCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    expect($event->type())->toBe(StreamEventType::TextComplete);
});

it('converts to array with all properties', function (): void {
    $event = new TextCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'message_id' => 'msg-456',
    ]);
});

it('handles empty string properties', function (): void {
    $event = new TextCompleteEvent(
        id: '',
        timestamp: 0,
        messageId: ''
    );

    expect($event->id)->toBe('')
        ->and($event->messageId)->toBe('');
});



================================================
FILE: tests/Unit/Streaming/Events/TextDeltaEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\TextDeltaEvent;

it('constructs with required parameters', function (): void {
    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Hello',
        messageId: 'msg-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->delta)->toBe('Hello')
        ->and($event->messageId)->toBe('msg-456');
});

it('returns correct stream event type', function (): void {
    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Hello',
        messageId: 'msg-456'
    );

    expect($event->type())->toBe(StreamEventType::TextDelta);
});

it('converts to array with all properties', function (): void {
    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Hello world!',
        messageId: 'msg-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'delta' => 'Hello world!',
        'message_id' => 'msg-456',
    ]);
});

it('handles empty string delta', function (): void {
    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: '',
        messageId: 'msg-456'
    );

    expect($event->delta)->toBe('');
});

it('handles unicode text delta', function (): void {
    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: '🚀 Hello 世界!',
        messageId: 'msg-456'
    );

    expect($event->delta)->toBe('🚀 Hello 世界!')
        ->and($event->toArray()['delta'])->toBe('🚀 Hello 世界!');
});

it('handles multiline text delta', function (): void {
    $delta = "Line 1\nLine 2\nLine 3";

    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: $delta,
        messageId: 'msg-456'
    );

    expect($event->delta)->toBe($delta);
});

it('handles special characters in delta', function (): void {
    $delta = "Special chars: \"'`!@#$%^&*(){}[]<>";

    $event = new TextDeltaEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: $delta,
        messageId: 'msg-456'
    );

    expect($event->delta)->toBe($delta);
});



================================================
FILE: tests/Unit/Streaming/Events/TextStartEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\TextStartEvent;

it('constructs with required parameters', function (): void {
    $event = new TextStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->messageId)->toBe('msg-456');
});

it('returns correct stream event type', function (): void {
    $event = new TextStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    expect($event->type())->toBe(StreamEventType::TextStart);
});

it('converts to array with all properties', function (): void {
    $event = new TextStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        messageId: 'msg-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'message_id' => 'msg-456',
    ]);
});

it('handles empty string properties', function (): void {
    $event = new TextStartEvent(
        id: '',
        timestamp: 0,
        messageId: ''
    );

    expect($event->id)->toBe('')
        ->and($event->messageId)->toBe('');
});



================================================
FILE: tests/Unit/Streaming/Events/ThinkingCompleteEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ThinkingCompleteEvent;

it('constructs with required parameters', function (): void {
    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->reasoningId)->toBe('reasoning-456')
        ->and($event->summary)->toBeNull();
});

it('constructs with summary', function (): void {
    $summary = [
        'conclusion' => 'The optimal solution is approach B',
        'confidence' => 0.95,
        'reasoning_time' => 5.2,
    ];

    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    expect($event->summary)->toBe($summary);
});

it('returns correct stream event type', function (): void {
    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    expect($event->type())->toBe(StreamEventType::ThinkingComplete);
});

it('converts to array with all properties', function (): void {
    $summary = [
        'final_answer' => 'The result is 42',
        'methodology' => 'deep thought',
        'certainty' => 0.99,
    ];

    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'reasoning_id' => 'reasoning-456',
        'summary' => $summary,
    ]);
});

it('converts to array with null summary', function (): void {
    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'reasoning_id' => 'reasoning-456',
        'summary' => null,
    ]);
});

it('handles complex summary with nested structures', function (): void {
    $summary = [
        'final_decision' => 'implement solution A',
        'analysis' => [
            'pros' => ['fast', 'memory-efficient'],
            'cons' => ['complex implementation'],
            'score' => 8.5,
        ],
        'alternatives_considered' => [
            ['name' => 'solution B', 'score' => 7.2],
            ['name' => 'solution C', 'score' => 6.8],
        ],
        'timestamps' => [
            'started' => 1640995100,
            'completed' => 1640995200,
        ],
    ];

    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    expect($event->summary)->toBe($summary)
        ->and($event->toArray()['summary'])->toBe($summary);
});

it('handles empty summary array', function (): void {
    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456',
        summary: []
    );

    expect($event->summary)->toBe([])
        ->and($event->toArray()['summary'])->toBe([]);
});

it('handles empty string reasoning id', function (): void {
    $event = new ThinkingCompleteEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: ''
    );

    expect($event->reasoningId)->toBe('');
});



================================================
FILE: tests/Unit/Streaming/Events/ThinkingEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ThinkingEvent;

it('constructs with required parameters', function (): void {
    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Let me think about this...',
        reasoningId: 'reasoning-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->delta)->toBe('Let me think about this...')
        ->and($event->reasoningId)->toBe('reasoning-456')
        ->and($event->summary)->toBeNull();
});

it('constructs with summary', function (): void {
    $summary = [
        'topic' => 'mathematics',
        'confidence' => 0.85,
        'steps' => ['analyze', 'compute', 'validate'],
    ];

    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Calculating the result...',
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    expect($event->summary)->toBe($summary);
});

it('returns correct stream event type', function (): void {
    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Thinking...',
        reasoningId: 'reasoning-456'
    );

    expect($event->type())->toBe(StreamEventType::ThinkingDelta);
});

it('converts to array with all properties', function (): void {
    $summary = [
        'topic' => 'physics',
        'confidence' => 0.92,
    ];

    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Considering quantum mechanics...',
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'delta' => 'Considering quantum mechanics...',
        'reasoning_id' => 'reasoning-456',
        'summary' => $summary,
    ]);
});

it('converts to array with null summary', function (): void {
    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Thinking deeply...',
        reasoningId: 'reasoning-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'delta' => 'Thinking deeply...',
        'reasoning_id' => 'reasoning-456',
        'summary' => null,
    ]);
});

it('handles empty string delta', function (): void {
    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: '',
        reasoningId: 'reasoning-456'
    );

    expect($event->delta)->toBe('');
});

it('handles multiline thinking delta', function (): void {
    $delta = "First, I need to consider:\n1. The problem context\n2. Available data\n3. Constraints";

    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: $delta,
        reasoningId: 'reasoning-456'
    );

    expect($event->delta)->toBe($delta);
});

it('handles complex summary structure', function (): void {
    $summary = [
        'main_topic' => 'algorithm analysis',
        'confidence_score' => 0.78,
        'reasoning_steps' => [
            ['step' => 'analyze', 'duration' => 2.5],
            ['step' => 'validate', 'duration' => 1.2],
        ],
        'metadata' => [
            'complexity' => 'O(n log n)',
            'memory_usage' => 'O(n)',
        ],
    ];

    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Analyzing time complexity...',
        reasoningId: 'reasoning-456',
        summary: $summary
    );

    expect($event->summary)->toBe($summary)
        ->and($event->toArray()['summary'])->toBe($summary);
});

it('handles empty summary array', function (): void {
    $event = new ThinkingEvent(
        id: 'event-123',
        timestamp: 1640995200,
        delta: 'Starting to think...',
        reasoningId: 'reasoning-456',
        summary: []
    );

    expect($event->summary)->toBe([])
        ->and($event->toArray()['summary'])->toBe([]);
});



================================================
FILE: tests/Unit/Streaming/Events/ThinkingStartEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ThinkingStartEvent;

it('constructs with required parameters', function (): void {
    $event = new ThinkingStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->reasoningId)->toBe('reasoning-456');
});

it('returns correct stream event type', function (): void {
    $event = new ThinkingStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    expect($event->type())->toBe(StreamEventType::ThinkingStart);
});

it('converts to array with all properties', function (): void {
    $event = new ThinkingStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: 'reasoning-456'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'reasoning_id' => 'reasoning-456',
    ]);
});

it('handles empty string properties', function (): void {
    $event = new ThinkingStartEvent(
        id: '',
        timestamp: 0,
        reasoningId: ''
    );

    expect($event->id)->toBe('')
        ->and($event->reasoningId)->toBe('');
});

it('handles long reasoning id', function (): void {
    $reasoningId = str_repeat('a', 1000);

    $event = new ThinkingStartEvent(
        id: 'event-123',
        timestamp: 1640995200,
        reasoningId: $reasoningId
    );

    expect($event->reasoningId)->toBe($reasoningId);
});



================================================
FILE: tests/Unit/Streaming/Events/ToolCallEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ToolCallEvent;
use Prism\Prism\ValueObjects\ToolCall;

it('constructs with required parameters', function (): void {
    $arguments = ['query' => 'hello world', 'max_results' => 10];
    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'search',
        arguments: $arguments
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->toolCall)->toBe($toolCall)
        ->and($event->toolCall->id)->toBe('tool-456')
        ->and($event->toolCall->name)->toBe('search')
        ->and($event->toolCall->arguments())->toBe($arguments)
        ->and($event->messageId)->toBe('msg-789')
        ->and($event->toolCall->reasoningId)->toBeNull();
});

it('constructs with reasoning id', function (): void {
    $arguments = ['file' => 'data.txt'];
    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'read_file',
        arguments: $arguments,
        reasoningId: 'reasoning-101'
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->toolCall->reasoningId)->toBe('reasoning-101');
});

it('returns correct stream event type', function (): void {
    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'calculator',
        arguments: []
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->type())->toBe(StreamEventType::ToolCall);
});

it('converts to array with all properties', function (): void {
    $arguments = [
        'expression' => '2 + 2',
        'precision' => 2,
        'format' => 'decimal',
    ];

    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'calculator',
        arguments: $arguments,
        reasoningId: 'reasoning-101'
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'tool_id' => 'tool-456',
        'tool_name' => 'calculator',
        'arguments' => $arguments,
        'message_id' => 'msg-789',
        'reasoning_id' => 'reasoning-101',
    ]);
});

it('converts to array with null reasoning id', function (): void {
    $arguments = ['prompt' => 'Generate a story'];
    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'text_generator',
        arguments: $arguments
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'tool_id' => 'tool-456',
        'tool_name' => 'text_generator',
        'arguments' => $arguments,
        'message_id' => 'msg-789',
        'reasoning_id' => null,
    ]);
});

it('handles empty arguments array', function (): void {
    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'ping',
        arguments: []
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->toolCall->arguments())->toBe([])
        ->and($event->toArray()['arguments'])->toBe([]);
});

it('handles complex nested arguments', function (): void {
    $arguments = [
        'config' => [
            'timeout' => 30,
            'retries' => 3,
            'options' => ['verbose', 'cache'],
        ],
        'data' => [
            'users' => [
                ['name' => 'John', 'age' => 30],
                ['name' => 'Jane', 'age' => 25],
            ],
        ],
        'metadata' => [
            'version' => '1.0.0',
            'timestamp' => 1640995200,
        ],
    ];

    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'complex_processor',
        arguments: $arguments
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->toolCall->arguments())->toBe($arguments)
        ->and($event->toArray()['arguments'])->toBe($arguments);
});

it('handles string and numeric arguments', function (): void {
    $arguments = [
        'string_param' => 'hello',
        'int_param' => 42,
        'float_param' => 3.14,
        'bool_param' => true,
        'null_param' => null,
    ];

    $toolCall = new ToolCall(
        id: 'tool-456',
        name: 'multi_type_tool',
        arguments: $arguments
    );

    $event = new ToolCallEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolCall: $toolCall,
        messageId: 'msg-789'
    );

    expect($event->toolCall->arguments())->toBe($arguments);
});

it('handles empty string properties', function (): void {
    $toolCall = new ToolCall(
        id: '',
        name: '',
        arguments: [],
        reasoningId: ''
    );

    $event = new ToolCallEvent(
        id: '',
        timestamp: 0,
        toolCall: $toolCall,
        messageId: ''
    );

    expect($event->id)->toBe('')
        ->and($event->toolCall->id)->toBe('')
        ->and($event->toolCall->name)->toBe('')
        ->and($event->messageId)->toBe('')
        ->and($event->toolCall->reasoningId)->toBe('');
});



================================================
FILE: tests/Unit/Streaming/Events/ToolResultEventTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\Enums\StreamEventType;
use Prism\Prism\Streaming\Events\ToolResultEvent;
use Prism\Prism\ValueObjects\ToolResult;

it('constructs with required parameters', function (): void {
    $result = ['output' => 'Hello World', 'status' => 'completed'];
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'greeting',
        args: ['name' => 'World'],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->id)->toBe('event-123')
        ->and($event->timestamp)->toBe(1640995200)
        ->and($event->toolResult)->toBe($toolResult)
        ->and($event->toolResult->toolCallId)->toBe('tool-456')
        ->and($event->toolResult->result)->toBe($result)
        ->and($event->messageId)->toBe('msg-789')
        ->and($event->success)->toBeTrue()
        ->and($event->error)->toBeNull();
});

it('constructs with custom success and error', function (): void {
    $result = ['partial_data' => 'some data'];
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'data_fetcher',
        args: ['source' => 'api'],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789',
        success: false,
        error: 'Connection timeout'
    );

    expect($event->success)->toBeFalse()
        ->and($event->error)->toBe('Connection timeout');
});

it('returns correct stream event type', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'test_tool',
        args: [],
        result: []
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->type())->toBe(StreamEventType::ToolResult);
});

it('converts to array with successful result', function (): void {
    $result = [
        'data' => ['item1', 'item2', 'item3'],
        'count' => 3,
        'processing_time' => 0.25,
    ];

    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'list_processor',
        args: ['items' => ['item1', 'item2', 'item3']],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'tool_id' => 'tool-456',
        'result' => $result,
        'message_id' => 'msg-789',
        'success' => true,
        'error' => null,
    ]);
});

it('converts to array with failed result', function (): void {
    $result = ['partial_output' => 'incomplete data'];
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'data_fetcher',
        args: ['url' => 'https://example.com'],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789',
        success: false,
        error: 'Network error: unable to fetch complete data'
    );

    $array = $event->toArray();

    expect($array)->toBe([
        'id' => 'event-123',
        'timestamp' => 1640995200,
        'tool_id' => 'tool-456',
        'result' => $result,
        'message_id' => 'msg-789',
        'success' => false,
        'error' => 'Network error: unable to fetch complete data',
    ]);
});

it('handles empty result array', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'empty_tool',
        args: [],
        result: []
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->toolResult->result)->toBe([])
        ->and($event->toArray()['result'])->toBe([]);
});

it('handles complex nested result', function (): void {
    $result = [
        'status' => 'success',
        'data' => [
            'users' => [
                ['id' => 1, 'name' => 'John', 'active' => true],
                ['id' => 2, 'name' => 'Jane', 'active' => false],
            ],
            'metadata' => [
                'total_count' => 2,
                'query_time' => 0.15,
                'cache_hit' => true,
            ],
        ],
        'pagination' => [
            'current_page' => 1,
            'total_pages' => 1,
            'per_page' => 50,
        ],
    ];

    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'user_fetcher',
        args: ['page' => 1, 'per_page' => 50],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->toolResult->result)->toBe($result)
        ->and($event->toArray()['result'])->toBe($result);
});

it('handles mixed data types in result', function (): void {
    $result = [
        'string_value' => 'text',
        'integer_value' => 42,
        'float_value' => 3.14159,
        'boolean_value' => true,
        'null_value' => null,
        'array_value' => [1, 2, 3],
    ];

    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'mixed_type_tool',
        args: ['type' => 'mixed'],
        result: $result
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->toolResult->result)->toBe($result);
});

it('handles success false with null error', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'failing_tool',
        args: [],
        result: ['status' => 'failed']
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789',
        success: false
    );

    expect($event->success)->toBeFalse()
        ->and($event->error)->toBeNull();
});

it('handles empty string error message', function (): void {
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'empty_error_tool',
        args: [],
        result: []
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789',
        success: false,
        error: ''
    );

    expect($event->error)->toBe('');
});

it('handles multiline error message', function (): void {
    $error = "Error occurred:\nLine 1: Connection failed\nLine 2: Retry limit exceeded\nLine 3: Operation aborted";
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'multiline_error_tool',
        args: ['operation' => 'complex'],
        result: []
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789',
        success: false,
        error: $error
    );

    expect($event->error)->toBe($error);
});

it('handles string result', function (): void {
    $stringResult = 'This is a simple string result';
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'string_tool',
        args: ['input' => 'test'],
        result: $stringResult
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->toolResult->result)->toBe($stringResult);
});

it('handles numeric result', function (): void {
    $numericResult = 42;
    $toolResult = new ToolResult(
        toolCallId: 'tool-456',
        toolName: 'calculation_tool',
        args: ['expression' => '6 * 7'],
        result: $numericResult
    );

    $event = new ToolResultEvent(
        id: 'event-123',
        timestamp: 1640995200,
        toolResult: $toolResult,
        messageId: 'msg-789'
    );

    expect($event->toolResult->result)->toBe($numericResult);
});



================================================
FILE: tests/ValueObjects/ToolCallTest.php
================================================
<?php

declare(strict_types=1);

use Prism\Prism\ValueObjects\ToolCall;

it('handles empty string arguments correctly', function (): void {
    $toolCall = new ToolCall(
        id: 'test-id',
        name: 'test-tool',
        arguments: ''
    );

    expect($toolCall->arguments())->toBe([]);
});

it('handles null arguments correctly', function (): void {
    $toolCall = new ToolCall(
        id: 'test-id',
        name: 'test-tool',
        arguments: []
    );

    expect($toolCall->arguments())->toBe([]);
});

it('handles valid JSON string arguments correctly', function (): void {
    $toolCall = new ToolCall(
        id: 'test-id',
        name: 'test-tool',
        arguments: '{"param1": "value1", "param2": 42}'
    );

    expect($toolCall->arguments())->toBe([
        'param1' => 'value1',
        'param2' => 42,
    ]);
});

it('handles array arguments correctly', function (): void {
    $arguments = ['param1' => 'value1', 'param2' => 42];

    $toolCall = new ToolCall(
        id: 'test-id',
        name: 'test-tool',
        arguments: $arguments
    );

    expect($toolCall->arguments())->toBe($arguments);
});

it('throws exception for malformed JSON string arguments', function (): void {
    $toolCall = new ToolCall(
        id: 'test-id',
        name: 'test-tool',
        arguments: '{"invalid json"'
    );

    expect($toolCall->arguments(...))->toThrow(JsonException::class);
});



================================================
FILE: tests/ValueObjects/Media/DocumentTest.php
================================================
<?php

use Prism\Prism\ValueObjects\Media\Document;

it('can create a document from chunks', function (): void {
    $document = Document::fromChunks(['chunk1', 'chunk2'], 'title');

    expect($document->chunks())->toBe(['chunk1', 'chunk2']);
    expect($document->documentTitle())->toBe('title');
});

it('can create a document from a file ID', function (): void {
    $document = Document::fromFileId('file-id', 'title');

    expect($document->fileId())->toBe('file-id');
    expect($document->documentTitle())->toBe('title');
});



================================================
FILE: tests/ValueObjects/Media/MediaTest.php
================================================
<?php

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Storage;
use Prism\Prism\ValueObjects\Media\Media;

describe('creation', function (): void {
    it('can create from file ID', function (): void {
        $media = Media::fromFileId('file-id');

        expect($media->fileId())->toBe('file-id');
    });

    it('can create from a local path', function (): void {
        $media = Media::fromLocalPath('tests/Fixtures/diamond.png');

        expect($media->localPath())->toBe('tests/Fixtures/diamond.png');
        expect($media->mimeType())->toBe('image/png');
    });

    it('can create from a storage path', function (): void {
        Storage::fake();

        Storage::put('images/test-image.png', file_get_contents('tests/Fixtures/diamond.png'));

        $media = Media::fromStoragePath('images/test-image.png');

        expect($media->storagePath())->toBe('images/test-image.png');
        expect($media->mimeType())->toBe('image/png');
    });

    it('can create from a URL', function (): void {
        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->url())->toBe('https://prismphp.com/storage/diamond.png');
    });

    it('can create from raw content', function (): void {
        $media = Media::fromRawContent('raw-content', 'text/plain');

        expect($media->rawContent())->toBe('raw-content');
        expect($media->mimeType())->toBe('text/plain');
    });

    it('can create from base64', function (): void {
        $media = Media::fromBase64(base64_encode('content'), 'text/plain');

        expect($media->base64())->toBe(base64_encode('content'));
        expect($media->mimeType())->toBe('text/plain');
    });
});

describe('inspection', function (): void {
    test('isFile returns true for local path', function (): void {
        $media = Media::fromLocalPath('tests/Fixtures/diamond.png');

        expect($media->isFile())->toBeTrue();
    });

    test('isFile returns true for storage path', function (): void {
        Storage::fake();

        Storage::put('images/test-image.png', file_get_contents('tests/Fixtures/diamond.png'));

        $media = Media::fromStoragePath('images/test-image.png');

        expect($media->isFile())->toBeTrue();
    });

    test('isFile returns false for url', function (): void {
        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->isFile())->toBeFalse();
    });

    test('isUrl returns true for URL', function (): void {
        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->isUrl())->toBeTrue();
    });

    test('hasRawContent returns true for local path', function (): void {
        $media = Media::fromLocalPath('tests/Fixtures/diamond.png');

        expect($media->hasRawContent())->toBeTrue();
    });

    test('hasRawContent returns true for storage path', function (): void {
        Storage::fake();

        Storage::put('images/test-image.png', file_get_contents('tests/Fixtures/diamond.png'));

        $media = Media::fromStoragePath('images/test-image.png');

        expect($media->hasRawContent())->toBeTrue();
    });

    test('hasRawContent returns true for url', function (): void {
        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->hasRawContent())->toBeTrue();
    });

    test('hasBase64 returns true for local path', function (): void {
        $media = Media::fromLocalPath('tests/Fixtures/diamond.png');

        expect($media->hasBase64())->toBeTrue();
    });

    test('hasBase64 returns true for storage path', function (): void {
        Storage::fake();

        Storage::put('images/test-image.png', file_get_contents('tests/Fixtures/diamond.png'));

        $media = Media::fromStoragePath('images/test-image.png');

        expect($media->hasBase64())->toBeTrue();
    });

    test('hasBase64 returns true for url', function (): void {
        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->hasBase64())->toBeTrue();
    });
});

describe('conversion', function (): void {
    it('converts local path to rawContent', function (): void {
        $media = Media::fromLocalPath('tests/Fixtures/diamond.png');

        expect($media->rawContent())->toBe(file_get_contents('tests/Fixtures/diamond.png'));
    });

    it('converts storage path to rawContent', function (): void {
        Storage::fake();

        Storage::put('images/test-image.png', file_get_contents('tests/Fixtures/diamond.png'));

        $media = Media::fromStoragePath('images/test-image.png');

        expect($media->rawContent())->toBe(file_get_contents('tests/Fixtures/diamond.png'));
    });

    it('converts url to rawContent', function (): void {
        Http::fake([
            'https://prismphp.com/storage/diamond.png' => Http::sequence()
                ->push(file_get_contents('tests/Fixtures/diamond.png'))
                ->push(file_get_contents('tests/Fixtures/diamond.png')),
        ])->preventStrayRequests();

        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->rawContent())->toBe(file_get_contents('tests/Fixtures/diamond.png'));
    });

    it('converts url to a resource', function (): void {
        Http::fake([
            'https://prismphp.com/storage/diamond.png' => Http::response(file_get_contents('tests/Fixtures/diamond.png')),
        ])->preventStrayRequests();

        $media = Media::fromUrl('https://prismphp.com/storage/diamond.png');

        expect($media->resource())->toBeResource();
    });

    it('converts base64 to rawContent', function (): void {
        $media = Media::fromBase64(base64_encode('content'), 'text/plain');

        expect($media->rawContent())->toBe('content');
    });

    it('converts rawContent to base64', function (): void {
        $media = Media::fromRawContent('content', 'text/plain');

        expect($media->base64())->toBe(base64_encode('content'));
    });
});



================================================
FILE: workbench/app/Models/User.php
================================================
<?php

namespace Workbench\App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var array<int, string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
    ];
}



================================================
FILE: workbench/app/Models/.gitkeep
================================================
[Empty file]


================================================
FILE: workbench/app/Providers/WorkbenchServiceProvider.php
================================================
<?php

namespace Workbench\App\Providers;

use Illuminate\Support\ServiceProvider;

class WorkbenchServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap services.
     */
    public function boot(): void
    {
        //
    }
}



================================================
FILE: workbench/bootstrap/app.php
================================================
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

use function Orchestra\Testbench\default_skeleton_path;

return Application::configure(basePath: $APP_BASE_PATH ?? default_skeleton_path())
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
    )
    ->withMiddleware(function (Middleware $middleware) {
        //
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })->create();



================================================
FILE: workbench/database/factories/UserFactory.php
================================================
<?php

namespace Workbench\Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;
use Workbench\App\Models\User;

/**
 * @template TModel of \Workbench\App\Models\User
 *
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<TModel>
 */
class UserFactory extends Factory
{
    /**
     * The current password being used by the factory.
     */
    protected static ?string $password;

    /**
     * The name of the factory's corresponding model.
     *
     * @var class-string<TModel>
     */
    protected $model = User::class;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->name(),
            'email' => fake()->unique()->safeEmail(),
            'email_verified_at' => now(),
            'password' => static::$password ??= Hash::make('password'),
            'remember_token' => Str::random(10),
        ];
    }

    /**
     * Indicate that the model's email address should be unverified.
     */
    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }
}



================================================
FILE: workbench/database/factories/.gitkeep
================================================
[Empty file]


================================================
FILE: workbench/database/migrations/.gitkeep
================================================
[Empty file]


================================================
FILE: workbench/database/seeders/DatabaseSeeder.php
================================================
<?php

namespace Workbench\Database\Seeders;

use Illuminate\Database\Seeder;
// use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Workbench\Database\Factories\UserFactory;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // UserFactory::new(10)->create();

        UserFactory::new()->create([
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }
}



================================================
FILE: workbench/resources/views/.gitkeep
================================================
[Empty file]


================================================
FILE: workbench/routes/console.php
================================================
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote')->hourly();



================================================
FILE: workbench/routes/web.php
================================================
<?php

use Illuminate\Support\Facades\Route;

Route::get('/', function () {
    return view('welcome');
});



================================================
FILE: .github/CONTRIBUTING.md
================================================
# Contributing

Contributions are **welcome** and will be fully **credited**.

Please read and understand the contribution guide before creating an issue or pull request.

## Etiquette

This project is open source, and as such, the maintainers give their free time to build and maintain the source code
held within. They make the code freely available in the hope that it will be of use to other developers. It would be
extremely unfair for them to suffer abuse or anger for their hard work.

Please be considerate towards maintainers when raising issues or presenting pull requests. Let's show the
world that developers are civilized and selfless people.

It's the duty of the maintainer to ensure that all submissions to the project are of sufficient
quality to benefit the project. Many developers have different skillsets, strengths, and weaknesses. Respect the maintainer's decision, and do not be upset or abusive if your submission is not used.

## Viability

When requesting or submitting new features, first consider whether it might be useful to others. Open
source projects are used by many developers, who may have entirely different needs to your own. Think about
whether or not your feature is likely to be used by other users of the project.

## Procedure

Before filing an issue:
- Attempt to replicate the problem, to ensure that it wasn't a coincidental incident.
- Check to make sure your feature suggestion isn't already present within the project.
- Check the pull requests tab to ensure that the bug doesn't have a fix in progress.
- Check the pull requests tab to ensure that the feature isn't already in progress.

Before submitting a pull request:
- Check the codebase to ensure that your feature doesn't already exist.
- Check the pull requests to ensure that another person hasn't already submitted the feature or fix.

## Branching Strategy & Commits

### Branching
We follow a trunk-based development approach with feature branches:
- `main` is the primary branch and should always be deployable
- Create feature branches from `main` using the format: `feature/description-of-change`
- Bug fix branches should use: `fix/description-of-bug`
- Release branches use: `release/version-number`

### Commit Messages
We follow [Conventional Commits 1.0.0](https://www.conventionalcommits.org/en/v1.0.0/) for clear, machine and human-readable commit history. Each commit message should be structured as follows:

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

Types include:
- `feat`: A new feature
- `fix`: A bug fix
- `docs`: Documentation only changes
- `style`: Changes that do not affect the meaning of the code
- `refactor`: A code change that neither fixes a bug nor adds a feature
- `perf`: A code change that improves performance
- `test`: Adding missing tests or correcting existing tests
- `chore`: Changes to the build process or auxiliary tools

Examples:
```
feat(auth): add social login with GitHub
fix(api): correct rate limiting header
docs(readme): update installation steps
```

Breaking changes must include a `!` after the type/scope and `BREAKING CHANGE:` in the footer:
```
feat(api)!: change authentication endpoint response format

BREAKING CHANGE: authentication response now returns JWT instead of session cookie
```

## Requirements

If the project maintainer has any additional requirements, you will find them listed here.

- **Pint Coding Standard** - The easiest way to apply the conventions is to install [Laravel Pint](https://laravel.com/docs/11.x/pint).
- **Add tests!** - Your patch won't be accepted if it doesn't have tests.
- **Document any change in behaviour** - Make sure the `README.md` and any other relevant documentation are kept up-to-date.
- **Consider our release cycle** - We try to follow [SemVer](http://semver.org/). Randomly breaking public APIs is not an option.
- **One pull request per feature** - If you want to do more than one thing, send multiple pull requests.
- **Send coherent history** - Make sure each individual commit in your pull request is meaningful. If you had to make multiple intermediate commits while developing, please [squash them](http://www.git-scm.com/book/en/v2/Git-Tools-Rewriting-History#Changing-Multiple-Commit-Messages) before submitting.



================================================
FILE: .github/FUNDING.yml
================================================
# These are supported funding model platforms

github: sixlive



================================================
FILE: .github/pull_request_template.md
================================================
<!-- Please review our contributing guidelines https://github.com/prism-php/prism/blob/main/.github/CONTRIBUTING.md -->
## Description

## Breaking Changes
<!-- Put any breaking changes here. Remove this section if there are no breaking changes -->



================================================
FILE: .github/SECURITY.md
================================================
# Reporting Security Issues
If you believe you have found a security vulnerability in Prism, we encourage you to let us know right away.

We will investigate all legitimate reports and do our best to quickly fix the problem.

Email `security@echolabs.dev` to disclose any security vulnerabilities.



================================================
FILE: .github/workflows/formatting.yml
================================================
name: Formatting

on:
  push:
    branches:
      - main
      - "*.x"
  pull_request:

env:
  phpv: 8.2

jobs:
  formatting:
    name: Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.phpv }}
          coverage: none

      - name: Install composer dependencies
        uses: ramsey/composer-install@v3

      - name: Run Pint
        run: |
          vendor/bin/pint
          git diff --exit-code

      - name: Run Rector
        run: |
          vendor/bin/rector
          git diff --exit-code



================================================
FILE: .github/workflows/phpstan.yml
================================================
name: PHPStan

on:
  push:
    branches:
      - main
      - "*.x"
  pull_request:

env:
  phpv: 8.2

jobs:
  phpstan:
    name: phpstan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.phpv }}
          coverage: none

      - name: Install composer dependencies
        uses: ramsey/composer-install@v3

      - name: Run PHPStan
        run: ./vendor/bin/phpstan --error-format=github



================================================
FILE: .github/workflows/tests.yml
================================================
name: Tests

on:
  push:
    branches:
      - main
      - "*.x"
  pull_request:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 5
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest]
        php: [8.2, 8.3, 8.4]
        laravel: [11.*, 12.*]
        stability: [prefer-lowest, prefer-stable]
        include:
          - laravel: 11.*
            testbench: 9.*
            carbon: ^2.63
          - laravel: 12.*
            testbench: 10.*
            carbon: ^3.8.4

    name: P${{ matrix.php }} - L${{ matrix.laravel }} - ${{ matrix.stability }} - ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo
          coverage: none

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Install dependencies
        run: |
          composer require "laravel/framework:${{ matrix.laravel }}" "orchestra/testbench:${{ matrix.testbench }}" "nesbot/carbon:${{ matrix.os == 'windows-latest' && '^^^' || '' }}${{ matrix.carbon }}" --no-interaction --no-update
          composer update --${{ matrix.stability }} --prefer-dist --no-interaction

      - name: List Installed Dependencies
        run: composer show -D

      - name: Execute tests
        run: vendor/bin/pest --parallel


